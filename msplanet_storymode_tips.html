<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>麦思星球 - 剧情模式攻略提示</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
        color: #fff;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      /* Animated background particles */
      .bg-particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
        z-index: 0;
      }

      /* Main container */
      .tips-container {
        position: relative;
        z-index: 10;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 30px;
        max-width: 1200px;
        width: 95vw;
        height: 100vh;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
        display: flex;
        flex-direction: column;
      }

      /* Header */
      .tips-header {
        text-align: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .tips-title {
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 5px;
      }

      .tips-subtitle {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
      }

      /* Content area */
      .tips-content {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tip-slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transform: translateX(50px);
        transition: all 0.5s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
      }

      .tip-slide.active {
        opacity: 1;
        transform: translateX(0);
      }

      .tip-slide.prev {
        opacity: 0;
        transform: translateX(-50px);
      }

      .tip-media-container {
        width: calc(480px * 16 / 9);
        height: 480px;
        min-height: 480px;
        border-radius: 15px;
        border: 3px solid rgba(102, 126, 234, 0.5);
        margin-bottom: 10px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        background: rgba(0, 0, 0, 0.3);
      }

      .tip-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 17px;
      }

      .tip-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 17px;
      }

      .tip-title-text {
        font-size: 20px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
        text-align: center;
      }

      .tip-text {
        font-size: 16px;
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.9);
        max-width: calc(480px * 16 / 9);
        margin-top: 5px;
      }

      .tip-highlight {
        color: #667eea;
        font-weight: bold;
      }

      /* Navigation */
      .tips-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        flex-shrink: 0;
      }

      .nav-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        color: white;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .nav-button:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      }

      .nav-button:disabled {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .page-indicator {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .page-dots {
        display: flex;
        gap: 8px;
      }

      .page-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .page-dot.active {
        background: #667eea;
        transform: scale(1.3);
      }

      .page-dot.watched {
        background: #10b981;
        border: 2px solid #059669;
      }

      .page-dot.watched.active {
        background: #667eea;
        border: 2px solid #4f46e5;
      }

      .page-number {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: bold;
        min-width: 80px;
        text-align: center;
      }

      /* Footer controls */
      .tips-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        cursor: pointer;
        user-select: none;
      }

      .custom-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 4px;
        background: transparent;
        position: relative;
        transition: all 0.3s ease;
      }

      .custom-checkbox.checked {
        background: #667eea;
        border-color: #667eea;
      }

      .custom-checkbox.checked::after {
        content: "✓";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .close-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 24px;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .close-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      }

      /* Watch Progress at bottom */
      .watch-progress-bottom {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 8px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 100;
      }

      /* Responsive for small height */
      @media (max-height: 790px) {
        .tips-container {
          padding: 10px 30px;
        }

        .tips-header {
          display: none; /* 在小高度时隐藏header */
        }

        .tips-navigation {
          margin: 5px 0;
        }

        .tips-footer {
          padding-top: 5px;
        }

        .nav-button {
          width: 35px;
          height: 35px;
          font-size: 14px;
        }

        .close-button {
          padding: 8px 16px;
          font-size: 14px;
        }

        .checkbox-container {
          font-size: 12px;
        }

        .custom-checkbox {
          width: 16px;
          height: 16px;
        }

        .watch-progress-bottom {
          font-size: 12px;
          padding: 6px 12px;
        }
      }

      /* Animation keyframes */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tips-container {
        animation: fadeInUp 0.6s ease;
      }
    </style>
  </head>
  <body>
    <div class="bg-particles"></div>

    <div class="tips-container">
      <!-- Header -->
      <div class="tips-header">
        <h1 class="tips-title">《故事模式》今日提示</h1>
      </div>

      <!-- Content -->
      <div class="tips-content" id="tipsContent">
        <div class="tip-slide active">
          <!-- Shared media container -->
          <div class="tip-media-container" id="sharedMediaContainer">
            <iframe id="sharedIframe" class="tip-iframe" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" loading="lazy" style="display: none">
            </iframe>
            <img id="sharedImage" class="tip-media" style="display: none" onerror="this.style.display='none'" />
          </div>

          <!-- Text content container -->
          <div class="tip-title-text" id="tipTitle"></div>
          <div class="tip-text" id="tipText"></div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="tips-navigation">
        <button class="nav-button" id="prevBtn" onclick="previousTip()">‹</button>

        <div class="page-indicator">
          <div class="page-dots" id="pageDots"></div>
          <div class="page-number" id="pageNumber">1 / 7</div>
        </div>

        <button class="nav-button" id="nextBtn" onclick="nextTip()">›</button>
      </div>

      <!-- Footer -->
      <div class="tips-footer">
        <div class="checkbox-container" onclick="toggleDontShowAgain()">
          <div class="custom-checkbox" id="dontShowCheckbox"></div>
          <span>下次不再显示《故事模式》今日提示</span>
        </div>

        <button class="close-button" onclick="closeTips()">知道了</button>
      </div>

      <!-- Watch Progress - 观看进度显示在最下面居中 -->
      <div id="watchProgress" class="watch-progress-bottom">
        <span id="watchTimeText">观看进度: 0秒 / 20秒</span>
        <span id="watchCompleteIcon" class="hidden ml-2 text-green-400">✅ 已完成</span>
      </div>
    </div>

    <script>
      // Keepwork SDK 初始化
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      console.log(`Keepwork SDK initialized token: ${sdk.token}`);

      // Tips data
      const tipsData = [
        {
          name: "save_point",
          title: "麦思星球存档点教学",
          text: "存档点简介，抢占存档点，多人共同创建",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473081434388&bvid=BV1cv15BREMX&cid=33586678013&p=1",
          },
        },
        {
          name: "building",
          title: "故事模式建造技巧",
          text: "无论方块还是模式，你可以快速构建属于自己的3D世界。记得保存你的设计哦!",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115313295229371&bvid=BV1f7xHz6EGb&cid=32826066816&p=1",
          },
        },
        {
          name: "action_system",
          title: "麦思星球动作系统",
          text: "掌握多角色动作系统：学会跳跃、冲刺和播放各种动作特效",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115472930441858&bvid=BV1wh15BtECR&cid=33585629250&p=1",
          },
        },
        {
          name: "character_system",
          title: "麦思星球角色系统介绍",
          text: "了解如何创建多个角色，扮演多个角色",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473165519533&bvid=BV1jA15BmETF&cid=33587333799&p=1",
          },
        },
        {
          name: "custom_item",
          title: "麦思星球自制物品教学",
          text: "学习如何制作自己的物品，将看到的物品收入时空背包!",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473282763326&bvid=BV1u715BTE5V&cid=33588120851&p=1",
          },
        },
        {
          name: "friend_teleport",
          title: "麦思星球好友传送",
          text: "学习如何使用好友传送功能,快速前往好友所在位置,一起畅游麦思星球!",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473299539192&bvid=BV1gL15BBEAH&cid=33588380343&p=1",
          },
        },
        {
          name: "knowledge_bean",
          title: "麦思星球知识豆攻略",
          text: "学习如何获取和使用知识豆,解锁更多游戏内容和道具!",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473383427017&bvid=BV1g515BuErE&cid=25897407468&p=1",
          },
        },
        {
          name: "transform_pill",
          title: "麦思星球变身药丸介绍",
          text: "了解变身药丸的使用方法，体验不同形态带来的独特能力!",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115473467575862&bvid=BV18Z1jB1Ei3&cid=33589431624&p=1",
          },
        },
        {
          name: "intro_video",
          title: "麦思星球宣传简介",
          text: "欢迎来到麦思星球！观看宣传视频，了解这个充满创造力和冒险的奇妙世界。",
          media: {
            type: "iframe",
            src: "//player.bilibili.com/player.html?isOutside=true&aid=115467511400025&bvid=BV1cE1KBeEvv&cid=33554433756&p=1",
          },
        },
      ];

      let currentTipIndex = 0;
      let dontShowAgain = false;

      // 用户观看进度跟踪
      let watchedTips = []; // 存储已观看的 tip 名称数组
      let dataLoaded = false;
      let tipStartTime = null;
      let tipTimeAccumulated = 0;
      const REQUIRED_WATCH_TIME = 20; // 必须观看20秒才算完成
      let progressUpdateInterval = null;

      // 加载用户观看进度数据和隐藏设置
      async function loadUserProgress() {
        try {
          // 加载观看进度
          let watchedData = await sdk.personalPageStore.loadPageData("msplanet_storymode_tips", "watchedTips");
          if (watchedData && Array.isArray(watchedData)) {
            watchedTips = [...watchedData];
            console.log("Loaded user progress from personal page store:", watchedData);
          }

          // 加载隐藏设置
          let hideData = await sdk.personalPageStore.loadPageData("msplanet_storymode_tips", "hidePreference");
          if (hideData === true) {
            dontShowAgain = true;
            console.log("Loaded hide preference from personal page store:", hideData);
          }
        } catch (error) {
          console.error("Error loading user progress:", error);
        }
        dataLoaded = true;
      }

      // 保存用户观看进度数据
      async function saveUserProgress() {
        try {
          await sdk.personalPageStore.savePageData("msplanet_storymode_tips", "watchedTips", [...watchedTips], true);
          console.log("Saved user progress to personal page store:", watchedTips);
        } catch (error) {
          console.error("Error saving user progress:", error);
        }
      }

      // 保存隐藏设置到personal page storage
      async function saveHidePreference() {
        try {
          await sdk.personalPageStore.savePageData("msplanet_storymode_tips", "hidePreference", dontShowAgain, true);
          console.log("Saved hide preference to personal page store:", dontShowAgain);
        } catch (error) {
          console.error("Error saving hide preference:", error);
        }
      }

      // 检查 tip 是否已观看
      function isTipWatched(tipName) {
        return watchedTips.includes(tipName);
      }

      // 标记 tip 为已观看
      async function markTipAsWatched(tipName) {
        if (!watchedTips.includes(tipName)) {
          watchedTips.push(tipName);
          await saveUserProgress();
          console.log(`Tip "${tipName}" marked as watched`);
        }
      }

      // 找到第一个未观看的 tip 索引
      function getFirstUnwatchedTipIndex() {
        for (let i = 0; i < tipsData.length; i++) {
          if (!isTipWatched(tipsData[i].name)) {
            return i;
          }
        }
        // 如果都看过了，返回今日 tip
        const today = new Date();
        const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
        return dayOfYear % tipsData.length;
      }

      // 更新观看进度显示
      function updateWatchProgress() {
        if (tipStartTime === null) return;

        const currentTime = Date.now();
        const sessionTime = Math.floor((currentTime - tipStartTime) / 1000);
        const totalTime = tipTimeAccumulated + sessionTime;

        const watchTimeText = document.getElementById("watchTimeText");
        const watchCompleteIcon = document.getElementById("watchCompleteIcon");

        if (totalTime >= REQUIRED_WATCH_TIME) {
          watchTimeText.textContent = `观看进度: ${REQUIRED_WATCH_TIME}秒 / ${REQUIRED_WATCH_TIME}秒`;
          watchCompleteIcon.classList.remove("hidden");

          // 如果观看时间达到要求，自动标记为已观看
          const currentTip = tipsData[currentTipIndex];
          if (!isTipWatched(currentTip.name)) {
            markTipAsWatched(currentTip.name);
            updateNavigation(); // 更新导航显示
          }
        } else {
          watchTimeText.textContent = `观看进度: ${totalTime}秒 / ${REQUIRED_WATCH_TIME}秒`;
          watchCompleteIcon.classList.add("hidden");
        }
      }

      // 检查并标记当前 tip 为已观看（如果观看时间足够）
      async function checkAndMarkCurrentTip() {
        if (tipStartTime !== null) {
          const currentTime = Date.now();
          const sessionTime = Math.floor((currentTime - tipStartTime) / 1000);
          tipTimeAccumulated += sessionTime;

          const currentTip = tipsData[currentTipIndex];
          console.log(`Tip "${currentTip.name}" 本次观看: ${sessionTime}秒, 累计: ${tipTimeAccumulated}秒`);

          if (tipTimeAccumulated >= REQUIRED_WATCH_TIME && !isTipWatched(currentTip.name)) {
            await markTipAsWatched(currentTip.name);
            console.log(`Tip "${currentTip.name}" 已标记为完成（观看时长: ${tipTimeAccumulated}秒）`);
          }

          // 重置计时器
          tipStartTime = null;
        }
      }

      // Initialize tips
      async function initializeTips() {
        // 加载用户观看进度
        await loadUserProgress();

        // 从第一个未观看的 tip 开始
        currentTipIndex = getFirstUnwatchedTipIndex();

        // Check if user has opted out (now from personal page storage)
        if (dontShowAgain) {
          closeTips();
          return;
        }

        renderCurrentTip();
        updateNavigation();
        generatePageDots();

        // 根据加载的设置更新checkbox状态
        const checkbox = document.getElementById("dontShowCheckbox");
        checkbox.classList.toggle("checked", dontShowAgain);

        // 开始观看时间跟踪
        startWatchingCurrentTip();
      }

      // 开始观看当前 tip 的时间跟踪
      function startWatchingCurrentTip() {
        // 停止之前的计时
        if (progressUpdateInterval) {
          clearInterval(progressUpdateInterval);
        }

        // 重置观看时间
        tipStartTime = Date.now();
        tipTimeAccumulated = 0;

        // 开始更新进度
        progressUpdateInterval = setInterval(updateWatchProgress, 1000);
        updateWatchProgress(); // 立即更新一次显示

        console.log(`开始观看 tip: ${tipsData[currentTipIndex].name}`);
      }

      // 停止观看当前 tip 的时间跟踪
      async function stopWatchingCurrentTip() {
        if (progressUpdateInterval) {
          clearInterval(progressUpdateInterval);
          progressUpdateInterval = null;
        }

        // 保存当前观看进度
        await checkAndMarkCurrentTip();

        console.log(`停止观看 tip: ${tipsData[currentTipIndex].name}`);
      }

      // Render current tip
      function renderCurrentTip() {
        const currentTip = tipsData[currentTipIndex];
        const sharedIframe = document.getElementById("sharedIframe");
        const sharedImage = document.getElementById("sharedImage");
        const tipTitle = document.getElementById("tipTitle");
        const tipText = document.getElementById("tipText");

        // Update title content
        tipTitle.textContent = currentTip.title;

        // Update text content
        tipText.innerHTML = currentTip.text;

        // Update media content
        if (currentTip.media.type === "image") {
          sharedIframe.style.display = "none";
          sharedImage.style.display = "block";
          sharedImage.src = currentTip.media.src;
          sharedImage.alt = currentTip.title;
        } else if (currentTip.media.type === "iframe") {
          sharedImage.style.display = "none";
          sharedIframe.style.display = "block";
          sharedIframe.src = currentTip.media.src;
        }
      }

      // Generate page dots
      function generatePageDots() {
        const dotsContainer = document.getElementById("pageDots");
        dotsContainer.innerHTML = "";

        tipsData.forEach((tip, index) => {
          const dot = document.createElement("div");
          const isWatched = isTipWatched(tip.name);
          dot.className = `page-dot ${index === currentTipIndex ? "active" : ""} ${isWatched ? "watched" : ""}`;
          dot.title = `${tip.title} ${isWatched ? "(已观看)" : "(未观看)"}`;
          dot.onclick = () => goToTip(index);
          dotsContainer.appendChild(dot);
        });
      }

      // Update navigation state
      function updateNavigation() {
        const pageNumber = document.getElementById("pageNumber");
        const watchedCount = tipsData.filter((tip) => isTipWatched(tip.name)).length;
        pageNumber.textContent = `${currentTipIndex + 1} / ${tipsData.length} (已看${watchedCount}个)`;

        // Update page dots
        document.querySelectorAll(".page-dot").forEach((dot, index) => {
          dot.classList.toggle("active", index === currentTipIndex);
          dot.classList.toggle("watched", isTipWatched(tipsData[index].name));
          dot.title = `${tipsData[index].title} ${isTipWatched(tipsData[index].name) ? "(已观看)" : "(未观看)"}`;
        });
      }

      // Switch to specific tip
      async function switchTip(newIndex) {
        if (newIndex < 0) newIndex = tipsData.length - 1;
        if (newIndex >= tipsData.length) newIndex = 0;

        if (newIndex === currentTipIndex) return;

        // 停止当前 tip 的观看跟踪
        await stopWatchingCurrentTip();

        currentTipIndex = newIndex;
        renderCurrentTip();
        updateNavigation();

        // 开始新 tip 的观看跟踪
        startWatchingCurrentTip();
      }

      // Navigation functions
      async function previousTip() {
        await switchTip(currentTipIndex - 1);
      }

      async function nextTip() {
        await switchTip(currentTipIndex + 1);
      }

      async function goToTip(index) {
        await switchTip(index);
      }

      // Toggle "don't show again" checkbox
      async function toggleDontShowAgain() {
        dontShowAgain = !dontShowAgain;
        const checkbox = document.getElementById("dontShowCheckbox");
        checkbox.classList.toggle("checked", dontShowAgain);

        // 立即保存隐藏设置
        await saveHidePreference();
      }

      // Close tips modal
      async function closeTips() {
        // 停止当前 tip 的观看跟踪并保存进度
        await stopWatchingCurrentTip();

        // 确保隐藏设置已保存到personal page storage
        if (dontShowAgain) {
          await saveHidePreference();
        }

        // Post message to parent if in iframe
        if (window.parent !== window) {
          window.parent.postMessage({ type: "closeTips", dontShowAgain }, "*");
        } else {
          // If standalone, just hide the page
          document.body.style.display = "none";
        }
      }

      // 页面可见性变化处理（用户切换标签页时暂停计时）
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          // 页面隐藏时，累计当前观看时间
          if (tipStartTime !== null) {
            const currentTime = Date.now();
            const sessionTime = Math.floor((currentTime - tipStartTime) / 1000);
            tipTimeAccumulated += sessionTime;
            tipStartTime = null;
            console.log(`页面隐藏，累计观看时间: ${tipTimeAccumulated}秒`);
          }
        } else {
          // 页面重新可见时，重新开始计时
          if (currentTipIndex !== -1) {
            tipStartTime = Date.now();
            console.log(`页面可见，重新开始计时`);
          }
        }
      });

      // Keyboard navigation
      document.addEventListener("keydown", async function (event) {
        switch (event.key) {
          case "ArrowLeft":
            await previousTip();
            break;
          case "ArrowRight":
            await nextTip();
            break;
          case "Escape":
            await closeTips();
            break;
        }
      });

      // Touch/swipe support for mobile
      let touchStartX = 0;
      let touchEndX = 0;

      document.addEventListener("touchstart", function (event) {
        touchStartX = event.changedTouches[0].screenX;
      });

      document.addEventListener("touchend", function (event) {
        touchEndX = event.changedTouches[0].screenX;
        handleSwipe();
      });

      async function handleSwipe() {
        const swipeThreshold = 50;
        const swipeDistance = touchEndX - touchStartX;

        if (Math.abs(swipeDistance) > swipeThreshold) {
          if (swipeDistance > 0) {
            await previousTip(); // Swipe right -> previous
          } else {
            await nextTip(); // Swipe left -> next
          }
        }
      }

      // Auto-advance timer (optional)
      let autoAdvanceTimer = null;

      function startAutoAdvance() {
        stopAutoAdvance();
        autoAdvanceTimer = setInterval(async () => {
          await nextTip();
        }, 8000); // Auto advance every 8 seconds
      }

      function stopAutoAdvance() {
        if (autoAdvanceTimer) {
          clearInterval(autoAdvanceTimer);
          autoAdvanceTimer = null;
        }
      }

      // Pause auto-advance on user interaction
      document.addEventListener("click", stopAutoAdvance);
      document.addEventListener("keydown", stopAutoAdvance);
      document.addEventListener("touchstart", stopAutoAdvance);

      // Listen for parent messages
      window.addEventListener("message", async function (event) {
        if (event.data.type === "showTips") {
          document.body.style.display = "flex";
          await initializeTips();
        }
      });

      // Initialize when loaded
      (async function () {
        await initializeTips();
        // 通知父窗口游戏已加载
        window.parent.postMessage({ type: "gameLoaded" }, "*");
      })();
      // Uncomment to enable auto-advance
      // startAutoAdvance();
    </script>
  </body>
</html>
