<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>抱抱龙的精神之海 - 主界面</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
      .cosmic-bg {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f0f23 50%, #1a1a2e 75%, #16213e 100%);
        position: relative;
        overflow: hidden;
      }

      .cosmic-bg::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(119, 198, 255, 0.3) 0%, transparent 50%);
        pointer-events: none;
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 2s infinite;
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 1;
        }
      }

      /* 侧边栏按钮样式 */
      .sidebar-nav {
        width: 100px;
        background: rgba(31, 41, 55, 0.8);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 0;
        gap: 1rem;
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 30;
      }

      .nav-button {
        width: 75px;
        height: 75px;
        border-radius: 12px;
        background: rgba(55, 65, 81, 0.6);
        border: none;
        color: #9ca3af;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
      }

      .nav-button:hover {
        background: rgba(139, 92, 246, 0.3);
        color: #c4b5fd;
        transform: translateY(-2px);
      }

      .nav-button.active {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
      }

      .nav-button svg {
        width: 26px;
        height: 26px;
      }

      .content-frame {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 8px;
        background: rgba(31, 41, 55, 0.3);
      }

      /* 主容器样式 */
      .main-container {
        min-height: 100vh;
        display: flex;
        padding-left: 100px; /* 为侧边栏留出空间 */
      }

      .content-area {
        flex: 1;
        padding: 1rem;
        display: flex;
        flex-direction: column;
      }

      /* 响应式布局 */
      @media (max-width: 767px) {
        .main-container {
          flex-direction: column;
          padding-left: 0;
          padding-top: 90px; /* 为移动端顶部导航留出空间 */
        }

        .sidebar-nav {
          width: 100%;
          height: 90px;
          flex-direction: row;
          justify-content: center;
          top: 0;
          left: 0;
          padding: 0.5rem;
        }

        .nav-button {
          width: 60px;
          height: 60px;
          font-size: 12px;
        }

        .nav-button svg {
          width: 20px;
          height: 20px;
        }

        .content-area {
          padding: 0.5rem;
        }
      }
    </style>
  </head>
  <body class="cosmic-bg min-h-screen text-white relative">
    <!-- 星星背景 -->
    <div class="absolute inset-0 pointer-events-none">
      <div class="star w-1 h-1" style="top: 10%; left: 10%; animation-delay: 0s"></div>
      <div class="star w-0.5 h-0.5" style="top: 20%; left: 80%; animation-delay: 0.5s"></div>
      <div class="star w-1 h-1" style="top: 70%; left: 20%; animation-delay: 1s"></div>
      <div class="star w-0.5 h-0.5" style="top: 80%; left: 90%; animation-delay: 1.5s"></div>
      <div class="star w-1 h-1" style="top: 30%; left: 70%; animation-delay: 2s"></div>
      <div class="star w-0.5 h-0.5" style="top: 50%; left: 15%; animation-delay: 2.5s"></div>
    </div>

    <!-- 主容器 -->
    <div class="relative z-10 main-container">
      <!-- 侧边导航栏 -->
      <nav class="sidebar-nav">
        <button class="nav-button active" data-page="tasks" id="navTasks">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
            ></path>
          </svg>
          任务
        </button>

        <button class="nav-button" data-page="wiki" id="navWiki">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
            ></path>
          </svg>
          百科
        </button>

        <button class="nav-button" data-page="inventory" id="navInventory">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
          </svg>
          背包
        </button>
      </nav>

      <!-- 内容区域 -->
      <div class="content-area">
        <!-- iframe 内容区域 -->
        <div id="iframeContent" class="flex-1">
          <iframe id="contentFrame" class="content-frame" src="about:blank"></iframe>
        </div>
      </div>
    </div>

    <script>
      class DragonMainInterface {
        constructor() {
          this.currentPage = "";
          this.navigationConfig = {
            tasks: {
              title: "任务",
              url: "dragon_task",
              isIframe: true,
            },
            feeding: {
              title: "喂养",
              url: "dragon_feed",
              isIframe: true,
            },
            inventory: {
              title: "背包",
              url: "dragon_bag",
              isIframe: true,
            },
            wiki: {
              title: "百科",
              url: "wiki_dashboard",
              isIframe: false,
            },
            settings: {
              title: "设置",
              url: "dragon_setting",
              isIframe: true,
            },
          };
          this.navigationInitialized = false;
          this.currentIframeUrl = "";

          this.initializeElements();
          this.bindEvents();
          this.initializeNavigation();
        }

        initializeElements() {
          this.contentFrame = document.getElementById("contentFrame");
          this.iframeContent = document.getElementById("iframeContent");
          this.navButtons = document.querySelectorAll(".nav-button");
        }
        bindEvents() {
          // 导航按钮事件
          this.navButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const pageId = button.dataset.page;
              this.navigateToPage(pageId);
            });
          });
        }

        getUrlFromUrlName(urlName, isIframe = true) {
          let finalUrl = urlName;

          // If URL does not begin with "http", construct relative URL
          if (!urlName.startsWith("http")) {
            // Replace current href's file name with the url string
            let currentUrl = window.location.href;
            currentUrl = currentUrl.split("?")[0];

            // For iframe, replace "dragon_main" with the urlName
            currentUrl = currentUrl.replace("dragon_main", urlName);

            // Forward all existing URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            finalUrl = `${currentUrl}?${urlParams.toString()}`;

            console.log(`构建${isIframe ? "iframe" : "非iframe"} URL: ${urlName} -> ${finalUrl}`);
          }

          return finalUrl;
        }
        initializeNavigation() {
          if (this.navigationInitialized) return;

          // 加载上次保存的页面状态，默认为任务页面
          let savedPage = localStorage.getItem("dragonmain_current_page") || "tasks";
          if (!this.navigationConfig[savedPage]) {
            savedPage = "tasks";
          }

          this.navigateToPage(savedPage);
          this.navigationInitialized = true;
        }
        navigateToPage(pageId) {
          if (this.currentPage === pageId) return;

          const pageConfig = this.navigationConfig[pageId];
          if (!pageConfig) {
            console.warn(`未找到页面配置: ${pageId}`);
            return;
          }

          console.log(`导航到页面: ${pageId}`);

          // 更新当前页面
          this.currentPage = pageId;

          // 更新导航按钮状态
          this.updateNavButtons(pageId); // 显示对应内容
          if (pageConfig.isIframe && pageConfig.url) {
            this.showIframeContent(pageConfig.url);
          } else if (!pageConfig.isIframe && pageConfig.url) {
            // 对于非iframe页面，使用window.location.replace
            const finalUrl = this.getUrlFromUrlName(pageConfig.url, false);

            console.log(`使用window.location.replace跳转到: ${finalUrl}`);
            window.location.replace(finalUrl);
            return; // 直接返回，不保存页面状态
          }

          // 保存当前页面状态
          localStorage.setItem("dragonmain_current_page", pageId);
        }

        updateNavButtons(activePageId) {
          this.navButtons.forEach((button) => {
            const pageId = button.dataset.page;
            if (pageId === activePageId) {
              button.classList.add("active");
            } else {
              button.classList.remove("active");
            }
          });
        }
        showIframeContent(url) {
          const finalUrl = this.getUrlFromUrlName(url, true);

          // 只有当URL改变时才刷新iframe
          if (this.currentIframeUrl !== finalUrl) {
            this.contentFrame.src = finalUrl;
            this.currentIframeUrl = finalUrl;
            console.log(`iframe URL已更新为: ${finalUrl}`);
          } else {
            console.log(`iframe URL未改变，保持: ${finalUrl}`);
          }
        }

        // 更新导航配置的方法
        updateNavigationConfig(newConfig) {
          this.navigationConfig = { ...this.navigationConfig, ...newConfig };
        }
      }

      let game_config = null;
      let gameLoaded = false;

      // 处理配置消息
      function handleConfig(configData) {
        console.log("接收到配置:", configData);

        // 获取已存在的DragonMainInterface实例或创建新实例
        const mainInterface = window.dragonMainInterface || new DragonMainInterface();

        // 处理导航配置
        if (configData.navigation) {
          mainInterface.updateNavigationConfig(configData.navigation);
        }

        // 处理左侧导航栏页面切换
        if (configData.selectTab && configData.selectTab.trim() !== "") {
          // 根据selectTab的值切换到对应页面
          mainInterface.navigateToPage(configData.selectTab);
        }

        // 保存实例引用
        window.dragonMainInterface = mainInterface;
      }

      // 监听来自父窗口的消息
      window.addEventListener("message", function (e) {
        switch (e.data.type) {
          case "setGameConfig":
            game_config = e.data.data;
            try {
              let configData = JSON.parse(game_config);
              console.log("游戏配置：", configData);
              handleConfig(configData);
            } catch (e) {
              console.error("解析配置失败:", e);
            }
            break;
          case "loadTaskConfig":
            window.parent.postMessage({ type: "loadTaskConfig" }, "*");
            break;
          case "loadBagConfig":
            window.parent.postMessage({ type: "loadBagConfig" }, "*");
            break;
          case "handleTask":
            console.log("Received handleTask message:", e.data.data);
            // 处理任务跳转逻辑
            const fulldata = e.data.data;
            const taskData = fulldata.taskData;
            if (taskData) {
              console.log("Handling task:", taskData);
              window.parent.postMessage(
                {
                  type: "handleTask",
                  data: {
                    task: taskData,
                    closeWindow: true,
                  },
                },
                "*"
              );
            }
            if (taskData && taskData.closeWindow) {
              console.log("Closing window as requested");
              // 可以添加关闭窗口的逻辑
            }
            break;
        }
      });

      // 延迟通知游戏加载完成
      setTimeout(() => {
        gameLoaded = true;
        window.parent.postMessage(
          {
            type: "gameLoaded",
            data: {
              gameName: "dragon_main",
            },
          },
          "*"
        );
      }, 100);

      // 创建主界面实例并保存到全局
      window.dragonMainInterface = new DragonMainInterface();
    </script>
  </body>
</html>
