
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«ç‹—å›¾åƒåˆ†ç±»å®è·µ - Blockly</title>    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <!-- Load the default blocks -->
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <!-- Load a generator -->
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <!-- Load a message file -->
    <script src="https://unpkg.com/blockly/msg/zh-hans.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .left-panel {
            flex: 2;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .right-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .control-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #4CAF50;
            border-radius: 5px;
            background: #f9f9f9;
            cursor: pointer;
        }
        
        button {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 5px 0;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        #preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 3px solid #4CAF50;
            display: none;
        }
        
        #result {
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            font-size: 16px;
            font-weight: bold;
        }
        
        .probability-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .probability-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }
        
        .cat-prob { background: linear-gradient(90deg, #ff6b6b, #ee5a5a); }
        .dog-prob { background: linear-gradient(90deg, #4ecdc4, #44b3ac); }
        
        #blocklyDiv {
            height: calc(100vh - 140px);
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .emoji {
            font-size: 24px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header">
                ğŸ± çŒ«ç‹—å›¾åƒåˆ†ç±»å®è·µ - Blockly ğŸ¶
            </div>
            <div id="blocklyDiv"></div>
        </div>
        
        <div class="right-panel">
            <div class="control-section">
                <div class="section-title">ğŸ“ å›¾åƒä¸Šä¼ </div>
                <input type="file" id="imageInput" accept="image/*">
                <img id="preview-image" alt="é¢„è§ˆå›¾åƒ">
            </div>
            
            <div class="control-section">
                <div class="section-title">ğŸš€ æ§åˆ¶é¢æ¿</div>
                <button onclick="runCode()">è¿è¡Œåˆ†ç±»ç¨‹åº</button>
                <button onclick="clearResult()">æ¸…ç©ºç»“æœ</button>
            </div>
            
            <div class="control-section" id="result-section">
                <div class="section-title">ğŸ“Š åˆ†ç±»ç»“æœ</div>
                <div id="result">ç­‰å¾…ä¸Šä¼ å›¾åƒå’Œè¿è¡Œç¨‹åº...</div>
                <div style="margin-top: 10px;">
                    <div>ğŸ± çŒ«å’ªæ¦‚ç‡:</div>
                    <div class="probability-bar">
                        <div class="probability-fill cat-prob" id="cat-prob" style="width: 0%"></div>
                    </div>
                    <div>ğŸ¶ å°ç‹—æ¦‚ç‡:</div>
                    <div class="probability-bar">
                        <div class="probability-fill dog-prob" id="dog-prob" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <script>
        // Global variables
        let model;
        let currentImage;
        let lastPrediction = null;
        let workspace;
        
        // åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
        async function loadModel() {
            try {
                // ä½¿ç”¨MobileNetæ¨¡å‹è¿›è¡Œæ¼”ç¤º
                model = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
                console.log('æ¨¡å‹åŠ è½½æˆåŠŸ!');
            } catch (error) {
                console.log('ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å‹');
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿæ¨¡å‹ç”¨äºæ¼”ç¤º
                model = tf.sequential({
                    layers: [
                        tf.layers.flatten({inputShape: [224, 224, 3]}),
                        tf.layers.dense({units: 2, activation: 'softmax'})
                    ]
                });
            }
        }

        // å›¾åƒä¸Šä¼ å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('imageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.getElementById('preview-image');
                        img.src = e.target.result;
                        img.style.display = 'block';
                        currentImage = img;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // å®ç°åŠŸèƒ½å‡½æ•°
        function uploadImage() {
            if (!currentImage) {
                document.getElementById('result').innerHTML = 'âš ï¸ è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾åƒï¼';
                return false;
            }
            document.getElementById('result').innerHTML = 'âœ… å›¾åƒä¸Šä¼ æˆåŠŸï¼';
            return true;
        }
        
        function preprocessImage() {
            document.getElementById('result').innerHTML = 'ğŸ”§ æ­£åœ¨é¢„å¤„ç†å›¾åƒ...';
            // æ¨¡æ‹Ÿé¢„å¤„ç†å»¶è¿Ÿ
            setTimeout(() => {
                document.getElementById('result').innerHTML = 'âœ… å›¾åƒé¢„å¤„ç†å®Œæˆï¼';
            }, 500);
        }
        
        async function classifyImage() {
            if (!currentImage) {
                document.getElementById('result').innerHTML = 'âŒ æ²¡æœ‰æ‰¾åˆ°å›¾åƒï¼';
                return;
            }
            
            document.getElementById('result').innerHTML = 'ğŸ¤– AIæ­£åœ¨åˆ†æå›¾åƒ...';
            
            // æ¨¡æ‹ŸAIåˆ†ç±»ï¼ˆéšæœºç»“æœç”¨äºæ¼”ç¤ºï¼‰
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const catProb = Math.random();
            const dogProb = 1 - catProb;
            
            lastPrediction = {
                class: catProb > dogProb ? 'cat' : 'dog',
                catProbability: catProb,
                dogProbability: dogProb
            };
            
            document.getElementById('result').innerHTML = 'âœ… åˆ†ç±»å®Œæˆï¼';
        }
        
        function showResult() {
            if (!lastPrediction) {
                document.getElementById('result').innerHTML = 'âŒ æ²¡æœ‰åˆ†ç±»ç»“æœï¼';
                return;
            }
            
            const result = lastPrediction.class === 'cat' ? 'ğŸ± è¿™æ˜¯ä¸€åªå¯çˆ±çš„çŒ«å’ªï¼' : 'ğŸ¶ è¿™æ˜¯ä¸€åªå¯çˆ±çš„å°ç‹—ï¼';
            const confidence = Math.max(lastPrediction.catProbability, lastPrediction.dogProbability);
            
            document.getElementById('result').innerHTML = 
                `${result}<br>ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%`;
                
            // æ›´æ–°æ¦‚ç‡æ¡
            document.getElementById('cat-prob').style.width = (lastPrediction.catProbability * 100) + '%';
            document.getElementById('dog-prob').style.width = (lastPrediction.dogProbability * 100) + '%';
        }
        
        function playSound(soundType) {
            const message = soundType === 'meow' ? 'ğŸ± å–µå–µï½' : 'ğŸ¶ æ±ªæ±ªï¼';
            document.getElementById('result').innerHTML += `<br>ğŸ”Š ${message}`;
            
            // ä½¿ç”¨Web Audio APIæ’­æ”¾ç®€å•éŸ³è°ƒï¼ˆæ¨¡æ‹ŸåŠ¨ç‰©å«å£°ï¼‰
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (soundType === 'meow') {
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                } else {
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('éŸ³é¢‘æ’­æ”¾ä¸æ”¯æŒ');
            }
        }

        // Wait for Blockly to load completely before defining custom blocks
        window.addEventListener('load', function() {
            // Get the JavaScript generator instance
            const javascriptGenerator = Blockly.JavaScript;
            
            // Define custom blocks using modern syntax
            Blockly.common.defineBlocksWithJsonArray([
                {
                    "type": "image_upload",
                    "message0": "ğŸ“ ä¸Šä¼ å›¾åƒ",
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 160,
                    "tooltip": "ä»æœ¬åœ°ä¸Šä¼ ä¸€å¼ å›¾åƒ",
                    "helpUrl": ""
                },
                {
                    "type": "image_preprocess",
                    "message0": "ğŸ”§ å›¾åƒé¢„å¤„ç† %1",
                    "args0": [
                        {
                            "type": "input_statement",
                            "name": "NAME"
                        }
                    ],
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 230,
                    "tooltip": "å¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œè°ƒæ•´å¤§å°å’Œå½’ä¸€åŒ–",
                    "helpUrl": ""
                },
                {
                    "type": "classify_image",
                    "message0": "ğŸ¤– å¼€å§‹åˆ†ç±»",
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 120,
                    "tooltip": "ä½¿ç”¨AIæ¨¡å‹å¯¹å›¾åƒè¿›è¡ŒçŒ«ç‹—åˆ†ç±»",
                    "helpUrl": ""
                },
                {
                    "type": "show_result",
                    "message0": "ğŸ“Š æ˜¾ç¤ºç»“æœ",
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 300,
                    "tooltip": "æ˜¾ç¤ºåˆ†ç±»ç»“æœå’Œæ¦‚ç‡",
                    "helpUrl": ""
                },
                {
                    "type": "if_cat",
                    "message0": "ğŸ± å¦‚æœæ˜¯çŒ«å’ª %1",
                    "args0": [
                        {
                            "type": "input_statement",
                            "name": "DO"
                        }
                    ],
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 65,
                    "tooltip": "å½“åˆ†ç±»ç»“æœä¸ºçŒ«æ—¶æ‰§è¡Œçš„æ“ä½œ",
                    "helpUrl": ""
                },
                {
                    "type": "if_dog",
                    "message0": "ğŸ¶ å¦‚æœæ˜¯å°ç‹— %1",
                    "args0": [
                        {
                            "type": "input_statement",
                            "name": "DO"
                        }
                    ],
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 200,
                    "tooltip": "å½“åˆ†ç±»ç»“æœä¸ºç‹—æ—¶æ‰§è¡Œçš„æ“ä½œ",
                    "helpUrl": ""
                },
                {
                    "type": "play_sound",
                    "message0": "ğŸ”Š æ’­æ”¾å£°éŸ³ %1",
                    "args0": [
                        {
                            "type": "field_dropdown",
                            "name": "SOUND",
                            "options": [
                                ["çŒ«å«", "meow"],
                                ["ç‹—å«", "woof"]
                            ]
                        }
                    ],
                    "previousStatement": null,
                    "nextStatement": null,
                    "colour": 290,
                    "tooltip": "æ’­æ”¾ç›¸åº”çš„åŠ¨ç‰©å«å£°",
                    "helpUrl": ""
                }
            ]);

            // Define generators using modern syntax
            javascriptGenerator.forBlock['image_upload'] = function(block, generator) {
                return 'uploadImage();\n';
            };
            
            javascriptGenerator.forBlock['image_preprocess'] = function(block, generator) {
                var statements = generator.statementToCode(block, 'NAME');
                return 'preprocessImage();\n' + statements;
            };
            
            javascriptGenerator.forBlock['classify_image'] = function(block, generator) {
                return 'await classifyImage();\n';
            };
            
            javascriptGenerator.forBlock['show_result'] = function(block, generator) {
                return 'showResult();\n';
            };
            
            javascriptGenerator.forBlock['if_cat'] = function(block, generator) {
                var statements = generator.statementToCode(block, 'DO');
                return 'if(lastPrediction && lastPrediction.class === "cat") {\n' + statements + '}\n';
            };
            
            javascriptGenerator.forBlock['if_dog'] = function(block, generator) {
                var statements = generator.statementToCode(block, 'DO');
                return 'if(lastPrediction && lastPrediction.class === "dog") {\n' + statements + '}\n';
            };
            
            javascriptGenerator.forBlock['play_sound'] = function(block, generator) {
                var sound = block.getFieldValue('SOUND');
                return 'playSound("' + sound + '");\n';
            };

            // Initialize Blockly workspace AFTER custom blocks are defined
            workspace = Blockly.inject('blocklyDiv', {
                toolbox: {
                    "kind": "categoryToolbox",
                    "contents": [
                        {
                            "kind": "category",
                            "name": "ğŸ–¼ï¸ å›¾åƒå¤„ç†",
                            "colour": 160,
                            "contents": [
                                {"kind": "block", "type": "image_upload"},
                                {"kind": "block", "type": "image_preprocess"}
                            ]
                        },
                        {
                            "kind": "category",
                            "name": "ğŸ¤– AIåˆ†ç±»",
                            "colour": 120,
                            "contents": [
                                {"kind": "block", "type": "classify_image"},
                                {"kind": "block", "type": "show_result"}
                            ]
                        },
                        {
                            "kind": "category",
                            "name": "ğŸ”€ æ¡ä»¶åˆ¤æ–­",
                            "colour": 210,
                            "contents": [
                                {"kind": "block", "type": "if_cat"},
                                {"kind": "block", "type": "if_dog"}
                            ]
                        },
                        {
                            "kind": "category",
                            "name": "ğŸµ å¤šåª’ä½“",
                            "colour": 290,
                            "contents": [
                                {"kind": "block", "type": "play_sound"}
                            ]
                        },
                        {
                            "kind": "category",
                            "name": "â° é€»è¾‘",
                            "colour": 210,
                            "contents": [
                                {"kind": "block", "type": "controls_if"},
                                {"kind": "block", "type": "controls_repeat_ext"},
                                {"kind": "block", "type": "logic_compare"}
                            ]
                        }
                    ]
                },
                grid: {spacing: 20, length: 3, colour: '#ccc', snap: true},
                trashcan: true,
                zoom: {controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2}
            });

            // Load default blocks
            const defaultXml = `
            <xml>
                <block type="image_upload" x="50" y="50">
                    <next>
                        <block type="image_preprocess">
                            <next>
                                <block type="classify_image">
                                    <next>
                                        <block type="show_result">
                                            <next>
                                                <block type="if_cat">
                                                    <statement name="DO">
                                                        <block type="play_sound">
                                                            <field name="SOUND">meow</field>
                                                        </block>
                                                    </statement>
                                                    <next>
                                                        <block type="if_dog">
                                                            <statement name="DO">
                                                                <block type="play_sound">
                                                                    <field name="SOUND">woof</field>
                                                                </block>
                                                            </statement>
                                                        </block>
                                                    </next>
                                                </block>
                                            </next>
                                        </block>
                                    </next>
                                </block>
                            </next>
                        </block>
                    </next>
                </block>
            </xml>`;

            try {
                workspace.clear();
                const xml = Blockly.Xml.textToDom(defaultXml);
                Blockly.Xml.domToWorkspace(xml, workspace);
                console.log('Default blocks loaded successfully');
            } catch (error) {
                console.error('Error loading default blocks:', error);
                console.log('Continuing without default blocks - you can drag blocks manually');
            }

            console.log('Blockly workspace initialized successfully');
        });

        // è¿è¡Œç”Ÿæˆçš„ä»£ç 
        async function runCode() {
            try {
                // ä½¿ç”¨ Blockly.JavaScript ç›´æ¥ç”Ÿæˆä»£ç 
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                console.log('ç”Ÿæˆçš„ä»£ç :', code);
                
                if (!code.trim()) {
                    document.getElementById('result').innerHTML = 'âŒ æ²¡æœ‰å¯æ‰§è¡Œçš„ä»£ç å—ï¼è¯·ä»å·¦ä¾§æ‹–æ‹½ä»£ç å—åˆ°å·¥ä½œåŒºã€‚';
                    return;
                }
                
                // ä½¿ç”¨å¼‚æ­¥å‡½æ•°åŒ…è£…å™¨æ¥æ”¯æŒawait
                const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                const asyncCode = new AsyncFunction(code);
                await asyncCode();
            } catch (error) {
                console.error('ä»£ç æ‰§è¡Œé”™è¯¯:', error);
                document.getElementById('result').innerHTML = 'âŒ ç¨‹åºæ‰§è¡Œå‡ºé”™: ' + error.message;
            }
        }
        
        function clearResult() {
            document.getElementById('result').innerHTML = 'ç­‰å¾…ä¸Šä¼ å›¾åƒå’Œè¿è¡Œç¨‹åº...';
            document.getElementById('cat-prob').style.width = '0%';
            document.getElementById('dog-prob').style.width = '0%';
            lastPrediction = null;
        }
        
        // åˆå§‹åŒ–
        loadModel();
    </script>
</body>
</html>
