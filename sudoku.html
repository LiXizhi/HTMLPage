<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°ç‹¬æŒ‘æˆ˜ - å¤šå…³å¡æ¸¸æˆ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow-x: hidden;
            height: 100vh;
            touch-action: manipulation;
            font-size: 16px; /* Increased base font size */
        }
        
        .game-container {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .sudoku-cell {
            transition: all 0.2s ease;
        }
        .sudoku-cell:hover {
            background-color: #e5e7eb;
        }
        .sudoku-cell.selected {
            background-color: #dbeafe !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .sudoku-cell.error {
            background-color: #fecaca !important;
            color: #dc2626;
        }
        .sudoku-cell.given {
            background-color: #6b7280;
            color: #ffffff;
            font-weight: bold;
        }
        .sudoku-cell.given:hover {
            background-color: #6b7280 !important;
        }
        
        /* Responsive Sudoku grid with larger text */
        .sudoku-grid {
            aspect-ratio: 1;
            max-width: min(90vw, 90vh - 200px);
            width: 100%;
        }
        
        .sudoku-block {
            border: 2px solid #1f2937;
            aspect-ratio: 1;
        }
        
        .sudoku-cell-responsive {
            aspect-ratio: 1;
            min-height: 35px; /* Increased from 30px */
            font-size: clamp(18px, 4vw, 24px); /* Increased from clamp(14px, 3vw, 20px) */
            font-weight: 600; /* Made text bolder */
        }
        
        .number-pad {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 0.75rem; /* Increased padding */
            z-index: 40;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Mobile optimizations with larger text */
        @media (max-width: 768px) {
            .game-header {
                padding: 0.75rem; /* Increased padding */
            }
            
            .number-pad {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 2px solid #e5e7eb;
                padding: 0.75rem; /* Increased padding */
                z-index: 40;
            }
            
            .game-content {
                padding-bottom: 140px; /* Increased from 120px */
            }
            
            .virtual-btn {
                min-height: 48px; /* Increased from 44px */
                font-size: 18px; /* Increased from 16px */
                font-weight: 600; /* Made text bolder */
            }
        }
        
        /* Header text sizes */
        .game-header {
            font-size: 16px; /* Increased base font size */
        }
        
        .game-header select {
            font-size: 14px; /* Increased from 12px */
            padding: 4px 8px; /* Increased padding */
        }
        
        .game-header .text-xs {
            font-size: 14px !important; /* Override Tailwind xs class */
        }
        
        /* Button text sizes */
        .btn-text-larger {
            font-size: 16px !important;
            padding: 8px 16px !important;
        }
        
        /* Modal text sizes */
        .modal-text-larger h2 {
            font-size: 1.75rem !important; /* Increased from 1.5rem */
        }
        
        .modal-text-larger h3 {
            font-size: 1.25rem !important; /* Increased from 1.125rem */
        }
        
        .modal-text-larger .text-sm {
            font-size: 16px !important; /* Increased from 14px */
        }
        
        .modal-text-larger button {
            font-size: 18px !important; /* Increased button text */
            padding: 12px 20px !important; /* Increased button padding */
        }
        
        @media (max-height: 600px) and (orientation: landscape) {
            .game-container {
                display: flex;
                flex-direction: row;
            }
            
            .game-main {
                flex: 1;
                overflow-y: auto;
            }
            
            .number-pad {
                position: relative;
                width: 220px; /* Increased from 200px */
                border-left: 2px solid #e5e7eb;
                border-top: none;
            }
            
            .game-content {
                padding-bottom: 0;
            }
        }
        
        /* Rules modal styles */
        .rules-modal {
            backdrop-filter: blur(4px);
        }
        
        .floating-rules-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            border-radius: 50%;
            width: 60px; /* Increased from 56px */
            height: 60px; /* Increased from 56px */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 24px; /* Increased icon size */
        }
        
        @media (max-width: 768px) {
            .floating-rules-btn {
                bottom: 160px; /* Adjusted for larger number pad */
            }
        }
        
        @media (max-height: 600px) and (orientation: landscape) {
            .floating-rules-btn {
                bottom: 20px;
                right: 240px; /* Adjusted for larger side panel */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50">
    <div class="game-container">
        <!-- æ¸¸æˆè§„åˆ™å¼¹çª— -->
        <div id="rulesModal" class="rules-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl max-w-2xl max-h-[90vh] overflow-y-auto modal-text-larger">
                <div class="p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">ğŸ¯ æ•°å­—æˆ˜å£«</h2>
                    <div class="text-xl">
                        <div>
                            <h3 class="text-2xl font-semibold text-gray-700 mb-4">ğŸ“‹ åŸºæœ¬è§„åˆ™</h3>
                            <ul class="space-y-3 text-gray-600">
                                <li class="flex items-start">
                                    <span class="text-blue-500 mr-3 text-lg">â€¢</span>
                                    <span >åœ¨9Ã—9çš„ç½‘æ ¼ä¸­å¡«å…¥æ•°å­—1-9</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-blue-500 mr-3 text-lg">â€¢</span>
                                    <span >æ¯ä¸€è¡Œéƒ½å¿…é¡»åŒ…å«1-9çš„æ•°å­—ï¼Œä¸èƒ½é‡å¤</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-blue-500 mr-3 text-lg">â€¢</span>
                                    <span >æ¯ä¸€åˆ—éƒ½å¿…é¡»åŒ…å«1-9çš„æ•°å­—ï¼Œä¸èƒ½é‡å¤</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-blue-500 mr-3 text-lg">â€¢</span>
                                    <span >æ¯ä¸ª3Ã—3çš„å°ä¹å®«æ ¼éƒ½å¿…é¡»åŒ…å«1-9çš„æ•°å­—ï¼Œä¸èƒ½é‡å¤</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <button id="startGameBtn" class="bg-green-500 text-white px-10 py-4 rounded-lg hover:bg-green-600 transition-colors font-bold text-2xl">
                            ğŸ® å¼€å§‹è®­ç»ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»æ¸¸æˆç•Œé¢ -->
        <div id="gameArea" class="game-main hidden">
            <!-- æ¸¸æˆå¤´éƒ¨ -->
            <div class="game-header bg-white shadow-sm border-b">
                <div class="flex justify-between items-center p-2 max-w-4xl mx-auto">
                    <div class="flex items-center space-x-2">
                        <select id="levelSelect" class="bg-white border border-gray-300 rounded px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="text-center">
                        <div id="currentLevel" class="text-base font-semibold text-gray-700"></div>
                        <div id="timer" class="text-base text-gray-500">00:00</div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="hintBtn" class="btn-text-larger bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition-colors">
                            æç¤º
                        </button>
                        <button id="resetBtn" class="btn-text-larger bg-green-500 text-white px-3 py-2 rounded hover:bg-red-600 transition-colors">
                            é‡ç½®
                        </button>
                    </div>
                </div>
                <div class="text-center pb-2">
                    <div id="progressInfo" class="text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- æ¸¸æˆå†…å®¹åŒºåŸŸ -->
            <div class="game-content flex flex-col items-center justify-center p-4">
                <!-- æ•°ç‹¬ç½‘æ ¼ -->
                <div class="sudoku-grid bg-white rounded-lg shadow-lg p-4 mb-4">
                    <div id="sudokuGrid" class="grid grid-cols-3 gap-0 border-2 border-gray-800 rounded">
                        <!-- 9ä¸ª3x3å—å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ•°å­—è¾“å…¥é¢æ¿ -->
            <div class="number-pad bg-white shadow-lg">
                <div class="flex justify-center flex-wrap gap-3 p-3">
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="1">1</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="2">2</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="3">3</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="4">4</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="5">5</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="6">6</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="7">7</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="8">8</button>
                    <button class="number-btn virtual-btn bg-blue-500 text-white w-14 h-14 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg" data-number="9">9</button>
                    <button id="eraseBtn" class="virtual-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-bold text-lg">
                        X
                    </button>
                </div>
                
            </div>
        </div>

        <!-- æµ®åŠ¨è§„åˆ™æŒ‰é’® -->
        <button id="floatingRulesBtn" class="floating-rules-btn hidden bg-blue-500 text-white hover:bg-blue-600 transition-colors flex items-center justify-center">
            <span class="text-xl">â”</span>
        </button>

        <!-- èƒœåˆ©å¼¹çª— -->
        <div id="victoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center modal-text-larger">
                <div class="text-6xl mb-6">ğŸ‰</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">æ­å–œé€šå…³ï¼</h2>
                <div id="victoryStats" class="text-gray-600 mb-8 text-base leading-relaxed"></div>
                <div class="space-x-4">
                    <button id="nextLevelBtn" class="bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600 transition-colors font-bold text-lg">
                        ä¸‹ä¸€å…³
                    </button>
                    <button id="continueBtn" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-colors font-bold text-lg">
                        ç»§ç»­æ¸¸æˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆç»Ÿè®¡å’Œæ¶ˆæ¯é€šä¿¡
        let game_config = '';
        let bestScore = 0;
        let currentGameScore = 0;

        // è®¡ç®—åˆ†æ•°ï¼šåŸºäºéš¾åº¦å’Œç”¨æ—¶ï¼Œæœ€é«˜100åˆ†
        function calculateScore(difficulty, timeInSeconds) {
            const maxScore = 100;
            let difficultyLevel = 1; // é»˜è®¤åˆçº§
            
            if (difficulty === 'ä¸­çº§') difficultyLevel = 2;
            else if (difficulty === 'é«˜çº§') difficultyLevel = 3;
            else if (difficulty === 'ä¸“å®¶') difficultyLevel = 3;
            
            // åŸºç¡€åˆ†æ•°ï¼šéš¾åº¦è¶Šé«˜åˆ†æ•°è¶Šé«˜
            const baseScore = difficultyLevel * 25; // åˆçº§25åˆ†ï¼Œä¸­çº§50åˆ†ï¼Œé«˜çº§75åˆ†
            
            // æ—¶é—´å¥–åŠ±ï¼š10åˆ†é’Ÿå†…å®Œæˆæœ‰æ—¶é—´å¥–åŠ±
            const timeBonus = Math.max(0, 25 - Math.floor(timeInSeconds / 24)); // æœ€å¤š25åˆ†æ—¶é—´å¥–åŠ±
            
            return Math.min(maxScore, baseScore + timeBonus);
        }

        // æ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data; // this is markdown or text string
                    // æ›´æ–°æ¸¸æˆé…ç½®é€»è¾‘
                    console.log('Game config updated:', game_config);
                    break;
                case 'getGameStats':
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: bestScore, // æ°¸è¿œè¿”å›æœ€é«˜åˆ†
                            difficulty: Math.min(3, Math.max(1, Math.ceil(game.currentLevel / 4))) // 1~3
                        }
                    }, '*');
                    break;
            }
        });

        class SudokuGame {
            constructor() {
                this.currentLevel = 1;
                this.selectedCell = null;
                this.gameGrid = Array(9).fill().map(() => Array(9).fill(0));
                this.solutionGrid = Array(9).fill().map(() => Array(9).fill(0));
                this.givenCells = Array(9).fill().map(() => Array(9).fill(false));
                this.timer = 0;
                this.timerInterval = null;
                this.completedLevels = JSON.parse(localStorage.getItem('completedLevels') || '[]');
                this.gameStarted = false;
                this.init();
            }

            init() {
                this.createLevelSelect();
                this.createSudokuGrid();
                this.bindEvents();
                this.setupTouchEvents(); // æ·»åŠ è§¦æ§äº‹ä»¶
                // å‘é€æ¸¸æˆåŠ è½½å®Œæˆäº‹ä»¶
                window.parent.postMessage({ type: 'gameLoaded' }, '*');
                // ä¸è‡ªåŠ¨å¼€å§‹ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»å¼€å§‹æ¸¸æˆ
            }

            // æ·»åŠ è§¦æ§äº‹ä»¶æ”¯æŒ
            setupTouchEvents() {
                // é˜²æ­¢åŒå‡»ç¼©æ”¾
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    let now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // å¤„ç†æ–¹å‘å˜åŒ–
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.handleOrientationChange();
                    }, 100);
                });
            }

            // å¤„ç†å±å¹•æ–¹å‘å˜åŒ–
            handleOrientationChange() {
                // é‡æ–°è®¡ç®—å¸ƒå±€
                if (window.innerHeight < 600 && window.orientation !== 0) {
                    document.body.classList.add('landscape-mode');
                } else {
                    document.body.classList.remove('landscape-mode');
                }
            }

            createLevelSelect() {
                const select = document.getElementById('levelSelect');
                select.innerHTML = '';

                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    const difficulty = this.getDifficulty(i);
                    const isCompleted = this.completedLevels.includes(i);
                    //const isLocked = i > 1 && !this.completedLevels.includes(i - 1);
                    const isLocked = false;
                    
                    option.value = i;
                    option.textContent = `ç¬¬${i}å…³ - ${difficulty.name}${isCompleted ? ' âœ…' : ''}${isLocked ? ' ğŸ”’' : ''}`;
                    option.disabled = isLocked;
                    
                    select.appendChild(option);
                }

                select.addEventListener('change', (e) => {
                    this.startLevel(parseInt(e.target.value));
                });
            }

            getDifficulty(level) {
                if (level <= 3) return { name: 'åˆçº§', clues: 45 + Math.floor(Math.random() * 6) };
                if (level <= 6) return { name: 'ä¸­çº§', clues: 35 + Math.floor(Math.random() * 6) };
                if (level <= 9) return { name: 'é«˜çº§', clues: 25 + Math.floor(Math.random() * 6) };
                return { name: 'ä¸“å®¶', clues: 17 + Math.floor(Math.random() * 6) };
            }

            startLevel(level) {
                this.currentLevel = level;
                document.getElementById('levelSelect').value = level;
                const difficulty = this.getDifficulty(level);
                document.getElementById('currentLevel').textContent = `ç¬¬${level}å…³ - ${difficulty.name}`;
                document.getElementById('progressInfo').textContent = `å·²å®Œæˆ: ${this.completedLevels.length}/12 å…³`;
                this.generatePuzzle();
                this.startTimer();
                
                // å‘é€æ¸¸æˆå¼€å§‹äº‹ä»¶
                if (!this.gameStarted) {
                    window.parent.postMessage({ type: 'gameStarted' }, '*');
                    this.gameStarted = true;
                }
            }

            generatePuzzle() {
                // ç”Ÿæˆå®Œæ•´çš„æ•°ç‹¬è§£
                this.generateSolution();
                // æ ¹æ®éš¾åº¦ç§»é™¤æ•°å­—
                this.createPuzzle();
                this.renderGrid();
            }

            generateSolution() {
                // æ¸…ç©ºç½‘æ ¼
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        this.solutionGrid[i][j] = 0;
                    }
                }
                
                // ä½¿ç”¨å›æº¯ç®—æ³•å¡«å……ç½‘æ ¼
                this.solveSudoku(this.solutionGrid);
            }

            solveSudoku(grid) {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (grid[row][col] === 0) {
                            const numbers = this.shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
                            for (let num of numbers) {
                                if (this.isValidMove(grid, row, col, num)) {
                                    grid[row][col] = num;
                                    if (this.solveSudoku(grid)) {
                                        return true;
                                    }
                                    grid[row][col] = 0;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            }

            createPuzzle() {
                // å¤åˆ¶è§£åˆ°æ¸¸æˆç½‘æ ¼
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        this.gameGrid[i][j] = this.solutionGrid[i][j];
                        this.givenCells[i][j] = true;
                    }
                }

                // æ ¹æ®éš¾åº¦ç§»é™¤æ•°å­—
                const difficulty = this.getDifficulty(this.currentLevel);
                const toRemove = 81 - difficulty.clues;
                const cells = [];
                
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        cells.push([i, j]);
                    }
                }

                const shuffledCells = this.shuffleArray(cells);
                for (let i = 0; i < toRemove; i++) {
                    const [row, col] = shuffledCells[i];
                    this.gameGrid[row][col] = 0;
                    this.givenCells[row][col] = false;
                }
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            createSudokuGrid() {
                const grid = document.getElementById('sudokuGrid');
                grid.innerHTML = '';

                // åˆ›å»º9ä¸ª3x3çš„å—
                for (let blockRow = 0; blockRow < 3; blockRow++) {
                    for (let blockCol = 0; blockCol < 3; blockCol++) {
                        const block = document.createElement('div');
                        block.className = 'sudoku-block grid grid-cols-3 gap-0';
                        
                        // åœ¨æ¯ä¸ªå—ä¸­åˆ›å»º9ä¸ªå•å…ƒæ ¼
                        for (let cellRow = 0; cellRow < 3; cellRow++) {
                            for (let cellCol = 0; cellCol < 3; cellCol++) {
                                const actualRow = blockRow * 3 + cellRow;
                                const actualCol = blockCol * 3 + cellCol;
                                
                                const cell = document.createElement('div');
                                cell.className = `sudoku-cell sudoku-cell-responsive bg-white border border-gray-300 flex items-center justify-center cursor-pointer font-semibold select-none`;
                                cell.dataset.row = actualRow;
                                cell.dataset.col = actualCol;

                                // ä½¿ç”¨touchstartä»¥æé«˜ç§»åŠ¨ç«¯å“åº”é€Ÿåº¦
                                cell.addEventListener('touchstart', (e) => {
                                    e.preventDefault();
                                    this.selectCell(actualRow, actualCol);
                                });
                                cell.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    this.selectCell(actualRow, actualCol);
                                });
                                
                                block.appendChild(cell);
                            }
                        }
                        
                        grid.appendChild(block);
                    }
                }
            }

            renderGrid() {
                const cells = document.querySelectorAll('.sudoku-cell');
                cells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const value = this.gameGrid[row][col];
                    
                    cell.textContent = value === 0 ? '' : value;
                    cell.classList.remove('given', 'error');
                    
                    if (this.givenCells[row][col]) {
                        cell.classList.add('given');
                    }
                });
            }

            selectCell(row, col) {
                if (this.givenCells[row][col]) return;

                // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„å•å…ƒæ ¼
                document.querySelectorAll('.sudoku-cell').forEach(cell => {
                    cell.classList.remove('selected');
                });

                // é€‰ä¸­æ–°å•å…ƒæ ¼
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.classList.add('selected');
                this.selectedCell = { row, col };
            }

            inputNumber(number) {
                if (!this.selectedCell) return;
                
                const { row, col } = this.selectedCell;
                if (this.givenCells[row][col]) return;

                this.gameGrid[row][col] = number;
                this.renderGrid();
                this.checkErrors();
                this.checkErrorLimit(); // æ·»åŠ é”™è¯¯é™åˆ¶æ£€æŸ¥
                
                if (this.isPuzzleComplete()) {
                    this.onVictory();
                }
            }

            eraseCell() {
                if (!this.selectedCell) return;
                
                const { row, col } = this.selectedCell;
                if (this.givenCells[row][col]) return;

                this.gameGrid[row][col] = 0;
                this.renderGrid();
                this.checkErrors();
            }

            checkErrors() {
                const cells = document.querySelectorAll('.sudoku-cell');
                cells.forEach(cell => {
                    cell.classList.remove('error');
                });

                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (this.gameGrid[i][j] !== 0 && !this.isValidMove(this.gameGrid, i, j, this.gameGrid[i][j], true)) {
                            const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
                            cell.classList.add('error');
                        }
                    }
                }
            }

            isValidMove(grid, row, col, num, checkExisting = false) {
                // å¦‚æœæ˜¯æ£€æŸ¥ç°æœ‰æ•°å­—ï¼Œæš‚æ—¶æ¸…é™¤è¯¥ä½ç½®çš„æ•°å­—
                const originalValue = grid[row][col];
                if (checkExisting) {
                    grid[row][col] = 0;
                }

                // æ£€æŸ¥è¡Œ
                for (let j = 0; j < 9; j++) {
                    if (grid[row][j] === num) {
                        if (checkExisting) grid[row][col] = originalValue;
                        return false;
                    }
                }

                // æ£€æŸ¥åˆ—
                for (let i = 0; i < 9; i++) {
                    if (grid[i][col] === num) {
                        if (checkExisting) grid[row][col] = originalValue;
                        return false;
                    }
                }

                // æ£€æŸ¥ä¹å®«æ ¼
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let i = startRow; i < startRow + 3; i++) {
                    for (let j = startCol; j < startCol + 3; j++) {
                        if (grid[i][j] === num) {
                            if (checkExisting) grid[row][col] = originalValue;
                            return false;
                        }
                    }
                }

                if (checkExisting) grid[row][col] = originalValue;
                return true;
            }

            isPuzzleComplete() {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (this.gameGrid[i][j] === 0) return false;
                    }
                }
                return true;
            }

            onVictory() {
                this.stopTimer();
                
                // è®¡ç®—å½“å‰æ¸¸æˆåˆ†æ•°
                const difficulty = this.getDifficulty(this.currentLevel);
                currentGameScore = calculateScore(difficulty.name, this.timer);
                
                // æ›´æ–°æœ€é«˜åˆ†
                if (currentGameScore > bestScore) {
                    bestScore = currentGameScore;
                    localStorage.setItem('bestScore', bestScore.toString());
                }
                
                // ä¿å­˜å®Œæˆçš„å…³å¡
                if (!this.completedLevels.includes(this.currentLevel)) {
                    this.completedLevels.push(this.currentLevel);
                    localStorage.setItem('completedLevels', JSON.stringify(this.completedLevels));
                    this.createLevelSelect(); // æ›´æ–°ä¸‹æ‹‰æ¡†
                }

                // å‘é€æ¸¸æˆå®Œæˆäº‹ä»¶
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: { 
                        score: Math.min(100, Math.max(0, currentGameScore)), // ç¡®ä¿åˆ†æ•°åœ¨0-100èŒƒå›´å†…
                        bestScore: bestScore,
                        difficulty: Math.min(3, Math.max(1, Math.ceil(this.currentLevel / 4))),
                        level: this.currentLevel,
                        timeUsed: this.timer,
                        isSuccess: true
                    }
                }, '*');

                // æ˜¾ç¤ºèƒœåˆ©å¼¹çª—
                const minutes = Math.floor(this.timer / 60);
                const seconds = this.timer % 60;
                document.getElementById('victoryStats').innerHTML = `
                    <div>ç”¨æ—¶: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</div>
                    <div>éš¾åº¦: ${this.getDifficulty(this.currentLevel).name}</div>
                    <div>æœ¬æ¬¡åˆ†æ•°: ${currentGameScore}åˆ†</div>
                    <div>æœ€é«˜åˆ†æ•°: ${bestScore}åˆ†</div>
                    <div>å®Œæˆè¿›åº¦: ${this.completedLevels.length}/12</div>
                `;

                // æ§åˆ¶ä¸‹ä¸€å…³æŒ‰é’®æ˜¾ç¤º
                const nextBtn = document.getElementById('nextLevelBtn');
                if (this.currentLevel < 12) {
                    nextBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.add('hidden');
                }

                document.getElementById('victoryModal').classList.remove('hidden');
            }

            // æ·»åŠ æ¸¸æˆå¤±è´¥é€»è¾‘ - è¶…æ—¶è‡ªåŠ¨ç»“æŸ
            onGameTimeout() {
                this.stopTimer();
                
                // è®¡ç®—å¤±è´¥æ—¶çš„åˆ†æ•°ï¼ˆè¾ƒä½åˆ†æ•°ï¼‰
                const timeoutScore = Math.max(5, 25 - Math.floor(this.timer / 120)); // åŸºäºç”¨æ—¶ç»™äºˆå°‘é‡åˆ†æ•°
                currentGameScore = timeoutScore;
                
                // å‘é€æ¸¸æˆå®Œæˆäº‹ä»¶
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: { 
                        score: Math.min(100, Math.max(0, currentGameScore)), // ç¡®ä¿åˆ†æ•°åœ¨0-100èŒƒå›´å†…
                        bestScore: bestScore,
                        difficulty: Math.min(3, Math.max(1, Math.ceil(this.currentLevel / 4))),
                        level: this.currentLevel,
                        timeUsed: this.timer,
                        isSuccess: false
                    }
                }, '*');
            }

            giveHint() {
                const emptyCells = [];
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (this.gameGrid[i][j] === 0) {
                            emptyCells.push([i, j]);
                        }
                    }
                }

                if (emptyCells.length === 0) return;

                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const [row, col] = randomCell;
                this.gameGrid[row][col] = this.solutionGrid[row][col];
                this.renderGrid();

                if (this.isPuzzleComplete()) {
                    this.onVictory();
                }
            }

            resetPuzzle() {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (!this.givenCells[i][j]) {
                            this.gameGrid[i][j] = 0;
                        }
                    }
                }
                this.renderGrid();
                this.timer = 0;
                this.startTimer();
            }

            startTimer() {
                this.stopTimer();
                this.timer = 0;
                this.updateTimerDisplay();
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    this.updateTimerDisplay();
                    
                    // æ·»åŠ è¶…æ—¶æ£€æŸ¥ - æ ¹æ®éš¾åº¦è®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´
                    const difficulty = this.getDifficulty(this.currentLevel);
                    let maxTime = 1800; // 30åˆ†é’ŸåŸºç¡€æ—¶é—´
                    
                    if (difficulty.name === 'åˆçº§') maxTime = 1200; // 20åˆ†é’Ÿ
                    else if (difficulty.name === 'ä¸­çº§') maxTime = 1500; // 25åˆ†é’Ÿ
                    else if (difficulty.name === 'é«˜çº§') maxTime = 1800; // 30åˆ†é’Ÿ
                    else if (difficulty.name === 'ä¸“å®¶') maxTime = 2100; // 35åˆ†é’Ÿ
                    
                    if (this.timer >= maxTime) {
                        this.onGameTimeout();
                    }
                }, 1000);
            }

            // æ·»åŠ é”™è¯¯æ¬¡æ•°æ£€æŸ¥é€»è¾‘
            checkErrorLimit() {
                if (!this.errorCount) this.errorCount = 0;
                
                let errorCells = 0;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (this.gameGrid[i][j] !== 0 && !this.isValidMove(this.gameGrid, i, j, this.gameGrid[i][j], true)) {
                            errorCells++;
                        }
                    }
                }
                
                // å¦‚æœé”™è¯¯æ•°é‡è¿‡å¤šï¼ˆè¶…è¿‡10ä¸ªï¼‰ï¼Œè‡ªåŠ¨ç»“æŸæ¸¸æˆ
                if (errorCells > 10) {
                    this.onGameTimeout(); // å¤ç”¨è¶…æ—¶é€»è¾‘
                }
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timer / 60);
                const seconds = this.timer % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            bindEvents() {
                // æ•°å­—æŒ‰é’® - æ·»åŠ è§¦æ§æ”¯æŒ
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.inputNumber(parseInt(btn.dataset.number));
                    });
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.inputNumber(parseInt(btn.dataset.number));
                    });
                });

                // å…¶ä»–æŒ‰é’® - æ·»åŠ è§¦æ§æ”¯æŒ
                const eraseBtn = document.getElementById('eraseBtn');
                eraseBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.eraseCell();
                });
                eraseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.eraseCell();
                });

                document.getElementById('hintBtn').addEventListener('click', () => this.giveHint());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetPuzzle());
                
                // è§„åˆ™ç›¸å…³æŒ‰é’®
                document.getElementById('startGameBtn').addEventListener('click', () => {
                    document.getElementById('rulesModal').classList.add('hidden');
                    document.getElementById('gameArea').classList.remove('hidden');
                    document.getElementById('floatingRulesBtn').classList.remove('hidden');
                    this.startLevel(1);
                });

                document.getElementById('floatingRulesBtn').addEventListener('click', () => {
                    document.getElementById('rulesModal').classList.remove('hidden');
                });

                // èƒœåˆ©å¼¹çª—æŒ‰é’®
                document.getElementById('nextLevelBtn').addEventListener('click', () => {
                    document.getElementById('victoryModal').classList.add('hidden');
                    if (this.currentLevel < 12) {
                        this.startLevel(this.currentLevel + 1);
                    }
                });
                
                document.getElementById('continueBtn').addEventListener('click', () => {
                    document.getElementById('victoryModal').classList.add('hidden');
                });

                // é”®ç›˜è¾“å…¥ - ä¿æŒPCç«¯æ”¯æŒ
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '9') {
                        this.inputNumber(parseInt(e.key));
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        this.eraseCell();
                    }
                });

                // é˜²æ­¢ç§»åŠ¨ç«¯è¯¯è§¦å‘å³é”®èœå•
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€é«˜åˆ†
        bestScore = parseInt(localStorage.getItem('bestScore') || '0');

        // å¯åŠ¨æ¸¸æˆ
        const game = new SudokuGame();
    </script>
</body>
</html>

