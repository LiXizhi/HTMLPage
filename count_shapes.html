<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>寻宝大师</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/ms_games_utils.js?v=1.0.0"></script>
    <link rel="stylesheet" href="https://cdn.keepwork.com/keepwork/cdn/ms_games_base.css">
    <style>
        body {
            background-color: #8A83FF;
        }

        .game-container {
            display: flex;
            gap: 0.4rem;
            width: 65.2rem;
            height: 37.5rem;
            position: relative;
            padding: 1.2rem;
            overflow-y: auto;
        }

        /* SVG形状样式 */
        .svg-shape {
            position: absolute;
            transition: all 0.3s ease;
            user-select: none;
            cursor: pointer;
            opacity: 0.9;
            visibility: visible;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* 添加这个新的CSS规则来统一边框粗细 */
        .svg-shape svg * {
            vector-effect: non-scaling-stroke !important;
            stroke-width: 1.5 !important;
        }

        .svg-shape:hover {
            opacity: 1;
            transform: scale(1.1);
            z-index: 1000 !important;
        }

        .svg-shape:active {
            transform: scale(1.2);
        }

        .shape-icon {
            width: 35px;
            height: 35px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .shape-icon-svg {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shape-icon-svg svg {
            width: 100%;
            height: 100%;
        }

        .canvas-container {
            position: relative;
            width: 28.8rem;
            height: 29.3rem;
            border: 0.2rem solid #DFDDFF;
            background: white;
            border-radius: 0.8rem;
            overflow: hidden;
        }

        .counting-grid {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            align-content: start;
            gap: 1.2rem;
        }

        .game-section {
            display: flex;
            flex-direction: column;
            width: 31.2rem;
            padding: 1.2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .game-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .count-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            width: 8.8rem;
            height: 7.6rem;
            padding: 1.2rem 0.9rem 0.9rem;
            background-color: #F9F9FF;
            border: 0.1rem solid #DFDDFF;
            border-radius: 0.8rem;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .count-card-icon {
            margin-bottom: 1rem;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .count-card-icon svg {
            width: 3rem;
            height: 3rem;
        }

        .count-input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 7.2rem;
            height: 2rem;
            padding: 0.1rem;
            background-color: #E3F1FF;
            border-radius: 0.4rem;
        }

        .count-btn {
            width: 1.8rem;
            height: 1.8rem;
            background: white;
            border-radius: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: #3776F8;
            transition: all 0.2s ease;
            touch-action: manipulation;
            flex-shrink: 0;
            position: relative;
            font-size: 0;
        }

        .count-btn:active {
            transform: scale(0.95);
        }

        /* 减号：一个横条 */
        .count-btn::before {
            content: '';
            position: absolute;
            width: 0.6rem;
            height: 0.1rem;
            background-color: #3776F8;
            border-radius: 0.1rem;
        }

        /* 加号：横条 + 竖条 */
        .count-btn.plus::after {
            content: '';
            position: absolute;
            width: 0.1rem;
            height: 0.6rem;
            background-color: #3776F8;
            border-radius: 0.1rem;
        }

        .count-display {
            min-width: 2rem;
            width: 2rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: #374151;
            background: transparent;
            border: none;
            outline: none;
            flex-shrink: 0;
        }

        /* 计时器样式 */
        .timer-display {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 5.2rem;
            height: 2.6rem;
            background-color: #9B95FF;
            border-radius: 0.8rem;
            color: #FFF;
        }

        .game-btn-reset {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 4rem;
            height: 2.6rem;
            background-color: #6A60FF;
            border-radius: 0.4rem;
            box-shadow: 0 0.4rem 0 0 #8A83FF;
            color: #FFF;
        }

        .game-btn-check,
        .game-btn-clear {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 12rem;
            height: 3rem;
            margin: 0 auto;
            border-radius: 0.8rem;
            font-weight: 500;
            color: #FFF;
        }

        .game-btn-check {
            background-color: #8EC625;
            box-shadow: 0 0.4rem 0 0 #17A34A;
        }

        .game-btn-clear {
            background-color: #626774;
            box-shadow: 0 0.4rem 0 0 #3E4454;
        }

        /* 游戏按钮 */
        .game-btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            transition: all 0.2s;
            touch-action: manipulation;
            user-select: none;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            border: none;
            cursor: pointer;
        }

        .game-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .game-btn:active {
            transform: translateY(0);
        }

        /* 帮助按钮 */
        .help-btn {
            position: absolute;
            width: 3.8rem;
            height: 3.8rem;
            right: 0.4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
            touch-action: manipulation;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .rules-btn {
            bottom: 0.4rem;
            background-image: url("https://qiniu-public.keepwork.com/paracraft-cdn-resource/Web/ms_games/icon/game_rule.png");
        }

        .points-btn {
            bottom: 4.2rem;
            background-image: url("https://qiniu-public.keepwork.com/paracraft-cdn-resource/Web/ms_games/icon/game_points.png");
        }

        /* 规则弹窗 */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            overflow-y: auto;
            /* 确保在iOS Safari等浏览器中正确显示 */
            -webkit-overflow-scrolling: touch;
            /* 使用动态视口高度 */
            height: 100dvh;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        .rules-content {
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            width: 39rem;
            padding: 2.2rem 2.2rem 1.8rem;
            background-color: #FFFFFF;
            border-radius: 0.8rem;
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.6rem;
        }

        .rules-sign {
            width: 0.6rem;
            height: 1.8rem;
            margin-right: 0.6rem;
            background-color: #009DFF;
            border-radius: 0.6rem;
        }

        .close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            touch-action: manipulation;
            font-weight: normal;
        }

        .rules-title {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .rules-sections {
            list-style-type: decimal;
            margin-left: 1.4rem;
        }

        .rules-sections li {
            margin-bottom: 1rem;
        }

        .rules-start-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem auto 0;
            width: 12rem;
            height: 3rem;
            background-color: #009DFF;
            border-radius: 0.8rem;
            font-weight: 600;
            color: #FFF;
            border: none;
            cursor: pointer;
        }



        /* 积分弹窗样式 */
        .points-modal {
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            width: 39rem;
            padding: 2.2rem 2.2rem 1.8rem;
            background-color: #FFFFFF;
            border-radius: 0.8rem;
        }

        .points-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .points-sign {
            width: 0.6rem;
            height: 1.8rem;
            margin-right: 0.6rem;
            background-color: #FF9A00;
            border-radius: 0.6rem;
        }

        .points-title {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .points-close {
            cursor: pointer;
            font-weight: normal;
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .points-modal-content {
            display: flex;
            flex-direction: column;
        }

        .points-stats-section {
            background-color: #FDECE2;
            border-radius: 0.8rem;
            padding: 0.8rem 1.3rem 1rem 2.5rem;
            margin-bottom: 0.2rem;
        }

        .points-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }

        .points-subtitle {
            position: relative;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: #333;
        }

        .points-subtitle::before {
            content: '';
            display: inline-block;
            position: absolute;
            left: -1.2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.4rem;
            height: 0.4rem;
            background-color: #FF9A00;
            border-radius: 50%;
        }

        .points-stats-grid {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .points-stat-item {
            display: flex;
            align-items: center;
            width: 14.6rem;
            height: 3.6rem;
            padding: 0 1.2rem;
            background-color: #ffffff;
            border-radius: 0.8rem;
        }

        .points-stat-label {
            color: #999999;
            font-size: 1.2rem;
        }

        .points-stat-value {
            margin-left: 1.2rem;
            font-weight: 600;
            font-size: 1.8rem;
        }

        .points-stat-value.total {
            color: #FF5800;
        }

        .points-stat-value.daily {
            color: #22C55E;
        }

        .points-rules-section {
            padding: 0.8rem 1.3rem 0 2.5rem;
        }

        .points-rules-list-warpper {
            width: 100%;
            max-height: 7.2rem;
            overflow-y: auto;
        }

        .points-rules-list {
            list-style-type: none;
            display: inline-block;
        }

        .points-rules-list-warpper::-webkit-scrollbar {
            width: 0.2rem;
        }

        .points-rules-list-warpper::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 0.2rem;
        }

        .points-rules-list li {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            color: #333333;
        }

        .points-rules-list li:last-child {
            margin-bottom: 0;
        }

        .points-rule-name {
            display: inline-block;
        }

        .points-rule-value {
            margin-left: 2rem;
            color: #FF9500;
            font-weight: 600;
        }

        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 标题区域 */
        .game-title {
            text-align: center;
            padding: 1rem 0.5rem 0.5rem;
        }

        .game-title h1 {
            font-size: 2.25rem;
            font-weight: bold;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }
        
        /* 难度选择器样式 */
        .difficulty-selector {
            position: relative;
            width: 8.8rem;
            height: 2.6rem;
            color: #333;
        }

        .difficulty-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2rem 0.6rem;
            background-color: #FFF1DF;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 100%;
        }

        .difficulty-selector-header.active {
            border-color: #4196FF;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .difficulty-selector-arrow {
            width: 0;
            height: 0;
            border-left: 0.3rem solid transparent;
            border-right: 0.3rem solid transparent;
            border-top: 0.4rem solid #333;
            transition: transform 0.2s ease;
        }

        .difficulty-selector-header.active .difficulty-selector-arrow {
            transform: rotate(180deg);
        }

        .difficulty-selector-dropdown {
            position: absolute;
            top: 2.6rem;
            left: 0;
            right: 0;
            background-color: #FFF1DF;
            border-top: none;
            border-bottom-left-radius: 0.4rem;
            border-bottom-right-radius: 0.4rem;
            z-index: 100;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .difficulty-selector-dropdown.show {
            max-height: 20rem;
            opacity: 1;
        }

        .difficulty-selector-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 2.6rem;
            padding: 0.2rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .difficulty-selector-option:last-child {
            border-bottom: none;
        }

        .difficulty-selector-option.selected {
            background-color: #DBEAFE;
            color: #4196FF;
            font-weight: 600;
        }

        .difficulty-selector-option:hover:not(.selected) {
            background-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes pulse-urgent {
            0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
            50% { transform: scale(1.1); box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3); }
        }

        /* 难度选择器高亮动画 */
        .difficulty-highlight {
            animation: difficulty-pulse 2s ease-in-out;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3) !important;
        }

        @keyframes difficulty-pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
                border-color: #3b82f6;
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.5);
                border-color: #1d4ed8;
            }
        }

        /* 统一交互式弹窗样式 */
        .interactive-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .interactive-modal-overlay.show {
            display: flex;
        }

        .interactive-modal {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            min-width: 30rem;
            max-height: 35.1rem;
            padding: 2.4rem 2.4rem 1.6rem;
            border-radius: 0.8rem;
            background-color: #FFFFFF;
        }

        .interactive-modal .modal-title {
            margin-bottom: 1.2rem;
        }

        .interactive-modal .modal-content {
            width: 100%;
            overflow-y: auto;
        }

        .interactive-modal .buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 1.2rem;
        }

        .interactive-modal .button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 12rem;
            height: 3rem;
            border-radius: 0.4rem;
            color: #FFF;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .interactive-modal .button:active {
            transform: scale(0.95);
        }

        .interactive-modal .button.cancel {
            background-color: #626774;
        }

        .interactive-modal .button.confirm {
            background-color: #7AA3FF;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 游戏画布 -->
        <div class="game-section">
            <div class="game-section-header">
                <h2 class="text-14" style="font-weight: 600;">数一数每种图形的数量</h2>
                <div class="flex items-center gap-4 text-sm text-gray-500">
                    <div class="flex items-center gap-2 hidden">
                        <span class="text-base">年龄组:</span>
                        <select id="ageGroupSelect" class="difficulty-select" style="display:none;">
                            <option value="younger">5-7岁 (幼儿)</option>
                            <option value="older">8岁以上 (少年)</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="difficulty-selector text-14" id="difficultySelector">
                            <div class="difficulty-selector-header" id="difficultySelectorHeader">
                                <span>难度</span>
                                <span style="font-weight: 500;" id="difficultySelectedText">中等</span>
                                <div class="difficulty-selector-arrow"></div>
                            </div>
                            <div class="difficulty-selector-dropdown" id="difficultySelectorDropdown">
                                <div class="difficulty-selector-option" data-value="1">
                                    <span style="opacity: 0;">难度</span>
                                    <span style="font-weight: 500;">简单</span>
                                    <div class="difficulty-selector-arrow" style="opacity: 0;"></div>
                                </div>
                                <div class="difficulty-selector-option selected" data-value="2">
                                    <span style="opacity: 0;">难度</span>
                                    <span style="font-weight: 500;">中等</span>
                                    <div class="difficulty-selector-arrow" style="opacity: 0;"></div>
                                </div>
                                <div class="difficulty-selector-option" data-value="3">
                                    <span style="opacity: 0;">难度</span>
                                    <span style="font-weight: 500;">困难</span>
                                    <div class="difficulty-selector-arrow" style="opacity: 0;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="newGame" class="game-btn-reset text-14">重置</button>
            </div>
            <div id="canvas" class="canvas-container"></div>
        </div>

        <!-- 计数区域 -->
        <div class="game-section">
            <div class="game-section-header">
                <h2 class="text-14" style="font-weight: 600;">输入每个图形的数量</h2>
                <div id="gameTimer" class="text-14 timer-display timer-normal">05:00</div>
            </div>
            <div id="countingGrid" class="counting-grid"></div>
            <div class="mt-3 flex gap-2 flex-wrap">
                <button id="checkAnswers" class="game-btn-check text-16">
                    <svg width="2rem" height="2rem" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                    </svg>
                    检查答案
                </button>
                <button id="clearInputs" class="game-btn-clear text-16">
                    <svg width="2rem" height="2rem" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                    </svg>
                    清空
                </button>
            </div>
        </div>

        <!-- 积分按钮 -->
        <div class="help-btn points-btn" onclick="showPoints()"></div>
        <!-- 规则按钮 -->
        <div class="help-btn rules-btn" onclick="showRules()"></div>
    </div>

    <!-- 积分弹窗 -->
    <div id="pointsModal" class="rules-modal" style="display: none;">
        <div class="points-modal">
            <div class="points-header">
                <div class="points-title text-18 text-secondary">
                    <div class="points-sign"></div>
                    <span>积分系统</span>
                </div>
                <button id="closePoints" class="points-close text-primary" onclick="hidePoints()">×</button>
            </div>
            <div class="points-modal-content text-14 text-list">
                <div class="points-stats-section">
                    <div class="points-stats-header">
                        <div class="points-subtitle" style="margin: 0;">积分统计</div>
                        <div class="text-10 text-note">
                            最后更新: <span id="lastUpdateDateDisplay">--</span>
                        </div>
                    </div>
                    <div class="points-stats-grid">
                        <div class="points-stat-item">
                            <div class="points-stat-label">总积分</div>
                            <div id="totalPointsDisplay" class="points-stat-value total">0</div>
                        </div>
                        <div class="points-stat-item">
                            <div class="points-stat-label">今日积分</div>
                            <div id="dailyPointsDisplay" class="points-stat-value daily">+0</div>
                        </div>
                    </div>
                </div>
                <div class="points-rules-section">
                    <div class="points-subtitle">积分获得规则</div>
                    <div class="points-rules-list-warpper">
                        <ul class="points-rules-list">
                            <li class="text-12">
                                <span class="points-rule-name">简单难度：每次正确完成获得</span>
                                <span class="points-rule-value">5积分</span>
                            </li>
                            <li class="text-12">
                                <span class="points-rule-name">中等难度：每次正确完成获得</span>
                                <span class="points-rule-value">5积分</span>
                            </li>
                            <li class="text-12">
                                <span class="points-rule-name">困难难度：每次正确完成获得</span>
                                <span class="points-rule-value">10积分</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 规则弹窗 -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <div class="rules-header text-18">
                <div class="rules-title text-secondary">
                    <div class="rules-sign"></div>
                    <span>寻宝大师</span>
                </div>
                <div class="close-btn text-primary" onclick="hideRules()">×</div>
            </div>
            
            <ol class="rules-sections text-14 text-list">
                <li>在限定时间内，数出左侧画布中每种图形和颜色的组合数量，如蓝色三角形、红色三角形</li>
                <li>在右侧面板中输入你数出的每种图形数量</li>
                <li>根据你的模型,当前为你推荐的难度为<span id="recommendedDifficulty" class="font-bold" style="color: #4189FF;">【中等】</span>，你可以随时根据作答情况，调整难度。</li>
            </ol>

            <button onclick="hideRules(); startNewGame();" class="rules-start-btn text-12">
                开始训练
            </button>
        </div>
    </div>

    <!-- 统一交互式弹窗 -->
    <div id="interactiveModalOverlay" class="interactive-modal-overlay">
        <div class="interactive-modal">
            <div class="text-title text-18 modal-title" id="modalTitle">
                标题
            </div>
            <div class="modal-content" id="modalContent">
            </div>
            <div class="buttons text-12" id="modalButtons">
                <div class="button cancel" id="modalCancelBtn">取消</div>
                <div class="button confirm" id="modalConfirmBtn">确认</div>
            </div>
        </div>
    </div>

    <script>
        // SVG形状数据数组
        const shapes_SVG = [
            {
                type: 'rectangle',
                name: '矩形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 70" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="90" height="60" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.43 // width/height
            },
            {
                type: 'square',
                name: '正方形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="90" height="90" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.0
            },
            {
                type: 'circle',
                name: '圆形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.0
            },
            {
                type: 'equilateral-triangle',
                name: '等边三角形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 87" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="50,5 95,82 5,82" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.15
            },
            {
                type: 'right-triangle',
                name: '直角三角形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="5,95 5,5 95,95" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.0
            },
            {
                type: 'triangle-30-60-90',
                name: '30-60-90度三角形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 87" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="5,82 35,5 95,82" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.15
            },
            {
                type: 'hexagon',
                name: '六边形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 87" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="25,5 75,5 95,43.5 75,82 25,82 5,43.5" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.15
            },
            {
                type: 'pentagon',
                name: '五边形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 95" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="50,5 95,35 80,90 20,90 5,35" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.05
            },
            {
                type: 'diamond',
                name: '菱形',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="50,5 95,50 50,95 5,50" fill="none" stroke="currentColor" stroke-width="3"/>
                      </svg>`,
                aspectRatio: 1.0
            },
            {
                type: 'star',
                name: '五角星',
                svg: `<svg width="100%" height="100%" viewBox="0 0 100 95" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="50,5 61,35 95,35 68,57 79,90 50,70 21,90 32,57 5,35 39,35" fill="none" stroke="currentColor" stroke-width="2"/>
                      </svg>`,
                aspectRatio: 1.05
            }
        ];

        // 添加全局变量
        let game_config = '';
        let highestScore = 0;
        let difficulty = 1;
        let ageGroup = 'older'; // 'younger' (5-7岁) 或 'older' (8岁以上)
        let gameInstance = null;
        let gameTimeLimit = 300;
        let timeLeft = 0;
        let gameTimer = null;
        let isFirstTimeClosingRules = true; // 跟踪是否第一次关闭规则窗口
        let isDifficultySelectorDisabled = false; // 跟踪难度选择器是否被禁用
        
        // 积分相关变量
        let totalTrainingPoints = 0;
        let dailyTrainingPoints = 0;
        let lastPointsUpdate = '';

        // 显示积分弹窗
        function showPoints() {
            // 查询最新积分数据
            window.parent.postMessage({ type: 'getTotalTrainingPoints' }, '*');
            document.getElementById('pointsModal').style.display = 'flex';
            document.getElementById('pointsModal').focus();
        }

        // 隐藏积分弹窗
        function hidePoints() {
            document.getElementById('pointsModal').style.display = 'none';
        }

        // 更新积分显示
        function updatePointsDisplay(total, daily, lastUpdate) {
            totalTrainingPoints = total || 0;
            dailyTrainingPoints = daily || 0;
            lastPointsUpdate = lastUpdate || '--';
            
            document.getElementById('totalPointsDisplay').textContent = totalTrainingPoints;
            document.getElementById('dailyPointsDisplay').textContent = dailyTrainingPoints > 0 ? `+${dailyTrainingPoints}` : '0';
            document.getElementById('lastUpdateDateDisplay').textContent = lastPointsUpdate;
        }

        // 显示规则
        function showRules() {
            document.getElementById('rulesModal').style.display = 'flex';
            document.getElementById('rulesModal').focus();
        }

        // 隐藏规则
        function hideRules() {
            document.getElementById('rulesModal').style.display = 'none';
            
            // 如果是第一次关闭规则窗口且难度选择器未被禁用，高亮难度选择器
            if (isFirstTimeClosingRules && !isDifficultySelectorDisabled) {
                highlightDifficultySelector();
                isFirstTimeClosingRules = false; // 标记为已经不是第一次了
            }
        }

        // 从弹窗开始游戏
        function startNewGame() {
            if (gameInstance) {
                gameInstance.initializeGame();
            }
        }

        // 更新难度推荐显示
        function updateDifficultyRecommendation() {
            const difficultyNames = {
                1: '简单',
                2: '中等', 
                3: '困难'
            };
            
            const recommendedElement = document.getElementById('recommendedDifficulty');
            if (recommendedElement) {
                recommendedElement.textContent = `【${difficultyNames[difficulty]}】`;
            }
        }

        // 高亮难度选择器
        function highlightDifficultySelector() {
            const selectorHeader = document.getElementById('difficultySelectorHeader');
            if (selectorHeader) {
                // 添加高亮样式
                selectorHeader.style.boxShadow = '0 0 0 3px rgba(65, 150, 255, 0.3)';
                selectorHeader.style.borderColor = '#4196FF';
                
                // 添加动画效果
                let scale = 1;
                let growing = true;
                const interval = setInterval(() => {
                    if (growing) {
                        scale += 0.01;
                        if (scale >= 1.05) growing = false;
                    } else {
                        scale -= 0.01;
                        if (scale <= 1) growing = true;
                    }
                    selectorHeader.style.transform = `scale(${scale})`;
                }, 100);
                
                // 2秒后移除高亮样式
                setTimeout(() => {
                    clearInterval(interval);
                    selectorHeader.style.boxShadow = '';
                    selectorHeader.style.borderColor = '';
                    selectorHeader.style.transform = '';
                }, 2000);
            }
        }

        // 添加消息监听器
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data
                    
                    // 根据levelName设置初始难度值
                    let initialDifficulty = difficulty;
                    if (e.data.levelName) {
                        switch (e.data.levelName) {
                            case '待提升':
                                initialDifficulty = 1;
                                break;
                            case '良好':
                            case '优异':
                                initialDifficulty = 2;
                                break;
                        }
                    }
                    
                    // 尝试解析 config 字段
                    let configObj = null;
                    let hasDifficultyLevelOverride = false;
                    if (e.data.config) {
                        try {
                            // 如果 config 是字符串，尝试解析
                            if (typeof e.data.config === 'string') {
                                configObj = JSON.parse(e.data.config);
                            } else {
                                configObj = e.data.config;
                            }
                            
                            // 从 config 中读取 difficultyLevel
                            if (configObj.difficultyLevel !== undefined && configObj.difficultyLevel !== null && configObj.difficultyLevel !== '') {
                                initialDifficulty = Math.max(1, Math.min(3, parseInt(configObj.difficultyLevel)));
                                hasDifficultyLevelOverride = true;
                            }
                        } catch (error) {
                            // console.warn('解析 config 失败:', error);
                        }
                    }
                    
                    // 如果没有从 config 解析到难度，尝试从URL获取参数
                    if (!hasDifficultyLevelOverride) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlDifficulty = urlParams.get('difficulty');
                        if (urlDifficulty !== null && urlDifficulty !== '') {
                            initialDifficulty = Math.max(1, Math.min(3, parseInt(urlDifficulty)));
                        }
                    }
                    
                    // 应用最终的难度值
                    difficulty = initialDifficulty;
                    
                    // 同步难度选择器的显示
                    if (gameInstance) {
                        gameInstance.syncDifficultySelector();
                    }
                    
                    // 如果有 difficultyLevel 覆盖，隐藏规则弹窗中的难度推荐那行文本
                    if (hasDifficultyLevelOverride) {
                        const recommendedElement = document.getElementById('recommendedDifficulty');
                        if (recommendedElement && recommendedElement.parentElement) {
                            recommendedElement.parentElement.style.display = 'none';
                        }
                    }
                    
                    // 处理难度选择器禁用
                    let shouldDisableSelector = false;
                    
                    // 优先从 config 读取 difficultySelect
                    if (configObj && configObj.difficultySelect !== undefined) {
                        shouldDisableSelector = configObj.difficultySelect === false;
                    } 
                    // 其次从 e.data 读取 difficultySelect
                    else if (e.data.difficultySelect !== undefined) {
                        shouldDisableSelector = e.data.difficultySelect === false;
                    }
                    // 最后从 URL 参数读取
                    else {
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlDifficultySelect = urlParams.get('difficultySelect');
                        if (urlDifficultySelect !== null && urlDifficultySelect === 'false') {
                            shouldDisableSelector = true;
                        }
                    }
                    
                    if (shouldDisableSelector) {
                        // 禁用难度选择器
                        const selectorHeader = document.getElementById('difficultySelectorHeader');
                        if (selectorHeader) {
                            selectorHeader.style.pointerEvents = 'none';
                            selectorHeader.style.opacity = '0.6';
                            selectorHeader.style.cursor = 'not-allowed';
                        }
                        isDifficultySelectorDisabled = true;
                    }
                    
                    if (gameInstance) {
                        gameInstance.updateGameConfig(game_config);
                    }
                    
                    window.parent.postMessage({ type: 'getTotalTrainingPoints' }, '*');
                    break;
                case 'gameContinue':
                    if (e.data.action === 'restart') {
                        if (gameInstance) {
                            gameInstance.initializeGame();
                        }
                    } else if (e.data.action === 'challenge') {
                        // 如果有下一个难度，从下一个难度开始游戏
                        if (gameInstance) {
                            difficulty = Math.min(difficulty + 1, 3); // 确保难度不超过3
                            gameInstance.initializeGame();
                        }
                    }
                    break;
                case 'getGameStats':
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: highestScore,
                            difficulty: difficulty
                        }
                    }, '*');
                    break;
                case 'totalTrainingPointsResponse':
                    updatePointsDisplay(e.data.total, e.data.dailyTotal, e.data.lastUpdateDate);
                    break;
                case 'trainingPointsResponse':
                    updatePointsDisplay(e.data.totalPoints, e.data.dailyTotal, e.data.lastUpdateDate);
                    break;
            }
        });

        class ShapeCountingGame {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.shapes = shapes_SVG; // 使用SVG数组
                this.colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#f97316', '#06b6d4', '#84cc16', '#ec4899', '#6366f1'];
                this.gameShapes = [];
                this.correctCounts = {};
                this.shapeColorCombinations = new Map();
                this.currentScore = 0;
                this.gameStartTime = null;
                this.gameInProgress = false;
                this.accuracy = 0; // 初始化准确率
                this.earnedPoints = 0; // 初始化获得的积分
                
                // 重叠控制参数
                this.overlapPercentage = 0.5;
                this.overlapIntensity = 0.3;
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('newGame').addEventListener('click', () => this.initializeGame());
                document.getElementById('checkAnswers').addEventListener('click', () => this.checkAnswers());
                document.getElementById('clearInputs').addEventListener('click', () => this.clearInputs());
                
                // 添加年龄组选择器事件监听
                const ageGroupSelect = document.getElementById('ageGroupSelect');
                if (ageGroupSelect) {
                    ageGroupSelect.addEventListener('change', (e) => {
                        ageGroup = e.target.value;
                        console.log(`年龄组已切换到: ${ageGroup}`);
                        this.initializeGame();
                    });
                }
                
                // 设置难度选择器事件监听
                this.setupDifficultySelector();
            }

            /**
             * 显示统一的交互式弹窗
             * @param {Object} options - 弹窗配置选项
             * @param {string} options.title - 弹窗标题
             * @param {string[]} options.contents - 内容行数组
             * @param {string} options.confirmText - 确认按钮文本
             * @param {string} [options.cancelText] - 取消按钮文本（可选，不传则不显示取消按钮）
             * @param {Function} options.onConfirm - 确认按钮回调
             * @param {Function} options.onCancel - 取消按钮回调
             * @returns {Promise} 返回一个Promise，确认时resolve，取消时reject
             */
            showInteractiveModal(options = {}) {
                return new Promise((resolve, reject) => {
                    const {
                        title = '提示',
                        contents = [],
                        confirmText = '确认',
                        cancelText = null,
                        onConfirm = null,
                        onCancel = null
                    } = options;

                    // 获取弹窗元素
                    const overlay = document.getElementById('interactiveModalOverlay');
                    const titleElement = document.getElementById('modalTitle');
                    const contentElement = document.getElementById('modalContent');
                    const buttonsContainer = document.getElementById('modalButtons');
                    const confirmBtn = document.getElementById('modalConfirmBtn');
                    const cancelBtn = document.getElementById('modalCancelBtn');

                    // 设置标题
                    titleElement.textContent = title;

                    // 设置内容
                    contentElement.innerHTML = contents.map(content => 
                        `<div class="text-14">${content}</div>`
                    ).join('');

                    // 设置按钮文本
                    confirmBtn.textContent = confirmText;

                    // 根据是否传入 cancelText 来决定是否显示取消按钮
                    if (cancelText) {
                        cancelBtn.textContent = cancelText;
                        cancelBtn.style.display = 'flex';
                        // 如果有取消按钮，使用 space-between 布局
                        buttonsContainer.style.justifyContent = 'space-between';
                    } else {
                        cancelBtn.style.display = 'none';
                        // 如果只有确认按钮，居中显示
                        buttonsContainer.style.justifyContent = 'center';
                    }

                    // 移除旧的事件监听器
                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    // 确认按钮事件
                    newConfirmBtn.addEventListener('click', () => {
                        overlay.classList.remove('show');
                        if (onConfirm) {
                            onConfirm();
                        }
                        resolve(true);
                    });

                    // 取消按钮事件（只有在显示取消按钮时才添加）
                    if (cancelText) {
                        newCancelBtn.addEventListener('click', () => {
                            overlay.classList.remove('show');
                            if (onCancel) {
                                onCancel();
                            }
                            reject(false);
                        });
                    }

                    // 显示弹窗
                    overlay.classList.add('show');
                });
            }

            setupDifficultySelector() {
                const selectorHeader = document.getElementById('difficultySelectorHeader');
                const selectorDropdown = document.getElementById('difficultySelectorDropdown');
                const options = document.querySelectorAll('.difficulty-selector-option');
                const selectedText = document.getElementById('difficultySelectedText');
                
                // 点击头部切换下拉菜单
                selectorHeader.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectorHeader.classList.toggle('active');
                    selectorDropdown.classList.toggle('show');
                });
                
                // 点击选项
                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = parseInt(option.getAttribute('data-value'));
                        const text = option.querySelector('span:nth-child(2)').textContent;
                        
                        // 更新选中状态
                        options.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // 更新显示文本
                        selectedText.textContent = text;
                        
                        // 关闭下拉菜单
                        selectorHeader.classList.remove('active');
                        selectorDropdown.classList.remove('show');
                        
                        // 更新难度并重新开始游戏
                        if (difficulty !== value) {
                            difficulty = value;
                            console.log(`难度已切换到: ${difficulty}`);
                            this.initializeGame();
                        }
                    });
                });
                
                // 点击页面其他地方关闭下拉菜单
                document.addEventListener('click', () => {
                    selectorHeader.classList.remove('active');
                    selectorDropdown.classList.remove('show');
                });
            }

            initializeGame() {
                // 同步年龄组选择器的值
                const ageGroupSelect = document.getElementById('ageGroupSelect');
                if (ageGroupSelect) {
                    ageGroupSelect.value = ageGroup;
                }
                
                // 同步难度选择器的值和显示
                this.syncDifficultySelector();
                
                this.canvas.innerHTML = '';
                this.gameShapes = [];
                this.correctCounts = {};
                this.shapeColorCombinations.clear();
                this.gameInProgress = true;
                this.gameStartTime = Date.now();

                // 根据年龄组和难度调整游戏参数
                let shapeTypeCount, colorCount, minCount, maxCount, finalMaxCount, shapeSize;
                
                if (ageGroup === 'younger') {
                    // 5-7岁幼儿模式
                    switch (difficulty) {
                        case 3: // 困难
                            shapeTypeCount = 4;
                            colorCount = 3; 
                            minCount = 2;
                            maxCount = 4;
                            finalMaxCount = 9;
                            gameTimeLimit = 420; // 7分钟
                            this.overlapPercentage = 0.2; // 很少重叠
                            this.overlapIntensity = 0.1;
                            shapeSize = 'large'; // 大图形
                            break;
                        case 2: // 中等
                            shapeTypeCount = 3;
                            colorCount = 3;
                            minCount = 1;
                            maxCount = 3;
                            finalMaxCount = 8;
                            gameTimeLimit = 450; // 7.5分钟
                            this.overlapPercentage = 0.1;
                            this.overlapIntensity = 0.05;
                            shapeSize = 'large';
                            break;
                        default: // 简单
                            shapeTypeCount = 3;
                            colorCount = 2;
                            minCount = 1;
                            maxCount = 3;
                            finalMaxCount = 6;
                            gameTimeLimit = 480; // 8分钟
                            this.overlapPercentage = 0.05; // 几乎无重叠
                            this.overlapIntensity = 0.02;
                            shapeSize = 'extra-large'; // 超大图形
                            break;
                    }
                } else {
                    // 8岁以上少年模式
                    switch (difficulty) {
                        case 3: // 困难
                            shapeTypeCount = 6;
                            colorCount = 4; 
                            minCount = 2;
                            maxCount = 5;
                            finalMaxCount = 9;
                            gameTimeLimit = 240; // 4分钟
                            this.overlapPercentage = 0.32; // 略微降低重叠
                            this.overlapIntensity = 0.22;
                            shapeSize = 'medium'; // 中等图形
                            break;
                        case 2: // 中等
                            shapeTypeCount = 5;
                            colorCount = 3;
                            minCount = 2;
                            maxCount = 4;
                            finalMaxCount = 8;
                            gameTimeLimit = 300; // 5分钟
                            this.overlapPercentage = 0.22;
                            this.overlapIntensity = 0.15;
                            shapeSize = 'large';
                            break;
                        default: // 简单
                            shapeTypeCount = 4;
                            colorCount = 3;
                            minCount = 2;
                            maxCount = 3;
                            finalMaxCount = 6;
                            gameTimeLimit = 360; // 6分钟
                            this.overlapPercentage = 0.18;
                            this.overlapIntensity = 0.12;
                            shapeSize = 'large';
                            break;
                    }
                }

                this.startTimer();

                // 为幼儿选择基础形状，为少年选择更复杂的形状
                let selectedShapes;
                if (ageGroup === 'younger') {
                    // 基础形状：圆形、正方形、三角形、矩形
                    const basicShapes = this.shapes.filter(s => 
                        ['circle', 'square', 'equilateral-triangle', 'rectangle'].includes(s.type)
                    );
                    selectedShapes = basicShapes.slice(0, shapeTypeCount);
                } else {
                    // 包含所有形状，优先复杂形状
                    selectedShapes = this.shapes.slice(0, shapeTypeCount);
                }
                
                // 为幼儿选择对比度更高的颜色
                let selectedColors;
                if (ageGroup === 'younger') {
                    const brightColors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']; // 明亮对比色
                    selectedColors = brightColors.slice(0, colorCount);
                } else {
                    selectedColors = this.colors.slice(0, colorCount);
                }
                
                // 为每种形状-颜色组合预定义固定尺寸
                this.generateShapeColorCombinations(selectedShapes, selectedColors, shapeSize);
                
                // 生成每种组合的数量
                this.generateCombinationCounts(minCount, maxCount, finalMaxCount);
                
                // 创建所有图形
                this.createAllShapes();
                this.applyOverlapAlgorithm();
                this.createCountingGrid();

                window.parent.postMessage({ type: 'gameStarted' }, '*');
            }

            syncDifficultySelector() {
                const options = document.querySelectorAll('.difficulty-selector-option');
                const selectedText = document.getElementById('difficultySelectedText');
                const difficultyNames = {
                    1: '简单',
                    2: '中等',
                    3: '困难'
                };
                
                // 更新选中状态
                options.forEach(option => {
                    const value = parseInt(option.getAttribute('data-value'));
                    if (value === difficulty) {
                        option.classList.add('selected');
                        selectedText.textContent = difficultyNames[difficulty];
                    } else {
                        option.classList.remove('selected');
                    }
                });
            }

            generateShapeColorCombinations(shapes, colors, sizeType = 'medium') {
                // 根据sizeType和年龄组调整尺寸范围（单位：rem）
                let minSize, maxSize;
                switch (sizeType) {
                    case 'extra-large':
                        minSize = 8;   // 8rem
                        maxSize = 16;  // 16rem
                        break;
                    case 'large':
                        minSize = 5;   // 5rem
                        maxSize = 12;  // 12rem
                        break;
                    case 'medium':
                        minSize = 3.5; // 3.5rem
                        maxSize = 8;   // 8rem
                        break;
                    case 'small':
                        minSize = 2;   // 2rem
                        maxSize = 5;   // 5rem
                        break;
                    default:
                        minSize = 3.5; // 3.5rem
                        maxSize = 10;  // 10rem
                }
                
                shapes.forEach(shape => {
                    colors.forEach(color => {
                        const key = `${shape.type}-${color}`;
                        // 为每种形状-颜色组合生成固定尺寸（rem单位）
                        const size = Math.random() * (maxSize - minSize) + minSize;
                        this.shapeColorCombinations.set(key, {
                            shape: shape,
                            color: color,
                            size: size
                        });
                    });
                });
            }

            generateCombinationCounts(minCount, maxCount, finalMaxCount) {
                // 随机选择一部分组合来生成
                const allCombinations = Array.from(this.shapeColorCombinations.keys());
                const numCombinations = Math.floor(allCombinations.length * (0.4 + Math.random() * 0.4)); // 40%-80%的组合
                
                const selectedCombinations = [];
                while (selectedCombinations.length < Math.min(numCombinations, finalMaxCount)) {
                    const randomKey = allCombinations[Math.floor(Math.random() * allCombinations.length)];
                    if (!selectedCombinations.includes(randomKey)) {
                        selectedCombinations.push(randomKey);
                    }
                }
                
                selectedCombinations.forEach(key => {
                    const count = Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount;
                    this.correctCounts[key] = count;
                });
            }

            createAllShapes() {
                Object.keys(this.correctCounts).forEach(key => {
                    const count = this.correctCounts[key];
                    const combination = this.shapeColorCombinations.get(key);
                    
                    for (let i = 0; i < count; i++) {
                        this.createShapeElement(combination.shape.type, combination.color, combination.size);
                    }
                });

                this.arrangeShapesRandomly();
            }

            createShapeElement(shapeType, color, size) {
                const shapeData = this.shapes.find(s => s.type === shapeType);
                if (!shapeData) {
                    console.error(`Shape type ${shapeType} not found`);
                    return;
                }

                const shapeElement = document.createElement('div');
                shapeElement.className = 'shape svg-shape';
                
                // 计算实际尺寸（考虑宽高比，使用rem单位）
                const width = size; // size 已经是 rem 单位
                const height = size / shapeData.aspectRatio;
                
                shapeElement.style.width = width + 'rem';
                shapeElement.style.height = height + 'rem';
                shapeElement.style.color = color;
                shapeElement.style.position = 'absolute';
                shapeElement.style.cursor = 'pointer';
                shapeElement.style.userSelect = 'none';
                shapeElement.style.transition = 'all 0.3s ease';
                shapeElement.style.opacity = '0.9';
                
                // 插入SVG
                shapeElement.innerHTML = shapeData.svg;

                const rotation = Math.random() * 360;
                shapeElement.style.transform = `rotate(${rotation}deg)`;
                shapeElement.style.zIndex = Math.floor(Math.random() * 100);
                
                // 添加交互事件
                shapeElement.addEventListener('mouseenter', () => {
                    shapeElement.style.zIndex = '1000';
                    shapeElement.style.opacity = '1';
                    shapeElement.style.transform = `rotate(${rotation}deg) scale(1.1)`;
                });
                
                shapeElement.addEventListener('mouseleave', () => {
                    shapeElement.style.zIndex = Math.floor(Math.random() * 100);
                    shapeElement.style.opacity = '0.9';
                    shapeElement.style.transform = `rotate(${rotation}deg)`;
                });

                shapeElement.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    shapeElement.style.zIndex = '1000';
                    shapeElement.style.opacity = '1';
                    shapeElement.style.transform = `rotate(${rotation}deg) scale(1.1)`;
                });

                shapeElement.addEventListener('touchend', () => {
                    shapeElement.style.zIndex = Math.floor(Math.random() * 100);
                    shapeElement.style.opacity = '0.9';
                    shapeElement.style.transform = `rotate(${rotation}deg)`;
                });
                
                this.canvas.appendChild(shapeElement);
                this.gameShapes.push({ 
                    type: shapeType, 
                    element: shapeElement, 
                    color: color,
                    size: size,
                    width: width,     // rem 单位
                    height: height,   // rem 单位
                    rotation: rotation,
                    x: 0, 
                    y: 0,
                    shouldOverlap: false
                });
            }

            arrangeShapesRandomly() {
                const canvasRect = this.canvas.getBoundingClientRect();
                const canvasWidth = canvasRect.width;
                const canvasHeight = canvasRect.height;
                
                this.gameShapes.forEach(item => {
                    // 将 rem 转换为像素用于定位计算
                    const widthPx = item.width * rootFontSize;
                    const heightPx = item.height * rootFontSize;
                    
                    // 减小边距，让图形可以分布到更靠近边缘的位置
                    const margin = 5;
                    const minX = margin;
                    const maxX = Math.max(margin, canvasWidth - widthPx - margin);
                    const minY = margin;
                    const maxY = Math.max(margin, canvasHeight - heightPx - margin);
                    
                    // 完全随机分布在整个画布范围内
                    item.x = minX + Math.random() * Math.max(0, maxX - minX);
                    item.y = minY + Math.random() * Math.max(0, maxY - minY);
                    
                    item.element.style.left = item.x + 'px';
                    item.element.style.top = item.y + 'px';
                });
            }

            applyOverlapAlgorithm() {
                const canvasRect = this.canvas.getBoundingClientRect();
                const canvasWidth = canvasRect.width;
                const canvasHeight = canvasRect.height;
                
                const shapesToOverlap = this.selectShapesForOverlap();
                
                shapesToOverlap.forEach(targetShape => {
                    this.createOverlapForShape(targetShape, canvasWidth, canvasHeight);
                });
                
                this.updateZIndexes();
            }

            selectShapesForOverlap() {
                const shuffled = [...this.gameShapes].sort(() => Math.random() - 0.5);
                const overlapCount = Math.floor(this.gameShapes.length * this.overlapPercentage);
                const selected = shuffled.slice(0, overlapCount);
                
                selected.forEach(shape => {
                    shape.shouldOverlap = true;
                });
                
                return selected;
            }

            createOverlapForShape(targetShape, canvasWidth, canvasHeight) {
                // 使用基于 rem 的距离阈值（转换为像素）
                const distanceThreshold = 15 * rootFontSize; // 15rem
                const candidateShapes = this.gameShapes.filter(shape => 
                    shape !== targetShape && this.calculateDistance(targetShape, shape) < distanceThreshold
                );
                
                if (candidateShapes.length === 0) {
                    const randomShape = this.gameShapes[Math.floor(Math.random() * this.gameShapes.length)];
                    if (randomShape !== targetShape) {
                        candidateShapes.push(randomShape);
                    }
                }
                
                if (candidateShapes.length > 0) {
                    const partnerShape = candidateShapes[Math.floor(Math.random() * candidateShapes.length)];
                    this.moveShapeToOverlap(targetShape, partnerShape, canvasWidth, canvasHeight);
                }
            }

            moveShapeToOverlap(shapeA, shapeB, canvasWidth, canvasHeight) {
                // 将 rem 转换为像素用于计算重叠距离
                const widthAPx = shapeA.width * rootFontSize;
                const heightAPx = shapeA.height * rootFontSize;
                const widthBPx = shapeB.width * rootFontSize;
                const heightBPx = shapeB.height * rootFontSize;
                
                const overlapDistance = (Math.max(widthAPx, heightAPx) + Math.max(widthBPx, heightBPx)) * this.overlapIntensity * 0.5;
                
                const dx = shapeA.x - shapeB.x;
                const dy = shapeA.y - shapeB.y;
                const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                
                const normalizedDx = dx / distance;
                const normalizedDy = dy / distance;
                
                const newX = shapeB.x + normalizedDx * overlapDistance;
                const newY = shapeB.y + normalizedDy * overlapDistance;
                
                const margin = 20;
                shapeA.x = Math.max(margin, Math.min(newX, canvasWidth - widthAPx - margin));
                shapeA.y = Math.max(margin, Math.min(newY, canvasHeight - heightAPx - margin));
                
                shapeA.element.style.left = shapeA.x + 'px';
                shapeA.element.style.top = shapeA.y + 'px';
            }

            calculateDistance(shapeA, shapeB) {
                const dx = shapeA.x - shapeB.x;
                const dy = shapeA.y - shapeB.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            updateZIndexes() {
                this.gameShapes.forEach(shape => {
                    if (shape.shouldOverlap) {
                        shape.element.style.zIndex = Math.floor(Math.random() * 50) + 50;
                    } else {
                        shape.element.style.zIndex = Math.floor(Math.random() * 50);
                    }
                });
            }

            createCountingGrid() {
                const countingGrid = document.getElementById('countingGrid');
                countingGrid.innerHTML = '';
                
                const usedCombinations = Object.keys(this.correctCounts);
                
                usedCombinations.forEach(key => {
                    const combination = this.shapeColorCombinations.get(key);
                    const shapeData = this.shapes.find(s => s.type === combination.shape.type);
                    
                    const card = document.createElement('div');
                    card.className = 'count-controls';
                    
                    card.innerHTML = `
                        <div class="count-card-icon" style="color: ${combination.color}">
                            ${shapeData.svg}
                        </div>
                        <div class="count-input-row">
                            <button class="count-btn" onclick="adjustCount('${key}', -1)">-</button>
                            <div class="count-display" data-shape="${key}">0</div>
                            <button class="count-btn plus" onclick="adjustCount('${key}', 1)">+</button>
                        </div>
                    `;
                    
                    countingGrid.appendChild(card);
                });
            }

            startTimer() {
                if (gameTimer) {
                    clearInterval(gameTimer);
                }

                timeLeft = gameTimeLimit;
                this.updateTimerDisplay();

                gameTimer = setInterval(() => {
                    timeLeft--;
                    this.updateTimerDisplay();

                    if (timeLeft <= 0) {
                        this.timeUp();
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                const timerElement = document.getElementById('gameTimer');
                if (!timerElement) return;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timerElement.textContent = timeString;
                
                if (timeLeft <= 30) {
                    timerElement.className = 'text-14 timer-display timer-urgent';
                } else if (timeLeft <= 60) {
                    timerElement.className = 'text-14 timer-display timer-warning';
                } else {
                    timerElement.className = 'text-14 timer-display timer-normal';
                }
            }

            timeUp() {
                if (!this.gameInProgress) return;
                this.checkAnswers(true);
            }

            updateGameConfig(config) {
                try {
                    let configObj;
                    if (typeof config === 'string') {
                        configObj = JSON.parse(config);
                    } else {
                        configObj = config;
                    }
                    
                    // 更新年龄组设置
                    if (configObj.ageGroup) {
                        ageGroup = configObj.ageGroup === 'younger' ? 'younger' : 'older';
                    }
                    
                    // 手动覆盖重叠参数（可选）
                    if (configObj.overlapPercentage !== undefined) {
                        this.overlapPercentage = Math.max(0, Math.min(1, parseFloat(configObj.overlapPercentage)));
                    }
                    
                    if (configObj.overlapIntensity !== undefined) {
                        this.overlapIntensity = Math.max(0, Math.min(1, parseFloat(configObj.overlapIntensity)));
                    }
                    
                    // 自定义时间限制（可选）
                    if (configObj.timeLimit) {
                        gameTimeLimit = Math.max(60, parseInt(configObj.timeLimit));
                    }
                    
                    // 自定义形状和颜色数量（可选，会覆盖年龄组默认设置）
                    if (configObj.shapeTypeCount) {
                        this.customShapeTypeCount = Math.max(1, Math.min(10, parseInt(configObj.shapeTypeCount)));
                    }
                    
                    if (configObj.colorCount) {
                        this.customColorCount = Math.max(1, Math.min(10, parseInt(configObj.colorCount)));
                    }
                    
                    // 自定义数量范围（可选）
                    if (configObj.minCount !== undefined && configObj.maxCount !== undefined) {
                        this.customMinCount = Math.max(0, parseInt(configObj.minCount));
                        this.customMaxCount = Math.max(this.customMinCount, parseInt(configObj.maxCount));
                    }
                    
                    // 同步UI选择器
                    const ageGroupSelect = document.getElementById('ageGroupSelect');
                    if (ageGroupSelect) {
                        ageGroupSelect.value = ageGroup;
                    }
                    
                    // 同步难度选择器
                    this.syncDifficultySelector();
                    
                } catch (error) {
                    console.warn('解析游戏配置失败，使用默认配置:', error);
                    ageGroup = 'older';
                    difficulty = 1;
                    this.overlapPercentage = 0.3;
                    this.overlapIntensity = 0.2;
                }
                
                // 更新难度推荐显示
                updateDifficultyRecommendation();
            }

            checkAnswers(isAutoSubmit = false) {
                if (!this.gameInProgress) return;
                
                this.gameInProgress = false;
                clearInterval(gameTimer);

                const timeTaken = Math.floor((Date.now() - this.gameStartTime) / 1000);
                const displays = document.querySelectorAll('.count-display');
                let correct = 0;
                let total = 0;
                let results = [];

                displays.forEach(display => {
                    const shapeKey = display.dataset.shape;
                    const userAnswer = parseInt(display.textContent) || 0;
                    const correctAnswer = this.correctCounts[shapeKey];
                    const combination = this.shapeColorCombinations.get(shapeKey);
                    const shapeName = combination.shape.name;
                    
                    total++;
                    if (userAnswer === correctAnswer) {
                        correct++;
                    } else {
                        // 传递包含详细信息的对象
                        results.push({
                            shapeName: shapeName,
                            shapeKey: shapeKey,
                            correctAnswer: correctAnswer,
                            userAnswer: userAnswer
                        });
                    }
                });

                this.currentScore = Math.round((correct / total) * 100);
                this.accuracy = this.currentScore;
                
                if (this.currentScore > highestScore) {
                    highestScore = this.currentScore;
                }

                // 计算获得的积分
                let earnedPoints = 0;
                if (this.currentScore === 100) { // 只有全部答对才获得积分
                    switch (difficulty) {
                        case 1: // 简单
                        case 2: // 中等
                            earnedPoints = 5;
                            break;
                        case 3: // 困难
                            earnedPoints = 10;
                            break;
                    }
                    
                    // 发送积分获得消息
                    if (earnedPoints > 0) {
                        window.parent.postMessage({
                            type: 'showTrainingPoints',
                            points: earnedPoints,
                            accuracy: this.accuracy,
                        }, '*');
                    }
                }

                // 保存本次获得的积分，用于finishGame时传递
                this.earnedPoints = earnedPoints;

                // 使用新的交互式弹窗显示结果
                this.showResultModal(correct, total, results, isAutoSubmit, timeTaken);
            }

            showResultModal(correct, total, errors, isAutoSubmit = false, timeTaken = 0) {
                const percentage = Math.round((correct / total) * 100);
                const minutes = Math.floor(timeTaken / 60);
                const seconds = timeTaken % 60;
                
                // 构建内容数组
                const contents = [];
                
                // 添加用时信息
                contents.push(`⏱️ 用时：${minutes}分${seconds}秒`);
                
                // 如果是自动提交，添加提示
                if (isAutoSubmit) {
                    contents.push(`<span style="color: #EF4444; font-weight: 600;">⏰ 时间到！自动提交答案</span>`);
                }
                
                // 添加错误信息
                if (errors.length > 0) {
                    contents.push('<div style="margin-top: 0.8rem; margin-bottom: 0.4rem; color: #EF4444; font-weight: 600;">❌ 需要改正的答案：</div>');
                    errors.forEach(errorInfo => {
                        // errorInfo 现在是一个对象，包含 shapeName, shapeKey, correctAnswer, userAnswer
                        const combination = this.shapeColorCombinations.get(errorInfo.shapeKey);
                        const shapeData = this.shapes.find(s => s.type === combination.shape.type);
                        
                        // 判断答案是否正确（虽然这里都是错误的，但为了完整性保留逻辑）
                        const isCorrect = errorInfo.userAnswer === errorInfo.correctAnswer;
                        const answerColor = isCorrect ? '#10B981' : '#EF4444'; // 绿色或红色
                        
                        // 在原结构基础上添加小图标
                        contents.push(`<div style="display: flex; align-items: center; margin-bottom: 0.4rem;">
                            <div style="width: 2rem; height: 2rem; flex-shrink: 0; color: ${combination.color}; margin-right: 0.5rem;">
                                ${shapeData.svg}
                            </div>
                            <div style="flex: 1; display: flex; justify-content: space-between;">
                                <span>• ${errorInfo.shapeName}:</span>
                                <span style="margin-left: 2rem; text-align: right;">正确答案是 <span>${errorInfo.correctAnswer}</span>，您的答案是 <span style="color: ${answerColor};">${errorInfo.userAnswer}</span></span>
                            </div>
                        </div>`);
                    });
                } else {
                    contents.push('<div style="margin-top: 0.8rem; color: #10B981; font-weight: 600;">🎉 完美！全部答对了！</div>');
                }
                
                // 显示弹窗
                this.showInteractiveModal({
                    title: '🎯 训练结果',
                    contents: contents,
                    confirmText: '提交答案',
                    // cancelText: '继续修改',
                    onConfirm: () => {
                        this.finishGame();
                    },
                    onCancel: () => {
                        // 继续游戏，重新启动计时器
                        this.gameInProgress = true;
                        this.startTimer();
                    }
                });
            }

            clearInputs() {
                const displays = document.querySelectorAll('.count-display');
                
                displays.forEach(display => {
                    display.textContent = '0';
                    display.style.backgroundColor = '';
                    display.style.borderRadius = '';
                    display.style.padding = '';
                });
            }

            finishGame() {
                // 关闭交互式弹窗
                const overlay = document.getElementById('interactiveModalOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
                
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: {
                        score: this.currentScore,
                        highestScore: highestScore,
                        difficulty: difficulty,
                        ageGroup: ageGroup,
                        timeTaken: Math.floor((Date.now() - this.gameStartTime) / 1000),
                        earnedPoints: this.earnedPoints || 0,  // 传递本次获得的积分
                        showAccuracy: true,
                        accuracy: this.accuracy,
                        isMaxDifficulty: difficulty === 3,
                        levelCount: 1,  // 记录本次游戏完成的关卡数量
                    }
                }, '*');
            }
        }

        // 全局函数
        function adjustCount(shapeKey, delta) {
            const display = document.querySelector(`[data-shape="${shapeKey}"]`);
            if (display) {
                const currentCount = parseInt(display.textContent) || 0;
                const newCount = Math.max(0, currentCount + delta);
                display.textContent = newCount;
                
                // 清除之前的背景色
                display.style.backgroundColor = '';
                display.style.borderRadius = '';
                display.style.padding = '';
            }
        }
        
        // 创建游戏实例
        gameInstance = new ShapeCountingGame();
        window.parent.postMessage({ type: 'gameLoaded' }, '*');

        setTimeout(() => {
            showRules(); // 延迟显示规则，这里有个机型不延时显示有问题
        }, 500);
    </script>
</body>
</html>