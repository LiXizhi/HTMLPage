<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>éº¦æ€æ˜Ÿçƒ</title>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.11"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .login-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 50px 60px;
        width: 800px;
        height: 650px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      /* åˆ‡æ¢ç™»å½•æ–¹å¼æŒ‰é’® */
      .login-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }

      .switch-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        border-radius: 8px;
        background: transparent;
        color: #667eea;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .switch-btn.active {
        background: #667eea;
        color: white;
      }

      .switch-btn:hover {
        background: #667eea;
        color: white;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        gap: 30px;
      }

      .icon {
        width: 160px;
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 20px;
      }

      .game-title {
        font-size: 48px;
        font-weight: bold;
        color: #333;
        text-align: left;
        line-height: 1.2;
        display: none; /* Hidden by default, shown when loginGameTitle exists */
      }

      .form-group {
        width: 100%;
        margin-bottom: 30px;
      }

      .input-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-field {
        width: 100%;
        padding: 20px 25px;
        border: 3px solid #e1e8ed;
        border-radius: 16px;
        font-size: 25px;
        background: white;
        transition: all 0.3s ease;
        outline: none;
      }

      .input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-field::placeholder {
        color: #94a3b8;
      }

      .verify-input {
        flex: 1;
        margin-right: 20px;
      }

      .verify-btn {
        padding: 20px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }

      .verify-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .verify-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .login-btn {
        width: 100%;
        padding: 24px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
      }
      .login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* æŒ‰é’®å®¹å™¨æ ·å¼ */
      .button-container {
        display: flex;
        gap: 12px;
        margin-top: 15px;
      }

      .button-container .login-btn {
        flex: 1;
        margin-top: 0;
      }

      /* æ¸¸å®¢ç™»å½•æŒ‰é’®æ ·å¼ */
      .guest-login-btn {
        flex: 1;
        padding: 24px;
        background: linear-gradient(45deg, #6b7280, #9ca3af);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 0;
      }

      .guest-login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(107, 114, 128, 0.3);
      }

      .guest-login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .tips {
        margin-top: 25px;
        font-size: 20px;
        color: #64748b;
        text-align: center;
        line-height: 1.5;
      }

      /* é”™è¯¯æç¤ºæ ·å¼ */
      .error-message {
        color: #ef4444;
        font-size: 20px;
        margin-top: 12px;
        display: none;
      }

      .input-field.error {
        border-color: #ef4444;
      }

      /* æ¶ˆæ¯æç¤º */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 24px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }

      /* åŒæ„æ¡æ¬¾æ ·å¼ */
      .agreement-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        font-size: 24px;
        color: #64748b;
        line-height: 1.5;
      }

      .agreement-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .agreement-text {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        cursor: pointer; /* æ•´è¡Œå¯ç‚¹å‡»åˆ‡æ¢å¤é€‰æ¡† */
      }

      .agreement-link {
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.3s ease;
      }      .agreement-link:hover {
        color: #5b6ee8;
      }

      /* æ³¨å†Œé“¾æ¥æ ·å¼ */
      .register-link {
        text-align: center;
        margin-top: 20px;
        color: #666;
        font-size: 18px;
      }

      .register-link a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .register-link a:hover {
        color: #5b6ee8;
        text-decoration: underline;
      }

      /* å¼¹çª—æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      /* IDéªŒè¯å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */
      #idVerifyModal {
        background-color: transparent;
        backdrop-filter: none;
      }

      #idVerifyModal .modal-content {
        margin: 0;
        padding: 0;
        border-radius: 0;
        width: 100vw;
        height: 100vh;
        max-width: none;
        max-height: none;
        overflow: hidden;
        box-shadow: none;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
      }

      .close {
        color: #94a3b8;
        float: right;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #667eea;
      }

      .modal-body {
        font-size: 16px;
        line-height: 1.6;
        color: #333;
      }

      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        margin-top: 25px;
        margin-bottom: 15px;
        color: #667eea;
      }

      .modal-body h1 {
        font-size: 24px;
      }

      .modal-body h2 {
        font-size: 20px;
      }

      .modal-body h3 {
        font-size: 18px;
      }

      .modal-body p {
        margin-bottom: 12px;
      }

      .modal-body ul,
      .modal-body ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      .modal-body li {
        margin-bottom: 8px;
      }

      .modal-body strong {
        color: #333;
        font-weight: 600;
      }

      .modal-body code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
      }

      .modal-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 2px solid #e1e8ed;
        display: flex;
        justify-content: center;
        gap: 12px;
      }

      .modal-btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 28px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.25);
        transition: all 0.3s ease;
      }

      .modal-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(102, 126, 234, 0.35);
      }

      .modal-btn-secondary {
        background: #f8f9fa;
        color: #64748b;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        padding: 10px 28px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .modal-btn-secondary:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: #475569;
        transform: translateY(-2px);
      }

      /* åŠ è½½çŠ¶æ€ */
      .modal-loading {
        text-align: center;
        padding: 40px;
        color: #94a3b8;
        font-size: 18px;
      }

      /* å®åè®¤è¯å¼¹çª—æ ·å¼ */
      .realname-modal .modal-content {
        max-width: 600px;
      }

      .realname-form {
        padding: 20px 0;
      }

      .realname-form .form-group {
        margin-bottom: 25px;
      }

      .realname-form .input-field {
        font-size: 20px;
        padding: 16px 20px;
      }

      .realname-form .verify-btn {
        font-size: 20px;
        padding: 16px 24px;
        min-width: 120px;
      }

      .realname-form .error-message {
        font-size: 16px;
        margin-top: 8px;
      }

      /* å®åé€šçŸ¥å¼¹çª—æ ·å¼ */
      .realname-notice-modal .modal-content {
        max-width: 500px;
        text-align: center;
      }

      .realname-notice-icon {
        font-size: 64px;
        color: #10b981;
        margin-bottom: 20px;
      }

      .realname-notice-text {
        font-size: 20px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 30px;
      }      /* ç”¨æˆ·è®¾ç½®å¼¹çª—æ ·å¼ */
      .user-setting-modal {
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .user-setting-modal.show {
        transform: translateY(0);
      }

      /* æ³¨å†Œå¼¹çª—æ ·å¼ */
      #registerModal .modal-content {
        margin: 0;
        padding: 0;
        border-radius: 0;
        width: 100%;
        max-width: none;
        height: 100vh;
        max-height: none;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      #registerModal .close {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        line-height: 1;
      }

      #registerModal .close:hover {
        background: rgba(0, 0, 0, 0.7);
      }

      #registerModal #register_iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
        overflow: hidden;
      }

      /* Developer panel styles */
      .dev-panel {
        position: fixed;
        top: 0;
        right: -200px;
        width: 200px;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 20px;
        transition: right 0.3s ease;
        z-index: 10000;
        font-size: 14px;
        overflow-y: auto;
      }

      .dev-panel.show {
        right: 0;
      }

      .dev-panel h3 {
        margin: 0 0 20px 0;
        font-size: 16px;
        color: #00ff00;
        text-align: center;
      }

      .dev-option {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dev-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .dev-option label {
        cursor: pointer;
        font-size: 12px;
        line-height: 1.2;
      }      .dev-option input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #666;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 12px;
        margin-top: 4px;
      }

      .dev-option input[type="text"]:focus {
        outline: none;
        border-color: #00ff00;
        background: rgba(255, 255, 255, 0.2);
      }

      .project-id-container {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      .project-id-container input[type="text"] {
        flex: 1;
        margin-top: 0;
      }

      .project-id-dropdown {
        width: 60px;
        padding: 4px 2px;
        border: 1px solid #666;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 10px;
        cursor: pointer;
        text-align: center;
      }

      .project-id-dropdown:focus {
        outline: none;
        border-color: #00ff00;
        background: rgba(255, 255, 255, 0.2);
      }

      .project-id-dropdown option {
        background: #333;
        color: white;
        font-size: 10px;
      }

      .dev-option-group {
        margin-bottom: 20px;
        border-bottom: 1px solid #666;
        padding-bottom: 15px;
      }

      .dev-option-title {
        font-size: 13px;
        color: #00ff00;
        margin-bottom: 8px;
      }

      .dev-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* è‡ªåŠ¨ç™»å½•çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
      .auto-login-status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        text-align: center;
        z-index: 1000;
        display: none;
      }

      .auto-login-status h3 {
        font-size: 24px;
        color: #333;
        margin-bottom: 15px;
      }

      .auto-login-status p {
        font-size: 18px;
        color: #666;
        margin-bottom: 25px;
        line-height: 1.5;
      }

      .auto-login-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .auto-login-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .auto-login-btn.primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .auto-login-btn.secondary {
        background: #f0f0f0;
        color: #666;
      }

      .auto-login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body>
    <div class="login-container">
      <!-- åˆ‡æ¢ç™»å½•æ–¹å¼æŒ‰é’® -->
      <div class="login-switch">
        <button type="button" class="switch-btn" id="phoneLoginBtn" onclick="switchToPhoneLogin()">ğŸ“±æ‰‹æœºå·ç™»å½•</button>
        <button type="button" class="switch-btn active" id="usernameLoginBtn" onclick="switchToUsernameLogin()">ğŸ”‘è´¦å·å¯†ç ç™»å½•</button>
      </div>
      <div class="header">
        <div id="maisiIcon" class="icon">
          <img src="https://cdn.keepwork.com/update61/assetdownload/update/texture/aries/creator/keepwork/minigame/logo.png.p,ba44b8275f4bdb7e6dacebc939b2ac13,33659" alt="éº¦æ€æ˜Ÿçƒ" />
        </div>
        <div class="game-title" id="gameTitle"></div>
      </div>
      <!-- æ‰‹æœºå·ç™»å½•è¡¨å• -->
      <form class="login-form" id="phoneLoginForm" style="display: none">
        <div class="form-group">
          <div class="input-container">
            <input type="tel" class="input-field" id="phoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " maxlength="11" />
          </div>
          <div class="error-message" id="phoneError">è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç </div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field verify-input" id="codeInput" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="4" />
            <button type="button" class="verify-btn" id="verifyBtn">è·å–éªŒè¯ç </button>
          </div>
          <div class="error-message" id="codeError">è¯·è¾“å…¥æ­£ç¡®çš„éªŒè¯ç </div>
        </div>
        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox" />
          <div class="agreement-text">
            <span>ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„</span>
            <span class="agreement-link" onclick="openPrivacyModal()">éšç§æ”¿ç­–</span>
            <span>å’Œ</span>
            <span class="agreement-link" onclick="openLicenseModal()">ç”¨æˆ·åè®®</span>
          </div>
        </div>

        <div class="button-container" id="phoneButtonContainer">
          <button type="submit" class="login-btn" id="phoneLoginBtn">ç™»å½•/æ³¨å†Œ</button>
        </div>
      </form>

      <!-- ç”¨æˆ·åå¯†ç ç™»å½•è¡¨å• -->
      <form class="login-form" id="usernameLoginForm">
        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±" />
          </div>
          <div class="error-message" id="usernameError">è¯·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·å</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="password" class="input-field" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " />
          </div>
          <div class="error-message" id="passwordError">è¯·è¾“å…¥å¯†ç </div>
        </div>
        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox2" />
          <div class="agreement-text">
            <span>ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„</span>
            <span class="agreement-link" onclick="openPrivacyModal()">éšç§æ”¿ç­–</span>
            <span>å’Œ</span>
            <span class="agreement-link" onclick="openLicenseModal()">ç”¨æˆ·åè®®</span>
          </div>
        </div>        <div class="button-container" id="usernameButtonContainer">
          <button type="submit" class="login-btn" id="usernameLoginSubmitBtn">ç™»å½•</button>
        </div>
        
        <!-- æ³¨å†Œé“¾æ¥ -->
        <div class="register-link">
          è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="javascript:void(0)" onclick="openRegisterModal()">ç‚¹å‡»è¿™é‡Œæ³¨å†Œ</a>
        </div>
      </form>

      <div class="tips" style="display: none">ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®</div>
    </div>

    <!-- éšç§æ”¿ç­–å¼¹çª— -->
    <div id="privacyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">éšç§æ”¿ç­–</div>
          <span class="close" onclick="closeModal('privacyModal')">&times;</span>
        </div>
        <div class="modal-body" id="privacyContent">
          <div class="modal-loading">æ­£åœ¨åŠ è½½éšç§æ”¿ç­–...</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="modal-btn-secondary" onclick="privacyReject()">æ‹’ç»å¹¶å…³é—­</button>
          <button type="button" class="modal-btn-primary" onclick="privacyAgree()">åŒæ„å¹¶ç»§ç»­</button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·åè®®å¼¹çª— -->
    <div id="licenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">ç”¨æˆ·åè®®</div>
          <span class="close" onclick="closeModal('licenseModal')">&times;</span>
        </div>
        <div class="modal-body" id="licenseContent">
          <div class="modal-loading">æ­£åœ¨åŠ è½½ç”¨æˆ·åè®®...</div>
        </div>
      </div>
    </div>

    <!-- å®åè®¤è¯å¼¹çª— -->
    <div id="realnameModal" class="modal realname-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">å®åè®¤è¯</div>
          <span class="close" onclick="closeModal('realnameModal')">&times;</span>
        </div>
        <div class="modal-body">
          <p style="color: #64748b; margin-bottom: 20px; text-align: center">ä¸ºäº†æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å®Œæˆå®åè®¤è¯</p>
          <form class="realname-form" id="realnameForm">
            <div class="form-group">
              <div class="input-container">
                <input type="tel" class="input-field" id="realnamePhoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " maxlength="11" />
              </div>
              <div class="error-message" id="realnamePhoneError">è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç </div>
            </div>

            <div class="form-group">
              <div class="input-container">
                <input type="text" class="input-field verify-input" id="realnameCodeInput" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="4" />
                <button type="button" class="verify-btn" id="realnameVerifyBtn">è·å–éªŒè¯ç </button>
              </div>
              <div class="error-message" id="realnameCodeError">è¯·è¾“å…¥æ­£ç¡®çš„éªŒè¯ç </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="modal-btn-primary" style="width: 100%; padding: 16px">å®Œæˆè®¤è¯</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- å®åé€šçŸ¥å¼¹çª— -->
    <div id="realnameNoticeModal" class="modal realname-notice-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">å®åè®¤è¯çŠ¶æ€</div>
        </div>
        <div class="modal-body">
          <div class="realname-notice-icon">âœ…</div>
          <div class="realname-notice-text" id="realnameNoticeText">
            æ‚¨å·²å®Œæˆå®åè®¤è¯<br />
            å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-btn-primary" onclick="closeRealnameNoticeAndContinue()">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>    <!-- ç”¨æˆ·ä¿¡æ¯è®¾ç½®å¼¹çª— -->
    <div id="userSettingModal" class="modal user-setting-modal">
      <iframe id="user_setting_iframe" src="" style="width: 100%; height: 100vh; border: none; background: white"></iframe>
    </div>
      <!-- æ³¨å†Œå¼¹çª— -->
    <div id="registerModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRegisterModal()">&times;</span>
        <iframe id="register_iframe" src=""></iframe>
      </div>
    </div>
    
    <!-- èº«ä»½è®¤è¯å¼¹çª— -->
    <div id="idVerifyModal" class="modal" style="z-index: 4000;">
      <div class="modal-content" style="width: 100vw; height: 100vh; max-width: none; padding: 0; margin: 0; border-radius: 0;">
        <iframe id="idVerifyIframe" src="" style="width: 100%; height: 100%; border: none; overflow: hidden;"></iframe>
      </div>
    </div>
    
    <!-- Developer Panel -->
    <div id="devPanel" class="dev-panel">
      <button class="dev-close" onclick="hideDevPanel()">&times;</button>
      <h3>å¼€å‘è€…é€‰é¡¹</h3>

      <div class="dev-option-group">
        <div class="dev-option-title">é¡¹ç›®è®¾ç½®</div>        <div class="dev-option">
          <div>
            <label for="projectIdInput">é¡¹ç›®ID (é»˜è®¤: 4108584)</label>
            <div class="project-id-container">
              <input type="text" id="projectIdInput" placeholder="è¾“å…¥é¡¹ç›®ID" onchange="updateProjectId(this.value)" />
              <select id="projectIdSelect" class="project-id-dropdown" onchange="selectProjectId(this.value)">
                <option value="">é€‰æ‹©...</option>
                <option value="4108584">4108584 (æ­£å¼ç‰ˆ)</option>
                <option value="4300098">4300098ï¼ˆDevï¼‰</option>
                <option value="4299999">4266694ï¼ˆå†…æµ‹ï¼‰</option>
                <option value="530">530</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="dev-option-group">
        <div class="dev-option-title">æ˜¾ç¤ºè®¾ç½®</div>
        <div class="dev-option">
          <input type="checkbox" id="showDevPanelOnStart" onchange="toggleShowDevPanelOnStart(this.checked)" />
          <label for="showDevPanelOnStart">å¯åŠ¨æ—¶æ˜¾ç¤ºå¼€å‘é¢æ¿</label>
        </div>
        <div class="dev-option">
          <input type="checkbox" id="showDevContent" onchange="toggleShowDevContent(this.checked)" />
          <label for="showDevContent">æ˜¾ç¤ºDevå†…å®¹</label>
        </div>
        <div class="dev-option">
          <input type="checkbox" id="showRealName" onchange="toggleShowRealName(this.checked)" />
          <label for="showRealName">æ˜¾ç¤ºå®åè®¤è¯</label>
        </div>
      </div>

      <div class="dev-option-group">
        <div class="dev-option-title">æœåŠ¡è®¾ç½®</div>
        <div class="dev-option">
          <input type="checkbox" id="useMaisiDev" onchange="toggleMaisiDevServer(this.checked)" />
          <label for="useMaisiDev">ä½¿ç”¨maisi DevæœåŠ¡</label>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
    <div id="autoLoginStatus" class="auto-login-status">
      <h3 id="autoLoginTitle">è‡ªåŠ¨ç™»å½•ä¸­</h3>
      <p id="autoLoginMessage">æ£€æµ‹åˆ°ä¸Šæ¬¡ç™»å½•è´¦å·ï¼Œæ­£åœ¨è‡ªåŠ¨ç™»å½•ï¼Œè¯·ç¨å...</p>
      <div class="auto-login-buttons" id="autoLoginButtons" style="display: none">
        <button class="auto-login-btn primary" onclick="proceedAutoLogin()">è‡ªåŠ¨ç™»å½•</button>
        <button class="auto-login-btn secondary" onclick="cancelAutoLogin()">è¿”å›</button>
      </div>
    </div>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      // Developer Mode functionality
      let maisiIconClickCount = 0;
      let clickTimer = null;
      let devOptions = {
        isUseMaisiDevServer: false,
        isShowDevContent: false,
        isShowDevPanelOnStart: false,
        isShowRealName: false,
        projectId: "4108584",
      };

      const DEFAULT_PROJECT_ID = "4108584";

      // Initialize developer mode click handler
      function initDevMode() {
        const maisiIcon = document.getElementById("maisiIcon");
        if (maisiIcon) {
          maisiIcon.addEventListener("click", handleMaisiIconClick);
        }
      }
     
      function handleMaisiIconClick() {
        maisiIconClickCount++;

        // Reset counter after 3 seconds if not reaching 5 clicks
        if (clickTimer) {
          clearTimeout(clickTimer);
        }

        clickTimer = setTimeout(() => {
          maisiIconClickCount = 0;
        }, 3000);

        // Show dev panel after 5 clicks
        if (maisiIconClickCount >= 5) {
          showDevPanel();
          maisiIconClickCount = 0;
          clearTimeout(clickTimer);
        }
      }

      function showDevPanel() {
        const devPanel = document.getElementById("devPanel");
        if (devPanel) {
          devPanel.classList.add("show");
          isDevModeActive = true;
          // Set default values when dev panel is first shown
          devOptions.isShowDevContent = true;
          document.getElementById("showDevContent").checked = true;
        }
      }

      function hideDevPanel() {
        const devPanel = document.getElementById("devPanel");
        if (devPanel) {
          devPanel.classList.remove("show");
          isDevModeActive = false;
        }
      }

      // ä¿®æ”¹APIå®¢æˆ·ç«¯ï¼Œè‡ªåŠ¨æ·»åŠ Authorizationå¤´
      class ApiClient {
        constructor(baseUrl = "") {
          this.baseUrl = baseUrl;
          this.defaultHeaders = {
            "Content-Type": "application/json",
            Accept: "application/json",
          };
        }

        // é€šç”¨è¯·æ±‚æ–¹æ³•
        async request(url, options = {}) {
          try {
            const config = {
              ...options,
              headers: {
                ...this.defaultHeaders,
                ...options.headers,
              },
            };

            const response = await fetch(this.baseUrl + url, config);

            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              console.error("Response error:", response.status, error);
              throw error;
            }

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              return await response.json();
            }

            return await response.text();
          } catch (error) {
            throw error;
          }
        }

        // GET è¯·æ±‚
        async get(url, params = {}, headers = {}) {
          const queryString = new URLSearchParams(params).toString();
          const fullUrl = queryString ? `${url}?${queryString}` : url;

          return this.request(fullUrl, {
            method: "GET",
            headers,
          });
        }

        // POST è¯·æ±‚
        async post(url, data = {}, headers = {}) {
          return this.request(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...headers,
            },
            body: JSON.stringify(data),
          });
        }

        // è®¾ç½®é»˜è®¤å¤´éƒ¨
        setDefaultHeader(key, value) {
          this.defaultHeaders[key] = value;
        }

        // è®¾ç½®åŸºç¡€URL
        setBaseUrl(url) {
          this.baseUrl = url;
        }
      }

      // åˆ›å»ºAPIå®¢æˆ·ç«¯å®ä¾‹
      const api = new ApiClient("https://api.keepwork.com/core/v0");
      const maisiApi = new ApiClient("https://be.maseai.com/api/v1/open");

      // è·å–maisiAIç”¨æˆ·ä¿¡æ¯
      async function getMsUserInfo() {
        try {
          const header = {
            Authorization: `Bearer ${await tokenManager.getMaisiAccessToken()}`,
          };
          const response = await maisiApi.get("/open/getUserInfo", {}, header);
          console.log("è·å–maisiAIç”¨æˆ·ä¿¡æ¯å“åº”:", response);
          return response;
        } catch (error) {
          console.warn("è·å–maisiAIç”¨æˆ·ä¿¡æ¯å¤±è´¥:", error);
          return null;
        }
      }

      class LocalStorageProxy {
        constructor() {
          this.requestId = 0;
          this.pendingRequests = new Map();

          // ç›‘å¬çˆ¶é¡µé¢çš„å“åº”
          window.addEventListener("message", (event) => {
            if (event.data.type === "localStorageResponse") {
              const { requestId, success, data, error } = event.data;
              const request = this.pendingRequests.get(requestId);

              if (request) {
                this.pendingRequests.delete(requestId);
                if (success) {
                  request.resolve(data);
                } else {
                  request.reject(new Error(error));
                }
              }
            }
          });
        }

        _sendRequest(action, key, value) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId;

            this.pendingRequests.set(requestId, { resolve, reject });

            // è®¾ç½®è¶…æ—¶
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId);
                reject(new Error("LocalStorage operation timeout"));
              }
            }, 5000);

            // å‘é€è¯·æ±‚åˆ°çˆ¶é¡µé¢
            window.parent.postMessage(
              {
                type: "localStorage",
                action,
                key,
                value,
                requestId,
              },
              "*"
            );
          });
        }

        // æ ‡å‡†localStorage API
        async getItem(key) {
          return await this._sendRequest("getItem", key);
        }

        async setItem(key, value) {
          return await this._sendRequest("setItem", key, value);
        }

        async removeItem(key) {
          return await this._sendRequest("removeItem", key);
        }

        async clear() {
          return await this._sendRequest("clear");
        }

        async key(index) {
          return await this._sendRequest("key", null, index);
        }

        async length() {
          return await this._sendRequest("length");
        }

        async keys() {
          return await this._sendRequest("keys");
        }

        // æ‰©å±•API - ä½¿ç”¨çˆ¶é¡µé¢çš„å·¥å…·æ–¹æ³•
        async getStorageData(key, defaultValue = {}) {
          return await this._sendRequest("getStorageData", key, defaultValue);
        }

        async setStorageData(key, data) {
          return await this._sendRequest("setStorageData", key, data);
        }
      }

      // åˆ›å»ºå…¨å±€å®ä¾‹
      window.parentLocalStorage = new LocalStorageProxy();

      // Tokenç®¡ç†å™¨
      class TokenManager {
        constructor() {
          this.TOKEN_KEY = "keepwork_access_token";
          this.EXPIRES_KEY = "keepwork_token_expires";
          this.MAISI_TOKEN_KEY = "mais_games_access_token";
          this.MAISI_EXPIRES_KEY = "mais_games_token_expires";
          this.USER_INFO_KEY = "keepwork_user_info";
          this.DEV_PANEL_KEY = "dev_panel_options";

          // ç¡®ä¿parentLocalStorageå­˜åœ¨
          this.storage = window.parentLocalStorage || localStorage;
        }

        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä»£ç†å­˜å‚¨
        get isUsingProxy() {
          return window.parent !== window && window.parentLocalStorage;
        } // ä¿å­˜tokenä¿¡æ¯
        async saveTokens(data) {
          const now = Date.now();
          const expiresAt = now + data.tokenExpire * 1000; // è½¬æ¢ä¸ºæ¯«ç§’

          if (this.isUsingProxy) {
            await this.storage.setItem(this.TOKEN_KEY, data.token);
            await this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString());
          } else {
            localStorage.setItem(this.TOKEN_KEY, data.token);
            localStorage.setItem(this.EXPIRES_KEY, expiresAt.toString());
          }

          console.log("Keepwork Tokenå·²ä¿å­˜ï¼Œè¿‡æœŸæ—¶é—´:", new Date(expiresAt));
        }

        async saveMaisiToken(data) {
          const now = Date.now();
          const expiresAt = now + data.expiresIn * 1000; // è½¬æ¢ä¸ºæ¯«ç§’

          if (this.isUsingProxy) {
            await this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken);
            await this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString());
          } else {
            localStorage.setItem(this.MAISI_TOKEN_KEY, data.accessToken);
            localStorage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString());
          }

          console.log("éº¦æ€Tokenå·²ä¿å­˜ï¼Œè¿‡æœŸæ—¶é—´:", new Date(expiresAt));
        } // è·å–è®¿é—®ä»¤ç‰Œ
        async getAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.TOKEN_KEY);
          } else {
            return localStorage.getItem(this.TOKEN_KEY);
          }
        }

        async getMaisiAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.MAISI_TOKEN_KEY);
          } else {
            return localStorage.getItem(this.MAISI_TOKEN_KEY);
          }
        } // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
        async isTokenValid() {
          let token, expiresAt;

          if (this.isUsingProxy) {
            token = await this.getAccessToken();
            expiresAt = await this.storage.getItem(this.EXPIRES_KEY);
          } else {
            token = await this.getAccessToken();
            expiresAt = localStorage.getItem(this.EXPIRES_KEY);
          }

          if (!token || !expiresAt) {
            return false;
          }

          const now = Date.now();
          const expires = parseInt(expiresAt);

          // æå‰5åˆ†é’Ÿåˆ¤æ–­è¿‡æœŸï¼ˆå®‰å…¨è¾¹é™…ï¼‰
          return now < expires - 5 * 60 * 1000;
        }
        async isMaisiTokenValid() {
          let token, expiresAt;

          if (this.isUsingProxy) {
            token = await this.getMaisiAccessToken();
            expiresAt = await this.storage.getItem(this.MAISI_EXPIRES_KEY);
          } else {
            token = await this.getMaisiAccessToken();
            expiresAt = localStorage.getItem(this.MAISI_EXPIRES_KEY);
          }

          if (!token || !expiresAt) {
            return false;
          }

          const now = Date.now();
          const expires = parseInt(expiresAt);

          // æå‰5åˆ†é’Ÿåˆ¤æ–­è¿‡æœŸï¼ˆå®‰å…¨è¾¹é™…ï¼‰
          return now < expires - 5 * 60 * 1000;
        } // æ¸…é™¤æ‰€æœ‰tokenä¿¡æ¯
        async clearTokens() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.TOKEN_KEY);
            await this.storage.removeItem(this.EXPIRES_KEY);
            await this.storage.removeItem(this.MAISI_TOKEN_KEY);
            await this.storage.removeItem(this.MAISI_EXPIRES_KEY);
            await this.storage.removeItem(this.USER_INFO_KEY);
            await this.storage.removeItem(this.DEV_PANEL_KEY);
          } else {
            localStorage.removeItem(this.TOKEN_KEY);
            localStorage.removeItem(this.EXPIRES_KEY);
            localStorage.removeItem(this.MAISI_TOKEN_KEY);
            localStorage.removeItem(this.MAISI_EXPIRES_KEY);
            localStorage.removeItem(this.USER_INFO_KEY);
            localStorage.removeItem(this.DEV_PANEL_KEY);
          }
        } // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        async saveUserInfo(userInfo) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo));
          } else {
            localStorage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo));
          }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async getUserInfo() {
          let userInfo;

          if (this.isUsingProxy) {
            userInfo = await this.storage.getItem(this.USER_INFO_KEY);
          } else {
            userInfo = localStorage.getItem(this.USER_INFO_KEY);
          }

          return userInfo ? JSON.parse(userInfo) : null;
        } // ä¿å­˜Developer PanelçŠ¶æ€
        async saveDevPanelOptions(devOptions) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.DEV_PANEL_KEY, JSON.stringify(devOptions));
          } else {
            localStorage.setItem(this.DEV_PANEL_KEY, JSON.stringify(devOptions));
          }
        }

        // è·å–Developer PanelçŠ¶æ€
        async getDevPanelOptions() {
          let devOptionsStr;

          if (this.isUsingProxy) {
            devOptionsStr = await this.storage.getItem(this.DEV_PANEL_KEY);
          } else {
            devOptionsStr = localStorage.getItem(this.DEV_PANEL_KEY);
          }

          return devOptionsStr ? JSON.parse(devOptionsStr) : null;
        }

        // æ¸…é™¤Developer PanelçŠ¶æ€
        async clearDevPanelOptions() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.DEV_PANEL_KEY);
          } else {
            localStorage.removeItem(this.DEV_PANEL_KEY);
          }
        }
      } // åˆ›å»ºtokenç®¡ç†å™¨å®ä¾‹
      const tokenManager = new TokenManager();

      // é¡¹ç›®IDç®¡ç†åŠŸèƒ½
      async function updateProjectId(value) {
        const projectId = value.trim() || DEFAULT_PROJECT_ID;
        devOptions.projectId = projectId;
        await tokenManager.saveDevPanelOptions(devOptions);

        // å¦‚æœé¡¹ç›®IDä¸æ˜¯é»˜è®¤å€¼ï¼Œè‡ªåŠ¨å¯ç”¨æ˜¾ç¤ºå¼€å‘é¢æ¿é€‰é¡¹
        if (projectId !== DEFAULT_PROJECT_ID) {
          devOptions.isShowDevPanelOnStart = true;
          document.getElementById("showDevPanelOnStart").checked = true;
          await tokenManager.saveDevPanelOptions(devOptions);
        }

        console.log("é¡¹ç›®IDå·²æ›´æ–°ä¸º:", projectId);
      }

      async function selectProjectId(value) {
        if (value) {
          document.getElementById("projectIdInput").value = value;
          await updateProjectId(value);
          // é‡ç½®ä¸‹æ‹‰åˆ—è¡¨ä¸ºé»˜è®¤é€‰æ‹©
          document.getElementById("projectIdSelect").value = "";
        }
      }

      async function toggleShowDevPanelOnStart(isEnabled) {
        devOptions.isShowDevPanelOnStart = isEnabled;
        await tokenManager.saveDevPanelOptions(devOptions);
        console.log("å¯åŠ¨æ—¶æ˜¾ç¤ºå¼€å‘é¢æ¿:", isEnabled);
      }

      // è‡ªåŠ¨ç™»å½•çŠ¶æ€æ˜¾ç¤ºç®¡ç†
      function showAutoLoginStatus(username, isDevPanelMode = false) {
        const statusDiv = document.getElementById("autoLoginStatus");
        const titleElement = document.getElementById("autoLoginTitle");
        const messageElement = document.getElementById("autoLoginMessage");
        const buttonsDiv = document.getElementById("autoLoginButtons");

        if (isDevPanelMode) {
          titleElement.textContent = "æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€";
          messageElement.innerHTML = `ä¸Šæ¬¡ç™»å½•è´¦å·: <strong>${username}</strong><br/>é€‰æ‹©æ“ä½œæ–¹å¼`;
          buttonsDiv.style.display = "flex";
        } else {
          titleElement.textContent = "è‡ªåŠ¨ç™»å½•ä¸­";
          messageElement.innerHTML = `æ£€æµ‹åˆ°ä¸Šæ¬¡ç™»å½•è´¦å·: <strong>${username}</strong><br/>æ­£åœ¨è‡ªåŠ¨ç™»å½•ï¼Œè¯·ç¨å...`;
          buttonsDiv.style.display = "none";
        }

        statusDiv.style.display = "block";
      }

      function hideAutoLoginStatus() {
        const statusDiv = document.getElementById("autoLoginStatus");
        statusDiv.style.display = "none";
      }

      function showLoginStatus() {
        const statusDiv = document.getElementById("autoLoginStatus");
        const titleElement = document.getElementById("autoLoginTitle");
        const messageElement = document.getElementById("autoLoginMessage");
        const buttonsDiv = document.getElementById("autoLoginButtons");

        titleElement.textContent = "ç™»å½•ä¸­";
        messageElement.innerHTML = "æ­£åœ¨å¤„ç†ç™»å½•è¯·æ±‚ï¼Œè¯·ç¨å...";
        buttonsDiv.style.display = "none";
        statusDiv.style.display = "block";
      }
      async function proceedAutoLogin() {
        // æ‰§è¡ŒåŸæœ‰çš„è‡ªåŠ¨ç™»å½•é€»è¾‘
        await performAutoLogin();
      }

      // æ‰§è¡Œè‡ªåŠ¨ç™»å½•çš„æ ¸å¿ƒé€»è¾‘
      async function performAutoLogin() {
        try {
          const locationInfo = await getParentLocation();
          await navigateToMSGames(locationInfo.href);
        } catch (error) {
          console.error("è‡ªåŠ¨ç™»å½•å¤±è´¥:", error);
          hideAutoLoginStatus();
          showMessage("è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç™»å½•");
          showLoginForm();
        }
      }

      function cancelAutoLogin() {
        hideAutoLoginStatus();
        showLoginForm();
      } 
      // åˆå§‹åŒ–å¼€å‘é¢æ¿çŠ¶æ€
      async function initDevPanelState() {
        try {
          const savedOptions = await tokenManager.getDevPanelOptions();
          if (savedOptions) {
            devOptions = { ...devOptions, ...savedOptions };

            // å½“é¡¹ç›®IDä¸æ˜¯é»˜è®¤å€¼æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨æ˜¾ç¤ºå¼€å‘é¢æ¿é€‰é¡¹
            if (devOptions.projectId !== DEFAULT_PROJECT_ID) {
              devOptions.isShowDevPanelOnStart = true;
            }

            // æ›´æ–°UIçŠ¶æ€
            document.getElementById("useMaisiDev").checked = devOptions.isUseMaisiDevServer;
            document.getElementById("showDevContent").checked = devOptions.isShowDevContent;
            document.getElementById("showDevPanelOnStart").checked = devOptions.isShowDevPanelOnStart;
            document.getElementById("showRealName").checked = devOptions.isShowRealName;
            document.getElementById("projectIdInput").value = devOptions.projectId || DEFAULT_PROJECT_ID;

            // å¦‚æœé¡¹ç›®IDä¸æ˜¯é»˜è®¤å€¼æˆ–è®¾ç½®äº†æ˜¾ç¤ºå¼€å‘é¢æ¿ï¼Œåˆ™æ˜¾ç¤ºå¼€å‘é¢æ¿
            if (devOptions.projectId !== DEFAULT_PROJECT_ID || devOptions.isShowDevPanelOnStart) {
              showDevPanel();
            }
          } else {
            // æ²¡æœ‰ä¿å­˜çš„é€‰é¡¹æ—¶ï¼Œä»éœ€è¦æ›´æ–°UIçŠ¶æ€
            document.getElementById("useMaisiDev").checked = devOptions.isUseMaisiDevServer;
            document.getElementById("showDevContent").checked = devOptions.isShowDevContent;
            document.getElementById("showDevPanelOnStart").checked = devOptions.isShowDevPanelOnStart;
            document.getElementById("showRealName").checked = devOptions.isShowRealName;
            document.getElementById("projectIdInput").value = devOptions.projectId || DEFAULT_PROJECT_ID;

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¼€å‘é¢æ¿
            if (devOptions.projectId !== DEFAULT_PROJECT_ID || devOptions.isShowDevPanelOnStart) {
              showDevPanel();
            }
          }
        } catch (error) {
          console.error("åˆå§‹åŒ–å¼€å‘é¢æ¿çŠ¶æ€å¤±è´¥:", error);
        }
      }

      // è·å–çˆ¶çª—å£Locationä¿¡æ¯Promiseå­˜å‚¨
      let getLocationResolve = null;
      let getLocationReject = null; // åˆå§‹åŒ–æ¸¸æˆæ ‡é¢˜æ˜¾ç¤º
      function initGameTitle(locationInfo) {
        const urlParams = new URLSearchParams((locationInfo || window.location).search);
        const loginGameTitle = urlParams.get("loginGameTitle");

        if (loginGameTitle) {
          const gameTitleElement = document.getElementById("gameTitle");
          if (gameTitleElement) {
            gameTitleElement.textContent = decodeURIComponent(loginGameTitle);
            gameTitleElement.style.display = "block";
          }
        }
      }

      // åˆå§‹åŒ–æ¸¸å®¢æ¨¡å¼
      function initGuestMode(locationInfo) {
        const urlParams = new URLSearchParams((locationInfo || window.location).search);
        const allowGuestMode = urlParams.get("allowGuestMode");

        if (allowGuestMode === "true") {
          // ä¸ºæ‰‹æœºå·ç™»å½•è¡¨å•æ·»åŠ æ¸¸å®¢ç™»å½•æŒ‰é’®
          const phoneButtonContainer = document.getElementById("phoneButtonContainer");
          if (phoneButtonContainer && !document.getElementById("phoneGuestBtn")) {
            const guestBtn = document.createElement("button");
            guestBtn.type = "button";
            guestBtn.className = "guest-login-btn";
            guestBtn.id = "phoneGuestBtn";
            guestBtn.textContent = "æ¸¸å®¢ç™»å½•";
            guestBtn.onclick = guestLogin;
            phoneButtonContainer.appendChild(guestBtn);
          }

          // ä¸ºç”¨æˆ·åå¯†ç ç™»å½•è¡¨å•æ·»åŠ æ¸¸å®¢ç™»å½•æŒ‰é’®
          const usernameButtonContainer = document.getElementById("usernameButtonContainer");
          if (usernameButtonContainer && !document.getElementById("usernameGuestBtn")) {
            const guestBtn = document.createElement("button");
            guestBtn.type = "button";
            guestBtn.className = "guest-login-btn";
            guestBtn.id = "usernameGuestBtn";
            guestBtn.textContent = "æ¸¸å®¢ç™»å½•";
            guestBtn.onclick = guestLogin;
            usernameButtonContainer.appendChild(guestBtn);
          }
        }
      }

      // æ¸¸å®¢ç™»å½•åŠŸèƒ½
      async function guestLogin() {
        try {
          showMessage("æ­£åœ¨ä»¥æ¸¸å®¢èº«ä»½ç™»å½•...");
          // Forward all existing URL parameters plus the new objective parameter
          const urlParams = new URLSearchParams(window.location.search);

          // replace current href's wiki_dashboard with characterAI.
          let url = window.location.href;
          url = url.split("?")[0];
          url = url.replace("ms_games_login", urlParams.get("loginGameName") || "");

          url = `${url}?${urlParams.toString()}`;
          window.location.replace(url);
        } catch (error) {
          console.error("æ¸¸å®¢ç™»å½•å¤±è´¥:", error);
          showMessage("æ¸¸å®¢ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
      }
      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¸¸æˆæ ‡é¢˜å’Œæ£€æŸ¥ç™»å½•çŠ¶æ€
      checkLoginStatus();

      // Initialize developer mode
      initDevMode();

      // Markdownè½¬HTMLçš„ç®€å•å®ç°
      function markdownToHtml(markdown) {
        if (!markdown) return "";

        let html = markdown
          // æ ‡é¢˜è½¬æ¢
          .replace(/^### (.*$)/gim, "<h3>$1</h3>")
          .replace(/^## (.*$)/gim, "<h2>$1</h2>")
          .replace(/^# (.*$)/gim, "<h1>$1</h1>")
          // ç²—ä½“
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/__(.*?)__/g, "<strong>$1</strong>")
          // æ–œä½“
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/_(.*?)_/g, "<em>$1</em>")
          // ä»£ç 
          .replace(/`(.*?)`/g, "<code>$1</code>")
          // é“¾æ¥
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          // åˆ—è¡¨
          .replace(/^[\s]*\*[\s]+(.*$)/gim, "<li>$1</li>")
          .replace(/^[\s]*\d+\.[\s]+(.*$)/gim, "<li>$1</li>")
          // æ®µè½
          .replace(/\n\n/g, "</p><p>")
          .replace(/\n/g, "<br>");

        // åŒ…è£…åˆ—è¡¨é¡¹
        html = html.replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>");

        // åŒ…è£…æ®µè½
        if (!html.startsWith("<h") && !html.startsWith("<ul") && !html.startsWith("<ol")) {
          html = "<p>" + html + "</p>";
        }

        return html;
      }

      // æ‰“å¼€éšç§æ”¿ç­–å¼¹çª—
      async function openPrivacyModal() {
        const modal = document.getElementById("privacyModal");
        const content = document.getElementById("privacyContent");

        modal.style.display = "block";
        content.innerHTML = '<div class="modal-loading">æ­£åœ¨åŠ è½½éšç§æ”¿ç­–...</div>';

        try {
          const response = await fetch("https://cross.keepwork.com/api/raw/maisi/maisi/docs/privacy");
          const markdown = await response.text();
          const html = markdownToHtml(markdown);
          hideAutoLoginStatus();
          content.innerHTML = html;
        } catch (error) {
          console.error("åŠ è½½éšç§æ”¿ç­–å¤±è´¥:", error);
          content.innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
          hideAutoLoginStatus();
        }
      }

      // æ‰“å¼€ç”¨æˆ·åè®®å¼¹çª—
      async function openLicenseModal() {
        const modal = document.getElementById("licenseModal");
        const content = document.getElementById("licenseContent");

        modal.style.display = "block";
        content.innerHTML = '<div class="modal-loading">æ­£åœ¨åŠ è½½ç”¨æˆ·åè®®...</div>';

        try {
          const response = await fetch("https://cross.keepwork.com/api/raw/maisi/maisi/docs/license");
          const markdown = await response.text();
          const html = markdownToHtml(markdown);
          content.innerHTML = html;
        } catch (error) {
          console.error("åŠ è½½ç”¨æˆ·åè®®å¤±è´¥:", error);
          content.innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
        }
      }      // å…³é—­å¼¹çª—
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // æ‰“å¼€æ³¨å†Œå¼¹çª—
      function openRegisterModal() {
        const modal = document.getElementById("registerModal");
        const iframe = document.getElementById("register_iframe");
        
        // è®¾ç½®iframeæº
        const currentUrl = new URL(window.location.href);
        const baseUrl = currentUrl.origin + currentUrl.pathname.replace('ms_games_login', 'ms_games_register');
        iframe.src = baseUrl;
        
        // æ˜¾ç¤ºmodal
        modal.style.display = "block";
      }

      // å…³é—­æ³¨å†Œå¼¹çª—
      function closeRegisterModal() {
        const modal = document.getElementById("registerModal");
        const iframe = document.getElementById("register_iframe");
        
        // éšè—modal
        modal.style.display = "none";
        
        // æ¸…ç©ºiframeæºä»¥èŠ‚çœèµ„æº
        iframe.src = "";
      }

      // èº«ä»½è®¤è¯å¼¹çª—ç›¸å…³å‡½æ•°
      function showIdVerifyModal() {
        hideAutoLoginStatus();
        const modal = document.getElementById("idVerifyModal");
        const iframe = document.getElementById("idVerifyIframe");
        
        // æ„é€ iframe src
        const url = window.location.href.replace("ms_games_login", "ms_games_id_verify");
        iframe.src = url;
        modal.style.display = "block";
      }

      function closeIdVerifyModal() {
        const modal = document.getElementById("idVerifyModal");
        const iframe = document.getElementById("idVerifyIframe");
        
        modal.style.display = "none";
        iframe.src = "";
      }

      // åŒæ„éšç§æ”¿ç­–æŒ‰é’®ï¼šå…³é—­å¼¹çª—å¹¶å‹¾é€‰å¤–éƒ¨å¤é€‰æ¡†
      function privacyAgree() {
        try {
          const cb1 = document.getElementById("agreementCheckbox");
          const cb2 = document.getElementById("agreementCheckbox2");
          if (cb1) cb1.checked = true;
          if (cb2) cb2.checked = true;
        } catch (e) {
          console.warn("è®¾ç½®å¤é€‰æ¡†çŠ¶æ€å¤±è´¥", e);
        }
        closeModal("privacyModal");
      }

      // æ‹’ç»éšç§æ”¿ç­–æŒ‰é’®ï¼šä»…å…³é—­å¼¹çª—
      function privacyReject() {
        try {
          const cb1 = document.getElementById("agreementCheckbox");
          const cb2 = document.getElementById("agreementCheckbox2");
          if (cb1) cb1.checked = false;
          if (cb2) cb2.checked = false;
        } catch (e) {
          console.warn("è®¾ç½®å¤é€‰æ¡†çŠ¶æ€å¤±è´¥", e);
        }
        closeModal("privacyModal");
      } // æ£€æŸ¥ç™»å½•çŠ¶æ€
      async function checkLoginStatus() {
        let isNeedCheck = true;
        let locationInfo = null;

        try {
          locationInfo = await getParentLocation();
          if (new URLSearchParams(locationInfo.search).get("showType") === "logout") {
            console.log("ç”¨æˆ·ç™»å‡º");
            await tokenManager.clearTokens();
            isNeedCheck = false;
          }
        } catch (_) {}

        initGameTitle(locationInfo);
        initGuestMode(locationInfo);

        // åˆå§‹åŒ–å¼€å‘é¢æ¿çŠ¶æ€
        await initDevPanelState();

        if (!isNeedCheck || !locationInfo) return;

        console.log("æ£€æŸ¥ç™»å½•çŠ¶æ€...");
        if (await tokenManager.isTokenValid()) {
          console.log("ç”¨æˆ·å·²ç™»å½•ï¼Œtokenæœ‰æ•ˆ"); // æ›´æ–°maisiApiçš„baseUrlï¼ˆdevOptionså·²åœ¨initDevPanelStateä¸­æ¢å¤ï¼‰
          if (devOptions.isUseMaisiDevServer) {
            maisiApi.setBaseUrl("https://maseai-be-qa1.langcong.com/api/v1");
          }

          // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¼€å‘é¢æ¿æ¨¡å¼
          const userInfo = await tokenManager.getUserInfo();
          const username = userInfo?.username || userInfo?.phone || "ç”¨æˆ·";
          
          // æœ‰æ•ˆtokenè§†ä¸ºå·²åŒæ„å¹¶ç™»å½•è¿‡
          markPrivacyConsent();
          let bAllowCancelAutoLogin = devOptions.isShowDevPanelOnStart || devOptions.projectId !== DEFAULT_PROJECT_ID || window.parent === window;

          if (bAllowCancelAutoLogin) {
            // æ˜¾ç¤ºå¼€å‘é¢æ¿æ¨¡å¼ï¼Œè®©ç”¨æˆ·é€‰æ‹©è‡ªåŠ¨ç™»å½•æˆ–è¿”å›
            showAutoLoginStatus(username, true);
          } else {
            // æ™®é€šæ¨¡å¼ï¼Œç›´æ¥è‡ªåŠ¨ç™»å½•
            showAutoLoginStatus(username, false);
          }
          if (!(await tokenManager.isMaisiTokenValid())) {
            console.log("Maisi tokenå·²è¿‡æœŸï¼Œé‡æ–°è·å–");
            const header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            };
            try {
              const response = await api.post(
                "/oauth/getMaisiToken",
                {
                  phone: userInfo?.phone || "",
                  from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                },
                header
              );
              await tokenManager.saveMaisiToken(response.token);
              console.log("Maisi tokenå·²æ›´æ–°");
            } catch (error) {
              console.error("è·å–Maisi tokenå¤±è´¥:", error);
            }
          }

          if (!bAllowCancelAutoLogin) {
            // æ™®é€šæ¨¡å¼ï¼Œç›´æ¥è‡ªåŠ¨ç™»å½•
            setTimeout(async () => {
              await performAutoLogin();
            }, 300);
          }

          sdk.remoteLog.logBehavior("maisiAI.user.autoLogin", {
            "userInfo": userInfo
          }, "maisiAI")
        } else {
          console.log("ç”¨æˆ·æœªç™»å½•æˆ–tokenå·²è¿‡æœŸ");
          await tokenManager.clearTokens();
          showLoginForm();

          // å³ä½¿æ²¡æœ‰ç™»å½•ï¼Œå¦‚æœè®¾ç½®äº†æ˜¾ç¤ºå¼€å‘é¢æ¿ï¼Œä»ç„¶è¦æ˜¾ç¤º
          if (devOptions.isShowDevPanelOnStart || devOptions.projectId !== DEFAULT_PROJECT_ID) {
            showDevPanel();
          }
        }
      }

      function getParentLocationWithTimeout(timeout = 1000) {
        if (window.parent !== window) {
          setTimeout(() => {
            window.parent.postMessage({ type: "getLocation" }, "*");
          }, timeout);
        } else {
          setTimeout(() => {
            navigateToMSGames();
          }, timeout);
        }
      }

      async function navigateToMSGames(href) {
        let originalUrl;
        try {
          originalUrl = new URL(href, window.location.href);
        } catch (e) {
          originalUrl = new URL(window.location.href);
        }
        let loginGameName = originalUrl.searchParams.get("loginGameName");
        let targetHref = href;
        if (!loginGameName) {
          const projectId = devOptions.projectId || DEFAULT_PROJECT_ID;
          targetHref = `https://keepwork.com/api/public/paracraft/index_release_html?pid=${projectId}&customLoader=https%3A%2F%2Fkeepwork.com%2Fmaisi%2Fmaisi%2Fwebgames%2Fdata%2Fcustom_loader1`;
        }

        const url = new URL(targetHref);

        for (const [key, value] of originalUrl.searchParams.entries()) {
          url.searchParams.set(key, value);
        }
        const accessToken = (await tokenManager.getAccessToken()) || "";
        if (!loginGameName) {
          url.searchParams.set("token", accessToken);
        } else {
          url.searchParams.set("gameName", loginGameName || "ms_games");
        }
        if (devOptions.isShowDevContent) {
          url.searchParams.set("dev", "true");
        }
        if (devOptions.isUseMaisiDevServer) {
          url.searchParams.set("isUseMaisiDevServer", "true");
        }

        if (window.parent !== window) {
          sdk.setToken(accessToken);
          sdk.getUserProfile();

          const userInfo = await tokenManager.getUserInfo();
          const username = userInfo?.username || "";
          const phone = userInfo?.phone || "";
          const maToken = (await tokenManager.getMaisiAccessToken()) || "";

          url.searchParams.set("username", username);
          url.searchParams.set("phone", phone);
          url.searchParams.set("thirdpartytoken", maToken);

          try {
            const platform = await getParacraftPlatform();
            if (platform) {
              url.searchParams.set("paracraftPlatform", platform);
            }
          } catch (e) {
            console.log("è·å–Paracraftå¹³å°å¤±è´¥:", e);
          }

          const response = await getMsUserInfo();
          if (response?.data) {
            url.searchParams.set("isMaisiTestCompleted", true);
          }

          try {
            const keepworkUser = await sdk.personalPageStore.loadPageData("maisi_userinfo", "user") || {};
            const maisiUserInfo = response?.data;
            if (maisiUserInfo && maisiUserInfo.birthday && keepworkUser.birthday != maisiUserInfo.birthday) {
              keepworkUser.birthday = maisiUserInfo.birthday;
              keepworkUser.gender = maisiUserInfo.sex;
              keepworkUser.vip = maisiUserInfo.vip;
              keepworkUser.grade = maisiUserInfo.grade;
              keepworkUser.age = calculateAge(keepworkUser.birthday);
              sdk.personalPageStore.savePageData("maisi_userinfo", "user", keepworkUser, true);
            }

            if (keepworkUser.birthday === undefined) {
              hideAutoLoginStatus();
              showUserSetting();
              return;
            }
          } catch (e) {
            console.log("è·å–Maisiç”¨æˆ·ä¿¡æ¯å¤±è´¥:", e);
          }

          // console.log('è·³è½¬åˆ°MSæ¸¸æˆé¡µé¢:', url.toString());
          window.parent.postMessage(
            {
              type: "navigate",
              url: url.toString(),
            },
            "*"
          );
        } else {
          window.location.href = url.toString();
        }
      }

      // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
      async function showLoggedInState() {
        const userInfo = await tokenManager.getUserInfo();
        const phone = userInfo ? userInfo.phone : "ç”¨æˆ·";

        // éšè—ç™»å½•è¡¨å•ï¼Œæ˜¾ç¤ºå·²ç™»å½•ä¿¡æ¯
        document.querySelector(".login-form").style.display = "none";
        document.querySelector(".tips").innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 24px; color: #667eea; margin-bottom: 20px;">
                        æ¬¢è¿å›æ¥ï¼${phone}
                    </p>
                    <button onclick="logout()" style="
                        padding: 12px 24px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                    ">é€€å‡ºç™»å½•</button>
                    <button onclick="goToMain()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: 15px;
                    ">è¿›å…¥ä¸»é¡µ</button>
                </div>
            `;
      }

      // æ˜¾ç¤ºç™»å½•è¡¨å•
      function showLoginForm() {
        document.getElementById("usernameLoginForm").style.display = "block";
        document.querySelector(".tips").style.display = "none";
      }

      // é€€å‡ºç™»å½•
      async function logout() {
        await tokenManager.clearTokens();
        showLoginForm();
        showMessage("å·²é€€å‡ºç™»å½•");
      }

      // è·³è½¬åˆ°ä¸»é¡µ
      function goToMain() {
        getParentLocationWithTimeout(0);
      }

      // æ‰‹æœºå·éªŒè¯
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
      }

      // éªŒè¯ç éªŒè¯
      function validateCode(code) {
        return /^\d{4}$/.test(code);
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.add("error");
        error.textContent = message;
        error.style.display = "block";
      }

      // éšè—é”™è¯¯ä¿¡æ¯
      function hideError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.remove("error");
        error.style.display = "none";
      }

      // å€’è®¡æ—¶åŠŸèƒ½
      function startCountdown(btn, seconds = 60) {
        btn.disabled = true;
        let remaining = seconds;

        const timer = setInterval(() => {
          btn.textContent = `${remaining}såé‡è¯•`;
          remaining--;

          if (remaining < 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = "è·å–éªŒè¯ç ";
          }
        }, 1000);
      }

      // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
      function showMessage(message) {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æç¤ºå…ƒç´ 
        let existingToast = document.querySelector(".toast");

        if (existingToast) {
          // æ›´æ–°ç°æœ‰å…ƒç´ çš„æ–‡æœ¬å†…å®¹
          existingToast.textContent = message;

          // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          if (existingToast.hideTimer) {
            clearTimeout(existingToast.hideTimer);
          }

          // é‡æ–°è®¾ç½®å®šæ—¶å™¨
          existingToast.hideTimer = setTimeout(() => {
            if (existingToast && existingToast.parentNode) {
              document.body.removeChild(existingToast);
            }
          }, 2000);
        } else {
          // åˆ›å»ºæ–°çš„æç¤ºå…ƒç´ 
          const toast = document.createElement("div");
          toast.className = "toast";
          toast.textContent = message;

          document.body.appendChild(toast);

          // è®¾ç½®å®šæ—¶å™¨å¹¶ä¿å­˜å¼•ç”¨
          toast.hideTimer = setTimeout(() => {
            if (toast && toast.parentNode) {
              document.body.removeChild(toast);
            }
          }, 2000);
        }
      }
      // åˆ‡æ¢åˆ°æ‰‹æœºå·ç™»å½•
      function switchToPhoneLogin() {
        const phoneForm = document.getElementById("phoneLoginForm");
        const usernameForm = document.getElementById("usernameLoginForm");
        const phoneBtn = document.getElementById("phoneLoginBtn");
        const usernameBtn = document.getElementById("usernameLoginBtn");

        phoneForm.style.display = "block";
        usernameForm.style.display = "none";
        phoneBtn.classList.add("active");
        usernameBtn.classList.remove("active");
      }

      // åˆ‡æ¢åˆ°ç”¨æˆ·åå¯†ç ç™»å½•
      function switchToUsernameLogin() {
        const phoneForm = document.getElementById("phoneLoginForm");
        const usernameForm = document.getElementById("usernameLoginForm");
        const phoneBtn = document.getElementById("phoneLoginBtn");
        const usernameBtn = document.getElementById("usernameLoginBtn");

        phoneForm.style.display = "none";
        usernameForm.style.display = "block";
        phoneBtn.classList.remove("active");
        usernameBtn.classList.add("active");
      }

      // éªŒè¯ç”¨æˆ·å
      function validateUsername(username) {
        return username && username.trim().length > 0;
      }

      // éªŒè¯å¯†ç 
      function validatePassword(password) {
        return password && password.trim().length >= 6;
      }

      // DOM å…ƒç´ 
      const phoneInput = document.getElementById("phoneInput");
      const codeInput = document.getElementById("codeInput");
      const verifyBtn = document.getElementById("verifyBtn");
      const phoneLoginForm = document.getElementById("phoneLoginForm");
      const usernameLoginForm = document.getElementById("usernameLoginForm");
      const agreementCheckbox = document.getElementById("agreementCheckbox");
      const agreementCheckbox2 = document.getElementById("agreementCheckbox2");
      const usernameInput = document.getElementById("usernameInput");
      const passwordInput = document.getElementById("passwordInput");

      // åè®®æ•´è¡Œç‚¹å‡»åˆ‡æ¢å¤é€‰æ¡†ï¼ˆç‚¹å‡»å…·ä½“é“¾æ¥é™¤å¤–ï¼‰
      document.querySelectorAll(".agreement-section .agreement-text").forEach((container) => {
        container.addEventListener("click", (e) => {
          if (e.target.closest(".agreement-link")) return; // ç‚¹å‡»é“¾æ¥ä¸åˆ‡æ¢
          const checkbox = container.parentElement.querySelector(".agreement-checkbox");
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
          }
        });
      });

      // æ‰‹æœºå·è¾“å…¥äº‹ä»¶
      phoneInput.addEventListener("input", function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("phoneInput", "phoneError");
      });

      // éªŒè¯ç è¾“å…¥äº‹ä»¶
      codeInput.addEventListener("input", function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("codeInput", "codeError");
      });

      // è·å–éªŒè¯ç 
      verifyBtn.addEventListener("click", async function () {
        const phone = phoneInput.value.trim();

        if (!validatePhone(phone)) {
          showError("phoneInput", "phoneError", "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ");
          phoneInput.focus();
          return;
        }

        try {
          // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•å‘é€éªŒè¯ç 
          const response = await api.get("/users/cellphone_captcha", {
            cellphone: phone,
          });

          console.log("å‘é€éªŒè¯ç å“åº”:", response);

          // å¼€å§‹å€’è®¡æ—¶
          startCountdown(verifyBtn);
          showMessage("éªŒè¯ç å·²å‘é€ï¼Œè¯·æ³¨æ„æŸ¥æ”¶");
        } catch (error) {
          console.error("å‘é€éªŒè¯ç å¤±è´¥:", error);
          let errorMessage = "å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";

          if (error.message.includes("429")) {
            errorMessage = "å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•";
          } else if (error.message.includes("400")) {
            errorMessage = "æ‰‹æœºå·æ ¼å¼é”™è¯¯";
          }

          showMessage(errorMessage);
        }
      }); // è¡¨å•æäº¤
      phoneLoginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = phoneInput.value.trim();
        const code = codeInput.value.trim();

        // éªŒè¯æ‰‹æœºå·
        if (!validatePhone(phone)) {
          showError("phoneInput", "phoneError", "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ");
          return;
        }

        // éªŒè¯éªŒè¯ç 
        if (!validateCode(code)) {
          showError("codeInput", "codeError", "è¯·è¾“å…¥4ä½æ•°å­—éªŒè¯ç ");
          return;
        }

        // éªŒè¯æ˜¯å¦åŒæ„æ¡æ¬¾
        if (!agreementCheckbox.checked) {
          showMessage("è¯·å‹¾é€‰åŒæ„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®");
          return;
        }

        // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•è¿›è¡Œç™»å½•
        const loginBtn = document.querySelector("#phoneLoginForm .login-btn");
        loginBtn.disabled = true;
        loginBtn.textContent = "ç™»å½•ä¸­...";
        showLoginStatus();

        try {
          const response1 = await api.post("/users/cellphone_captcha_verify", {
            cellphone: phone,
            captcha: code,
          });

          console.log("éªŒè¯ç éªŒè¯å“åº”:", response1);
          if (response1.verify) {
            const response2 = await api.post("/users/cellphoneLoginRegister", {
              cellphone: phone,
              captcha: code,
              channel: 60,
            });
            console.log("ç™»å½•å“åº”:", response2);

            // ä¿å­˜ç™»å½•ä¿¡æ¯
            if (response2 && response2.token) {
              await tokenManager.saveTokens(response2);

              // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
              await tokenManager.saveUserInfo({
                phone: phone,
                loginTime: new Date().toISOString(),
              });

              // ä¿å­˜Developer PanelçŠ¶æ€
              await tokenManager.saveDevPanelOptions(devOptions);

              // å°è¯•è·å–éº¦æ€Tokenï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰
              if (!(await tokenManager.getMaisiAccessToken())) {
                try {
                  const header = {
                    Authorization: `Bearer ${response2.token}`,
                  };
                  const response3 = await api.post(
                    "/oauth/getMaisiToken",
                    {
                      phone: phone,
                      from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                    },
                    header
                  );
                  console.log("è·å–éº¦æ€Tokenå“åº”:", response3);
                  await tokenManager.saveMaisiToken(response3.token);
                } catch (error) {
                  console.warn("è·å–éº¦æ€Tokenå¤±è´¥:", error);
                }
              }

              // ç™»å½•æˆåŠŸåè®°å½•éšç§æ”¿ç­–åŒæ„
              markPrivacyConsent();

              //  åˆ¤æ–­æµ·å¤–ç”¨æˆ·
              if ((response2.lastLoginEduOrgId && response2.lastLoginEduOrgId > 0) || response2.channel == 11) {
                // æµ·å¤–ç”¨æˆ·ï¼Œç›´æ¥è·³è½¬
                getParentLocationWithTimeout();
                return;
              }

              // æ‰‹æœºå·ç™»å½•é»˜è®¤å·²å®åï¼Œæ˜¾ç¤ºå®åè®¤è¯é€šçŸ¥
              checkRealnameNoticeStatus()
                .then((hasShown) => {
                  if (!hasShown) {
                    // æœªæ˜¾ç¤ºè¿‡å®åé€šçŸ¥ï¼Œæ˜¾ç¤ºä¸€æ¬¡å¹¶æ ‡è®°
                    markRealnameNoticeShown();
                    showRealnameNotice(phone);
                  } else {
                    // å·²æ˜¾ç¤ºè¿‡å®åé€šçŸ¥ï¼Œç›´æ¥è·³è½¬
                    getParentLocationWithTimeout();
                  }
                })
                .catch((error) => {
                  console.warn("æ£€æŸ¥å®åé€šçŸ¥çŠ¶æ€å¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºå®åé€šçŸ¥:", error);
                  // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºå®åé€šçŸ¥
                  showRealnameNotice(phone);
                });
            } else {
              throw new Error("ç™»å½•å¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆtoken");
            }
          } else {
            throw new Error("éªŒè¯ç éªŒè¯å¤±è´¥");
          }
        } catch (error) {
          console.error("ç™»å½•å¤±è´¥:", error);
          let errorMessage = "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";

          if (error.message) {
            errorMessage = error.message;
          }

          showMessage(errorMessage);
        } finally {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          hideAutoLoginStatus();
          loginBtn.disabled = false;
          loginBtn.textContent = "ç™»å½•/æ³¨å†Œ";
        }
      });

      // ç”¨æˆ·åå¯†ç ç™»å½•è¡¨å•æäº¤
      usernameLoginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        // éªŒè¯ç”¨æˆ·å
        if (!validateUsername(username)) {
          showError("usernameInput", "usernameError", "è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±");
          return;
        }

        // éªŒè¯å¯†ç 
        if (!validatePassword(password)) {
          showError("passwordInput", "passwordError", "å¯†ç è‡³å°‘6ä½");
          return;
        }

        // éªŒè¯æ˜¯å¦åŒæ„æ¡æ¬¾
        if (!agreementCheckbox2.checked) {
          showMessage("è¯·å‹¾é€‰åŒæ„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®");
          return;
        }

        // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•è¿›è¡Œç™»å½•
        const loginBtn = document.querySelector("#usernameLoginForm .login-btn");
        loginBtn.disabled = true;
        loginBtn.textContent = "ç™»å½•ä¸­...";
        showLoginStatus();

        try {
          let response2 = await api.post("/users/login", {
            username: username,
            password: password,
            platform: "WEB",
          });

          console.log("ç”¨æˆ·åå¯†ç ç™»å½•å“åº”:", response2);

          // ä¿å­˜ç™»å½•ä¿¡æ¯
          if (response2 && response2.token) {
            await tokenManager.saveTokens(response2);

            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            await tokenManager.saveUserInfo({
              username: response2.username,
              phone: response2.cellphone,
              realname: response2.realname,
              loginTime: new Date().toISOString(),
            });

            // ä¿å­˜Developer PanelçŠ¶æ€
            await tokenManager.saveDevPanelOptions(devOptions);

            // å°è¯•è·å–éº¦æ€Tokenï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰
            if (!(await tokenManager.getMaisiAccessToken()) && response2.cellphone) {
              try {
                const header = {
                  Authorization: `Bearer ${response2.token}`,
                };
                const response3 = await api.post(
                  "/oauth/getMaisiToken",
                  {
                    phone: response2.cellphone,
                    from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                  },
                  header
                );
                console.log("è·å–éº¦æ€Tokenå“åº”:", response3);
                await tokenManager.saveMaisiToken(response3.token);
              } catch (error) {
                console.warn("è·å–éº¦æ€Tokenå¤±è´¥:", error);
              }
            }

            // ç™»å½•æˆåŠŸåè®°å½•éšç§æ”¿ç­–åŒæ„
            markPrivacyConsent();

            //  åˆ¤æ–­æµ·å¤–ç”¨æˆ·
            if (!devOptions.isShowRealName && ((response2.lastLoginEduOrgId && response2.lastLoginEduOrgId > 0) || response2.channel == 11)) {
              // æµ·å¤–ç”¨æˆ·ï¼Œç›´æ¥è·³è½¬
              getParentLocationWithTimeout();
              return;
            }

            // æ£€æŸ¥å®åè®¤è¯çŠ¶æ€
            const isIdVerified = await checkIdentityVerification()
            
            if (devOptions.isShowRealName || (!(devOptions.isUseMaisiDevServer || devOptions.isShowDevContent) 
              && (!response2.realname || response2.realname.trim() === "") && !isIdVerified)) {
              // æœªå®åï¼Œæ˜¾ç¤ºèº«ä»½è®¤è¯å¼¹çª—
              showIdVerifyModal();
              // showRealnameModal();
            } else {
              // å·²å®åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè¿‡å®åé€šçŸ¥
              checkRealnameNoticeStatus()
                .then((hasShown) => {
                  if (!hasShown) {
                    // æœªæ˜¾ç¤ºè¿‡å®åé€šçŸ¥ï¼Œæ˜¾ç¤ºä¸€æ¬¡å¹¶æ ‡è®°
                    markRealnameNoticeShown();
                    showRealnameNotice(response2.realname);
                  } else {
                    // å·²æ˜¾ç¤ºè¿‡å®åé€šçŸ¥ï¼Œç›´æ¥è·³è½¬
                    getParentLocationWithTimeout();
                  }
                })
                .catch((error) => {
                  console.warn("æ£€æŸ¥å®åé€šçŸ¥çŠ¶æ€å¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºå®åé€šçŸ¥:", error);
                  // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºå®åé€šçŸ¥
                  showRealnameNotice(response2.realname);
                });
            }
          } else {
            throw new Error("ç™»å½•å¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆtoken");
          }
        } catch (error) {
          console.error("ç”¨æˆ·åå¯†ç ç™»å½•å¤±è´¥:", error);
          let errorMessage = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";

          if (error.message && error.message.includes("ç½‘ç»œ")) {
            errorMessage = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
          }
          hideAutoLoginStatus();
          showMessage(errorMessage);
        } finally {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          loginBtn.disabled = false;
          loginBtn.textContent = "ç™»å½•";
        }
      });

      // é˜»æ­¢é¡µé¢ç¼©æ”¾
      document.addEventListener(
        "touchstart",
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        },
        { passive: false }
      );

      // é˜»æ­¢åŒå‡»ç¼©æ”¾
      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (e) {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            e.preventDefault();
          }
          lastTouchEnd = now;
        },
        false
      );

      // Paracraftå¹³å°è·å–Promiseå­˜å‚¨
      let paracraftPlatformResolve = null;
      let paracraftPlatformReject = null;

      // è·å–Paracraftå¹³å°ä¿¡æ¯çš„å°è£…æ–¹æ³•
      async function getParacraftPlatform() {
        return new Promise((resolve, reject) => {
          paracraftPlatformResolve = resolve;
          paracraftPlatformReject = reject;

          // å‘é€è·å–å¹³å°ä¿¡æ¯çš„æ¶ˆæ¯
          window.parent.postMessage({ type: "getParacraftPlatform" }, "*");

          // è®¾ç½®è¶…æ—¶å¤„ç†
          setTimeout(() => {
            if (paracraftPlatformReject) {
              paracraftPlatformReject(new Error("è·å–Paracraftå¹³å°ä¿¡æ¯è¶…æ—¶"));
              paracraftPlatformResolve = null;
              paracraftPlatformReject = null;
            }
          }, 1000); // 1ç§’è¶…æ—¶
        });
      }

      // è·å–çˆ¶çª—å£Locationä¿¡æ¯çš„å°è£…æ–¹æ³•
      async function getParentLocation() {
        if(window.parent === window) {
          return {
            href: window.location.href,
            pathname: window.location.pathname,
            search: window.location.search,
          };
        }
        return new Promise((resolve, reject) => {
          getLocationResolve = resolve;
          getLocationReject = reject;

          // å‘é€è·å–Locationä¿¡æ¯çš„æ¶ˆæ¯
          getParentLocationWithTimeout(0);

          // è®¾ç½®è¶…æ—¶å¤„ç†
          setTimeout(() => {
            if (getLocationReject) {
              getLocationReject(new Error("è·å–çˆ¶çª—å£Locationä¿¡æ¯è¶…æ—¶"));
              getLocationResolve = null;
              getLocationReject = null;
            }
          }, 3000); // 3ç§’è¶…æ—¶
        });
      }

      function toggleMaisiDevServer(isEnabled) {
        devOptions.isUseMaisiDevServer = isEnabled;
        maisiApi.setBaseUrl(isEnabled ? "https://maseai-be-qa1.langcong.com/api/v1" : "https://be.maseai.com/api/v1");
        console.log("Maisi DevæœåŠ¡:", isEnabled ? "å·²å¯ç”¨" : "å·²ç¦ç”¨");

        // ä¿å­˜Developer PanelçŠ¶æ€åˆ°ç¼“å­˜
        tokenManager.saveDevPanelOptions(devOptions).catch((error) => {
          console.warn("ä¿å­˜Developer PanelçŠ¶æ€å¤±è´¥:", error);
        });
      }

      function toggleShowDevContent(isEnabled) {
        devOptions.isShowDevContent = isEnabled;
        console.log("æ˜¾ç¤ºDevå†…å®¹:", isEnabled ? "å·²å¯ç”¨" : "å·²ç¦ç”¨");

        // ä¿å­˜Developer PanelçŠ¶æ€åˆ°ç¼“å­˜
        tokenManager.saveDevPanelOptions(devOptions).catch((error) => {
          console.warn("ä¿å­˜Developer PanelçŠ¶æ€å¤±è´¥:", error);
        });
      }

      function toggleShowRealName(isEnabled) {
        devOptions.isShowRealName = isEnabled;
        console.log("æ˜¾ç¤ºå®åè®¤è¯:", isEnabled ? "å·²å¯ç”¨" : "å·²ç¦ç”¨");

        // ä¿å­˜Developer PanelçŠ¶æ€åˆ°ç¼“å­˜
        tokenManager.saveDevPanelOptions(devOptions).catch((error) => {
          console.warn("ä¿å­˜Developer PanelçŠ¶æ€å¤±è´¥:", error);
        });
      }

      window.addEventListener("message", async function (event) {
        switch (event.data.type) {
          case "locationResponse":
            // å¤„ç†getParentLocationçš„å“åº”
            if (getLocationResolve) {
              getLocationResolve({
                href: event.data.href,
                pathname: event.data.pathname,
                search: event.data.search,
              });
              getLocationResolve = null;
              getLocationReject = null;
            } else {
              // å…¼å®¹åŸæœ‰çš„å¯¼èˆªé€»è¾‘
              await navigateToMSGames(event.data.href);
            }
            break;
          case "paracraftPlatformResponse":
            if (paracraftPlatformResolve) {
              paracraftPlatformResolve(event.data.platform);
              paracraftPlatformResolve = null;
              paracraftPlatformReject = null;
            }
            break;
          case "registerSuccess":
            // æ³¨å†ŒæˆåŠŸï¼Œå…³é—­æ³¨å†Œå¼¹çª—å¹¶æ˜¾ç¤ºç™»å½•è¡¨å•
            closeRegisterModal();
            showLoginForm();
            if (event.data.username) {
              phoneInput.value = event.data.username;
            }
            switchToUsernameLogin();
            break;
          case "userProfileCreated":
            saveUserProfile({
              age: event.data.age,
              gender: event.data.gender,
              grade: event.data.grade,
            });
            break;
          case "identityVerified":
            // å¤„ç†èº«ä»½è®¤è¯æˆåŠŸ
            if (event.data.verified && event.data.realName && event.data.idCard) {
              closeIdVerifyModal();
              
              // ä¿å­˜å®åè®¤è¯ä¿¡æ¯
              await saveVerifiedIdentity(event.data.realName, event.data.idCard);
              
              showMessage("å®åè®¤è¯æˆåŠŸï¼");
              
              // è·³è½¬åˆ°ä¸»é¡µé¢
              setTimeout(() => {
                getParentLocationWithTimeout(500);
              }, 1000);
            }
            else {
              closeIdVerifyModal();
              hideAutoLoginStatus();
              showMessage("å®åè®¤è¯å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
            break;
        }
      });

      // =============== éšç§æ”¿ç­–è‡ªåŠ¨å±•ç¤ºé€»è¾‘ï¼ˆéœ€ç™»å½•ä¸”å‹¾é€‰åæ‰åœæ­¢å¼¹å‡ºï¼‰ ===============
      const PRIVACY_CONSENT_KEY = "maisi_privacy_consent_loggedin_v1";
      async function markPrivacyConsent() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            await window.parentLocalStorage.setItem(PRIVACY_CONSENT_KEY, "true");
          } else {
            localStorage.setItem(PRIVACY_CONSENT_KEY, "true");
          }
        } catch (e) {
          console.warn("è®°å½•éšç§åŒæ„çŠ¶æ€å¤±è´¥", e);
        }
      }

      async function hasPrivacyConsent() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            return (await window.parentLocalStorage.getItem(PRIVACY_CONSENT_KEY)) === "true";
          } else {
            return localStorage.getItem(PRIVACY_CONSENT_KEY) === "true";
          }
        } catch (e) {
          console.warn("è¯»å–éšç§åŒæ„çŠ¶æ€å¤±è´¥", e);
          return false;
        }
      }

      // å®åé€šçŸ¥çŠ¶æ€ç®¡ç†
      const REALNAME_NOTICE_KEY = "hasShownRealnameNotice";
      async function markRealnameNoticeShown() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            await window.parentLocalStorage.setItem(REALNAME_NOTICE_KEY, "true");
          } else {
            localStorage.setItem(REALNAME_NOTICE_KEY, "true");
          }
        } catch (e) {
          console.warn("è®°å½•å®åé€šçŸ¥çŠ¶æ€å¤±è´¥", e);
        }
      }

      async function checkRealnameNoticeStatus() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            return (await window.parentLocalStorage.getItem(REALNAME_NOTICE_KEY)) === "true";
          } else {
            return localStorage.getItem(REALNAME_NOTICE_KEY) === "true";
          }
        } catch (e) {
          console.warn("è¯»å–å®åé€šçŸ¥çŠ¶æ€å¤±è´¥", e);
          return false;
        }
      }

      async function maybeShowPrivacyPolicy() {
        if (await hasPrivacyConsent()) return;
        // æœªæœ‰åŒæ„è®°å½• -> è‡ªåŠ¨å¼¹å‡ºï¼Œä½†ä¸å†™å…¥åŒæ„æ ‡è®°ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½•æˆåŠŸåå†æ ‡è®°
        openPrivacyModal();
      }

      // åœ¨é¡µé¢è„šæœ¬å°¾éƒ¨è§¦å‘ï¼ˆcheckLoginStatus å·²åœ¨å‰é¢è°ƒç”¨ï¼Œä¼šåœ¨è‡ªåŠ¨ç™»å½•æ—¶å†™å…¥åŒæ„æ ‡è®°ï¼‰
      maybeShowPrivacyPolicy();
      // ==================================================================

      // =============== å®åè®¤è¯ç›¸å…³åŠŸèƒ½ ===============

      // æ£€æŸ¥å®åè®¤è¯çŠ¶æ€
      async function checkIdentityVerification() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          let verifiedData;
          
          if (isUsingProxy) {
            // Use personal page store for verified status
            verifiedData = await sdk.personalPageStore.loadPageData("maisi_userinfo", "identityVerified");
            if (verifiedData && verifiedData.verified) {
              console.log('ç”¨æˆ·å·²å®Œæˆå®åè®¤è¯:', verifiedData);
              return true;
            }
          } else {
            // Fallback to localStorage
            const storedData = localStorage.getItem('identityVerified');
            if (storedData) {
              const identityData = JSON.parse(storedData);
              if (identityData && identityData.verified) {
                console.log('ç”¨æˆ·å·²å®Œæˆå®åè®¤è¯:', identityData);
                return true;
              }
            }
          }
        } catch (error) {
          console.error('è¯»å–è®¤è¯çŠ¶æ€å¤±è´¥:', error);
        }
        return false;
      }

      async function saveVerifiedIdentity(realName, idCard) {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          const identityData = {
            verified: true,
            realName: realName,
            idCard: idCard,
            verifiedTime: new Date().toISOString(),
          };
          
          if (isUsingProxy) {
            // Save to personal page store
            await sdk.personalPageStore.savePageData("maisi_userinfo", "identityVerified", identityData, true);
          } else {
            // Fallback to localStorage
            localStorage.setItem('identityVerified', JSON.stringify(identityData));
          }
          
          console.log('ä¿å­˜å®åè®¤è¯ä¿¡æ¯æˆåŠŸ:', identityData);
        } catch (error) {
          console.error('ä¿å­˜å®åè®¤è¯ä¿¡æ¯å¤±è´¥:', error);
        }
      }

      // æ˜¾ç¤ºå®åè®¤è¯é€šçŸ¥å¼¹çª—ï¼ˆæ‰‹æœºå·ç™»å½•æ—¶ä½¿ç”¨ï¼‰
      function showRealnameNotice(phoneNumber = "") {
        const modal = document.getElementById("realnameNoticeModal");
        const textElement = document.getElementById("realnameNoticeText");

        if (phoneNumber) {
          // æ ¼å¼åŒ–æ‰‹æœºå·æ˜¾ç¤ºï¼ˆä¸­é—´4ä½ç”¨*å·æ›¿æ¢ï¼‰
          const maskedPhone = phoneNumber.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
          textElement.innerHTML = `æ‚¨å·²ä½¿ç”¨æ‰‹æœºå· ${maskedPhone} å®Œæˆè®¤è¯<br>å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½`;
        } else {
          textElement.innerHTML = "æ‚¨å·²å®Œæˆå®åè®¤è¯<br>å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½";
        }

        modal.style.display = "block";
      }

      // æ˜¾ç¤ºå®åè®¤è¯çª—å£ï¼ˆè´¦å·å¯†ç ç™»å½•æœªå®åæ—¶ä½¿ç”¨ï¼‰
      function showRealnameModal() {
        const modal = document.getElementById("realnameModal");
        modal.style.display = "block";
      }

      // å…³é—­å®åé€šçŸ¥å¼¹çª—å¹¶ç»§ç»­è·³è½¬
      function closeRealnameNoticeAndContinue() {
        closeModal("realnameNoticeModal");
        getParentLocationWithTimeout(500);
      }

      // å®åè®¤è¯è¡¨å•ç›¸å…³å…ƒç´ 
      const realnamePhoneInput = document.getElementById("realnamePhoneInput");
      const realnameCodeInput = document.getElementById("realnameCodeInput");
      const realnameVerifyBtn = document.getElementById("realnameVerifyBtn");
      const realnameForm = document.getElementById("realnameForm");

      // å®åè®¤è¯æ‰‹æœºå·è¾“å…¥äº‹ä»¶
      realnamePhoneInput.addEventListener("input", function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("realnamePhoneInput", "realnamePhoneError");
      });

      // å®åè®¤è¯éªŒè¯ç è¾“å…¥äº‹ä»¶
      realnameCodeInput.addEventListener("input", function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("realnameCodeInput", "realnameCodeError");
      });

      // å®åè®¤è¯è·å–éªŒè¯ç 
      realnameVerifyBtn.addEventListener("click", async function () {
        const phone = realnamePhoneInput.value.trim();

        if (!validatePhone(phone)) {
          showError("realnamePhoneInput", "realnamePhoneError", "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ");
          realnamePhoneInput.focus();
          return;
        }

        try {
          // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•å‘é€éªŒè¯ç 
          const response = await api.get("/users/cellphone_captcha", {
            cellphone: phone,
          });

          console.log("å®åè®¤è¯å‘é€éªŒè¯ç å“åº”:", response);

          // å¼€å§‹å€’è®¡æ—¶
          startCountdown(realnameVerifyBtn);
          showMessage("éªŒè¯ç å·²å‘é€ï¼Œè¯·æ³¨æ„æŸ¥æ”¶");
        } catch (error) {
          console.error("å®åè®¤è¯å‘é€éªŒè¯ç å¤±è´¥:", error);
          let errorMessage = "å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";

          if (error.message.includes("429")) {
            errorMessage = "å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•";
          } else if (error.message.includes("400")) {
            errorMessage = "æ‰‹æœºå·æ ¼å¼é”™è¯¯";
          }

          showMessage(errorMessage);
        }
      });

      // å®åè®¤è¯è¡¨å•æäº¤
      realnameForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = realnamePhoneInput.value.trim();
        const code = realnameCodeInput.value.trim();

        // éªŒè¯æ‰‹æœºå·
        if (!validatePhone(phone)) {
          showError("realnamePhoneInput", "realnamePhoneError", "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ");
          return;
        }

        // éªŒè¯éªŒè¯ç 
        if (!validateCode(code)) {
          showError("realnameCodeInput", "realnameCodeError", "è¯·è¾“å…¥4ä½æ•°å­—éªŒè¯ç ");
          return;
        }

        const submitBtn = realnameForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "è®¤è¯ä¸­...";

        try {
          let params_header = {};
          if (await tokenManager.isTokenValid()) {
            console.log("ç”¨æˆ·å·²ç™»å½•ï¼Œtokenæœ‰æ•ˆ");
            params_header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            };
          } else {
            console.log("ç”¨æˆ·æœªç™»å½•ï¼Œtokenæ— æ•ˆ");
            // æ— æ•ˆtokenè§†ä¸ºæœªç™»å½•ï¼Œéœ€è¦å…ˆç™»å½•
            showLoginModal();
            return;
          }
          // å…ˆéªŒè¯éªŒè¯ç 
          const response1 = await api.post(
            "/users/cellphone_captcha",
            {
              cellphone: phone,
              captcha: code,
              realname: true,
            },
            params_header
          );

          console.log("å®åè®¤è¯éªŒè¯ç éªŒè¯å“åº”:", response1);

          if (response1 && response1.data === true) {
            showMessage("å®åè®¤è¯æˆåŠŸï¼");

            // å…³é—­å®åè®¤è¯å¼¹çª—å¹¶è·³è½¬
            setTimeout(() => {
              closeModal("realnameModal");
              getParentLocationWithTimeout(500);
            }, 1000);
          } else {
            throw new Error("éªŒè¯ç éªŒè¯å¤±è´¥");
          }
        } catch (error) {
          console.error("å®åè®¤è¯å¤±è´¥:", error);
          let errorMessage = "å®åè®¤è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";

          if (error.message) {
            errorMessage = error.message;
          }

          showMessage(errorMessage);
        } finally {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          submitBtn.disabled = false;
          submitBtn.textContent = "å®Œæˆè®¤è¯";
        }
      });

      function showUserSetting() {
        const modal = document.getElementById("userSettingModal");
        const iframe = document.getElementById("user_setting_iframe");
        modal.classList.remove("show");
        modal.style.display = "block";
        if (iframe) {
          let url = window.location.href;
          url = url.replace("ms_games_login", "ms_games_create_profile");
          iframe.src = url;
        }
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            modal.classList.add("show");
          });
        });
      }

      function calculateAge(birthday) {
        if (!birthday) return null;
        const birthDate = new Date(birthday);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      }

      // è®¡ç®—ç”Ÿæ—¥
      function calculateBirthday(age) {
        if (!age) return null;
        const today = new Date();
        const year = today.getFullYear() - age;
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      async function saveUserProfile(userinfo) {
        if (!userinfo.age || !userinfo.gender || !userinfo.grade) {
          console.log("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
          return;
        }
        const birthday = calculateBirthday(userinfo.age);
        const gender = userinfo.gender === "male" ? 0 : 1;
        const age = userinfo.age;
        const keepworkUser = (await sdk.personalPageStore.loadPageData("maisi_userinfo", "user")) || {};
        keepworkUser.birthday = birthday;
        keepworkUser.gender = parseInt(gender);
        keepworkUser.age = age;
        sdk.personalPageStore.savePageData("maisi_userinfo", "user", keepworkUser, true);
        console.log("ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸ:", userinfo);
        if (window.parent !== window) {
          getParentLocationWithTimeout(500);
        } else {
          navigateToMSGames();
        }
      }
    </script>
  </body>
</html>
