<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>éº¦æ€æ˜Ÿçƒ - ç™»å½•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }      .login-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 50px 60px;
        width: 800px;
        height: 650px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      /* åˆ‡æ¢ç™»å½•æ–¹å¼æŒ‰é’® */
      .login-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }

      .switch-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        border-radius: 8px;
        background: transparent;
        color: #667eea;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .switch-btn.active {
        background: #667eea;
        color: white;
      }

      .switch-btn:hover {
        background: #667eea;
        color: white;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
      }

      .icon {
        width: 160px;
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 20px;
      }

      .form-group {
        width: 100%;
        margin-bottom: 30px;
      }

      .input-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-field {
        width: 100%;
        padding: 20px 25px;
        border: 3px solid #e1e8ed;
        border-radius: 16px;
        font-size: 25px;
        background: white;
        transition: all 0.3s ease;
        outline: none;
      }

      .input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-field::placeholder {
        color: #94a3b8;
      }

      .verify-input {
        flex: 1;
        margin-right: 20px;
      }

      .verify-btn {
        padding: 20px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }

      .verify-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .verify-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .login-btn {
        width: 100%;
        padding: 24px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
      }

      .login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .tips {
        margin-top: 25px;
        font-size: 20px;
        color: #64748b;
        text-align: center;
        line-height: 1.5;
      }

      /* é”™è¯¯æç¤ºæ ·å¼ */
      .error-message {
        color: #ef4444;
        font-size: 20px;
        margin-top: 12px;
        display: none;
      }

      .input-field.error {
        border-color: #ef4444;
      }

      /* æ¶ˆæ¯æç¤º */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 24px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }

      /* åŒæ„æ¡æ¬¾æ ·å¼ */
      .agreement-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        font-size: 24px;
        color: #64748b;
        line-height: 1.5;
      }

      .agreement-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .agreement-text {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }

      .agreement-link {
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .agreement-link:hover {
        color: #5b6ee8;
      }

      /* å¼¹çª—æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
      }

      .close {
        color: #94a3b8;
        float: right;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #667eea;
      }

      .modal-body {
        font-size: 16px;
        line-height: 1.6;
        color: #333;
      }

      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        margin-top: 25px;
        margin-bottom: 15px;
        color: #667eea;
      }

      .modal-body h1 {
        font-size: 24px;
      }

      .modal-body h2 {
        font-size: 20px;
      }

      .modal-body h3 {
        font-size: 18px;
      }

      .modal-body p {
        margin-bottom: 12px;
      }

      .modal-body ul,
      .modal-body ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      .modal-body li {
        margin-bottom: 8px;
      }

      .modal-body strong {
        color: #333;
        font-weight: 600;
      }

      .modal-body code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
      }

      /* åŠ è½½çŠ¶æ€ */
      .modal-loading {
        text-align: center;
        padding: 40px;
        color: #94a3b8;
        font-size: 18px;
      }
    </style>

  </head>

  <body>    <div class="login-container">
      <!-- åˆ‡æ¢ç™»å½•æ–¹å¼æŒ‰é’® -->
      <div class="login-switch">
        <button type="button" class="switch-btn active" id="phoneLoginBtn" onclick="switchToPhoneLogin()">ğŸ“±æ‰‹æœºå·ç™»å½•</button>
        <button type="button" class="switch-btn" id="usernameLoginBtn" onclick="switchToUsernameLogin()">ğŸ”‘è´¦å·å¯†ç ç™»å½•</button>
      </div>

      <div class="header">
        <div class="icon">
          <img
            src="https://cdn.keepwork.com/update61/assetdownload/update/texture/aries/creator/keepwork/minigame/logo.png.p,ba44b8275f4bdb7e6dacebc939b2ac13,33659"
            alt="éº¦æ€æ˜Ÿçƒ"
          />
        </div>
      </div>      <!-- æ‰‹æœºå·ç™»å½•è¡¨å• -->
      <form class="login-form" id="phoneLoginForm">
        <div class="form-group">
          <div class="input-container">
            <input type="tel" class="input-field" id="phoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " maxlength="11" />
          </div>
          <div class="error-message" id="phoneError">è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç </div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input
              type="text"
              class="input-field verify-input"
              id="codeInput"
              placeholder="è¯·è¾“å…¥éªŒè¯ç "
              maxlength="4"
            />
            <button type="button" class="verify-btn" id="verifyBtn">è·å–éªŒè¯ç </button>
          </div>
          <div class="error-message" id="codeError">è¯·è¾“å…¥æ­£ç¡®çš„éªŒè¯ç </div>
        </div>

        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox" />
          <div class="agreement-text">
            <span>ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„</span>
            <span class="agreement-link" onclick="openPrivacyModal()">éšç§æ”¿ç­–</span>
            <span>å’Œ</span>
            <span class="agreement-link" onclick="openLicenseModal()">ç”¨æˆ·åè®®</span>
          </div>
        </div>

        <button type="submit" class="login-btn" id="phoneLoginBtn">ç™»å½•/æ³¨å†Œ</button>
      </form>

      <!-- ç”¨æˆ·åå¯†ç ç™»å½•è¡¨å• -->
      <form class="login-form" id="usernameLoginForm" style="display: none;">
        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±" />
          </div>
          <div class="error-message" id="usernameError">è¯·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·å</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="password" class="input-field" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " />
          </div>
          <div class="error-message" id="passwordError">è¯·è¾“å…¥å¯†ç </div>
        </div>

        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox2" />
          <div class="agreement-text">
            <span>ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„</span>
            <span class="agreement-link" onclick="openPrivacyModal()">éšç§æ”¿ç­–</span>
            <span>å’Œ</span>
            <span class="agreement-link" onclick="openLicenseModal()">ç”¨æˆ·åè®®</span>
          </div>
        </div>

        <button type="submit" class="login-btn" id="usernameLoginSubmitBtn">ç™»å½•</button>
      </form>

      <div class="tips" style="display: none">ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®</div>
    </div>

    <!-- éšç§æ”¿ç­–å¼¹çª— -->
    <div id="privacyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">éšç§æ”¿ç­–</div>
          <span class="close" onclick="closeModal('privacyModal')">&times;</span>
        </div>
        <div class="modal-body" id="privacyContent">
          <div class="modal-loading">æ­£åœ¨åŠ è½½éšç§æ”¿ç­–...</div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·åè®®å¼¹çª— -->
    <div id="licenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">ç”¨æˆ·åè®®</div>
          <span class="close" onclick="closeModal('licenseModal')">&times;</span>
        </div>
        <div class="modal-body" id="licenseContent">
          <div class="modal-loading">æ­£åœ¨åŠ è½½ç”¨æˆ·åè®®...</div>
        </div>
      </div>
    </div>

    <script>
      // ä¿®æ”¹APIå®¢æˆ·ç«¯ï¼Œè‡ªåŠ¨æ·»åŠ Authorizationå¤´
      class ApiClient {
        constructor(baseUrl = '') {
          this.baseUrl = baseUrl
          this.defaultHeaders = {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          }
        }

        // é€šç”¨è¯·æ±‚æ–¹æ³•
        async request(url, options = {}) {
          try {
            const config = {
              ...options,
              headers: {
                ...this.defaultHeaders,
                ...options.headers,
              },
            }

            const response = await fetch(this.baseUrl + url, config)

            if (!response.ok) {
              const error = await response.json().catch(() => ({}))
              console.error('Response error:', response.status, error)
              throw error
            }

            const contentType = response.headers.get('content-type')
            if (contentType && contentType.includes('application/json')) {
              return await response.json()
            }

            return await response.text()
          } catch (error) {
            throw error
          }
        }

        // GET è¯·æ±‚
        async get(url, params = {}, headers = {}) {
          const queryString = new URLSearchParams(params).toString()
          const fullUrl = queryString ? `${url}?${queryString}` : url

          return this.request(fullUrl, {
            method: 'GET',
            headers,
          })
        }

        // POST è¯·æ±‚
        async post(url, data = {}, headers = {}) {
          return this.request(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...headers,
            },
            body: JSON.stringify(data),
          })
        }

        // è®¾ç½®é»˜è®¤å¤´éƒ¨
        setDefaultHeader(key, value) {
          this.defaultHeaders[key] = value
        }

        // è®¾ç½®åŸºç¡€URL
        setBaseUrl(url) {
          this.baseUrl = url
        }
      }

      // åˆ›å»ºAPIå®¢æˆ·ç«¯å®ä¾‹
      const api = new ApiClient('https://api.keepwork.com/core/v0')

      class LocalStorageProxy {
        constructor() {
          this.requestId = 0
          this.pendingRequests = new Map()

          // ç›‘å¬çˆ¶é¡µé¢çš„å“åº”
          window.addEventListener('message', (event) => {
            if (event.data.type === 'localStorageResponse') {
              const { requestId, success, data, error } = event.data
              const request = this.pendingRequests.get(requestId)

              if (request) {
                this.pendingRequests.delete(requestId)
                if (success) {
                  request.resolve(data)
                } else {
                  request.reject(new Error(error))
                }
              }
            }
          })
        }

        _sendRequest(action, key, value) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId

            this.pendingRequests.set(requestId, { resolve, reject })

            // è®¾ç½®è¶…æ—¶
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId)
                reject(new Error('LocalStorage operation timeout'))
              }
            }, 5000)

            // å‘é€è¯·æ±‚åˆ°çˆ¶é¡µé¢
            window.parent.postMessage(
              {
                type: 'localStorage',
                action,
                key,
                value,
                requestId,
              },
              '*'
            )
          })
        }

        // æ ‡å‡†localStorage API
        async getItem(key) {
          return await this._sendRequest('getItem', key)
        }

        async setItem(key, value) {
          return await this._sendRequest('setItem', key, value)
        }

        async removeItem(key) {
          return await this._sendRequest('removeItem', key)
        }

        async clear() {
          return await this._sendRequest('clear')
        }

        async key(index) {
          return await this._sendRequest('key', null, index)
        }

        async length() {
          return await this._sendRequest('length')
        }

        async keys() {
          return await this._sendRequest('keys')
        }

        // æ‰©å±•API - ä½¿ç”¨çˆ¶é¡µé¢çš„å·¥å…·æ–¹æ³•
        async getStorageData(key, defaultValue = {}) {
          return await this._sendRequest('getStorageData', key, defaultValue)
        }

        async setStorageData(key, data) {
          return await this._sendRequest('setStorageData', key, data)
        }
      }

      // åˆ›å»ºå…¨å±€å®ä¾‹
      window.parentLocalStorage = new LocalStorageProxy()

      // Tokenç®¡ç†å™¨
      class TokenManager {
        constructor() {
          this.TOKEN_KEY = 'keepwork_access_token'
          this.EXPIRES_KEY = 'keepwork_token_expires'
          this.MAISI_TOKEN_KEY = 'mais_games_access_token'
          this.MAISI_EXPIRES_KEY = 'mais_games_token_expires'
          this.USER_INFO_KEY = 'keepwork_user_info'

          // ç¡®ä¿parentLocalStorageå­˜åœ¨
          this.storage = window.parentLocalStorage || localStorage
        }

        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä»£ç†å­˜å‚¨
        get isUsingProxy() {
          return window.parentLocalStorage !== undefined
        }

        // ä¿å­˜tokenä¿¡æ¯
        async saveTokens(data) {
          const now = Date.now()
          const expiresAt = now + data.tokenExpire * 1000 // è½¬æ¢ä¸ºæ¯«ç§’

          if (this.isUsingProxy) {
            await this.storage.setItem(this.TOKEN_KEY, data.token)
            await this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString())
          } else {
            this.storage.setItem(this.TOKEN_KEY, data.token)
            this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString())
          }

          console.log('Keepwork Tokenå·²ä¿å­˜ï¼Œè¿‡æœŸæ—¶é—´:', new Date(expiresAt))
        }

        async saveMaisiToken(data) {
          const now = Date.now()
          const expiresAt = now + data.expiresIn * 1000 // è½¬æ¢ä¸ºæ¯«ç§’

          if (this.isUsingProxy) {
            await this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken)
            await this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString())
          } else {
            this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken)
            this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString())
          }

          console.log('éº¦æ€Tokenå·²ä¿å­˜ï¼Œè¿‡æœŸæ—¶é—´:', new Date(expiresAt))
        }

        // è·å–è®¿é—®ä»¤ç‰Œ
        async getAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.TOKEN_KEY)
          } else {
            return this.storage.getItem(this.TOKEN_KEY)
          }
        }

        async getMaisiAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.MAISI_TOKEN_KEY)
          } else {
            return this.storage.getItem(this.MAISI_TOKEN_KEY)
          }
        }

        // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
        async isTokenValid() {
          let token, expiresAt

          if (this.isUsingProxy) {
            token = await this.getAccessToken()
            expiresAt = await this.storage.getItem(this.EXPIRES_KEY)
          } else {
            token = this.getAccessToken()
            expiresAt = this.storage.getItem(this.EXPIRES_KEY)
          }

          if (!token || !expiresAt) {
            return false
          }

          const now = Date.now()
          const expires = parseInt(expiresAt)

          // æå‰5åˆ†é’Ÿåˆ¤æ–­è¿‡æœŸï¼ˆå®‰å…¨è¾¹é™…ï¼‰
          return now < expires - 5 * 60 * 1000
        }

        async isMaisiTokenValid() {
          let token, expiresAt

          if (this.isUsingProxy) {
            token = await this.getMaisiAccessToken()
            expiresAt = await this.storage.getItem(this.MAISI_EXPIRES_KEY)
          } else {
            token = this.getMaisiAccessToken()
            expiresAt = this.storage.getItem(this.MAISI_EXPIRES_KEY)
          }

          if (!token || !expiresAt) {
            return false
          }

          const now = Date.now()
          const expires = parseInt(expiresAt)

          // æå‰5åˆ†é’Ÿåˆ¤æ–­è¿‡æœŸï¼ˆå®‰å…¨è¾¹é™…ï¼‰
          return now < expires - 5 * 60 * 1000
        }

        // æ¸…é™¤æ‰€æœ‰tokenä¿¡æ¯
        async clearTokens() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.TOKEN_KEY)
            await this.storage.removeItem(this.EXPIRES_KEY)
            await this.storage.removeItem(this.MAISI_TOKEN_KEY)
            await this.storage.removeItem(this.MAISI_EXPIRES_KEY)
            await this.storage.removeItem(this.USER_INFO_KEY)
          } else {
            this.storage.removeItem(this.TOKEN_KEY)
            this.storage.removeItem(this.EXPIRES_KEY)
            this.storage.removeItem(this.MAISI_TOKEN_KEY)
            this.storage.removeItem(this.MAISI_EXPIRES_KEY)
            this.storage.removeItem(this.USER_INFO_KEY)
          }
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        async saveUserInfo(userInfo) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo))
          } else {
            this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo))
          }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async getUserInfo() {
          let userInfo

          if (this.isUsingProxy) {
            userInfo = await this.storage.getItem(this.USER_INFO_KEY)
          } else {
            userInfo = this.storage.getItem(this.USER_INFO_KEY)
          }

          return userInfo ? JSON.parse(userInfo) : null
        }
      }

      // åˆ›å»ºtokenç®¡ç†å™¨å®ä¾‹
      const tokenManager = new TokenManager()

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
      checkLoginStatus()

      // Markdownè½¬HTMLçš„ç®€å•å®ç°
      function markdownToHtml(markdown) {
        if (!markdown) return ''

        let html = markdown
          // æ ‡é¢˜è½¬æ¢
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          // ç²—ä½“
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.*?)__/g, '<strong>$1</strong>')
          // æ–œä½“
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/_(.*?)_/g, '<em>$1</em>')
          // ä»£ç 
          .replace(/`(.*?)`/g, '<code>$1</code>')
          // é“¾æ¥
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          // åˆ—è¡¨
          .replace(/^[\s]*\*[\s]+(.*$)/gim, '<li>$1</li>')
          .replace(/^[\s]*\d+\.[\s]+(.*$)/gim, '<li>$1</li>')
          // æ®µè½
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>')

        // åŒ…è£…åˆ—è¡¨é¡¹
        html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')

        // åŒ…è£…æ®µè½
        if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<ol')) {
          html = '<p>' + html + '</p>'
        }

        return html
      }

      // æ‰“å¼€éšç§æ”¿ç­–å¼¹çª—
      async function openPrivacyModal() {
        const modal = document.getElementById('privacyModal')
        const content = document.getElementById('privacyContent')

        modal.style.display = 'block'
        content.innerHTML = '<div class="modal-loading">æ­£åœ¨åŠ è½½éšç§æ”¿ç­–...</div>'

        try {
          const response = await fetch('https://cross.keepwork.com/api/raw/maisi/maisi/docs/privacy')
          const markdown = await response.text()
          const html = markdownToHtml(markdown)
          content.innerHTML = html
        } catch (error) {
          console.error('åŠ è½½éšç§æ”¿ç­–å¤±è´¥:', error)
          content.innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>'
        }
      }

      // æ‰“å¼€ç”¨æˆ·åè®®å¼¹çª—
      async function openLicenseModal() {
        const modal = document.getElementById('licenseModal')
        const content = document.getElementById('licenseContent')

        modal.style.display = 'block'
        content.innerHTML = '<div class="modal-loading">æ­£åœ¨åŠ è½½ç”¨æˆ·åè®®...</div>'

        try {
          const response = await fetch('https://cross.keepwork.com/api/raw/maisi/maisi/docs/license')
          const markdown = await response.text()
          const html = markdownToHtml(markdown)
          content.innerHTML = html
        } catch (error) {
          console.error('åŠ è½½ç”¨æˆ·åè®®å¤±è´¥:', error)
          content.innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>'
        }
      }

      // å…³é—­å¼¹çª—
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none'
      }

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      window.addEventListener('click', function (event) {
        const privacyModal = document.getElementById('privacyModal')
        const licenseModal = document.getElementById('licenseModal')

        if (event.target === privacyModal) {
          privacyModal.style.display = 'none'
        }
        if (event.target === licenseModal) {
          licenseModal.style.display = 'none'
        }
      })

      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      async function checkLoginStatus() {
        if (await tokenManager.isTokenValid()) {
          console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œtokenæœ‰æ•ˆ')
          if (!(await tokenManager.isMaisiTokenValid())) {
            console.log('Maisi tokenå·²è¿‡æœŸï¼Œé‡æ–°è·å–')
            const header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            }
            try {
              const userInfo = await tokenManager.getUserInfo()
              const response = await api.post(
                '/oauth/getMaisiToken',
                {
                  phone: userInfo?.phone || '',
                },
                header
              )
              await tokenManager.saveMaisiToken(response.token)
              console.log('Maisi tokenå·²æ›´æ–°')
            } catch (error) {
              console.error('è·å–Maisi tokenå¤±è´¥:', error)
            }
          }
          window.parent.postMessage({ type: 'getLocation' }, '*')
          return
        } else {
          console.log('ç”¨æˆ·æœªç™»å½•æˆ–tokenå·²è¿‡æœŸ')
          await tokenManager.clearTokens()
          showLoginForm()
        }
      }

      async function navigateToMSGames(href) {
        const url = new URL(href)
        url.searchParams.set('gameName', 'ms_games')

        const userInfo = await tokenManager.getUserInfo()
        const phone = userInfo?.phone || ''
        const token = (await tokenManager.getMaisiAccessToken()) || ''

        url.searchParams.set('phone', phone)
        url.searchParams.set('thirdpartytoken', token)

        // console.log('è·³è½¬åˆ°MSæ¸¸æˆé¡µé¢:', url.toString());
        window.parent.postMessage(
          {
            type: 'navigate',
            url: url.toString(),
          },
          '*'
        )
      }

      // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
      async function showLoggedInState() {
        const userInfo = await tokenManager.getUserInfo()
        const phone = userInfo ? userInfo.phone : 'ç”¨æˆ·'

        // éšè—ç™»å½•è¡¨å•ï¼Œæ˜¾ç¤ºå·²ç™»å½•ä¿¡æ¯
        document.querySelector('.login-form').style.display = 'none'
        document.querySelector('.tips').innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 24px; color: #667eea; margin-bottom: 20px;">
                        æ¬¢è¿å›æ¥ï¼${phone}
                    </p>
                    <button onclick="logout()" style="
                        padding: 12px 24px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                    ">é€€å‡ºç™»å½•</button>
                    <button onclick="goToMain()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: 15px;
                    ">è¿›å…¥ä¸»é¡µ</button>
                </div>
            `
      }

      // æ˜¾ç¤ºç™»å½•è¡¨å•
      function showLoginForm() {
        document.querySelector('.login-form').style.display = 'block'
        document.querySelector('.tips').style.display = 'none'
      }

      // é€€å‡ºç™»å½•
      async function logout() {
        await tokenManager.clearTokens()
        showLoginForm()
        showMessage('å·²é€€å‡ºç™»å½•')
      }

      // è·³è½¬åˆ°ä¸»é¡µ
      function goToMain() {
        // è¿™é‡Œæ·»åŠ è·³è½¬åˆ°ä¸»é¡µçš„é€»è¾‘
        window.parent.postMessage({ type: 'getLocation' }, '*')
      }

      // æ‰‹æœºå·éªŒè¯
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone)
      }

      // éªŒè¯ç éªŒè¯
      function validateCode(code) {
        return /^\d{4}$/.test(code)
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId)
        const error = document.getElementById(errorId)
        input.classList.add('error')
        error.textContent = message
        error.style.display = 'block'
      }

      // éšè—é”™è¯¯ä¿¡æ¯
      function hideError(inputId, errorId) {
        const input = document.getElementById(inputId)
        const error = document.getElementById(errorId)
        input.classList.remove('error')
        error.style.display = 'none'
      }

      // å€’è®¡æ—¶åŠŸèƒ½
      function startCountdown(btn, seconds = 60) {
        btn.disabled = true
        let remaining = seconds

        const timer = setInterval(() => {
          btn.textContent = `${remaining}såé‡è¯•`
          remaining--

          if (remaining < 0) {
            clearInterval(timer)
            btn.disabled = false
            btn.textContent = 'è·å–éªŒè¯ç '
          }
        }, 1000)
      }

      // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
      function showMessage(message) {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æç¤ºå…ƒç´ 
        let existingToast = document.querySelector('.toast')

        if (existingToast) {
          // æ›´æ–°ç°æœ‰å…ƒç´ çš„æ–‡æœ¬å†…å®¹
          existingToast.textContent = message

          // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          if (existingToast.hideTimer) {
            clearTimeout(existingToast.hideTimer)
          }

          // é‡æ–°è®¾ç½®å®šæ—¶å™¨
          existingToast.hideTimer = setTimeout(() => {
            if (existingToast && existingToast.parentNode) {
              document.body.removeChild(existingToast)
            }
          }, 2000)
        } else {
          // åˆ›å»ºæ–°çš„æç¤ºå…ƒç´ 
          const toast = document.createElement('div')
          toast.className = 'toast'
          toast.textContent = message

          document.body.appendChild(toast)

          // è®¾ç½®å®šæ—¶å™¨å¹¶ä¿å­˜å¼•ç”¨
          toast.hideTimer = setTimeout(() => {
            if (toast && toast.parentNode) {
              document.body.removeChild(toast)
            }
          }, 2000)
        }
      }      // åˆ‡æ¢åˆ°æ‰‹æœºå·ç™»å½•
      function switchToPhoneLogin() {
        const phoneForm = document.getElementById('phoneLoginForm')
        const usernameForm = document.getElementById('usernameLoginForm')
        const phoneBtn = document.getElementById('phoneLoginBtn')
        const usernameBtn = document.getElementById('usernameLoginBtn')

        phoneForm.style.display = 'block'
        usernameForm.style.display = 'none'
        phoneBtn.classList.add('active')
        usernameBtn.classList.remove('active')
      }

      // åˆ‡æ¢åˆ°ç”¨æˆ·åå¯†ç ç™»å½•
      function switchToUsernameLogin() {
        const phoneForm = document.getElementById('phoneLoginForm')
        const usernameForm = document.getElementById('usernameLoginForm')
        const phoneBtn = document.getElementById('phoneLoginBtn')
        const usernameBtn = document.getElementById('usernameLoginBtn')

        phoneForm.style.display = 'none'
        usernameForm.style.display = 'block'
        phoneBtn.classList.remove('active')
        usernameBtn.classList.add('active')
      }

      // éªŒè¯ç”¨æˆ·å
      function validateUsername(username) {
        return username && username.trim().length > 0
      }

      // éªŒè¯å¯†ç 
      function validatePassword(password) {
        return password && password.trim().length >= 6
      }

      // DOM å…ƒç´ 
      const phoneInput = document.getElementById('phoneInput')
      const codeInput = document.getElementById('codeInput')
      const verifyBtn = document.getElementById('verifyBtn')
      const phoneLoginForm = document.getElementById('phoneLoginForm')
      const usernameLoginForm = document.getElementById('usernameLoginForm')
      const agreementCheckbox = document.getElementById('agreementCheckbox')
      const agreementCheckbox2 = document.getElementById('agreementCheckbox2')
      const usernameInput = document.getElementById('usernameInput')
      const passwordInput = document.getElementById('passwordInput')

      // æ‰‹æœºå·è¾“å…¥äº‹ä»¶
      phoneInput.addEventListener('input', function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, '')
        hideError('phoneInput', 'phoneError')
      })

      // éªŒè¯ç è¾“å…¥äº‹ä»¶
      codeInput.addEventListener('input', function (e) {
        // åªå…è®¸è¾“å…¥æ•°å­—
        e.target.value = e.target.value.replace(/\D/g, '')
        hideError('codeInput', 'codeError')
      })

      // è·å–éªŒè¯ç 
      verifyBtn.addEventListener('click', async function () {
        const phone = phoneInput.value.trim()

        if (!validatePhone(phone)) {
          showError('phoneInput', 'phoneError', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ')
          phoneInput.focus()
          return
        }

        try {
          // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•å‘é€éªŒè¯ç 
          const response = await api.get('/users/cellphone_captcha', {
            cellphone: phone,
          })

          console.log('å‘é€éªŒè¯ç å“åº”:', response)

          // å¼€å§‹å€’è®¡æ—¶
          startCountdown(verifyBtn)
          showMessage('éªŒè¯ç å·²å‘é€ï¼Œè¯·æ³¨æ„æŸ¥æ”¶')
        } catch (error) {
          console.error('å‘é€éªŒè¯ç å¤±è´¥:', error)
          let errorMessage = 'å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'

          if (error.message.includes('429')) {
            errorMessage = 'å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
          } else if (error.message.includes('400')) {
            errorMessage = 'æ‰‹æœºå·æ ¼å¼é”™è¯¯'
          }

          showMessage(errorMessage)
        }
      })      // è¡¨å•æäº¤
      phoneLoginForm.addEventListener('submit', async function (e) {
        e.preventDefault()

        const phone = phoneInput.value.trim()
        const code = codeInput.value.trim()

        // éªŒè¯æ‰‹æœºå·
        if (!validatePhone(phone)) {
          showError('phoneInput', 'phoneError', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ')
          return
        }

        // éªŒè¯éªŒè¯ç 
        if (!validateCode(code)) {
          showError('codeInput', 'codeError', 'è¯·è¾“å…¥4ä½æ•°å­—éªŒè¯ç ')
          return
        }

        // éªŒè¯æ˜¯å¦åŒæ„æ¡æ¬¾
        if (!agreementCheckbox.checked) {
          showMessage('è¯·å‹¾é€‰åŒæ„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®')
          return
        }

        // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•è¿›è¡Œç™»å½•
        const loginBtn = document.querySelector('#phoneLoginForm .login-btn')
        loginBtn.disabled = true
        loginBtn.textContent = 'ç™»å½•ä¸­...'

        try {
          const response1 = await api.post('/users/cellphone_captcha_verify', {
            cellphone: phone,
            captcha: code,
          })

          console.log('éªŒè¯ç éªŒè¯å“åº”:', response1)
          if (response1.verify) {
            const response2 = await api.post('/users/cellphoneLoginRegister', {
              cellphone: phone,
              captcha: code,
              channel: 60,
            })
            console.log('ç™»å½•å“åº”:', response2)

            // ä¿å­˜ç™»å½•ä¿¡æ¯
            if (response2 && response2.token) {
              await tokenManager.saveTokens(response2)

              // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
              await tokenManager.saveUserInfo({
                phone: phone,
                loginTime: new Date().toISOString(),
              })

              // å°è¯•è·å–éº¦æ€Tokenï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰
              if (!(await tokenManager.getMaisiAccessToken())) {
                try {
                  const header = {
                    Authorization: `Bearer ${response2.token}`,
                  }
                  const response3 = await api.post(
                    '/oauth/getMaisiToken',
                    {
                      phone,
                    },
                    header
                  )
                  console.log('è·å–éº¦æ€Tokenå“åº”:', response3)
                  await tokenManager.saveMaisiToken(response3.token)
                } catch (error) {
                  console.warn('è·å–éº¦æ€Tokenå¤±è´¥:', error)
                }
              }

              // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
              setTimeout(() => {
                window.parent.postMessage({ type: 'getLocation' }, '*')
              }, 1000)
            } else {
              throw new Error('ç™»å½•å¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆtoken')
            }
          } else {
            throw new Error('éªŒè¯ç éªŒè¯å¤±è´¥')
          }
        } catch (error) {
          console.error('ç™»å½•å¤±è´¥:', error)
          let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'

          if (error.message) {
            errorMessage = error.message
          }

          showMessage(errorMessage)
        } finally {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          loginBtn.disabled = false
          loginBtn.textContent = 'ç™»å½•/æ³¨å†Œ'
        }
      })

      // ç”¨æˆ·åå¯†ç ç™»å½•è¡¨å•æäº¤
      usernameLoginForm.addEventListener('submit', async function (e) {
        e.preventDefault()

        const username = usernameInput.value.trim()
        const password = passwordInput.value.trim()

        // éªŒè¯ç”¨æˆ·å
        if (!validateUsername(username)) {
          showError('usernameInput', 'usernameError', 'è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±')
          return
        }

        // éªŒè¯å¯†ç 
        if (!validatePassword(password)) {
          showError('passwordInput', 'passwordError', 'å¯†ç è‡³å°‘6ä½')
          return
        }

        // éªŒè¯æ˜¯å¦åŒæ„æ¡æ¬¾
        if (!agreementCheckbox2.checked) {
          showMessage('è¯·å‹¾é€‰åŒæ„éšç§æ”¿ç­–å’Œç”¨æˆ·åè®®')
          return
        }

        // ä½¿ç”¨å°è£…çš„APIæ–¹æ³•è¿›è¡Œç™»å½•
        const loginBtn = document.querySelector('#usernameLoginForm .login-btn')
        loginBtn.disabled = true
        loginBtn.textContent = 'ç™»å½•ä¸­...'

        try {
          let response2 = await api.post('/users/login', {
              username: username,
              password: password,
              platform: 'WEB',
            })
          
          console.log('ç”¨æˆ·åå¯†ç ç™»å½•å“åº”:', response2)

          // ä¿å­˜ç™»å½•ä¿¡æ¯
          if (response2 && response2.token) {
            await tokenManager.saveTokens(response2)

            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            await tokenManager.saveUserInfo({
              username: response2.username,
              phone: response2.cellphone,
              loginTime: new Date().toISOString(),
            })

            // å°è¯•è·å–éº¦æ€Tokenï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰
            if (!(await tokenManager.getMaisiAccessToken()) && response2.cellphone) {
              try {
                const header = {
                  Authorization: `Bearer ${response2.token}`,
                }
                const response3 = await api.post(
                  '/oauth/getMaisiToken',
                  {
                    phone: response2.cellphone, 
                  },
                  header
                )
                console.log('è·å–éº¦æ€Tokenå“åº”:', response3)
                await tokenManager.saveMaisiToken(response3.token)
              } catch (error) {
                console.warn('è·å–éº¦æ€Tokenå¤±è´¥:', error)
              }
            }

            // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
            setTimeout(() => {
              window.parent.postMessage({ type: 'getLocation' }, '*')
            }, 1000)
          } else {
            throw new Error('ç™»å½•å¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆtoken')
          }
        } catch (error) {
          console.error('ç”¨æˆ·åå¯†ç ç™»å½•å¤±è´¥:', error)
          let errorMessage = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'

          if (error.message && error.message.includes('ç½‘ç»œ')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
          }

          showMessage(errorMessage)
        } finally {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          loginBtn.disabled = false
          loginBtn.textContent = 'ç™»å½•'
        }
      })

      // é˜»æ­¢é¡µé¢ç¼©æ”¾
      document.addEventListener(
        'touchstart',
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault()
          }
        },
        { passive: false }
      )

      // é˜»æ­¢åŒå‡»ç¼©æ”¾
      let lastTouchEnd = 0
      document.addEventListener(
        'touchend',
        function (e) {
          const now = new Date().getTime()
          if (now - lastTouchEnd <= 300) {
            e.preventDefault()
          }
          lastTouchEnd = now
        },
        false
      )

      window.addEventListener('message', async function (event) {
        switch (event.data.type) {
          case 'locationResponse':
            await navigateToMSGames(event.data.href)
            break
          // case 'setGameConfig':
          //     try {
          //         const script = document.createElement('script');
          //         script.textContent = event.data.injectedScript;
          //         document.head.appendChild(script);
          //         console.log('Script injected successfully');
          //     } catch (error) {
          //         console.error('Failed to execute injected script:', error);
          //     }
          //     break;
        }
      })
    </script>

  </body>
</html>

