<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>麦思星球 - 登录</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }      .login-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 50px 60px;
        width: 800px;
        height: 650px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      /* 切换登录方式按钮 */
      .login-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }

      .switch-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        border-radius: 8px;
        background: transparent;
        color: #667eea;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .switch-btn.active {
        background: #667eea;
        color: white;
      }

      .switch-btn:hover {
        background: #667eea;
        color: white;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
      }

      .icon {
        width: 160px;
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 20px;
      }

      .form-group {
        width: 100%;
        margin-bottom: 30px;
      }

      .input-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-field {
        width: 100%;
        padding: 20px 25px;
        border: 3px solid #e1e8ed;
        border-radius: 16px;
        font-size: 25px;
        background: white;
        transition: all 0.3s ease;
        outline: none;
      }

      .input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-field::placeholder {
        color: #94a3b8;
      }

      .verify-input {
        flex: 1;
        margin-right: 20px;
      }

      .verify-btn {
        padding: 20px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }

      .verify-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .verify-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .login-btn {
        width: 100%;
        padding: 24px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
      }

      .login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .tips {
        margin-top: 25px;
        font-size: 20px;
        color: #64748b;
        text-align: center;
        line-height: 1.5;
      }

      /* 错误提示样式 */
      .error-message {
        color: #ef4444;
        font-size: 20px;
        margin-top: 12px;
        display: none;
      }

      .input-field.error {
        border-color: #ef4444;
      }

      /* 消息提示 */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 24px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }

      /* 同意条款样式 */
      .agreement-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        font-size: 24px;
        color: #64748b;
        line-height: 1.5;
      }

      .agreement-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .agreement-text {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }

      .agreement-link {
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .agreement-link:hover {
        color: #5b6ee8;
      }

      /* 弹窗样式 */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
      }

      .close {
        color: #94a3b8;
        float: right;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #667eea;
      }

      .modal-body {
        font-size: 16px;
        line-height: 1.6;
        color: #333;
      }

      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        margin-top: 25px;
        margin-bottom: 15px;
        color: #667eea;
      }

      .modal-body h1 {
        font-size: 24px;
      }

      .modal-body h2 {
        font-size: 20px;
      }

      .modal-body h3 {
        font-size: 18px;
      }

      .modal-body p {
        margin-bottom: 12px;
      }

      .modal-body ul,
      .modal-body ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      .modal-body li {
        margin-bottom: 8px;
      }

      .modal-body strong {
        color: #333;
        font-weight: 600;
      }

      .modal-body code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
      }

      /* 加载状态 */
      .modal-loading {
        text-align: center;
        padding: 40px;
        color: #94a3b8;
        font-size: 18px;
      }
    </style>

  </head>

  <body>    <div class="login-container">
      <!-- 切换登录方式按钮 -->
      <div class="login-switch">
        <button type="button" class="switch-btn active" id="phoneLoginBtn" onclick="switchToPhoneLogin()">📱手机号登录</button>
        <button type="button" class="switch-btn" id="usernameLoginBtn" onclick="switchToUsernameLogin()">🔑账号密码登录</button>
      </div>

      <div class="header">
        <div class="icon">
          <img
            src="https://cdn.keepwork.com/update61/assetdownload/update/texture/aries/creator/keepwork/minigame/logo.png.p,ba44b8275f4bdb7e6dacebc939b2ac13,33659"
            alt="麦思星球"
          />
        </div>
      </div>      <!-- 手机号登录表单 -->
      <form class="login-form" id="phoneLoginForm">
        <div class="form-group">
          <div class="input-container">
            <input type="tel" class="input-field" id="phoneInput" placeholder="请输入手机号码" maxlength="11" />
          </div>
          <div class="error-message" id="phoneError">请输入正确的手机号码</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input
              type="text"
              class="input-field verify-input"
              id="codeInput"
              placeholder="请输入验证码"
              maxlength="4"
            />
            <button type="button" class="verify-btn" id="verifyBtn">获取验证码</button>
          </div>
          <div class="error-message" id="codeError">请输入正确的验证码</div>
        </div>

        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox" />
          <div class="agreement-text">
            <span>登录即表示您同意我们的</span>
            <span class="agreement-link" onclick="openPrivacyModal()">隐私政策</span>
            <span>和</span>
            <span class="agreement-link" onclick="openLicenseModal()">用户协议</span>
          </div>
        </div>

        <button type="submit" class="login-btn" id="phoneLoginBtn">登录/注册</button>
      </form>

      <!-- 用户名密码登录表单 -->
      <form class="login-form" id="usernameLoginForm" style="display: none;">
        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field" id="usernameInput" placeholder="请输入用户名/邮箱" />
          </div>
          <div class="error-message" id="usernameError">请输入正确的用户名</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="password" class="input-field" id="passwordInput" placeholder="请输入密码" />
          </div>
          <div class="error-message" id="passwordError">请输入密码</div>
        </div>

        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox2" />
          <div class="agreement-text">
            <span>登录即表示您同意我们的</span>
            <span class="agreement-link" onclick="openPrivacyModal()">隐私政策</span>
            <span>和</span>
            <span class="agreement-link" onclick="openLicenseModal()">用户协议</span>
          </div>
        </div>

        <button type="submit" class="login-btn" id="usernameLoginSubmitBtn">登录</button>
      </form>

      <div class="tips" style="display: none">登录即表示您同意我们的隐私政策和用户协议</div>
    </div>

    <!-- 隐私政策弹窗 -->
    <div id="privacyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">隐私政策</div>
          <span class="close" onclick="closeModal('privacyModal')">&times;</span>
        </div>
        <div class="modal-body" id="privacyContent">
          <div class="modal-loading">正在加载隐私政策...</div>
        </div>
      </div>
    </div>

    <!-- 用户协议弹窗 -->
    <div id="licenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">用户协议</div>
          <span class="close" onclick="closeModal('licenseModal')">&times;</span>
        </div>
        <div class="modal-body" id="licenseContent">
          <div class="modal-loading">正在加载用户协议...</div>
        </div>
      </div>
    </div>

    <script>
      // 修改API客户端，自动添加Authorization头
      class ApiClient {
        constructor(baseUrl = '') {
          this.baseUrl = baseUrl
          this.defaultHeaders = {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          }
        }

        // 通用请求方法
        async request(url, options = {}) {
          try {
            const config = {
              ...options,
              headers: {
                ...this.defaultHeaders,
                ...options.headers,
              },
            }

            const response = await fetch(this.baseUrl + url, config)

            if (!response.ok) {
              const error = await response.json().catch(() => ({}))
              console.error('Response error:', response.status, error)
              throw error
            }

            const contentType = response.headers.get('content-type')
            if (contentType && contentType.includes('application/json')) {
              return await response.json()
            }

            return await response.text()
          } catch (error) {
            throw error
          }
        }

        // GET 请求
        async get(url, params = {}, headers = {}) {
          const queryString = new URLSearchParams(params).toString()
          const fullUrl = queryString ? `${url}?${queryString}` : url

          return this.request(fullUrl, {
            method: 'GET',
            headers,
          })
        }

        // POST 请求
        async post(url, data = {}, headers = {}) {
          return this.request(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...headers,
            },
            body: JSON.stringify(data),
          })
        }

        // 设置默认头部
        setDefaultHeader(key, value) {
          this.defaultHeaders[key] = value
        }

        // 设置基础URL
        setBaseUrl(url) {
          this.baseUrl = url
        }
      }

      // 创建API客户端实例
      const api = new ApiClient('https://api.keepwork.com/core/v0')

      class LocalStorageProxy {
        constructor() {
          this.requestId = 0
          this.pendingRequests = new Map()

          // 监听父页面的响应
          window.addEventListener('message', (event) => {
            if (event.data.type === 'localStorageResponse') {
              const { requestId, success, data, error } = event.data
              const request = this.pendingRequests.get(requestId)

              if (request) {
                this.pendingRequests.delete(requestId)
                if (success) {
                  request.resolve(data)
                } else {
                  request.reject(new Error(error))
                }
              }
            }
          })
        }

        _sendRequest(action, key, value) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId

            this.pendingRequests.set(requestId, { resolve, reject })

            // 设置超时
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId)
                reject(new Error('LocalStorage operation timeout'))
              }
            }, 5000)

            // 发送请求到父页面
            window.parent.postMessage(
              {
                type: 'localStorage',
                action,
                key,
                value,
                requestId,
              },
              '*'
            )
          })
        }

        // 标准localStorage API
        async getItem(key) {
          return await this._sendRequest('getItem', key)
        }

        async setItem(key, value) {
          return await this._sendRequest('setItem', key, value)
        }

        async removeItem(key) {
          return await this._sendRequest('removeItem', key)
        }

        async clear() {
          return await this._sendRequest('clear')
        }

        async key(index) {
          return await this._sendRequest('key', null, index)
        }

        async length() {
          return await this._sendRequest('length')
        }

        async keys() {
          return await this._sendRequest('keys')
        }

        // 扩展API - 使用父页面的工具方法
        async getStorageData(key, defaultValue = {}) {
          return await this._sendRequest('getStorageData', key, defaultValue)
        }

        async setStorageData(key, data) {
          return await this._sendRequest('setStorageData', key, data)
        }
      }

      // 创建全局实例
      window.parentLocalStorage = new LocalStorageProxy()

      // Token管理器
      class TokenManager {
        constructor() {
          this.TOKEN_KEY = 'keepwork_access_token'
          this.EXPIRES_KEY = 'keepwork_token_expires'
          this.MAISI_TOKEN_KEY = 'mais_games_access_token'
          this.MAISI_EXPIRES_KEY = 'mais_games_token_expires'
          this.USER_INFO_KEY = 'keepwork_user_info'

          // 确保parentLocalStorage存在
          this.storage = window.parentLocalStorage || localStorage
        }

        // 检查是否使用代理存储
        get isUsingProxy() {
          return window.parentLocalStorage !== undefined
        }

        // 保存token信息
        async saveTokens(data) {
          const now = Date.now()
          const expiresAt = now + data.tokenExpire * 1000 // 转换为毫秒

          if (this.isUsingProxy) {
            await this.storage.setItem(this.TOKEN_KEY, data.token)
            await this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString())
          } else {
            this.storage.setItem(this.TOKEN_KEY, data.token)
            this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString())
          }

          console.log('Keepwork Token已保存，过期时间:', new Date(expiresAt))
        }

        async saveMaisiToken(data) {
          const now = Date.now()
          const expiresAt = now + data.expiresIn * 1000 // 转换为毫秒

          if (this.isUsingProxy) {
            await this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken)
            await this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString())
          } else {
            this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken)
            this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString())
          }

          console.log('麦思Token已保存，过期时间:', new Date(expiresAt))
        }

        // 获取访问令牌
        async getAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.TOKEN_KEY)
          } else {
            return this.storage.getItem(this.TOKEN_KEY)
          }
        }

        async getMaisiAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.MAISI_TOKEN_KEY)
          } else {
            return this.storage.getItem(this.MAISI_TOKEN_KEY)
          }
        }

        // 检查token是否有效
        async isTokenValid() {
          let token, expiresAt

          if (this.isUsingProxy) {
            token = await this.getAccessToken()
            expiresAt = await this.storage.getItem(this.EXPIRES_KEY)
          } else {
            token = this.getAccessToken()
            expiresAt = this.storage.getItem(this.EXPIRES_KEY)
          }

          if (!token || !expiresAt) {
            return false
          }

          const now = Date.now()
          const expires = parseInt(expiresAt)

          // 提前5分钟判断过期（安全边际）
          return now < expires - 5 * 60 * 1000
        }

        async isMaisiTokenValid() {
          let token, expiresAt

          if (this.isUsingProxy) {
            token = await this.getMaisiAccessToken()
            expiresAt = await this.storage.getItem(this.MAISI_EXPIRES_KEY)
          } else {
            token = this.getMaisiAccessToken()
            expiresAt = this.storage.getItem(this.MAISI_EXPIRES_KEY)
          }

          if (!token || !expiresAt) {
            return false
          }

          const now = Date.now()
          const expires = parseInt(expiresAt)

          // 提前5分钟判断过期（安全边际）
          return now < expires - 5 * 60 * 1000
        }

        // 清除所有token信息
        async clearTokens() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.TOKEN_KEY)
            await this.storage.removeItem(this.EXPIRES_KEY)
            await this.storage.removeItem(this.MAISI_TOKEN_KEY)
            await this.storage.removeItem(this.MAISI_EXPIRES_KEY)
            await this.storage.removeItem(this.USER_INFO_KEY)
          } else {
            this.storage.removeItem(this.TOKEN_KEY)
            this.storage.removeItem(this.EXPIRES_KEY)
            this.storage.removeItem(this.MAISI_TOKEN_KEY)
            this.storage.removeItem(this.MAISI_EXPIRES_KEY)
            this.storage.removeItem(this.USER_INFO_KEY)
          }
        }

        // 保存用户信息
        async saveUserInfo(userInfo) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo))
          } else {
            this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo))
          }
        }

        // 获取用户信息
        async getUserInfo() {
          let userInfo

          if (this.isUsingProxy) {
            userInfo = await this.storage.getItem(this.USER_INFO_KEY)
          } else {
            userInfo = this.storage.getItem(this.USER_INFO_KEY)
          }

          return userInfo ? JSON.parse(userInfo) : null
        }
      }

      // 创建token管理器实例
      const tokenManager = new TokenManager()

      // 页面加载时检查登录状态
      checkLoginStatus()

      // Markdown转HTML的简单实现
      function markdownToHtml(markdown) {
        if (!markdown) return ''

        let html = markdown
          // 标题转换
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          // 粗体
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.*?)__/g, '<strong>$1</strong>')
          // 斜体
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/_(.*?)_/g, '<em>$1</em>')
          // 代码
          .replace(/`(.*?)`/g, '<code>$1</code>')
          // 链接
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          // 列表
          .replace(/^[\s]*\*[\s]+(.*$)/gim, '<li>$1</li>')
          .replace(/^[\s]*\d+\.[\s]+(.*$)/gim, '<li>$1</li>')
          // 段落
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>')

        // 包装列表项
        html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')

        // 包装段落
        if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<ol')) {
          html = '<p>' + html + '</p>'
        }

        return html
      }

      // 打开隐私政策弹窗
      async function openPrivacyModal() {
        const modal = document.getElementById('privacyModal')
        const content = document.getElementById('privacyContent')

        modal.style.display = 'block'
        content.innerHTML = '<div class="modal-loading">正在加载隐私政策...</div>'

        try {
          const response = await fetch('https://cross.keepwork.com/api/raw/maisi/maisi/docs/privacy')
          const markdown = await response.text()
          const html = markdownToHtml(markdown)
          content.innerHTML = html
        } catch (error) {
          console.error('加载隐私政策失败:', error)
          content.innerHTML = '<p style="color: #ef4444;">加载失败，请稍后重试</p>'
        }
      }

      // 打开用户协议弹窗
      async function openLicenseModal() {
        const modal = document.getElementById('licenseModal')
        const content = document.getElementById('licenseContent')

        modal.style.display = 'block'
        content.innerHTML = '<div class="modal-loading">正在加载用户协议...</div>'

        try {
          const response = await fetch('https://cross.keepwork.com/api/raw/maisi/maisi/docs/license')
          const markdown = await response.text()
          const html = markdownToHtml(markdown)
          content.innerHTML = html
        } catch (error) {
          console.error('加载用户协议失败:', error)
          content.innerHTML = '<p style="color: #ef4444;">加载失败，请稍后重试</p>'
        }
      }

      // 关闭弹窗
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none'
      }

      // 点击弹窗外部关闭
      window.addEventListener('click', function (event) {
        const privacyModal = document.getElementById('privacyModal')
        const licenseModal = document.getElementById('licenseModal')

        if (event.target === privacyModal) {
          privacyModal.style.display = 'none'
        }
        if (event.target === licenseModal) {
          licenseModal.style.display = 'none'
        }
      })

      // 检查登录状态
      async function checkLoginStatus() {
        if (await tokenManager.isTokenValid()) {
          console.log('用户已登录，token有效')
          if (!(await tokenManager.isMaisiTokenValid())) {
            console.log('Maisi token已过期，重新获取')
            const header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            }
            try {
              const userInfo = await tokenManager.getUserInfo()
              const response = await api.post(
                '/oauth/getMaisiToken',
                {
                  phone: userInfo?.phone || '',
                },
                header
              )
              await tokenManager.saveMaisiToken(response.token)
              console.log('Maisi token已更新')
            } catch (error) {
              console.error('获取Maisi token失败:', error)
            }
          }
          window.parent.postMessage({ type: 'getLocation' }, '*')
          return
        } else {
          console.log('用户未登录或token已过期')
          await tokenManager.clearTokens()
          showLoginForm()
        }
      }

      async function navigateToMSGames(href) {
        const url = new URL(href)
        url.searchParams.set('gameName', 'ms_games')

        const userInfo = await tokenManager.getUserInfo()
        const phone = userInfo?.phone || ''
        const token = (await tokenManager.getMaisiAccessToken()) || ''

        url.searchParams.set('phone', phone)
        url.searchParams.set('thirdpartytoken', token)

        // console.log('跳转到MS游戏页面:', url.toString());
        window.parent.postMessage(
          {
            type: 'navigate',
            url: url.toString(),
          },
          '*'
        )
      }

      // 显示已登录状态
      async function showLoggedInState() {
        const userInfo = await tokenManager.getUserInfo()
        const phone = userInfo ? userInfo.phone : '用户'

        // 隐藏登录表单，显示已登录信息
        document.querySelector('.login-form').style.display = 'none'
        document.querySelector('.tips').innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 24px; color: #667eea; margin-bottom: 20px;">
                        欢迎回来！${phone}
                    </p>
                    <button onclick="logout()" style="
                        padding: 12px 24px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                    ">退出登录</button>
                    <button onclick="goToMain()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: 15px;
                    ">进入主页</button>
                </div>
            `
      }

      // 显示登录表单
      function showLoginForm() {
        document.querySelector('.login-form').style.display = 'block'
        document.querySelector('.tips').style.display = 'none'
      }

      // 退出登录
      async function logout() {
        await tokenManager.clearTokens()
        showLoginForm()
        showMessage('已退出登录')
      }

      // 跳转到主页
      function goToMain() {
        // 这里添加跳转到主页的逻辑
        window.parent.postMessage({ type: 'getLocation' }, '*')
      }

      // 手机号验证
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone)
      }

      // 验证码验证
      function validateCode(code) {
        return /^\d{4}$/.test(code)
      }

      // 显示错误信息
      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId)
        const error = document.getElementById(errorId)
        input.classList.add('error')
        error.textContent = message
        error.style.display = 'block'
      }

      // 隐藏错误信息
      function hideError(inputId, errorId) {
        const input = document.getElementById(inputId)
        const error = document.getElementById(errorId)
        input.classList.remove('error')
        error.style.display = 'none'
      }

      // 倒计时功能
      function startCountdown(btn, seconds = 60) {
        btn.disabled = true
        let remaining = seconds

        const timer = setInterval(() => {
          btn.textContent = `${remaining}s后重试`
          remaining--

          if (remaining < 0) {
            clearInterval(timer)
            btn.disabled = false
            btn.textContent = '获取验证码'
          }
        }, 1000)
      }

      // 显示消息提示
      function showMessage(message) {
        // 检查是否已有提示元素
        let existingToast = document.querySelector('.toast')

        if (existingToast) {
          // 更新现有元素的文本内容
          existingToast.textContent = message

          // 清除现有的定时器（如果有的话）
          if (existingToast.hideTimer) {
            clearTimeout(existingToast.hideTimer)
          }

          // 重新设置定时器
          existingToast.hideTimer = setTimeout(() => {
            if (existingToast && existingToast.parentNode) {
              document.body.removeChild(existingToast)
            }
          }, 2000)
        } else {
          // 创建新的提示元素
          const toast = document.createElement('div')
          toast.className = 'toast'
          toast.textContent = message

          document.body.appendChild(toast)

          // 设置定时器并保存引用
          toast.hideTimer = setTimeout(() => {
            if (toast && toast.parentNode) {
              document.body.removeChild(toast)
            }
          }, 2000)
        }
      }      // 切换到手机号登录
      function switchToPhoneLogin() {
        const phoneForm = document.getElementById('phoneLoginForm')
        const usernameForm = document.getElementById('usernameLoginForm')
        const phoneBtn = document.getElementById('phoneLoginBtn')
        const usernameBtn = document.getElementById('usernameLoginBtn')

        phoneForm.style.display = 'block'
        usernameForm.style.display = 'none'
        phoneBtn.classList.add('active')
        usernameBtn.classList.remove('active')
      }

      // 切换到用户名密码登录
      function switchToUsernameLogin() {
        const phoneForm = document.getElementById('phoneLoginForm')
        const usernameForm = document.getElementById('usernameLoginForm')
        const phoneBtn = document.getElementById('phoneLoginBtn')
        const usernameBtn = document.getElementById('usernameLoginBtn')

        phoneForm.style.display = 'none'
        usernameForm.style.display = 'block'
        phoneBtn.classList.remove('active')
        usernameBtn.classList.add('active')
      }

      // 验证用户名
      function validateUsername(username) {
        return username && username.trim().length > 0
      }

      // 验证密码
      function validatePassword(password) {
        return password && password.trim().length >= 6
      }

      // DOM 元素
      const phoneInput = document.getElementById('phoneInput')
      const codeInput = document.getElementById('codeInput')
      const verifyBtn = document.getElementById('verifyBtn')
      const phoneLoginForm = document.getElementById('phoneLoginForm')
      const usernameLoginForm = document.getElementById('usernameLoginForm')
      const agreementCheckbox = document.getElementById('agreementCheckbox')
      const agreementCheckbox2 = document.getElementById('agreementCheckbox2')
      const usernameInput = document.getElementById('usernameInput')
      const passwordInput = document.getElementById('passwordInput')

      // 手机号输入事件
      phoneInput.addEventListener('input', function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, '')
        hideError('phoneInput', 'phoneError')
      })

      // 验证码输入事件
      codeInput.addEventListener('input', function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, '')
        hideError('codeInput', 'codeError')
      })

      // 获取验证码
      verifyBtn.addEventListener('click', async function () {
        const phone = phoneInput.value.trim()

        if (!validatePhone(phone)) {
          showError('phoneInput', 'phoneError', '请输入正确的手机号码')
          phoneInput.focus()
          return
        }

        try {
          // 使用封装的API方法发送验证码
          const response = await api.get('/users/cellphone_captcha', {
            cellphone: phone,
          })

          console.log('发送验证码响应:', response)

          // 开始倒计时
          startCountdown(verifyBtn)
          showMessage('验证码已发送，请注意查收')
        } catch (error) {
          console.error('发送验证码失败:', error)
          let errorMessage = '发送验证码失败，请稍后重试'

          if (error.message.includes('429')) {
            errorMessage = '发送过于频繁，请稍后再试'
          } else if (error.message.includes('400')) {
            errorMessage = '手机号格式错误'
          }

          showMessage(errorMessage)
        }
      })      // 表单提交
      phoneLoginForm.addEventListener('submit', async function (e) {
        e.preventDefault()

        const phone = phoneInput.value.trim()
        const code = codeInput.value.trim()

        // 验证手机号
        if (!validatePhone(phone)) {
          showError('phoneInput', 'phoneError', '请输入正确的手机号码')
          return
        }

        // 验证验证码
        if (!validateCode(code)) {
          showError('codeInput', 'codeError', '请输入4位数字验证码')
          return
        }

        // 验证是否同意条款
        if (!agreementCheckbox.checked) {
          showMessage('请勾选同意隐私政策和用户协议')
          return
        }

        // 使用封装的API方法进行登录
        const loginBtn = document.querySelector('#phoneLoginForm .login-btn')
        loginBtn.disabled = true
        loginBtn.textContent = '登录中...'

        try {
          const response1 = await api.post('/users/cellphone_captcha_verify', {
            cellphone: phone,
            captcha: code,
          })

          console.log('验证码验证响应:', response1)
          if (response1.verify) {
            const response2 = await api.post('/users/cellphoneLoginRegister', {
              cellphone: phone,
              captcha: code,
              channel: 60,
            })
            console.log('登录响应:', response2)

            // 保存登录信息
            if (response2 && response2.token) {
              await tokenManager.saveTokens(response2)

              // 保存用户信息
              await tokenManager.saveUserInfo({
                phone: phone,
                loginTime: new Date().toISOString(),
              })

              // 尝试获取麦思Token（不影响主流程）
              if (!(await tokenManager.getMaisiAccessToken())) {
                try {
                  const header = {
                    Authorization: `Bearer ${response2.token}`,
                  }
                  const response3 = await api.post(
                    '/oauth/getMaisiToken',
                    {
                      phone,
                    },
                    header
                  )
                  console.log('获取麦思Token响应:', response3)
                  await tokenManager.saveMaisiToken(response3.token)
                } catch (error) {
                  console.warn('获取麦思Token失败:', error)
                }
              }

              // 显示已登录状态
              setTimeout(() => {
                window.parent.postMessage({ type: 'getLocation' }, '*')
              }, 1000)
            } else {
              throw new Error('登录失败，未获取到有效token')
            }
          } else {
            throw new Error('验证码验证失败')
          }
        } catch (error) {
          console.error('登录失败:', error)
          let errorMessage = '登录失败，请稍后重试'

          if (error.message) {
            errorMessage = error.message
          }

          showMessage(errorMessage)
        } finally {
          // 重置按钮状态
          loginBtn.disabled = false
          loginBtn.textContent = '登录/注册'
        }
      })

      // 用户名密码登录表单提交
      usernameLoginForm.addEventListener('submit', async function (e) {
        e.preventDefault()

        const username = usernameInput.value.trim()
        const password = passwordInput.value.trim()

        // 验证用户名
        if (!validateUsername(username)) {
          showError('usernameInput', 'usernameError', '请输入用户名或邮箱')
          return
        }

        // 验证密码
        if (!validatePassword(password)) {
          showError('passwordInput', 'passwordError', '密码至少6位')
          return
        }

        // 验证是否同意条款
        if (!agreementCheckbox2.checked) {
          showMessage('请勾选同意隐私政策和用户协议')
          return
        }

        // 使用封装的API方法进行登录
        const loginBtn = document.querySelector('#usernameLoginForm .login-btn')
        loginBtn.disabled = true
        loginBtn.textContent = '登录中...'

        try {
          let response2 = await api.post('/users/login', {
              username: username,
              password: password,
              platform: 'WEB',
            })
          
          console.log('用户名密码登录响应:', response2)

          // 保存登录信息
          if (response2 && response2.token) {
            await tokenManager.saveTokens(response2)

            // 保存用户信息
            await tokenManager.saveUserInfo({
              username: response2.username,
              phone: response2.cellphone,
              loginTime: new Date().toISOString(),
            })

            // 尝试获取麦思Token（不影响主流程）
            if (!(await tokenManager.getMaisiAccessToken()) && response2.cellphone) {
              try {
                const header = {
                  Authorization: `Bearer ${response2.token}`,
                }
                const response3 = await api.post(
                  '/oauth/getMaisiToken',
                  {
                    phone: response2.cellphone, 
                  },
                  header
                )
                console.log('获取麦思Token响应:', response3)
                await tokenManager.saveMaisiToken(response3.token)
              } catch (error) {
                console.warn('获取麦思Token失败:', error)
              }
            }

            // 显示已登录状态
            setTimeout(() => {
              window.parent.postMessage({ type: 'getLocation' }, '*')
            }, 1000)
          } else {
            throw new Error('登录失败，未获取到有效token')
          }
        } catch (error) {
          console.error('用户名密码登录失败:', error)
          let errorMessage = '用户名或密码错误'

          if (error.message && error.message.includes('网络')) {
            errorMessage = '网络连接失败，请稍后重试'
          }

          showMessage(errorMessage)
        } finally {
          // 重置按钮状态
          loginBtn.disabled = false
          loginBtn.textContent = '登录'
        }
      })

      // 阻止页面缩放
      document.addEventListener(
        'touchstart',
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault()
          }
        },
        { passive: false }
      )

      // 阻止双击缩放
      let lastTouchEnd = 0
      document.addEventListener(
        'touchend',
        function (e) {
          const now = new Date().getTime()
          if (now - lastTouchEnd <= 300) {
            e.preventDefault()
          }
          lastTouchEnd = now
        },
        false
      )

      window.addEventListener('message', async function (event) {
        switch (event.data.type) {
          case 'locationResponse':
            await navigateToMSGames(event.data.href)
            break
          // case 'setGameConfig':
          //     try {
          //         const script = document.createElement('script');
          //         script.textContent = event.data.injectedScript;
          //         document.head.appendChild(script);
          //         console.log('Script injected successfully');
          //     } catch (error) {
          //         console.error('Failed to execute injected script:', error);
          //     }
          //     break;
        }
      })
    </script>

  </body>
</html>

