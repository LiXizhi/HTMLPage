<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>麦思星球 - 登录</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .login-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 50px 60px;
        width: 800px;
        height: 650px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      /* 切换登录方式按钮 */
      .login-switch {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }

      .switch-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        border-radius: 8px;
        background: transparent;
        color: #667eea;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .switch-btn.active {
        background: #667eea;
        color: white;
      }

      .switch-btn:hover {
        background: #667eea;
        color: white;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        gap: 30px;
      }

      .icon {
        width: 160px;
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 20px;
      }

      .game-title {
        font-size: 48px;
        font-weight: bold;
        color: #333;
        text-align: left;
        line-height: 1.2;
        display: none; /* Hidden by default, shown when loginGameTitle exists */
      }

      .form-group {
        width: 100%;
        margin-bottom: 30px;
      }

      .input-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-field {
        width: 100%;
        padding: 20px 25px;
        border: 3px solid #e1e8ed;
        border-radius: 16px;
        font-size: 25px;
        background: white;
        transition: all 0.3s ease;
        outline: none;
      }

      .input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-field::placeholder {
        color: #94a3b8;
      }

      .verify-input {
        flex: 1;
        margin-right: 20px;
      }

      .verify-btn {
        padding: 20px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }

      .verify-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .verify-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .login-btn {
        width: 100%;
        padding: 24px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
      }
      .login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* 按钮容器样式 */
      .button-container {
        display: flex;
        gap: 12px;
        margin-top: 15px;
      }

      .button-container .login-btn {
        flex: 1;
        margin-top: 0;
      }

      /* 游客登录按钮样式 */
      .guest-login-btn {
        flex: 1;
        padding: 24px;
        background: linear-gradient(45deg, #6b7280, #9ca3af);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 0;
      }

      .guest-login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(107, 114, 128, 0.3);
      }

      .guest-login-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .tips {
        margin-top: 25px;
        font-size: 20px;
        color: #64748b;
        text-align: center;
        line-height: 1.5;
      }

      /* 错误提示样式 */
      .error-message {
        color: #ef4444;
        font-size: 20px;
        margin-top: 12px;
        display: none;
      }

      .input-field.error {
        border-color: #ef4444;
      }

      /* 消息提示 */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 24px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }

      /* 同意条款样式 */
      .agreement-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        font-size: 24px;
        color: #64748b;
        line-height: 1.5;
      }

      .agreement-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .agreement-text {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        cursor: pointer; /* 整行可点击切换复选框 */
      }

      .agreement-link {
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.3s ease;
      }      .agreement-link:hover {
        color: #5b6ee8;
      }

      /* 注册链接样式 */
      .register-link {
        text-align: center;
        margin-top: 20px;
        color: #666;
        font-size: 18px;
      }

      .register-link a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .register-link a:hover {
        color: #5b6ee8;
        text-decoration: underline;
      }

      /* 弹窗样式 */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
      }

      .close {
        color: #94a3b8;
        float: right;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #667eea;
      }

      .modal-body {
        font-size: 16px;
        line-height: 1.6;
        color: #333;
      }

      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        margin-top: 25px;
        margin-bottom: 15px;
        color: #667eea;
      }

      .modal-body h1 {
        font-size: 24px;
      }

      .modal-body h2 {
        font-size: 20px;
      }

      .modal-body h3 {
        font-size: 18px;
      }

      .modal-body p {
        margin-bottom: 12px;
      }

      .modal-body ul,
      .modal-body ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      .modal-body li {
        margin-bottom: 8px;
      }

      .modal-body strong {
        color: #333;
        font-weight: 600;
      }

      .modal-body code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
      }

      .modal-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 2px solid #e1e8ed;
        display: flex;
        justify-content: center;
        gap: 12px;
      }

      .modal-btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 28px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.25);
        transition: all 0.3s ease;
      }

      .modal-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(102, 126, 234, 0.35);
      }

      .modal-btn-secondary {
        background: #f8f9fa;
        color: #64748b;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        padding: 10px 28px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .modal-btn-secondary:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: #475569;
        transform: translateY(-2px);
      }

      /* 加载状态 */
      .modal-loading {
        text-align: center;
        padding: 40px;
        color: #94a3b8;
        font-size: 18px;
      }

      /* 实名认证弹窗样式 */
      .realname-modal .modal-content {
        max-width: 600px;
      }

      .realname-form {
        padding: 20px 0;
      }

      .realname-form .form-group {
        margin-bottom: 25px;
      }

      .realname-form .input-field {
        font-size: 20px;
        padding: 16px 20px;
      }

      .realname-form .verify-btn {
        font-size: 20px;
        padding: 16px 24px;
        min-width: 120px;
      }

      .realname-form .error-message {
        font-size: 16px;
        margin-top: 8px;
      }

      /* 实名通知弹窗样式 */
      .realname-notice-modal .modal-content {
        max-width: 500px;
        text-align: center;
      }

      .realname-notice-icon {
        font-size: 64px;
        color: #10b981;
        margin-bottom: 20px;
      }

      .realname-notice-text {
        font-size: 20px;
        color: #333;
        line-height: 1.6;
        margin-bottom: 30px;
      }      /* 用户设置弹窗样式 */
      .user-setting-modal {
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .user-setting-modal.show {
        transform: translateY(0);
      }

      /* 注册弹窗样式 */
      #registerModal .modal-content {
        margin: 0;
        padding: 0;
        border-radius: 0;
        width: 100%;
        max-width: none;
        height: 100vh;
        max-height: none;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      #registerModal .close {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        line-height: 1;
      }

      #registerModal .close:hover {
        background: rgba(0, 0, 0, 0.7);
      }

      #registerModal #register_iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
        overflow: hidden;
      }

      /* Developer panel styles */
      .dev-panel {
        position: fixed;
        top: 0;
        right: -200px;
        width: 200px;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 20px;
        transition: right 0.3s ease;
        z-index: 10000;
        font-size: 14px;
        overflow-y: auto;
      }

      .dev-panel.show {
        right: 0;
      }

      .dev-panel h3 {
        margin: 0 0 20px 0;
        font-size: 16px;
        color: #00ff00;
        text-align: center;
      }

      .dev-option {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dev-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .dev-option label {
        cursor: pointer;
        font-size: 12px;
        line-height: 1.2;
      }      .dev-option input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #666;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 12px;
        margin-top: 4px;
      }

      .dev-option input[type="text"]:focus {
        outline: none;
        border-color: #00ff00;
        background: rgba(255, 255, 255, 0.2);
      }

      .project-id-container {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      .project-id-container input[type="text"] {
        flex: 1;
        margin-top: 0;
      }

      .project-id-dropdown {
        width: 60px;
        padding: 4px 2px;
        border: 1px solid #666;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 10px;
        cursor: pointer;
        text-align: center;
      }

      .project-id-dropdown:focus {
        outline: none;
        border-color: #00ff00;
        background: rgba(255, 255, 255, 0.2);
      }

      .project-id-dropdown option {
        background: #333;
        color: white;
        font-size: 10px;
      }

      .dev-option-group {
        margin-bottom: 20px;
        border-bottom: 1px solid #666;
        padding-bottom: 15px;
      }

      .dev-option-title {
        font-size: 13px;
        color: #00ff00;
        margin-bottom: 8px;
      }

      .dev-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 自动登录状态显示样式 */
      .auto-login-status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        text-align: center;
        z-index: 1000;
        display: none;
      }

      .auto-login-status h3 {
        font-size: 24px;
        color: #333;
        margin-bottom: 15px;
      }

      .auto-login-status p {
        font-size: 18px;
        color: #666;
        margin-bottom: 25px;
        line-height: 1.5;
      }

      .auto-login-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .auto-login-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .auto-login-btn.primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .auto-login-btn.secondary {
        background: #f0f0f0;
        color: #666;
      }

      .auto-login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body>
    <div class="login-container">
      <!-- 切换登录方式按钮 -->
      <div class="login-switch">
        <button type="button" class="switch-btn" id="phoneLoginBtn" onclick="switchToPhoneLogin()">📱手机号登录</button>
        <button type="button" class="switch-btn active" id="usernameLoginBtn" onclick="switchToUsernameLogin()">🔑账号密码登录</button>
      </div>
      <div class="header">
        <div id="maisiIcon" class="icon">
          <img src="https://cdn.keepwork.com/update61/assetdownload/update/texture/aries/creator/keepwork/minigame/logo.png.p,ba44b8275f4bdb7e6dacebc939b2ac13,33659" alt="麦思星球" />
        </div>
        <div class="game-title" id="gameTitle"></div>
      </div>
      <!-- 手机号登录表单 -->
      <form class="login-form" id="phoneLoginForm" style="display: none">
        <div class="form-group">
          <div class="input-container">
            <input type="tel" class="input-field" id="phoneInput" placeholder="请输入手机号码" maxlength="11" />
          </div>
          <div class="error-message" id="phoneError">请输入正确的手机号码</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field verify-input" id="codeInput" placeholder="请输入验证码" maxlength="4" />
            <button type="button" class="verify-btn" id="verifyBtn">获取验证码</button>
          </div>
          <div class="error-message" id="codeError">请输入正确的验证码</div>
        </div>
        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox" />
          <div class="agreement-text">
            <span>登录即表示您同意我们的</span>
            <span class="agreement-link" onclick="openPrivacyModal()">隐私政策</span>
            <span>和</span>
            <span class="agreement-link" onclick="openLicenseModal()">用户协议</span>
          </div>
        </div>

        <div class="button-container" id="phoneButtonContainer">
          <button type="submit" class="login-btn" id="phoneLoginBtn">登录/注册</button>
        </div>
      </form>

      <!-- 用户名密码登录表单 -->
      <form class="login-form" id="usernameLoginForm">
        <div class="form-group">
          <div class="input-container">
            <input type="text" class="input-field" id="usernameInput" placeholder="请输入用户名/邮箱" />
          </div>
          <div class="error-message" id="usernameError">请输入正确的用户名</div>
        </div>

        <div class="form-group">
          <div class="input-container">
            <input type="password" class="input-field" id="passwordInput" placeholder="请输入密码" />
          </div>
          <div class="error-message" id="passwordError">请输入密码</div>
        </div>
        <div class="agreement-section">
          <input type="checkbox" class="agreement-checkbox" id="agreementCheckbox2" />
          <div class="agreement-text">
            <span>登录即表示您同意我们的</span>
            <span class="agreement-link" onclick="openPrivacyModal()">隐私政策</span>
            <span>和</span>
            <span class="agreement-link" onclick="openLicenseModal()">用户协议</span>
          </div>
        </div>        <div class="button-container" id="usernameButtonContainer">
          <button type="submit" class="login-btn" id="usernameLoginSubmitBtn">登录</button>
        </div>
        
        <!-- 注册链接 -->
        <div class="register-link">
          还没有账号？<a href="javascript:void(0)" onclick="openRegisterModal()">点击这里注册</a>
        </div>
      </form>

      <div class="tips" style="display: none">登录即表示您同意我们的隐私政策和用户协议</div>
    </div>

    <!-- 隐私政策弹窗 -->
    <div id="privacyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">隐私政策</div>
          <span class="close" onclick="closeModal('privacyModal')">&times;</span>
        </div>
        <div class="modal-body" id="privacyContent">
          <div class="modal-loading">正在加载隐私政策...</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="modal-btn-secondary" onclick="privacyReject()">拒绝并关闭</button>
          <button type="button" class="modal-btn-primary" onclick="privacyAgree()">同意并继续</button>
        </div>
      </div>
    </div>

    <!-- 用户协议弹窗 -->
    <div id="licenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">用户协议</div>
          <span class="close" onclick="closeModal('licenseModal')">&times;</span>
        </div>
        <div class="modal-body" id="licenseContent">
          <div class="modal-loading">正在加载用户协议...</div>
        </div>
      </div>
    </div>

    <!-- 实名认证弹窗 -->
    <div id="realnameModal" class="modal realname-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">实名认证</div>
          <span class="close" onclick="closeModal('realnameModal')">&times;</span>
        </div>
        <div class="modal-body">
          <p style="color: #64748b; margin-bottom: 20px; text-align: center">为了您的账户安全，请完成实名认证</p>
          <form class="realname-form" id="realnameForm">
            <div class="form-group">
              <div class="input-container">
                <input type="tel" class="input-field" id="realnamePhoneInput" placeholder="请输入手机号码" maxlength="11" />
              </div>
              <div class="error-message" id="realnamePhoneError">请输入正确的手机号码</div>
            </div>

            <div class="form-group">
              <div class="input-container">
                <input type="text" class="input-field verify-input" id="realnameCodeInput" placeholder="请输入验证码" maxlength="4" />
                <button type="button" class="verify-btn" id="realnameVerifyBtn">获取验证码</button>
              </div>
              <div class="error-message" id="realnameCodeError">请输入正确的验证码</div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="modal-btn-primary" style="width: 100%; padding: 16px">完成认证</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 实名通知弹窗 -->
    <div id="realnameNoticeModal" class="modal realname-notice-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">实名认证状态</div>
        </div>
        <div class="modal-body">
          <div class="realname-notice-icon">✅</div>
          <div class="realname-notice-text" id="realnameNoticeText">
            您已完成实名认证<br />
            可以正常使用所有功能
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-btn-primary" onclick="closeRealnameNoticeAndContinue()">确定</button>
          </div>
        </div>
      </div>
    </div>    <!-- 用户信息设置弹窗 -->
    <div id="userSettingModal" class="modal user-setting-modal">
      <iframe id="user_setting_iframe" src="" style="width: 100%; height: 100vh; border: none; background: white"></iframe>
    </div>
      <!-- 注册弹窗 -->
    <div id="registerModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRegisterModal()">&times;</span>
        <iframe id="register_iframe" src=""></iframe>
      </div>
    </div>
    
    <!-- Developer Panel -->
    <div id="devPanel" class="dev-panel">
      <button class="dev-close" onclick="hideDevPanel()">&times;</button>
      <h3>开发者选项</h3>

      <div class="dev-option-group">
        <div class="dev-option-title">项目设置</div>        <div class="dev-option">
          <div>
            <label for="projectIdInput">项目ID (默认: 4108584)</label>
            <div class="project-id-container">
              <input type="text" id="projectIdInput" placeholder="输入项目ID" onchange="updateProjectId(this.value)" />
              <select id="projectIdSelect" class="project-id-dropdown" onchange="selectProjectId(this.value)">
                <option value="">选择...</option>
                <option value="4108584">4108584 (正式版)</option>
                <option value="4300098">4300098（Dev）</option>
                <option value="4299999">4266694（内测）</option>
                <option value="530">530</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="dev-option-group">
        <div class="dev-option-title">显示设置</div>
        <div class="dev-option">
          <input type="checkbox" id="showDevPanelOnStart" onchange="toggleShowDevPanelOnStart(this.checked)" />
          <label for="showDevPanelOnStart">启动时显示开发面板</label>
        </div>
        <div class="dev-option">
          <input type="checkbox" id="showDevContent" onchange="toggleShowDevContent(this.checked)" />
          <label for="showDevContent">显示Dev内容</label>
        </div>
      </div>

      <div class="dev-option-group">
        <div class="dev-option-title">服务设置</div>
        <div class="dev-option">
          <input type="checkbox" id="useMaisiDev" onchange="toggleMaisiDevServer(this.checked)" />
          <label for="useMaisiDev">使用maisi Dev服务</label>
        </div>
      </div>
    </div>

    <!-- 自动登录状态显示 -->
    <div id="autoLoginStatus" class="auto-login-status">
      <h3 id="autoLoginTitle">自动登录中</h3>
      <p id="autoLoginMessage">检测到上次登录账号，正在自动登录，请稍后...</p>
      <div class="auto-login-buttons" id="autoLoginButtons" style="display: none">
        <button class="auto-login-btn primary" onclick="proceedAutoLogin()">自动登录</button>
        <button class="auto-login-btn secondary" onclick="cancelAutoLogin()">返回</button>
      </div>
    </div>

    <script>
      // Developer Mode functionality
      let maisiIconClickCount = 0;
      let clickTimer = null;
      let devOptions = {
        isUseMaisiDevServer: false,
        isShowDevContent: false,
        isShowDevPanelOnStart: false,
        projectId: "4108584",
      };

      const DEFAULT_PROJECT_ID = "4108584";

      // Initialize developer mode click handler
      function initDevMode() {
        const maisiIcon = document.getElementById("maisiIcon");
        if (maisiIcon) {
          maisiIcon.addEventListener("click", handleMaisiIconClick);
        }
      }

      function handleMaisiIconClick() {
        maisiIconClickCount++;

        // Reset counter after 3 seconds if not reaching 5 clicks
        if (clickTimer) {
          clearTimeout(clickTimer);
        }

        clickTimer = setTimeout(() => {
          maisiIconClickCount = 0;
        }, 3000);

        // Show dev panel after 5 clicks
        if (maisiIconClickCount >= 5) {
          showDevPanel();
          maisiIconClickCount = 0;
          clearTimeout(clickTimer);
        }
      }

      function showDevPanel() {
        const devPanel = document.getElementById("devPanel");
        if (devPanel) {
          devPanel.classList.add("show");
          isDevModeActive = true;
          // Set default values when dev panel is first shown
          devOptions.isShowDevContent = true;
          document.getElementById("showDevContent").checked = true;
        }
      }

      function hideDevPanel() {
        const devPanel = document.getElementById("devPanel");
        if (devPanel) {
          devPanel.classList.remove("show");
          isDevModeActive = false;
        }
      }

      // 修改API客户端，自动添加Authorization头
      class ApiClient {
        constructor(baseUrl = "") {
          this.baseUrl = baseUrl;
          this.defaultHeaders = {
            "Content-Type": "application/json",
            Accept: "application/json",
          };
        }

        // 通用请求方法
        async request(url, options = {}) {
          try {
            const config = {
              ...options,
              headers: {
                ...this.defaultHeaders,
                ...options.headers,
              },
            };

            const response = await fetch(this.baseUrl + url, config);

            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              console.error("Response error:", response.status, error);
              throw error;
            }

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              return await response.json();
            }

            return await response.text();
          } catch (error) {
            throw error;
          }
        }

        // GET 请求
        async get(url, params = {}, headers = {}) {
          const queryString = new URLSearchParams(params).toString();
          const fullUrl = queryString ? `${url}?${queryString}` : url;

          return this.request(fullUrl, {
            method: "GET",
            headers,
          });
        }

        // POST 请求
        async post(url, data = {}, headers = {}) {
          return this.request(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...headers,
            },
            body: JSON.stringify(data),
          });
        }

        // 设置默认头部
        setDefaultHeader(key, value) {
          this.defaultHeaders[key] = value;
        }

        // 设置基础URL
        setBaseUrl(url) {
          this.baseUrl = url;
        }
      }

      // 创建API客户端实例
      const api = new ApiClient("https://api.keepwork.com/core/v0");
      const maisiApi = new ApiClient("https://be.maseai.com/api/v1/open");

      // 获取maisiAI用户信息
      async function getMsUserInfo() {
        try {
          const header = {
            Authorization: `Bearer ${await tokenManager.getMaisiAccessToken()}`,
          };
          const response = await maisiApi.get("/open/getUserInfo", {}, header);
          console.log("获取maisiAI用户信息响应:", response);
          return response;
        } catch (error) {
          console.warn("获取maisiAI用户信息失败:", error);
          return null;
        }
      }

      class LocalStorageProxy {
        constructor() {
          this.requestId = 0;
          this.pendingRequests = new Map();

          // 监听父页面的响应
          window.addEventListener("message", (event) => {
            if (event.data.type === "localStorageResponse") {
              const { requestId, success, data, error } = event.data;
              const request = this.pendingRequests.get(requestId);

              if (request) {
                this.pendingRequests.delete(requestId);
                if (success) {
                  request.resolve(data);
                } else {
                  request.reject(new Error(error));
                }
              }
            }
          });
        }

        _sendRequest(action, key, value) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId;

            this.pendingRequests.set(requestId, { resolve, reject });

            // 设置超时
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId);
                reject(new Error("LocalStorage operation timeout"));
              }
            }, 5000);

            // 发送请求到父页面
            window.parent.postMessage(
              {
                type: "localStorage",
                action,
                key,
                value,
                requestId,
              },
              "*"
            );
          });
        }

        // 标准localStorage API
        async getItem(key) {
          return await this._sendRequest("getItem", key);
        }

        async setItem(key, value) {
          return await this._sendRequest("setItem", key, value);
        }

        async removeItem(key) {
          return await this._sendRequest("removeItem", key);
        }

        async clear() {
          return await this._sendRequest("clear");
        }

        async key(index) {
          return await this._sendRequest("key", null, index);
        }

        async length() {
          return await this._sendRequest("length");
        }

        async keys() {
          return await this._sendRequest("keys");
        }

        // 扩展API - 使用父页面的工具方法
        async getStorageData(key, defaultValue = {}) {
          return await this._sendRequest("getStorageData", key, defaultValue);
        }

        async setStorageData(key, data) {
          return await this._sendRequest("setStorageData", key, data);
        }
      }

      // 创建全局实例
      window.parentLocalStorage = new LocalStorageProxy();

      // Token管理器
      class TokenManager {
        constructor() {
          this.TOKEN_KEY = "keepwork_access_token";
          this.EXPIRES_KEY = "keepwork_token_expires";
          this.MAISI_TOKEN_KEY = "mais_games_access_token";
          this.MAISI_EXPIRES_KEY = "mais_games_token_expires";
          this.USER_INFO_KEY = "keepwork_user_info";
          this.DEV_PANEL_KEY = "dev_panel_options";

          // 确保parentLocalStorage存在
          this.storage = window.parentLocalStorage || localStorage;
        }

        // 检查是否使用代理存储
        get isUsingProxy() {
          return window.parent !== window && window.parentLocalStorage;
        } // 保存token信息
        async saveTokens(data) {
          const now = Date.now();
          const expiresAt = now + data.tokenExpire * 1000; // 转换为毫秒

          if (this.isUsingProxy) {
            await this.storage.setItem(this.TOKEN_KEY, data.token);
            await this.storage.setItem(this.EXPIRES_KEY, expiresAt.toString());
          } else {
            localStorage.setItem(this.TOKEN_KEY, data.token);
            localStorage.setItem(this.EXPIRES_KEY, expiresAt.toString());
          }

          console.log("Keepwork Token已保存，过期时间:", new Date(expiresAt));
        }

        async saveMaisiToken(data) {
          const now = Date.now();
          const expiresAt = now + data.expiresIn * 1000; // 转换为毫秒

          if (this.isUsingProxy) {
            await this.storage.setItem(this.MAISI_TOKEN_KEY, data.accessToken);
            await this.storage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString());
          } else {
            localStorage.setItem(this.MAISI_TOKEN_KEY, data.accessToken);
            localStorage.setItem(this.MAISI_EXPIRES_KEY, expiresAt.toString());
          }

          console.log("麦思Token已保存，过期时间:", new Date(expiresAt));
        } // 获取访问令牌
        async getAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.TOKEN_KEY);
          } else {
            return localStorage.getItem(this.TOKEN_KEY);
          }
        }

        async getMaisiAccessToken() {
          if (this.isUsingProxy) {
            return await this.storage.getItem(this.MAISI_TOKEN_KEY);
          } else {
            return localStorage.getItem(this.MAISI_TOKEN_KEY);
          }
        } // 检查token是否有效
        async isTokenValid() {
          let token, expiresAt;

          if (this.isUsingProxy) {
            token = await this.getAccessToken();
            expiresAt = await this.storage.getItem(this.EXPIRES_KEY);
          } else {
            token = await this.getAccessToken();
            expiresAt = localStorage.getItem(this.EXPIRES_KEY);
          }

          if (!token || !expiresAt) {
            return false;
          }

          const now = Date.now();
          const expires = parseInt(expiresAt);

          // 提前5分钟判断过期（安全边际）
          return now < expires - 5 * 60 * 1000;
        }
        async isMaisiTokenValid() {
          let token, expiresAt;

          if (this.isUsingProxy) {
            token = await this.getMaisiAccessToken();
            expiresAt = await this.storage.getItem(this.MAISI_EXPIRES_KEY);
          } else {
            token = await this.getMaisiAccessToken();
            expiresAt = localStorage.getItem(this.MAISI_EXPIRES_KEY);
          }

          if (!token || !expiresAt) {
            return false;
          }

          const now = Date.now();
          const expires = parseInt(expiresAt);

          // 提前5分钟判断过期（安全边际）
          return now < expires - 5 * 60 * 1000;
        } // 清除所有token信息
        async clearTokens() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.TOKEN_KEY);
            await this.storage.removeItem(this.EXPIRES_KEY);
            await this.storage.removeItem(this.MAISI_TOKEN_KEY);
            await this.storage.removeItem(this.MAISI_EXPIRES_KEY);
            await this.storage.removeItem(this.USER_INFO_KEY);
            await this.storage.removeItem(this.DEV_PANEL_KEY);
          } else {
            localStorage.removeItem(this.TOKEN_KEY);
            localStorage.removeItem(this.EXPIRES_KEY);
            localStorage.removeItem(this.MAISI_TOKEN_KEY);
            localStorage.removeItem(this.MAISI_EXPIRES_KEY);
            localStorage.removeItem(this.USER_INFO_KEY);
            localStorage.removeItem(this.DEV_PANEL_KEY);
          }
        } // 保存用户信息
        async saveUserInfo(userInfo) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo));
          } else {
            localStorage.setItem(this.USER_INFO_KEY, JSON.stringify(userInfo));
          }
        }

        // 获取用户信息
        async getUserInfo() {
          let userInfo;

          if (this.isUsingProxy) {
            userInfo = await this.storage.getItem(this.USER_INFO_KEY);
          } else {
            userInfo = localStorage.getItem(this.USER_INFO_KEY);
          }

          return userInfo ? JSON.parse(userInfo) : null;
        } // 保存Developer Panel状态
        async saveDevPanelOptions(devOptions) {
          if (this.isUsingProxy) {
            await this.storage.setItem(this.DEV_PANEL_KEY, JSON.stringify(devOptions));
          } else {
            localStorage.setItem(this.DEV_PANEL_KEY, JSON.stringify(devOptions));
          }
        }

        // 获取Developer Panel状态
        async getDevPanelOptions() {
          let devOptionsStr;

          if (this.isUsingProxy) {
            devOptionsStr = await this.storage.getItem(this.DEV_PANEL_KEY);
          } else {
            devOptionsStr = localStorage.getItem(this.DEV_PANEL_KEY);
          }

          return devOptionsStr ? JSON.parse(devOptionsStr) : null;
        }

        // 清除Developer Panel状态
        async clearDevPanelOptions() {
          if (this.isUsingProxy) {
            await this.storage.removeItem(this.DEV_PANEL_KEY);
          } else {
            localStorage.removeItem(this.DEV_PANEL_KEY);
          }
        }
      } // 创建token管理器实例
      const tokenManager = new TokenManager();

      // 项目ID管理功能
      async function updateProjectId(value) {
        const projectId = value.trim() || DEFAULT_PROJECT_ID;
        devOptions.projectId = projectId;
        await tokenManager.saveDevPanelOptions(devOptions);

        // 如果项目ID不是默认值，自动启用显示开发面板选项
        if (projectId !== DEFAULT_PROJECT_ID) {
          devOptions.isShowDevPanelOnStart = true;
          document.getElementById("showDevPanelOnStart").checked = true;
          await tokenManager.saveDevPanelOptions(devOptions);
        }

        console.log("项目ID已更新为:", projectId);
      }

      async function selectProjectId(value) {
        if (value) {
          document.getElementById("projectIdInput").value = value;
          await updateProjectId(value);
          // 重置下拉列表为默认选择
          document.getElementById("projectIdSelect").value = "";
        }
      }

      async function toggleShowDevPanelOnStart(isEnabled) {
        devOptions.isShowDevPanelOnStart = isEnabled;
        await tokenManager.saveDevPanelOptions(devOptions);
        console.log("启动时显示开发面板:", isEnabled);
      }

      // 自动登录状态显示管理
      function showAutoLoginStatus(username, isDevPanelMode = false) {
        const statusDiv = document.getElementById("autoLoginStatus");
        const titleElement = document.getElementById("autoLoginTitle");
        const messageElement = document.getElementById("autoLoginMessage");
        const buttonsDiv = document.getElementById("autoLoginButtons");

        if (isDevPanelMode) {
          titleElement.textContent = "检测到登录状态";
          messageElement.innerHTML = `上次登录账号: <strong>${username}</strong><br/>选择操作方式`;
          buttonsDiv.style.display = "flex";
        } else {
          titleElement.textContent = "自动登录中";
          messageElement.innerHTML = `检测到上次登录账号: <strong>${username}</strong><br/>正在自动登录，请稍后...`;
          buttonsDiv.style.display = "none";
        }

        statusDiv.style.display = "block";
      }

      function hideAutoLoginStatus() {
        const statusDiv = document.getElementById("autoLoginStatus");
        statusDiv.style.display = "none";
      }

      function showLoginStatus() {
        const statusDiv = document.getElementById("autoLoginStatus");
        const titleElement = document.getElementById("autoLoginTitle");
        const messageElement = document.getElementById("autoLoginMessage");
        const buttonsDiv = document.getElementById("autoLoginButtons");

        titleElement.textContent = "登录中";
        messageElement.innerHTML = "正在处理登录请求，请稍后...";
        buttonsDiv.style.display = "none";
        statusDiv.style.display = "block";
      }
      async function proceedAutoLogin() {
        // 执行原有的自动登录逻辑
        await performAutoLogin();
      }

      // 执行自动登录的核心逻辑
      async function performAutoLogin() {
        try {
          const locationInfo = await getParentLocation();
          await navigateToMSGames(locationInfo.href);
        } catch (error) {
          console.error("自动登录失败:", error);
          hideAutoLoginStatus();
          showMessage("自动登录失败，请手动登录");
          showLoginForm();
        }
      }

      function cancelAutoLogin() {
        hideAutoLoginStatus();
        showLoginForm();
      } // 初始化开发面板状态
      async function initDevPanelState() {
        try {
          const savedOptions = await tokenManager.getDevPanelOptions();
          if (savedOptions) {
            devOptions = { ...devOptions, ...savedOptions };

            // 当项目ID不是默认值时，自动启用显示开发面板选项
            if (devOptions.projectId !== DEFAULT_PROJECT_ID) {
              devOptions.isShowDevPanelOnStart = true;
            }

            // 更新UI状态
            document.getElementById("useMaisiDev").checked = devOptions.isUseMaisiDevServer;
            document.getElementById("showDevContent").checked = devOptions.isShowDevContent;
            document.getElementById("showDevPanelOnStart").checked = devOptions.isShowDevPanelOnStart;
            document.getElementById("projectIdInput").value = devOptions.projectId || DEFAULT_PROJECT_ID;

            // 如果项目ID不是默认值或设置了显示开发面板，则显示开发面板
            if (devOptions.projectId !== DEFAULT_PROJECT_ID || devOptions.isShowDevPanelOnStart) {
              showDevPanel();
            }
          } else {
            // 没有保存的选项时，仍需要更新UI状态
            document.getElementById("useMaisiDev").checked = devOptions.isUseMaisiDevServer;
            document.getElementById("showDevContent").checked = devOptions.isShowDevContent;
            document.getElementById("showDevPanelOnStart").checked = devOptions.isShowDevPanelOnStart;
            document.getElementById("projectIdInput").value = devOptions.projectId || DEFAULT_PROJECT_ID;

            // 检查是否需要显示开发面板
            if (devOptions.projectId !== DEFAULT_PROJECT_ID || devOptions.isShowDevPanelOnStart) {
              showDevPanel();
            }
          }
        } catch (error) {
          console.error("初始化开发面板状态失败:", error);
        }
      }

      class KeepworkProxy {
        constructor() {
          this.requestId = 0;
          this.pendingRequests = new Map();
          this.debugMode = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";

          // 监听父页面的响应
          window.addEventListener("message", (event) => {
            if (event.data.type === "keepworkResponse") {
              const { requestId, success, data, error } = event.data;
              const request = this.pendingRequests.get(requestId);

              if (request) {
                this.pendingRequests.delete(requestId);
                if (this.debugMode) {
                  console.debug("KeepworkProxy response received:", { requestId, success, data, error });
                }
                if (success) {
                  request.resolve(data);
                } else {
                  request.reject(new Error(error));
                }
              }
            }
          });
        }

        _sendRequest(method, args = []) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId;

            this.pendingRequests.set(requestId, { resolve, reject });

            if (this.debugMode) {
              console.debug("KeepworkProxy sending request:", { method, args, requestId });
            }

            // 设置超时
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId);
                reject(new Error("Keepwork operation timeout"));
              }
            }, 10000); // keepwork操作可能需要更长时间

            // 发送请求到父页面
            window.parent.postMessage(
              {
                type: "keepwork",
                method,
                args,
                requestId,
              },
              "*"
            );
          });
        }

        // 通用方法调用
        async call(method, ...args) {
          return await this._sendRequest(method, args);
        }

        // 支持深层方法调用，如 keepwork.some.deep.method
        _createProxy(basePath = "") {
          return new Proxy(this, {
            get: (target, prop) => {
              if (typeof prop === "string" && !prop.startsWith("_") && prop !== "constructor") {
                const fullPath = basePath ? basePath + "." + prop : prop;

                // 如果是已定义的方法，直接返回
                if (target[prop] && typeof target[prop] === "function") {
                  return target[prop].bind(target);
                }

                // 如果是已定义的属性，直接返回
                if (target[prop]) {
                  return target[prop];
                }

                // 否则创建一个新的代理
                return this._createProxy(fullPath);
              }
              return target[prop];
            },
            apply: (target, thisArg, argArray) => {
              // 当作为函数调用时，执行远程方法调用
              return target._sendRequest(basePath, argArray);
            },
          });
        }

        // 创建代理实例
        createProxy() {
          return this._createProxy();
        }
      }
      window.parentKeepwork = new KeepworkProxy().createProxy();

      

      // 获取父窗口Location信息Promise存储
      let getLocationResolve = null;
      let getLocationReject = null; // 初始化游戏标题显示
      function initGameTitle(locationInfo) {
        const urlParams = new URLSearchParams((locationInfo || window.location).search);
        const loginGameTitle = urlParams.get("loginGameTitle");

        if (loginGameTitle) {
          const gameTitleElement = document.getElementById("gameTitle");
          if (gameTitleElement) {
            gameTitleElement.textContent = decodeURIComponent(loginGameTitle);
            gameTitleElement.style.display = "block";
          }
        }
      }

      // 初始化游客模式
      function initGuestMode(locationInfo) {
        const urlParams = new URLSearchParams((locationInfo || window.location).search);
        const allowGuestMode = urlParams.get("allowGuestMode");

        if (allowGuestMode === "true") {
          // 为手机号登录表单添加游客登录按钮
          const phoneButtonContainer = document.getElementById("phoneButtonContainer");
          if (phoneButtonContainer && !document.getElementById("phoneGuestBtn")) {
            const guestBtn = document.createElement("button");
            guestBtn.type = "button";
            guestBtn.className = "guest-login-btn";
            guestBtn.id = "phoneGuestBtn";
            guestBtn.textContent = "游客登录";
            guestBtn.onclick = guestLogin;
            phoneButtonContainer.appendChild(guestBtn);
          }

          // 为用户名密码登录表单添加游客登录按钮
          const usernameButtonContainer = document.getElementById("usernameButtonContainer");
          if (usernameButtonContainer && !document.getElementById("usernameGuestBtn")) {
            const guestBtn = document.createElement("button");
            guestBtn.type = "button";
            guestBtn.className = "guest-login-btn";
            guestBtn.id = "usernameGuestBtn";
            guestBtn.textContent = "游客登录";
            guestBtn.onclick = guestLogin;
            usernameButtonContainer.appendChild(guestBtn);
          }
        }
      }

      // 游客登录功能
      async function guestLogin() {
        try {
          showMessage("正在以游客身份登录...");
          // Forward all existing URL parameters plus the new objective parameter
          const urlParams = new URLSearchParams(window.location.search);

          // replace current href's wiki_dashboard with characterAI.
          let url = window.location.href;
          url = url.split("?")[0];
          url = url.replace("ms_games_login", urlParams.get("loginGameName") || "");

          url = `${url}?${urlParams.toString()}`;
          window.location.replace(url);
        } catch (error) {
          console.error("游客登录失败:", error);
          showMessage("游客登录失败，请重试");
        }
      }
      // 页面加载时初始化游戏标题和检查登录状态
      checkLoginStatus();

      // Initialize developer mode
      initDevMode();

      // Markdown转HTML的简单实现
      function markdownToHtml(markdown) {
        if (!markdown) return "";

        let html = markdown
          // 标题转换
          .replace(/^### (.*$)/gim, "<h3>$1</h3>")
          .replace(/^## (.*$)/gim, "<h2>$1</h2>")
          .replace(/^# (.*$)/gim, "<h1>$1</h1>")
          // 粗体
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/__(.*?)__/g, "<strong>$1</strong>")
          // 斜体
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/_(.*?)_/g, "<em>$1</em>")
          // 代码
          .replace(/`(.*?)`/g, "<code>$1</code>")
          // 链接
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          // 列表
          .replace(/^[\s]*\*[\s]+(.*$)/gim, "<li>$1</li>")
          .replace(/^[\s]*\d+\.[\s]+(.*$)/gim, "<li>$1</li>")
          // 段落
          .replace(/\n\n/g, "</p><p>")
          .replace(/\n/g, "<br>");

        // 包装列表项
        html = html.replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>");

        // 包装段落
        if (!html.startsWith("<h") && !html.startsWith("<ul") && !html.startsWith("<ol")) {
          html = "<p>" + html + "</p>";
        }

        return html;
      }

      // 打开隐私政策弹窗
      async function openPrivacyModal() {
        const modal = document.getElementById("privacyModal");
        const content = document.getElementById("privacyContent");

        modal.style.display = "block";
        content.innerHTML = '<div class="modal-loading">正在加载隐私政策...</div>';

        try {
          const response = await fetch("https://cross.keepwork.com/api/raw/maisi/maisi/docs/privacy");
          const markdown = await response.text();
          const html = markdownToHtml(markdown);
          hideAutoLoginStatus();
          content.innerHTML = html;
        } catch (error) {
          console.error("加载隐私政策失败:", error);
          content.innerHTML = '<p style="color: #ef4444;">加载失败，请稍后重试</p>';
          hideAutoLoginStatus();
        }
      }

      // 打开用户协议弹窗
      async function openLicenseModal() {
        const modal = document.getElementById("licenseModal");
        const content = document.getElementById("licenseContent");

        modal.style.display = "block";
        content.innerHTML = '<div class="modal-loading">正在加载用户协议...</div>';

        try {
          const response = await fetch("https://cross.keepwork.com/api/raw/maisi/maisi/docs/license");
          const markdown = await response.text();
          const html = markdownToHtml(markdown);
          content.innerHTML = html;
        } catch (error) {
          console.error("加载用户协议失败:", error);
          content.innerHTML = '<p style="color: #ef4444;">加载失败，请稍后重试</p>';
        }
      }      // 关闭弹窗
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // 打开注册弹窗
      function openRegisterModal() {
        const modal = document.getElementById("registerModal");
        const iframe = document.getElementById("register_iframe");
        
        // 设置iframe源
        const currentUrl = new URL(window.location.href);
        const baseUrl = currentUrl.origin + currentUrl.pathname.replace('ms_games_login', 'ms_games_register');
        iframe.src = baseUrl;
        
        // 显示modal
        modal.style.display = "block";
      }

      // 关闭注册弹窗
      function closeRegisterModal() {
        const modal = document.getElementById("registerModal");
        const iframe = document.getElementById("register_iframe");
        
        // 隐藏modal
        modal.style.display = "none";
        
        // 清空iframe源以节省资源
        iframe.src = "";
      }

      // 同意隐私政策按钮：关闭弹窗并勾选外部复选框
      function privacyAgree() {
        try {
          const cb1 = document.getElementById("agreementCheckbox");
          const cb2 = document.getElementById("agreementCheckbox2");
          if (cb1) cb1.checked = true;
          if (cb2) cb2.checked = true;
        } catch (e) {
          console.warn("设置复选框状态失败", e);
        }
        closeModal("privacyModal");
      }

      // 拒绝隐私政策按钮：仅关闭弹窗
      function privacyReject() {
        try {
          const cb1 = document.getElementById("agreementCheckbox");
          const cb2 = document.getElementById("agreementCheckbox2");
          if (cb1) cb1.checked = false;
          if (cb2) cb2.checked = false;
        } catch (e) {
          console.warn("设置复选框状态失败", e);
        }
        closeModal("privacyModal");
      } // 检查登录状态
      async function checkLoginStatus() {
        let isNeedCheck = true;
        let locationInfo = null;

        try {
          locationInfo = await getParentLocation();
          if (new URLSearchParams(locationInfo.search).get("showType") === "logout") {
            console.log("用户登出");
            await tokenManager.clearTokens();
            isNeedCheck = false;
          }
        } catch (_) {}

        initGameTitle(locationInfo);
        initGuestMode(locationInfo);

        // 初始化开发面板状态
        await initDevPanelState();

        if (!isNeedCheck || !locationInfo) return;

        console.log("检查登录状态...");
        if (await tokenManager.isTokenValid()) {
          console.log("用户已登录，token有效"); // 更新maisiApi的baseUrl（devOptions已在initDevPanelState中恢复）
          if (devOptions.isUseMaisiDevServer) {
            maisiApi.setBaseUrl("https://maseai-be-qa1.langcong.com/api/v1");
          }

          // 检查是否需要显示开发面板模式
          const userInfo = await tokenManager.getUserInfo();
          const username = userInfo?.username || userInfo?.phone || "用户";
          
          // 有效token视为已同意并登录过
          markPrivacyConsent();
          let bAllowCancelAutoLogin = devOptions.isShowDevPanelOnStart || devOptions.projectId !== DEFAULT_PROJECT_ID || window.parent === window;

          if (bAllowCancelAutoLogin) {
            // 显示开发面板模式，让用户选择自动登录或返回
            showAutoLoginStatus(username, true);
          } else {
            // 普通模式，直接自动登录
            showAutoLoginStatus(username, false);
          }
          if (!(await tokenManager.isMaisiTokenValid())) {
            console.log("Maisi token已过期，重新获取");
            const header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            };
            try {
              const response = await api.post(
                "/oauth/getMaisiToken",
                {
                  phone: userInfo?.phone || "",
                  from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                },
                header
              );
              await tokenManager.saveMaisiToken(response.token);
              console.log("Maisi token已更新");
            } catch (error) {
              console.error("获取Maisi token失败:", error);
            }
          }

          if (!bAllowCancelAutoLogin) {
            // 普通模式，直接自动登录
            setTimeout(async () => {
              await performAutoLogin();
            }, 300);
          }
        } else {
          console.log("用户未登录或token已过期");
          await tokenManager.clearTokens();
          showLoginForm();

          // 即使没有登录，如果设置了显示开发面板，仍然要显示
          if (devOptions.isShowDevPanelOnStart || devOptions.projectId !== DEFAULT_PROJECT_ID) {
            showDevPanel();
          }
        }
      }

      function getParentLocationWithTimeout(timeout = 1000) {
        if (window.parent !== window) {
          setTimeout(() => {
            window.parent.postMessage({ type: "getLocation" }, "*");
          }, timeout);
        } else {
          setTimeout(() => {
            navigateToMSGames();
          }, timeout);
        }
      }

      async function navigateToMSGames(href) {
        let originalUrl;
        try {
          originalUrl = new URL(href, window.location.href);
        } catch (e) {
          originalUrl = new URL(window.location.href);
        }
        let loginGameName = originalUrl.searchParams.get("loginGameName");
        let targetHref = href;
        if (!loginGameName) {
          const projectId = devOptions.projectId || DEFAULT_PROJECT_ID;
          targetHref = `https://keepwork.com/api/public/paracraft/index_release_html?pid=${projectId}&customLoader=https%3A%2F%2Fkeepwork.com%2Fmaisi%2Fmaisi%2Fwebgames%2Fdata%2Fcustom_loader1`;
        }

        const url = new URL(targetHref);

        for (const [key, value] of originalUrl.searchParams.entries()) {
          url.searchParams.set(key, value);
        }
        const accessToken = (await tokenManager.getAccessToken()) || "";
        if (!loginGameName) {
          url.searchParams.set("token", accessToken);
        } else {
          url.searchParams.set("gameName", loginGameName || "ms_games");
        }
        if (devOptions.isShowDevContent) {
          url.searchParams.set("dev", "true");
        }
        if (devOptions.isUseMaisiDevServer) {
          url.searchParams.set("isUseMaisiDevServer", "true");
        }

        if (window.parent !== window) {
          await window.parentKeepwork.call("setToken", accessToken);
          await window.parentKeepwork.call("getUserProfile");

          const userInfo = await tokenManager.getUserInfo();
          const username = userInfo?.username || "";
          const phone = userInfo?.phone || "";
          const maToken = (await tokenManager.getMaisiAccessToken()) || "";

          url.searchParams.set("username", username);
          url.searchParams.set("phone", phone);
          url.searchParams.set("thirdpartytoken", maToken);

          const platform = await getParacraftPlatform();
          if (platform) {
            url.searchParams.set("paracraftPlatform", platform);
          }

          const response = await getMsUserInfo();
          if (response && response.data) {
            url.searchParams.set("isMaisiTestCompleted", true);
          }

          try {
            const keepworkUser = (await window.parentKeepwork.call("personalPageStore.loadPageData", "maisi_userinfo", "user")) || {};
            const maisiUserInfo = response.data;
            if (maisiUserInfo && maisiUserInfo.birthday && keepworkUser.birthday != maisiUserInfo.birthday) {
              keepworkUser.birthday = maisiUserInfo.birthday;
              keepworkUser.gender = maisiUserInfo.sex;
              keepworkUser.vip = maisiUserInfo.vip;
              keepworkUser.grade = maisiUserInfo.grade;
              keepworkUser.age = calculateAge(keepworkUser.birthday);
              window.parentKeepwork.call("personalPageStore.savePageData", "maisi_userinfo", "user", keepworkUser, true);
            }

            if (keepworkUser.birthday === undefined) {
              hideAutoLoginStatus();
              showUserSetting();
              return;
            }
          } catch (e) {
            console.log("获取Maisi用户信息失败:", e);
          }

          // console.log('跳转到MS游戏页面:', url.toString());
          window.parent.postMessage(
            {
              type: "navigate",
              url: url.toString(),
            },
            "*"
          );
        } else {
          window.location.href = url.toString();
        }
      }

      // 显示已登录状态
      async function showLoggedInState() {
        const userInfo = await tokenManager.getUserInfo();
        const phone = userInfo ? userInfo.phone : "用户";

        // 隐藏登录表单，显示已登录信息
        document.querySelector(".login-form").style.display = "none";
        document.querySelector(".tips").innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 24px; color: #667eea; margin-bottom: 20px;">
                        欢迎回来！${phone}
                    </p>
                    <button onclick="logout()" style="
                        padding: 12px 24px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                    ">退出登录</button>
                    <button onclick="goToMain()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: 15px;
                    ">进入主页</button>
                </div>
            `;
      }

      // 显示登录表单
      function showLoginForm() {
        document.getElementById("usernameLoginForm").style.display = "block";
        document.querySelector(".tips").style.display = "none";
      }

      // 退出登录
      async function logout() {
        await tokenManager.clearTokens();
        showLoginForm();
        showMessage("已退出登录");
      }

      // 跳转到主页
      function goToMain() {
        getParentLocationWithTimeout(0);
      }

      // 手机号验证
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
      }

      // 验证码验证
      function validateCode(code) {
        return /^\d{4}$/.test(code);
      }

      // 显示错误信息
      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.add("error");
        error.textContent = message;
        error.style.display = "block";
      }

      // 隐藏错误信息
      function hideError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.remove("error");
        error.style.display = "none";
      }

      // 倒计时功能
      function startCountdown(btn, seconds = 60) {
        btn.disabled = true;
        let remaining = seconds;

        const timer = setInterval(() => {
          btn.textContent = `${remaining}s后重试`;
          remaining--;

          if (remaining < 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = "获取验证码";
          }
        }, 1000);
      }

      // 显示消息提示
      function showMessage(message) {
        // 检查是否已有提示元素
        let existingToast = document.querySelector(".toast");

        if (existingToast) {
          // 更新现有元素的文本内容
          existingToast.textContent = message;

          // 清除现有的定时器（如果有的话）
          if (existingToast.hideTimer) {
            clearTimeout(existingToast.hideTimer);
          }

          // 重新设置定时器
          existingToast.hideTimer = setTimeout(() => {
            if (existingToast && existingToast.parentNode) {
              document.body.removeChild(existingToast);
            }
          }, 2000);
        } else {
          // 创建新的提示元素
          const toast = document.createElement("div");
          toast.className = "toast";
          toast.textContent = message;

          document.body.appendChild(toast);

          // 设置定时器并保存引用
          toast.hideTimer = setTimeout(() => {
            if (toast && toast.parentNode) {
              document.body.removeChild(toast);
            }
          }, 2000);
        }
      }
      // 切换到手机号登录
      function switchToPhoneLogin() {
        const phoneForm = document.getElementById("phoneLoginForm");
        const usernameForm = document.getElementById("usernameLoginForm");
        const phoneBtn = document.getElementById("phoneLoginBtn");
        const usernameBtn = document.getElementById("usernameLoginBtn");

        phoneForm.style.display = "block";
        usernameForm.style.display = "none";
        phoneBtn.classList.add("active");
        usernameBtn.classList.remove("active");
      }

      // 切换到用户名密码登录
      function switchToUsernameLogin() {
        const phoneForm = document.getElementById("phoneLoginForm");
        const usernameForm = document.getElementById("usernameLoginForm");
        const phoneBtn = document.getElementById("phoneLoginBtn");
        const usernameBtn = document.getElementById("usernameLoginBtn");

        phoneForm.style.display = "none";
        usernameForm.style.display = "block";
        phoneBtn.classList.remove("active");
        usernameBtn.classList.add("active");
      }

      // 验证用户名
      function validateUsername(username) {
        return username && username.trim().length > 0;
      }

      // 验证密码
      function validatePassword(password) {
        return password && password.trim().length >= 6;
      }

      // DOM 元素
      const phoneInput = document.getElementById("phoneInput");
      const codeInput = document.getElementById("codeInput");
      const verifyBtn = document.getElementById("verifyBtn");
      const phoneLoginForm = document.getElementById("phoneLoginForm");
      const usernameLoginForm = document.getElementById("usernameLoginForm");
      const agreementCheckbox = document.getElementById("agreementCheckbox");
      const agreementCheckbox2 = document.getElementById("agreementCheckbox2");
      const usernameInput = document.getElementById("usernameInput");
      const passwordInput = document.getElementById("passwordInput");

      // 协议整行点击切换复选框（点击具体链接除外）
      document.querySelectorAll(".agreement-section .agreement-text").forEach((container) => {
        container.addEventListener("click", (e) => {
          if (e.target.closest(".agreement-link")) return; // 点击链接不切换
          const checkbox = container.parentElement.querySelector(".agreement-checkbox");
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
          }
        });
      });

      // 手机号输入事件
      phoneInput.addEventListener("input", function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("phoneInput", "phoneError");
      });

      // 验证码输入事件
      codeInput.addEventListener("input", function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("codeInput", "codeError");
      });

      // 获取验证码
      verifyBtn.addEventListener("click", async function () {
        const phone = phoneInput.value.trim();

        if (!validatePhone(phone)) {
          showError("phoneInput", "phoneError", "请输入正确的手机号码");
          phoneInput.focus();
          return;
        }

        try {
          // 使用封装的API方法发送验证码
          const response = await api.get("/users/cellphone_captcha", {
            cellphone: phone,
          });

          console.log("发送验证码响应:", response);

          // 开始倒计时
          startCountdown(verifyBtn);
          showMessage("验证码已发送，请注意查收");
        } catch (error) {
          console.error("发送验证码失败:", error);
          let errorMessage = "发送验证码失败，请稍后重试";

          if (error.message.includes("429")) {
            errorMessage = "发送过于频繁，请稍后再试";
          } else if (error.message.includes("400")) {
            errorMessage = "手机号格式错误";
          }

          showMessage(errorMessage);
        }
      }); // 表单提交
      phoneLoginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = phoneInput.value.trim();
        const code = codeInput.value.trim();

        // 验证手机号
        if (!validatePhone(phone)) {
          showError("phoneInput", "phoneError", "请输入正确的手机号码");
          return;
        }

        // 验证验证码
        if (!validateCode(code)) {
          showError("codeInput", "codeError", "请输入4位数字验证码");
          return;
        }

        // 验证是否同意条款
        if (!agreementCheckbox.checked) {
          showMessage("请勾选同意隐私政策和用户协议");
          return;
        }

        // 使用封装的API方法进行登录
        const loginBtn = document.querySelector("#phoneLoginForm .login-btn");
        loginBtn.disabled = true;
        loginBtn.textContent = "登录中...";
        showLoginStatus();

        try {
          const response1 = await api.post("/users/cellphone_captcha_verify", {
            cellphone: phone,
            captcha: code,
          });

          console.log("验证码验证响应:", response1);
          if (response1.verify) {
            const response2 = await api.post("/users/cellphoneLoginRegister", {
              cellphone: phone,
              captcha: code,
              channel: 60,
            });
            console.log("登录响应:", response2);

            // 保存登录信息
            if (response2 && response2.token) {
              await tokenManager.saveTokens(response2);

              // 保存用户信息
              await tokenManager.saveUserInfo({
                phone: phone,
                loginTime: new Date().toISOString(),
              });

              // 保存Developer Panel状态
              await tokenManager.saveDevPanelOptions(devOptions);

              // 尝试获取麦思Token（不影响主流程）
              if (!(await tokenManager.getMaisiAccessToken())) {
                try {
                  const header = {
                    Authorization: `Bearer ${response2.token}`,
                  };
                  const response3 = await api.post(
                    "/oauth/getMaisiToken",
                    {
                      phone: phone,
                      from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                    },
                    header
                  );
                  console.log("获取麦思Token响应:", response3);
                  await tokenManager.saveMaisiToken(response3.token);
                } catch (error) {
                  console.warn("获取麦思Token失败:", error);
                }
              }

              // 登录成功后记录隐私政策同意
              markPrivacyConsent();

              //  判断海外用户
              if ((response2.lastLoginEduOrgId && response2.lastLoginEduOrgId > 0) || response2.channel == 11) {
                // 海外用户，直接跳转
                getParentLocationWithTimeout();
                return;
              }

              // 手机号登录默认已实名，显示实名认证通知
              checkRealnameNoticeStatus()
                .then((hasShown) => {
                  if (!hasShown) {
                    // 未显示过实名通知，显示一次并标记
                    markRealnameNoticeShown();
                    showRealnameNotice(phone);
                  } else {
                    // 已显示过实名通知，直接跳转
                    getParentLocationWithTimeout();
                  }
                })
                .catch((error) => {
                  console.warn("检查实名通知状态失败，直接显示实名通知:", error);
                  // 检查失败时，直接显示实名通知
                  showRealnameNotice(phone);
                });
            } else {
              throw new Error("登录失败，未获取到有效token");
            }
          } else {
            throw new Error("验证码验证失败");
          }
        } catch (error) {
          console.error("登录失败:", error);
          let errorMessage = "登录失败，请稍后重试";

          if (error.message) {
            errorMessage = error.message;
          }

          showMessage(errorMessage);
        } finally {
          // 重置按钮状态
          hideAutoLoginStatus();
          loginBtn.disabled = false;
          loginBtn.textContent = "登录/注册";
        }
      });

      // 用户名密码登录表单提交
      usernameLoginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        // 验证用户名
        if (!validateUsername(username)) {
          showError("usernameInput", "usernameError", "请输入用户名或邮箱");
          return;
        }

        // 验证密码
        if (!validatePassword(password)) {
          showError("passwordInput", "passwordError", "密码至少6位");
          return;
        }

        // 验证是否同意条款
        if (!agreementCheckbox2.checked) {
          showMessage("请勾选同意隐私政策和用户协议");
          return;
        }

        // 使用封装的API方法进行登录
        const loginBtn = document.querySelector("#usernameLoginForm .login-btn");
        loginBtn.disabled = true;
        loginBtn.textContent = "登录中...";
        showLoginStatus();

        try {
          let response2 = await api.post("/users/login", {
            username: username,
            password: password,
            platform: "WEB",
          });

          console.log("用户名密码登录响应:", response2);

          // 保存登录信息
          if (response2 && response2.token) {
            await tokenManager.saveTokens(response2);

            // 保存用户信息
            await tokenManager.saveUserInfo({
              username: response2.username,
              phone: response2.cellphone,
              realname: response2.realname,
              loginTime: new Date().toISOString(),
            });

            // 保存Developer Panel状态
            await tokenManager.saveDevPanelOptions(devOptions);

            // 尝试获取麦思Token（不影响主流程）
            if (!(await tokenManager.getMaisiAccessToken()) && response2.cellphone) {
              try {
                const header = {
                  Authorization: `Bearer ${response2.token}`,
                };
                const response3 = await api.post(
                  "/oauth/getMaisiToken",
                  {
                    phone: response2.cellphone,
                    from: devOptions.isUseMaisiDevServer ? "dev" : "prod",
                  },
                  header
                );
                console.log("获取麦思Token响应:", response3);
                await tokenManager.saveMaisiToken(response3.token);
              } catch (error) {
                console.warn("获取麦思Token失败:", error);
              }
            }

            // 登录成功后记录隐私政策同意
            markPrivacyConsent();

            //  判断海外用户
            if ((response2.lastLoginEduOrgId && response2.lastLoginEduOrgId > 0) || response2.channel == 11) {
              // 海外用户，直接跳转
              getParentLocationWithTimeout();
              return;
            }

            // 检查实名认证状态
            if (!(devOptions.isUseMaisiDevServer || devOptions.isShowDevContent) && (!response2.realname || response2.realname.trim() === "")) {
              // 未实名，显示实名认证窗口
              showRealnameModal();
            } else {
              // 已实名，检查是否显示过实名通知
              checkRealnameNoticeStatus()
                .then((hasShown) => {
                  if (!hasShown) {
                    // 未显示过实名通知，显示一次并标记
                    markRealnameNoticeShown();
                    showRealnameNotice(response2.realname);
                  } else {
                    // 已显示过实名通知，直接跳转
                    getParentLocationWithTimeout();
                  }
                })
                .catch((error) => {
                  console.warn("检查实名通知状态失败，直接显示实名通知:", error);
                  // 检查失败时，直接显示实名通知
                  showRealnameNotice(response2.realname);
                });
            }
          } else {
            throw new Error("登录失败，未获取到有效token");
          }
        } catch (error) {
          console.error("用户名密码登录失败:", error);
          let errorMessage = "用户名或密码错误";

          if (error.message && error.message.includes("网络")) {
            errorMessage = "网络连接失败，请稍后重试";
          }
          hideAutoLoginStatus();
          showMessage(errorMessage);
        } finally {
          // 重置按钮状态
          loginBtn.disabled = false;
          loginBtn.textContent = "登录";
        }
      });

      // 阻止页面缩放
      document.addEventListener(
        "touchstart",
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        },
        { passive: false }
      );

      // 阻止双击缩放
      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (e) {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            e.preventDefault();
          }
          lastTouchEnd = now;
        },
        false
      );

      // Paracraft平台获取Promise存储
      let paracraftPlatformResolve = null;
      let paracraftPlatformReject = null;

      // 获取Paracraft平台信息的封装方法
      async function getParacraftPlatform() {
        return new Promise((resolve, reject) => {
          paracraftPlatformResolve = resolve;
          paracraftPlatformReject = reject;

          // 发送获取平台信息的消息
          window.parent.postMessage({ type: "getParacraftPlatform" }, "*");

          // 设置超时处理
          setTimeout(() => {
            if (paracraftPlatformReject) {
              paracraftPlatformReject(new Error("获取Paracraft平台信息超时"));
              paracraftPlatformResolve = null;
              paracraftPlatformReject = null;
            }
          }, 1000); // 1秒超时
        });
      }

      // 获取父窗口Location信息的封装方法
      async function getParentLocation() {
        if(window.parent === window) {
          return {
            href: window.location.href,
            pathname: window.location.pathname,
            search: window.location.search,
          };
        }
        return new Promise((resolve, reject) => {
          getLocationResolve = resolve;
          getLocationReject = reject;

          // 发送获取Location信息的消息
          getParentLocationWithTimeout(0);

          // 设置超时处理
          setTimeout(() => {
            if (getLocationReject) {
              getLocationReject(new Error("获取父窗口Location信息超时"));
              getLocationResolve = null;
              getLocationReject = null;
            }
          }, 3000); // 3秒超时
        });
      }

      function toggleMaisiDevServer(isEnabled) {
        devOptions.isUseMaisiDevServer = isEnabled;
        maisiApi.setBaseUrl(isEnabled ? "https://maseai-be-qa1.langcong.com/api/v1" : "https://be.maseai.com/api/v1");
        console.log("Maisi Dev服务:", isEnabled ? "已启用" : "已禁用");

        // 保存Developer Panel状态到缓存
        tokenManager.saveDevPanelOptions(devOptions).catch((error) => {
          console.warn("保存Developer Panel状态失败:", error);
        });
      }

      function toggleShowDevContent(isEnabled) {
        devOptions.isShowDevContent = isEnabled;
        console.log("显示Dev内容:", isEnabled ? "已启用" : "已禁用");

        // 保存Developer Panel状态到缓存
        tokenManager.saveDevPanelOptions(devOptions).catch((error) => {
          console.warn("保存Developer Panel状态失败:", error);
        });
      }

      window.addEventListener("message", async function (event) {
        switch (event.data.type) {
          case "locationResponse":
            // 处理getParentLocation的响应
            if (getLocationResolve) {
              getLocationResolve({
                href: event.data.href,
                pathname: event.data.pathname,
                search: event.data.search,
              });
              getLocationResolve = null;
              getLocationReject = null;
            } else {
              // 兼容原有的导航逻辑
              await navigateToMSGames(event.data.href);
            }
            break;
          case "paracraftPlatformResponse":
            if (paracraftPlatformResolve) {
              paracraftPlatformResolve(event.data.platform);
              paracraftPlatformResolve = null;
              paracraftPlatformReject = null;
            }
            break;
          case "registerSuccess":
            // 注册成功，关闭注册弹窗并显示登录表单
            closeRegisterModal();
            showLoginForm();
            if (event.data.username) {
              phoneInput.value = event.data.username;
            }
            switchToUsernameLogin();
            break;
          case "userProfileCreated":
            saveUserProfile({
              age: event.data.age,
              gender: event.data.gender,
              grade: event.data.grade,
            });
            break;
        }
      });

      // =============== 隐私政策自动展示逻辑（需登录且勾选后才停止弹出） ===============
      const PRIVACY_CONSENT_KEY = "maisi_privacy_consent_loggedin_v1";
      async function markPrivacyConsent() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            await window.parentLocalStorage.setItem(PRIVACY_CONSENT_KEY, "true");
          } else {
            localStorage.setItem(PRIVACY_CONSENT_KEY, "true");
          }
        } catch (e) {
          console.warn("记录隐私同意状态失败", e);
        }
      }

      async function hasPrivacyConsent() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            return (await window.parentLocalStorage.getItem(PRIVACY_CONSENT_KEY)) === "true";
          } else {
            return localStorage.getItem(PRIVACY_CONSENT_KEY) === "true";
          }
        } catch (e) {
          console.warn("读取隐私同意状态失败", e);
          return false;
        }
      }

      // 实名通知状态管理
      const REALNAME_NOTICE_KEY = "hasShownRealnameNotice";
      async function markRealnameNoticeShown() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            await window.parentLocalStorage.setItem(REALNAME_NOTICE_KEY, "true");
          } else {
            localStorage.setItem(REALNAME_NOTICE_KEY, "true");
          }
        } catch (e) {
          console.warn("记录实名通知状态失败", e);
        }
      }

      async function checkRealnameNoticeStatus() {
        try {
          const isUsingProxy = window.parent !== window && window.parentLocalStorage;
          if (isUsingProxy) {
            return (await window.parentLocalStorage.getItem(REALNAME_NOTICE_KEY)) === "true";
          } else {
            return localStorage.getItem(REALNAME_NOTICE_KEY) === "true";
          }
        } catch (e) {
          console.warn("读取实名通知状态失败", e);
          return false;
        }
      }

      async function maybeShowPrivacyPolicy() {
        if (await hasPrivacyConsent()) return;
        // 未有同意记录 -> 自动弹出，但不写入同意标记，等待用户登录成功后再标记
        openPrivacyModal();
      }

      // 在页面脚本尾部触发（checkLoginStatus 已在前面调用，会在自动登录时写入同意标记）
      maybeShowPrivacyPolicy();
      // ==================================================================

      // =============== 实名认证相关功能 ===============

      // 显示实名认证通知弹窗（手机号登录时使用）
      function showRealnameNotice(phoneNumber = "") {
        const modal = document.getElementById("realnameNoticeModal");
        const textElement = document.getElementById("realnameNoticeText");

        if (phoneNumber) {
          // 格式化手机号显示（中间4位用*号替换）
          const maskedPhone = phoneNumber.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
          textElement.innerHTML = `您已使用手机号 ${maskedPhone} 完成认证<br>可以正常使用所有功能`;
        } else {
          textElement.innerHTML = "您已完成实名认证<br>可以正常使用所有功能";
        }

        modal.style.display = "block";
      }

      // 显示实名认证窗口（账号密码登录未实名时使用）
      function showRealnameModal() {
        const modal = document.getElementById("realnameModal");
        modal.style.display = "block";
      }

      // 关闭实名通知弹窗并继续跳转
      function closeRealnameNoticeAndContinue() {
        closeModal("realnameNoticeModal");
        getParentLocationWithTimeout(500);
      }

      // 实名认证表单相关元素
      const realnamePhoneInput = document.getElementById("realnamePhoneInput");
      const realnameCodeInput = document.getElementById("realnameCodeInput");
      const realnameVerifyBtn = document.getElementById("realnameVerifyBtn");
      const realnameForm = document.getElementById("realnameForm");

      // 实名认证手机号输入事件
      realnamePhoneInput.addEventListener("input", function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("realnamePhoneInput", "realnamePhoneError");
      });

      // 实名认证验证码输入事件
      realnameCodeInput.addEventListener("input", function (e) {
        // 只允许输入数字
        e.target.value = e.target.value.replace(/\D/g, "");
        hideError("realnameCodeInput", "realnameCodeError");
      });

      // 实名认证获取验证码
      realnameVerifyBtn.addEventListener("click", async function () {
        const phone = realnamePhoneInput.value.trim();

        if (!validatePhone(phone)) {
          showError("realnamePhoneInput", "realnamePhoneError", "请输入正确的手机号码");
          realnamePhoneInput.focus();
          return;
        }

        try {
          // 使用封装的API方法发送验证码
          const response = await api.get("/users/cellphone_captcha", {
            cellphone: phone,
          });

          console.log("实名认证发送验证码响应:", response);

          // 开始倒计时
          startCountdown(realnameVerifyBtn);
          showMessage("验证码已发送，请注意查收");
        } catch (error) {
          console.error("实名认证发送验证码失败:", error);
          let errorMessage = "发送验证码失败，请稍后重试";

          if (error.message.includes("429")) {
            errorMessage = "发送过于频繁，请稍后再试";
          } else if (error.message.includes("400")) {
            errorMessage = "手机号格式错误";
          }

          showMessage(errorMessage);
        }
      });

      // 实名认证表单提交
      realnameForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = realnamePhoneInput.value.trim();
        const code = realnameCodeInput.value.trim();

        // 验证手机号
        if (!validatePhone(phone)) {
          showError("realnamePhoneInput", "realnamePhoneError", "请输入正确的手机号码");
          return;
        }

        // 验证验证码
        if (!validateCode(code)) {
          showError("realnameCodeInput", "realnameCodeError", "请输入4位数字验证码");
          return;
        }

        const submitBtn = realnameForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "认证中...";

        try {
          let params_header = {};
          if (await tokenManager.isTokenValid()) {
            console.log("用户已登录，token有效");
            params_header = {
              Authorization: `Bearer ${await tokenManager.getAccessToken()}`,
            };
          } else {
            console.log("用户未登录，token无效");
            // 无效token视为未登录，需要先登录
            showLoginModal();
            return;
          }
          // 先验证验证码
          const response1 = await api.post(
            "/users/cellphone_captcha",
            {
              cellphone: phone,
              captcha: code,
              realname: true,
            },
            params_header
          );

          console.log("实名认证验证码验证响应:", response1);

          if (response1 && response1.data === true) {
            showMessage("实名认证成功！");

            // 关闭实名认证弹窗并跳转
            setTimeout(() => {
              closeModal("realnameModal");
              getParentLocationWithTimeout(500);
            }, 1000);
          } else {
            throw new Error("验证码验证失败");
          }
        } catch (error) {
          console.error("实名认证失败:", error);
          let errorMessage = "实名认证失败，请稍后重试";

          if (error.message) {
            errorMessage = error.message;
          }

          showMessage(errorMessage);
        } finally {
          // 重置按钮状态
          submitBtn.disabled = false;
          submitBtn.textContent = "完成认证";
        }
      });

      function showUserSetting() {
        const modal = document.getElementById("userSettingModal");
        const iframe = document.getElementById("user_setting_iframe");
        modal.classList.remove("show");
        modal.style.display = "block";
        if (iframe) {
          let url = window.location.href;
          url = url.replace("ms_games_login", "ms_games_create_profile");
          iframe.src = url;
        }
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            modal.classList.add("show");
          });
        });
      }

      function calculateAge(birthday) {
        if (!birthday) return null;
        const birthDate = new Date(birthday);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      }

      // 计算生日
      function calculateBirthday(age) {
        if (!age) return null;
        const today = new Date();
        const year = today.getFullYear() - age;
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      async function saveUserProfile(userinfo) {
        if (!userinfo.age || !userinfo.gender || !userinfo.grade) {
          console.log("请填写完整信息");
          return;
        }
        const birthday = calculateBirthday(userinfo.age);
        const gender = userinfo.gender === "male" ? 0 : 1;
        const age = userinfo.age;
        const keepworkUser = (await window.parentKeepwork.call("personalPageStore.loadPageData", "maisi_userinfo", "user")) || {};
        keepworkUser.birthday = birthday;
        keepworkUser.gender = parseInt(gender);
        keepworkUser.age = age;
        await window.parentKeepwork.call("personalPageStore.savePageData", "maisi_userinfo", "user", keepworkUser, true);
        console.log("用户信息保存成功:", userinfo);
        if (window.parent !== window) {
          getParentLocationWithTimeout(500);
        } else {
          navigateToMSGames();
        }
      }
    </script>
  </body>
</html>
