<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ³ä¹è®°å¿†å¤§å¸ˆ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        /* å…¨å±åŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        
        .playing {
            animation: pulse 0.5s ease-in-out;
            transform: scale(1.05);
        }
        
        .correct {
            animation: pulse 0.3s ease-in-out;
            background-color: #10b981 !important;
        }
        
        .wrong {
            animation: pulse 0.3s ease-in-out;
            background-color: #ef4444 !important;
        }

        /* è§„åˆ™å¼¹çª—æ ·å¼ */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideUp 0.3s ease-out;
        }
        
        .rules-modal.hide {
            animation: slideDown 0.3s ease-out;
        }
        
        .rules-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        .game-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* å“åº”å¼ç½‘æ ¼ */
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem; /* ä»0.75remå¢å¤§åˆ°1rem */
            max-width: min(85vw, 450px); /* ä»80vw, 400pxå¢å¤§åˆ°85vw, 450px */
            margin: 0 auto;
        }

        /* éŸ³ç¬¦æŒ‰é’® */
        .sound-btn {
            aspect-ratio: 1;
            min-height: 80px; /* ä»60pxå¢å¤§åˆ°80px */
            border: none;
            border-radius: 20px; /* ä»16pxå¢å¤§åˆ°20px */
            font-size: clamp(2rem, 5vw, 2.5rem); /* ä»1.5rem, 4vw, 2remå¢å¤§åˆ°2rem, 5vw, 2.5rem */
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); /* å¢å¼ºé˜´å½± */
            touch-action: manipulation;
        }

        .sound-btn:active {
            transform: scale(0.95);
        }

        .sound-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* æ‚¬æµ®è§„åˆ™æŒ‰é’® */
        .rules-float-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px; /* ä»50pxå¢å¤§åˆ°60px */
            height: 60px; /* ä»50pxå¢å¤§åˆ°60px */
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 1.8rem; /* ä»1.5remå¢å¤§åˆ°1.8rem */
            z-index: 100;
            transition: all 0.2s ease;
        }

        .rules-float-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .flex-1 {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform: translateY(-5rem); /* Move entire game area up */
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .sound-grid {
                gap: 0.75rem; /* ä»0.5remå¢å¤§åˆ°0.75rem */
                max-width: 90vw;
            }
            
            .sound-btn {
                min-height: 70px; /* ä»50pxå¢å¤§åˆ°70px */
                font-size: clamp(1.8rem, 6vw, 2.2rem); /* ä»1.2rem, 5vw, 1.8remå¢å¤§ */
            }
            
            .rules-content {
                padding: 2rem; /* ä»1.5remå¢å¤§åˆ°2rem */
                margin: 1rem;
            }
        }

        /* æ¨ªå±é€‚é… */
        @media (orientation: landscape) and (max-height: 600px) {
            .game-container {
                padding: 0.5rem;
            }
            
            .sound-grid {
                max-width: min(60vh, 350px); /* ä»50vh, 300pxå¢å¤§ */
            }
            
            .sound-btn {
                min-height: 55px; /* ä»40pxå¢å¤§åˆ°55px */
            }
        }

        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) {
            .sound-btn {
                min-height: 65px; /* ä»45pxå¢å¤§åˆ°65px */
                border-radius: 16px; /* ä»12pxå¢å¤§åˆ°16px */
            }
            
            .rules-float-btn {
                width: 55px; /* ä»45pxå¢å¤§åˆ°55px */
                height: 55px; /* ä»45pxå¢å¤§åˆ°55px */
                bottom: 15px;
                right: 15px;
                font-size: 1.6rem; /* ä»1.3remå¢å¤§åˆ°1.6rem */
            }
        }

        /* éš¾åº¦é€‰æ‹©æŒ‰é’®æ ·å¼ */
        .difficulty-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 80px;
            text-align: center;
        }

        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .difficulty-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }

        .difficulty-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ç§»åŠ¨ç«¯éš¾åº¦é€‰æ‹©ä¼˜åŒ– */
        @media (max-width: 768px) {
            .difficulty-btn {
                padding: 10px 12px;
                min-width: 70px;
                font-size: 14px;
            }
            
            .difficulty-btn span.block {
                font-size: 12px;
            }
            
            .difficulty-btn span.text-xs {
                font-size: 10px;
            }
        }

        /* åŠ¨æ€ç½‘æ ¼å¸ƒå±€ */
        .sound-grid.grid-2x2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .sound-grid.grid-3x2 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .sound-grid.grid-5x2 {
            grid-template-columns: repeat(5, 1fr);
        }

        /* ç§»é™¤åŸæœ‰éš¾åº¦æŒ‰é’®æ ·å¼ï¼Œæ·»åŠ ä¸‹æ‹‰èœå•æ ·å¼ */
        .difficulty-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .difficulty-select:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .difficulty-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .difficulty-select option {
            background: white;
            color: #374151;
            padding: 0.5rem;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .difficulty-select {
                min-width: 100px;
                font-size: 12px;
                padding: 0.25rem 2rem 0.25rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆè§„åˆ™å¼¹çª— -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-purple-800">ğŸµ è®­ç»ƒè§„åˆ™</h2> <!-- ä»text-2xlå¢å¤§åˆ°text-3xl -->
                <button id="closeRules" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button> <!-- ä»text-2xlå¢å¤§åˆ°text-3xl -->
            </div>
            <div class="space-y-4"> <!-- ä»space-y-3å¢å¤§åˆ°space-y-4 -->
                <div class="flex items-center space-x-4"> <!-- ä»space-x-3å¢å¤§åˆ°space-x-4 -->
                    <span class="text-3xl">ğŸ‘‚</span> <!-- ä»text-2xlå¢å¤§åˆ°text-3xl -->
                    <span class="text-gray-700 text-lg">ä»”ç»†å¬éŸ³ä¹åºåˆ—</span> <!-- å¢åŠ text-lg -->
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">ğŸ¯</span>
                    <span class="text-gray-700 text-lg">æŒ‰ç…§ç›¸åŒé¡ºåºç‚¹å‡»å¯¹åº”çš„ä¹å™¨</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">â¬†ï¸</span>
                    <span class="text-gray-700 text-lg">æ¯å…³åºåˆ—ä¼šå¢åŠ ä¸€ä¸ªéŸ³ç¬¦</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">ğŸ’¯</span>
                    <span class="text-gray-700 text-lg">æŒ‘æˆ˜ä½ çš„æœ€é«˜åˆ†ï¼</span>
                </div>
            </div>
            <div class="mt-8 text-center"> <!-- ä»mt-6å¢å¤§åˆ°mt-8 -->
                <button id="startGameFromRules" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-10 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 shadow-lg"> <!-- ä»px-8 py-3 text-lgå¢å¤§åˆ°px-10 py-4 text-xl -->
                    å¼€å§‹è®­ç»ƒ
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div class="game-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="flex-shrink-0 p-4">
            <h1 class="text-center text-white font-bold text-3xl md:text-4xl mb-4">ğŸµ éŸ³ä¹è®°å¿†å¤§å¸ˆ</h1> <!-- ä»text-2xl md:text-3xlå¢å¤§åˆ°text-3xl md:text-4xl -->
            <div class="flex justify-center gap-3 md:gap-6 text-base md:text-lg"> <!-- ä»gap-2 md:gap-4 text-sm md:text-baseå¢å¤§ -->
                <div class="bg-white bg-opacity-20 px-4 py-2 rounded-lg text-white"> <!-- ä»px-3 py-1å¢å¤§åˆ°px-4 py-2 -->
                    <span class="font-semibold">å…³å¡:</span> <span id="level">1</span>
                </div>
                <div class="bg-white bg-opacity-20 px-4 py-2 rounded-lg text-white">
                    <span class="font-semibold">å¾—åˆ†:</span> <span id="score">0</span>
                </div>
                <div class="bg-white bg-opacity-20 px-4 py-2 rounded-lg text-white">
                    <span class="font-semibold">æœ€é«˜:</span> <span id="highScore">0</span>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="flex-1 flex flex-col justify-center p-4">
            <div class="sound-grid mb-6" id="soundGrid">
                <button class="sound-btn bg-red-400 hover:bg-red-500" data-sound="0">ğŸ¹</button>
                <button class="sound-btn bg-orange-400 hover:bg-orange-500" data-sound="1">ğŸ¸</button>
                <button class="sound-btn bg-yellow-400 hover:bg-yellow-500" data-sound="2">ğŸ¥</button>
                <button class="sound-btn bg-green-400 hover:bg-green-500" data-sound="3">ğŸº</button>
                <button class="sound-btn bg-blue-400 hover:bg-blue-500" data-sound="4">ğŸ»</button>
                <button class="sound-btn bg-purple-400 hover:bg-purple-500" data-sound="5">ğŸ·</button>
                <button class="sound-btn bg-pink-400 hover:bg-pink-500" data-sound="6" style="display: none;">ğŸª•</button>
                <button class="sound-btn bg-teal-400 hover:bg-teal-500" data-sound="7" style="display: none;">ğŸ¼</button>
                <button class="sound-btn bg-indigo-400 hover:bg-indigo-500" data-sound="8" style="display: none;">ğŸ¤</button>
                <button class="sound-btn bg-cyan-400 hover:bg-cyan-500" data-sound="9" style="display: none;">ğŸ””</button>
            </div>

            <!-- æ¶ˆæ¯å’Œæ§åˆ¶åŒºåŸŸ -->
            <div class="text-center">
                <button id="startBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg mb-6">
                    å¼€å§‹è®­ç»ƒ
                </button>
                <p id="message" class="text-white text-xl font-semibold min-h-[32px]"></p>
            </div>
        </div>

        <!-- ç®€åŒ–çš„éš¾åº¦é€‰æ‹©åŒºåŸŸ -->
        <div class="flex-shrink-0 p-4 pb-6">
            <div class="flex justify-center items-center gap-3">
                <span class="text-white text-sm opacity-80">éš¾åº¦:</span>
                <select id="difficultySelect" class="difficulty-select bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-1 text-sm backdrop-blur-md">
                    <option value="easy" class="text-gray-800">ç®€å• (4ä¸ªä¹å™¨)</option>
                    <option value="normal" class="text-gray-800">æ™®é€š (6ä¸ªä¹å™¨)</option>
                    <option value="master" class="text-gray-800">å¤§å¸ˆ (10ä¸ªä¹å™¨)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®è§„åˆ™æŒ‰é’® -->
    <button id="rulesFloatBtn" class="rules-float-btn" title="æŸ¥çœ‹æ¸¸æˆè§„åˆ™" style="display: none;">
        â“
    </button>

    <script>
        // å…¨å±€å˜é‡å’Œé…ç½®
        let game_config = '';
        let globalHighestScore = 0;
        let gameStarted = false;
        
        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // éŸ³ç¬¦é¢‘ç‡ï¼ˆCå¤§è°ƒéŸ³é˜¶ï¼‰
        let frequencies = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00];
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            sequence: [],
            playerSequence: [],
            level: 1,
            score: 0,
            highScore: localStorage.getItem('highScore') || 0,
            isPlaying: false,
            isPlayerTurn: false,
            startTime: null,
            maxLevels: 15, // æœ€å¤§å…³å¡æ•°
            timeLimit: 300000, // 5åˆ†é’Ÿæ—¶é—´é™åˆ¶ï¼ˆæ¯«ç§’ï¼‰
            errorCount: 0, // æ·»åŠ é”™è¯¯è®¡æ•°
            maxErrors: 3 // æœ€å¤§é”™è¯¯æ¬¡æ•°
        };

        // åˆå§‹åŒ–å…¨å±€æœ€é«˜åˆ†
        globalHighestScore = Math.max(gameState.highScore, globalHighestScore);

        // è§„åˆ™å¼¹çª—æ§åˆ¶
        const rulesModal = document.getElementById('rulesModal');
        const closeRulesBtn = document.getElementById('closeRules');
        const startGameFromRulesBtn = document.getElementById('startGameFromRules');
        const rulesFloatBtn = document.getElementById('rulesFloatBtn');

        // æ˜¾ç¤ºè§„åˆ™å¼¹çª—
        function showRules() {
            rulesModal.style.display = 'flex';
            rulesModal.classList.remove('hide');
        }

        // éšè—è§„åˆ™å¼¹çª—
        function hideRules() {
            rulesModal.classList.add('hide');
            setTimeout(() => {
                rulesModal.style.display = 'none';
                rulesModal.classList.remove('hide');
            }, 300);
        }

        // ä»è§„åˆ™å¼¹çª—å¼€å§‹æ¸¸æˆ
        function startGameFromRules() {
            hideRules();
            setTimeout(() => {
                startGame();
                rulesFloatBtn.style.display = 'block';
            }, 300);
        }

        // äº‹ä»¶ç›‘å¬
        closeRulesBtn.addEventListener('click', hideRules);
        startGameFromRulesBtn.addEventListener('click', startGameFromRules);
        rulesFloatBtn.addEventListener('click', showRules);

        // è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
        function addTouchSupport() {
            document.querySelectorAll('.sound-btn').forEach(btn => {
                // åªéœ€è¦åŸºæœ¬çš„è§¦æ‘¸æ ·å¼ä¼˜åŒ–
                btn.addEventListener('mousedown', () => {
                    btn.style.transform = 'scale(0.95)';
                });
                
                btn.addEventListener('mouseup', () => {
                    btn.style.transform = '';
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = '';
                });
            });
        }

        // å±å¹•æ–¹å‘å˜åŒ–å¤„ç†
        function handleOrientationChange() {
            // å»¶è¿Ÿå¤„ç†ä»¥ç¡®ä¿æ–°çš„å°ºå¯¸ç”Ÿæ•ˆ
            setTimeout(() => {
                // é‡æ–°è®¡ç®—å¸ƒå±€
                const gameContainer = document.querySelector('.game-container');
                const soundGrid = document.querySelector('.sound-grid');
                
                if (window.innerHeight < 600 && window.innerWidth > window.innerHeight) {
                    // æ¨ªå±ä½é«˜åº¦è®¾å¤‡
                    gameContainer.style.padding = '0.5rem';
                    soundGrid.style.maxWidth = 'min(50vh, 300px)';
                } else {
                    // æ¢å¤é»˜è®¤
                    gameContainer.style.padding = '';
                    soundGrid.style.maxWidth = '';
                }
            }, 100);
        }

        // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
        window.addEventListener('orientationchange', handleOrientationChange);
        window.addEventListener('resize', handleOrientationChange);

        // æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data;
                    updateGameConfig(game_config);
                    break;
                case 'getGameStats':
                    const difficulty = calculateDifficulty();
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: globalHighestScore,
                            difficulty: Math.min(difficulty, 3)
                        }
                    }, '*');
                    break;
            }
        });

        // æ›´æ–°æ¸¸æˆé…ç½®
        function updateGameConfig(config) {
            try {
                if (typeof config === 'string' && config.trim()) {
                    const newConfig = parseGameConfig(config);
                    if (newConfig.frequencies && newConfig.frequencies.length > 0) {
                        frequencies = newConfig.frequencies;
                        console.log(`é…ç½®å·²æ›´æ–°ï¼ŒåŠ è½½äº† ${frequencies.length} ä¸ªéŸ³ç¬¦é¢‘ç‡`);
                        
                        if (gameState.level > 1 || gameState.isPlaying) {
                            startGame();
                        }
                    } else {
                        console.warn('æ–°é…ç½®æ²¡æœ‰æœ‰æ•ˆéŸ³ç¬¦ï¼Œä¿æŒåŸé…ç½®');
                    }
                }
            } catch (error) {
                console.warn('è§£ææ¸¸æˆé…ç½®å¤±è´¥ï¼Œä¿æŒåŸé…ç½®:', error);
            }
        }

        // è§£ææ¸¸æˆé…ç½®ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function parseGameConfig(config) {
            const result = { frequencies: [] };
            
            try {
                const jsonData = JSON.parse(config);
                if (jsonData.frequencies && Array.isArray(jsonData.frequencies)) {
                    result.frequencies = jsonData.frequencies.filter(f => typeof f === 'number' && f > 0);
                } else if (Array.isArray(jsonData)) {
                    result.frequencies = jsonData.filter(f => typeof f === 'number' && f > 0);
                }
            } catch (e) {
                const lines = config.trim().split('\n');
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line || line.startsWith('#')) continue;
                    
                    const numbers = line.split(/[,\s]+/).map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n > 0);
                    result.frequencies.push(...numbers);
                }
            }
            
            return result;
        }

        // è®¡ç®—å½“å‰éš¾åº¦ï¼ˆåŸºäºå…³å¡å’Œåºåˆ—é•¿åº¦ï¼‰
        function calculateDifficulty() {
            const level = gameState.level;
            const sequenceLength = gameState.sequence.length;
            
            if (level >= 10 || sequenceLength >= 8) return 3;
            if (level >= 5 || sequenceLength >= 5) return 2;
            return 1;
        }

        // æ’­æ”¾éŸ³ç¬¦
        function playSound(index, duration = 500) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequencies[index];
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.8, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
            
            const btn = document.querySelector(`[data-sound="${index}"]`);
            btn.classList.add('playing');
            setTimeout(() => btn.classList.remove('playing'), duration);
        }

        // ç”Ÿæˆæ–°çš„åºåˆ—
        function generateSequence() {
            const config = difficultyConfig[currentDifficulty];
            const newSound = Math.floor(Math.random() * config.instruments);
            gameState.sequence.push(newSound);
        }

        // æ’­æ”¾åºåˆ—
        async function playSequence() {
            gameState.isPlaying = true;
            updateMessage('ä»”ç»†å¬... ğŸ§');
            disableButtons();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            for (let i = 0; i < gameState.sequence.length; i++) {
                playSound(gameState.sequence[i]);
                await new Promise(resolve => setTimeout(resolve, 600));
            }
            
            gameState.isPlaying = false;
            gameState.isPlayerTurn = true;
            enableButtons();
            updateMessage('è½®åˆ°ä½ äº†ï¼è¯·é‡å¤åˆšæ‰çš„åºåˆ— ğŸ¹');
        }

        async function gameWrong() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`âŒ æ¸¸æˆç»“æŸï¼è¿ç»­é”™è¯¯${gameState.maxErrors}æ¬¡ï¼Œæœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ®`);
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`âŒ æ¸¸æˆç»“æŸï¼æ–°çºªå½•ï¼š${gameState.score} ğŸ†`);
            }

            // æ›´æ–°å…¨å±€æœ€é«˜åˆ†
            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            // å‘é€æ¸¸æˆç»“æŸæ¶ˆæ¯ï¼ˆé”™è¯¯æ¬¡æ•°è¿‡å¤šï¼‰
            const finalScore = convertToPercentage(gameState.score, gameState.level, false);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level,
                    difficulty: Math.min(difficulty, 3),
                    completed: false,
                    reason: 'tooManyErrors' // æ·»åŠ ç»“æŸåŸå› 
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        // æ£€æŸ¥ç©å®¶è¾“å…¥
        function checkPlayerInput(soundIndex) {
            if (!gameState.isPlayerTurn || gameState.isPlaying) return;
            
            const config = difficultyConfig[currentDifficulty];
            if (soundIndex >= config.instruments) return; // é˜²æ­¢ç‚¹å‡»éšè—çš„æŒ‰é’®
            
            playSound(soundIndex, 300);
            gameState.playerSequence.push(soundIndex);
            
            const currentIndex = gameState.playerSequence.length - 1;
            
            if (gameState.playerSequence[currentIndex] !== gameState.sequence[currentIndex]) {
                gameState.errorCount++;
                
                if (gameState.errorCount >= gameState.maxErrors) {
                    // è¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°ï¼Œæ¸¸æˆç»“æŸ
                    gameWrong();
                } else {
                    // è¿˜æœ‰æœºä¼šï¼Œé‡ç½®å½“å‰å›åˆ
                    wrongButRetry();
                }
            } else if (gameState.playerSequence.length === gameState.sequence.length) {
                // å®Œæˆå½“å‰å…³å¡ï¼Œé‡ç½®é”™è¯¯è®¡æ•°
                gameState.errorCount = 0;
                levelComplete();
            }
        }

        // æ·»åŠ æ–°å‡½æ•°ï¼šé”™è¯¯ä½†å¯ä»¥é‡è¯•
        async function wrongButRetry() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            // çŸ­æš‚æ˜¾ç¤ºé”™è¯¯æ•ˆæœ
            document.querySelectorAll('.sound-btn').forEach(btn => {
                btn.classList.add('wrong');
            });
            
            const remainingChances = gameState.maxErrors - gameState.errorCount;
            updateMessage(`ç‚¹é”™äº†ï¼è¿˜æœ‰ ${remainingChances} æ¬¡æœºä¼š ğŸ˜…`);
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // ç§»é™¤é”™è¯¯æ•ˆæœ
            document.querySelectorAll('.sound-btn').forEach(btn => {
                btn.classList.remove('wrong');
            });
            
            // é‡ç½®å½“å‰å›åˆçš„ç©å®¶åºåˆ—
            gameState.playerSequence = [];
            
            // é‡æ–°æ’­æ”¾åºåˆ—
            await new Promise(resolve => setTimeout(resolve, 500));
            updateMessage('å†å¬ä¸€é... ğŸ§');
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            for (let i = 0; i < gameState.sequence.length; i++) {
                playSound(gameState.sequence[i]);
                await new Promise(resolve => setTimeout(resolve, 600));
            }
            
            gameState.isPlayerTurn = true;
            enableButtons();
            updateMessage('å†è¯•ä¸€æ¬¡ï¼è¯·é‡å¤åˆšæ‰çš„åºåˆ— ğŸ¹');
        }

        // å¼€å§‹æ–°æ¸¸æˆ
        function startGame() {
            if (!gameStarted) {
                // å‘é€æ¸¸æˆå¼€å§‹æ¶ˆæ¯
                window.parent.postMessage({ type: 'gameStarted' }, '*');
                gameStarted = true;
            }

            const config = difficultyConfig[currentDifficulty];
            
            gameState = {
                sequence: [],
                playerSequence: [],
                level: 1,
                score: 0,
                highScore: gameState.highScore,
                isPlaying: false,
                isPlayerTurn: false,
                startTime: Date.now(),
                maxLevels: config.maxLevels,
                timeLimit: 300000,
                errorCount: 0,
                maxErrors: 3
            };
            
            updateDisplay();
            updateDifficultySelect(); // ç¦ç”¨éš¾åº¦é€‰æ‹©
            document.getElementById('startBtn').style.display = 'none';
            
            generateSequence();
            playSequence();
        }

        // å…³å¡å®Œæˆ
        async function levelComplete() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            document.querySelectorAll('.sound-btn').forEach(btn => {
                btn.classList.add('correct');
            });
            
            gameState.score += gameState.level * 10;
            gameState.level++;
            gameState.errorCount = 0; // é‡ç½®é”™è¯¯è®¡æ•°
            updateDisplay();
            updateMessage(`å¤ªæ£’äº†ï¼å¾—åˆ° ${(gameState.level - 1) * 10} åˆ†ï¼ğŸ‰`);
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            document.querySelectorAll('.sound-btn').forEach(btn => {
                btn.classList.remove('correct');
            });
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¸¸æˆå®Œæˆæ¡ä»¶
            if (checkGameComplete()) {
                return;
            }
            
            gameState.playerSequence = [];
            generateSequence();
            playSequence();
        }

        // æ·»åŠ ç¼ºå¤±çš„æ¸¸æˆå®Œæˆæ£€æŸ¥å‡½æ•°
        function checkGameComplete() {
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§å…³å¡æ•°
            if (gameState.level > gameState.maxLevels) {
                gameComplete();
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ—¶é—´é™åˆ¶
            const timeElapsed = Date.now() - gameState.startTime;
            if (timeElapsed >= gameState.timeLimit) {
                gameTimeout();
                return true;
            }
            
            return false;
        }

        // æ¸¸æˆå®Œæˆï¼ˆé€šå…³ï¼‰
        async function gameComplete() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`ğŸ‰ æ­å–œé€šå…³ï¼å®Œæˆæ‰€æœ‰${gameState.maxLevels}å…³ï¼æœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ†`);
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`ğŸ‰ æ–°çºªå½•ï¼é€šå…³å¾—åˆ†ï¼š${gameState.score} ğŸ†`);
            }

            // æ›´æ–°å…¨å±€æœ€é«˜åˆ†
            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            // å‘é€æ¸¸æˆç»“æŸæ¶ˆæ¯ï¼ˆæˆåŠŸå®Œæˆï¼‰
            const finalScore = convertToPercentage(gameState.score, gameState.level - 1, true);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level - 1,
                    difficulty: Math.min(difficulty, 3),
                    completed: true
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        // æ¸¸æˆè¶…æ—¶
        async function gameTimeout() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`â° æ—¶é—´åˆ°ï¼æ¸¸æˆç»“æŸï¼æœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ®`);
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`â° æ—¶é—´åˆ°ï¼æ–°çºªå½•ï¼š${gameState.score} ğŸ†`);
            }

            // æ›´æ–°å…¨å±€æœ€é«˜åˆ†
            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            // å‘é€æ¸¸æˆç»“æŸæ¶ˆæ¯ï¼ˆè¶…æ—¶ï¼‰
            const finalScore = convertToPercentage(gameState.score, gameState.level, false);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level,
                    difficulty: Math.min(difficulty, 3),
                    completed: false
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        // å°†æ¸¸æˆå¾—åˆ†è½¬æ¢ä¸ºç™¾åˆ†åˆ¶
        function convertToPercentage(score, level, completed) {
            // åŸºç¡€åˆ†æ•°è®¡ç®—ï¼šæ¯å…³å¡çš„ç†è®ºæœ€é«˜åˆ†æ˜¯ level * 10
            const maxPossibleScore = gameState.maxLevels * (gameState.maxLevels + 1) * 5; // ç†è®ºæœ€é«˜æ€»åˆ†
            const timeBonus = completed ? 300 : 0; // å®Œæˆå¥–åŠ±
            const totalScore = score + timeBonus;
            
            // è®¡ç®—ç™¾åˆ†æ¯”
            let percentage = Math.min(100, Math.max(0, (totalScore / maxPossibleScore) * 100));
            
            // æ ¹æ®å®Œæˆæƒ…å†µè°ƒæ•´
            if (completed && level >= gameState.maxLevels) {
                // å®Œå…¨é€šå…³ï¼Œæœ€ä½85åˆ†
                percentage = Math.max(85, percentage);
            } else if (level >= 10) {
                // è¾¾åˆ°è¾ƒé«˜å…³å¡ï¼Œç»™äºˆé¢å¤–å¥–åŠ±
                percentage = Math.min(100, percentage * 1.2);
            } else if (level >= 5) {
                // ä¸­ç­‰å…³å¡ï¼Œé€‚å½“å¥–åŠ±
        percentage = Math.min(100, percentage * 1.1);
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰åŸºç¡€åˆ†æ•°
            if (level >= 3) {
                percentage = Math.max(20, percentage);
            } else if (level >= 2) {
                percentage = Math.max(10, percentage);
            }
            
            return Math.round(percentage);
        }

        // éš¾åº¦é…ç½®
        const difficultyConfig = {
            easy: {
                instruments: 4,
                frequencies: [261.63, 293.66, 329.63, 349.23],
                gridClass: 'grid-2x2',
                maxLevels: 12
            },
            normal: {
                instruments: 6,
                frequencies: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00],
                gridClass: 'grid-3x2',
                maxLevels: 15
            },
            master: {
                instruments: 10,
                frequencies: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25],
                gridClass: 'grid-5x2',
                maxLevels: 20
            }
        };

        // å½“å‰éš¾åº¦
        let currentDifficulty = 'normal';

        // åˆå§‹åŒ–éš¾åº¦é€‰æ‹©
        function initDifficultySelector() {
            const difficultySelect = document.getElementById('difficultySelect');
            
            difficultySelect.addEventListener('change', (e) => {
                const difficulty = e.target.value;
                setDifficulty(difficulty);
                
                // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œï¼Œæ˜¾ç¤ºæç¤ºå¹¶é‡æ–°å¼€å§‹
                if (gameState.isPlaying || gameState.isPlayerTurn) {
                    updateMessage('éš¾åº¦å·²åˆ‡æ¢ï¼Œæ¸¸æˆé‡æ–°å¼€å§‹ï¼');
                }
            });
        }

        // è®¾ç½®éš¾åº¦
        function setDifficulty(difficulty) {
            if (!difficultyConfig[difficulty]) return;
            
            currentDifficulty = difficulty;
            const config = difficultyConfig[difficulty];
            
            // æ›´æ–°é¢‘ç‡æ•°ç»„
            frequencies = [...config.frequencies];
            
            // æ›´æ–°æ¸¸æˆå‚æ•°
            gameState.maxLevels = config.maxLevels;
            
            // æ— è®ºæ¸¸æˆå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½é‡ç½®æ¸¸æˆ
            gameState = {
                sequence: [],
                playerSequence: [],
                level: 1,
                score: 0,
                highScore: gameState.highScore,
                isPlaying: false,
                isPlayerTurn: false,
                startTime: null,
                maxLevels: config.maxLevels,
                timeLimit: 300000,
                errorCount: 0,
                maxErrors: 3
            };
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å¼€å§‹è®­ç»ƒ';
            
            // æ¸…ç©ºæ¶ˆæ¯
            updateMessage('');
            
            // å¯ç”¨æŒ‰é’®4
            enableButtons();
            
            // æ›´æ–°UI
            updateDifficultySelect();
            updateSoundGrid();
            
            console.log(`éš¾åº¦å·²è®¾ç½®ä¸º: ${difficulty} (${config.instruments}ä¸ªä¹å™¨)`);
        }

        // æ›´æ–°éš¾åº¦é€‰æ‹©çŠ¶æ€
        function updateDifficultySelect() {
            const difficultySelect = document.getElementById('difficultySelect');
            
            difficultySelect.value = currentDifficulty;
            
            // å§‹ç»ˆå¯ç”¨éš¾åº¦é€‰æ‹©ï¼Œå…è®¸éšæ—¶åˆ‡æ¢
            difficultySelect.disabled = false;
        }

        // æ›´æ–°éŸ³ç¬¦ç½‘æ ¼
        function updateSoundGrid() {
            const config = difficultyConfig[currentDifficulty];
            const soundGrid = document.getElementById('soundGrid');
            const allBtns = soundGrid.querySelectorAll('.sound-btn');
            
            // ç§»é™¤æ‰€æœ‰ç½‘æ ¼ç±»
            soundGrid.classList.remove('grid-2x2', 'grid-3x2', 'grid-5x2');
            // æ·»åŠ å½“å‰éš¾åº¦çš„ç½‘æ ¼ç±»
            soundGrid.classList.add(config.gridClass);
            
            // æ˜¾ç¤º/éšè—æŒ‰é’®
            allBtns.forEach((btn, index) => {
                if (index < config.instruments) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            });
            
            // é‡æ–°åº”ç”¨è§¦æ‘¸æ”¯æŒ
            addTouchSupport();
        }

        // ç¦ç”¨æ‰€æœ‰éŸ³ç¬¦æŒ‰é’®
        function disableButtons() {
            document.querySelectorAll('.sound-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        // å¯ç”¨æ‰€æœ‰éŸ³ç¬¦æŒ‰é’®
        function enableButtons() {
            const config = difficultyConfig[currentDifficulty];
            document.querySelectorAll('.sound-btn').forEach((btn, index) => {
                if (index < config.instruments) {
                    btn.disabled = false;
                }
            });
        }

        // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
        function updateDisplay() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('highScore').textContent = gameState.highScore;
        }

        // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
        function updateMessage(text) {
            document.getElementById('message').textContent = text;
        }

        // ä¿®æ”¹æ¸¸æˆç»“æŸç›¸å…³å‡½æ•°
        async function gameWrong() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`âŒ è®­ç»ƒç»“æŸï¼è¿ç»­é”™è¯¯${gameState.maxErrors}æ¬¡ï¼Œæœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ®`);
            
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`âŒ è®­ç»ƒç»“æŸï¼æ–°çºªå½•ï¼š${gameState.score} ğŸ†`);
            }

            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            const finalScore = convertToPercentage(gameState.score, gameState.level, false);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level,
                    difficulty: Math.min(difficulty, 3),
                    completed: false,
                    reason: 'tooManyErrors'
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        async function gameComplete() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`ğŸ‰ æ­å–œé€šå…³ï¼å®Œæˆæ‰€æœ‰${gameState.maxLevels}å…³ï¼æœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ†`);
            
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`ğŸ‰ æ–°çºªå½•ï¼é€šå…³å¾—åˆ†ï¼š${gameState.score} ğŸ†`);
            }

            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            const finalScore = convertToPercentage(gameState.score, gameState.level - 1, true);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level - 1,
                    difficulty: Math.min(difficulty, 3),
                    completed: true
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        async function gameTimeout() {
            gameState.isPlayerTurn = false;
            disableButtons();
            
            updateMessage(`â° æ—¶é—´åˆ°ï¼æ¸¸æˆç»“æŸï¼æœ€ç»ˆå¾—åˆ†ï¼š${gameState.score} ğŸ®`);
            
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
                document.getElementById('highScore').textContent = gameState.highScore;
                updateMessage(`â° æ—¶é—´åˆ°ï¼æ–°çºªå½•ï¼š${gameState.score} ğŸ†`);
            }

            if (gameState.score > globalHighestScore) {
                globalHighestScore = gameState.score;
            }

            const finalScore = convertToPercentage(gameState.score, gameState.level, false);
            const difficulty = calculateDifficulty();
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: finalScore,
                    highestScore: globalHighestScore,
                    level: gameState.level,
                    difficulty: Math.min(difficulty, 3),
                    completed: false
                }
            }, '*');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // é‡æ–°å¯ç”¨éš¾åº¦é€‰æ‹©
            updateDifficultySelect();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'å†ç©ä¸€æ¬¡';
        }

        // ä¿®æ”¹å¼€å§‹æ¸¸æˆå‡½æ•°
        function startGame() {
            if (!gameStarted) {
                window.parent.postMessage({ type: 'gameStarted' }, '*');
                gameStarted = true;
            }

            const config = difficultyConfig[currentDifficulty];
            
            gameState = {
                sequence: [],
                playerSequence: [],
                level: 1,
                score: 0,
                highScore: gameState.highScore,
                isPlaying: false,
                isPlayerTurn: false,
                startTime: Date.now(),
                maxLevels: config.maxLevels,
                timeLimit: 300000,
                errorCount: 0,
                maxErrors: 3
            };
            
            updateDisplay();
            updateDifficultySelect(); // ç¦ç”¨éš¾åº¦é€‰æ‹©
            document.getElementById('startBtn').style.display = 'none';
            
            generateSequence();
            playSequence();
        }

        // åˆå§‹åŒ–
        document.getElementById('startBtn').addEventListener('click', () => {
            hideRules();
            setTimeout(() => {
                startGame();
                rulesFloatBtn.style.display = 'block';
            }, 300);
        });

        document.querySelectorAll('.sound-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const soundIndex = parseInt(btn.getAttribute('data-sound'));
                checkPlayerInput(soundIndex);
            });
        });

        // åˆå§‹åŒ–
        disableButtons();
        addTouchSupport();
        initDifficultySelector(); // åˆå§‹åŒ–éš¾åº¦é€‰æ‹©å™¨
        setDifficulty('normal'); // è®¾ç½®é»˜è®¤éš¾åº¦
        
        document.getElementById('highScore').textContent = gameState.highScore;
        
        window.parent.postMessage({ type: 'gameLoaded' }, '*');
        showRules();
    </script>
</body>
</html>

