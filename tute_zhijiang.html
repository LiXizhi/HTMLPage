<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ™ºåŒ  iMOM ç”Ÿäº§ç®¡ç†ç³»ç»Ÿ H5</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.4"></script>
    <meta name="color-scheme" content="light dark" />
    <style>
      /* è½»å¾®çš„è¿‡æ¸¡åŠ¨ç”» */
      .fade-enter {
        opacity: 0;
        transform: translateY(6px);
      }
      .fade-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.2s ease;
      }
      /* å›ºå®šå¤´éƒ¨é˜´å½± */
      .header-shadow {
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
      }
      /* è¡¨æ ¼æ»šåŠ¨ */
      .table-scroll {
        max-height: 360px;
        overflow: auto;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-800">
    <div class="flex min-h-screen">
      <!-- ä¾§è¾¹æ  -->
      <aside class="w-56 bg-white border-r border-slate-200 hidden md:flex md:flex-col">
        <div class="px-4 py-4 border-b border-slate-200">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded bg-indigo-600 text-white flex items-center justify-center font-bold">åŒ </div>
            <div>
              <div class="text-lg font-semibold">æ™ºåŒ  iMOM</div>
              <div class="text-xs text-slate-500">ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¹³å°</div>
            </div>
          </div>
        </div>
        <nav class="p-3 space-y-1">
          <button data-target="overview" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100 font-medium bg-slate-100">
            <span>ğŸ“Š</span><span>æ¦‚è§ˆ</span>
          </button>
          <button data-target="plan" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ—“ï¸</span><span>ç”Ÿäº§è®¡åˆ’</span></button>
          <button data-target="schedule" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ“…</span><span>è°ƒåº¦å®‰æ’</span></button>
          <button data-target="tasks" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ§°</span><span>ç”Ÿäº§ä»»åŠ¡</span></button>
          <button data-target="quality" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>âœ…</span><span>è´¨é‡æ£€æµ‹</span></button>
          <button data-target="equipment" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ› ï¸</span><span>è®¾å¤‡ç›‘æ§</span></button>          <button data-target="analytics" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ“ˆ</span><span>åˆ†ææŠ¥è¡¨</span></button>
          <button data-target="integrations" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ§©</span><span>3Dè™šä»¿é›†æˆ</span></button>
          <div id="integratedPagesList" class="ml-6 space-y-1">
            <!-- åŠ¨æ€ç”Ÿæˆçš„é›†æˆé¡µé¢åˆ—è¡¨ -->
          </div>
        </nav>
        <div class="mt-auto p-3 border-t border-slate-200 text-xs text-slate-500">æ•°å­—å­ªç”Ÿæ•™å­¦ Â· å®éªŒä¸å®è®­ Â· iMOM</div>
      </aside>

      <!-- ä¸»åŒºåŸŸ -->
      <main class="flex-1 flex flex-col">
        <!-- é¡¶éƒ¨æ¡ -->
        <header class="sticky top-0 bg-white header-shadow z-10">
          <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-2 md:hidden">
              <button id="mobileMenuBtn" class="px-3 py-2 rounded border border-slate-200">èœå•</button>
              <span class="font-semibold">æ™ºåŒ  iMOM</span>
            </div>
            <div class="hidden md:block">
              <div class="text-sm text-slate-500">æ•°å­—å­ªç”Ÿæ•™å­¦ / å®éªŒä¸å®è®­ / ç”Ÿäº§å…¨æµç¨‹</div>
              <div class="text-lg font-semibold">iMOM ç”Ÿäº§ç®¡ç†ç³»ç»Ÿ</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="seedBtn" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm">ä¸€é”®ç”Ÿæˆæ¼”ç¤ºæ•°æ®</button>
              <button id="resetBtn" class="px-3 py-2 rounded border border-slate-200 text-sm">é‡ç½®</button>
            </div>
          </div>
        </header>

        <!-- å†…å®¹ -->
        <section id="content" class="p-4 space-y-6">
          <!-- æ¦‚è§ˆ -->
          <div data-section="overview" class="section">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="text-slate-500 text-sm">ä»Šæ—¥äº§é‡ï¼ˆä»¶ï¼‰</div>
                <div id="kpi-today-output" class="text-3xl font-bold mt-1">0</div>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="text-slate-500 text-sm">åœ¨åˆ¶å“ WIPï¼ˆä»¶ï¼‰</div>
                <div id="kpi-wip" class="text-3xl font-bold mt-1">0</div>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="text-slate-500 text-sm">åˆæ ¼ç‡</div>
                <div class="text-3xl font-bold mt-1"><span id="kpi-yield">--</span><span class="text-lg font-medium">%</span></div>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="text-slate-500 text-sm">è®¾å¤‡åœ¨çº¿ç‡</div>
                <div class="text-3xl font-bold mt-1"><span id="kpi-uptime">--</span><span class="text-lg font-medium">%</span></div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="bg-white rounded border border-slate-200 p-4 lg:col-span-2">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">å‘¨äº§é‡è¶‹åŠ¿</div>
                  <div class="text-xs text-slate-500">åŸºäºä»»åŠ¡å®Œæˆé‡</div>
                </div>
                <canvas id="chart-throughput" class="mt-3"></canvas>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ</div>
                  <div class="text-xs text-slate-500">è¿è¡Œ/åœæœº/æ•…éšœ</div>
                </div>
                <canvas id="chart-equipment" class="mt-3"></canvas>
              </div>
            </div>

            <div class="bg-indigo-50 border border-indigo-100 rounded p-4 text-sm text-indigo-700">
              æœ¬å¹³å°ç”¨äºæ•°å­—å­ªç”Ÿæ•™å­¦ã€å®éªŒä¸å®è®­ã€‚å­¦ç”Ÿå¯åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿›è¡Œç”Ÿäº§è®¡åˆ’åˆ¶å®šã€è°ƒåº¦å®‰æ’ã€ç”Ÿäº§ä»»åŠ¡åˆ†é…ã€è´¨é‡æ£€æµ‹æ§åˆ¶ä¸è®¾å¤‡ç›‘æ§ï¼Œå¹¶é€šè¿‡æ•°æ®åŒ–ç®¡ç†å½¢æˆåˆ†ææŠ¥è¡¨ï¼Œè¾…åŠ©å†³ç­–ã€ä¼˜åŒ–æµç¨‹ã€‚
            </div>
          </div>

          <!-- ç”Ÿäº§è®¡åˆ’ -->
          <div data-section="plan" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="font-semibold mb-3">æ–°å¢ç”Ÿäº§è®¡åˆ’</div>
              <form id="planForm" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <input required name="product" placeholder="äº§å“åç§°" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="qty" type="number" placeholder="æ•°é‡" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="start" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="end" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <button class="px-3 py-2 rounded bg-indigo-600 text-white">æ·»åŠ </button>
              </form>
            </div>

            <div class="bg-white rounded border border-slate-200 mt-4">
              <div class="p-4 flex items-center justify-between">
                <div class="font-semibold">è®¡åˆ’åˆ—è¡¨</div>
                <div class="text-xs text-slate-500">ç‚¹å‡»å¼€å§‹è°ƒåº¦å¯æ¨é€åˆ°è°ƒåº¦å®‰æ’</div>
              </div>
              <div class="overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr>
                      <th class="text-left px-4 py-2">äº§å“</th>
                      <th class="text-left px-4 py-2">æ•°é‡</th>
                      <th class="text-left px-4 py-2">å¼€å§‹</th>
                      <th class="text-left px-4 py-2">ç»“æŸ</th>
                      <th class="text-left px-4 py-2">çŠ¶æ€</th>
                      <th class="text-right px-4 py-2">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="planTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- è°ƒåº¦å®‰æ’ -->
          <div data-section="schedule" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="font-semibold mb-3">è°ƒåº¦å®‰æ’ï¼ˆç®€ç‰ˆï¼‰</div>
              <form id="scheduleForm" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <input required name="planId" placeholder="è®¡åˆ’ID" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="line" placeholder="äº§çº¿/å·¥ä½" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="priority" type="number" placeholder="ä¼˜å…ˆçº§(1é«˜)" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="date" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <button class="px-3 py-2 rounded bg-indigo-600 text-white">æ·»åŠ </button>
              </form>
            </div>
            <div class="bg-white rounded border border-slate-200 mt-4">
              <div class="p-4 flex items-center justify-between">
                <div class="font-semibold">è°ƒåº¦é˜Ÿåˆ—</div>
                <div class="text-xs text-slate-500">æŒ‰ä¼˜å…ˆçº§ä»å°åˆ°å¤§æ‰§è¡Œ</div>
              </div>
              <div class="overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr>
                      <th class="text-left px-4 py-2">#</th>
                      <th class="text-left px-4 py-2">è®¡åˆ’ID</th>
                      <th class="text-left px-4 py-2">äº§çº¿/å·¥ä½</th>
                      <th class="text-left px-4 py-2">æ—¥æœŸ</th>
                      <th class="text-left px-4 py-2">ä¼˜å…ˆçº§</th>
                      <th class="text-right px-4 py-2">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="scheduleTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ç”Ÿäº§ä»»åŠ¡ -->
          <div data-section="tasks" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="font-semibold mb-3">åˆ†é…ç”Ÿäº§ä»»åŠ¡</div>
              <form id="taskForm" class="grid grid-cols-1 md:grid-cols-6 gap-3">
                <input required name="taskName" placeholder="ä»»åŠ¡åç§°" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="assignee" placeholder="æŒ‡æ´¾äººå‘˜" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="qty" type="number" placeholder="æ•°é‡" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="deadline" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <select name="status" class="px-3 py-2 rounded border border-slate-300">
                  <option>æœªå¼€å§‹</option>
                  <option>è¿›è¡Œä¸­</option>
                  <option>å·²å®Œæˆ</option>
                </select>
                <button class="px-3 py-2 rounded bg-indigo-600 text-white">åˆ›å»º</button>
              </form>
            </div>
            <div class="bg-white rounded border border-slate-200 mt-4">
              <div class="p-4 flex items-center justify-between">
                <div class="font-semibold">ä»»åŠ¡åˆ—è¡¨</div>
                <div class="text-xs text-slate-500">å®Œæˆä»»åŠ¡è®¡å…¥äº§é‡</div>
              </div>
              <div class="overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr>
                      <th class="text-left px-4 py-2">#</th>
                      <th class="text-left px-4 py-2">ä»»åŠ¡</th>
                      <th class="text-left px-4 py-2">è´Ÿè´£äºº</th>
                      <th class="text-left px-4 py-2">æ•°é‡</th>
                      <th class="text-left px-4 py-2">æˆªæ­¢</th>
                      <th class="text-left px-4 py-2">çŠ¶æ€</th>
                      <th class="text-right px-4 py-2">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="taskTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- è´¨é‡æ£€æµ‹ -->
          <div data-section="quality" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="font-semibold mb-3">æ–°å¢è´¨æ£€è®°å½•</div>
              <form id="qualityForm" class="grid grid-cols-1 md:grid-cols-6 gap-3">
                <input required name="batch" placeholder="æ‰¹æ¬¡å·" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="item" placeholder="æ£€éªŒé¡¹ç›®" class="px-3 py-2 rounded border border-slate-300" />
                <select name="result" class="px-3 py-2 rounded border border-slate-300">
                  <option>åˆæ ¼</option>
                  <option>ä¸åˆæ ¼</option>
                </select>
                <input name="defect" placeholder="ç¼ºé™·ç±»å‹ï¼ˆä¸åˆæ ¼æ—¶ï¼‰" class="px-3 py-2 rounded border border-slate-300" />
                <input required name="qty" type="number" placeholder="æ•°é‡" class="px-3 py-2 rounded border border-slate-300" />
                <button class="px-3 py-2 rounded bg-indigo-600 text-white">è®°å½•</button>
              </form>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
              <div class="bg-white rounded border border-slate-200 p-4 lg:col-span-2">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">è´¨æ£€è®°å½•</div>
                  <button id="exportQualityBtn" class="px-3 py-1.5 text-sm rounded border border-slate-200">å¯¼å‡º CSV</button>
                </div>
                <div class="table-scroll">
                  <table class="min-w-full text-sm">
                    <thead class="bg-slate-50">
                      <tr>
                        <th class="text-left px-4 py-2">#</th>
                        <th class="text-left px-4 py-2">æ‰¹æ¬¡</th>
                        <th class="text-left px-4 py-2">é¡¹ç›®</th>
                        <th class="text-left px-4 py-2">ç»“æœ</th>
                        <th class="text-left px-4 py-2">ç¼ºé™·</th>
                        <th class="text-left px-4 py-2">æ•°é‡</th>
                        <th class="text-left px-4 py-2">æ—¶é—´</th>
                      </tr>
                    </thead>
                    <tbody id="qualityTable"></tbody>
                  </table>
                </div>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">ç¼ºé™·åˆ†å¸ƒ</div>
                  <div class="text-xs text-slate-500">æŒ‰ç¼ºé™·ç±»å‹</div>
                </div>
                <canvas id="chart-defects" class="mt-3"></canvas>
              </div>
            </div>
          </div>

          <!-- è®¾å¤‡ç›‘æ§ -->
          <div data-section="equipment" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="flex items-center justify-between">
                <div class="font-semibold">è®¾å¤‡åˆ—è¡¨</div>
                <div class="text-xs text-slate-500">æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®æ¯ 3 ç§’åˆ·æ–°</div>
              </div>
              <div class="overflow-auto mt-3">
                <table class="min-w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr>
                      <th class="text-left px-4 py-2">#</th>
                      <th class="text-left px-4 py-2">è®¾å¤‡</th>
                      <th class="text-left px-4 py-2">çŠ¶æ€</th>
                      <th class="text-left px-4 py-2">æ¸©åº¦(Â°C)</th>
                      <th class="text-left px-4 py-2">æŒ¯åŠ¨(mm/s)</th>
                      <th class="text-left px-4 py-2">æ›´æ–°æ—¶é—´</th>
                      <th class="text-right px-4 py-2">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="equipmentTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- åˆ†ææŠ¥è¡¨ -->
          <div data-section="analytics" class="section hidden">
            <div class="bg-white rounded border border-slate-200 p-4">
              <div class="font-semibold mb-3">ç­›é€‰ä¸ç”ŸæˆæŠ¥è¡¨</div>
              <form id="analyticsForm" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <input name="product" placeholder="äº§å“ï¼ˆå¯é€‰ï¼‰" class="px-3 py-2 rounded border border-slate-300" />
                <input name="from" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <input name="to" type="date" class="px-3 py-2 rounded border border-slate-300" />
                <select name="metric" class="px-3 py-2 rounded border border-slate-300">
                  <option value="throughput">äº§é‡</option>
                  <option value="yield">åˆæ ¼ç‡</option>
                  <option value="downtime">åœæœºç‡</option>
                </select>
                <button class="px-3 py-2 rounded bg-indigo-600 text-white">ç”Ÿæˆ</button>
              </form>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
              <div class="bg-white rounded border border-slate-200 p-4 lg:col-span-2">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">æŒ‡æ ‡è¶‹åŠ¿</div>
                  <button id="exportAnalyticsBtn" class="px-3 py-1.5 text-sm rounded border border-slate-200">å¯¼å‡º CSV</button>
                </div>
                <canvas id="chart-analytics" class="mt-3"></canvas>
              </div>
              <div class="bg-white rounded border border-slate-200 p-4">
                <div class="font-semibold mb-2">å…³é”®ç»“è®º</div>
                <ul id="analyticsInsights" class="list-disc pl-5 text-sm space-y-1 text-slate-700"></ul>
              </div>
            </div>
          </div>          <!-- é›†æˆï¼š3Dè™šæ‹Ÿä»¿çœŸ -->
          <div data-section="integrations" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <!-- å·¦ä¾§ï¼šé¡µé¢ç®¡ç† -->
              <div class="lg:col-span-1 space-y-4">
                <div class="bg-white rounded border border-slate-200 p-4">
                  <h3 class="font-semibold mb-3">é¡µé¢ç®¡ç†</h3>
                  
                  <!-- æ·»åŠ é¡µé¢è¡¨å• -->
                  <form id="addPageForm" class="mb-4 space-y-3">
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">é¡µé¢åç§°</label>
                      <input type="text" name="name" class="w-full px-3 py-2 border border-slate-300 rounded text-sm" placeholder="ä¾‹å¦‚: 3Då»ºæ¨¡å¹³å°" required>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">é¡µé¢URL</label>
                      <input type="url" name="url" class="w-full px-3 py-2 border border-slate-300 rounded text-sm" placeholder="https://example.com" required>
                    </div>
                    <button type="submit" class="w-full px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                      æ·»åŠ é¡µé¢
                    </button>
                  </form>
                  
                  <!-- é¡µé¢åˆ—è¡¨ -->
                  <div>
                    <div class="text-sm font-medium text-slate-700 mb-2">å·²æ·»åŠ çš„é¡µé¢</div>
                    <div id="pagesList" class="space-y-2">
                      <!-- åŠ¨æ€ç”Ÿæˆé¡µé¢åˆ—è¡¨ -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- å³ä¾§ï¼šé¡µé¢é¢„è§ˆ -->
              <div class="lg:col-span-2">
                <div class="bg-white rounded border border-slate-200 h-[600px] relative">
                  <!-- æ— é¡µé¢é€‰ä¸­çŠ¶æ€ -->
                  <div id="noPageSelected" class="flex flex-col items-center justify-center h-full text-slate-500">
                    <div class="text-6xl mb-4">ğŸ“±</div>
                    <div class="text-lg font-medium mb-2">è¯·é€‰æ‹©ä¸€ä¸ªé¡µé¢</div>
                    <div class="text-sm">ä»å·¦ä¾§é¡µé¢åˆ—è¡¨æˆ–ä¾§è¾¹æ ä¸­é€‰æ‹©è¦é¢„è§ˆçš„é¡µé¢</div>
                  </div>
                  
                  <!-- é¡µé¢é¢„è§ˆåŒºåŸŸ -->
                  <div id="pagePreviewContainer" class="hidden h-full flex flex-col">
                    <div class="flex items-center justify-between p-3 border-b border-slate-200">
                      <div class="font-medium" id="currentPageName">é¡µé¢åç§°</div>
                      <a id="openInNew" href="#" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 hidden">
                        åœ¨æ–°çª—å£æ‰“å¼€ â†—
                      </a>
                    </div>
                    <div class="flex-1 relative">
                      <iframe id="pagePreview" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
                      <div id="pageLoadError" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 hidden">
                        <div class="text-4xl mb-2">âš ï¸</div>
                        <div class="text-slate-600 text-center">
                          <div class="font-medium mb-1">æ— æ³•åŠ è½½é¡µé¢</div>
                          <div class="text-sm">è¯¥ç«™ç‚¹å¯èƒ½ç¦æ­¢åœ¨iframeä¸­æ˜¾ç¤ºæˆ–å­˜åœ¨è·¨åŸŸé™åˆ¶</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
              <!-- å·¦ä¾§ï¼šé¡µé¢ç®¡ç† -->
              <div class="lg:col-span-1 space-y-4">
                <!-- æ·»åŠ æ–°é¡µé¢ -->
                <div class="bg-white rounded border border-slate-200 p-4">
                  <div class="font-semibold mb-3">æ·»åŠ ç¬¬ä¸‰æ–¹é¡µé¢</div>                  <form id="addPageForm" class="space-y-3">
                    <input required name="name" placeholder="é¡µé¢åç§°" class="w-full px-3 py-2 rounded border border-slate-300" />
                    <input required name="url" placeholder="é¡µé¢URL" class="w-full px-3 py-2 rounded border border-slate-300" />
                    <button type="submit" class="w-full px-3 py-2 rounded bg-indigo-600 text-white">æ·»åŠ é¡µé¢</button>
                  </form>
                </div>

                <!-- é¡µé¢åˆ—è¡¨ç®¡ç† -->
                <div class="bg-white rounded border border-slate-200">
                  <div class="p-4 flex items-center justify-between border-b border-slate-200">
                    <div class="font-semibold">é¡µé¢ç®¡ç†</div>
                    <div class="text-xs text-slate-500">æ‹–æ‹½æ’åº</div>
                  </div>
                  <div id="pagesList" class="p-2 space-y-2">
                    <!-- åŠ¨æ€ç”Ÿæˆé¡µé¢åˆ—è¡¨ -->
                  </div>
                </div>
              </div>

              <!-- å³ä¾§ï¼šé¡µé¢é¢„è§ˆ -->
              <div class="lg:col-span-2">
                <div class="bg-white rounded border border-slate-200">
                  <div class="p-4 flex items-center justify-between border-b border-slate-200">
                    <div class="font-semibold">é¡µé¢é¢„è§ˆ</div>
                    <div class="flex items-center gap-2">
                      <span id="currentPageName" class="text-sm text-slate-500">è¯·é€‰æ‹©ä¸€ä¸ªé¡µé¢</span>
                      <a id="openInNew" target="_blank" rel="noopener" class="px-3 py-1.5 text-sm rounded border border-slate-200 hidden">æ–°çª—å£æ‰“å¼€</a>
                    </div>
                  </div>
                  <div class="relative">
                    <div id="noPageSelected" class="h-96 flex items-center justify-center text-slate-500">
                      è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡µé¢è¿›è¡Œé¢„è§ˆ
                    </div>
                    <iframe id="pagePreview" class="w-full h-96 bg-white hidden" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
                    <div id="pageLoadError" class="absolute inset-0 hidden items-center justify-center bg-white/90 text-sm text-slate-600">
                      <div class="text-center">
                        <div>æ— æ³•åŠ è½½æ­¤é¡µé¢</div>
                        <div class="text-xs mt-1">å¯èƒ½è¢«ç«™ç‚¹ç­–ç•¥ç¦æ­¢å†…åµŒï¼Œè¯·ä½¿ç”¨å³ä¸Šè§’"æ–°çª—å£æ‰“å¼€"</div>
                      </div>
                    </div>
                  </div>
                <div class="mt-3 border border-slate-200 rounded overflow-hidden">
                  <div class="bg-slate-50 text-xs text-slate-500 px-3 py-2">Keepwork é¢„è§ˆ</div>
                  <div class="relative">
                    <iframe id="keepworkFrame" class="w-full h-96 bg-white" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
                    <div id="keepworkHint" class="absolute inset-0 hidden items-center justify-center bg-white/80 text-sm text-slate-600">
                      æ— æ³•å†…åµŒæ­¤é¡µé¢ï¼ˆå¯èƒ½è¢«ç«™ç‚¹ç­–ç•¥ç¦æ­¢ï¼‰ã€‚è¯·ä½¿ç”¨å³ä¸Šè§’â€œæ–°çª—å£â€æ‰“å¼€ã€‚
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <footer class="p-4 text-xs text-slate-500">Â© 2025 æ™ºåŒ  ç®¡ç†ç³»ç»Ÿ</footer>
      </main>
    </div>

    <!-- ç§»åŠ¨ç«¯æŠ½å±‰èœå•ï¼ˆç®€å•ç‰ˆï¼‰ -->
    <div id="mobileDrawer" class="fixed inset-0 bg-black/40 hidden">
      <div class="absolute left-0 top-0 bottom-0 w-72 bg-white border-r border-slate-200 p-3">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">èœå•</div>
          <button id="mobileClose" class="px-3 py-2 rounded border border-slate-200">å…³é—­</button>
        </div>
        <nav class="mt-3 space-y-1">
          <button data-target="overview" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100 font-medium bg-slate-100">
            <span>ğŸ“Š</span><span>æ¦‚è§ˆ</span>
          </button>
          <button data-target="plan" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ—“ï¸</span><span>ç”Ÿäº§è®¡åˆ’</span></button>
          <button data-target="schedule" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ“…</span><span>è°ƒåº¦å®‰æ’</span></button>
          <button data-target="tasks" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ§°</span><span>ç”Ÿäº§ä»»åŠ¡</span></button>
          <button data-target="quality" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>âœ…</span><span>è´¨é‡æ£€æµ‹</span></button>
          <button data-target="equipment" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ› ï¸</span><span>è®¾å¤‡ç›‘æ§</span></button>          <button data-target="analytics" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ“ˆ</span><span>åˆ†ææŠ¥è¡¨</span></button>
          <button data-target="integrations" class="nav-btn w-full flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-slate-100"><span>ğŸ§©</span><span>3Dè™šä»¿é›†æˆ</span></button>
          <div id="integratedPagesListMobile" class="ml-6 space-y-1">
            <!-- åŠ¨æ€ç”Ÿæˆçš„é›†æˆé¡µé¢åˆ—è¡¨ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
          </div>
        </nav>
      </div>
    </div>
    <script>
      // -------------------------
      // ç®€æ˜“çŠ¶æ€ç®¡ç†ä¸æŒä¹…åŒ–
      // -------------------------
      const nowISO = () => new Date().toISOString();
      const todayStr = () => new Date().toISOString().slice(0, 10);
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });      
      const defaultState = {
        plans: [],
        schedules: [],
        tasks: [],
        quality: [],
        equipment: [
          { id: "E-1001", name: "CNC-1 å·", status: "è¿è¡Œ", temp: 35, vib: 2.1, updatedAt: nowISO() },
          { id: "E-1002", name: "CNC-2 å·", status: "åœæœº", temp: 29, vib: 0.6, updatedAt: nowISO() },
          { id: "E-2001", name: "æœºå™¨äºº-è‡‚", status: "è¿è¡Œ", temp: 42, vib: 3.2, updatedAt: nowISO() },
          { id: "E-3001", name: "æ¿€å…‰åˆ‡å‰²", status: "è¿è¡Œ", temp: 38, vib: 2.7, updatedAt: nowISO() },
          { id: "E-4001", name: "æ£€æµ‹å·¥ä½", status: "æ•…éšœ", temp: 45, vib: 4.5, updatedAt: nowISO() },
        ],
        integratedPages: [
          { id: "page-1", name: "Keepwork", url: "https://keepwork.com", order: 1 },
          { id: "page-2", name: "Paracraft", url: "https://paracraft.cn", order: 2 },
          { id: "page-3", name: "3Då»ºæ¨¡å¹³å°", url: "https://www.tinkercad.com", order: 3 }
        ],
        currentPageId: null,
        settings: {
          keepworkUrl: "",
          paracraftWebUrl: "",
          paracraftDeepLink: ""
        },
        seeded: false,
      };

      let state = null;
      async function loadState() {
        try {
          const data = await sdk.personalPageStore.loadPageData("imom_system", "state");          // Check if data has the expected structure with required arrays
          if (
            data &&
            data.plans &&
            Array.isArray(data.plans) &&
            data.schedules &&
            Array.isArray(data.schedules) &&
            data.tasks &&
            Array.isArray(data.tasks) &&
            data.quality &&
            Array.isArray(data.quality) &&
            data.equipment &&
            Array.isArray(data.equipment) &&
            data.integratedPages &&
            Array.isArray(data.integratedPages)
          ) {
            state = structuredClone(data);
          } else {
            console.warn("åŠ è½½çš„æ•°æ®ç»“æ„ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€");
            state = structuredClone(defaultState);
          }
        } catch (e) {
          console.warn("è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤", e);
          state = structuredClone(defaultState);
        }
      }
      function saveState() {
        sdk.personalPageStore
          .savePageData("imom_system", "state", state)
          .then(() => {
            updateAll();
          })
          .catch((e) => {
            console.warn("ä¿å­˜æ•°æ®å¤±è´¥", e);
            updateAll();
          });
      }

      // -------------------------
      // å·¥å…·
      // -------------------------
      function fmt(n) {
        return Number(n).toLocaleString("zh-CN");
      }
      function badge(text, color) {
        const colors = {
          æœªå¼€å§‹: "bg-slate-100 text-slate-700",
          è¿›è¡Œä¸­: "bg-amber-100 text-amber-800",
          å·²å®Œæˆ: "bg-emerald-100 text-emerald-800",
          è¿è¡Œ: "bg-emerald-100 text-emerald-800",
          åœæœº: "bg-slate-100 text-slate-700",
          æ•…éšœ: "bg-rose-100 text-rose-800",
          æœªè°ƒåº¦: "bg-slate-100 text-slate-700",
          å·²è°ƒåº¦: "bg-indigo-100 text-indigo-800",
        };
        const cls = colors[text] || "bg-slate-100 text-slate-700";
        return `<span class="px-2 py-1 text-xs rounded ${cls}">${text}</span>`;
      }
      function byId(id) {
        return document.getElementById(id);
      }
      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      // -------------------------
      // å¯¼èˆª
      // -------------------------
      function setActiveSection(name) {
        document.querySelectorAll(".section").forEach((el) => {
          if (el.getAttribute("data-section") === name) {
            el.classList.remove("hidden");
            el.classList.add("fade-enter");
            requestAnimationFrame(() => {
              el.classList.add("fade-enter-active");
              setTimeout(() => el.classList.remove("fade-enter", "fade-enter-active"), 200);
            });
          } else {
            el.classList.add("hidden");
          }
        });
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          const active = btn.getAttribute("data-target") === name;
          btn.classList.toggle("bg-slate-100", active);
          btn.classList.toggle("font-medium", active);
        });
        // å…³é—­ç§»åŠ¨æŠ½å±‰
        byId("mobileDrawer").classList.add("hidden");
      }

      // -------------------------
      // æ¦‚è§ˆ KPI ä¸å›¾è¡¨
      // -------------------------
      let chartThroughput, chartEquipment, chartDefects, chartAnalytics;
      function calcKPIs() {
        // Ensure state arrays exist and are arrays
        const tasks = Array.isArray(state.tasks) ? state.tasks : [];
        const plans = Array.isArray(state.plans) ? state.plans : [];
        const quality = Array.isArray(state.quality) ? state.quality : [];
        const equipment = Array.isArray(state.equipment) ? state.equipment : [];

        const today = todayStr();
        const todayOutput = tasks.filter((t) => t.status === "å·²å®Œæˆ" && (t.completedAt || "").slice(0, 10) === today).reduce((sum, t) => sum + Number(t.qty || 0), 0);

        const totalPlanned = plans.reduce((s, p) => s + Number(p.qty || 0), 0);
        const totalCompleted = tasks.filter((t) => t.status === "å·²å®Œæˆ").reduce((s, t) => s + Number(t.qty || 0), 0);
        const wip = Math.max(totalPlanned - totalCompleted, 0);

        const totalQualityQty = quality.reduce((s, q) => s + Number(q.qty || 0), 0);
        const okQty = quality.filter((q) => q.result === "åˆæ ¼").reduce((s, q) => s + Number(q.qty || 0), 0);
        const yieldRate = totalQualityQty ? Math.round((okQty / totalQualityQty) * 100) : 100;

        const online = equipment.filter((e) => e.status === "è¿è¡Œ").length;
        const uptime = equipment.length ? Math.round((online / equipment.length) * 100) : 0;

        return { todayOutput, wip, yieldRate, uptime };
      }

      function updateKPIs() {
        const k = calcKPIs();
        byId("kpi-today-output").textContent = fmt(k.todayOutput);
        byId("kpi-wip").textContent = fmt(k.wip);
        byId("kpi-yield").textContent = isFinite(k.yieldRate) ? k.yieldRate : "--";
        byId("kpi-uptime").textContent = isFinite(k.uptime) ? k.uptime : "--";
      }

      function aggThroughputLast7() {
        // è¿‘7å¤©ä»»åŠ¡å®Œæˆæ•°é‡
        const days = [];
        const data = [];
        const d = new Date();
        for (let i = 6; i >= 0; i--) {
          const di = new Date(d);
          di.setDate(d.getDate() - i);
          const key = di.toISOString().slice(0, 10);
          const label = `${di.getMonth() + 1}/${di.getDate()}`;
          days.push(label);
          const sum = state.tasks.filter((t) => t.status === "å·²å®Œæˆ" && (t.completedAt || "").slice(0, 10) === key).reduce((s, t) => s + Number(t.qty || 0), 0);
          data.push(sum);
        }
        return { labels: days, data };
      }

      function updateOverviewCharts() {
        // äº§é‡è¶‹åŠ¿
        const t = aggThroughputLast7();
        if (!chartThroughput) {
          chartThroughput = new Chart(byId("chart-throughput").getContext("2d"), {
            type: "line",
            data: {
              labels: t.labels,
              datasets: [
                {
                  label: "å®Œæˆæ•°é‡",
                  data: t.data,
                  borderColor: "#4f46e5",
                  backgroundColor: "rgba(79,70,229,.15)",
                  tension: 0.3,
                  fill: true,
                  pointRadius: 3,
                },
              ],
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
          });
        } else {
          chartThroughput.data.labels = t.labels;
          chartThroughput.data.datasets[0].data = t.data;
          chartThroughput.update();
        }

        // è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ
        const run = state.equipment.filter((e) => e.status === "è¿è¡Œ").length;
        const stop = state.equipment.filter((e) => e.status === "åœæœº").length;
        const fault = state.equipment.filter((e) => e.status === "æ•…éšœ").length;
        const eLabels = ["è¿è¡Œ", "åœæœº", "æ•…éšœ"];
        const eData = [run, stop, fault];
        if (!chartEquipment) {
          chartEquipment = new Chart(byId("chart-equipment").getContext("2d"), {
            type: "doughnut",
            data: {
              labels: eLabels,
              datasets: [
                {
                  data: eData,
                  backgroundColor: ["#10b981", "#94a3b8", "#ef4444"],
                },
              ],
            },
            options: { responsive: true, plugins: { legend: { position: "bottom" } } },
          });
        } else {
          chartEquipment.data.labels = eLabels;
          chartEquipment.data.datasets[0].data = eData;
          chartEquipment.update();
        }
      }

      // -------------------------
      // è®¡åˆ’
      // -------------------------
      function renderPlans() {
        const tbody = document.querySelector("#planTable");
        tbody.innerHTML = "";
        state.plans.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="px-4 py-2">${p.product}</td>
          <td class="px-4 py-2">${fmt(p.qty)}</td>
          <td class="px-4 py-2">${p.start}</td>
          <td class="px-4 py-2">${p.end}</td>
          <td class="px-4 py-2">${badge(p.status || "æœªè°ƒåº¦")}</td>
          <td class="px-4 py-2 text-right">
            <div class="inline-flex gap-2">
              <button class="px-2 py-1 text-xs rounded border border-slate-200" data-act="toSchedule" data-id="${p.id}">å¼€å§‹è°ƒåº¦</button>
              <button class="px-2 py-1 text-xs rounded border border-rose-200 text-rose-600" data-act="delPlan" data-id="${p.id}">åˆ é™¤</button>
            </div>
          </td>`;
          tbody.appendChild(tr);
        });
        // äº‹ä»¶ä»£ç†
        tbody.querySelectorAll("button[data-act='toSchedule']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            const plan = state.plans.find((x) => x.id === id);
            if (!plan) return;
            state.schedules.push({ id: crypto.randomUUID(), planId: plan.id, line: "L-1", priority: 1, date: plan.start });
            plan.status = "å·²è°ƒåº¦";
            saveState();
          };
        });
        tbody.querySelectorAll("button[data-act='delPlan']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            state.plans = state.plans.filter((x) => x.id !== id);
            // åŒæ­¥åˆ é™¤ schedule ä¸­å¼•ç”¨
            state.schedules = state.schedules.filter((s) => s.planId !== id);
            saveState();
          };
        });
      }

      // -------------------------
      // è°ƒåº¦
      // -------------------------
      function renderSchedules() {
        const tbody = document.querySelector("#scheduleTable");
        tbody.innerHTML = "";
        const list = [...state.schedules].sort((a, b) => Number(a.priority) - Number(b.priority));
        list.forEach((s, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="px-4 py-2">${idx + 1}</td>
          <td class="px-4 py-2">${s.planId}</td>
          <td class="px-4 py-2">${s.line}</td>
          <td class="px-4 py-2">${s.date}</td>
          <td class="px-4 py-2">${s.priority}</td>
          <td class="px-4 py-2 text-right">
            <div class="inline-flex gap-2">
              <button class="px-2 py-1 text-xs rounded border border-slate-200" data-act="toTask" data-id="${s.id}">ç”Ÿæˆä»»åŠ¡</button>
              <button class="px-2 py-1 text-xs rounded border border-rose-200 text-rose-600" data-act="delSchedule" data-id="${s.id}">åˆ é™¤</button>
            </div>
          </td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll("button[data-act='toTask']").forEach((btn) => {
          btn.onclick = () => {
            const sid = btn.getAttribute("data-id");
            const s = state.schedules.find((x) => x.id === sid);
            const p = s ? state.plans.find((x) => x.id === s.planId) : null;
            if (!s || !p) return;
            // ç®€åŒ–ï¼šè®¡åˆ’æ‹†åˆ†ä¸ºä¸€ä¸ªä»»åŠ¡
            state.tasks.push({
              id: crypto.randomUUID(),
              taskName: `${p.product} ç”Ÿäº§`,
              assignee: "å­¦ç”ŸA",
              qty: Number(p.qty),
              deadline: p.end,
              status: "æœªå¼€å§‹",
              createdAt: nowISO(),
            });
            saveState();
            alert("å·²ç”Ÿæˆç”Ÿäº§ä»»åŠ¡ï¼Œå¯å‰å¾€â€œç”Ÿäº§ä»»åŠ¡â€æŸ¥çœ‹");
          };
        });
        tbody.querySelectorAll("button[data-act='delSchedule']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            state.schedules = state.schedules.filter((x) => x.id !== id);
            saveState();
          };
        });
      }

      // -------------------------
      // ä»»åŠ¡
      // -------------------------
      function renderTasks() {
        const tbody = document.querySelector("#taskTable");
        tbody.innerHTML = "";
        state.tasks.forEach((t, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="px-4 py-2">${idx + 1}</td>
          <td class="px-4 py-2">${t.taskName}</td>
          <td class="px-4 py-2">${t.assignee}</td>
          <td class="px-4 py-2">${fmt(t.qty)}</td>
          <td class="px-4 py-2">${t.deadline}</td>
          <td class="px-4 py-2">${badge(t.status)}</td>
          <td class="px-4 py-2 text-right">
            <div class="inline-flex gap-2">
              <button class="px-2 py-1 text-xs rounded border border-slate-200" data-act="start" data-id="${t.id}">å¼€å§‹</button>
              <button class="px-2 py-1 text-xs rounded border border-emerald-200 text-emerald-700" data-act="done" data-id="${t.id}">å®Œæˆ</button>
              <button class="px-2 py-1 text-xs rounded border border-rose-200 text-rose-600" data-act="delTask" data-id="${t.id}">åˆ é™¤</button>
            </div>
          </td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll("button[data-act='start']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            const t = state.tasks.find((x) => x.id === id);
            if (!t) return;
            t.status = "è¿›è¡Œä¸­";
            t.startedAt = nowISO();
            saveState();
          };
        });
        tbody.querySelectorAll("button[data-act='done']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            const t = state.tasks.find((x) => x.id === id);
            if (!t) return;
            t.status = "å·²å®Œæˆ";
            t.completedAt = nowISO();
            saveState();
          };
        });
        tbody.querySelectorAll("button[data-act='delTask']").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            state.tasks = state.tasks.filter((x) => x.id !== id);
            saveState();
          };
        });
      }

      // -------------------------
      // è´¨é‡
      // -------------------------
      function renderQuality() {
        const tbody = document.querySelector("#qualityTable");
        tbody.innerHTML = "";
        state.quality.forEach((q, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="px-4 py-2">${idx + 1}</td>
          <td class="px-4 py-2">${q.batch}</td>
          <td class="px-4 py-2">${q.item}</td>
          <td class="px-4 py-2">${badge(q.result)}</td>
          <td class="px-4 py-2">${q.result === "ä¸åˆæ ¼" ? q.defect || "-" : "-"}</td>
          <td class="px-4 py-2">${fmt(q.qty)}</td>
          <td class="px-4 py-2">${new Date(q.time).toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
        // ç¼ºé™·åˆ†å¸ƒ
        const map = new Map();
        state.quality
          .filter((q) => q.result === "ä¸åˆæ ¼")
          .forEach((q) => {
            const k = q.defect || "æœªåˆ†ç±»";
            map.set(k, (map.get(k) || 0) + Number(q.qty || 0));
          });
        const labels = Array.from(map.keys());
        const data = Array.from(map.values());
        if (!chartDefects) {
          chartDefects = new Chart(byId("chart-defects").getContext("2d"), {
            type: "pie",
            data: { labels, datasets: [{ data, backgroundColor: ["#f59e0b", "#ef4444", "#10b981", "#3b82f6", "#a855f7", "#06b6d4"] }] },
            options: { responsive: true, plugins: { legend: { position: "bottom" } } },
          });
        } else {
          chartDefects.data.labels = labels;
          chartDefects.data.datasets[0].data = data;
          chartDefects.update();
        }
      }

      // -------------------------
      // è®¾å¤‡
      // -------------------------
      function renderEquipment() {
        const tbody = document.querySelector("#equipmentTable");
        tbody.innerHTML = "";
        state.equipment.forEach((e, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="px-4 py-2">${idx + 1}</td>
          <td class="px-4 py-2">${e.name} <span class="text-xs text-slate-400 ml-1">(${e.id})</span></td>
          <td class="px-4 py-2">${badge(e.status)}</td>
          <td class="px-4 py-2">${e.temp.toFixed(1)}</td>
          <td class="px-4 py-2">${e.vib.toFixed(1)}</td>
          <td class="px-4 py-2">${new Date(e.updatedAt).toLocaleTimeString()}</td>
          <td class="px-4 py-2 text-right">
            <div class="inline-flex gap-2">
              <button class="px-2 py-1 text-xs rounded border border-slate-200" data-act="run" data-id="${e.id}">è¿è¡Œ</button>
              <button class="px-2 py-1 text-xs rounded border border-slate-200" data-act="stop" data-id="${e.id}">åœæœº</button>
              <button class="px-2 py-1 text-xs rounded border border-rose-200 text-rose-600" data-act="fault" data-id="${e.id}">æ•…éšœ</button>
            </div>
          </td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll("button").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            const act = btn.getAttribute("data-act");
            const e = state.equipment.find((x) => x.id === id);
            if (!e) return;
            if (act === "run") e.status = "è¿è¡Œ";
            if (act === "stop") e.status = "åœæœº";
            if (act === "fault") e.status = "æ•…éšœ";
            e.updatedAt = nowISO();
            saveState();
          };
        });
      }
      function tickEquipmentSensors() {
        // ç®€æ˜“æ¨¡æ‹Ÿï¼šæ¸©åº¦ã€æŒ¯åŠ¨åœ¨åˆç†èŒƒå›´å†…éšæœºæ³¢åŠ¨ï¼ŒçŠ¶æ€å½±å“èŒƒå›´
        state.equipment.forEach((e) => {
          let tDelta = (Math.random() - 0.5) * 2;
          let vDelta = (Math.random() - 0.5) * 0.6;
          if (e.status === "è¿è¡Œ") {
            tDelta += 0.3;
            vDelta += 0.2;
          }
          if (e.status === "åœæœº") {
            tDelta -= 0.4;
            vDelta -= 0.2;
          }
          if (e.status === "æ•…éšœ") {
            tDelta += 1.0;
            vDelta += 0.8;
          }
          e.temp = Math.max(20, Math.min(80, e.temp + tDelta));
          e.vib = Math.max(0, Math.min(10, e.vib + vDelta));
          e.updatedAt = nowISO();
        });
        // Note: Removed saveState() - sensor data is simulated and doesn't need persistent storage
        // Only save when user makes actual changes (equipment status changes, etc.)
      }

      // -------------------------
      // åˆ†ææŠ¥è¡¨
      // -------------------------
      function generateAnalytics(metric, from, to, product) {
        // ç®€åŒ–ï¼šä»…ä½¿ç”¨å·²æœ‰æ•°æ®æ„é€  14 å¤©è¶‹åŠ¿
        const labels = [];
        const data = [];
        const d = new Date();
        for (let i = 13; i >= 0; i--) {
          const di = new Date(d);
          di.setDate(d.getDate() - i);
          const key = di.toISOString().slice(0, 10);
          const label = `${di.getMonth() + 1}/${di.getDate()}`;
          labels.push(label);
          if (metric === "throughput") {
            const sum = state.tasks
              .filter((t) => {
                const day = (t.completedAt || "").slice(0, 10);
                const matchDay = t.status === "å·²å®Œæˆ" && day === key;
                const matchProd = product ? (t.taskName || "").includes(product) : true;
                return matchDay && matchProd;
              })
              .reduce((s, t) => s + Number(t.qty || 0), 0);
            data.push(sum);
          } else if (metric === "yield") {
            const dayAll = state.quality.filter((q) => (q.time || "").slice(0, 10) === key);
            const all = dayAll.reduce((s, q) => s + Number(q.qty || 0), 0);
            const ok = dayAll.filter((q) => q.result === "åˆæ ¼").reduce((s, q) => s + Number(q.qty || 0), 0);
            data.push(all ? Math.round((ok / all) * 100) : 100);
          } else if (metric === "downtime") {
            // ç²—ç•¥ï¼šæ•…éšœ+åœæœºå æ¯”ï¼ˆåŸºäºè®¾å¤‡æ•°é‡ï¼‰
            const run = state.equipment.filter((e) => e.status === "è¿è¡Œ").length;
            const rate = state.equipment.length ? Math.round(((state.equipment.length - run) / state.equipment.length) * 100) : 0;
            data.push(rate);
          }
        }
        return { labels, data };
      }

      function renderAnalytics(metric = "throughput", from = "", to = "", product = "") {
        const res = generateAnalytics(metric, from, to, product);
        if (!chartAnalytics) {
          chartAnalytics = new Chart(byId("chart-analytics").getContext("2d"), {
            type: metric === "throughput" ? "bar" : "line",
            data: { labels: res.labels, datasets: [{ label: metric, data: res.data, backgroundColor: "#4f46e5", borderColor: "#4f46e5", fill: metric !== "throughput", tension: 0.3 }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
          });
        } else {
          chartAnalytics.config.type = metric === "throughput" ? "bar" : "line";
          chartAnalytics.data.labels = res.labels;
          chartAnalytics.data.datasets[0].data = res.data;
          chartAnalytics.update();
        }
        // ç”Ÿæˆç®€çŸ­æ´å¯Ÿ
        const insights = byId("analyticsInsights");
        insights.innerHTML = "";
        const max = Math.max(...res.data);
        const min = Math.min(...res.data);
        const avg = res.data.reduce((s, x) => s + x, 0) / (res.data.length || 1);
        const li = (t) => {
          const el = document.createElement("li");
          el.textContent = t;
          insights.appendChild(el);
        };
        if (metric === "throughput") {
          li(`è¿‘ä¸¤å‘¨æœ€é«˜äº§é‡ï¼š${fmt(max)} ä»¶ï¼›æœ€ä½ï¼š${fmt(min)} ä»¶ï¼›å¹³å‡ï¼š${fmt(Math.round(avg))} ä»¶`);
        } else if (metric === "yield") {
          li(`è¿‘ä¸¤å‘¨åˆæ ¼ç‡å‡å€¼ï¼š${Math.round(avg)}%`);
          li(`æœ€ä½åˆæ ¼ç‡ï¼š${min}%ï¼Œå…³æ³¨å½“å¤©å·¥è‰ºä¸æ£€éªŒæµç¨‹`);
        } else {
          li(`è¿‘ä¸¤å‘¨å¹³å‡åœæœºç‡ï¼š${Math.round(avg)}%`);
          li(`æœ€å¤§åœæœºç‡ï¼š${max}%ï¼›å»ºè®®æ’æŸ¥è®¾å¤‡ç»´æŠ¤ä¸å¤‡ä»¶ä¿éšœ`);
        }
      }

      // -------------------------
      // å¯¼å‡º CSV
      // -------------------------
      function exportToCSV(rows, filename) {
        const escape = (v) => {
          const s = String(v ?? "");
          if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
          return s;
        };
        const csv = rows.map((r) => r.map(escape).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // -------------------------
      // 3Dè™šä»¿é›†æˆï¼šKeepwork / Paracraft
      // -------------------------
      function tryLoadIframe(iframe, url, hintEl) {
        hintEl.classList.add("hidden");
        if (!url) {
          iframe.removeAttribute("src");
          return;
        }
        iframe.onload = () => {
          /* å¯èƒ½è·¨åŸŸï¼Œonload ä¸ä»£è¡¨å¯é€šä¿¡ */
        };
        iframe.onerror = () => {
          hintEl.classList.remove("hidden");
        };
        iframe.src = url;
        // è¶…æ—¶æç¤ºï¼ˆç«™ç‚¹å¯èƒ½é€šè¿‡ X-Frame-Options ç¦æ­¢ï¼‰
        setTimeout(() => {
          // ç®€å•æ£€æµ‹ï¼šè‹¥ä»ä¸º about:blank æˆ–æ— å†…å®¹é«˜åº¦ï¼Œæ˜¾ç¤ºæç¤º
          try {
            if (!iframe.contentWindow || iframe.contentWindow.location.href === "about:blank") {
              hintEl.classList.remove("hidden");
            }
          } catch (e) {
            // è·¨åŸŸè®¿é—®ä¼šæŠ›å¼‚å¸¸ï¼Œç›´æ¥å¿½ç•¥ï¼Œäº¤ç”±å¯è§†åˆ¤æ–­
          }
        }, 1500);
      }      function initIntegrationsUI() {
        // æ¸²æŸ“é¡µé¢åˆ—è¡¨
        renderIntegratedPages();
        
        // ä¸è‡ªåŠ¨æ¢å¤ä¹‹å‰é€‰ä¸­çš„é¡µé¢ï¼Œåªåœ¨ç”¨æˆ·ç‚¹å‡»æ—¶æ‰åŠ è½½
        // é‡ç½®é¢„è§ˆåŒºåŸŸåˆ°é»˜è®¤çŠ¶æ€
        resetPagePreview();
        
        // ç»‘å®šæ·»åŠ é¡µé¢è¡¨å•
        const addPageForm = byId("addPageForm");
        if (addPageForm) {
          addPageForm.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get("name")?.trim();
            const url = formData.get("url")?.trim();
            
            if (!name || !url) {
              alert("è¯·è¾“å…¥é¡µé¢åç§°å’ŒURL");
              return;
            }
            
            // éªŒè¯URLæ ¼å¼
            try {
              new URL(url);
            } catch (error) {
              alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URLæ ¼å¼ï¼ˆå¦‚ https://example.comï¼‰");
              return;
            }
            
            // æ£€æŸ¥åç§°æ˜¯å¦é‡å¤
            if (state.integratedPages.some(p => p.name === name)) {
              alert("é¡µé¢åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„åç§°");
              return;
            }
            
            // æ·»åŠ æ–°é¡µé¢
            const maxOrder = Math.max(...state.integratedPages.map(p => p.order || 0), 0);
            state.integratedPages.push({
              id: crypto.randomUUID(),
              name: name,
              url: url,
              order: maxOrder + 1
            });
            
            e.target.reset();
            saveState();
          };
        }
      }

      function renderIntegratedPages() {
        // æ¸²æŸ“é¡µé¢ç®¡ç†åˆ—è¡¨
        const pagesList = byId("pagesList");
        if (!pagesList) return;
        
        const sortedPages = [...state.integratedPages].sort((a, b) => (a.order || 0) - (b.order || 0));
        
        pagesList.innerHTML = "";
        
        sortedPages.forEach((page, index) => {
          const pageItem = document.createElement("div");
          pageItem.className = "flex items-center gap-3 p-3 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors";
          pageItem.draggable = true;
          pageItem.dataset.pageId = page.id;
          
          pageItem.innerHTML = `
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${page.name}</div>
              <div class="text-xs text-slate-500 truncate">${page.url}</div>
            </div>
            <div class="flex items-center gap-1">
              <button class="p-1 hover:bg-slate-200 rounded text-slate-500" data-action="edit" data-page-id="${page.id}" title="ç¼–è¾‘">
                âœï¸
              </button>
              <button class="p-1 hover:bg-red-200 rounded text-red-600" data-action="delete" data-page-id="${page.id}" title="åˆ é™¤">
                ğŸ—‘ï¸
              </button>
            </div>
          `;
          
          // ç‚¹å‡»é€‰æ‹©é¡µé¢
          pageItem.addEventListener("click", (e) => {
            if (e.target.tagName === 'BUTTON') return; // å¿½ç•¥æŒ‰é’®ç‚¹å‡»
            selectPage(page.id);
          });
          
          // æ‹–æ‹½æ’åº
          pageItem.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", page.id);
          });
          
          pageItem.addEventListener("dragover", (e) => {
            e.preventDefault();
          });
          
          pageItem.addEventListener("drop", (e) => {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData("text/plain");
            if (draggedId !== page.id) {
              reorderPages(draggedId, page.id);
            }
          });
          
          pagesList.appendChild(pageItem);
        });
        
        // ç»‘å®šæ“ä½œæŒ‰é’®
        pagesList.addEventListener("click", (e) => {
          if (e.target.dataset.action === "edit") {
            editPage(e.target.dataset.pageId);
          } else if (e.target.dataset.action === "delete") {
            deletePage(e.target.dataset.pageId);
          }
        });
        
        // æ¸²æŸ“ä¾§è¾¹æ é¡µé¢åˆ—è¡¨
        renderSidebarPageList();
      }

      function renderSidebarPageList() {
        const sidebarList = byId("integratedPagesList");
        const mobileList = byId("integratedPagesListMobile");
        
        const sortedPages = [...state.integratedPages].sort((a, b) => (a.order || 0) - (b.order || 0));
        
        [sidebarList, mobileList].forEach(list => {
          if (!list) return;
          list.innerHTML = "";
          
          sortedPages.forEach(page => {
            const pageBtn = document.createElement("button");
            pageBtn.className = "w-full flex items-center gap-2 px-3 py-1.5 rounded text-left hover:bg-slate-100 text-sm text-slate-600";
            pageBtn.innerHTML = `<span>ğŸ”—</span><span class="truncate">${page.name}</span>`;
            pageBtn.onclick = () => {
              setActiveSection("integrations");
              setTimeout(() => selectPage(page.id), 100);
            };
            list.appendChild(pageBtn);
          });
        });
      }      function selectPage(pageId) {
        const page = state.integratedPages.find(p => p.id === pageId);
        if (!page) return;
        
        state.currentPageId = pageId;
        
        // æ›´æ–°é¢„è§ˆåŒºåŸŸ
        const pagePreviewContainer = byId("pagePreviewContainer");
        const noPageMessage = byId("noPageMessage");
        
        if (!pagePreviewContainer) return;
        
        // éšè—æ— é¡µé¢é€‰æ‹©çš„æ¶ˆæ¯
        if (noPageMessage) {
          noPageMessage.style.display = "none";
        }
        
        // æ¸…ç©ºå®¹å™¨å¹¶åˆ›å»ºæ–°çš„iframe
        pagePreviewContainer.innerHTML = `
          <div class="flex items-center justify-between p-3 border-b border-slate-200 bg-slate-50">
            <h3 class="font-medium text-slate-700">${page.name}</h3>
            <a href="${page.url}" target="_blank" 
               class="text-xs px-2 py-1 bg-slate-600 text-white rounded hover:bg-slate-700 transition-colors">
              åœ¨æ–°çª—å£æ‰“å¼€
            </a>
          </div>
          <div class="relative flex-1">
            <iframe 
              id="pageIframe" 
              src="${page.url}" 
              class="w-full h-full border-0"
              onload="document.getElementById('pageLoadError').style.display = 'none';"
              onerror="document.getElementById('pageLoadError').style.display = 'block';">
            </iframe>
            <div id="pageLoadError" 
                 class="absolute inset-0 flex items-center justify-center bg-slate-50 text-slate-500 text-sm"
                 style="display: none;">
              <div class="text-center">
                <div>ğŸš« é¡µé¢åŠ è½½å¤±è´¥</div>
                <div class="text-xs mt-1">å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–é¡µé¢ç¦æ­¢åµŒå…¥</div>
              </div>
            </div>
          </div>
        `;
        
        // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
        pagePreviewContainer.style.display = "flex";
        
        // é«˜äº®é€‰ä¸­çš„é¡µé¢é¡¹
        document.querySelectorAll('[data-page-id]').forEach(el => {
          el.classList.remove('bg-indigo-50', 'border-indigo-200');
        });
        const selectedItem = document.querySelector(`[data-page-id="${pageId}"]`);
        if (selectedItem) {
          selectedItem.classList.add('bg-indigo-50', 'border-indigo-200');
        }
        
        saveState();
      }      function resetPagePreview() {
        const pagePreviewContainer = byId("pagePreviewContainer");
        const noPageMessage = byId("noPageMessage");
        
        if (pagePreviewContainer) {
          pagePreviewContainer.style.display = "none";
          pagePreviewContainer.innerHTML = "";
        }
        
        if (noPageMessage) {
          noPageMessage.style.display = "flex";
        }
        
        // æ¸…é™¤å½“å‰é¡µé¢é€‰æ‹©çŠ¶æ€
        state.currentPageId = null;
        
        // æ¸…é™¤é¡µé¢é¡¹çš„é«˜äº®çŠ¶æ€
        document.querySelectorAll('[data-page-id]').forEach(el => {
          el.classList.remove('bg-indigo-50', 'border-indigo-200');
        });
      }function editPage(pageId) {
        const page = state.integratedPages.find(p => p.id === pageId);
        if (!page) return;
        
        const newName = prompt("è¯·è¾“å…¥é¡µé¢åç§°:", page.name);
        if (newName === null) return;
        
        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("é¡µé¢åç§°ä¸èƒ½ä¸ºç©º");
          return;
        }
        
        // æ£€æŸ¥åç§°æ˜¯å¦ä¸å…¶ä»–é¡µé¢é‡å¤
        if (trimmedName !== page.name && state.integratedPages.some(p => p.name === trimmedName)) {
          alert("é¡µé¢åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„åç§°");
          return;
        }
        
        const newUrl = prompt("è¯·è¾“å…¥é¡µé¢URL:", page.url);
        if (newUrl === null) return;
        
        const trimmedUrl = newUrl.trim();
        if (!trimmedUrl) {
          alert("é¡µé¢URLä¸èƒ½ä¸ºç©º");
          return;
        }
        
        // éªŒè¯URLæ ¼å¼
        try {
          new URL(trimmedUrl);
        } catch (error) {
          alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URLæ ¼å¼ï¼ˆå¦‚ https://example.comï¼‰");
          return;
        }
        
        page.name = trimmedName;
        page.url = trimmedUrl;
        
        // å¦‚æœç¼–è¾‘çš„æ˜¯å½“å‰é€‰ä¸­çš„é¡µé¢ï¼Œéœ€è¦æ›´æ–°é¢„è§ˆ
        if (state.currentPageId === pageId) {
          selectPage(pageId);
        }
        
        saveState();
      }

      function deletePage(pageId) {
        const page = state.integratedPages.find(p => p.id === pageId);
        if (!page) return;
        
        if (confirm(`ç¡®å®šåˆ é™¤é¡µé¢ "${page.name}"ï¼Ÿ`)) {
          state.integratedPages = state.integratedPages.filter(p => p.id !== pageId);
          
          // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é¡µé¢ï¼Œé‡ç½®é¢„è§ˆ
          if (state.currentPageId === pageId) {
            state.currentPageId = null;
            resetPagePreview();
          }
          
          saveState();
        }
      }

      function reorderPages(draggedId, targetId) {
        const draggedIndex = state.integratedPages.findIndex(p => p.id === draggedId);
        const targetIndex = state.integratedPages.findIndex(p => p.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // é‡æ–°æ’åº
        const draggedPage = state.integratedPages[draggedIndex];
        state.integratedPages.splice(draggedIndex, 1);
        state.integratedPages.splice(targetIndex, 0, draggedPage);
        
        // æ›´æ–°orderå­—æ®µ
        state.integratedPages.forEach((page, index) => {
          page.order = index + 1;
        });
        
        saveState();
      }

      function safeJson(text) {
        try {
          return JSON.parse(text);
        } catch (e) {
          alert("è¯·è¾“å…¥åˆæ³• JSON");
          return null;
        }
      }

      // -------------------------
      // è¡¨å•ä¸äº‹ä»¶
      // -------------------------
      function bindForms() {
        byId("planForm").onsubmit = (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          state.plans.push({
            id: crypto.randomUUID(),
            product: fd.get("product"),
            qty: Number(fd.get("qty")),
            start: fd.get("start"),
            end: fd.get("end"),
            status: "æœªè°ƒåº¦",
            createdAt: nowISO(),
          });
          e.target.reset();
          saveState();
        };

        byId("scheduleForm").onsubmit = (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          state.schedules.push({
            id: crypto.randomUUID(),
            planId: fd.get("planId"),
            line: fd.get("line"),
            priority: Number(fd.get("priority")),
            date: fd.get("date"),
          });
          e.target.reset();
          saveState();
        };

        byId("taskForm").onsubmit = (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          state.tasks.push({
            id: crypto.randomUUID(),
            taskName: fd.get("taskName"),
            assignee: fd.get("assignee"),
            qty: Number(fd.get("qty")),
            deadline: fd.get("deadline"),
            status: fd.get("status"),
            createdAt: nowISO(),
          });
          e.target.reset();
          saveState();
        };

        byId("qualityForm").onsubmit = (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          state.quality.push({
            id: crypto.randomUUID(),
            batch: fd.get("batch"),
            item: fd.get("item"),
            result: fd.get("result"),
            defect: fd.get("result") === "ä¸åˆæ ¼" ? fd.get("defect") || "æœªåˆ†ç±»" : "",
            qty: Number(fd.get("qty")),
            time: nowISO(),
          });
          e.target.reset();
          saveState();
        };

        byId("analyticsForm").onsubmit = (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          renderAnalytics(fd.get("metric"), fd.get("from"), fd.get("to"), fd.get("product"));
        };

        byId("exportQualityBtn").onclick = () => {
          const rows = [["åºå·", "æ‰¹æ¬¡", "é¡¹ç›®", "ç»“æœ", "ç¼ºé™·", "æ•°é‡", "æ—¶é—´"]];
          state.quality.forEach((q, i) => rows.push([i + 1, q.batch, q.item, q.result, q.defect || "-", q.qty, new Date(q.time).toLocaleString()]));
          exportToCSV(rows, "quality.csv");
        };

        byId("exportAnalyticsBtn").onclick = () => {
          if (!chartAnalytics) return;
          const rows = [["æ—¥æœŸ", "å€¼"]];
          chartAnalytics.data.labels.forEach((l, i) => rows.push([l, chartAnalytics.data.datasets[0].data[i]]));
          exportToCSV(rows, "analytics.csv");
        };

        // é¡¶éƒ¨æŒ‰é’®
        byId("seedBtn").onclick = () => seedDemoData();
        byId("resetBtn").onclick = async () => {
          if (confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤ï¼Ÿ")) {
            try {
              await sdk.personalPageStore.savePageData("imom_system", "state", {}, true);
              await loadState();
              updateAll();
            } catch (e) {
              console.warn("é‡ç½®æ•°æ®å¤±è´¥", e);
            }
          }
        };

        // å¯¼èˆªæŒ‰é’®
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.onclick = () => setActiveSection(btn.getAttribute("data-target"));
        });

        // ç§»åŠ¨èœå•
        byId("mobileMenuBtn")?.addEventListener("click", () => byId("mobileDrawer").classList.remove("hidden"));
        byId("mobileClose")?.addEventListener("click", () => byId("mobileDrawer").classList.add("hidden"));
        document.getElementById("mobileDrawer").addEventListener("click", (e) => {
          if (e.target.id === "mobileDrawer") e.currentTarget.classList.add("hidden");
        });
      }

      // -------------------------
      // æ¼”ç¤ºæ•°æ®
      // -------------------------
      function seedDemoData() {
        if (state.seeded && !confirm("å·²ç»ç”Ÿæˆè¿‡æ¼”ç¤ºæ•°æ®ï¼Œæ˜¯å¦å†æ¬¡ç”Ÿæˆå¹¶å åŠ ï¼Ÿ")) return;

        const today = new Date();
        const day = (offset) => {
          const d = new Date(today);
          d.setDate(d.getDate() + offset);
          return d.toISOString().slice(0, 10);
        };
        // è®¡åˆ’
        const products = ["æ™ºèƒ½æ‰‹ç¯", "æ— äººè½¦åº•ç›˜", "æ•™è‚²æœºå™¨äººå¥—ä»¶", "ç‰©è”ç½‘ç½‘å…³"];
        for (let i = 0; i < 4; i++) {
          state.plans.push({
            id: crypto.randomUUID(),
            product: products[i],
            qty: 100 + i * 50,
            start: day(-3 + i),
            end: day(1 + i),
            status: i % 2 ? "å·²è°ƒåº¦" : "æœªè°ƒåº¦",
            createdAt: nowISO(),
          });
        }
        // è°ƒåº¦ï¼ˆå…³è”å·²è°ƒåº¦è®¡åˆ’ï¼‰
        state.plans
          .filter((p) => p.status === "å·²è°ƒåº¦")
          .forEach((p, idx) => {
            state.schedules.push({
              id: crypto.randomUUID(),
              planId: p.id,
              line: `L-${idx + 1}`,
              priority: idx + 1,
              date: p.start,
            });
          });
        // ä»»åŠ¡
        const assignees = ["å­¦ç”ŸA", "å­¦ç”ŸB", "å­¦ç”ŸC"];
        for (let i = 0; i < 8; i++) {
          const status = i % 3 === 0 ? "å·²å®Œæˆ" : i % 3 === 1 ? "è¿›è¡Œä¸­" : "æœªå¼€å§‹";
          const created = new Date(today);
          created.setDate(created.getDate() - Math.floor(Math.random() * 6));
          const completed = new Date(created);
          completed.setDate(completed.getDate() + Math.floor(Math.random() * 3));
          state.tasks.push({
            id: crypto.randomUUID(),
            taskName: `${products[i % products.length]} è£…é…`,
            assignee: assignees[i % assignees.length],
            qty: 20 + Math.floor(Math.random() * 30),
            deadline: day(Math.floor(Math.random() * 5)),
            status,
            createdAt: created.toISOString(),
            completedAt: status === "å·²å®Œæˆ" ? completed.toISOString() : undefined,
          });
        }
        // è´¨é‡
        const defects = ["å¤–è§‚åˆ’ç—•", "å°ºå¯¸åå·®", "åŠŸèƒ½å¤±æ•ˆ", "è£…é…ä¸è‰¯"];
        for (let i = 0; i < 10; i++) {
          const ok = Math.random() > 0.25;
          state.quality.push({
            id: crypto.randomUUID(),
            batch: "BATCH-" + (1000 + i),
            item: "å‡ºå‚æ£€éªŒ",
            result: ok ? "åˆæ ¼" : "ä¸åˆæ ¼",
            defect: ok ? "" : defects[i % defects.length],
            qty: 10 + Math.floor(Math.random() * 10),
            time: new Date(today.getTime() - Math.random() * 7 * 86400000).toISOString(),
          });
        }
        state.seeded = true;
        saveState();
        alert("å·²ç”Ÿæˆæ¼”ç¤ºæ•°æ®");
      }

      // -------------------------
      // æ¸²æŸ“
      // -------------------------
      function updateAll() {
        updateKPIs();
        renderPlans();
        renderSchedules();
        renderTasks();
        renderQuality();
        renderEquipment();
        updateOverviewCharts();
        // é»˜è®¤æ¸²æŸ“åˆ†æå›¾
        renderAnalytics();
        // æ›´æ–°é›†æˆåŒº
        initIntegrationsUI();
      } // -------------------------
      // å¯åŠ¨
      // -------------------------
      async function init() {
        await loadState();
        bindForms();
        updateAll();
        setActiveSection("overview");
        // è®¾å¤‡å®šæ—¶åˆ·æ–°
        setInterval(tickEquipmentSensors, 3000);
      }

      init();
    </script>
  </body>
</html>
