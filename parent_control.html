<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®¶é•¿æ§åˆ¶ - Parent Control</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 10px;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
        font-family: 
          "PingFang SC", "PingFang TC",
          "-apple-system", "BlinkMacSystemFont", "SF Pro Text", "SF Pro Display",
          "Noto Sans SC", "Noto Sans CJK SC",
          "Roboto",
          "Helvetica Neue", "Arial", "Microsoft YaHei", "å¾®è½¯é›…é»‘",
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }

      .card {
        background: white;
        border-radius: 1.6rem;
        box-shadow: 0 2rem 6rem rgba(0, 0, 0, 0.3);
      }
      .control-item {
        transition: all 0.3s ease;
      }
      .control-item:hover {
        background: #f8fafc;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 6rem;
        height: 3.4rem;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.4s;
        border-radius: 3.4rem;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 2.6rem;
        width: 2.6rem;
        left: 0.4rem;
        bottom: 0.4rem;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #10b981;
      }
      input:checked + .slider:before {
        transform: translateX(2.6rem);
      }
      .time-input {
        border: 0.2rem solid #e2e8f0;
        border-radius: 0.6rem;
        padding: 0.6rem;
        text-align: center;
        font-size: 1.7rem;
        font-weight: 600;
        color: #1e293b;
        width: 5rem;
      }
      .time-input:focus {
        outline: none;
        border-color: #667eea;
      }
      .save-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: all 0.3s ease;
      }
      .save-btn:hover {
        transform: translateY(-0.2rem);
        box-shadow: 0 1rem 3rem rgba(102, 126, 234, 0.4);
      }
      .toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        padding: 1.8rem 2.5rem;
        border-radius: 1rem;
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 1.2rem;
        opacity: 0;
        transform: translateX(40rem);
        transition: all 0.3s ease;
        z-index: 1000;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
    </style>
  </head>
  <body>
    <div class="card" style="width: 95%; max-width: 110rem; height: 95vh; padding: 1.5rem 2.5rem; display: flex; flex-direction: column; position: relative;">
      <!-- User Info - Top Right Corner of Card -->
      <div id="userInfo" style="position: absolute; top: 1.5rem; right: 2.5rem; z-index: 10; display: none;">
        <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.6rem 1.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 2rem; border: 0.1rem solid rgba(102, 126, 234, 0.3);">
          <span style="font-size: 1.8rem;">ğŸ‘¤</span>
          <span id="userNickname" style="font-size: 1.5rem; font-weight: 600; color: #667eea;"></span>
          <span style="font-size: 1.3rem; color: #9ca3af;">(@<span id="username"></span>)</span>
        </div>
      </div>

      <!-- Header -->
      <div style="text-align: center; margin-bottom: 1rem;">
        <h1 style="font-size: 3.2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.3rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿æ§åˆ¶ä¸­å¿ƒ</h1>
        <p style="font-size: 1.5rem; color: #6b7280;">è®¾ç½®å­©å­çš„å­¦ä¹ ä¸æ¸¸æˆè§„åˆ™</p>
      </div>

      <!-- Control Items - Two Column Layout -->
      <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; overflow: hidden;">
        <!-- 1. å®Œæˆæ¯æ—¥è®­ç»ƒæ‰èƒ½æ¸¸æˆ -->
        <div class="control-item" style="padding: 1.5rem; border-radius: 1rem; border: 0.1rem solid #e5e7eb; display: flex; flex-direction: column; justify-content: center;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.6rem;">
            <div style="font-size: 3.5rem;">ğŸ“š</div>
            <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937;">å®Œæˆæ¯æ—¥è®­ç»ƒæ‰èƒ½æ¸¸æˆ</h3>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <p style="font-size: 1.4rem; color: #6b7280;">è¦æ±‚å­©å­å®Œæˆæ¯æ—¥å­¦ä¹ ä»»åŠ¡åæ‰èƒ½ç©æ¸¸æˆ</p>
            <label class="toggle-switch">
              <input type="checkbox" id="requireDailyTraining" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <!-- 2. æ¯æ—¥æ¸¸æˆæ—¶é•¿ -->
        <div class="control-item" style="padding: 1.5rem; border-radius: 1rem; border: 0.1rem solid #e5e7eb; display: flex; flex-direction: column; justify-content: center;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.6rem;">
            <div style="font-size: 3.5rem;">â±ï¸</div>
            <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937;">æ¯æ—¥æ¸¸æˆæ—¶é•¿é™åˆ¶</h3>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <p style="font-size: 1.4rem; color: #6b7280;">è®¾ç½®å­©å­æ¯å¤©å¯ä»¥ç©æ¸¸æˆçš„æ—¶é—´</p>
            <div style="display: flex; align-items: center; gap: 0.6rem;">
              <input type="number" id="dailyGameHours" min="0" max="23" value="1" class="time-input" style="width: 5rem;" />
              <span style="font-size: 1.6rem; color: #4b5563;">å°æ—¶</span>
              <input type="number" id="dailyGameMinutes" min="0" max="59" value="30" class="time-input" style="width: 5rem;" />
              <span style="font-size: 1.6rem; color: #4b5563;">åˆ†é’Ÿ</span>
            </div>
          </div>
        </div>

        <!-- 3. æ˜¯å¦å…è®¸æ–‡å­—èŠå¤© -->
        <div class="control-item" style="padding: 1.5rem; border-radius: 1rem; border: 0.1rem solid #e5e7eb; display: flex; flex-direction: column; justify-content: center;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.6rem;">
            <div style="font-size: 3.5rem;">ğŸ’¬</div>
            <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937;">å…è®¸æ–‡å­—èŠå¤©</h3>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <p style="font-size: 1.4rem; color: #6b7280;">å…è®¸å­©å­åœ¨åº”ç”¨å†…ä½¿ç”¨æ–‡å­—èŠå¤©åŠŸèƒ½</p>
            <label class="toggle-switch">
              <input type="checkbox" id="allowTextChat" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <!-- 4. æ™šä¸Šç¡è§‰æ—¶é—´ -->
        <div class="control-item" style="padding: 1.5rem; border-radius: 1rem; border: 0.1rem solid #e5e7eb; display: flex; flex-direction: column; justify-content: center;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.6rem;">
            <div style="font-size: 3.5rem;">ğŸŒ™</div>
            <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937;">æ™šä¸Šç¡è§‰æ—¶é—´</h3>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <p style="font-size: 1.4rem; color: #6b7280;">è®¾ç½®æ™šä¸Šç¡è§‰æ—¶é—´ï¼Œåˆ°ç‚¹åå°†é™åˆ¶ä½¿ç”¨</p>
            <div style="display: flex; align-items: center; gap: 0.6rem;">
              <input type="number" id="bedtimeHour" min="0" max="23" value="23" class="time-input" style="width: 5rem;" />
              <span style="font-size: 1.6rem; color: #4b5563;">:</span>
              <input type="number" id="bedtimeMinute" min="0" max="59" value="0" class="time-input" style="width: 5rem;" />
            </div>
          </div>
        </div>

        <!-- 5. æ—©ä¸Šèµ·åºŠæ—¶é—´ -->
        <div class="control-item" style="padding: 1.5rem; border-radius: 1rem; border: 0.1rem solid #e5e7eb; display: flex; flex-direction: column; justify-content: center; grid-column: span 2;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="font-size: 3.5rem;">â˜€ï¸</div>
              <div>
                <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937;">æ—©ä¸Šèµ·åºŠæ—¶é—´</h3>
                <p style="font-size: 1.4rem; color: #6b7280; margin-top: 0.3rem;">è®¾ç½®æ—©ä¸Šèµ·åºŠæ—¶é—´ï¼Œä¹‹åæ‰èƒ½ä½¿ç”¨åº”ç”¨</p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.6rem;">
              <input type="number" id="wakeupHour" min="0" max="23" value="7" class="time-input" style="width: 5rem;" />
              <span style="font-size: 1.6rem; color: #4b5563;">:</span>
              <input type="number" id="wakeupMinute" min="0" max="59" value="0" class="time-input" style="width: 5rem;" />
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button and Footer -->
      <div style="margin-top: 1.2rem; display: flex; flex-direction: column; align-items: center; gap: 0.8rem;">
        <div style="display: flex; gap: 1.5rem;">
          <button id="saveBtn" class="save-btn" style="color: white; font-weight: 700; padding: 1.4rem 5rem; border-radius: 1rem; font-size: 2rem; border: none; cursor: pointer;">
            ğŸ’¾ ä¿å­˜è®¾ç½®
          </button>
          <button id="changePasswordBtn" class="save-btn" style="color: white; font-weight: 700; padding: 1.4rem 3rem; border-radius: 1rem; font-size: 2rem; border: none; cursor: pointer; display: none;">
            ğŸ”‘ ä¿®æ”¹å¯†ç 
          </button>
        </div>
        <p style="font-size: 1.4rem; color: #6b7280;">ğŸ”’ æ‰€æœ‰è®¾ç½®å°†å®‰å…¨ä¿å­˜åˆ°äº‘ç«¯ï¼Œå„è®¾å¤‡åŒæ­¥ç”Ÿæ•ˆ</p>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 1.6rem; padding: 3rem; max-width: 50rem; width: 90%; box-shadow: 0 2rem 6rem rgba(0, 0, 0, 0.3);">
        <h2 id="passwordModalTitle" style="font-size: 2.4rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; text-align: center;">ğŸ” è®¾ç½®ç®¡ç†å¯†ç </h2>
        <p id="passwordModalDesc" style="font-size: 1.5rem; color: #6b7280; margin-bottom: 2rem; text-align: center;">è¯·è®¾ç½®ä¸€ä¸ªç®¡ç†å¯†ç ï¼Œç”¨äºä¿æŠ¤å®¶é•¿æ§åˆ¶è®¾ç½®ï¼ˆæœ€å¤š16ä¸ªå­—ç¬¦ï¼‰</p>
        
        <div style="margin-bottom: 2rem;">
          <label style="display: block; font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem;">å¯†ç </label>
          <input type="password" id="passwordInput" maxlength="16" style="width: 100%; padding: 1.2rem; border: 0.2rem solid #e5e7eb; border-radius: 0.8rem; font-size: 1.6rem;" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆæœ€å¤š16ä¸ªå­—ç¬¦ï¼‰" />
        </div>
        
        <div id="confirmPasswordContainer" style="margin-bottom: 2rem; display: none;">
          <label style="display: block; font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem;">ç¡®è®¤å¯†ç </label>
          <input type="password" id="confirmPasswordInput" maxlength="16" style="width: 100%; padding: 1.2rem; border: 0.2rem solid #e5e7eb; border-radius: 0.8rem; font-size: 1.6rem;" placeholder="å†æ¬¡è¾“å…¥å¯†ç " />
        </div>
        
        <div style="display: flex; gap: 1.5rem; justify-content: center;">
          <button id="passwordCancelBtn" style="padding: 1.2rem 3rem; border-radius: 0.8rem; font-size: 1.6rem; font-weight: 600; border: 0.2rem solid #667eea; color: #667eea; background: white; cursor: pointer;">
            å–æ¶ˆ
          </button>
          <button id="passwordConfirmBtn" style="padding: 1.2rem 3rem; border-radius: 0.8rem; font-size: 1.6rem; font-weight: 600; border: none; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;">
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 1.6rem; padding: 3rem; max-width: 50rem; width: 90%; box-shadow: 0 2rem 6rem rgba(0, 0, 0, 0.3);">
        <h2 style="font-size: 2.4rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; text-align: center;">ğŸ”‘ ä¿®æ”¹ç®¡ç†å¯†ç </h2>
        
        <div style="margin-bottom: 2rem;">
          <label style="display: block; font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem;">å½“å‰å¯†ç </label>
          <input type="password" id="oldPasswordInput" maxlength="16" style="width: 100%; padding: 1.2rem; border: 0.2rem solid #e5e7eb; border-radius: 0.8rem; font-size: 1.6rem;" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " />
        </div>
        
        <div style="margin-bottom: 2rem;">
          <label style="display: block; font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem;">æ–°å¯†ç </label>
          <input type="password" id="newPasswordInput" maxlength="16" style="width: 100%; padding: 1.2rem; border: 0.2rem solid #e5e7eb; border-radius: 0.8rem; font-size: 1.6rem;" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆæœ€å¤š16ä¸ªå­—ç¬¦ï¼‰" />
        </div>
        
        <div style="margin-bottom: 2rem;">
          <label style="display: block; font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem;">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmNewPasswordInput" maxlength="16" style="width: 100%; padding: 1.2rem; border: 0.2rem solid #e5e7eb; border-radius: 0.8rem; font-size: 1.6rem;" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " />
        </div>
        
        <div style="display: flex; gap: 1.5rem; justify-content: center;">
          <button id="changePasswordCancelBtn" style="padding: 1.2rem 3rem; border-radius: 0.8rem; font-size: 1.6rem; font-weight: 600; border: 0.2rem solid #667eea; color: #667eea; background: white; cursor: pointer;">
            å–æ¶ˆ
          </button>
          <button id="changePasswordConfirmBtn" style="padding: 1.2rem 3rem; border-radius: 0.8rem; font-size: 1.6rem; font-weight: 600; border: none; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;">
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <div id="toastIcon" style="font-size: 3rem;">âœ…</div>
      <div id="toastMessage" style="font-weight: 600; color: #1f2937; font-size: 1.8rem;">è®¾ç½®ä¿å­˜æˆåŠŸï¼</div>
    </div>

    <script>
      // è°ƒæ•´æ ¹å­—ä½“å¤§å°ä»¥é€‚é…ä¸åŒå±å¹•
      function adjustRootFontSize() {
        // æ¸¸æˆä¸»å®¹å™¨çš„è®¾è®¡å°ºå¯¸
        const DESIGN_WIDTH = 1000;
        const DESIGN_HEIGHT = 720;
        
        // è·å–è§†å£å°ºå¯¸
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // è®¡ç®—åŸºäºå®½åº¦å’Œé«˜åº¦çš„ç¼©æ”¾æ¯”ä¾‹
        const scaleByWidth = viewportWidth / DESIGN_WIDTH;
        const scaleByHeight = viewportHeight / DESIGN_HEIGHT;
        
        // å–è¾ƒå°çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å†…å®¹å®Œå…¨å¯è§ï¼ˆç­‰æ¯”ä¾‹ç¼©æ”¾ï¼‰
        const scale = Math.min(scaleByWidth, scaleByHeight);
        
        // è®¾ç½®æ ¹å…ƒç´ çš„ font-size
        // å‡è®¾è®¾è®¡ç¨¿åŸºå‡†æ˜¯ 1rem = 10pxï¼Œåˆ™è°ƒæ•´åçš„ font-size = 10 * scale
        const baseFontSize = 10; // è®¾è®¡ç¨¿åŸºå‡†
        const finalFontSize = baseFontSize * scale;
        
        document.documentElement.style.fontSize = `${finalFontSize}px`;
      }
      
      // åˆå§‹åŒ–ç¼©æ”¾
      adjustRootFontSize();
      
      // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—ç¼©æ”¾
      window.addEventListener('resize', adjustRootFontSize);

      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      console.log(`Keepwork SDK initialized token: ${sdk.token}`);

      const PAGE_NAME = "parent_control";
      const STORAGE_KEY = "settings";

      // Load and display user info
      async function loadUserInfo() {
        try {
          if (sdk.token) {
            const userProfile = await sdk.getUserProfile();
            if (userProfile) {
              console.log("ç”¨æˆ·ä¿¡æ¯:", userProfile);
              
              // Display user info
              const userInfoDiv = document.getElementById("userInfo");
              const nicknameSpan = document.getElementById("userNickname");
              const usernameSpan = document.getElementById("username");
              
              if (userProfile.nickname || userProfile.username) {
                nicknameSpan.textContent = userProfile.nickname || userProfile.username || "ç”¨æˆ·";
                usernameSpan.textContent = userProfile.username || "";
                userInfoDiv.style.display = "block";
              }
            }
          }
        } catch (error) {
          console.warn("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", error);
        }
      }

      // Default settings
      const defaultSettings = {
        requireDailyTraining: false,
        dailyGameTime: 90, // minutes
        allowTextChat: true,
        bedtime: "23:00",
        wakeup: "07:00",
        passwordHash: null, // å­˜å‚¨å¯†ç çš„å“ˆå¸Œå€¼
      };

      let currentSettings = { ...defaultSettings };
      let pendingSaveSettings = null; // ä¸´æ—¶å­˜å‚¨å¾…ä¿å­˜çš„è®¾ç½®

      // Hash password using browser's Web Crypto API
      async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
      }

      // Show password modal
      function showPasswordModal(mode = 'setup') {
        const modal = document.getElementById('passwordModal');
        const title = document.getElementById('passwordModalTitle');
        const desc = document.getElementById('passwordModalDesc');
        const confirmContainer = document.getElementById('confirmPasswordContainer');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        
        passwordInput.value = '';
        confirmPasswordInput.value = '';
        
        if (mode === 'setup') {
          title.textContent = 'ğŸ” è®¾ç½®ç®¡ç†å¯†ç ';
          desc.textContent = 'è¯·è®¾ç½®ä¸€ä¸ªç®¡ç†å¯†ç ï¼Œç”¨äºä¿æŠ¤å®¶é•¿æ§åˆ¶è®¾ç½®ï¼ˆæœ€å¤š16ä¸ªå­—ç¬¦ï¼‰';
          confirmContainer.style.display = 'block';
        } else {
          title.textContent = 'ğŸ”’ éªŒè¯å¯†ç ';
          desc.textContent = 'è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥ä¿®æ”¹è®¾ç½®';
          confirmContainer.style.display = 'none';
        }
        
        modal.style.display = 'flex';
        setTimeout(() => passwordInput.focus(), 100);
      }

      // Hide password modal
      function hidePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
        // Don't clear pendingSaveSettings here - it's needed for performSave()
      }

      // Show change password modal
      function showChangePasswordModal() {
        const modal = document.getElementById('changePasswordModal');
        document.getElementById('oldPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmNewPasswordInput').value = '';
        modal.style.display = 'flex';
        setTimeout(() => document.getElementById('oldPasswordInput').focus(), 100);
      }

      // Hide change password modal
      function hideChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
      }

      // Handle password confirmation
      async function handlePasswordConfirm() {
        try {
          const passwordInput = document.getElementById('passwordInput');
          const confirmPasswordInput = document.getElementById('confirmPasswordInput');
          const password = passwordInput.value.trim();
          
          console.log('å¤„ç†å¯†ç ç¡®è®¤ï¼Œé¦–æ¬¡è®¾ç½®:', !currentSettings.passwordHash);
          
          if (!password) {
            showToast('è¯·è¾“å…¥å¯†ç ', 'warning');
            return;
          }
          
          if (password.length > 16) {
            showToast('å¯†ç æœ€å¤š16ä¸ªå­—ç¬¦', 'warning');
            return;
          }
          
          // é¦–æ¬¡è®¾ç½®å¯†ç 
          if (!currentSettings.passwordHash) {
            const confirmPassword = confirmPasswordInput.value.trim();
            if (password !== confirmPassword) {
              showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
              return;
            }
            
            console.log('é¦–æ¬¡è®¾ç½®å¯†ç ï¼Œç”ŸæˆSHA-256å“ˆå¸Œ...');
            const hash = await hashPassword(password);
            console.log('å¯†ç SHA-256å“ˆå¸Œç”ŸæˆæˆåŠŸ:', hash);
            pendingSaveSettings.passwordHash = hash;
            
            hidePasswordModal();
            console.log('è°ƒç”¨performSaveä¿å­˜è®¾ç½®...');
            await performSave();
          } else {
            // éªŒè¯å¯†ç 
            console.log('éªŒè¯ç°æœ‰å¯†ç ...');
            const hash = await hashPassword(password);
            console.log('è¾“å…¥å¯†ç çš„SHA-256:', hash);
            console.log('å­˜å‚¨çš„å¯†ç SHA-256:', currentSettings.passwordHash);
            if (hash !== currentSettings.passwordHash) {
              console.log('å¯†ç éªŒè¯å¤±è´¥');
              showToast('å¯†ç é”™è¯¯', 'error');
              return;
            }
            
            console.log('å¯†ç éªŒè¯æˆåŠŸ');
            hidePasswordModal();
            console.log('è°ƒç”¨performSaveä¿å­˜è®¾ç½®...');
            await performSave();
          }
        } catch (error) {
          console.error('å¯†ç ç¡®è®¤å¤„ç†å¤±è´¥:', error);
          showToast('å¯†ç å¤„ç†å¤±è´¥: ' + error.message, 'error');
        }
      }

      // Handle change password
      async function handleChangePassword() {
        try {
          const oldPassword = document.getElementById('oldPasswordInput').value.trim();
          const newPassword = document.getElementById('newPasswordInput').value.trim();
          const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value.trim();
          
          console.log('å¤„ç†ä¿®æ”¹å¯†ç è¯·æ±‚');
          
          if (!oldPassword || !newPassword || !confirmNewPassword) {
            showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning');
            return;
          }
          
          if (newPassword.length > 16) {
            showToast('å¯†ç æœ€å¤š16ä¸ªå­—ç¬¦', 'warning');
            return;
          }
          
          console.log('éªŒè¯æ—§å¯†ç ...');
          const oldHash = await hashPassword(oldPassword);
          console.log('æ—§å¯†ç SHA-256:', oldHash);
          console.log('å­˜å‚¨çš„å¯†ç SHA-256:', currentSettings.passwordHash);
          
          if (oldHash !== currentSettings.passwordHash) {
            console.log('æ—§å¯†ç é”™è¯¯');
            showToast('å½“å‰å¯†ç é”™è¯¯', 'error');
            return;
          }
          
          if (newPassword !== confirmNewPassword) {
            showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
            return;
          }
          
          console.log('ç”Ÿæˆæ–°å¯†ç SHA-256å“ˆå¸Œ...');
          const newHash = await hashPassword(newPassword);
          console.log('æ–°å¯†ç SHA-256:', newHash);
          
          // Update settings with new password hash
          const updatedSettings = {
            ...currentSettings,
            passwordHash: newHash,
          };
          
          console.log('å‡†å¤‡ä¿å­˜æ–°å¯†ç åˆ°æœåŠ¡å™¨...');
          console.log('SDK token:', sdk.token ? 'å·²å­˜åœ¨' : 'æœªå­˜åœ¨');
          console.log('ä¿å­˜çš„å®Œæ•´è®¾ç½®:', updatedSettings);
          
          await sdk.personalPageStore.savePageData(PAGE_NAME, STORAGE_KEY, updatedSettings, true);
          
          // Update current settings after successful save
          currentSettings = updatedSettings;
          
          console.log('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œæ–°å¯†ç å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
          showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
          hideChangePasswordModal();
        } catch (error) {
          console.error('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:', error);
          console.error('é”™è¯¯å †æ ˆ:', error.stack);
          showToast('ä¿®æ”¹å¯†ç å¤±è´¥: ' + error.message, 'error');
        }
      }

      // Actual save operation
      async function performSave() {
        try {
          console.log("performSaveè¢«è°ƒç”¨");
          console.log("pendingSaveSettings:", pendingSaveSettings);
          
          if (!pendingSaveSettings) {
            console.error("pendingSaveSettingsä¸ºç©ºï¼Œæå‰è¿”å›");
            return;
          }
          
          console.log("å‡†å¤‡ä¿å­˜è®¾ç½®:", pendingSaveSettings);
          console.log("å¯†ç å“ˆå¸Œå­˜åœ¨:", !!pendingSaveSettings.passwordHash);
          
          await sdk.personalPageStore.savePageData(PAGE_NAME, STORAGE_KEY, pendingSaveSettings, true);
          
          currentSettings = { ...pendingSaveSettings };
          pendingSaveSettings = null;
          
          console.log('è®¾ç½®ä¿å­˜æˆåŠŸï¼Œå½“å‰è®¾ç½®:', currentSettings);
          console.log('å¯†ç å“ˆå¸Œ:', currentSettings.passwordHash ? "å·²ä¿å­˜" : "æœªä¿å­˜");
          showToast('è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
          
          // Show change password button after first save
          if (currentSettings.passwordHash) {
            console.log("æ˜¾ç¤ºä¿®æ”¹å¯†ç æŒ‰é’®ï¼ˆå¯†ç å·²è®¾ç½®ï¼‰");
            document.getElementById('changePasswordBtn').style.display = 'block';
          }
          
          // Send message to parent window if embedded
          if (window.parent !== window) {
            window.parent.postMessage(
              {
                type: 'parentControlUpdated',
                data: currentSettings,
              },
              '*'
            );
          }
        } catch (error) {
          console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
          showToast('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
          pendingSaveSettings = null;
        }
      }

      // Toast notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const icon = document.getElementById("toastIcon");
        const messageEl = document.getElementById("toastMessage");

        const icons = {
          success: "âœ…",
          error: "âŒ",
          info: "â„¹ï¸",
          warning: "âš ï¸",
        };

        icon.textContent = icons[type] || icons.info;
        messageEl.textContent = message;

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Load settings from SDK
      async function loadSettings() {
        try {
          console.log("æ­£åœ¨åŠ è½½å®¶é•¿æ§åˆ¶è®¾ç½®...");
          const data = await sdk.personalPageStore.loadPageData(PAGE_NAME, STORAGE_KEY);

          if (data) {
            currentSettings = { ...defaultSettings, ...data };
            console.log("è®¾ç½®åŠ è½½æˆåŠŸ:", currentSettings);
            console.log("å¯†ç å“ˆå¸Œ:", currentSettings.passwordHash ? "å·²è®¾ç½®" : "æœªè®¾ç½®");
          } else {
            console.log("æœªæ‰¾åˆ°ä¿å­˜çš„è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼");
            currentSettings = { ...defaultSettings };
          }

          updateUI();
          
          // Show change password button if password is set
          if (currentSettings.passwordHash) {
            console.log("æ˜¾ç¤ºä¿®æ”¹å¯†ç æŒ‰é’®");
            document.getElementById('changePasswordBtn').style.display = 'block';
          } else {
            console.log("éšè—ä¿®æ”¹å¯†ç æŒ‰é’®ï¼ˆå¯†ç æœªè®¾ç½®ï¼‰");
            document.getElementById('changePasswordBtn').style.display = 'none';
          }
        } catch (error) {
          console.error("åŠ è½½è®¾ç½®å¤±è´¥:", error);
          showToast("åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®", "error");
          currentSettings = { ...defaultSettings };
          updateUI();
        }
      }

      // Save settings to SDK
      async function saveSettings() {
        // Collect current values from UI
        const bedtimeHour = String(parseInt(document.getElementById("bedtimeHour").value) || 23).padStart(2, '0');
        const bedtimeMinute = String(parseInt(document.getElementById("bedtimeMinute").value) || 0).padStart(2, '0');
        const wakeupHour = String(parseInt(document.getElementById("wakeupHour").value) || 7).padStart(2, '0');
        const wakeupMinute = String(parseInt(document.getElementById("wakeupMinute").value) || 0).padStart(2, '0');
        
        const newSettings = {
          requireDailyTraining: document.getElementById("requireDailyTraining").checked,
          dailyGameTime: (parseInt(document.getElementById("dailyGameHours").value) || 0) * 60 + 
                        (parseInt(document.getElementById("dailyGameMinutes").value) || 0),
          allowTextChat: document.getElementById("allowTextChat").checked,
          bedtime: `${bedtimeHour}:${bedtimeMinute}`,
          wakeup: `${wakeupHour}:${wakeupMinute}`,
          passwordHash: currentSettings.passwordHash, // Keep existing password hash
        };

        pendingSaveSettings = newSettings;
        
        console.log('pendingSaveSettingså·²è®¾ç½®:', pendingSaveSettings);

        // Check if password is set
        if (!currentSettings.passwordHash) {
          // First time setup - ask to set password
          showPasswordModal('setup');
        } else {
          // Verify password before saving
          showPasswordModal('verify');
        }
      }

      // Update UI with current settings
      function updateUI() {
        document.getElementById("requireDailyTraining").checked = currentSettings.requireDailyTraining;

        const totalMinutes = currentSettings.dailyGameTime || 90;
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        document.getElementById("dailyGameHours").value = hours;
        document.getElementById("dailyGameMinutes").value = minutes;

        document.getElementById("allowTextChat").checked = currentSettings.allowTextChat;

        // Parse bedtime string (format: "HH:MM")
        const bedtimeParts = (currentSettings.bedtime || "23:00").split(":");
        document.getElementById("bedtimeHour").value = parseInt(bedtimeParts[0]) || 23;
        document.getElementById("bedtimeMinute").value = parseInt(bedtimeParts[1]) || 0;

        // Parse wakeup string (format: "HH:MM")
        const wakeupParts = (currentSettings.wakeup || "07:00").split(":");
        document.getElementById("wakeupHour").value = parseInt(wakeupParts[0]) || 7;
        document.getElementById("wakeupMinute").value = parseInt(wakeupParts[1]) || 0;
      }

      // Event listeners
      document.getElementById("saveBtn").addEventListener("click", saveSettings);
      document.getElementById("changePasswordBtn").addEventListener("click", showChangePasswordModal);
      
      // Password modal buttons
      document.getElementById("passwordCancelBtn").addEventListener("click", hidePasswordModal);
      document.getElementById("passwordConfirmBtn").addEventListener("click", handlePasswordConfirm);
      
      // Change password modal buttons
      document.getElementById("changePasswordCancelBtn").addEventListener("click", hideChangePasswordModal);
      document.getElementById("changePasswordConfirmBtn").addEventListener("click", handleChangePassword);
      
      // Enter key support in modals
      document.getElementById("passwordInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") handlePasswordConfirm();
      });
      document.getElementById("confirmPasswordInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") handlePasswordConfirm();
      });
      document.getElementById("confirmNewPasswordInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleChangePassword();
      });

      // Validate time inputs
      function validateTimeInput(input, max) {
        input.addEventListener("input", function () {
          let value = parseInt(this.value);
          if (isNaN(value) || value < 0) {
            this.value = 0;
          } else if (value > max) {
            this.value = max;
          }
        });

        input.addEventListener("blur", function () {
          if (this.value === "") {
            this.value = 0;
          }
        });
      }

      validateTimeInput(document.getElementById("dailyGameHours"), 23);
      validateTimeInput(document.getElementById("dailyGameMinutes"), 59);
      validateTimeInput(document.getElementById("bedtimeHour"), 23);
      validateTimeInput(document.getElementById("bedtimeMinute"), 59);
      validateTimeInput(document.getElementById("wakeupHour"), 23);
      validateTimeInput(document.getElementById("wakeupMinute"), 59);

      // Listen for messages from parent
      window.addEventListener("message", function (e) {
        if (e.data.type === "getParentControl") {
          // Send current settings to parent
          e.source.postMessage(
            {
              type: "parentControlData",
              data: currentSettings,
            },
            "*"
          );
        }
      });

      // Send loaded message to parent
      window.parent.postMessage({ type: "pageLoaded", page: "parent_control" }, "*");

      // Initialize - load user info and settings when page loads
      loadUserInfo();
      loadSettings();
    </script>
  </body>
</html>
