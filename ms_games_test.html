<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Iframe Page</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 75%, #c850c0 100%);
        overflow: hidden;
      }
      .mobile-frame {
        height: 100vh;
        width: calc(100vh * 414 / 896);
        background-color: #fff;
        border: 2px solid #333;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform-origin: center center;
        transition: transform 0.3s ease;
        will-change: transform;
        position: relative;
        z-index: 1; /* 确保在星星层之上 */
      }
      .mobile-frame iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* 响应式处理：如果计算的宽度超过视窗宽度，则以宽度为准 */
      @media (max-aspect-ratio: 414/896) {
        .mobile-frame {
          width: 100vw;
          height: calc(100vw * 896 / 414);
        }
      }

      /* 右上角旋转按钮样式 */
      .rotate-btn {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        border: none;
        border-radius: 9999px;
        height: 44px;
        padding: 0 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        user-select: none;
      }
      .rotate-btn:hover {
        background: rgba(0, 0, 0, 0.8);
      }
      .rotate-btn:active {
        transform: scale(0.98);
      }
      .rotate-btn svg {
        width: 22px;
        height: 22px;
      }
      .rotate-btn .rotate-btn-label {
        font-size: 12px;
        line-height: 1;
        white-space: nowrap;
        opacity: 0.95;
      }
      /* 紧凑状态：仅显示图标 */
      .rotate-btn.compact {
        width: 44px;
        height: 44px;
        padding: 0;
        gap: 0;
      }

      /* 星星闪烁背景层 */
      .stars {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .stars .star {
        position: absolute;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 9999px;
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        animation: twinkle 2s infinite ease-in-out;
      }
      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.35;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.25);
        }
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center">
    <!-- 星星闪烁背景层 -->
    <div class="stars" aria-hidden="true">
      <div class="star" style="top: 8%; left: 10%; width: 3px; height: 3px; animation-delay: 0s"></div>
      <div class="star" style="top: 18%; right: 12%; width: 2px; height: 2px; animation-delay: 0.4s"></div>
      <div class="star" style="top: 30%; left: 22%; width: 4px; height: 4px; animation-delay: 0.8s"></div>
      <div class="star" style="top: 42%; right: 28%; width: 2px; height: 2px; animation-delay: 1.2s"></div>
      <div class="star" style="top: 55%; left: 14%; width: 3px; height: 3px; animation-delay: 1.6s"></div>
      <div class="star" style="top: 65%; right: 18%; width: 1.5px; height: 1.5px; animation-delay: 2s"></div>
      <div class="star" style="top: 12%; right: 35%; width: 2.5px; height: 2.5px; animation-delay: 0.2s"></div>
      <div class="star" style="top: 48%; left: 36%; width: 1.8px; height: 1.8px; animation-delay: 0.6s"></div>
      <div class="star" style="top: 72%; left: 26%; width: 2.2px; height: 2.2px; animation-delay: 1s"></div>
      <div class="star" style="top: 82%; right: 26%; width: 3.2px; height: 3.2px; animation-delay: 1.4s"></div>
      <div class="star" style="top: 24%; left: 70%; width: 1.6px; height: 1.6px; animation-delay: 1.8s"></div>
      <div class="star" style="top: 76%; left: 64%; width: 2.8px; height: 2.8px; animation-delay: 2.2s"></div>
    </div>
    <button id="rotateToggle" class="rotate-btn" aria-label="旋转" title="旋转">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 12a8 8 0 0 1 13.657-5.657" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M20 12a8 8 0 0 1-13.657 5.657" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4h4" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 21v-4H4" />
      </svg>
      <span class="rotate-btn-label">竖屏模式</span>
    </button>

    <div class="mobile-frame">
      <iframe id="mobileIframe" src="" frameborder="0" allowfullscreen></iframe>
    </div>

    <script>
      // 旋转与缩放（contain：保持比例，只有一边贴满窗口）
      (function () {
        const frame = document.querySelector(".mobile-frame");
        const btn = document.getElementById("rotateToggle");
        const labelEl = btn?.querySelector(".rotate-btn-label");
        let rotated = false;
        let labelHidden = false;

        function getBaseSize() {
          // 使用 offsetWidth/offsetHeight 获取未受 transform 影响的盒子尺寸
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          let w = frame.offsetWidth;
          let h = frame.offsetHeight;
          if (!w || !h) {
            // 回退估算：对比按高度/按宽度两种模式
            const byH_w = (vh * 414) / 896;
            const byH_h = vh;
            const byW_w = vw;
            const byW_h = (vw * 896) / 414;
            const dH = Math.abs(byH_w - vw) + Math.abs(byH_h - vh);
            const dW = Math.abs(byW_w - vw) + Math.abs(byW_h - vh);
            if (dW < dH) {
              w = byW_w;
              h = byW_h;
            } else {
              w = byH_w;
              h = byH_h;
            }
          }
          return { w, h };
        }

        function applyTransform() {
          const { w, h } = getBaseSize();
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          if (rotated) {
            // 旋转 90° 后，仅让一边贴满窗口（contain）
            // s 需满足 s*h <= vw 且 s*w <= vh -> s = min(vw/h, vh/w)
            const s = Math.min(vw / h, vh / w);
            frame.style.transform = `rotate(90deg) scale(${s})`;
            if (btn) {
              btn.setAttribute("aria-label", "还原");
              btn.title = "还原";
            }
          } else {
            frame.style.transform = "none";
            if (btn) {
              btn.setAttribute("aria-label", "旋转");
              btn.title = "旋转";
            }
          }
        }

        btn?.addEventListener("click", () => {
          // 首次点击后隐藏文本并使用紧凑样式
          if (!labelHidden) {
            labelHidden = true;
            btn.classList.add("compact");
            if (labelEl) labelEl.style.display = "none";
          }
          rotated = !rotated;
          applyTransform();
        });

        window.addEventListener("resize", () => {
          if (rotated) applyTransform();
        });
        window.requestAnimationFrame(() => applyTransform());
      })();

      // 获取URL参数
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        const results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      // 获取accessToken参数
      const accessToken = getUrlParameter("accessToken");
      let isUseMaisiDevServer = getUrlParameter("isUseMaisiDevServer");

      // 构建iframe的src URL
      let baseUrl = "https://mp.maseai.com/#/pages/evaluation/index";
      if (isUseMaisiDevServer === "true") {
        baseUrl = "https://maseai-mp-qa.langcong.com/#/pages/evaluation/index";
      }
      const iframeSrc = `${baseUrl}?accessToken=${accessToken || ""}`;

      // 设置iframe的src
      document.getElementById("mobileIframe").src = iframeSrc; 
      if (!accessToken) {
        console.log("未找到accessToken参数");
      } else {
        console.log("使用accessToken:", accessToken);
      }

      // 监听来自iframe的消息并转发给父窗口
      window.addEventListener("message", function (event) {
        // 检查消息来源是否为iframe
        const iframe = document.getElementById("mobileIframe");
        if (event.source === iframe.contentWindow) {
          // 监听miniTrialFinished消息并转发为gameFinished
          if (event.data && event.data.type === "miniTrialFinished") {
            console.log("收到miniTrialFinished消息:", event.data);

            // 向父窗口发送gameFinished消息
            if (window.parent && window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "gameFinished",
                  trialId: event.data.trialId,
                  originalData: event.data,
                },
                "*"
              );
              console.log("已转发gameFinished消息到父窗口");
            }
          }
        }
      });
    </script>
  </body>
</html>
