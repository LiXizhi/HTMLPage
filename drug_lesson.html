
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>学法拒毒，护航成长 | 五年级校内阅读H5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230ea5e9'/%3E%3Ctext x='50' y='58' font-size='42' text-anchor='middle' fill='white' font-family='Arial'%3E读%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
  <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
  <style>
    html, body { height: 100%; background: #f8fafc; }
    .section { display: none; }
    .section.active { display: block; }
    .card { background: white; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(2,6,23,0.06); }
    .pill { border-radius: 9999px; }
    .grid-auto { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    .kbd { background:#e2e8f0;border-radius:0.375rem;padding:0 0.5rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    .progress { height: 10px; background: #e2e8f0; border-radius: 9999px; overflow: hidden; }
    .progress > div { height: 100%; background: #22c55e; width: 0%; transition: width 0.3s ease; }
    .tag { background:#eff6ff; color:#1d4ed8; }
    .tag-warn { background:#fff7ed; color:#c2410c; }
    .tag-safe { background:#ecfeff; color:#0e7490; }
    .no-select { user-select: none; }
    .accent { color:#0ea5e9; }
    .spinner { width: 1rem; height: 1rem; border-radius: 9999px; border: 2px solid rgba(14,165,233,0.25); border-top-color: #0ea5e9; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-sky-500 grid place-items-center text-white font-bold">法</div>
        <div class="leading-tight">
          <div class="font-bold text-slate-800">学法拒毒，护航成长</div>
          <div class="text-sm text-slate-500">五年级校内阅读·“读-析-创-评-延”闭环</div>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-2">
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="intro">导入</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="speedread">速读</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="group">分组</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="qa">答疑</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="scenario">情景</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="creative">创作</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="peer">互评</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="summary">总结</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="home">家校</button>
        <button class="nav-btn px-3 py-2 text-sm pill hover:bg-slate-100" data-target="rubric">评价表</button>
      </nav>
      <div class="md:hidden">
        <select id="navSelect" class="border rounded px-2 py-1 text-sm">
          <option value="intro">导入</option>
          <option value="speedread">速读</option>
          <option value="group">分组</option>
          <option value="qa">答疑</option>
          <option value="scenario">情景</option>
          <option value="creative">创作</option>
          <option value="peer">互评</option>
          <option value="summary">总结</option>
          <option value="home">家校</option>
          <option value="rubric">评价表</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-4 md:py-8">
    <!-- 导入 -->
    <section id="intro" class="section active">
      <div class="card p-5 md:p-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
          <h1 class="text-2xl md:text-3xl font-bold text-slate-800">情境导入：我们是“学法拒毒守护者”</h1>
          <div class="pill bg-sky-50 text-sky-700 px-3 py-1 text-sm">用时建议：3分钟</div>
        </div>
        <p class="text-slate-700 leading-7 mb-4">
          同学们，课堂上我们将以真实案例和法律条文为材料，完成一次“读-析-创-评-延”的任务挑战。
          我们要学会用法律保护自己，及时拒绝诱惑，成为守护同学与家庭安全的“学法拒毒守护者”。
        </p>
        <div class="grid-auto">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">AI走进课堂：从法律条文看禁毒</div>
            <p class="text-sm text-slate-600 mb-3">点击播放，了解《刑法》《禁毒法》对未成年人的保护与要求。</p>
            <video class="w-full rounded-lg bg-slate-100" controls preload="none" poster="/api/placeholder/640/360">
              <source src="" type="video/mp4" />
            </video>
            <div class="text-xs text-slate-500 mt-2">占位视频：请替换为校内资源链接</div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">学习目标</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
              <li>掌握不回读、抓关键词的速读技巧</li>
              <li>理解毒品的法律定义与禁令</li>
              <li>掌握正确的拒毒与求助方法</li>
              <li>通过创作分享法律知识与案例启示</li>
            </ul>
          </div>
        </div>
        <div class="mt-6 p-4 border rounded-lg bg-slate-50">
          <div class="font-semibold mb-2">今日阅读资源</div>
          <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
            <li>《关于毒品的法律常识》：速读法律条文，明晰底线。</li>
            <li>《掌握正确的拒毒防毒技巧》：学习实用的拒绝和自护方法。</li>
            <li>《危险的好奇》：辨析同伴诱惑中的危险信号。</li>
            <li>《藏在小书包里的秘密》：了解毒品对个人、家庭、社会的深层危害。</li>
          </ul>
        </div>
        <div class="mt-6 flex gap-3">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="speedread">进入速读训练</button>
          <span class="text-sm text-slate-500">快捷键：<span class="kbd">N</span> 下一步</span>
        </div>
      </div>
    </section>

    <!-- 速读 -->
    <section id="speedread" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">智能体辅助速读</h2>
          <div class="pill bg-emerald-50 text-emerald-700 px-3 py-1 text-sm">用时建议：12分钟</div>
        </div>

        <!-- 1. 快速阅读：掌握法律常识 -->
        <div class="mb-6">
          <div class="font-semibold mb-2">任务一：快速阅读，掌握禁毒法律常识（3分钟限时）</div>
          <div class="grid-auto">
            <div class="p-4 border rounded-lg">
              <div class="text-sm text-slate-600 mb-2">速览要点（可更换为班级资料卡）：</div>
              <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                <li>毒品的法律定义来源于《中华人民共和国刑法》第三百五十七条。</li>
                <li>非法种植、走私、买卖、运输、持有毒品原植物种子或幼苗都被严格禁止。</li>
                <li>未成年人违反禁毒相关规定会被依法矫治，家长需要承担教育责任。</li>
              </ul>
            </div>

            <div class="p-4 border rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">阅读文本：关于毒品的法律常识（约600字）</div>
                <div class="text-sm text-slate-500">规则：3分钟内默读完毕，不回读</div>
              </div>
              <div id="srText" class="bg-slate-50 p-3 rounded max-h-56 overflow-y-auto text-sm text-slate-700 leading-7 no-select">
                <h3 class="font-semibold text-base text-slate-800 mb-2">关于毒品的法律常识</h3>
                <p class="mb-2">《中华人民共和国刑法》第三百五十七条规定：“本法所称的毒品，是指鸦片、海洛因、甲基苯丙胺（冰毒）、吗啡、大麻、可卡因以及国家规定管制的其他能够使人形成瘾癖的麻醉药品和精神药品。”</p>
                <p class="mb-2">法律规定，我们不能做这些事情：第一，禁止非法种植罂粟、古柯植物、大麻植物等毒品原植物，也不能走私、非法买卖、运输、携带、持有未经灭活的毒品原植物种子或者幼苗。如果发现有人这么做，要赶紧告诉公安机关。第二，国家对麻醉药品和精神药品实行管制，未经许可，不能非法生产、买卖、运输、储存、提供、持有、使用它们。</p>
                <p class="mb-2">再给大家讲讲《中华人民共和国刑法》中关于毒品的一些规定。走私、贩卖、运输、制造毒品，不管数量多少，都要被追究刑事责任。如果有人引诱、教唆、欺骗他人吸食、注射毒品，会被判处三年以下有期徒刑、拘役或者管制，并处罚金；情节严重的，处三年以上七年以下有期徒刑，并处罚金。强迫他人吸食、注射毒品的，处三年以上十年以下有期徒刑，并处罚金。</p>
                <p class="mb-2">根据《中华人民共和国预防未成年人犯罪法》第三十八条，本法所称“严重不良行为”包括吸食、注射毒品等九类严重危害社会，尚不够刑事处罚的违法行为。</p>
                <p class="mb-2">根据《中华人民共和国禁毒法》第十八条规定：“未成年人的父母或者其他监护人应当对未成年人进行毒品危害的教育，防止其吸食、注射毒品或者进行其他毒品违法犯罪活动。”</p>
                <p>同学们，我们要牢记这些法律知识，不仅自己要远离毒品，还要告诉身边的人，让大家都知道毒品的危害和相关法律规定，一起守护我们的美好生活。</p>
              </div>
              <div class="mt-3 flex items-center gap-3">
                <button id="startRead" class="bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded">开始阅读（计时）</button>
                <div class="text-sm text-slate-600">剩余时间：<span id="timer" class="font-mono">03:00</span></div>
                <div class="progress w-40 md:w-64"><div id="timeline"></div></div>
                <div class="text-xs text-slate-500">系统记录回读次数</div>
              </div>
              <div id="readMsg" class="text-sm text-amber-700 mt-2 hidden">提示：请专注阅读，不要来回切换页面。</div>
            </div>
          </div>

          <div class="mt-4 p-4 border rounded-lg bg-white">
            <div class="font-semibold mb-2">即时反馈：填空题</div>
            <form id="quizForm" class="space-y-3">
              <div class="text-sm">文中明确禁止非法种植
                  <input name="q1" class="border rounded px-2 py-1 w-32" placeholder="____"/>
                  等毒品原植物。</div>
                <div class="text-sm">走私、贩卖、运输、制造毒品，不管数量多少，都要被追究
                  <input name="q2" class="border rounded px-2 py-1 w-32" placeholder="____"/>
                  责任。</div>
                <div class="text-sm">《预防未成年人犯罪法》把吸食、注射毒品列为
                  <input name="q3" class="border rounded px-2 py-1 w-32" placeholder="________"/>。
                </div>
              <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">提交答案</button>
            </form>
            <div id="srReport" class="mt-3 hidden">
              <div class="p-3 bg-slate-50 rounded">
                <div class="font-semibold mb-1">个人速读报告</div>
                <div class="text-sm text-slate-700">阅读时长：<span id="srTime">--</span>；回读次数：<span id="srBack">0</span>；正确率：<span id="srAcc">--</span></div>
                <div id="srHint" class="text-sm text-amber-700 mt-1"></div>
              </div>
            </div>
          </div>

          <div class="mt-4 p-4 border rounded-lg bg-slate-50">
            <div class="font-semibold mb-2">集体点评（教师端）</div>
            <div class="text-sm text-slate-700">可投屏展示班级汇总报告：零回读比例、高频错项（如漏写“刑事责任”“严重不良行为”）。</div>
          </div>
        </div>

        <!-- 2. 分组任务 -->
        <div class="border-t pt-5">
          <div class="font-semibold mb-3">任务二：分组速读与信息提炼（8分钟）</div>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="p-4 border rounded-lg">
              <div class="font-semibold">拒毒方法组</div>
              <p class="text-sm text-slate-600">使用“标注工具”划出拒毒技巧。示例文本（约600字占位）。</p>
              <textarea class="mt-2 w-full border rounded p-2 text-sm h-40">掌握正确的拒毒防毒技巧
1.了解毒品危害，减弱好奇心。树立“毒品绝不能碰”的理念，对毒品说不！
2.坚决拒绝同伴的吸毒邀请。大多数人第一次吸毒都是受朋友“邀请”，远离有吸毒、贩毒行为的人。如遇陌生人递可疑零食、饮料，要冷静拒绝，及时报告。
3.在娱乐服务场所要提高警惕。在娱乐服务场所不接受陌生人提供的香烟和零食饮料，留意饮料是否有针眼和开封的迹象，离开座位回来后不喝开封的饮料。
4.不为他人保管、投递、买卖不明物品。如果被委托保管、投递、买卖的物品是毒品，有可能在法律上被认定为贩毒者的同谋。
5.建立健康的生活方式。不用毒品满足心理需求，学会规律生活、合理安排工作和娱乐时间、正确应对压力、保持良好情绪。</textarea>
              <button class="mt-2 px-3 py-1 rounded bg-sky-600 text-white text-sm group-highlight" data-keys="冷静拒绝,及时报告,核对来源,不随意尝试">一键标注关键词</button>
              <div class="mt-2 text-xs text-slate-500">智能体匹配核心词库：冷静拒绝/及时报告/核对来源/不随意尝试</div>
            </div>
            <div class="p-4 border rounded-lg">
              <div class="font-semibold">法律常识组</div>
              <p class="text-sm text-slate-600">在“笔记模块”记录核心条款。</p>
              <div class="space-y-2">
                <input class="w-full border rounded p-2 text-sm" value="《刑法》第三百五十七条：毒品的法律定义"/>
                <input class="w-full border rounded p-2 text-sm" value="走私、贩卖、运输、制造毒品都要被追究刑事责任"/>
                <input class="w-full border rounded p-2 text-sm" value="《禁毒法》第十八条：监护人要进行毒品危害教育"/>
              </div>
            </div>
            <div class="p-4 border rounded-lg">
              <div class="font-semibold">危害警示组</div>
              <p class="text-sm text-slate-600">用“思维导图插件（简易）”补全三大模块。</p>
              <div class="grid-auto">
                <div class="p-3 bg-slate-50 rounded">
                  <div class="font-medium text-sm">个人危害</div>
                  <textarea class="mt-1 w-full border rounded p-2 text-sm h-24">个人危害：佳佳被诱骗吸食海洛因后迅速上瘾，情绪恐惧、学习受阻，还需要接受戒断治疗，身体和心理都受到影响。</textarea>
                </div>
                <div class="p-3 bg-slate-50 rounded">
                  <div class="font-medium text-sm">家庭危害</div>
                  <textarea class="mt-1 w-full border rounded p-2 text-sm h-24">家庭危害：父母因工作忽视孩子，导致缺乏沟通与关爱，毒品消耗了生活费和班费，加重家庭经济与情感压力。</textarea>
                </div>
                <div class="p-3 bg-slate-50 rounded">
                  <div class="font-medium text-sm">社会危害</div>
                  <textarea class="mt-1 w-full border rounded p-2 text-sm h-24">社会危害：楼下的张姨吸毒、藏毒、教唆未成年人吸毒，破坏社区安全秩序，最终被公安机关抓获，需要投入公共资源治理。</textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-4 p-4 border rounded-lg bg-white">
            <div class="font-semibold mb-2">成果共享与整合</div>
            <button id="mergeBoard" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">一键生成“禁毒知识框架图”</button>
            <div id="board" class="mt-3 p-3 bg-slate-50 rounded text-sm text-slate-700"></div>
            <div id="boardInsights" class="mt-3 hidden"></div>
          </div>
        </div>

        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="qa">进入答疑互动</button>
        </div>
      </div>
    </section>

    <!-- 答疑互动 -->
    <section id="qa" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">智能体答疑互动</h2>
          <div class="pill bg-fuchsia-50 text-fuchsia-700 px-3 py-1 text-sm">用时建议：3分钟</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">疑问收集</div>
            <input id="qaInput" class="w-full border rounded p-2 text-sm" placeholder="输入你的问题，例如：什么是合成毒品？"/>
            <button id="qaAsk" class="mt-2 px-3 py-2 rounded bg-sky-600 text-white text-sm">提交问题</button>
            <div id="qaList" class="mt-3 space-y-2 text-sm"></div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">智能体答复（知识库占位）</div>
            <div id="qaAnswer" class="text-sm text-slate-700 space-y-2">
              <div class="text-slate-500">提交问题后，这里会给出漫画化/流程化简答。例如：</div>
              <div class="p-2 bg-slate-50 rounded">
                所谓“提神保健品”可能暗藏毒品成分，一旦摄入就会损害身体，必须第一时间拒绝并告知老师。
              </div>
              <div class="p-2 bg-slate-50 rounded">
                发现同学拿可疑物品：先远离，保持冷静；再报告老师与家长；必要时联系民警并说明时间、地点、物品特征。
              </div>
            </div>
          </div>
        </div>
        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="scenario">进入情景模拟</button>
        </div>
      </div>
    </section>

    <!-- 情景模拟 -->
    <section id="scenario" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">智能体情景模拟</h2>
          <div class="pill bg-violet-50 text-violet-700 px-3 py-1 text-sm">用时建议：4分钟</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">情景视频</div>
            <p class="text-sm text-slate-600 mb-2">场景来源：《危险的好奇》。同路同学小赵在小卖部取出“提神保健品”药片冲饮后立刻亢奋。</p>
            <div class="bg-slate-50 border rounded p-3 text-sm text-slate-700 leading-6 mb-3">
              “他越是神秘，我就越是好奇。带着这份好奇，我打算哪天放学时跟他要一颗，我也泡瓶饮料试试。
              可是，上了今天这堂课，我终于明白，他所说的‘提神保健品’就是毒品。我被自己的好奇吓出一身冷汗。”
            </div>
            <video class="w-full rounded-lg bg-slate-100" controls preload="none" poster="/api/placeholder/640/360">
              <source src="" type="video/mp4" />
            </video>
            <div class="text-xs text-slate-500 mt-2">占位视频：请替换为校内资源链接</div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">录制与提交</div>
            <p class="text-sm text-slate-700 mb-2">
              使用设备“录音/录像”，演示你的应对过程，包含“拒绝话术”和“后续做法”。
            </p>
            <div class="space-y-2">
              <label class="text-sm">上传文件（占位）：</label>
              <input type="file" id="uploadMedia" accept="video/*,audio/*" class="block text-sm" />
              <button id="checkKeywords" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">关键词检测</button>
              <div id="kwResult" class="text-sm mt-2"></div>
              <div class="text-xs text-slate-500">建议包含：谢谢，我不需要；我要告诉老师/家长；远离陌生人的可疑礼物</div>
            </div>
          </div>
        </div>
        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="creative">进入创意创作</button>
        </div>
      </div>
    </section>

    <!-- 创意创作 -->
    <section id="creative" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">智能体创意工坊</h2>
          <div class="pill bg-rose-50 text-rose-700 px-3 py-1 text-sm">用时建议：10分钟</div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- 手抄报 -->
          <div class="p-4 border rounded-lg">
            <div class="font-semibold">手抄报组</div>
            <div class="text-sm text-slate-600">选择模板，填充内容，插入图库元素。</div>
            <div class="mt-3 space-y-2">
              <select id="posterTpl" class="border rounded px-2 py-1 text-sm">
                <option value="classic">模板A：标题栏+漫画区+文字区</option>
                <option value="clean">模板B：左右分栏</option>
                <option value="grid">模板C：四象限信息块</option>
              </select>
              <input id="posterTitle" class="w-full border rounded p-2 text-sm" placeholder="手抄报标题（如：学法拒毒护成长）"/>
              <textarea id="posterText" class="w-full border rounded p-2 text-sm h-28" placeholder="添加内容：拒毒小口诀、法律小贴士、危害警示…"></textarea>
              <div class="flex flex-wrap gap-2 text-xs">
                <span class="tag pill px-2 py-1 cursor-pointer gallery">禁止毒品符号</span>
                <span class="tag-safe pill px-2 py-1 cursor-pointer gallery">保护伞图案</span>
                <span class="tag pill px-2 py-1 cursor-pointer gallery">安全盾牌</span>
              </div>
              <button id="genPoster" class="mt-2 px-3 py-2 rounded bg-sky-600 text-white text-sm">生成预览</button>
              <div id="posterPreview" class="mt-3 p-3 bg-slate-50 rounded text-sm"></div>
            </div>
          </div>

          <!-- 书签 -->
          <div class="p-4 border rounded-lg">
            <div class="font-semibold">书签组</div>
            <div class="text-sm text-slate-600">选择底图，添加卡通图案与押韵标语。</div>
            <div class="mt-3 space-y-2">
              <select id="bookmarkBg" class="border rounded px-2 py-1 text-sm">
                <option value="blue">蓝色卡通底图</option>
                <option value="green">绿色卡通底图</option>
                <option value="orange">橙色卡通底图</option>
              </select>
              <input id="sloganHead" class="w-full border rounded p-2 text-sm" placeholder="标语前半句（如：对可疑零食说）"/>
              <button id="rhymeSuggest" class="px-3 py-1 rounded bg-emerald-600 text-white text-sm">押韵推荐</button>
              <input id="sloganFull" class="w-full border rounded p-2 text-sm" placeholder="完整标语（自动或手动填写）"/>
              <button id="genBookmark" class="px-3 py-2 rounded bg-sky-600 text-white text-sm">生成预览</button>
              <div id="bookmarkPreview" class="mt-3 p-3 bg-slate-50 rounded text-sm"></div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="peer">进入作品互评</button>
        </div>
      </div>
    </section>

    <!-- 互评 -->
    <section id="peer" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">作品展示与互评</h2>
          <div class="pill bg-amber-50 text-amber-700 px-3 py-1 text-sm">用时建议：3分钟（融入创作后段）</div>
        </div>
        <div class="grid-auto">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">上传作品（占位）</div>
            <input type="file" multiple class="block text-sm" />
            <div class="text-xs text-slate-500 mt-2">实际接入“班级展示区”后自动汇集作品。</div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">评价量表（自动+互评）</div>
            <div class="text-sm text-slate-700 mb-2">维度：信息准确性、创意性、传播性（各5分）。</div>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span>信息准确性</span>
                <input type="range" min="0" max="5" value="5" class="peer-range" />
              </div>
              <div class="flex items-center justify-between">
                <span>创意性</span>
                <input type="range" min="0" max="5" value="4" class="peer-range" />
              </div>
              <div class="flex items-center justify-between">
                <span>传播性</span>
                <input type="range" min="0" max="5" value="4" class="peer-range" />
              </div>
              <button id="calcScore" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">计算得分</button>
              <div id="peerScore" class="text-sm text-slate-700"></div>
            </div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">成果表彰</div>
            <div class="text-sm text-slate-700">结合自动评分+互评，评选“最佳创意奖/最佳宣传奖”。系统弹出电子奖状。</div>
            <button id="makeAwards" class="px-3 py-2 rounded bg-sky-600 text-white text-sm">生成电子奖状（占位）</button>
            <div id="awardArea" class="mt-3 grid-auto"></div>
          </div>
        </div>
        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="summary">进入课堂总结</button>
        </div>
      </div>
    </section>

    <!-- 总结与延伸 -->
    <section id="summary" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">智能体总结延伸</h2>
          <div class="pill bg-teal-50 text-teal-700 px-3 py-1 text-sm">用时建议：3分钟</div>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">课堂知识清单</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
              <li>速读技巧：不回读、抓关键词</li>
              <li>法律要点：《刑法》第三百五十七条、《禁毒法》第十八条</li>
              <li>核心拒毒方法：冷静拒绝、及时报告</li>
            </ul>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">班级口号</div>
            <div class="p-3 bg-slate-50 rounded text-center font-semibold">珍爱生命，远离毒品；学法明志，守护纯真！</div>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">教师寄语</div>
            <p class="text-sm text-slate-700">把今天学到的本领带回家，向家人分享禁毒知识，一起守护健康生活。</p>
          </div>
        </div>
        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="home">推送家庭任务</button>
        </div>
      </div>
    </section>

    <!-- 家校协同 -->
    <section id="home" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">家庭延伸任务</h2>
          <div class="pill bg-indigo-50 text-indigo-700 px-3 py-1 text-sm">弹性时间</div>
        </div>
        <ol class="list-decimal pl-5 space-y-2 text-slate-700 text-sm">
          <li>与家长共读《禁毒亲子手册》，使用“不回读”速读技巧。</li>
          <li>合作创作“家庭拒毒宣言”海报（可用简易绘图工具）。</li>
          <li>录制1分钟“亲子拒毒视频”，上传家庭任务区。</li>
        </ol>
        <div class="mt-4 p-4 border rounded-lg bg-slate-50">
          <div class="font-semibold mb-2">家长操作指南（占位）</div>
          <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
            <li>扫码或链接进入“家庭专区”。</li>
            <li>点击“阅读手册”→“创作宣言”→“上传视频”。</li>
            <li>遇到问题点击“家长帮助”。</li>
          </ul>
        </div>
        <div class="mt-6">
          <button class="next-btn bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded" data-next="rubric">查看评价表</button>
        </div>
      </div>
    </section>

    <!-- 评价表 -->
    <section id="rubric" class="section">
      <div class="card p-5 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">阅读评价表（总分100分）</h2>
          <div class="pill bg-lime-50 text-lime-700 px-3 py-1 text-sm">即时评价/单元综合</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">基础信息</div>
            <table class="w-full text-sm">
              <tbody class="align-top text-slate-700">
                <tr><td class="py-1 w-32 text-slate-500">评价对象</td><td>五年级学生（个体/小组）</td></tr>
                <tr><td class="py-1 text-slate-500">评价维度</td><td>提高阅读速度/筛选关键信息/整合信息</td></tr>
                <tr><td class="py-1 text-slate-500">评价方式</td><td>AI自动评分+教师复核</td></tr>
                <tr><td class="py-1 text-slate-500">周期</td><td>单课即时/单元综合</td></tr>
              </tbody>
            </table>
          </div>
          <div class="p-4 border rounded-lg">
            <div class="font-semibold mb-2">AI即时报告（演示）</div>
            <div class="text-sm text-slate-700">
              <div>默读速度：<span id="aiSpeed">--</span></div>
              <div>无回读习惯：<span id="aiBack">--</span></div>
              <div>关键词匹配：<span id="aiKey">--</span></div>
              <div>思维导图完整性：<span id="aiMap">--</span></div>
              <div>跨文本关联：<span id="aiCross">--</span></div>
            </div>
          </div>
        </div>

        <div class="mt-4 p-4 border rounded-lg">
          <div class="font-semibold mb-2">评分标准摘要</div>
          <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
            <li>阅读速度（30）：≤1分40秒达标；1分41秒-2分基本达标；>2分未达标</li>
            <li>无回读（10）：0次回看=10分；1-2次=5分；≥3次=0分</li>
            <li>关键词定位（35）：匹配≥80%得高分</li>
            <li>信息准确性（10）：与原文一致得分</li>
            <li>整合信息（35）：三模块完整、逻辑清晰；跨文本关联越多越好</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-center text-xs text-slate-500">
    校园定制版教学智能体系统接入占位：将本页各功能按钮与平台API对接即可。
  </footer>

  <script>
    const sdk = new KeepworkSDK({
      timeout: 30000,
    });
    console.log(`Keepwork SDK initialized token: ${sdk.token}`);

    const lessonReference = [
  "课堂背景：小学五年级禁毒主题阅读课。",
  "速读技巧：不回读、抓关键词，标记关键法律表达。",
  "核心条文：《刑法》第三百五十七条、《禁毒法》第十八条、《预防未成年人犯罪法》第三十八条。",
  "拒绝话术：谢谢，我不需要；我要告诉老师或家长；远离陌生人的可疑礼物。",
  "案例提醒：危险的好奇、藏在小书包里的秘密等真实故事要及时报告。",
    ].join("\n");

    function escapeHTML(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderLLMText(text) {
      return String(text || '')
        .trim()
        .split(/\n+/)
        .map((line) => `<div>${escapeHTML(line.trim())}</div>`)
        .join("");
    }

    async function callLessonLLM(messages, options = {}) {
      const config = typeof options === 'number' ? { temperature: options } : options || {};
      const temperature = typeof config.temperature === 'number' ? config.temperature : 0.3;
      const onStream = typeof config.onStream === 'function' ? config.onStream : null;
      try {
        if (onStream) {
          let lastChunk = "";
          const response = await sdk.aiChat.chat({
            model: "keepwork-pro",
            temperature,
            messages,
            stream: true,
            onMessage: (chunk) => {
              let textChunk = "";
              if (typeof chunk === "string") {
                textChunk = chunk;
              } else if (chunk && typeof chunk === "object") {
                if (typeof chunk.text === "string") {
                  textChunk = chunk.text;
                } else if (typeof chunk.content === "string") {
                  textChunk = chunk.content;
                } else {
                  try {
                    textChunk = JSON.stringify(chunk);
                  } catch (_) {
                    textChunk = String(chunk);
                  }
                }
              } else {
                textChunk = String(chunk || "");
              }
              lastChunk = textChunk;
              onStream(textChunk);
            },
          });
          if (!lastChunk && typeof response === "string") {
            lastChunk = response;
          }
          if (!lastChunk && response && typeof response === "object") {
            if (Array.isArray(response.choices) && response.choices[0]?.message?.content) {
              const content = response.choices[0].message.content;
              if (typeof content === "string") {
                lastChunk = content;
              }
            } else if (typeof response.text === "string") {
              lastChunk = response.text;
            }
          }
          return String(lastChunk || "").trim();
        }

        const response = await sdk.aiChat.chat({
          model: "keepwork-pro",
          temperature,
          messages,
          stream: false,
        });
        if (typeof response === "string") {
          return response.trim();
        }
        if (response && typeof response === "object") {
          if (Array.isArray(response.choices) && response.choices[0]?.message?.content) {
            const content = response.choices[0].message.content;
            if (typeof content === "string") {
              return content.trim();
            }
            if (Array.isArray(content)) {
              return content
                .map((part) => {
                  if (typeof part === "string") return part;
                  if (part && typeof part === "object") {
                    if (typeof part.text === "string") return part.text;
                    if (typeof part.content === "string") return part.content;
                  }
                  return "";
                })
                .join("")
                .trim();
            }
          }
          if (Array.isArray(response.content)) {
            return response.content
              .map((part) => (typeof part === "string" ? part : part?.text || ""))
              .join("")
              .trim();
          }
          if (Object.prototype.hasOwnProperty.call(response, "text")) {
            return String(response.text || "").trim();
          }
        }
        if (response == null) {
          return "";
        }
        if (typeof response === "object") {
          try {
            return JSON.stringify(response);
          } catch (err) {
            console.warn("callLessonLLM fallback stringify error", err);
            return "";
          }
        }
        return String(response || "").trim();
      } catch (error) {
        console.error("callLessonLLM error", error);
        throw error;
      }
    }

    // 简易导航
    const sections = document.querySelectorAll('.section');
    function showSection(id){
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.getElementById('navSelect').value = id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> showSection(btn.dataset.target));
    });
    document.getElementById('navSelect').addEventListener('change', (e)=> showSection(e.target.value));
    document.querySelectorAll('.next-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> showSection(btn.dataset.next));
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='n'){
        const order = ['intro','speedread','group','qa','scenario','creative','peer','summary','home','rubric'];
        const current = Array.from(sections).findIndex(s=>s.classList.contains('active'));
        const next = Math.min(order.length-1, current+1);
        showSection(order[next]);
      }
    });

    // 速读计时与回读检测
  let reading = false, startTime=0, timerInt=null, remaining=180, backCount=0, scrollOps=0;
    const srText = document.getElementById('srText');
    const timerEl = document.getElementById('timer');
    const timeline = document.getElementById('timeline');
    const readMsg = document.getElementById('readMsg');
    const srReport = document.getElementById('srReport');
    const srTime = document.getElementById('srTime');
    const srBack = document.getElementById('srBack');
    const srAcc = document.getElementById('srAcc');
    const srHint = document.getElementById('srHint');

    function fmt(sec){ const m = String(Math.floor(sec/60)).padStart(2,'0'); const s = String(sec%60).padStart(2,'0'); return m+':'+s; }

    document.getElementById('startRead').addEventListener('click', ()=>{
      reading = true;
      startTime = Date.now();
  remaining = 180;
      backCount = 0;
      scrollOps = 0;
      srReport.classList.add('hidden');
      readMsg.classList.remove('hidden');
      timerEl.textContent = fmt(remaining);
      timeline.style.width = '0%';
      if(timerInt) clearInterval(timerInt);
      timerInt = setInterval(()=>{
        remaining--;
        timerEl.textContent = fmt(Math.max(0, remaining));
  timeline.style.width = (100*(1-(remaining/180))).toFixed(1)+'%';
        if(remaining<=0){
          clearInterval(timerInt);
          reading = false;
          readMsg.classList.add('hidden');
          // 自动收起文本（示意）
          srText.classList.add('no-select');
          srText.style.opacity = 0.7;
        }
      }, 1000);
    });

    // 记录“回读”行为：快速上下切换（滚动阈值）、失焦再返回
    srText.addEventListener('scroll', ()=>{
      if(!reading) return;
      // 粗略判定：3秒内反向滚动两次判为一次回读
      scrollOps++;
      if(scrollOps % 8 === 0) { backCount++; }
    });
    document.addEventListener('visibilitychange', ()=>{
      if(!reading) return;
      if (document.visibilityState === 'hidden') {
        // 页面切出
      } else {
        // 切回判为一次回读
        backCount++;
      }
    });

    // 即时反馈测验
    document.getElementById('quizForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const a1 = (fd.get('q1')||'').trim();
      const a2 = (fd.get('q2')||'').trim();
      const a3 = (fd.get('q3')||'').trim();

  const gold = { q1: '罂粟', q2: '刑事', q3: '严重不良行为' };
      let score = 0;
  if(a1.includes(gold.q1)) score+=33.4;
  if(a2.includes(gold.q2)) score+=33.3;
  if(a3.includes('严重')) score+=33.3;

      const spent = Math.round((Date.now()-startTime)/1000);
      srTime.textContent = spent>0 ? fmt(spent) : '--';
      srBack.textContent = backCount;
      srAcc.textContent = Math.round(score)+'%';
  srHint.textContent = score<100 ? '提示：留意文中“刑事责任”“严重不良行为”“监护责任”等关键词，理解其含义。' : '做得好！保持零回读与关键词速读。';
      srReport.classList.remove('hidden');
    });

    // 分组：关键词一键标注（示意）
    document.querySelectorAll('.group-highlight').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const area = btn.parentElement.querySelector('textarea');
        const text = area.value;
        const keys = (btn.dataset.keys || '').split(',');
        let highlighted = text;
        keys.forEach(k=>{
          if(!k) return;
          const re = new RegExp(k, 'g');
          highlighted = highlighted.replace(re, '【'+k+'】');
        });
        const preview = document.createElement('div');
        preview.className = 'mt-2 p-2 bg-slate-50 rounded text-sm';
        preview.textContent = highlighted || '（请先输入文本再标注）';
        btn.parentElement.appendChild(preview);
      });
    });

    // 合并“禁毒知识框架图”（示意）
    document.getElementById('mergeBoard').addEventListener('click', async ()=>{
      const cols = document.querySelectorAll('#speedread .grid.md\\:grid-cols-3 .p-4.border.rounded-lg');
      const rejectPreview = cols[0].querySelector('.mt-2.p-2.bg-slate-50.rounded.text-sm');
      const lawInputs = cols[1].querySelectorAll('input');
      const mapAreas = cols[2].querySelectorAll('textarea');
      const board = document.getElementById('board');

      const methodsText = (rejectPreview?.textContent || '冷静拒绝、及时报告、核对来源、不随意尝试').trim();
      const methodsHTML = escapeHTML(methodsText).replace(/\n/g, '<br/>');

      const lawRaw = Array.from(lawInputs).map((input) => input.value.trim()).filter(Boolean);
      const lawHTML = lawRaw.length
        ? lawRaw.map((text) => `<li>${escapeHTML(text)}</li>`).join('')
        : '<li>未成年人不得接触毒品</li><li>发现可疑情况及时报告</li>';

      const hazardLabels = ['个人危害', '家庭危害', '社会危害'];
      const hazardBlocks = hazardLabels
        .map((label, index) => {
          const raw = (mapAreas[index]?.value || '').trim();
          const safe = escapeHTML(raw || '补充危害描述');
          return `<div><div class="font-medium">${label}</div><div class="text-slate-700">${safe}</div></div>`;
        })
        .join('<hr class="my-2 border-dashed"/>');

      board.innerHTML = `
        <div class="grid md:grid-cols-4 gap-3">
          <div class="p-3 bg-white rounded border"><div class="font-semibold">学习要点</div><div class="text-sm text-slate-700">毒品定义、刑事责任、家庭监护义务（结合课堂材料及时复述）。</div></div>
          <div class="p-3 bg-white rounded border"><div class="font-semibold">拒毒方法</div><div class="text-sm text-slate-700">${methodsHTML}</div></div>
          <div class="p-3 bg-white rounded border"><div class="font-semibold">法律条文</div><ul class="list-disc pl-5 text-sm text-slate-700">${lawHTML}</ul></div>
          <div class="p-3 bg-white rounded border"><div class="font-semibold">危害警示</div><div class="text-sm">${hazardBlocks}</div></div>
        </div>
      `;

      document.getElementById('aiKey').textContent = '≥80%（示例）';
      document.getElementById('aiMap').textContent = '模块完整（示例）';
      document.getElementById('aiCross').textContent = '已关联≥3处（示例）';

      const insightsBox = document.getElementById('boardInsights');
      if (insightsBox) {
        insightsBox.classList.remove('hidden');
        insightsBox.innerHTML = '<div class="p-3 bg-slate-50 rounded text-sm text-slate-600 flex items-center gap-2"><span class="spinner"></span><span>智能体正在总结重点…</span></div>';
      }

      await generateBoardInsights({
        methodsText,
        lawTexts: lawRaw,
        hazardTexts: hazardLabels
          .map((label, index) => {
            const raw = (mapAreas[index]?.value || '').trim();
            return raw ? `${label}：${raw}` : '';
          })
          .filter(Boolean),
      });
    });

    async function generateBoardInsights({ methodsText, lawTexts, hazardTexts }) {
      const container = document.getElementById('boardInsights');
      if (!container) {
        return;
      }
      container.innerHTML = '<div class="p-3 bg-slate-50 rounded text-sm text-slate-600 flex items-center gap-2"><span class="spinner"></span><span>智能体正在总结重点…</span></div>';
      try {
        const hazardLine = hazardTexts.length ? hazardTexts.join('；') : '个人、家庭、社会都会受损。';
        const lawLine = lawTexts.length ? lawTexts.join('；') : '未成年人不得接触或传播毒品信息，发现异常要报告。';
        const messages = [
          {
            role: 'system',
            content: '你是一名小学禁毒课堂助教，需要把课堂成果总结成简明可执行的重点，强调法律意识、勇敢拒绝与及时报告。',
          },
          {
            role: 'user',
            content: `${lessonReference}\n拒毒方法整理：${methodsText}\n法律提醒：${lawLine}\n危害摘录：${hazardLine}\n请用三句话总结今天的禁毒知识框架，格式如“①…②…③…”，每句不超过40个字。`,
          },
        ];
        const summary = await callLessonLLM(messages, { temperature: 0.2 });
        container.innerHTML = `<div class="p-3 bg-white border border-slate-200 rounded text-sm leading-6 text-slate-700">${renderLLMText(summary)}</div>`;
      } catch (error) {
        console.error('board insights error', error);
        container.innerHTML = '<div class="p-3 bg-amber-50 rounded text-sm text-amber-700">暂时无法生成智能总结，请稍后再试。</div>';
      }
    }

    // 答疑：接入 LLM 答复
    const qaList = document.getElementById('qaList');
    const qaAnswer = document.getElementById('qaAnswer');
    const qaButton = document.getElementById('qaAsk');
    const qaInput = document.getElementById('qaInput');
    const qaState = { pending: false };

    async function handleQuestionSubmit() {
      if (qaState.pending) {
        return;
      }
      const question = qaInput.value.trim();
      if (!question) {
        return;
      }
      qaInput.value = '';

      const item = document.createElement('div');
      item.className = 'p-2 bg-slate-50 rounded';
      item.textContent = '问题：' + question;
      qaList.prepend(item);

      const placeholder = document.createElement('div');
      placeholder.className = 'p-2 bg-emerald-50 rounded text-sm text-slate-600 flex items-center gap-2';
      placeholder.innerHTML = '<span class="spinner"></span><span>智能体正在思考…</span>';
      placeholder.dataset.mode = 'loading';
      qaAnswer.prepend(placeholder);

      qaState.pending = true;
      qaButton.disabled = true;
      qaButton.textContent = '生成中…';

      try {
        let streamedText = '';
        const answerText = await getLessonAnswer(question, (partial) => {
          streamedText = String(partial || '');
          const html = renderLLMText(streamedText);
          if (placeholder.dataset.mode !== 'streaming') {
            placeholder.dataset.mode = 'streaming';
            placeholder.className = 'p-2 bg-emerald-50 rounded text-sm leading-6 text-slate-700';
          }
          placeholder.innerHTML = html || '<div class="text-slate-600">正在生成内容…</div>';
        });
        const finalText = String(answerText || streamedText || '').trim();
        placeholder.className = 'p-2 bg-emerald-50 rounded text-sm leading-6 text-slate-700';
        if (finalText) {
          placeholder.innerHTML = renderLLMText(finalText);
        } else {
          placeholder.innerHTML = '<div class="text-slate-600">暂无可用内容，请稍后再试。</div>';
        }
      } catch (error) {
        placeholder.className = 'p-2 bg-amber-50 rounded text-sm text-amber-700';
        placeholder.textContent = '暂时无法获取智能答复，稍后再试或请教师解答。';
      } finally {
        qaState.pending = false;
        qaButton.disabled = false;
        qaButton.textContent = '提交问题';
        qaInput.focus();
      }
    }

    async function getLessonAnswer(question, onStream) {
      const messages = [
        {
          role: 'system',
          content: '你是一名小学禁毒教育辅导老师，要结合中国禁毒法规和校园安全守则回答问题，语言要亲切但专业，不要提及自己是AI。',
        },
        {
          role: 'user',
          content: `${lessonReference}\n学生问题：${question}\n请用两到三条要点给出解读与建议，每条不超过60个字。`,
        },
      ];
      return await callLessonLLM(messages, { temperature: 0.25, onStream });
    }

    qaButton.addEventListener('click', handleQuestionSubmit);
    qaInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleQuestionSubmit();
      }
    });

    // 情景：关键词检测（文本占位检测）
    document.getElementById('checkKeywords').addEventListener('click', ()=>{
      // 实际应对音视频转写后进行关键词识别
      const advised = ['谢谢，我不需要','告诉老师','告诉家长','远离'];
      const found = [];
      // 占位：从自填标语等处抓取模拟
      const stash = [
        document.getElementById('posterText')?.value || '',
        document.getElementById('sloganFull')?.value || ''
      ].join(' ');
      advised.forEach(k=>{ if(stash.includes(k)) found.push(k); });
      const res = document.getElementById('kwResult');
      if(found.length===0){
        res.innerHTML = '<span class="tag-warn pill px-2 py-1">未检测到关键话术</span>，提示：记得加上“谢谢，我不需要”“我要告诉老师/家长”。';
      }else{
        res.innerHTML = '<span class="pill px-2 py-1 bg-emerald-50 text-emerald-700">合格</span> 已包含：'+found.join('、');
      }
    });

    // 创意：手抄报预览
    document.querySelectorAll('.gallery').forEach(el=>{
      el.addEventListener('click', ()=>{
        const poster = document.getElementById('posterText');
        poster.value += (poster.value ? '\n' : '') + '【插入元素】' + el.textContent;
      });
    });
    document.getElementById('genPoster').addEventListener('click', ()=>{
      const tpl = document.getElementById('posterTpl').value;
      const title = document.getElementById('posterTitle').value || '禁毒主题手抄报';
      const text = (document.getElementById('posterText').value || '内容区（拒毒口诀/法律贴士/危害警示）').replace(/\n/g,'<br/>');
      const preview = `
        <div class="border rounded p-4 bg-white">
          <div class="text-center font-bold text-lg mb-2">${title}</div>
          <div class="grid gap-3 ${tpl==='grid'?'md:grid-cols-2':''}">
            <div class="p-2 bg-sky-50 rounded">漫画/图示区（占位）</div>
            <div class="p-2 bg-slate-50 rounded">${text}</div>
          </div>
        </div>`;
      document.getElementById('posterPreview').innerHTML = preview;
    });

    // 创意：押韵推荐与书签预览
    const rhymeButton = document.getElementById('rhymeSuggest');
    const rhymeIdeasBox = document.createElement('div');
    rhymeIdeasBox.id = 'rhymeIdeas';
    rhymeIdeasBox.className = 'text-xs text-slate-500 mt-1 space-y-1 hidden';
    rhymeButton.insertAdjacentElement('afterend', rhymeIdeasBox);

    rhymeButton.addEventListener('click', async ()=>{
      const head = (document.getElementById('sloganHead').value || '对可疑零食说').replace(/[，。！,.!]?$/, '');
      const fallback = [
        `${head}不！远离风险守护我`,
        `${head}不！健康校园我来守`,
        `${head}不！安全第一记心口`,
        `${head}不！家校同心不碰触`
      ];

      rhymeIdeasBox.classList.remove('hidden');
      rhymeIdeasBox.innerHTML = '<div class="flex items-center gap-2 text-slate-600"><span class="spinner"></span><span>智能体正在构思押韵标语…</span></div>';
      rhymeButton.disabled = true;
      rhymeButton.textContent = '生成中…';

      try {
        const messages = [
          {
            role: 'system',
            content: '你是一名禁毒宣传文案创作者，擅长写出朗朗上口、押韵的中文标语。',
          },
          {
            role: 'user',
            content: `${lessonReference}\n标语前半句：${head}……\n请补全三个不同的押韵标语，每条控制在16字以内，突出“拒绝、远离、报告”主题，列表输出。`,
          },
        ];
        const raw = await callLessonLLM(messages, { temperature: 0.5 });
        let options = raw
          .split(/\n+/)
          .map((line) => line.replace(/^[\-•·\d\.)\s]+/, '').trim())
          .filter(Boolean);
        if (options.length === 0) {
          options = fallback;
        }

        const slogans = options.slice(0, 3);
        document.getElementById('sloganFull').value = slogans[0];
        rhymeIdeasBox.innerHTML = slogans
          .map((line, index) => `<button type="button" class="w-full text-left px-2 py-1 rounded border border-transparent hover:border-sky-400" data-value="${escapeHTML(line)}">${index + 1}. ${escapeHTML(line)}</button>`)
          .join('');
      } catch (error) {
        console.error('rhyme suggest error', error);
        const choice = fallback[Math.floor(Math.random() * fallback.length)];
        document.getElementById('sloganFull').value = choice;
        rhymeIdeasBox.innerHTML = '<div class="text-amber-700">智能体暂时未返回结果，已提供预设押韵。</div>';
      } finally {
        rhymeButton.disabled = false;
        rhymeButton.textContent = '押韵推荐';
      }
    });

    rhymeIdeasBox.addEventListener('click', (event)=>{
      const button = event.target.closest('button[data-value]');
      if (!button) {
        return;
      }
      document.getElementById('sloganFull').value = button.dataset.value;
    });
    document.getElementById('genBookmark').addEventListener('click', ()=>{
      const bg = document.getElementById('bookmarkBg').value;
      const slogan = document.getElementById('sloganFull').value || '对可疑零食说“不”！';
      const color = bg==='blue'?'bg-sky-50':bg==='green'?'bg-emerald-50':'bg-amber-50';
      const preview = `
        <div class="border rounded p-3 ${color}">
          <div class="aspect-[2/5] bg-white rounded grid place-items-center text-center p-3">
            <div>
              <div class="text-sm text-slate-500 mb-2">卡通图案（占位）</div>
              <div class="font-semibold">${slogan}</div>
            </div>
          </div>
        </div>`;
      document.getElementById('bookmarkPreview').innerHTML = preview;
    });

    // 互评分数
    document.getElementById('calcScore').addEventListener('click', ()=>{
      const ranges = document.querySelectorAll('.peer-range');
      let sum = 0; ranges.forEach(r=> sum += Number(r.value));
      const total = sum; // 最高15分的互评演示
      document.getElementById('peerScore').textContent = '本作品互评得分（示例）: '+ total + ' / 15';
    });

    // 电子奖状占位
    document.getElementById('makeAwards').addEventListener('click', ()=>{
      const area = document.getElementById('awardArea');
      area.innerHTML = '';
      ['最佳创意奖','最佳宣传奖'].forEach(title=>{
        const card = document.createElement('div');
        card.className = 'p-4 border rounded bg-white';
        card.innerHTML = `
          <div class="text-center">
            <div class="text-lg font-bold accent">${title}</div>
            <div class="text-sm text-slate-600">颁发给：_______________</div>
            <div class="mt-2 text-xs text-slate-500">系统生成电子奖状（占位）。</div>
          </div>
        `;
        area.appendChild(card);
      });
    });

    // 评价表动态演示
    // 从速读环节填充
    const aiSpeed = document.getElementById('aiSpeed');
    const aiBack = document.getElementById('aiBack');
    setInterval(()=>{
      // 演示：如果已经读过
      const t = srTime.textContent;
      if(t && t!=='--'){
        aiSpeed.textContent = t + '（示例映射到速度分档）';
        aiBack.textContent = srBack.textContent + '次';
      }
    }, 1500);
  </script>
</body>
</html>
