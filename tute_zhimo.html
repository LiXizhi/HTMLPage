<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>â€œæ™ºè°‹â€BIç³»ç»Ÿâ€”â€”æ•°å­—å­ªç”Ÿæ€»æ§ä¸­å¿ƒï¼ˆH5ï¼‰</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.4"></script>
    <style>
      /* å¹³æ»‘è¿‡æ¸¡ä¸å¯æ‹–æ‹½è¾…åŠ© */
      .transition-base {
        transition: all 0.2s ease;
      }
      .drag-over {
        outline: 2px dashed #93c5fd;
        outline-offset: -8px;
      }
      /* ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ– */
      .scroll-area {
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- é¡¶æ  -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded bg-sky-500 flex items-center justify-center text-white font-bold">æ™º</div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold">â€œæ™ºè°‹â€BIç³»ç»Ÿâ€”â€”æ•°å­—å­ªç”Ÿæ€»æ§ä¸­å¿ƒ</h1>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">å½“å‰è§†è§’</label>
            <select id="roleSelect" class="text-sm border border-slate-300 rounded px-2 py-1 bg-white">
              <option value="student">å­¦ç”Ÿ</option>
              <option value="teacher">æ•™å¸ˆ</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="max-w-7xl mx-auto grid grid-cols-12 gap-4 px-4 sm:px-6 lg:px-8 py-4">
      <!-- ä¾§æ  -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <nav class="bg-white border border-slate-200 rounded-lg p-3 sticky top-20">
          <ul id="navList" class="space-y-1 text-sm">
            <li><button data-target="section-dashboard" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100 bg-sky-50 text-sky-700 font-medium">æ¦‚è§ˆ/BI</button></li>
            <li><button data-target="section-sim" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">è™šæ‹Ÿä»¿çœŸï¼ˆParacraft/Keepworkï¼‰</button></li>
            <li><button data-target="section-plan" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">å­¦ä¹ è·¯å¾„ä¸è®¡åˆ’</button></li>
            <li><button data-target="section-projects" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">é¡¹ç›®åä½œï¼ˆä»»åŠ¡çœ‹æ¿ï¼‰</button></li>
            <li><button data-target="section-feedback" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">å®æ—¶æŒ‡å¯¼ä¸åé¦ˆ</button></li>
            <li><button data-target="section-monitor" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">å­¦ä¹ è¿›åº¦ç›‘æ§ï¼ˆæ•™å¸ˆï¼‰</button></li>
            <li><button data-target="section-materials" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">é…å¥—æ•™æ/èµ„æº</button></li>
            <li><button data-target="section-settings" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">é›†æˆè®¾ç½®ï¼ˆKeepwork/Paracraftï¼‰</button></li>
          </ul>
        </nav>
      </aside>

      <!-- å†…å®¹åŒº -->
      <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-6">
        <!-- æ¦‚è§ˆ/BI -->
        <section id="section-dashboard" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">æ¦‚è§ˆä¸æ•°æ®æ´å¯Ÿ</h2>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">æ´»è·ƒå­¦ç”Ÿ</div>
              <div id="kpiStudents" class="text-2xl font-bold">0</div>
              <div class="text-xs text-emerald-600 mt-1">+ ä»Šæ—¥æ–°å¢ <span id="kpiNewStudents">0</span></div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">å¹³å‡å®Œæˆç‡</div>
              <div id="kpiCompletion" class="text-2xl font-bold">0%</div>
              <div class="text-xs text-sky-600 mt-1">å­¦ä¹ è®¡åˆ’æ¨è¿›</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">å¹³å‡è¯„åˆ†</div>
              <div id="kpiScore" class="text-2xl font-bold">0</div>
              <div class="text-xs text-amber-600 mt-1">æœ€æ–°æµ‹è¯„å‡åˆ†</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">æ­£åœ¨è¿›è¡Œçš„å›¢é˜Ÿé¡¹ç›®</div>
              <div id="kpiProjects" class="text-2xl font-bold">0</div>
              <div class="text-xs text-fuchsia-600 mt-1">åä½œä¸ä»»åŠ¡åˆ†å·¥</div>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="col-span-1 lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">7æ—¥å­¦ä¹ æ´»è·ƒè¶‹åŠ¿</div>
                <button id="refreshChartsBtn" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">åˆ·æ–°</button>
              </div>
              <canvas id="lineChart" class="mt-2"></canvas>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium">å®Œæˆç‡åˆ†å¸ƒ</div>
              <canvas id="doughnutChart" class="mt-2"></canvas>
            </div>
          </div>
        </section>

        <!-- è™šæ‹Ÿä»¿çœŸï¼ˆParacraft/Keepworkï¼‰ -->
        <section id="section-sim" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">è™šæ‹Ÿä»¿çœŸæ•™å­¦ä¸å®è®­</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">å†…åµŒ Keepwork è¯¾ç¨‹/é¡¹ç›®é¡µ</div>
              <div class="space-y-2">
                <input id="keepworkUrl" type="url" placeholder="ç²˜è´´ Keepwork é¡µé¢é“¾æ¥ï¼ˆå¦‚è¯¾ç¨‹ã€é¡¹ç›®æˆ–æ•™æï¼‰" class="w-full border border-slate-300 rounded px-3 py-2" />
                <div class="flex gap-2">
                  <button id="embedKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">åµŒå…¥é¢„è§ˆ</button>
                  <a id="openKeepworkBtn" href="#" target="_blank" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">åœ¨æ–°æ ‡ç­¾æ‰“å¼€</a>
                </div>
                <div class="rounded border border-slate-200 overflow-hidden">
                  <iframe id="keepworkFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                </div>
                <p class="text-xs text-slate-500">å¦‚é¡µé¢ç¦æ­¢è·¨åŸŸå†…åµŒï¼Œè¯·ä½¿ç”¨â€œåœ¨æ–°æ ‡ç­¾æ‰“å¼€â€ã€‚</p>
              </div>
            </div>

            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">Paracraft ä¸–ç•Œ/åœºæ™¯</div>
              <div class="space-y-2">
                <input id="paracraftWebUrl" type="url" placeholder="å¯é€‰ï¼šParacraft çš„ Web é¢„è§ˆé“¾æ¥ï¼ˆè‹¥æœ‰ï¼‰" class="w-full border border-slate-300 rounded px-3 py-2" />
                <input id="paracraftDeepLinkTpl" type="text" placeholder="Paracraft æ·±é“¾æ¨¡æ¿ï¼ˆå¦‚ paracraft://open?url={WORLD_URL}ï¼‰" class="w-full border border-slate-300 rounded px-3 py-2" />
                <div class="flex gap-2">
                  <button id="embedParacraftBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">å†…åµŒ/é¢„è§ˆ</button>
                  <a id="openParacraftBtn" href="#" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">åœ¨ Paracraft å®¢æˆ·ç«¯æ‰“å¼€</a>
                </div>
                <div class="rounded border border-slate-200 overflow-hidden">
                  <iframe id="paracraftFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                </div>
                <p class="text-xs text-slate-500">è¯´æ˜ï¼šè‹¥æœ‰ Paracraft Web ç‰ˆ/åµŒå…¥å™¨ï¼Œå¯ç›´æ¥ iframeï¼›è‹¥éœ€å®¢æˆ·ç«¯ï¼Œè¯·é…ç½®â€œæ·±é“¾æ¨¡æ¿â€ï¼Œç³»ç»Ÿå°†è°ƒç”¨æœ¬åœ°å®¢æˆ·ç«¯æ‰“å¼€ä¸–ç•Œã€‚</p>
              </div>
            </div>
          </div>
        </section>

        <!-- å­¦ä¹ è·¯å¾„ä¸è®¡åˆ’ -->
        <section id="section-plan" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ä¸è®¡åˆ’</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex flex-wrap items-end gap-2">
                <div class="grow">
                  <label class="text-xs text-slate-500">å­¦ä¹ ç›®æ ‡</label>
                  <input id="planTitle" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="ä¾‹å¦‚ï¼šå®Œæˆæ•°å­—å­ªç”ŸåŸºç¡€å»ºæ¨¡" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">æˆªæ­¢æ—¥æœŸ</label>
                  <input id="planDue" type="date" class="w-full border border-slate-300 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">éš¾åº¦</label>
                  <select id="planLevel" class="w-full border border-slate-300 rounded px-3 py-2">
                    <option value="å…¥é—¨">å…¥é—¨</option>
                    <option value="è¿›é˜¶">è¿›é˜¶</option>
                    <option value="é«˜çº§">é«˜çº§</option>
                  </select>
                </div>
                <button id="addPlanBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">æ·»åŠ </button>
              </div>
              <ul id="planList" class="mt-3 divide-y divide-slate-200"></ul>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">æ¨èè·¯å¾„ï¼ˆå¯é€‰ï¼‰</div>
              <div class="space-y-2 text-sm">
                <button data-tpl="åŸºç¡€å…¥é—¨" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">åŸºç¡€å…¥é—¨ï¼šè®¤è¯†æ•°å­—å­ªç”Ÿä¸Paracraft</button>
                <button data-tpl="å»ºæ¨¡å®è·µ" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">å»ºæ¨¡å®è·µï¼šä»ç®€å•å¯¹è±¡åˆ°åœºæ™¯æ­å»º</button>
                <button data-tpl="åä½œé¡¹ç›®" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">åä½œé¡¹ç›®ï¼šå›¢é˜Ÿåˆ†å·¥ä¸ç‰ˆæœ¬åä½œ</button>
                <button data-tpl="ç»¼åˆå®è®­" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">ç»¼åˆå®è®­ï¼šä»éœ€æ±‚åˆ°æˆæœå±•ç¤º</button>
              </div>
            </div>
          </div>
        </section>

        <!-- é¡¹ç›®åä½œï¼ˆçœ‹æ¿ï¼‰ -->
        <section id="section-projects" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">é¡¹ç›®ä¸å›¢é˜Ÿåä½œï¼ˆçœ‹æ¿ï¼‰</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <input id="taskTitle" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="æ–°ä»»åŠ¡æ ‡é¢˜ï¼Œå¦‚ï¼šæ­å»ºæœºæˆ¿å­ç³»ç»Ÿæ¨¡å‹" />
            <select id="taskAssignee" class="border border-slate-300 rounded px-3 py-2">
              <option value="">æœªæŒ‡æ´¾</option>
            </select>
            <button id="addTaskBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">æ·»åŠ ä»»åŠ¡</button>
            <button id="exportBoardBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">å¯¼å‡ºJSON</button>
            <label class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 cursor-pointer">
              å¯¼å…¥JSON
              <input id="importBoardFile" type="file" accept="application/json" class="hidden" />
            </label>
            <a id="keepworkProjectLink" class="ml-auto text-sm text-sky-700 underline hidden" target="_blank">æ‰“å¼€ Keepwork é¡¹ç›®</a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">å¾…åŠ</div>
              <ul id="colTodo" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">è¿›è¡Œä¸­</div>
              <ul id="colDoing" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">å·²å®Œæˆ</div>
              <ul id="colDone" class="min-h-40 space-y-2"></ul>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-3">æç¤ºï¼šæ‹–æ‹½ä»»åŠ¡ä»¥åˆ‡æ¢çŠ¶æ€</p>
        </section>

        <!-- å®æ—¶æŒ‡å¯¼ä¸åé¦ˆ -->
        <section id="section-feedback" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">å®æ—¶æŒ‡å¯¼ä¸åé¦ˆï¼ˆæ•™å¸ˆ/å­¦ç”ŸåŒç«¯æ¨¡æ‹Ÿï¼‰</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3 flex flex-col">
              <div id="chatLog" class="scroll-area flex-1 min-h-[240px] max-h-[360px] overflow-y-auto space-y-2">
                <!-- æ¶ˆæ¯æ°”æ³¡ -->
              </div>
              <div class="mt-3 flex items-end gap-2">
                <textarea id="chatInput" rows="2" class="border border-slate-300 rounded px-3 py-2 w-full" placeholder="è¾“å…¥é—®é¢˜æˆ–åé¦ˆ..."></textarea>
                <button id="sendMsgBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">å‘é€</button>
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="è¯·åˆ†äº«å½“å‰ä¸–ç•Œçš„æˆªå›¾æˆ–å½•åƒã€‚">è¯·åˆ†äº«æˆªå›¾</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="ä½ å¯ä»¥å°è¯•å¤ç”¨æ¨¡æ¿å¹¶è°ƒæ•´å‚æ•°ã€‚">å°è¯•å¤ç”¨æ¨¡æ¿</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="å»ºè®®å…ˆå®Œæˆâ€˜åŸºç¡€å»ºæ¨¡â€™çš„å‰ä¸¤ä¸ªä»»åŠ¡ã€‚">å…ˆå®Œæˆå‰ç½®ä»»åŠ¡</button>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">è¯¾å ‚çŠ¶æ€</div>
              <div class="space-y-2 text-sm">
                <label class="flex items-center gap-2"><input id="liveIndicator" type="checkbox" class="accent-emerald-600" /> å¼€å¯â€œåœ¨çº¿è¾…å¯¼â€çŠ¶æ€</label>
                <label class="flex items-center gap-2"><input id="autoTips" type="checkbox" class="accent-emerald-600" /> æ™ºèƒ½æç¤ºï¼ˆæ ¹æ®å®Œæˆç‡ï¼‰</label>
              </div>
              <hr class="my-2" />
              <div>
                <div class="text-sm font-medium mb-1">å¿«é€Ÿè¯„ä»·</div>
                <div class="flex flex-wrap gap-2">
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-emerald-100 text-emerald-700" data-text="ğŸ‘ è¿›æ­¥æ˜æ˜¾">ğŸ‘ è¿›æ­¥æ˜æ˜¾</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-amber-100 text-amber-700" data-text="ğŸ§­ æ³¨æ„æŒ‰è®¡åˆ’æ‰§è¡Œ">ğŸ§­ æ³¨æ„æŒ‰è®¡åˆ’æ‰§è¡Œ</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-fuchsia-100 text-fuchsia-700" data-text="ğŸ¤ å›¢é˜Ÿåä½œä½³">ğŸ¤ å›¢é˜Ÿåä½œä½³</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-rose-100 text-rose-700" data-text="ğŸ“Œ éœ€æ”¹è¿›å‘½åè§„èŒƒ">ğŸ“Œ éœ€æ”¹è¿›å‘½åè§„èŒƒ</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- å­¦ä¹ è¿›åº¦ç›‘æ§ï¼ˆæ•™å¸ˆï¼‰ -->
        <section id="section-monitor" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">å­¦ä¹ è¿›åº¦ç›‘æ§ï¼ˆæ•™å¸ˆè§†è§’ï¼‰</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <button id="syncFromKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">ä» Keepwork åŒæ­¥</button>
            <button id="addStudentBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">æ·»åŠ å­¦ç”Ÿ</button>
            <span class="text-xs text-slate-500">æ¼”ç¤ºæ•°æ®å¯ç¼–è¾‘ï¼Œæ”¯æŒå¯¼å‡ºCSV</span>
            <button id="exportCSVBtn" class="ml-auto px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">å¯¼å‡º CSV</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
              <thead class="bg-slate-50">
                <tr>
                  <th class="text-left px-3 py-2 border-b">å§“å</th>
                  <th class="text-left px-3 py-2 border-b">å®Œæˆç‡</th>
                  <th class="text-left px-3 py-2 border-b">è¯„åˆ†</th>
                  <th class="text-left px-3 py-2 border-b">å½“å‰ä»»åŠ¡</th>
                  <th class="text-left px-3 py-2 border-b">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="studentTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- é…å¥—æ•™æ/èµ„æº -->
        <section id="section-materials" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">é…å¥—æ•™æä¸èµ„æºä¸­å¿ƒ</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">æ•™æï¼ˆKeepwork/ç½‘é¡µ/PDFï¼‰</div>
              <input id="materialUrl" type="url" placeholder="ç²˜è´´æ•™æURLï¼ˆæ”¯æŒ Keepwork æˆ– PDF é“¾æ¥ï¼‰" class="w-full border border-slate-300 rounded px-3 py-2" />
              <div class="flex gap-2 mt-2">
                <button id="embedMaterialBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">åµŒå…¥é¢„è§ˆ</button>
                <a id="openMaterialBtn" target="_blank" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">æ–°æ ‡ç­¾æ‰“å¼€</a>
              </div>
              <div class="rounded border border-slate-200 overflow-hidden mt-2">
                <iframe id="materialFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">è¯¾ç¨‹/å®éªŒæ¸…å•</div>
              <ul id="materialList" class="space-y-2 text-sm">
                <!-- åŠ¨æ€å¡«å…… -->
              </ul>
              <div class="mt-2 flex gap-2">
                <input id="newMaterialTitle" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="èµ„æºæ ‡é¢˜" />
                <input id="newMaterialLink" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="èµ„æºé“¾æ¥" />
                <button id="addMaterialBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">æ·»åŠ </button>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">ç§»åŠ¨å­¦ä¹ å»ºè®®</div>
              <ul class="list-disc pl-5 text-sm space-y-1 text-slate-700">
                <li>åˆ©ç”¨ç¢ç‰‡æ—¶é—´æŸ¥çœ‹æ•™æä¸ä»»åŠ¡è¿›åº¦</li>
                <li>åœ¨ç§»åŠ¨ç«¯ç›´æ¥æ‰“å¼€ Keepwork é“¾æ¥ï¼Œéšæ—¶æµè§ˆè¯¾ç¨‹</li>
                <li>åŒæ­¥è®¡åˆ’åˆ°æ—¥å†ï¼Œæ¥æ”¶åˆ°æœŸæé†’</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- é›†æˆè®¾ç½® -->
        <section id="section-settings" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">é›†æˆè®¾ç½®ï¼ˆKeepwork / Paracraftï¼‰</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-200 p-3 space-y-2">
              <div class="text-sm font-medium">Keepwork</div>
              <input id="keepworkProjectUrl" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork é¡¹ç›®/è¯¾ç¨‹URLï¼ˆç”¨äºå¿«é€Ÿæ‰“å¼€ä¸çœ‹æ¿è·³è½¬ï¼‰" />
              <input id="keepworkApiBase" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork API Baseï¼ˆå¯é€‰ï¼Œç¤ºä¾‹ï¼šhttps://api.keepwork.comï¼‰" />
              <input id="keepworkToken" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork API Tokenï¼ˆå¯é€‰ï¼Œç”¨äºåç«¯å¯¹æ¥ï¼‰" />
              <div class="flex gap-2">
                <button id="saveKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">ä¿å­˜</button>
                <button id="testKeepworkBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">è¿é€šæ€§æµ‹è¯•</button>
              </div>
              <p id="keepworkStatus" class="text-xs text-slate-500"></p>
            </div>
            <div class="rounded-lg border border-slate-200 p-3 space-y-2">
              <div class="text-sm font-medium">Paracraft</div>
              <input id="paracraftDeepLink" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="æ·±é“¾æ¨¡æ¿ï¼šparacraft://open?url={WORLD_URL}" />
              <input id="paracraftWorldUrl" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="é»˜è®¤ WORLD_URLï¼ˆå¯ä¸è¯¾ç¨‹å…³è”ï¼‰" />
              <div class="flex gap-2">
                <button id="saveParacraftBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">ä¿å­˜</button>
                <button id="tryOpenParacraftBtn" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">å°è¯•æ‰“å¼€å®¢æˆ·ç«¯</button>
              </div>
              <p class="text-xs text-slate-500">å¦‚éœ€ Web é¢„è§ˆï¼Œè¯·æä¾›å¯å†…åµŒçš„ URLï¼›å¦‚éœ€å®¢æˆ·ç«¯ï¼Œé…ç½®æ·±é“¾æ¨¡æ¿ã€‚</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6 text-xs text-slate-500">
      <hr class="my-4" />
      <p>æ¸©é¦¨æç¤ºï¼šä¸ Keepwork/Paracraft çš„æ·±åº¦é›†æˆéœ€é…ç½®å®é™…é“¾æ¥ã€Token ä¸æœåŠ¡ç«¯æ¥å£ã€‚</p>
    </footer>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      // ---------- æœ¬åœ°å­˜å‚¨ä¸å·¥å…· ----------
      const LS = {
        get: async (k, d) => {
          try {
            const data = await sdk.personalPageStore.loadPageData("zhimo_system", k);
            return structuredClone(data ?? d);
          } catch (e) {
            console.warn("è¯»å–æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼", e);
            return d;
          }
        },
        set: async (k, v) => {
          try {
            await sdk.personalPageStore.savePageData("zhimo_system", k, v);
          } catch (e) {
            console.warn("ä¿å­˜æ•°æ®å¤±è´¥", e);
          }
        },
      };
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
      const fmtPercent = (n) => Math.round(n * 100) + "%";

      // ---------- å¯¼èˆª ----------
      const sections = $$(".card");
      const navBtns = $$("#navList .nav-btn");
      function showSection(id) {
        sections.forEach((s) => s.classList.toggle("hidden", s.id !== id));
        navBtns.forEach((b) => {
          const active = b.dataset.target === id;
          b.classList.toggle("bg-sky-50", active);
          b.classList.toggle("text-sky-700", active);
          b.classList.toggle("font-medium", active);
        });
        LS.set("activeSection", id);
      }
      navBtns.forEach((b) => b.addEventListener("click", () => showSection(b.dataset.target)));

      // ---------- è§’è‰²åˆ‡æ¢ ----------
      const roleSelect = $("#roleSelect");
      roleSelect.addEventListener("change", () => {
        LS.set("role", roleSelect.value);
        renderRoleHints();
      });
      function renderRoleHints() {
        const isTeacher = roleSelect.value === "teacher";
        // æ•™å¸ˆä¸“ç”¨æ¿å—é«˜äº®æç¤º
        $("#section-monitor").classList.toggle("ring-2", isTeacher);
        $("#section-monitor").classList.toggle("ring-amber-300", isTeacher);
      }

      // ---------- æ¦‚è§ˆ/BI å›¾è¡¨ ----------
      let lineChart, doughnutChart;
      function rand(n, m) {
        return Math.floor(n + Math.random() * (m - n + 1));
      }
      function initCharts() {
        const ctx1 = $("#lineChart").getContext("2d");
        const ctx2 = $("#doughnutChart").getContext("2d");
        const labels = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"];
        const data = labels.map(() => rand(20, 120));
        const completed = rand(30, 70);
        const partial = rand(10, 40);
        const notstarted = 100 - Math.min(95, completed + partial);

        if (lineChart) lineChart.destroy();
        if (doughnutChart) doughnutChart.destroy();

        lineChart = new Chart(ctx1, {
          type: "line",
          data: { labels, datasets: [{ label: "æ´»è·ƒåº¦", data, borderColor: "#0ea5e9", backgroundColor: "rgba(14,165,233,.15)", tension: 0.3, fill: true }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
        });
        doughnutChart = new Chart(ctx2, {
          type: "doughnut",
          data: { labels: ["å·²å®Œæˆ", "è¿›è¡Œä¸­", "æœªå¼€å§‹"], datasets: [{ data: [completed, partial, notstarted], backgroundColor: ["#10b981", "#f59e0b", "#e5e7eb"] }] },
          options: { plugins: { legend: { position: "bottom" } } },
        });

        // KPI æ›´æ–°ï¼ˆæ¼”ç¤ºï¼‰
        $("#kpiStudents").textContent = rand(80, 180);
        $("#kpiNewStudents").textContent = rand(1, 8);
        const avgCompletion = Math.min(98, completed + partial * 0.5);
        $("#kpiCompletion").textContent = Math.round(avgCompletion) + "%";
        $("#kpiScore").textContent = rand(70, 92);
        $("#kpiProjects").textContent = rand(2, 8);
      }
      initCharts();
      $("#refreshChartsBtn").addEventListener("click", initCharts);

      // ---------- Keepwork åµŒå…¥ ----------
      const keepworkUrl = $("#keepworkUrl");
      const keepworkFrame = $("#keepworkFrame");
      const openKeepworkBtn = $("#openKeepworkBtn");
      $("#embedKeepworkBtn").addEventListener("click", () => {
        const url = keepworkUrl.value.trim();
        if (!url) return alert("è¯·å¡«å†™ Keepwork é“¾æ¥");
        keepworkFrame.src = url;
        openKeepworkBtn.href = url;
        LS.set("keepwork.lastUrl", url);
      });
      openKeepworkBtn.addEventListener("click", (e) => {
        const url = keepworkUrl.value.trim();
        if (!url) e.preventDefault();
      });

      // ---------- Paracraft åµŒå…¥/æ·±é“¾ ----------
      const paracraftWebUrl = $("#paracraftWebUrl");
      const paracraftDeepLinkTpl = $("#paracraftDeepLinkTpl");
      const paracraftFrame = $("#paracraftFrame");
      const openParacraftBtn = $("#openParacraftBtn");

      function buildDeepLink(worldUrl, tpl) {
        return tpl.replace("{WORLD_URL}", encodeURIComponent(worldUrl));
      }
      $("#embedParacraftBtn").addEventListener("click", () => {
        const webUrl = paracraftWebUrl.value.trim();
        if (webUrl) {
          paracraftFrame.src = webUrl;
          LS.set("paracraft.webUrl", webUrl);
        } else {
          alert("è¯·æä¾›å¯å†…åµŒçš„ Web é¢„è§ˆURLï¼Œæˆ–ä½¿ç”¨å³ä¾§â€œåœ¨å®¢æˆ·ç«¯æ‰“å¼€â€ã€‚");
        }
      });
      openParacraftBtn.addEventListener("click", async (e) => {
        const tpl = paracraftDeepLinkTpl.value.trim() || (await LS.get("settings.paracraft.deepLink", ""));
        const world = paracraftWebUrl.value.trim() || (await LS.get("settings.paracraft.worldUrl", ""));
        if (!tpl || !world) {
          e.preventDefault();
          return alert("è¯·åœ¨â€œé›†æˆè®¾ç½®â€ä¸­é…ç½®æ·±é“¾æ¨¡æ¿ä¸ WORLD_URLï¼Œæˆ–åœ¨æ­¤å¡«å†™ã€‚");
        }
        const link = buildDeepLink(world, tpl);
        openParacraftBtn.href = link;
      });

      // ---------- å­¦ä¹ è·¯å¾„ä¸è®¡åˆ’ ----------
      let plans = [];
      function renderPlans() {
        // Ensure plans is an array
        if (!Array.isArray(plans)) {
          plans = [];
        }

        const root = $("#planList");
        root.innerHTML = "";
        plans.forEach((p, idx) => {
          const li = document.createElement("li");
          li.className = "py-2 flex items-center gap-3";
          li.innerHTML = `
          <input type="checkbox" class="accent-emerald-600 plan-done" data-id="${idx}" ${p.done ? "checked" : ""}/>
          <div class="grow">
            <div class="font-medium">${p.title || "æœªå‘½åç›®æ ‡"} <span class="text-xs text-slate-500">Â· ${p.level || "å…¥é—¨"}</span></div>
            <div class="text-xs text-slate-500">æˆªæ­¢ï¼š${p.due || "æœªè®¾ç½®"}</div>
          </div>
          <button data-id="${idx}" class="plan-edit text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ç¼–è¾‘</button>
          <button data-id="${idx}" class="plan-del text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">åˆ é™¤</button>
        `;
          root.appendChild(li);
        });
        LS.set("plans", plans);
      }
      $("#addPlanBtn").addEventListener("click", () => {
        const title = $("#planTitle").value.trim();
        const due = $("#planDue").value;
        const level = $("#planLevel").value;
        if (!title) return alert("è¯·å¡«å†™å­¦ä¹ ç›®æ ‡");
        plans.push({ title, due, level, done: false });
        $("#planTitle").value = "";
        renderPlans();
      });
      $("#planList").addEventListener("change", (e) => {
        if (e.target.classList.contains("plan-done")) {
          const idx = +e.target.dataset.id;
          plans[idx].done = e.target.checked;
          renderPlans();
        }
      });
      $("#planList").addEventListener("click", (e) => {
        if (e.target.classList.contains("plan-del")) {
          const idx = +e.target.dataset.id;
          plans.splice(idx, 1);
          renderPlans();
        }
        if (e.target.classList.contains("plan-edit")) {
          const idx = +e.target.dataset.id;
          const p = plans[idx];
          const title = prompt("å­¦ä¹ ç›®æ ‡", p.title);
          if (title === null) return;
          const due = prompt("æˆªæ­¢æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰", p.due);
          if (due === null) return;
          const level = prompt("éš¾åº¦ï¼ˆå…¥é—¨/è¿›é˜¶/é«˜çº§ï¼‰", p.level);
          if (level === null) return;
          plans[idx] = { ...p, title, due, level };
          renderPlans();
        }
      });
      $$(".tpl-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          plans.push({
            title: btn.dataset.tpl,
            due: "",
            level: ["å…¥é—¨", "è¿›é˜¶", "é«˜çº§"][Math.floor(Math.random() * 3)],
            done: false,
          });
          renderPlans();
        })
      );
      // ---------- çœ‹æ¿ ----------
      let board = { todo: [], doing: [], done: [] };
      const cols = { todo: $("#colTodo"), doing: $("#colDoing"), done: $("#colDone") };
      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }
      function renderBoard() {
        // Ensure board has proper structure
        if (!board || typeof board !== "object") {
          board = { todo: [], doing: [], done: [] };
        }
        ["todo", "doing", "done"].forEach((col) => {
          if (!Array.isArray(board[col])) {
            board[col] = [];
          }
        });

        Object.values(cols).forEach((c) => (c.innerHTML = ""));
        ["todo", "doing", "done"].forEach((col) => {
          board[col].forEach((task) => {
            // Ensure task has an id
            if (!task.id) {
              task.id = uid();
            }
            const li = document.createElement("li");
            li.className = "draggable transition-base cursor-move p-3 rounded border border-slate-200 bg-white shadow-sm";
            li.draggable = true;
            li.dataset.id = task.id;
            li.dataset.col = col;
            li.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">${task.title}</div>
              <button class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 del-task">åˆ é™¤</button>
            </div>
            <div class="text-xs text-slate-500 mt-1">æŒ‡æ´¾ï¼š${task.assignee || "æœªæŒ‡æ´¾"}</div>
          `;
            cols[col].appendChild(li);
          });
        });
        LS.set("board", board);
      }
      function bindDnD() {
        $$(".draggable").forEach((el) => {
          el.addEventListener("dragstart", (e) => {
            const id = el.dataset.id;
            const from = el.dataset.col;
            if (id && from) {
              e.dataTransfer.setData("text/plain", JSON.stringify({ id, from }));
            } else {
              e.preventDefault(); // Prevent drag if data is invalid
            }
          });
        });
        Object.entries(cols).forEach(([col, ul]) => {
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            ul.classList.add("drag-over");
          });
          ul.addEventListener("dragleave", () => ul.classList.remove("drag-over"));
          ul.addEventListener("drop", (e) => {
            e.preventDefault();
            ul.classList.remove("drag-over");
            const dataString = e.dataTransfer.getData("text/plain");
            if (!dataString) return; // Guard against empty data
            try {
              const { id, from } = JSON.parse(dataString);
              if (from === col) return;
              const idx = board[from].findIndex((t) => t.id === id);
              if (idx === -1) return; // Guard against task not found
              const [task] = board[from].splice(idx, 1);
              board[col].push(task);
              renderBoard();
              bindDnD();
            } catch (error) {
              console.error("Error parsing drag data:", error);
            }
          });
          ul.addEventListener("click", (e) => {
            if (e.target.classList.contains("del-task")) {
              const li = e.target.closest("li");
              const id = li.dataset.id;
              const from = li.dataset.col;
              board[from] = board[from].filter((t) => t.id !== id);
              renderBoard();
              bindDnD();
            }
          });
        });
      }
      $("#addTaskBtn").addEventListener("click", () => {
        const title = $("#taskTitle").value.trim();
        const assignee = $("#taskAssignee").value.trim();
        if (!title) return alert("è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜");
        board.todo.push({ id: uid(), title, assignee });
        $("#taskTitle").value = "";
        renderBoard();
        bindDnD();
      });
      $("#exportBoardBtn").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(board, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "board.json";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#importBoardFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const importedBoard = JSON.parse(reader.result);
            // Validate the imported board structure
            if (importedBoard && typeof importedBoard === "object" && importedBoard.todo && importedBoard.doing && importedBoard.done) {
              // Ensure all tasks have IDs
              ["todo", "doing", "done"].forEach((col) => {
                if (Array.isArray(importedBoard[col])) {
                  importedBoard[col].forEach((task) => {
                    if (!task.id) {
                      task.id = uid();
                    }
                  });
                }
              });
              board = importedBoard;
              renderBoard();
              bindDnD();
            } else {
              alert("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®");
            }
          } catch (error) {
            console.error("JSON parse error:", error);
            alert("JSON è§£æå¤±è´¥");
          }
        };
        reader.readAsText(file);
      });
      // ---------- åä½œæˆå‘˜ï¼ˆç”¨äºæŒ‡æ´¾ï¼‰ ----------
      let roster = [];
      const assigneeSel = $("#taskAssignee");
      function renderRoster() {
        // Ensure roster is an array
        if (!Array.isArray(roster)) {
          roster = [];
        }
        assigneeSel.innerHTML = '<option value="">æœªæŒ‡æ´¾</option>' + roster.map((n) => `<option>${n}</option>`).join("");
      }
      // ---------- å®æ—¶æŒ‡å¯¼ä¸åé¦ˆï¼ˆæœ¬åœ°æ¨¡æ‹ŸèŠå¤©ï¼‰ ----------
      let chat = [];
      function renderChat() {
        // Ensure chat is an array
        if (!Array.isArray(chat)) {
          chat = [];
        }

        const log = $("#chatLog");
        log.innerHTML = "";
        chat.forEach((msg) => {
          const wrap = document.createElement("div");
          const isTeacher = msg.role === "teacher";
          wrap.className = `max-w-[85%] ${isTeacher ? "ml-auto" : ""}`;
          wrap.innerHTML = `
          <div class="text-xs text-slate-500 mb-1">${isTeacher ? "æ•™å¸ˆ" : "å­¦ç”Ÿ"} Â· ${new Date(msg.ts).toLocaleString()}</div>
          <div class="px-3 py-2 rounded ${isTeacher ? "bg-sky-600 text-white" : "bg-slate-100"}">${msg.text}</div>
        `;
          log.appendChild(wrap);
        });
        log.scrollTop = log.scrollHeight;
        LS.set("chat", chat);
      }
      $("#sendMsgBtn").addEventListener("click", () => {
        const text = $("#chatInput").value.trim();
        if (!text) return;
        chat.push({ role: roleSelect.value, text, ts: Date.now() });
        $("#chatInput").value = "";
        renderChat();
      });
      $$(".quick-reply").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: roleSelect.value, text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );
      $$(".badge-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: "teacher", text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );

      // è‡ªåŠ¨æç¤ºï¼ˆæ ¹æ®å®Œæˆç‡â€”â€”å–å†³äºè®¡åˆ’å®Œæˆä¸ªæ•°ï¼‰
      function autoTipsMaybe() {
        if (!$("#autoTips").checked) return;
        const doneCount = plans.filter((p) => p.done).length;
        const total = Math.max(1, plans.length);
        const completion = doneCount / total;
        if (completion < 0.3 && Math.random() < 0.2) {
          chat.push({ role: "teacher", text: "æç¤ºï¼šå»ºè®®å…ˆå®Œå–„åŸºç¡€ä»»åŠ¡ï¼Œå†è¿›å…¥å¤æ‚åœºæ™¯ã€‚", ts: Date.now() });
          renderChat();
        }
      }
      setInterval(autoTipsMaybe, 12000);
      // ---------- è¿›åº¦ç›‘æ§ï¼ˆæ•™å¸ˆï¼‰ ----------
      let students = [];
      function renderStudents() {
        // Ensure students is an array
        if (!Array.isArray(students)) {
          students = [];
        }

        const tb = $("#studentTbody");
        tb.innerHTML = "";
        students.forEach((s, i) => {
          const tr = document.createElement("tr");
          tr.className = "odd:bg-white even:bg-slate-50";
          tr.innerHTML = `
          <td class="px-3 py-2 border-b">${s.name}</td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="completion" type="range" min="0" max="1" step="0.01" value="${s.completion}" class="align-middle accent-sky-600">
            <span class="ml-2 text-xs">${fmtPercent(s.completion)}</span>
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="score" type="number" min="0" max="100" value="${s.score}" class="w-20 border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="task" type="text" value="${s.task}" class="w-full border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <button data-i="${i}" class="del-stu text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">åˆ é™¤</button>
          </td>
        `;
          tb.appendChild(tr);
        });
        LS.set("students", students);
      }
      $("#studentTbody").addEventListener("input", (e) => {
        const i = e.target.dataset.i;
        const k = e.target.dataset.k;
        if (k === "completion") {
          students[i][k] = +e.target.value;
          // æ›´æ–°åŒåˆ—æ–‡æœ¬
          e.target.parentElement.querySelector("span").textContent = fmtPercent(students[i][k]);
        } else if (k) {
          students[i][k] = k === "score" ? +e.target.value : e.target.value;
        }
        LS.set("students", students);
      });
      $("#studentTbody").addEventListener("click", (e) => {
        if (e.target.classList.contains("del-stu")) {
          const i = +e.target.dataset.i;
          students.splice(i, 1);
          renderStudents();
        }
      });
      $("#addStudentBtn").addEventListener("click", () => {
        const name = prompt("å­¦ç”Ÿå§“å");
        if (!name) return;
        students.push({ name, completion: 0, score: 0, task: "" });
        roster.push(name);
        LS.set("roster", roster);
        renderRoster();
        renderStudents();
      });
      $("#exportCSVBtn").addEventListener("click", () => {
        const lines = [["å§“å", "å®Œæˆç‡", "è¯„åˆ†", "å½“å‰ä»»åŠ¡"], ...students.map((s) => [s.name, s.completion, s.score, `"${s.task.replace(/"/g, '""')}"`])];
        const csv = lines.map((r) => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "students.csv";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#syncFromKeepworkBtn").addEventListener("click", async () => {
        // æç¤ºï¼šå®é™…å¯¹æ¥åº”è°ƒç”¨æœåŠ¡ç«¯æˆ– Keepwork APIã€‚è¿™é‡Œåšè¿é€šæ€§æ¼”ç¤ºã€‚
        const base = $("#keepworkApiBase").value.trim() || (await LS.get("settings.keepwork.apiBase", ""));
        if (!base) return alert("è¯·åœ¨â€œé›†æˆè®¾ç½®â€ä¸­æä¾› Keepwork API Base");
        try {
          // ç®€å•HEADè¯·æ±‚æµ‹è¯•å¯è¾¾æ€§ï¼ˆé¿å…CORSé”™è¯¯æ— æ³•æ•æ‰æ—¶çš„è¯¯åˆ¤ï¼‰
          const res = await fetch(base, { method: "HEAD", mode: "no-cors" });
          alert("å·²å°è¯•è¿æ¥ Keepwork APIï¼ˆæµè§ˆå™¨å¯èƒ½å›  CORS ä¸è¿”å›è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚å®é™…åŒæ­¥éœ€æœåŠ¡ç«¯ä»£ç†ã€‚");
        } catch (e) {
          alert("è¿æ¥å¤±è´¥ï¼š" + e.message);
        }
      });
      // ---------- æ•™æ/èµ„æº ----------
      let materials = [];
      function renderMaterials() {
        // Ensure materials is an array
        if (!Array.isArray(materials)) {
          materials = [];
        }

        const ul = $("#materialList");
        ul.innerHTML = "";
        materials.forEach((m, i) => {
          const li = document.createElement("li");
          li.className = "flex items-center gap-2";
          li.innerHTML = `
          <a class="text-sky-700 underline" href="${m.link || "#"}" target="_blank">${m.title}</a>
          <button data-i="${i}" class="mat-embed text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">åœ¨å·¦ä¾§é¢„è§ˆ</button>
          <button data-i="${i}" class="mat-del text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">åˆ é™¤</button>
        `;
          ul.appendChild(li);
        });
        LS.set("materials", materials);
      }
      $("#addMaterialBtn").addEventListener("click", () => {
        const title = $("#newMaterialTitle").value.trim();
        const link = $("#newMaterialLink").value.trim();
        if (!title || !link) return alert("è¯·è¾“å…¥èµ„æºæ ‡é¢˜ä¸é“¾æ¥");
        materials.push({ title, link });
        $("#newMaterialTitle").value = "";
        $("#newMaterialLink").value = "";
        renderMaterials();
      });
      $("#materialList").addEventListener("click", (e) => {
        if (e.target.classList.contains("mat-embed")) {
          const m = materials[+e.target.dataset.i];
          $("#materialUrl").value = m.link;
          $("#materialFrame").src = m.link;
          $("#openMaterialBtn").href = m.link;
        }
        if (e.target.classList.contains("mat-del")) {
          materials.splice(+e.target.dataset.i, 1);
          renderMaterials();
        }
      });
      renderMaterials();
      // åµŒå…¥
      $("#embedMaterialBtn").addEventListener("click", () => {
        const url = $("#materialUrl").value.trim();
        if (!url) return alert("è¯·è¾“å…¥æ•™æURL");
        $("#materialFrame").src = url;
        $("#openMaterialBtn").href = url;
      }); // ---------- è®¾ç½®ä¿å­˜/æµ‹è¯• ----------
      // Keepwork
      const keepworkProjectLink = $("#keepworkProjectLink");
      async function refreshKeepworkProjectLink() {
        const url = await LS.get("settings.keepwork.projectUrl", "");
        if (url) {
          keepworkProjectLink.href = url;
          keepworkProjectLink.classList.remove("hidden");
        } else {
          keepworkProjectLink.classList.add("hidden");
        }
      }
      async function saveKeepworkSettings() {
        const projectUrl = $("#keepworkProjectUrl").value.trim();
        const apiBase = $("#keepworkApiBase").value.trim();
        const token = $("#keepworkToken").value.trim();
        await LS.set("settings.keepwork.projectUrl", projectUrl);
        await LS.set("settings.keepwork.apiBase", apiBase);
        await LS.set("settings.keepwork.token", token);
        $("#keepworkStatus").textContent = "å·²ä¿å­˜ã€‚";
        await refreshKeepworkProjectLink();
      }
      $("#saveKeepworkBtn").addEventListener("click", saveKeepworkSettings);
      $("#testKeepworkBtn").addEventListener("click", async () => {
        const base = $("#keepworkApiBase").value.trim();
        if (!base) return alert("è¯·å…ˆå¡«å†™ Keepwork API Base");
        $("#keepworkStatus").textContent = "æµ‹è¯•ä¸­...";
        try {
          // ä»…æµ‹è¯•å¯è¾¾æ€§ï¼›å®é™…APIéœ€è¦å¸¦Tokenå¹¶ç”±æœåŠ¡ç«¯ä»£ç†ä»¥é¿å…æ³„æ¼
          await fetch(base, { method: "HEAD", mode: "no-cors" });
          $("#keepworkStatus").textContent = "å·²å°è¯•è¿æ¥ï¼ˆå¦‚å—CORSé™åˆ¶ï¼Œç»“æœä»¥å®é™…åç«¯ä¸ºå‡†ï¼‰ã€‚";
        } catch (e) {
          $("#keepworkStatus").textContent = "è¿æ¥å¤±è´¥ï¼š" + e.message;
        }
      }); // Remove immediate sync calls - data will be loaded in initializeApp()// Paracraft
      async function saveParacraftSettings() {
        const deepLink = $("#paracraftDeepLink").value.trim();
        const worldUrl = $("#paracraftWorldUrl").value.trim();
        await LS.set("settings.paracraft.deepLink", deepLink);
        await LS.set("settings.paracraft.worldUrl", worldUrl);
        $("#paracraftDeepLinkTpl").value = deepLink; // åŒæ­¥åˆ°ä»¿çœŸåŒº
        alert("Paracraft é…ç½®å·²ä¿å­˜");
      }
      $("#saveParacraftBtn").addEventListener("click", saveParacraftSettings);
      $("#tryOpenParacraftBtn").addEventListener("click", async () => {
        const deepLink = $("#paracraftDeepLink").value.trim();
        const worldUrl = $("#paracraftWorldUrl").value.trim();
        if (!deepLink || !worldUrl) return alert("è¯·å…ˆå¡«å†™æ·±é“¾æ¨¡æ¿ä¸ WORLD_URL");
        const href = buildDeepLink(worldUrl, deepLink);
        location.href = href; // å°è¯•è°ƒèµ·å®¢æˆ·ç«¯
      }); // Remove immediate sync calls - data will be loaded in initializeApp()      // Remove immediate sync calls - data will be loaded in initializeApp()// ---------- å¼‚æ­¥åˆå§‹åŒ–åº”ç”¨ ----------
      async function initializeApp() {
        try {
          // Load all data asynchronously
          const activeSection = await LS.get("activeSection", "section-dashboard");
          const role = await LS.get("role", "student");
          const keepworkLastUrl = await LS.get("keepwork.lastUrl", "");
          const paracraftWebUrlValue = await LS.get("paracraft.webUrl", "");
          const paracraftDeepLinkValue = await LS.get("settings.paracraft.deepLink", "");

          plans = await LS.get("plans", []);
          board = await LS.get("board", { todo: [], doing: [], done: [] });
          roster = await LS.get("roster", ["å¼ ä¸‰", "æå››", "ç‹äº”", "èµµå…­"]);
          chat = await LS.get("chat", []);
          students = await LS.get("students", [
            { name: "å¼ ä¸‰", completion: 0.4, score: 78, task: "å¯¼å…¥ç¤ºä¾‹ä¸–ç•Œå¹¶è¿è¡Œ" },
            { name: "æå››", completion: 0.7, score: 86, task: "æ­å»ºåŸºç¡€åœºæ™¯" },
            { name: "ç‹äº”", completion: 0.2, score: 65, task: "å­¦ä¹ å»ºæ¨¡è§„èŒƒ" },
          ]);
          materials = await LS.get("materials", [
            { title: "è¯¾ç¨‹å¤§çº²ï¼ˆKeepworkï¼‰", link: "" },
            { title: "å®éªŒæŒ‡å¯¼ä¹¦ï¼ˆPDFï¼‰", link: "" },
          ]);

          // Set up UI with loaded data
          showSection(activeSection);
          roleSelect.value = role;
          renderRoleHints();

          keepworkUrl.value = keepworkLastUrl;
          paracraftWebUrl.value = paracraftWebUrlValue;
          paracraftDeepLinkTpl.value = paracraftDeepLinkValue;

          // Fill settings
          $("#keepworkProjectUrl").value = await LS.get("settings.keepwork.projectUrl", "");
          $("#keepworkApiBase").value = await LS.get("settings.keepwork.apiBase", "");
          $("#keepworkToken").value = await LS.get("settings.keepwork.token", "");
          $("#paracraftDeepLink").value = await LS.get("settings.paracraft.deepLink", "");
          $("#paracraftWorldUrl").value = await LS.get("settings.paracraft.worldUrl", "");

          // Render all components
          renderPlans();
          renderBoard();
          bindDnD();
          renderRoster();
          renderChat();
          renderStudents();
          renderMaterials();
          refreshKeepworkProjectLink();

          // Check if first time and seed if needed
          const isSeeded = await LS.get("init.seeded", false);
          if (!isSeeded) {
            await LS.set("init.seeded", true);
            // å¯åœ¨æ­¤æ”¾ç½®æœºæ„å†…ç½‘å¯è®¿é—®çš„åœ°å€
          }
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±è´¥:", error);
        }
      }

      // ---------- å¯ç”¨æ€§å°å¢å¼º ----------
      // è®© Enter å¿«é€Ÿæ·»åŠ è®¡åˆ’å’Œä»»åŠ¡
      $("#planTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addPlanBtn").click();
      });
      $("#taskTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addTaskBtn").click();
      });

      // Initialize the app when DOM is ready
      initializeApp();
    </script>
  </body>
</html>
