<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>“智谋”BI系统——数字孪生总控中心（H5）</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.4"></script>
    <style>
      /* 平滑过渡与可拖拽辅助 */
      .transition-base {
        transition: all 0.2s ease;
      }
      .drag-over {
        outline: 2px dashed #93c5fd;
        outline-offset: -8px;
      }
      /* 移动端滚动优化 */
      .scroll-area {
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- 顶栏 -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded bg-sky-500 flex items-center justify-center text-white font-bold">智</div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold">“智谋”BI系统——数字孪生总控中心</h1>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">当前视角</label>
            <select id="roleSelect" class="text-sm border border-slate-300 rounded px-2 py-1 bg-white">
              <option value="student">学生</option>
              <option value="teacher">教师</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <!-- 主布局 -->
    <div class="max-w-7xl mx-auto grid grid-cols-12 gap-4 px-4 sm:px-6 lg:px-8 py-4">
      <!-- 侧栏 -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <nav class="bg-white border border-slate-200 rounded-lg p-3 sticky top-20">
          <ul id="navList" class="space-y-1 text-sm">
            <li><button data-target="section-dashboard" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100 bg-sky-50 text-sky-700 font-medium">概览/BI</button></li>
            <li><button data-target="section-sim" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">虚拟仿真（Paracraft/Keepwork）</button></li>
            <li><button data-target="section-plan" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">学习路径与计划</button></li>
            <li><button data-target="section-projects" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">项目协作（任务看板）</button></li>
            <li><button data-target="section-feedback" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">实时指导与反馈</button></li>
            <li><button data-target="section-monitor" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">学习进度监控（教师）</button></li>
            <li><button data-target="section-materials" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">配套教材/资源</button></li>
            <li><button data-target="section-settings" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">集成设置（Keepwork/Paracraft）</button></li>
          </ul>
        </nav>
      </aside>

      <!-- 内容区 -->
      <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-6">
        <!-- 概览/BI -->
        <section id="section-dashboard" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">概览与数据洞察</h2>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">活跃学生</div>
              <div id="kpiStudents" class="text-2xl font-bold">0</div>
              <div class="text-xs text-emerald-600 mt-1">+ 今日新增 <span id="kpiNewStudents">0</span></div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">平均完成率</div>
              <div id="kpiCompletion" class="text-2xl font-bold">0%</div>
              <div class="text-xs text-sky-600 mt-1">学习计划推进</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">平均评分</div>
              <div id="kpiScore" class="text-2xl font-bold">0</div>
              <div class="text-xs text-amber-600 mt-1">最新测评均分</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">正在进行的团队项目</div>
              <div id="kpiProjects" class="text-2xl font-bold">0</div>
              <div class="text-xs text-fuchsia-600 mt-1">协作与任务分工</div>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="col-span-1 lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">7日学习活跃趋势</div>
                <button id="refreshChartsBtn" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">刷新</button>
              </div>
              <canvas id="lineChart" class="mt-2"></canvas>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium">完成率分布</div>
              <canvas id="doughnutChart" class="mt-2"></canvas>
            </div>
          </div>
        </section>

        <!-- 虚拟仿真（Paracraft/Keepwork） -->
        <section id="section-sim" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">虚拟仿真教学与实训</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">内嵌 Keepwork 课程/项目页</div>
              <div class="space-y-2">
                <input id="keepworkUrl" type="url" placeholder="粘贴 Keepwork 页面链接（如课程、项目或教材）" class="w-full border border-slate-300 rounded px-3 py-2" />
                <div class="flex gap-2">
                  <button id="embedKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">嵌入预览</button>
                  <a id="openKeepworkBtn" href="#" target="_blank" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">在新标签打开</a>
                </div>
                <div class="rounded border border-slate-200 overflow-hidden">
                  <iframe id="keepworkFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                </div>
                <p class="text-xs text-slate-500">如页面禁止跨域内嵌，请使用“在新标签打开”。</p>
              </div>
            </div>

            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">Paracraft 世界/场景</div>
              <div class="space-y-2">
                <input id="paracraftWebUrl" type="url" placeholder="可选：Paracraft 的 Web 预览链接（若有）" class="w-full border border-slate-300 rounded px-3 py-2" />
                <input id="paracraftDeepLinkTpl" type="text" placeholder="Paracraft 深链模板（如 paracraft://open?url={WORLD_URL}）" class="w-full border border-slate-300 rounded px-3 py-2" />
                <div class="flex gap-2">
                  <button id="embedParacraftBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">内嵌/预览</button>
                  <a id="openParacraftBtn" href="#" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">在 Paracraft 客户端打开</a>
                </div>
                <div class="rounded border border-slate-200 overflow-hidden">
                  <iframe id="paracraftFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                </div>
                <p class="text-xs text-slate-500">说明：若有 Paracraft Web 版/嵌入器，可直接 iframe；若需客户端，请配置“深链模板”，系统将调用本地客户端打开世界。</p>
              </div>
            </div>
          </div>
        </section>

        <!-- 学习路径与计划 -->
        <section id="section-plan" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">个性化学习路径与计划</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex flex-wrap items-end gap-2">
                <div class="grow">
                  <label class="text-xs text-slate-500">学习目标</label>
                  <input id="planTitle" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="例如：完成数字孪生基础建模" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">截止日期</label>
                  <input id="planDue" type="date" class="w-full border border-slate-300 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">难度</label>
                  <select id="planLevel" class="w-full border border-slate-300 rounded px-3 py-2">
                    <option value="入门">入门</option>
                    <option value="进阶">进阶</option>
                    <option value="高级">高级</option>
                  </select>
                </div>
                <button id="addPlanBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">添加</button>
              </div>
              <ul id="planList" class="mt-3 divide-y divide-slate-200"></ul>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">推荐路径（可选）</div>
              <div class="space-y-2 text-sm">
                <button data-tpl="基础入门" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">基础入门：认识数字孪生与Paracraft</button>
                <button data-tpl="建模实践" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">建模实践：从简单对象到场景搭建</button>
                <button data-tpl="协作项目" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">协作项目：团队分工与版本协作</button>
                <button data-tpl="综合实训" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">综合实训：从需求到成果展示</button>
              </div>
            </div>
          </div>
        </section>

        <!-- 项目协作（看板） -->
        <section id="section-projects" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">项目与团队协作（看板）</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <input id="taskTitle" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="新任务标题，如：搭建机房子系统模型" />
            <select id="taskAssignee" class="border border-slate-300 rounded px-3 py-2">
              <option value="">未指派</option>
            </select>
            <button id="addTaskBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">添加任务</button>
            <button id="exportBoardBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">导出JSON</button>
            <label class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 cursor-pointer">
              导入JSON
              <input id="importBoardFile" type="file" accept="application/json" class="hidden" />
            </label>
            <a id="keepworkProjectLink" class="ml-auto text-sm text-sky-700 underline hidden" target="_blank">打开 Keepwork 项目</a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">待办</div>
              <ul id="colTodo" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">进行中</div>
              <ul id="colDoing" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">已完成</div>
              <ul id="colDone" class="min-h-40 space-y-2"></ul>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-3">提示：拖拽任务以切换状态</p>
        </section>

        <!-- 实时指导与反馈 -->
        <section id="section-feedback" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">实时指导与反馈（教师/学生双端模拟）</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3 flex flex-col">
              <div id="chatLog" class="scroll-area flex-1 min-h-[240px] max-h-[360px] overflow-y-auto space-y-2">
                <!-- 消息气泡 -->
              </div>
              <div class="mt-3 flex items-end gap-2">
                <textarea id="chatInput" rows="2" class="border border-slate-300 rounded px-3 py-2 w-full" placeholder="输入问题或反馈..."></textarea>
                <button id="sendMsgBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">发送</button>
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="请分享当前世界的截图或录像。">请分享截图</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="你可以尝试复用模板并调整参数。">尝试复用模板</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="建议先完成‘基础建模’的前两个任务。">先完成前置任务</button>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">课堂状态</div>
              <div class="space-y-2 text-sm">
                <label class="flex items-center gap-2"><input id="liveIndicator" type="checkbox" class="accent-emerald-600" /> 开启“在线辅导”状态</label>
                <label class="flex items-center gap-2"><input id="autoTips" type="checkbox" class="accent-emerald-600" /> 智能提示（根据完成率）</label>
              </div>
              <hr class="my-2" />
              <div>
                <div class="text-sm font-medium mb-1">快速评价</div>
                <div class="flex flex-wrap gap-2">
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-emerald-100 text-emerald-700" data-text="👍 进步明显">👍 进步明显</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-amber-100 text-amber-700" data-text="🧭 注意按计划执行">🧭 注意按计划执行</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-fuchsia-100 text-fuchsia-700" data-text="🤝 团队协作佳">🤝 团队协作佳</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-rose-100 text-rose-700" data-text="📌 需改进命名规范">📌 需改进命名规范</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 学习进度监控（教师） -->
        <section id="section-monitor" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">学习进度监控（教师视角）</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <button id="syncFromKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">从 Keepwork 同步</button>
            <button id="addStudentBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">添加学生</button>
            <span class="text-xs text-slate-500">演示数据可编辑，支持导出CSV</span>
            <button id="exportCSVBtn" class="ml-auto px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">导出 CSV</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
              <thead class="bg-slate-50">
                <tr>
                  <th class="text-left px-3 py-2 border-b">姓名</th>
                  <th class="text-left px-3 py-2 border-b">完成率</th>
                  <th class="text-left px-3 py-2 border-b">评分</th>
                  <th class="text-left px-3 py-2 border-b">当前任务</th>
                  <th class="text-left px-3 py-2 border-b">操作</th>
                </tr>
              </thead>
              <tbody id="studentTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- 配套教材/资源 -->
        <section id="section-materials" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">配套教材与资源中心</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">教材（Keepwork/网页/PDF）</div>
              <input id="materialUrl" type="url" placeholder="粘贴教材URL（支持 Keepwork 或 PDF 链接）" class="w-full border border-slate-300 rounded px-3 py-2" />
              <div class="flex gap-2 mt-2">
                <button id="embedMaterialBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">嵌入预览</button>
                <a id="openMaterialBtn" target="_blank" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">新标签打开</a>
              </div>
              <div class="rounded border border-slate-200 overflow-hidden mt-2">
                <iframe id="materialFrame" class="w-full h-72 bg-slate-50" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">课程/实验清单</div>
              <ul id="materialList" class="space-y-2 text-sm">
                <!-- 动态填充 -->
              </ul>
              <div class="mt-2 flex gap-2">
                <input id="newMaterialTitle" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="资源标题" />
                <input id="newMaterialLink" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="资源链接" />
                <button id="addMaterialBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">添加</button>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">移动学习建议</div>
              <ul class="list-disc pl-5 text-sm space-y-1 text-slate-700">
                <li>利用碎片时间查看教材与任务进度</li>
                <li>在移动端直接打开 Keepwork 链接，随时浏览课程</li>
                <li>同步计划到日历，接收到期提醒</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- 集成设置 -->
        <section id="section-settings" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">集成设置（Keepwork / Paracraft）</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-200 p-3 space-y-2">
              <div class="text-sm font-medium">Keepwork</div>
              <input id="keepworkProjectUrl" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork 项目/课程URL（用于快速打开与看板跳转）" />
              <input id="keepworkApiBase" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork API Base（可选，示例：https://api.keepwork.com）" />
              <input id="keepworkToken" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="Keepwork API Token（可选，用于后端对接）" />
              <div class="flex gap-2">
                <button id="saveKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">保存</button>
                <button id="testKeepworkBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">连通性测试</button>
              </div>
              <p id="keepworkStatus" class="text-xs text-slate-500"></p>
            </div>
            <div class="rounded-lg border border-slate-200 p-3 space-y-2">
              <div class="text-sm font-medium">Paracraft</div>
              <input id="paracraftDeepLink" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="深链模板：paracraft://open?url={WORLD_URL}" />
              <input id="paracraftWorldUrl" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="默认 WORLD_URL（可与课程关联）" />
              <div class="flex gap-2">
                <button id="saveParacraftBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">保存</button>
                <button id="tryOpenParacraftBtn" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">尝试打开客户端</button>
              </div>
              <p class="text-xs text-slate-500">如需 Web 预览，请提供可内嵌的 URL；如需客户端，配置深链模板。</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6 text-xs text-slate-500">
      <hr class="my-4" />
      <p>温馨提示：与 Keepwork/Paracraft 的深度集成需配置实际链接、Token 与服务端接口。</p>
    </footer>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      // ---------- 本地存储与工具 ----------
      const LS = {
        get: async (k, d) => {
          try {
            const data = await sdk.personalPageStore.loadPageData("zhimo_system", k);
            return structuredClone(data ?? d);
          } catch (e) {
            console.warn("读取数据失败，使用默认值", e);
            return d;
          }
        },
        set: async (k, v) => {
          try {
            await sdk.personalPageStore.savePageData("zhimo_system", k, v);
          } catch (e) {
            console.warn("保存数据失败", e);
          }
        },
      };
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
      const fmtPercent = (n) => Math.round(n * 100) + "%";

      // ---------- 导航 ----------
      const sections = $$(".card");
      const navBtns = $$("#navList .nav-btn");
      function showSection(id) {
        sections.forEach((s) => s.classList.toggle("hidden", s.id !== id));
        navBtns.forEach((b) => {
          const active = b.dataset.target === id;
          b.classList.toggle("bg-sky-50", active);
          b.classList.toggle("text-sky-700", active);
          b.classList.toggle("font-medium", active);
        });
        LS.set("activeSection", id);
      }
      navBtns.forEach((b) => b.addEventListener("click", () => showSection(b.dataset.target)));

      // ---------- 角色切换 ----------
      const roleSelect = $("#roleSelect");
      roleSelect.addEventListener("change", () => {
        LS.set("role", roleSelect.value);
        renderRoleHints();
      });
      function renderRoleHints() {
        const isTeacher = roleSelect.value === "teacher";
        // 教师专用板块高亮提示
        $("#section-monitor").classList.toggle("ring-2", isTeacher);
        $("#section-monitor").classList.toggle("ring-amber-300", isTeacher);
      }

      // ---------- 概览/BI 图表 ----------
      let lineChart, doughnutChart;
      function rand(n, m) {
        return Math.floor(n + Math.random() * (m - n + 1));
      }
      function initCharts() {
        const ctx1 = $("#lineChart").getContext("2d");
        const ctx2 = $("#doughnutChart").getContext("2d");
        const labels = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];
        const data = labels.map(() => rand(20, 120));
        const completed = rand(30, 70);
        const partial = rand(10, 40);
        const notstarted = 100 - Math.min(95, completed + partial);

        if (lineChart) lineChart.destroy();
        if (doughnutChart) doughnutChart.destroy();

        lineChart = new Chart(ctx1, {
          type: "line",
          data: { labels, datasets: [{ label: "活跃度", data, borderColor: "#0ea5e9", backgroundColor: "rgba(14,165,233,.15)", tension: 0.3, fill: true }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
        });
        doughnutChart = new Chart(ctx2, {
          type: "doughnut",
          data: { labels: ["已完成", "进行中", "未开始"], datasets: [{ data: [completed, partial, notstarted], backgroundColor: ["#10b981", "#f59e0b", "#e5e7eb"] }] },
          options: { plugins: { legend: { position: "bottom" } } },
        });

        // KPI 更新（演示）
        $("#kpiStudents").textContent = rand(80, 180);
        $("#kpiNewStudents").textContent = rand(1, 8);
        const avgCompletion = Math.min(98, completed + partial * 0.5);
        $("#kpiCompletion").textContent = Math.round(avgCompletion) + "%";
        $("#kpiScore").textContent = rand(70, 92);
        $("#kpiProjects").textContent = rand(2, 8);
      }
      initCharts();
      $("#refreshChartsBtn").addEventListener("click", initCharts);

      // ---------- Keepwork 嵌入 ----------
      const keepworkUrl = $("#keepworkUrl");
      const keepworkFrame = $("#keepworkFrame");
      const openKeepworkBtn = $("#openKeepworkBtn");
      $("#embedKeepworkBtn").addEventListener("click", () => {
        const url = keepworkUrl.value.trim();
        if (!url) return alert("请填写 Keepwork 链接");
        keepworkFrame.src = url;
        openKeepworkBtn.href = url;
        LS.set("keepwork.lastUrl", url);
      });
      openKeepworkBtn.addEventListener("click", (e) => {
        const url = keepworkUrl.value.trim();
        if (!url) e.preventDefault();
      });

      // ---------- Paracraft 嵌入/深链 ----------
      const paracraftWebUrl = $("#paracraftWebUrl");
      const paracraftDeepLinkTpl = $("#paracraftDeepLinkTpl");
      const paracraftFrame = $("#paracraftFrame");
      const openParacraftBtn = $("#openParacraftBtn");

      function buildDeepLink(worldUrl, tpl) {
        return tpl.replace("{WORLD_URL}", encodeURIComponent(worldUrl));
      }
      $("#embedParacraftBtn").addEventListener("click", () => {
        const webUrl = paracraftWebUrl.value.trim();
        if (webUrl) {
          paracraftFrame.src = webUrl;
          LS.set("paracraft.webUrl", webUrl);
        } else {
          alert("请提供可内嵌的 Web 预览URL，或使用右侧“在客户端打开”。");
        }
      });
      openParacraftBtn.addEventListener("click", async (e) => {
        const tpl = paracraftDeepLinkTpl.value.trim() || (await LS.get("settings.paracraft.deepLink", ""));
        const world = paracraftWebUrl.value.trim() || (await LS.get("settings.paracraft.worldUrl", ""));
        if (!tpl || !world) {
          e.preventDefault();
          return alert("请在“集成设置”中配置深链模板与 WORLD_URL，或在此填写。");
        }
        const link = buildDeepLink(world, tpl);
        openParacraftBtn.href = link;
      });

      // ---------- 学习路径与计划 ----------
      let plans = [];
      function renderPlans() {
        // Ensure plans is an array
        if (!Array.isArray(plans)) {
          plans = [];
        }

        const root = $("#planList");
        root.innerHTML = "";
        plans.forEach((p, idx) => {
          const li = document.createElement("li");
          li.className = "py-2 flex items-center gap-3";
          li.innerHTML = `
          <input type="checkbox" class="accent-emerald-600 plan-done" data-id="${idx}" ${p.done ? "checked" : ""}/>
          <div class="grow">
            <div class="font-medium">${p.title || "未命名目标"} <span class="text-xs text-slate-500">· ${p.level || "入门"}</span></div>
            <div class="text-xs text-slate-500">截止：${p.due || "未设置"}</div>
          </div>
          <button data-id="${idx}" class="plan-edit text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">编辑</button>
          <button data-id="${idx}" class="plan-del text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">删除</button>
        `;
          root.appendChild(li);
        });
        LS.set("plans", plans);
      }
      $("#addPlanBtn").addEventListener("click", () => {
        const title = $("#planTitle").value.trim();
        const due = $("#planDue").value;
        const level = $("#planLevel").value;
        if (!title) return alert("请填写学习目标");
        plans.push({ title, due, level, done: false });
        $("#planTitle").value = "";
        renderPlans();
      });
      $("#planList").addEventListener("change", (e) => {
        if (e.target.classList.contains("plan-done")) {
          const idx = +e.target.dataset.id;
          plans[idx].done = e.target.checked;
          renderPlans();
        }
      });
      $("#planList").addEventListener("click", (e) => {
        if (e.target.classList.contains("plan-del")) {
          const idx = +e.target.dataset.id;
          plans.splice(idx, 1);
          renderPlans();
        }
        if (e.target.classList.contains("plan-edit")) {
          const idx = +e.target.dataset.id;
          const p = plans[idx];
          const title = prompt("学习目标", p.title);
          if (title === null) return;
          const due = prompt("截止日期（YYYY-MM-DD）", p.due);
          if (due === null) return;
          const level = prompt("难度（入门/进阶/高级）", p.level);
          if (level === null) return;
          plans[idx] = { ...p, title, due, level };
          renderPlans();
        }
      });
      $$(".tpl-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          plans.push({
            title: btn.dataset.tpl,
            due: "",
            level: ["入门", "进阶", "高级"][Math.floor(Math.random() * 3)],
            done: false,
          });
          renderPlans();
        })
      );
      // ---------- 看板 ----------
      let board = { todo: [], doing: [], done: [] };
      const cols = { todo: $("#colTodo"), doing: $("#colDoing"), done: $("#colDone") };
      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }
      function renderBoard() {
        // Ensure board has proper structure
        if (!board || typeof board !== "object") {
          board = { todo: [], doing: [], done: [] };
        }
        ["todo", "doing", "done"].forEach((col) => {
          if (!Array.isArray(board[col])) {
            board[col] = [];
          }
        });

        Object.values(cols).forEach((c) => (c.innerHTML = ""));
        ["todo", "doing", "done"].forEach((col) => {
          board[col].forEach((task) => {
            // Ensure task has an id
            if (!task.id) {
              task.id = uid();
            }
            const li = document.createElement("li");
            li.className = "draggable transition-base cursor-move p-3 rounded border border-slate-200 bg-white shadow-sm";
            li.draggable = true;
            li.dataset.id = task.id;
            li.dataset.col = col;
            li.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">${task.title}</div>
              <button class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 del-task">删除</button>
            </div>
            <div class="text-xs text-slate-500 mt-1">指派：${task.assignee || "未指派"}</div>
          `;
            cols[col].appendChild(li);
          });
        });
        LS.set("board", board);
      }
      function bindDnD() {
        $$(".draggable").forEach((el) => {
          el.addEventListener("dragstart", (e) => {
            const id = el.dataset.id;
            const from = el.dataset.col;
            if (id && from) {
              e.dataTransfer.setData("text/plain", JSON.stringify({ id, from }));
            } else {
              e.preventDefault(); // Prevent drag if data is invalid
            }
          });
        });
        Object.entries(cols).forEach(([col, ul]) => {
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            ul.classList.add("drag-over");
          });
          ul.addEventListener("dragleave", () => ul.classList.remove("drag-over"));
          ul.addEventListener("drop", (e) => {
            e.preventDefault();
            ul.classList.remove("drag-over");
            const dataString = e.dataTransfer.getData("text/plain");
            if (!dataString) return; // Guard against empty data
            try {
              const { id, from } = JSON.parse(dataString);
              if (from === col) return;
              const idx = board[from].findIndex((t) => t.id === id);
              if (idx === -1) return; // Guard against task not found
              const [task] = board[from].splice(idx, 1);
              board[col].push(task);
              renderBoard();
              bindDnD();
            } catch (error) {
              console.error("Error parsing drag data:", error);
            }
          });
          ul.addEventListener("click", (e) => {
            if (e.target.classList.contains("del-task")) {
              const li = e.target.closest("li");
              const id = li.dataset.id;
              const from = li.dataset.col;
              board[from] = board[from].filter((t) => t.id !== id);
              renderBoard();
              bindDnD();
            }
          });
        });
      }
      $("#addTaskBtn").addEventListener("click", () => {
        const title = $("#taskTitle").value.trim();
        const assignee = $("#taskAssignee").value.trim();
        if (!title) return alert("请输入任务标题");
        board.todo.push({ id: uid(), title, assignee });
        $("#taskTitle").value = "";
        renderBoard();
        bindDnD();
      });
      $("#exportBoardBtn").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(board, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "board.json";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#importBoardFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const importedBoard = JSON.parse(reader.result);
            // Validate the imported board structure
            if (importedBoard && typeof importedBoard === "object" && importedBoard.todo && importedBoard.doing && importedBoard.done) {
              // Ensure all tasks have IDs
              ["todo", "doing", "done"].forEach((col) => {
                if (Array.isArray(importedBoard[col])) {
                  importedBoard[col].forEach((task) => {
                    if (!task.id) {
                      task.id = uid();
                    }
                  });
                }
              });
              board = importedBoard;
              renderBoard();
              bindDnD();
            } else {
              alert("导入的 JSON 格式不正确");
            }
          } catch (error) {
            console.error("JSON parse error:", error);
            alert("JSON 解析失败");
          }
        };
        reader.readAsText(file);
      });
      // ---------- 协作成员（用于指派） ----------
      let roster = [];
      const assigneeSel = $("#taskAssignee");
      function renderRoster() {
        // Ensure roster is an array
        if (!Array.isArray(roster)) {
          roster = [];
        }
        assigneeSel.innerHTML = '<option value="">未指派</option>' + roster.map((n) => `<option>${n}</option>`).join("");
      }
      // ---------- 实时指导与反馈（本地模拟聊天） ----------
      let chat = [];
      function renderChat() {
        // Ensure chat is an array
        if (!Array.isArray(chat)) {
          chat = [];
        }

        const log = $("#chatLog");
        log.innerHTML = "";
        chat.forEach((msg) => {
          const wrap = document.createElement("div");
          const isTeacher = msg.role === "teacher";
          wrap.className = `max-w-[85%] ${isTeacher ? "ml-auto" : ""}`;
          wrap.innerHTML = `
          <div class="text-xs text-slate-500 mb-1">${isTeacher ? "教师" : "学生"} · ${new Date(msg.ts).toLocaleString()}</div>
          <div class="px-3 py-2 rounded ${isTeacher ? "bg-sky-600 text-white" : "bg-slate-100"}">${msg.text}</div>
        `;
          log.appendChild(wrap);
        });
        log.scrollTop = log.scrollHeight;
        LS.set("chat", chat);
      }
      $("#sendMsgBtn").addEventListener("click", () => {
        const text = $("#chatInput").value.trim();
        if (!text) return;
        chat.push({ role: roleSelect.value, text, ts: Date.now() });
        $("#chatInput").value = "";
        renderChat();
      });
      $$(".quick-reply").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: roleSelect.value, text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );
      $$(".badge-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: "teacher", text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );

      // 自动提示（根据完成率——取决于计划完成个数）
      function autoTipsMaybe() {
        if (!$("#autoTips").checked) return;
        const doneCount = plans.filter((p) => p.done).length;
        const total = Math.max(1, plans.length);
        const completion = doneCount / total;
        if (completion < 0.3 && Math.random() < 0.2) {
          chat.push({ role: "teacher", text: "提示：建议先完善基础任务，再进入复杂场景。", ts: Date.now() });
          renderChat();
        }
      }
      setInterval(autoTipsMaybe, 12000);
      // ---------- 进度监控（教师） ----------
      let students = [];
      function renderStudents() {
        // Ensure students is an array
        if (!Array.isArray(students)) {
          students = [];
        }

        const tb = $("#studentTbody");
        tb.innerHTML = "";
        students.forEach((s, i) => {
          const tr = document.createElement("tr");
          tr.className = "odd:bg-white even:bg-slate-50";
          tr.innerHTML = `
          <td class="px-3 py-2 border-b">${s.name}</td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="completion" type="range" min="0" max="1" step="0.01" value="${s.completion}" class="align-middle accent-sky-600">
            <span class="ml-2 text-xs">${fmtPercent(s.completion)}</span>
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="score" type="number" min="0" max="100" value="${s.score}" class="w-20 border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="task" type="text" value="${s.task}" class="w-full border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <button data-i="${i}" class="del-stu text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">删除</button>
          </td>
        `;
          tb.appendChild(tr);
        });
        LS.set("students", students);
      }
      $("#studentTbody").addEventListener("input", (e) => {
        const i = e.target.dataset.i;
        const k = e.target.dataset.k;
        if (k === "completion") {
          students[i][k] = +e.target.value;
          // 更新同列文本
          e.target.parentElement.querySelector("span").textContent = fmtPercent(students[i][k]);
        } else if (k) {
          students[i][k] = k === "score" ? +e.target.value : e.target.value;
        }
        LS.set("students", students);
      });
      $("#studentTbody").addEventListener("click", (e) => {
        if (e.target.classList.contains("del-stu")) {
          const i = +e.target.dataset.i;
          students.splice(i, 1);
          renderStudents();
        }
      });
      $("#addStudentBtn").addEventListener("click", () => {
        const name = prompt("学生姓名");
        if (!name) return;
        students.push({ name, completion: 0, score: 0, task: "" });
        roster.push(name);
        LS.set("roster", roster);
        renderRoster();
        renderStudents();
      });
      $("#exportCSVBtn").addEventListener("click", () => {
        const lines = [["姓名", "完成率", "评分", "当前任务"], ...students.map((s) => [s.name, s.completion, s.score, `"${s.task.replace(/"/g, '""')}"`])];
        const csv = lines.map((r) => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "students.csv";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#syncFromKeepworkBtn").addEventListener("click", async () => {
        // 提示：实际对接应调用服务端或 Keepwork API。这里做连通性演示。
        const base = $("#keepworkApiBase").value.trim() || (await LS.get("settings.keepwork.apiBase", ""));
        if (!base) return alert("请在“集成设置”中提供 Keepwork API Base");
        try {
          // 简单HEAD请求测试可达性（避免CORS错误无法捕捉时的误判）
          const res = await fetch(base, { method: "HEAD", mode: "no-cors" });
          alert("已尝试连接 Keepwork API（浏览器可能因 CORS 不返回详细信息）。实际同步需服务端代理。");
        } catch (e) {
          alert("连接失败：" + e.message);
        }
      });
      // ---------- 教材/资源 ----------
      let materials = [];
      function renderMaterials() {
        // Ensure materials is an array
        if (!Array.isArray(materials)) {
          materials = [];
        }

        const ul = $("#materialList");
        ul.innerHTML = "";
        materials.forEach((m, i) => {
          const li = document.createElement("li");
          li.className = "flex items-center gap-2";
          li.innerHTML = `
          <a class="text-sky-700 underline" href="${m.link || "#"}" target="_blank">${m.title}</a>
          <button data-i="${i}" class="mat-embed text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">在左侧预览</button>
          <button data-i="${i}" class="mat-del text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">删除</button>
        `;
          ul.appendChild(li);
        });
        LS.set("materials", materials);
      }
      $("#addMaterialBtn").addEventListener("click", () => {
        const title = $("#newMaterialTitle").value.trim();
        const link = $("#newMaterialLink").value.trim();
        if (!title || !link) return alert("请输入资源标题与链接");
        materials.push({ title, link });
        $("#newMaterialTitle").value = "";
        $("#newMaterialLink").value = "";
        renderMaterials();
      });
      $("#materialList").addEventListener("click", (e) => {
        if (e.target.classList.contains("mat-embed")) {
          const m = materials[+e.target.dataset.i];
          $("#materialUrl").value = m.link;
          $("#materialFrame").src = m.link;
          $("#openMaterialBtn").href = m.link;
        }
        if (e.target.classList.contains("mat-del")) {
          materials.splice(+e.target.dataset.i, 1);
          renderMaterials();
        }
      });
      renderMaterials();
      // 嵌入
      $("#embedMaterialBtn").addEventListener("click", () => {
        const url = $("#materialUrl").value.trim();
        if (!url) return alert("请输入教材URL");
        $("#materialFrame").src = url;
        $("#openMaterialBtn").href = url;
      }); // ---------- 设置保存/测试 ----------
      // Keepwork
      const keepworkProjectLink = $("#keepworkProjectLink");
      async function refreshKeepworkProjectLink() {
        const url = await LS.get("settings.keepwork.projectUrl", "");
        if (url) {
          keepworkProjectLink.href = url;
          keepworkProjectLink.classList.remove("hidden");
        } else {
          keepworkProjectLink.classList.add("hidden");
        }
      }
      async function saveKeepworkSettings() {
        const projectUrl = $("#keepworkProjectUrl").value.trim();
        const apiBase = $("#keepworkApiBase").value.trim();
        const token = $("#keepworkToken").value.trim();
        await LS.set("settings.keepwork.projectUrl", projectUrl);
        await LS.set("settings.keepwork.apiBase", apiBase);
        await LS.set("settings.keepwork.token", token);
        $("#keepworkStatus").textContent = "已保存。";
        await refreshKeepworkProjectLink();
      }
      $("#saveKeepworkBtn").addEventListener("click", saveKeepworkSettings);
      $("#testKeepworkBtn").addEventListener("click", async () => {
        const base = $("#keepworkApiBase").value.trim();
        if (!base) return alert("请先填写 Keepwork API Base");
        $("#keepworkStatus").textContent = "测试中...";
        try {
          // 仅测试可达性；实际API需要带Token并由服务端代理以避免泄漏
          await fetch(base, { method: "HEAD", mode: "no-cors" });
          $("#keepworkStatus").textContent = "已尝试连接（如受CORS限制，结果以实际后端为准）。";
        } catch (e) {
          $("#keepworkStatus").textContent = "连接失败：" + e.message;
        }
      }); // Remove immediate sync calls - data will be loaded in initializeApp()// Paracraft
      async function saveParacraftSettings() {
        const deepLink = $("#paracraftDeepLink").value.trim();
        const worldUrl = $("#paracraftWorldUrl").value.trim();
        await LS.set("settings.paracraft.deepLink", deepLink);
        await LS.set("settings.paracraft.worldUrl", worldUrl);
        $("#paracraftDeepLinkTpl").value = deepLink; // 同步到仿真区
        alert("Paracraft 配置已保存");
      }
      $("#saveParacraftBtn").addEventListener("click", saveParacraftSettings);
      $("#tryOpenParacraftBtn").addEventListener("click", async () => {
        const deepLink = $("#paracraftDeepLink").value.trim();
        const worldUrl = $("#paracraftWorldUrl").value.trim();
        if (!deepLink || !worldUrl) return alert("请先填写深链模板与 WORLD_URL");
        const href = buildDeepLink(worldUrl, deepLink);
        location.href = href; // 尝试调起客户端
      }); // Remove immediate sync calls - data will be loaded in initializeApp()      // Remove immediate sync calls - data will be loaded in initializeApp()// ---------- 异步初始化应用 ----------
      async function initializeApp() {
        try {
          // Load all data asynchronously
          const activeSection = await LS.get("activeSection", "section-dashboard");
          const role = await LS.get("role", "student");
          const keepworkLastUrl = await LS.get("keepwork.lastUrl", "");
          const paracraftWebUrlValue = await LS.get("paracraft.webUrl", "");
          const paracraftDeepLinkValue = await LS.get("settings.paracraft.deepLink", "");

          plans = await LS.get("plans", []);
          board = await LS.get("board", { todo: [], doing: [], done: [] });
          roster = await LS.get("roster", ["张三", "李四", "王五", "赵六"]);
          chat = await LS.get("chat", []);
          students = await LS.get("students", [
            { name: "张三", completion: 0.4, score: 78, task: "导入示例世界并运行" },
            { name: "李四", completion: 0.7, score: 86, task: "搭建基础场景" },
            { name: "王五", completion: 0.2, score: 65, task: "学习建模规范" },
          ]);
          materials = await LS.get("materials", [
            { title: "课程大纲（Keepwork）", link: "" },
            { title: "实验指导书（PDF）", link: "" },
          ]);

          // Set up UI with loaded data
          showSection(activeSection);
          roleSelect.value = role;
          renderRoleHints();

          keepworkUrl.value = keepworkLastUrl;
          paracraftWebUrl.value = paracraftWebUrlValue;
          paracraftDeepLinkTpl.value = paracraftDeepLinkValue;

          // Fill settings
          $("#keepworkProjectUrl").value = await LS.get("settings.keepwork.projectUrl", "");
          $("#keepworkApiBase").value = await LS.get("settings.keepwork.apiBase", "");
          $("#keepworkToken").value = await LS.get("settings.keepwork.token", "");
          $("#paracraftDeepLink").value = await LS.get("settings.paracraft.deepLink", "");
          $("#paracraftWorldUrl").value = await LS.get("settings.paracraft.worldUrl", "");

          // Render all components
          renderPlans();
          renderBoard();
          bindDnD();
          renderRoster();
          renderChat();
          renderStudents();
          renderMaterials();
          refreshKeepworkProjectLink();

          // Check if first time and seed if needed
          const isSeeded = await LS.get("init.seeded", false);
          if (!isSeeded) {
            await LS.set("init.seeded", true);
            // 可在此放置机构内网可访问的地址
          }
        } catch (error) {
          console.error("初始化失败:", error);
        }
      }

      // ---------- 可用性小增强 ----------
      // 让 Enter 快速添加计划和任务
      $("#planTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addPlanBtn").click();
      });
      $("#taskTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addTaskBtn").click();
      });

      // Initialize the app when DOM is ready
      initializeApp();
    </script>
  </body>
</html>
