<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>“智谋”BI系统——数字孪生总控中心（H5）</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.4"></script>
    <style>
      /* 平滑过渡与可拖拽辅助 */
      .transition-base {
        transition: all 0.2s ease;
      }
      .drag-over {
        outline: 2px dashed #93c5fd;
        outline-offset: -8px;
      }
      /* 移动端滚动优化 */
      .scroll-area {
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- 顶栏 -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded bg-sky-500 flex items-center justify-center text-white font-bold">智</div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold">“智谋”BI系统——数字孪生总控中心</h1>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">当前视角</label>
            <select id="roleSelect" class="text-sm border border-slate-300 rounded px-2 py-1 bg-white">
              <option value="student">学生</option>
              <option value="teacher">教师</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <!-- 主布局 -->
    <div class="max-w-7xl mx-auto grid grid-cols-12 gap-4 px-4 sm:px-6 lg:px-8 py-4">
      <!-- 侧栏 -->
      <aside class="col-span-12 md:col-span-3 lg:col-span-2">
        <nav class="bg-white border border-slate-200 rounded-lg p-3 sticky top-20">
          <ul id="navList" class="space-y-1 text-sm">
            <li><button data-target="section-dashboard" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100 bg-sky-50 text-sky-700 font-medium">概览/BI</button></li>
            <li><button data-target="section-plan" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">学习路径与计划</button></li>
            <li><button data-target="section-projects" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">项目协作（任务看板）</button></li>
            <li><button data-target="section-feedback" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">实时指导与反馈</button></li>
            <li><button data-target="section-monitor" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">学习进度监控（教师）</button></li>
            <li><button data-target="section-settings" class="nav-btn w-full text-left px-3 py-2 rounded hover:bg-slate-100">3D虚拟仿真集成</button></li>
            <div id="integratedPagesList" class="ml-6 space-y-1">
              <!-- 动态生成的集成页面列表 -->
            </div>
          </ul>
        </nav>
      </aside>

      <!-- 内容区 -->
      <main class="col-span-12 md:col-span-9 lg:col-span-10">
        <!-- 概览/BI -->
        <section id="section-dashboard" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">概览与数据洞察</h2>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">活跃学生</div>
              <div id="kpiStudents" class="text-2xl font-bold">0</div>
              <div class="text-xs text-emerald-600 mt-1">+ 今日新增 <span id="kpiNewStudents">0</span></div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">平均完成率</div>
              <div id="kpiCompletion" class="text-2xl font-bold">0%</div>
              <div class="text-xs text-sky-600 mt-1">学习计划推进</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">平均评分</div>
              <div id="kpiScore" class="text-2xl font-bold">0</div>
              <div class="text-xs text-amber-600 mt-1">最新测评均分</div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-xs text-slate-500">正在进行的团队项目</div>
              <div id="kpiProjects" class="text-2xl font-bold">0</div>
              <div class="text-xs text-fuchsia-600 mt-1">协作与任务分工</div>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="col-span-1 lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">7日学习活跃趋势</div>
                <button id="refreshChartsBtn" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">刷新</button>
              </div>
              <canvas id="lineChart" class="mt-2"></canvas>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium">完成率分布</div>
              <canvas id="doughnutChart" class="mt-2"></canvas>
            </div>
          </div>
        </section>

        <!-- 学习路径与计划 -->
        <section id="section-plan" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">个性化学习路径与计划</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3">
              <div class="flex flex-wrap items-end gap-2">
                <div class="grow">
                  <label class="text-xs text-slate-500">学习目标</label>
                  <input id="planTitle" class="w-full border border-slate-300 rounded px-3 py-2" placeholder="例如：完成数字孪生基础建模" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">截止日期</label>
                  <input id="planDue" type="date" class="w-full border border-slate-300 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="text-xs text-slate-500">难度</label>
                  <select id="planLevel" class="w-full border border-slate-300 rounded px-3 py-2">
                    <option value="入门">入门</option>
                    <option value="进阶">进阶</option>
                    <option value="高级">高级</option>
                  </select>
                </div>
                <button id="addPlanBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">添加</button>
              </div>
              <ul id="planList" class="mt-3 divide-y divide-slate-200"></ul>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">推荐路径（可选）</div>
              <div class="space-y-2 text-sm">
                <button data-tpl="基础入门" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">基础入门：认识数字孪生与Paracraft</button>
                <button data-tpl="建模实践" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">建模实践：从简单对象到场景搭建</button>
                <button data-tpl="协作项目" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">协作项目：团队分工与版本协作</button>
                <button data-tpl="综合实训" class="tpl-btn w-full text-left px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">综合实训：从需求到成果展示</button>
              </div>
            </div>
          </div>
        </section>

        <!-- 项目协作（看板） -->
        <section id="section-projects" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">项目与团队协作（看板）</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <input id="taskTitle" class="border border-slate-300 rounded px-3 py-2 grow" placeholder="新任务标题，如：搭建机房子系统模型" />
            <select id="taskAssignee" class="border border-slate-300 rounded px-3 py-2">
              <option value="">未指派</option>
            </select>
            <button id="addTaskBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">添加任务</button>
            <button id="exportBoardBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">导出JSON</button>
            <label class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 cursor-pointer">
              导入JSON
              <input id="importBoardFile" type="file" accept="application/json" class="hidden" />
            </label>
            <a id="keepworkProjectLink" class="ml-auto text-sm text-sky-700 underline hidden" target="_blank">打开 Keepwork 项目</a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">待办</div>
              <ul id="colTodo" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">进行中</div>
              <ul id="colDoing" class="min-h-40 space-y-2"></ul>
            </div>
            <div class="col rounded-lg border border-slate-200 p-3">
              <div class="font-medium mb-2">已完成</div>
              <ul id="colDone" class="min-h-40 space-y-2"></ul>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-3">提示：拖拽任务以切换状态</p>
        </section>

        <!-- 实时指导与反馈 -->
        <section id="section-feedback" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">实时指导与反馈（教师/学生双端模拟）</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-lg border border-slate-200 p-3 flex flex-col">
              <div id="chatLog" class="scroll-area flex-1 min-h-[240px] max-h-[360px] overflow-y-auto space-y-2">
                <!-- 消息气泡 -->
              </div>
              <div class="mt-3 flex items-end gap-2">
                <textarea id="chatInput" rows="2" class="border border-slate-300 rounded px-3 py-2 w-full" placeholder="输入问题或反馈..."></textarea>
                <button id="sendMsgBtn" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">发送</button>
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="请分享当前世界的截图或录像。">请分享截图</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="你可以尝试复用模板并调整参数。">尝试复用模板</button>
                <button class="quick-reply px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" data-text="建议先完成‘基础建模’的前两个任务。">先完成前置任务</button>
              </div>
            </div>
            <div class="rounded-lg border border-slate-200 p-3">
              <div class="text-sm font-medium mb-2">课堂状态</div>
              <div class="space-y-2 text-sm">
                <label class="flex items-center gap-2"><input id="liveIndicator" type="checkbox" class="accent-emerald-600" /> 开启“在线辅导”状态</label>
                <label class="flex items-center gap-2"><input id="autoTips" type="checkbox" class="accent-emerald-600" /> 智能提示（根据完成率）</label>
              </div>
              <hr class="my-2" />
              <div>
                <div class="text-sm font-medium mb-1">快速评价</div>
                <div class="flex flex-wrap gap-2">
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-emerald-100 text-emerald-700" data-text="👍 进步明显">👍 进步明显</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-amber-100 text-amber-700" data-text="🧭 注意按计划执行">🧭 注意按计划执行</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-fuchsia-100 text-fuchsia-700" data-text="🤝 团队协作佳">🤝 团队协作佳</button>
                  <button class="badge-btn px-2 py-1 text-xs rounded bg-rose-100 text-rose-700" data-text="📌 需改进命名规范">📌 需改进命名规范</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 学习进度监控（教师） -->
        <section id="section-monitor" class="card bg-white border border-slate-200 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-3">学习进度监控（教师视角）</h2>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <button id="syncFromKeepworkBtn" class="px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">从 Keepwork 同步</button>
            <button id="addStudentBtn" class="px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">添加学生</button>
            <span class="text-xs text-slate-500">演示数据可编辑，支持导出CSV</span>
            <button id="exportCSVBtn" class="ml-auto px-3 py-2 rounded bg-slate-100 hover:bg-slate-200">导出 CSV</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
              <thead class="bg-slate-50">
                <tr>
                  <th class="text-left px-3 py-2 border-b">姓名</th>
                  <th class="text-left px-3 py-2 border-b">完成率</th>
                  <th class="text-left px-3 py-2 border-b">评分</th>
                  <th class="text-left px-3 py-2 border-b">当前任务</th>
                  <th class="text-left px-3 py-2 border-b">操作</th>
                </tr>
              </thead>
              <tbody id="studentTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- 3D虚拟仿真集成 -->
        <section id="section-settings" class="card bg-white border border-slate-200 rounded-lg p-4">
          <!-- 页面管理模式 -->
          <div id="pageManagementMode" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- 左侧：页面管理 -->
            <div class="lg:col-span-1 space-y-4">
              <div class="bg-white rounded border border-slate-200 p-4">
                <h3 class="font-semibold mb-3">页面管理</h3>

                <!-- 添加页面表单 -->
                <form id="addPageForm" class="mb-4 space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">页面名称</label>
                    <input type="text" name="name" class="w-full px-3 py-2 border border-slate-300 rounded text-sm" placeholder="例如: 3D建模平台" required />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">页面URL或paracraft项目ID</label>
                    <input type="text" name="url" class="w-full px-3 py-2 border border-slate-300 rounded text-sm" placeholder="https://example.com 或 项目ID" required />
                  </div>
                  <button type="submit" class="w-full px-3 py-2 bg-sky-600 text-white rounded text-sm hover:bg-sky-700">添加页面</button>
                </form>

                <!-- 页面列表 -->
                <div>
                  <div class="text-sm font-medium text-slate-700 mb-2">已添加的页面</div>
                  <div id="pagesList" class="space-y-2">
                    <!-- 动态生成页面列表 -->
                  </div>
                </div>
              </div>
            </div>

            <!-- 右侧：管理说明 -->
            <div class="lg:col-span-2">
              <div class="bg-white rounded border border-slate-200 p-6">
                <div class="text-center text-slate-500">
                  <div class="text-6xl mb-4">🛠️</div>
                  <div class="text-lg font-medium mb-2">页面管理中心</div>
                  <div class="text-sm mb-4">在这里添加和管理集成页面</div>
                  <div class="text-xs text-slate-400">要预览页面，请点击左侧边栏中的相应页面链接</div>
                </div>
              </div>
            </div>
          </div>
          <!-- 全屏预览模式 -->
          <div id="pagePreviewMode" class="hidden">
            <div class="bg-white rounded border border-slate-200" style="height: calc(100vh - 140px)">
              <div class="flex items-center justify-between p-3 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center gap-3">
                  <button id="backToManagement" class="px-3 py-1 text-sm bg-slate-600 text-white rounded hover:bg-slate-700">← 返回管理</button>
                  <h3 id="currentPageTitle" class="font-medium text-slate-700"></h3>
                </div>
                <a id="openInNewWindow" href="#" target="_blank" class="text-xs px-2 py-1 bg-sky-600 text-white rounded hover:bg-sky-700 transition-colors"> 在新窗口打开 </a>
              </div>
              <div class="w-full" style="height: calc(100% - 53px)">
                <iframe
                  id="fullScreenIframe"
                  class="w-full h-full border-0"
                  style="width: 100%; height: 100%"
                  onload="document.getElementById('pageLoadError').style.display = 'none';"
                  onerror="document.getElementById('pageLoadError').style.display = 'block';"
                >
                </iframe>
                <div id="pageLoadError" class="absolute inset-0 flex items-center justify-center bg-slate-50 text-slate-500 text-sm" style="display: none">
                  <div class="text-center">
                    <div class="text-4xl mb-2">🚫</div>
                    <div class="font-medium mb-1">页面加载失败</div>
                    <div class="text-xs mt-1">可能是网络问题或页面禁止嵌入</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6 text-xs text-slate-500">
      <hr class="my-4" />
      <p>温馨提示：与 Keepwork/Paracraft 的深度集成需配置实际链接、Token 与服务端接口。</p>
    </footer>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      // ---------- 本地存储与工具 ----------
      const LS = {
        get: async (k, d) => {
          try {
            const data = await sdk.personalPageStore.loadPageData("zhimo_system", k);
            return structuredClone(data ?? d);
          } catch (e) {
            console.warn("读取数据失败，使用默认值", e);
            return d;
          }
        },
        set: async (k, v) => {
          try {
            await sdk.personalPageStore.savePageData("zhimo_system", k, v);
          } catch (e) {
            console.warn("保存数据失败", e);
          }
        },
      };
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
      const fmtPercent = (n) => Math.round(n * 100) + "%";

      // ---------- 导航 ----------
      const sections = $$(".card");
      const navBtns = $$("#navList .nav-btn");
      function showSection(id) {
        sections.forEach((s) => s.classList.toggle("hidden", s.id !== id));
        navBtns.forEach((b) => {
          const active = b.dataset.target === id;
          b.classList.toggle("bg-sky-50", active);
          b.classList.toggle("text-sky-700", active);
          b.classList.toggle("font-medium", active);
        });
        LS.set("activeSection", id);
      }
      navBtns.forEach((b) => b.addEventListener("click", () => showSection(b.dataset.target)));

      // ---------- 角色切换 ----------
      const roleSelect = $("#roleSelect");
      roleSelect.addEventListener("change", () => {
        LS.set("role", roleSelect.value);
        renderRoleHints();
      });
      function renderRoleHints() {
        const isTeacher = roleSelect.value === "teacher";
        // 教师专用板块高亮提示
        $("#section-monitor").classList.toggle("ring-2", isTeacher);
        $("#section-monitor").classList.toggle("ring-amber-300", isTeacher);
      }

      // ---------- 概览/BI 图表 ----------
      let lineChart, doughnutChart;
      function rand(n, m) {
        return Math.floor(n + Math.random() * (m - n + 1));
      }
      function initCharts() {
        const ctx1 = $("#lineChart").getContext("2d");
        const ctx2 = $("#doughnutChart").getContext("2d");
        const labels = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];
        const data = labels.map(() => rand(20, 120));
        const completed = rand(30, 70);
        const partial = rand(10, 40);
        const notstarted = 100 - Math.min(95, completed + partial);

        if (lineChart) lineChart.destroy();
        if (doughnutChart) doughnutChart.destroy();

        lineChart = new Chart(ctx1, {
          type: "line",
          data: { labels, datasets: [{ label: "活跃度", data, borderColor: "#0ea5e9", backgroundColor: "rgba(14,165,233,.15)", tension: 0.3, fill: true }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
        });
        doughnutChart = new Chart(ctx2, {
          type: "doughnut",
          data: { labels: ["已完成", "进行中", "未开始"], datasets: [{ data: [completed, partial, notstarted], backgroundColor: ["#10b981", "#f59e0b", "#e5e7eb"] }] },
          options: { plugins: { legend: { position: "bottom" } } },
        });

        // KPI 更新（演示）
        $("#kpiStudents").textContent = rand(80, 180);
        $("#kpiNewStudents").textContent = rand(1, 8);
        const avgCompletion = Math.min(98, completed + partial * 0.5);
        $("#kpiCompletion").textContent = Math.round(avgCompletion) + "%";
        $("#kpiScore").textContent = rand(70, 92);
        $("#kpiProjects").textContent = rand(2, 8);
      }
      initCharts();
      $("#refreshChartsBtn").addEventListener("click", initCharts);

      // ---------- 学习路径与计划 ----------
      let plans = [];
      function renderPlans() {
        // Ensure plans is an array
        if (!Array.isArray(plans)) {
          plans = [];
        }

        const root = $("#planList");
        root.innerHTML = "";
        plans.forEach((p, idx) => {
          const li = document.createElement("li");
          li.className = "py-2 flex items-center gap-3";
          li.innerHTML = `
          <input type="checkbox" class="accent-emerald-600 plan-done" data-id="${idx}" ${p.done ? "checked" : ""}/>
          <div class="grow">
            <div class="font-medium">${p.title || "未命名目标"} <span class="text-xs text-slate-500">· ${p.level || "入门"}</span></div>
            <div class="text-xs text-slate-500">截止：${p.due || "未设置"}</div>
          </div>
          <button data-id="${idx}" class="plan-edit text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">编辑</button>
          <button data-id="${idx}" class="plan-del text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">删除</button>
        `;
          root.appendChild(li);
        });
        LS.set("plans", plans);
      }
      $("#addPlanBtn").addEventListener("click", () => {
        const title = $("#planTitle").value.trim();
        const due = $("#planDue").value;
        const level = $("#planLevel").value;
        if (!title) return alert("请填写学习目标");
        plans.push({ title, due, level, done: false });
        $("#planTitle").value = "";
        renderPlans();
      });
      $("#planList").addEventListener("change", (e) => {
        if (e.target.classList.contains("plan-done")) {
          const idx = +e.target.dataset.id;
          plans[idx].done = e.target.checked;
          renderPlans();
        }
      });
      $("#planList").addEventListener("click", (e) => {
        if (e.target.classList.contains("plan-del")) {
          const idx = +e.target.dataset.id;
          plans.splice(idx, 1);
          renderPlans();
        }
        if (e.target.classList.contains("plan-edit")) {
          const idx = +e.target.dataset.id;
          const p = plans[idx];
          const title = prompt("学习目标", p.title);
          if (title === null) return;
          const due = prompt("截止日期（YYYY-MM-DD）", p.due);
          if (due === null) return;
          const level = prompt("难度（入门/进阶/高级）", p.level);
          if (level === null) return;
          plans[idx] = { ...p, title, due, level };
          renderPlans();
        }
      });
      $$(".tpl-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          plans.push({
            title: btn.dataset.tpl,
            due: "",
            level: ["入门", "进阶", "高级"][Math.floor(Math.random() * 3)],
            done: false,
          });
          renderPlans();
        })
      );
      // ---------- 看板 ----------
      let board = { todo: [], doing: [], done: [] };
      const cols = { todo: $("#colTodo"), doing: $("#colDoing"), done: $("#colDone") };
      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }
      function renderBoard() {
        // Ensure board has proper structure
        if (!board || typeof board !== "object") {
          board = { todo: [], doing: [], done: [] };
        }
        ["todo", "doing", "done"].forEach((col) => {
          if (!Array.isArray(board[col])) {
            board[col] = [];
          }
        });

        Object.values(cols).forEach((c) => (c.innerHTML = ""));
        ["todo", "doing", "done"].forEach((col) => {
          board[col].forEach((task) => {
            // Ensure task has an id
            if (!task.id) {
              task.id = uid();
            }
            const li = document.createElement("li");
            li.className = "draggable transition-base cursor-move p-3 rounded border border-slate-200 bg-white shadow-sm";
            li.draggable = true;
            li.dataset.id = task.id;
            li.dataset.col = col;
            li.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">${task.title}</div>
              <button class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 del-task">删除</button>
            </div>
            <div class="text-xs text-slate-500 mt-1">指派：${task.assignee || "未指派"}</div>
          `;
            cols[col].appendChild(li);
          });
        });
        LS.set("board", board);
      }
      function bindDnD() {
        $$(".draggable").forEach((el) => {
          el.addEventListener("dragstart", (e) => {
            const id = el.dataset.id;
            const from = el.dataset.col;
            if (id && from) {
              e.dataTransfer.setData("text/plain", JSON.stringify({ id, from }));
            } else {
              e.preventDefault(); // Prevent drag if data is invalid
            }
          });
        });
        Object.entries(cols).forEach(([col, ul]) => {
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            ul.classList.add("drag-over");
          });
          ul.addEventListener("dragleave", () => ul.classList.remove("drag-over"));
          ul.addEventListener("drop", (e) => {
            e.preventDefault();
            ul.classList.remove("drag-over");
            const dataString = e.dataTransfer.getData("text/plain");
            if (!dataString) return; // Guard against empty data
            try {
              const { id, from } = JSON.parse(dataString);
              if (from === col) return;
              const idx = board[from].findIndex((t) => t.id === id);
              if (idx === -1) return; // Guard against task not found
              const [task] = board[from].splice(idx, 1);
              board[col].push(task);
              renderBoard();
              bindDnD();
            } catch (error) {
              console.error("Error parsing drag data:", error);
            }
          });
          ul.addEventListener("click", (e) => {
            if (e.target.classList.contains("del-task")) {
              const li = e.target.closest("li");
              const id = li.dataset.id;
              const from = li.dataset.col;
              board[from] = board[from].filter((t) => t.id !== id);
              renderBoard();
              bindDnD();
            }
          });
        });
      }
      $("#addTaskBtn").addEventListener("click", () => {
        const title = $("#taskTitle").value.trim();
        const assignee = $("#taskAssignee").value.trim();
        if (!title) return alert("请输入任务标题");
        board.todo.push({ id: uid(), title, assignee });
        $("#taskTitle").value = "";
        renderBoard();
        bindDnD();
      });
      $("#exportBoardBtn").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(board, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "board.json";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#importBoardFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const importedBoard = JSON.parse(reader.result);
            // Validate the imported board structure
            if (importedBoard && typeof importedBoard === "object" && importedBoard.todo && importedBoard.doing && importedBoard.done) {
              // Ensure all tasks have IDs
              ["todo", "doing", "done"].forEach((col) => {
                if (Array.isArray(importedBoard[col])) {
                  importedBoard[col].forEach((task) => {
                    if (!task.id) {
                      task.id = uid();
                    }
                  });
                }
              });
              board = importedBoard;
              renderBoard();
              bindDnD();
            } else {
              alert("导入的 JSON 格式不正确");
            }
          } catch (error) {
            console.error("JSON parse error:", error);
            alert("JSON 解析失败");
          }
        };
        reader.readAsText(file);
      });
      // ---------- 协作成员（用于指派） ----------
      let roster = [];
      const assigneeSel = $("#taskAssignee");
      function renderRoster() {
        // Ensure roster is an array
        if (!Array.isArray(roster)) {
          roster = [];
        }
        assigneeSel.innerHTML = '<option value="">未指派</option>' + roster.map((n) => `<option>${n}</option>`).join("");
      }
      // ---------- 实时指导与反馈（本地模拟聊天） ----------
      let chat = [];
      function renderChat() {
        // Ensure chat is an array
        if (!Array.isArray(chat)) {
          chat = [];
        }

        const log = $("#chatLog");
        log.innerHTML = "";
        chat.forEach((msg) => {
          const wrap = document.createElement("div");
          const isTeacher = msg.role === "teacher";
          wrap.className = `max-w-[85%] ${isTeacher ? "ml-auto" : ""}`;
          wrap.innerHTML = `
          <div class="text-xs text-slate-500 mb-1">${isTeacher ? "教师" : "学生"} · ${new Date(msg.ts).toLocaleString()}</div>
          <div class="px-3 py-2 rounded ${isTeacher ? "bg-sky-600 text-white" : "bg-slate-100"}">${msg.text}</div>
        `;
          log.appendChild(wrap);
        });
        log.scrollTop = log.scrollHeight;
        LS.set("chat", chat);
      }
      $("#sendMsgBtn").addEventListener("click", () => {
        const text = $("#chatInput").value.trim();
        if (!text) return;
        chat.push({ role: roleSelect.value, text, ts: Date.now() });
        $("#chatInput").value = "";
        renderChat();
      });
      $$(".quick-reply").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: roleSelect.value, text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );
      $$(".badge-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          chat.push({ role: "teacher", text: btn.dataset.text, ts: Date.now() });
          renderChat();
        })
      );

      // 自动提示（根据完成率——取决于计划完成个数）
      function autoTipsMaybe() {
        if (!$("#autoTips").checked) return;
        const doneCount = plans.filter((p) => p.done).length;
        const total = Math.max(1, plans.length);
        const completion = doneCount / total;
        if (completion < 0.3 && Math.random() < 0.2) {
          chat.push({ role: "teacher", text: "提示：建议先完善基础任务，再进入复杂场景。", ts: Date.now() });
          renderChat();
        }
      }
      setInterval(autoTipsMaybe, 12000);
      // ---------- 进度监控（教师） ----------
      let students = [];
      function renderStudents() {
        // Ensure students is an array
        if (!Array.isArray(students)) {
          students = [];
        }

        const tb = $("#studentTbody");
        tb.innerHTML = "";
        students.forEach((s, i) => {
          const tr = document.createElement("tr");
          tr.className = "odd:bg-white even:bg-slate-50";
          tr.innerHTML = `
          <td class="px-3 py-2 border-b">${s.name}</td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="completion" type="range" min="0" max="1" step="0.01" value="${s.completion}" class="align-middle accent-sky-600">
            <span class="ml-2 text-xs">${fmtPercent(s.completion)}</span>
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="score" type="number" min="0" max="100" value="${s.score}" class="w-20 border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <input data-i="${i}" data-k="task" type="text" value="${s.task}" class="w-full border border-slate-300 rounded px-2 py-1">
          </td>
          <td class="px-3 py-2 border-b">
            <button data-i="${i}" class="del-stu text-xs px-2 py-1 rounded bg-rose-50 text-rose-700 hover:bg-rose-100">删除</button>
          </td>
        `;
          tb.appendChild(tr);
        });
        LS.set("students", students);
      }
      $("#studentTbody").addEventListener("input", (e) => {
        const i = e.target.dataset.i;
        const k = e.target.dataset.k;
        if (k === "completion") {
          students[i][k] = +e.target.value;
          // 更新同列文本
          e.target.parentElement.querySelector("span").textContent = fmtPercent(students[i][k]);
        } else if (k) {
          students[i][k] = k === "score" ? +e.target.value : e.target.value;
        }
        LS.set("students", students);
      });
      $("#studentTbody").addEventListener("click", (e) => {
        if (e.target.classList.contains("del-stu")) {
          const i = +e.target.dataset.i;
          students.splice(i, 1);
          renderStudents();
        }
      });
      $("#addStudentBtn").addEventListener("click", () => {
        const name = prompt("学生姓名");
        if (!name) return;
        students.push({ name, completion: 0, score: 0, task: "" });
        roster.push(name);
        LS.set("roster", roster);
        renderRoster();
        renderStudents();
      });
      $("#exportCSVBtn").addEventListener("click", () => {
        const lines = [["姓名", "完成率", "评分", "当前任务"], ...students.map((s) => [s.name, s.completion, s.score, `"${s.task.replace(/"/g, '""')}"`])];
        const csv = lines.map((r) => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "students.csv";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });
      $("#syncFromKeepworkBtn").addEventListener("click", async () => {
        // 提示：实际对接应调用服务端或 Keepwork API。这里做连通性演示。
        const base = $("#keepworkApiBase").value.trim() || "https://api.keepwork.com";
        if (!base) return alert("请在“集成设置”中提供 Keepwork API Base");
        try {
          // 简单HEAD请求测试可达性（避免CORS错误无法捕捉时的误判）
          const res = await fetch(base, { method: "HEAD", mode: "no-cors" });
          alert("已尝试连接 Keepwork API（浏览器可能因 CORS 不返回详细信息）。实际同步需服务端代理。");
        } catch (e) {
          alert("连接失败：" + e.message);
        }
      });

      // ---------- 3D虚拟仿真集成 ----------
      // URL 验证辅助函数
      function isValidUrlOrProjectId(input) {
        // 检查是否为纯数字（项目ID）
        if (/^\d+$/.test(input.trim())) {
          return true;
        }

        // 检查是否为有效的URL
        try {
          new URL(input);
          return true;
        } catch (error) {
          return false;
        }
      }

      // 集成页面管理
      let integratedPages = [];
      let currentPageId = null;

      function initIntegrationsUI() {
        // 渲染页面列表
        renderIntegratedPages();

        // 只有在没有当前选中页面时才重置预览区域到默认状态
        if (!currentPageId) {
          resetPagePreview();
        }

        // 绑定添加页面表单
        const addPageForm = $("#addPageForm");
        if (addPageForm) {
          addPageForm.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get("name")?.trim();
            const url = formData.get("url")?.trim();
            if (!name || !url) {
              alert("请输入页面名称和URL");
              return;
            }

            // 验证URL格式或项目ID
            if (!isValidUrlOrProjectId(url)) {
              alert("请输入有效的URL格式（如 https://keepwork.com）或项目ID数字");
              return;
            }

            // 检查名称是否重复
            if (integratedPages.some((p) => p.name === name)) {
              alert("页面名称已存在，请使用不同的名称");
              return;
            }

            // 添加新页面
            const maxOrder = Math.max(...integratedPages.map((p) => p.order || 0), 0);
            integratedPages.push({
              id: crypto.randomUUID(),
              name: name,
              url: url,
              order: maxOrder + 1,
            });

            e.target.reset();
            saveIntegratedPages();
          };
        }

        // 绑定返回管理按钮
        const backToManagement = $("#backToManagement");
        if (backToManagement) {
          backToManagement.addEventListener("click", () => {
            resetPagePreview();
          });
        }
      }

      function renderIntegratedPages() {
        // 渲染页面管理列表
        const pagesList = $("#pagesList");
        if (!pagesList) return;

        const sortedPages = [...integratedPages].sort((a, b) => (a.order || 0) - (b.order || 0));

        pagesList.innerHTML = "";

        sortedPages.forEach((page, index) => {
          const pageItem = document.createElement("div");
          pageItem.className = "flex items-center gap-3 p-3 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors";
          pageItem.draggable = true;
          pageItem.dataset.pageId = page.id;

          pageItem.innerHTML = `
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${page.name}</div>
              <div class="text-xs text-slate-500 truncate">${page.url}</div>
            </div>
            <div class="flex items-center gap-1">
              <button class="p-1 hover:bg-slate-200 rounded text-slate-500" data-action="edit" data-page-id="${page.id}" title="编辑">
                ✏️
              </button>
              <button class="p-1 hover:bg-red-200 rounded text-red-600" data-action="delete" data-page-id="${page.id}" title="删除">
                🗑️
              </button>
            </div>
          `;

          // 拖拽排序
          pageItem.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", page.id);
          });

          pageItem.addEventListener("dragover", (e) => {
            e.preventDefault();
          });

          pageItem.addEventListener("drop", (e) => {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData("text/plain");
            if (draggedId !== page.id) {
              reorderPages(draggedId, page.id);
            }
          });

          pagesList.appendChild(pageItem);
        });

        // 绑定操作按钮
        pagesList.addEventListener("click", (e) => {
          if (e.target.dataset.action === "edit") {
            editPage(e.target.dataset.pageId);
          } else if (e.target.dataset.action === "delete") {
            deletePage(e.target.dataset.pageId);
          }
        });

        // 渲染侧边栏页面列表
        renderSidebarPageList();
      }

      function renderSidebarPageList() {
        const sidebarList = $("#integratedPagesList");

        const sortedPages = [...integratedPages].sort((a, b) => (a.order || 0) - (b.order || 0));

        if (sidebarList) {
          sidebarList.innerHTML = "";
          sortedPages.forEach((page) => {
            const pageBtn = document.createElement("button");
            pageBtn.className = "w-full flex items-center gap-2 px-3 py-1.5 rounded text-left hover:bg-slate-100 text-sm text-slate-600 sidebar-page-btn";
            pageBtn.dataset.pageId = page.id;
            pageBtn.innerHTML = `<span>🔗</span><span class="truncate">${page.name}</span>`;
            pageBtn.onclick = () => {
              showSection("section-settings");
              setTimeout(() => selectPage(page.id), 100);
            };
            sidebarList.appendChild(pageBtn);
          });
        }
      }

      function selectPage(pageId) {
        const page = integratedPages.find((p) => p.id === pageId);
        if (!page) return;

        currentPageId = pageId;

        // 切换到集成页面section
        showSection("section-settings");

        // 等待DOM更新后再设置预览模式
        setTimeout(() => {
          // 显示全屏预览模式，隐藏管理模式
          const managementMode = $("#pageManagementMode");
          const previewMode = $("#pagePreviewMode");
          const fullScreenIframe = $("#fullScreenIframe");
          const currentPageTitle = $("#currentPageTitle");
          const openInNewWindow = $("#openInNewWindow");

          if (managementMode) managementMode.style.display = "none";
          if (previewMode) previewMode.style.display = "block";

          if (fullScreenIframe) {
            // 检查URL是否为纯数字，如果是则转换为Paracraft项目链接
            const isNumeric = /^\d+$/.test(page.url.trim());
            fullScreenIframe.src = isNumeric ? `https://webparacraft.keepwork.com/?pid=${page.url.trim()}` : page.url;
          }
          if (currentPageTitle) {
            currentPageTitle.textContent = page.name;
          }
          if (openInNewWindow) {
            // 同样处理新窗口打开的链接
            const isNumeric = /^\d+$/.test(page.url.trim());
            openInNewWindow.href = isNumeric ? `https://webparacraft.keepwork.com/?pid=${page.url.trim()}` : page.url;
          }

          // 高亮侧边栏中的页面按钮
          document.querySelectorAll(".sidebar-page-btn").forEach((btn) => {
            btn.classList.remove("bg-slate-100");
          });

          const sidebarBtn = document.querySelector(`[data-page-id="${pageId}"].sidebar-page-btn`);
          if (sidebarBtn) {
            sidebarBtn.classList.add("bg-slate-100");
          }
        }, 50);

        saveIntegratedPages();
      }

      function resetPagePreview() {
        const managementMode = $("#pageManagementMode");
        const previewMode = $("#pagePreviewMode");
        const fullScreenIframe = $("#fullScreenIframe");

        // 显示管理模式，隐藏预览模式
        if (managementMode) managementMode.style.display = "grid";
        if (previewMode) previewMode.style.display = "none";

        // 清空iframe
        if (fullScreenIframe) {
          fullScreenIframe.src = "about:blank";
        }

        // 清除当前页面选择状态
        currentPageId = null;

        // 清除侧边栏页面按钮的高亮状态
        document.querySelectorAll(".sidebar-page-btn").forEach((btn) => {
          btn.classList.remove("bg-slate-100");
        });
      }

      function editPage(pageId) {
        const page = integratedPages.find((p) => p.id === pageId);
        if (!page) return;

        const newName = prompt("请输入页面名称:", page.name);
        if (newName === null) return;

        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("页面名称不能为空");
          return;
        }

        // 检查名称是否与其他页面重复
        if (trimmedName !== page.name && integratedPages.some((p) => p.name === trimmedName)) {
          alert("页面名称已存在，请使用不同的名称");
          return;
        }

        const newUrl = prompt("请输入页面URL:", page.url);
        if (newUrl === null) return;
        const trimmedUrl = newUrl.trim();
        if (!trimmedUrl) {
          alert("页面URL不能为空");
          return;
        }

        // 验证URL格式或项目ID
        if (!isValidUrlOrProjectId(trimmedUrl)) {
          alert("请输入有效的URL格式（如 https://example.com）或项目ID数字");
          return;
        }

        page.name = trimmedName;
        page.url = trimmedUrl;

        // 如果编辑的是当前选中的页面，需要更新预览
        if (currentPageId === pageId) {
          selectPage(pageId);
        }

        saveIntegratedPages();
      }

      function deletePage(pageId) {
        const page = integratedPages.find((p) => p.id === pageId);
        if (!page) return;

        if (confirm(`确定删除页面 "${page.name}"？`)) {
          integratedPages = integratedPages.filter((p) => p.id !== pageId);

          // 如果删除的是当前选中的页面，重置预览
          if (currentPageId === pageId) {
            currentPageId = null;
            resetPagePreview();
          }

          saveIntegratedPages();
        }
      }

      function reorderPages(draggedId, targetId) {
        const draggedIndex = integratedPages.findIndex((p) => p.id === draggedId);
        const targetIndex = integratedPages.findIndex((p) => p.id === targetId);

        if (draggedIndex === -1 || targetIndex === -1) return;

        // 重新排序
        const draggedPage = integratedPages[draggedIndex];
        integratedPages.splice(draggedIndex, 1);
        integratedPages.splice(targetIndex, 0, draggedPage);

        // 更新order字段
        integratedPages.forEach((page, index) => {
          page.order = index + 1;
        });

        saveIntegratedPages();
      }

      async function saveIntegratedPages() {
        await LS.set("integratedPages", integratedPages);
        await LS.set("currentPageId", currentPageId);
        renderIntegratedPages();
      } // ---------- 异步初始化应用 ----------
      async function initializeApp() {
        try {
          // Load all data asynchronously
          const activeSection = await LS.get("activeSection", "section-dashboard");
          const role = await LS.get("role", "student");
          const keepworkLastUrl = await LS.get("keepwork.lastUrl", "");
          const paracraftWebUrlValue = await LS.get("paracraft.webUrl", "");
          const paracraftDeepLinkValue = await LS.get("settings.paracraft.deepLink", "");

          plans = await LS.get("plans", []);
          board = await LS.get("board", { todo: [], doing: [], done: [] });
          roster = await LS.get("roster", ["张三", "李四", "王五", "赵六"]);
          chat = await LS.get("chat", []);
          students = await LS.get("students", [
            { name: "张三", completion: 0.4, score: 78, task: "导入示例世界并运行" },
            { name: "李四", completion: 0.7, score: 86, task: "搭建基础场景" },
            { name: "王五", completion: 0.2, score: 65, task: "学习建模规范" },
          ]);
          materials = await LS.get("materials", [
            { title: "课程大纲（Keepwork）", link: "" },
            { title: "实验指导书（PDF）", link: "" },
          ]);
          integratedPages = await LS.get("integratedPages", [
            { id: "page-1", name: "网站创作", url: "https://keepwork.com/ed", order: 1 },
            { id: "page-2", name: "3D世界创作", url: "https://webparacraft.keepwork.com", order: 2 },
            { id: "page-3", name: "文档中心", url: "https://keepwork.com/official/docs/UserGuide/keepwork/index", order: 3 },
            { id: "page-4", name: "虚拟仿真世界", url: "3468093", order: 4 },
          ]);
          currentPageId = await LS.get("currentPageId", null);

          // Set up UI with loaded data
          showSection(activeSection);
          roleSelect.value = role;
          renderRoleHints();

          // Render all components
          renderPlans();
          renderBoard();
          bindDnD();
          renderRoster();
          renderChat();
          renderStudents();
          
          // Initialize integrations UI
          initIntegrationsUI();

          // Check if first time and seed if needed
          const isSeeded = await LS.get("init.seeded", false);
          if (!isSeeded) {
            await LS.set("init.seeded", true);
            // 可在此放置机构内网可访问的地址
          }
        } catch (error) {
          console.error("初始化失败:", error);
        }
      }

      // ---------- 可用性小增强 ----------
      // 让 Enter 快速添加计划和任务
      $("#planTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addPlanBtn").click();
      });
      $("#taskTitle").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("#addTaskBtn").click();
      });

      // Initialize the app when DOM is ready
      initializeApp();
    </script>
  </body>
</html>
