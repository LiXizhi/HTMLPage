<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>学习能力评估</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.3"></script>
    <style>
      /* 确保全屏显示 */
      html,
      body {
        height: 100vh;
        overflow: hidden;
      }

      /* tab激活状态样式 - 重新设计为白色背景 */
      .tab-active {
        background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%);
        color: #8b5cf6;
        transform: translateX(8px);
        box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.8);
      }

      /* tab未选中状态 */
      .tab-inactive {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .tab-inactive:hover {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border-color: rgba(255, 255, 255, 0.4);
      }

      /* 图片容器样式 */
      .image-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        overflow: hidden;
      }

      /* 按钮hover效果 */
      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      /* 淡入动画 */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* 紫粉色渐变背景 */
      .purple-pink-gradient {
        background: linear-gradient(135deg, #f8e7ff 0%, #fde2f3 50%, #f3e8ff 100%);
      } /* 左侧纯紫色背景加投影 */
      .left-sidebar {
        background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
        box-shadow: 10px 0 30px rgba(139, 92, 246, 0.3);
      }

      /* Toast 样式 */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        animation: toastFadeIn 0.3s ease-in;
      }

      .toast.success {
        background: rgba(34, 197, 94, 0.9);
      }

      .toast.warning {
        background: rgba(245, 158, 11, 0.9);
      }

      .toast.error {
        background: rgba(239, 68, 68, 0.9);
      }

      @keyframes toastFadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      /* 按钮禁用状态 */
      .start-btn.disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .start-btn.disabled:hover {
        transform: none;
        box-shadow: none;
      } /* 奖励物品样式 - 改为水平布局，限制高度64px */
      .reward-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 8px 12px;
        background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 255, 255, 0.5);
        height: 52px;
        max-height: 52px;
        white-space: nowrap;
        overflow: hidden;
      }

      .reward-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
      }

      .reward-icon {
        font-size: 2rem;
        margin-right: 8px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        flex-shrink: 0;
      }

      .reward-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        min-width: 0;
        flex: 1;
      }

      .reward-name {
        font-weight: 600;
        color: #92400e;
        font-size: 1rem;
        line-height: 1.1;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .reward-count {
        font-size: 0.7rem;
        color: #b45309;
        background: rgba(255, 255, 255, 0.7);
        padding: 1px 6px;
        border-radius: 8px;
        margin-top: 2px;
        margin-left: 5px;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="purple-pink-gradient font-sans">
    <div class="flex h-full">
      <!-- 左侧Tab栏 - 20% -->
      <div class="w-1/5 left-sidebar flex flex-col p-6">
        <div class="space-y-4">
          <!-- Tab按钮将通过JavaScript动态生成 -->
          <div id="tabContainer" class="space-y-4"></div>
        </div>
      </div>

      <!-- 右侧内容区 - 80% -->
      <div class="w-4/5 purple-pink-gradient p-8 flex flex-col">
        <!-- 内容标题 -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <h2 id="contentTitle" class="text-3xl font-bold text-gray-800">记忆力</h2>
            <div class="flex gap-3">
              <button id="vipBtn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-yellow-500 hover:to-orange-600 transition-all duration-300">
                VIP会员无限制
              </button>
              <button id="offlineBtn" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-green-600 hover:to-teal-700 transition-all duration-300">
                线下测评报名
              </button>
            </div>
          </div>
          <p id="contentDesc" class="text-gray-600">评估您的记忆能力和记忆策略</p>
        </div>
        <!-- 游戏展示区域 -->
        <div id="gamesDisplay" class="mb-6">
          <div id="gamesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- 游戏卡片将通过JavaScript动态生成 -->
          </div>
        </div>
        <!-- 图片和按钮区域 -->
        <div class="flex-1 flex flex-col items-center justify-center">
          <div class="image-container w-full max-w-3xl mb-6 fade-in">
            <img id="contentImage" src="" alt="记忆力" class="w-full h-80 object-cover" />
          </div>

          <!-- 奖励展示区域 -->
          <div id="rewardDisplay" class="mb-5 w-full max-w-2xl">
            <div id="rewardItems" class="flex justify-center items-center gap-3 flex-wrap">
              <!-- 奖励物品将通过JavaScript动态生成 -->
            </div>
          </div>

          <div class="relative inline-block">
            <button
              id="startBtn"
              class="start-btn bg-gradient-to-r from-purple-600 to-blue-600 text-white px-12 py-4 rounded-full text-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              立即开始
            </button>
            <span id="rewardDot" class="absolute top-2 right-3 w-4 h-4 bg-red-500 rounded-full hidden"></span>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });

      // Toast 提示函数
      function showToast(message, type = "info", duration = 3000) {
        // 移除之前的 toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // 创建新的 toast
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // 自动移除
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.opacity = "0";
            setTimeout(() => {
              if (toast.parentNode) {
                toast.remove();
              }
            }, 300);
          }
        }, duration);
      } // 配置数据
      const assessmentConfig = [
        {
          id: 0,
          name: "vip",
          displayName: "报名砸金蛋",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46806/raw#敲金蛋.jpg",
          description: "报名成功，可立即参与砸金蛋活动",
          isFinished: true, // 默认完成，不用测评
          isGiftCollected: false,
          reward_items: [
            { icon: "🪶", name: "VIP飞行翅膀", count: 1 },
            { icon: "👑", name: "尊贵头衔", count: 1 },
            { icon: "✨", name: "脚底特效", count: 1 },
            { icon: "💖", name: "爱心特效", count: 1 },
          ],
        },
        {
          id: 1,
          name: "quality",
          displayName: "学习品质",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46802/raw#6-角色底部金色特效.jpg",
          description: "评估您的学习态度和品质特征",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "💎", name: "品质钻石戒指", count: 1 },
            { icon: "🛡️", name: "坚韧守护盾牌", count: 1 },
          ],
        },
        {
          id: 2,
          name: "cognitive",
          displayName: "认知能力",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46797/raw#1-大天使翅膀.jpg",
          description: "评估您的认知处理和思维能力",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "🧠", name: "智慧水晶头饰", count: 1 },
            { icon: "⚡", name: "思维闪电法杖", count: 1 },
          ],
        },
        {
          id: 3,
          name: "emotional",
          displayName: "情绪智力",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46803/raw#7-角色底部金色特效.jpg",
          description: "测试您的情绪管理和社交能力",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "💝", name: "情感共鸣手套", count: 1 },
            { icon: "🌈", name: "彩虹情绪面具", count: 1 },
          ],
        },
        {
          id: 4,
          name: "self_management",
          displayName: "自我管理",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46798/raw#2-恶魔翅膀.jpg",
          description: "评估您的自我控制和管理能力",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "👕", name: "专注蓝光套装", count: 1 },
            { icon: "🎯", name: "精准射手徽章", count: 1 },
          ],
        },
        {
          id: 5,
          name: "strategy",
          displayName: "学习策略",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46800/raw#4-银冠头饰新.jpg",
          description: "了解您的学习方法和策略偏好",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "📚", name: "策略大师披风", count: 1 },
            { icon: "🗺️", name: "学习路径指南针", count: 1 },
          ],
        },
        {
          id: 6,
          name: "motivation",
          displayName: "学习动机",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46801/raw#5-人物套装.jpg",
          description: "探索驱动您学习的内在动力",
          isFinished: true,
          isGiftCollected: false,
          reward_items: [
            { icon: "🔥", name: "激情火焰战靴", count: 1 },
            { icon: "⭐", name: "动力之星项链", count: 1 },
          ],
        },
        {
          id: 7,
          name: "interpersonal",
          displayName: "人际交往",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46799/raw#3-金冠头饰新.jpg",
          description: "评估您的人际沟通和交往能力",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "🤝", name: "友谊之桥徽章", count: 1 },
            { icon: "💬", name: "沟通大师勋章", count: 1 },
          ],
        },
        {
          id: 8,
          name: "motor_coordination",
          displayName: "运动协调",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46797/raw#1-大天使翅膀.jpg",
          description: "测试您的身体协调和运动能力",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "🏃", name: "运动健将套装", count: 1 },
            { icon: "⚽", name: "协调大师球鞋", count: 1 },
          ],
        },
      ];

      let currentTabId = 1;  // 默认返回第一个tab

      // 获取URL参数并初始化当前tab
      function getInitialTabFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabName = urlParams.get("tab");
        if (tabName) {
          const foundItem = assessmentConfig.find((item) => item.name === tabName);
          if (foundItem) {
            return foundItem.id;
          }
        }
        return currentTabId;
      } // 初始化页面
      function initPage() {
        currentTabId = getInitialTabFromURL();
        renderTabs();
        const initialItem = assessmentConfig.find((item) => item.id === currentTabId);
        updateContent(initialItem);
      } // 渲染Tab按钮
      function renderTabs() {
        const tabContainer = document.getElementById("tabContainer");

        assessmentConfig.forEach((item) => {
          const tabButton = document.createElement("button");
          tabButton.className = `w-full text-left p-4 rounded-lg transition-all duration-300 relative ${item.id === currentTabId ? "tab-active" : "tab-inactive"}`;

          // 构建按钮内容
          let buttonContent = `<div class="font-semibold text-base flex items-center">`;

          // 如果已完成，在文字前显示绿色对号
          if (item.isFinished) {
            buttonContent += `<span class="text-green-500 mr-2">✓</span>`;
          }

          buttonContent += `${item.displayName}</div>`;

          // 如果已完成但未领取奖励，在右上角显示红色小点
          if (item.isFinished && !item.isGiftCollected) {
            buttonContent += `<span class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full"></span>`;
          }

          tabButton.innerHTML = buttonContent;

          tabButton.addEventListener("click", () => {
            switchTab(item.id);
          });

          tabContainer.appendChild(tabButton);
        });
      } // 切换Tab
      function switchTab(tabId) {
        if (tabId === currentTabId) return;

        currentTabId = tabId;
        const selectedItem = assessmentConfig.find((item) => item.id === tabId);

        // 更新Tab样式
        updateTabStyles();

        // 更新内容
        updateContent(selectedItem);

        // 更新按钮状态
        updateUIBasedOnVipStatus();
      } 
      
      // 更新Tab样式
      function updateTabStyles() {
        const tabButtons = document.querySelectorAll("#tabContainer button");
        tabButtons.forEach((button, index) => {
          const item = assessmentConfig[index];
          if (item.id === currentTabId) {
            button.className = "w-full text-left p-4 rounded-lg transition-all duration-300 relative tab-active";
          } else {
            button.className = "w-full text-left p-4 rounded-lg transition-all duration-300 relative tab-inactive";
          }

          // 重新构建按钮内容
          let buttonContent = `<div class="font-semibold text-base flex items-center">`;

          // 如果已完成，在文字前显示绿色对号
          if (item.isFinished) {
            buttonContent += `<span class="text-green-500 mr-2">✓</span>`;
          }

          buttonContent += `${item.displayName}</div>`;

          // 如果已完成但未领取奖励，在右上角显示红色小点
          if (item.isFinished && !item.isGiftCollected) {
            buttonContent += `<span class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full"></span>`;
          }

          button.innerHTML = buttonContent;
        });
      } // 更新右侧内容
      function updateContent(item) {
        const contentTitle = document.getElementById("contentTitle");
        const contentDesc = document.getElementById("contentDesc");
        const contentImage = document.getElementById("contentImage");
        const rewardItems = document.getElementById("rewardItems");

        // 添加淡出效果
        contentTitle.style.opacity = "0";
        contentDesc.style.opacity = "0";
        contentImage.style.opacity = "0";
        rewardItems.style.opacity = "0";

        setTimeout(() => {
          contentTitle.style.color = "";

          if (item.isFinished && item.isGiftCollected) {
            contentTitle.textContent = `你已经领取过"${item.displayName}"的奖励了！`;
            contentTitle.style.color = "gray";
          } else if (item.name == "vip") {
            contentTitle.textContent = `${item.displayName}`;
            contentTitle.style.color = "green";
          } else if (item.isFinished && !item.isGiftCollected) {
            contentTitle.textContent = `恭喜！你已完成"${item.displayName}"的建模，快来领取奖励吧！`;
            contentTitle.style.color = "green";
          } else {
            contentTitle.textContent = `完成"${item.displayName}"训练后可领取奖励`;
          }

          // 根据VIP状态设置描述内容
          if (!item.isFinished && !sdk.isVip) {
            contentDesc.innerHTML = `
              <div class="text-gray-600 mb-3">${item.description}</div>
              <div class="text-orange-600 font-semibold">📋 你还没有报名，请先完成报名后再开始训练</div>
            `;
          } else {
            contentDesc.textContent = item.description;
          }

          // 只在需要时加载图片
          if (contentImage.src !== item.bg_url) {
            contentImage.src = item.bg_url;
          }
          contentImage.alt = item.displayName;

          // 更新奖励显示
          updateRewardDisplay(item.reward_items);

          // 更新游戏展示
          updateGamesDisplay(item.displayName);

          // 淡入效果
          contentTitle.style.opacity = "1";
          contentDesc.style.opacity = "1";
          contentImage.style.opacity = "1";
          rewardItems.style.opacity = "1";

          // 重新添加fade-in类
          contentImage.classList.remove("fade-in");
          setTimeout(() => contentImage.classList.add("fade-in"), 10);
        }, 200);
      } // 更新奖励显示函数
      function updateRewardDisplay(rewards) {
        const rewardItems = document.getElementById("rewardItems");
        rewardItems.innerHTML = "";

        if (rewards && rewards.length > 0) {
          rewards.forEach((reward) => {
            const rewardItem = document.createElement("div");
            rewardItem.className = "reward-item";

            rewardItem.innerHTML = `
              <div class="reward-icon">${reward.icon}</div>
              <div class="reward-text">
                <div class="reward-name">${reward.name}</div>
              </div>
              <div class="reward-count">x${reward.count}</div>
            `;

            rewardItems.appendChild(rewardItem);
          });
        } else {
          rewardItems.innerHTML = '<div class="text-gray-500">暂无奖励信息</div>';
        }
      }
      function CommitGame() {
        // Send game commit event to host with same data as gameFinished
        window.parent.postMessage(
          {
            type: "gameCommit",
            data: {
              score: sdk.isTestCompleted ? 100 : 0,
              earnedPoints: sdk.isTestCompleted ? 1000 : 0,
              finalProgress: sdk.isTestCompleted ? 100 : 0,
              isMaxDifficulty: true, // prevent selecting difficulty again
            },
          },
          "*"
        );
        console.log("CommitGame");
      }

      async function CollectGiftForTest(currentItem) {
        try {
          // 获取当前已收集的礼品列表
          let collectedGifts = await sdk.personalPageStore.loadPageData("maisi_test", "testGift");

          if (!collectedGifts || !Array.isArray(collectedGifts)) {
            collectedGifts = [];
          }

          // 如果当前项目的displayName不在列表中，则添加
          if (!collectedGifts.includes(currentItem.displayName)) {
            collectedGifts = [...collectedGifts];
            collectedGifts.push(currentItem.displayName);
            await sdk.personalPageStore.savePageData("maisi_test", "testGift", collectedGifts, true);
            console.log("已保存礼品数据:", collectedGifts);
          }
        } catch (error) {
          console.error("保存礼品数据失败:", error);
        }
        // 通知父窗口测评完成并传递奖励信息
        window.parent.postMessage(
          {
            type: "gameCommit",
            data: {
              score: 100,
              testName: currentItem.name,
              testDisplayName: currentItem.displayName, // "注意力", ...
              reward_items: currentItem.reward_items,
              isMaxDifficulty: true, // prevent selecting difficulty again
            },
          },
          "*"
        );
      }
      document.getElementById("startBtn").addEventListener("click", () => {
        const currentItem = assessmentConfig.find((item) => item.id === currentTabId);

        // 检查是否已报名（VIP状态）
        if (!currentItem.isFinished && !sdk.isVip) {
          // 未报名，跳转到报名页面
          const currentUrl = window.location.href;
          const signupUrl = currentUrl.replace("ms_games_test_reward", "ms_games_test_signup");
          window.location.replace(signupUrl);
        } else {
          // 已报名
          if (currentItem.isFinished) {
            if (currentItem.isGiftCollected) {
              // 已经领取过奖励
              showToast(`你已经领取过"${currentItem.displayName}"的奖励了！`, "warning");
            } else {
              // 可以领取奖励
              showToast(`恭喜！你已成功领取"${currentItem.displayName}"的奖励！`, "success");
              // 更新状态
              currentItem.isGiftCollected = true;
              // 重新渲染UI
              updateTabStyles();
              updateContent(currentItem);
              updateUIBasedOnVipStatus();

              // 保存已收集的礼品数据
              CollectGiftForTest(currentItem);
            }
          } else {
            // 未完成评估，开始评估
            const currentUrl = window.location.href;
            let maisiTestUrl = currentUrl.replace("ms_games_test_reward", "ms_games_test");

            if (sdk?.miniGameProxyData?.maisiToken) {
              const url = new URL(maisiTestUrl);
              url.searchParams.set("accessToken", sdk.miniGameProxyData.maisiToken);
              maisiTestUrl = url.toString();
            }
            window.location.replace(maisiTestUrl);
          }
        }
      }); // 加载已收集的礼品数据
      async function loadGiftData() {
        try {
          const collectedGifts = await sdk.personalPageStore.loadPageData("maisi_test", "testGift");
          if (collectedGifts && Array.isArray(collectedGifts)) {
            console.log("加载已收集的礼品:", collectedGifts);

            // 更新 assessmentConfig 中的 isGiftCollected 状态
            assessmentConfig.forEach((item) => {
              if (collectedGifts.includes(item.displayName)) {
                item.isGiftCollected = true;
              }
            });
          }
        } catch (error) {
          console.error("加载礼品数据失败:", error);
        }
      }

      // 初始化应用程序
      async function initializeApp() {
        await GetTestResultList();
        await loadGiftData(); // 加载礼品数据
        await fetchGameData(); // 加载游戏数据
        initPage();
        updateUIBasedOnVipStatus();

        window.parent.postMessage({ type: "gameLoaded" }, "*");

        setTimeout(() => {
          CommitGame();
        }, 1000);
      } // 根据VIP状态更新UI
      function updateUIBasedOnVipStatus() {
        const startBtn = document.getElementById("startBtn");
        const rewardDot = document.getElementById("rewardDot");
        const currentItem = assessmentConfig.find((item) => item.id === currentTabId);

        if (!currentItem.isFinished && !sdk.isVip) {
          // 非VIP用户显示未报名状态
          startBtn.textContent = "立即报名";
          rewardDot.classList.add("hidden");
        } else {
          // VIP用户根据完成状态显示不同按钮
          if (currentItem.isFinished) {
            if (currentItem.isGiftCollected) {
              startBtn.textContent = "你已经领取过";
              rewardDot.classList.add("hidden");
            } else {
              startBtn.textContent = "领取奖励";
              rewardDot.classList.remove("hidden");
            }
          } else {
            startBtn.textContent = "立即开始";
            rewardDot.classList.add("hidden");
          }
        }
      }

      async function GetTestResultList() {
        if (!sdk?.miniGameProxyData?.maisiToken) {
          if (window.location.hostname === "127.0.0.1") {
            sdk.miniGameProxyData = {
              maisiToken:
                "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0a2lkIjoiYmQ4MDljMmEtNTE3OC00OTMzLThmNzUtZTNlNmVhNjQzZjZmIiwidXNlcl9pZCI6IjIwOCIsInBob25lIjoiMTMwNjY5MzU3NzYiLCJleHAiOjE3NTczODMyODksInR5cGUiOiJhY2Nlc3MifQ.eT9cHazQmnPX9zcyaagjqZPFSeW-NIPUzI2KqD9CsGQ",
            };
          }
        }
        if (!sdk?.miniGameProxyData?.maisiToken) return null;
        const headers = {};
        headers["auth_token"] = `Bearer ${sdk?.miniGameProxyData?.maisiToken}`;
        headers["deviceType"] = 1; // pad
        try {
          const response = await fetch("https://api.maseai.com/srt/open/trialList", {
            headers: headers,
          });
          const data = await response.json();
          if (data.code === 200 && data.data) {
            console.log("用户测评信息:", data.data);

            // 更新 assessmentConfig 中的 isFinished 状态
            if (data.data.trialList && Array.isArray(data.data.trialList)) {
              data.data.trialList.forEach((trial) => {
                // 根据名称匹配找到对应的配置项
                const configItem = assessmentConfig.find((item) => item.displayName === trial.name);
                if (configItem) {
                  // 测评状态 0-完成，1-进行中，2-报告生成中，3-未开始
                  configItem.isFinished = trial.status === 0 || trial.status === 2;
                  // 如果有userReportId，说明已完成测评
                  if (trial.userReportId) {
                    configItem.isFinished = true;
                  }
                }
              });
            }

            return data.data;
          } else {
            console.error("API返回错误:", data);
          }
          return null;
        } catch (error) {
          console.error("获取测评信息失败:", error);
          return null;
        }
      } // 游戏数据相关变量
      let allGamesData = [];
      let gameCategories = [];

      // 能力分类与游戏名称的映射关系
      const abilityGameMapping = {
        "运动协调": ["手拉手", "单词迷宫大冒险", "单词贪吃蛇"],
        "学习品质": ["数字战士（数独）", "倒水游戏", "图形密码"],
        "认知能力": ["寻宝大师", "旋转音阶", "音乐记忆大师"],
        "情绪智力": ["一心多用", "西蒙说", "三心二意"],
        "自我管理": ["脑力双轨战", "数字复读机", "舒尔特方格"],
        "学习策略": ["逻辑拼图", "谁想吃什么", "心领神会"],
        "学习动机": ["影子骑士", "一一对应", "图形找茬"],
        "人际交往": ["和平使者", "单词魔方", "我说你选"]
      };

      // 获取游戏配置数据
      async function fetchGameData() {
        try {
          const response = await fetch(
            `https://api.keepwork.com/core/v0/repos/${encodeURIComponent('maisi/maisi')}/files/${encodeURIComponent(
              'maisi/maisi/webgames/data/todayRecommended_config'
            )}.md`
          );
          const configText = await response.text();
          gameCategories = parseGameConfig(configText);
          
          // 收集所有游戏
          allGamesData = [];
          gameCategories.forEach(category => {
            allGamesData.push(...category.games);
          });
          
          console.log('游戏数据加载成功:', allGamesData.length, '个游戏');
        } catch (error) {
          console.error('加载游戏配置失败:', error);
        }
      }

      // 解析游戏配置
      function parseGameConfig(configText) {
        const categories = [];
        const lines = configText.trim().split('\n');
        let currentCategory = null;
        let currentGame = null;

        for (let line of lines) {
          line = line.trim();
          if (line.startsWith('## ')) {
            currentCategory = {
              name: line.substring(3),
              games: []
            };
            categories.push(currentCategory);
          } else if (line.startsWith('### ')) {
            const gameTitle = line.substring(4);
            const emoji = gameTitle.split(' ')[0];
            const name = gameTitle.substring(emoji.length + 1);
            currentGame = {
              emoji: emoji,
              name: name,
              description: '',
              tags: [],
              url: '',
              isvip: false,
              gameName: ''
            };
            if (currentCategory) {
              currentCategory.games.push(currentGame);
            }
          } else if (line.startsWith('- desc:')) {
            if (currentGame) {
              currentGame.description = line.substring(7).trim();
            }
          } else if (line.startsWith('- tags:')) {
            if (currentGame) {
              const tagString = line.substring(7).trim();
              currentGame.tags = tagString.split(',').map(tag => tag.trim());
            }
          } else if (line.startsWith('- url:')) {
            if (currentGame) {
              currentGame.url = line.substring(6).trim();
            }
          } else if (line.startsWith('- isvip:')) {
            if (currentGame) {
              currentGame.isvip = line.substring(8).trim() === 'true';
            }
          } else if (line.startsWith('- gameName:')) {
            if (currentGame) {
              const gameName = line.substring(11).trim();
              currentGame.gameName = gameName || '';
              currentGame.isUnavailable = !gameName;
            }
          }
        }
        return categories;
      }

      // 根据能力分类获取相关游戏
      function getGamesByAbility(abilityName) {
        const gameNames = abilityGameMapping[abilityName] || [];
        const relatedGames = [];
        
        gameNames.forEach(gameName => {
          const foundGame = allGamesData.find(game => game.name === gameName);
          if (foundGame && !foundGame.isUnavailable) {
            relatedGames.push(foundGame);
          }
        });
        
        return relatedGames;
      }

      // 更新游戏展示
      function updateGamesDisplay(abilityName) {
        const gamesList = document.getElementById('gamesList');
        const relatedGames = getGamesByAbility(abilityName);
        
        if (relatedGames.length === 0) {
          gamesList.innerHTML = '<div class="col-span-full text-center text-gray-500"></div>';
          return;
        }
        
        gamesList.innerHTML = '';
        relatedGames.forEach(game => {
          const gameButton = document.createElement('button');
          
          // 根据VIP状态决定按钮的样式和交互
          const isDisabled = !sdk.isVip;
          const buttonClass = `px-4 py-2 rounded text-sm transition-colors border ${
            isDisabled 
              ? 'bg-gray-300 text-gray-500 border-gray-300 cursor-not-allowed' 
              : 'bg-blue-500 hover:bg-blue-600 text-white border-blue-500'
          }`;
          
          gameButton.className = buttonClass;
          gameButton.textContent = isDisabled ? `${game.name} (需要报名)` : game.name;
          
          // 只有已报名用户才能点击游戏
          if (!isDisabled) {
            gameButton.addEventListener('click', () => {
              openGame(game);
            });
          } else {
            gameButton.addEventListener('click', () => {
              showMessage('需要先报名才能开始游戏训练');
            });
          }
          
          gamesList.appendChild(gameButton);
        });
      }

      // 打开游戏
      function openGame(game) {
        if (!game.gameName || game.gameName.trim() === '' || game.isUnavailable) {
          showMessage('游戏内容解析失败，换个游戏试试吧！');
          return;
        }

        // 检查是否已报名（VIP状态）
        if (!sdk.isVip) {
          showMessage('需要先报名才能开始游戏训练');
          return;
        }

        showMessage('正在打开任务...');
        
        // 获取父窗口URL和参数
        const parentUrl = new URL(window.parent.location.href);
        const urlParams = new URLSearchParams(parentUrl.search);

        // 查找游戏数据，如果存在targetGameName则添加到URL参数中
        if (game.targetGameName) {
          urlParams.set('originalGameName', game.gameName);
          urlParams.set('gameName', game.targetGameName);
        } else {
          urlParams.set('gameName', game.gameName);
        }

        // 构建目标URL
        const targetUrl = `${parentUrl.origin}${parentUrl.pathname}?${urlParams.toString()}&startFrom=ms_games`;
        
        setTimeout(() => {
          window.parent.postMessage(
            {
              type: 'navigate',
              navigateType: 'openGame',
              url: targetUrl,
            },
            '*'
          );
        }, 500);
      }

      // 显示消息提示
      function showMessage(message) {
        // 创建或更新消息提示元素
        let messageEl = document.getElementById('gameMessage');
        if (!messageEl) {
          messageEl = document.createElement('div');
          messageEl.id = 'gameMessage';
          messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            transition: opacity 0.3s ease;
          `;
          document.body.appendChild(messageEl);
        }
        
        messageEl.textContent = message;
        messageEl.style.opacity = '1';
        
        // 3秒后自动隐藏
        setTimeout(() => {
          if (messageEl) {
            messageEl.style.opacity = '0';
            setTimeout(() => {
              if (messageEl && messageEl.parentNode) {
                messageEl.parentNode.removeChild(messageEl);
              }
            }, 300);
          }
        }, 3000);
      }
      function checkStartGame(timeoutMs) {
        if (!timeoutMs) {
          const urlParams = new URLSearchParams(window.location.search);
          timeoutMs = urlParams.get("parent") === "miniGameProxy" ? 3000 : 200;
        }

        let gameStarted = false;
        const waitForMinigameProxyWithTimeout = new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            if (!gameStarted) {
              resolve(null);
            }
          }, timeoutMs);

          let locationReceived = false;
          let miniGameProxyReceived = false;
          const messageHandler = function (e) {
            if (e.data.type === "locationResponse") {
              locationReceived = true;
              const searchPath = e.data.search;
              if (searchPath) {
                const params = new URLSearchParams(searchPath);
                const tabName = params.get("tab");
                if (tabName) {
                  const foundItem = assessmentConfig.find((item) => item.name === tabName);
                  if (foundItem) {
                    currentTabId = foundItem.id;
                  }
                }
              }
            } else if (e.data.type === "miniGameProxyDataResponse") {
              miniGameProxyReceived = true;
              sdk.token = e.data?.keepworkToken;
              sdk.isVip = e.data?.isVip;
              sdk.isTestCompleted = e.data?.isTestCompleted;
              sdk.isProfileCreated = e.data?.isProfileCreated;
              sdk.miniGameProxyData = e.data;
            }
            if (locationReceived && miniGameProxyReceived) {
              window.removeEventListener("message", messageHandler);
              clearTimeout(timeout);
              resolve(e.data);
            }
          };

          window.addEventListener("message", messageHandler);
          window.parent.postMessage({ type: "getLocation" }, "*");
          window.parent.postMessage({ type: "getMiniGameProxyData" }, "*");
        });

        waitForMinigameProxyWithTimeout
          .then(async () => {
            if (!gameStarted) {
              gameStarted = true;
              await initializeApp();
            }
          })
          .catch(async (error) => {
            if (!gameStarted) {
              gameStarted = true;
              await initializeApp();
            }
          });
      }

      // 按钮点击事件处理
      function setupButtonEvents() {
        // VIP会员按钮点击事件
        document.getElementById('vipBtn').addEventListener('click', () => {
          // 打开活动中心页面并自动选中VIP标签
          let url = 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/game_activities?type=vip';
          if (sdk.token) {
            url += `&token=${sdk.token}`;
          }
          window.parent.postMessage({
            type: 'navigate',
            navigateType: 'openGame',
            url: url
          }, '*');
        });

        // 线下测评报名按钮点击事件
        document.getElementById('offlineBtn').addEventListener('click', () => {
          // 打开VIP充值页面
          let url = 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/game_activities?type=mai_si_test';
          if (sdk.token) {
            url += `&token=${sdk.token}`;
          }
          window.parent.postMessage({
            type: 'navigate',
            navigateType: 'openGame',
            url: url,
          }, '*');
        });
      }

      // 启动游戏检查
      checkStartGame();
      
      // 设置按钮事件
      setupButtonEvents();
    </script>
  </body>
</html>