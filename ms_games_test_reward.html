<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å­¦ä¹ èƒ½åŠ›è¯„ä¼°</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.3"></script>
    <style>
      /* ç¡®ä¿å…¨å±æ˜¾ç¤º */
      html,
      body {
        height: 100vh;
        overflow: hidden;
      }

      /* tabæ¿€æ´»çŠ¶æ€æ ·å¼ - é‡æ–°è®¾è®¡ä¸ºç™½è‰²èƒŒæ™¯ */
      .tab-active {
        background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%);
        color: #8b5cf6;
        transform: translateX(8px);
        box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.8);
      }

      /* tabæœªé€‰ä¸­çŠ¶æ€ */
      .tab-inactive {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .tab-inactive:hover {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border-color: rgba(255, 255, 255, 0.4);
      }

      /* å›¾ç‰‡å®¹å™¨æ ·å¼ */
      .image-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        overflow: hidden;
      }

      /* æŒ‰é’®hoveræ•ˆæœ */
      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      /* æ·¡å…¥åŠ¨ç”» */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* ç´«ç²‰è‰²æ¸å˜èƒŒæ™¯ */
      .purple-pink-gradient {
        background: linear-gradient(135deg, #f8e7ff 0%, #fde2f3 50%, #f3e8ff 100%);
      } /* å·¦ä¾§çº¯ç´«è‰²èƒŒæ™¯åŠ æŠ•å½± */
      .left-sidebar {
        background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
        box-shadow: 10px 0 30px rgba(139, 92, 246, 0.3);
      }

      /* Toast æ ·å¼ */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        animation: toastFadeIn 0.3s ease-in;
      }

      .toast.success {
        background: rgba(34, 197, 94, 0.9);
      }

      .toast.warning {
        background: rgba(245, 158, 11, 0.9);
      }

      .toast.error {
        background: rgba(239, 68, 68, 0.9);
      }

      @keyframes toastFadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
      .start-btn.disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .start-btn.disabled:hover {
        transform: none;
        box-shadow: none;
      } /* å¥–åŠ±ç‰©å“æ ·å¼ - æ”¹ä¸ºæ°´å¹³å¸ƒå±€ï¼Œé™åˆ¶é«˜åº¦64px */
      .reward-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 8px 12px;
        background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 255, 255, 0.5);
        height: 52px;
        max-height: 52px;
        white-space: nowrap;
        overflow: hidden;
      }

      .reward-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
      }

      .reward-icon {
        font-size: 2rem;
        margin-right: 8px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        flex-shrink: 0;
      }

      .reward-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        min-width: 0;
        flex: 1;
      }

      .reward-name {
        font-weight: 600;
        color: #92400e;
        font-size: 1rem;
        line-height: 1.1;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .reward-count {
        font-size: 0.7rem;
        color: #b45309;
        background: rgba(255, 255, 255, 0.7);
        padding: 1px 6px;
        border-radius: 8px;
        margin-top: 2px;
        margin-left: 5px;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="purple-pink-gradient font-sans">
    <div class="flex h-full">
      <!-- å·¦ä¾§Tabæ  - 20% -->
      <div class="w-1/5 left-sidebar flex flex-col p-6">
        <div class="space-y-4">
          <!-- TabæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          <div id="tabContainer" class="space-y-4"></div>
        </div>
      </div>

      <!-- å³ä¾§å†…å®¹åŒº - 80% -->
      <div class="w-4/5 purple-pink-gradient p-8 flex flex-col">
        <!-- å†…å®¹æ ‡é¢˜ -->
        <div class="mb-6">
          <h2 id="contentTitle" class="text-3xl font-bold text-gray-800 mb-2">è®°å¿†åŠ›</h2>
          <p id="contentDesc" class="text-gray-600">è¯„ä¼°æ‚¨çš„è®°å¿†èƒ½åŠ›å’Œè®°å¿†ç­–ç•¥</p>
        </div>
        <!-- å›¾ç‰‡å’ŒæŒ‰é’®åŒºåŸŸ -->
        <div class="flex-1 flex flex-col items-center justify-center">
          <div class="image-container w-full max-w-3xl mb-6 fade-in">
            <img id="contentImage" src="" alt="è®°å¿†åŠ›" class="w-full h-80 object-cover" />
          </div>

          <!-- å¥–åŠ±å±•ç¤ºåŒºåŸŸ -->
          <div id="rewardDisplay" class="mb-5 w-full max-w-2xl">
            <div id="rewardItems" class="flex justify-center items-center gap-3 flex-wrap">
              <!-- å¥–åŠ±ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>

          <div class="relative inline-block">
            <button
              id="startBtn"
              class="start-btn bg-gradient-to-r from-purple-600 to-blue-600 text-white px-12 py-4 rounded-full text-lg font-semibold transition-all duration-300 transform hover:scale-105"
            >
              ç«‹å³å¼€å§‹
            </button>
            <span id="rewardDot" class="absolute top-2 right-3 w-4 h-4 bg-red-500 rounded-full hidden"></span>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });

      // Toast æç¤ºå‡½æ•°
      function showToast(message, type = "info", duration = 3000) {
        // ç§»é™¤ä¹‹å‰çš„ toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // åˆ›å»ºæ–°çš„ toast
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.opacity = "0";
            setTimeout(() => {
              if (toast.parentNode) {
                toast.remove();
              }
            }, 300);
          }
        }, duration);
      } // é…ç½®æ•°æ®
      const assessmentConfig = [
        {
          id: 0,
          name: "vip",
          displayName: "æŠ¥åç ¸é‡‘è›‹",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46806/raw#æ•²é‡‘è›‹.jpg",
          description: "æŠ¥åæˆåŠŸï¼Œå¯ç«‹å³å‚ä¸ç ¸é‡‘è›‹æ´»åŠ¨",
          isFinished: true, // é»˜è®¤å®Œæˆï¼Œä¸ç”¨æµ‹è¯„
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸª¶", name: "VIPé£è¡Œç¿…è†€", count: 1 },
            { icon: "ğŸ‘‘", name: "å°Šè´µå¤´è¡”", count: 1 },
            { icon: "âœ¨", name: "è„šåº•ç‰¹æ•ˆ", count: 1 },
            { icon: "ğŸ’–", name: "çˆ±å¿ƒç‰¹æ•ˆ", count: 1 },
          ],
        },
        {
          id: 1,
          name: "memory",
          displayName: "è®°å¿†åŠ›",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46797/raw#1-å¤§å¤©ä½¿ç¿…è†€.jpg",
          description: "è¯„ä¼°æ‚¨çš„è®°å¿†èƒ½åŠ›å’Œè®°å¿†ç­–ç•¥",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ¥»", name: "å›å¿†é“¶æ²™å¥—è£…", count: 1 },
            { icon: "ğŸª¶", name: "å¤§å¤©ä½¿ç™½è‰²ç¾½ç¿¼", count: 1 },
          ],
        },
        {
          id: 2,
          name: "attention",
          displayName: "æ³¨æ„åŠ›",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46798/raw#2-æ¶é­”ç¿…è†€.jpg",
          description: "æµ‹è¯•æ‚¨çš„ä¸“æ³¨åŠ›å’Œæ³¨æ„åŠ›åˆ†é…èƒ½åŠ›",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ‘•", name: "ä¸“æ³¨è“å…‰å¥—è£…", count: 1 },
            { icon: "ğŸ¯", name: "ç²¾å‡†å°„æ‰‹å¾½ç« ", count: 1 },
          ],
        },
        {
          id: 3,
          name: "thinking",
          displayName: "æ€ç»´èƒ½åŠ›",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46799/raw#3-é‡‘å† å¤´é¥°æ–°.jpg",
          description: "è¯„ä¼°æ‚¨çš„é€»è¾‘æ€ç»´å’Œé—®é¢˜è§£å†³èƒ½åŠ›",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ§ ", name: "æ™ºæ…§æ°´æ™¶å¤´é¥°", count: 1 },
            { icon: "âš¡", name: "æ€ç»´é—ªç”µæ³•æ–", count: 1 },
          ],
        },
        {
          id: 4,
          name: "strategy",
          displayName: "å­¦ä¹ ç­–ç•¥",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46800/raw#4-é“¶å† å¤´é¥°æ–°.jpg",
          description: "äº†è§£æ‚¨çš„å­¦ä¹ æ–¹æ³•å’Œç­–ç•¥åå¥½",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ“š", name: "ç­–ç•¥å¤§å¸ˆæŠ«é£", count: 1 },
            { icon: "ğŸ—ºï¸", name: "å­¦ä¹ è·¯å¾„æŒ‡å—é’ˆ", count: 1 },
          ],
        },
        {
          id: 5,
          name: "motivation",
          displayName: "å­¦ä¹ åŠ¨æœº",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46801/raw#5-äººç‰©å¥—è£….jpg",
          description: "æ¢ç´¢é©±åŠ¨æ‚¨å­¦ä¹ çš„å†…åœ¨åŠ¨åŠ›",
          isFinished: true,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ”¥", name: "æ¿€æƒ…ç«ç„°æˆ˜é´", count: 1 },
            { icon: "â­", name: "åŠ¨åŠ›ä¹‹æ˜Ÿé¡¹é“¾", count: 1 },
          ],
        },
        {
          id: 6,
          name: "quality",
          displayName: "å­¦ä¹ å“è´¨",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46802/raw#6-è§’è‰²åº•éƒ¨é‡‘è‰²ç‰¹æ•ˆ.jpg",
          description: "è¯„ä¼°æ‚¨çš„å­¦ä¹ æ€åº¦å’Œå“è´¨ç‰¹å¾",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ’", name: "å“è´¨é’»çŸ³æˆ’æŒ‡", count: 1 },
            { icon: "ğŸ›¡ï¸", name: "åšéŸ§å®ˆæŠ¤ç›¾ç‰Œ", count: 1 },
          ],
        },
        {
          id: 7,
          name: "emotional",
          displayName: "æƒ…ç»ªæ™ºåŠ›",
          bg_url: "https://api.keepwork.com/ts-storage/siteFiles/46803/raw#7-è§’è‰²åº•éƒ¨é‡‘è‰²ç‰¹æ•ˆ.jpg",
          description: "æµ‹è¯•æ‚¨çš„æƒ…ç»ªç®¡ç†å’Œç¤¾äº¤èƒ½åŠ›",
          isFinished: false,
          isGiftCollected: false,
          reward_items: [
            { icon: "ğŸ’", name: "æƒ…æ„Ÿå…±é¸£æ‰‹å¥—", count: 1 },
            { icon: "ğŸŒˆ", name: "å½©è™¹æƒ…ç»ªé¢å…·", count: 1 },
          ],
        },
      ];

      let currentTabId = 1;  // é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªtab

      // è·å–URLå‚æ•°å¹¶åˆå§‹åŒ–å½“å‰tab
      function getInitialTabFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabName = urlParams.get("tab");
        if (tabName) {
          const foundItem = assessmentConfig.find((item) => item.name === tabName);
          if (foundItem) {
            return foundItem.id;
          }
        }
        return currentTabId;
      } // åˆå§‹åŒ–é¡µé¢
      function initPage() {
        currentTabId = getInitialTabFromURL();
        renderTabs();
        const initialItem = assessmentConfig.find((item) => item.id === currentTabId);
        updateContent(initialItem);
      } // æ¸²æŸ“TabæŒ‰é’®
      function renderTabs() {
        const tabContainer = document.getElementById("tabContainer");

        assessmentConfig.forEach((item) => {
          const tabButton = document.createElement("button");
          tabButton.className = `w-full text-left p-4 rounded-lg transition-all duration-300 relative ${item.id === currentTabId ? "tab-active" : "tab-inactive"}`;

          // æ„å»ºæŒ‰é’®å†…å®¹
          let buttonContent = `<div class="font-semibold text-base flex items-center">`;

          // å¦‚æœå·²å®Œæˆï¼Œåœ¨æ–‡å­—å‰æ˜¾ç¤ºç»¿è‰²å¯¹å·
          if (item.isFinished) {
            buttonContent += `<span class="text-green-500 mr-2">âœ“</span>`;
          }

          buttonContent += `${item.displayName}</div>`;

          // å¦‚æœå·²å®Œæˆä½†æœªé¢†å–å¥–åŠ±ï¼Œåœ¨å³ä¸Šè§’æ˜¾ç¤ºçº¢è‰²å°ç‚¹
          if (item.isFinished && !item.isGiftCollected) {
            buttonContent += `<span class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full"></span>`;
          }

          tabButton.innerHTML = buttonContent;

          tabButton.addEventListener("click", () => {
            switchTab(item.id);
          });

          tabContainer.appendChild(tabButton);
        });
      } // åˆ‡æ¢Tab
      function switchTab(tabId) {
        if (tabId === currentTabId) return;

        currentTabId = tabId;
        const selectedItem = assessmentConfig.find((item) => item.id === tabId);

        // æ›´æ–°Tabæ ·å¼
        updateTabStyles();

        // æ›´æ–°å†…å®¹
        updateContent(selectedItem);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateUIBasedOnVipStatus();
      } 
      
      // æ›´æ–°Tabæ ·å¼
      function updateTabStyles() {
        const tabButtons = document.querySelectorAll("#tabContainer button");
        tabButtons.forEach((button, index) => {
          const item = assessmentConfig[index];
          if (item.id === currentTabId) {
            button.className = "w-full text-left p-4 rounded-lg transition-all duration-300 relative tab-active";
          } else {
            button.className = "w-full text-left p-4 rounded-lg transition-all duration-300 relative tab-inactive";
          }

          // é‡æ–°æ„å»ºæŒ‰é’®å†…å®¹
          let buttonContent = `<div class="font-semibold text-base flex items-center">`;

          // å¦‚æœå·²å®Œæˆï¼Œåœ¨æ–‡å­—å‰æ˜¾ç¤ºç»¿è‰²å¯¹å·
          if (item.isFinished) {
            buttonContent += `<span class="text-green-500 mr-2">âœ“</span>`;
          }

          buttonContent += `${item.displayName}</div>`;

          // å¦‚æœå·²å®Œæˆä½†æœªé¢†å–å¥–åŠ±ï¼Œåœ¨å³ä¸Šè§’æ˜¾ç¤ºçº¢è‰²å°ç‚¹
          if (item.isFinished && !item.isGiftCollected) {
            buttonContent += `<span class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full"></span>`;
          }

          button.innerHTML = buttonContent;
        });
      } // æ›´æ–°å³ä¾§å†…å®¹
      function updateContent(item) {
        const contentTitle = document.getElementById("contentTitle");
        const contentDesc = document.getElementById("contentDesc");
        const contentImage = document.getElementById("contentImage");
        const rewardItems = document.getElementById("rewardItems");

        // æ·»åŠ æ·¡å‡ºæ•ˆæœ
        contentTitle.style.opacity = "0";
        contentDesc.style.opacity = "0";
        contentImage.style.opacity = "0";
        rewardItems.style.opacity = "0";

        setTimeout(() => {
          contentTitle.style.color = "";

          if (item.isFinished && item.isGiftCollected) {
            contentTitle.textContent = `ä½ å·²ç»é¢†å–è¿‡"${item.displayName}"çš„å¥–åŠ±äº†ï¼`;
            contentTitle.style.color = "gray";
          } else if (item.name == "vip") {
            contentTitle.textContent = `${item.displayName}`;
            contentTitle.style.color = "green";
          } else if (item.isFinished && !item.isGiftCollected) {
            contentTitle.textContent = `æ­å–œï¼ä½ å·²å®Œæˆ"${item.displayName}"çš„å»ºæ¨¡ï¼Œå¿«æ¥é¢†å–å¥–åŠ±å§ï¼`;
            contentTitle.style.color = "green";
          } else {
            contentTitle.textContent = `å®Œæˆ"${item.displayName}"æµ‹è¯„åå¯é¢†å–å¥–åŠ±`;
          }

          // æ ¹æ®VIPçŠ¶æ€è®¾ç½®æè¿°å†…å®¹
          if (!item.isFinished && !sdk.isVip) {
            contentDesc.innerHTML = `
              <div class="text-gray-600 mb-3">${item.description}</div>
              <div class="text-orange-600 font-semibold">ğŸ“‹ ä½ è¿˜æ²¡æœ‰æŠ¥åï¼Œè¯·å…ˆå®ŒæˆæŠ¥ååå†å¼€å§‹è¯„ä¼°</div>
            `;
          } else {
            contentDesc.textContent = item.description;
          }

          // åªåœ¨éœ€è¦æ—¶åŠ è½½å›¾ç‰‡
          if (contentImage.src !== item.bg_url) {
            contentImage.src = item.bg_url;
          }
          contentImage.alt = item.displayName;

          // æ›´æ–°å¥–åŠ±æ˜¾ç¤º
          updateRewardDisplay(item.reward_items);

          // æ·¡å…¥æ•ˆæœ
          contentTitle.style.opacity = "1";
          contentDesc.style.opacity = "1";
          contentImage.style.opacity = "1";
          rewardItems.style.opacity = "1";

          // é‡æ–°æ·»åŠ fade-inç±»
          contentImage.classList.remove("fade-in");
          setTimeout(() => contentImage.classList.add("fade-in"), 10);
        }, 200);
      } // æ›´æ–°å¥–åŠ±æ˜¾ç¤ºå‡½æ•°
      function updateRewardDisplay(rewards) {
        const rewardItems = document.getElementById("rewardItems");
        rewardItems.innerHTML = "";

        if (rewards && rewards.length > 0) {
          rewards.forEach((reward) => {
            const rewardItem = document.createElement("div");
            rewardItem.className = "reward-item";

            rewardItem.innerHTML = `
              <div class="reward-icon">${reward.icon}</div>
              <div class="reward-text">
                <div class="reward-name">${reward.name}</div>
              </div>
              <div class="reward-count">x${reward.count}</div>
            `;

            rewardItems.appendChild(rewardItem);
          });
        } else {
          rewardItems.innerHTML = '<div class="text-gray-500">æš‚æ— å¥–åŠ±ä¿¡æ¯</div>';
        }
      }
      function CommitGame() {
        // Send game commit event to host with same data as gameFinished
        window.parent.postMessage(
          {
            type: "gameCommit",
            data: {
              score: sdk.isTestCompleted ? 100 : 0,
              earnedPoints: sdk.isTestCompleted ? 1000 : 0,
              finalProgress: sdk.isTestCompleted ? 100 : 0,
              isMaxDifficulty: true, // prevent selecting difficulty again
            },
          },
          "*"
        );
        console.log("CommitGame");
      }

      async function CollectGiftForTest(currentItem) {
        try {
          // è·å–å½“å‰å·²æ”¶é›†çš„ç¤¼å“åˆ—è¡¨
          let collectedGifts = await sdk.personalPageStore.loadPageData("maisi_test", "testGift");

          if (!collectedGifts || !Array.isArray(collectedGifts)) {
            collectedGifts = [];
          }

          // å¦‚æœå½“å‰é¡¹ç›®çš„displayNameä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™æ·»åŠ 
          if (!collectedGifts.includes(currentItem.displayName)) {
            collectedGifts = [...collectedGifts];
            collectedGifts.push(currentItem.displayName);
            await sdk.personalPageStore.savePageData("maisi_test", "testGift", collectedGifts, true);
            console.log("å·²ä¿å­˜ç¤¼å“æ•°æ®:", collectedGifts);
          }
        } catch (error) {
          console.error("ä¿å­˜ç¤¼å“æ•°æ®å¤±è´¥:", error);
        }
        // é€šçŸ¥çˆ¶çª—å£æµ‹è¯„å®Œæˆå¹¶ä¼ é€’å¥–åŠ±ä¿¡æ¯
        window.parent.postMessage(
          {
            type: "gameCommit",
            data: {
              score: 100,
              testName: currentItem.name,
              testDisplayName: currentItem.displayName, // "æ³¨æ„åŠ›", ...
              reward_items: currentItem.reward_items,
              isMaxDifficulty: true, // prevent selecting difficulty again
            },
          },
          "*"
        );
      }
      document.getElementById("startBtn").addEventListener("click", () => {
        const currentItem = assessmentConfig.find((item) => item.id === currentTabId);

        // æ£€æŸ¥æ˜¯å¦å·²æŠ¥åï¼ˆVIPçŠ¶æ€ï¼‰
        if (!currentItem.isFinished && !sdk.isVip) {
          // æœªæŠ¥åï¼Œè·³è½¬åˆ°æŠ¥åé¡µé¢
          const currentUrl = window.location.href;
          const signupUrl = currentUrl.replace("ms_games_test_reward", "ms_games_test_signup");
          window.location.replace(signupUrl);
        } else {
          // å·²æŠ¥å
          if (currentItem.isFinished) {
            if (currentItem.isGiftCollected) {
              // å·²ç»é¢†å–è¿‡å¥–åŠ±
              showToast(`ä½ å·²ç»é¢†å–è¿‡"${currentItem.displayName}"çš„å¥–åŠ±äº†ï¼`, "warning");
            } else {
              // å¯ä»¥é¢†å–å¥–åŠ±
              showToast(`æ­å–œï¼ä½ å·²æˆåŠŸé¢†å–"${currentItem.displayName}"çš„å¥–åŠ±ï¼`, "success");
              // è¿™é‡Œå¯ä»¥æ·»åŠ é¢†å–å¥–åŠ±çš„é€»è¾‘
              // ç¤ºä¾‹ï¼šæ›´æ–°çŠ¶æ€
              currentItem.isGiftCollected = true;
              // é‡æ–°æ¸²æŸ“UI
              updateTabStyles();
              updateContent(currentItem);
              updateUIBasedOnVipStatus();

              // ä¿å­˜å·²æ”¶é›†çš„ç¤¼å“æ•°æ®
              CollectGiftForTest(currentItem);
            }
          } else {
            // æœªå®Œæˆè¯„ä¼°ï¼Œå¼€å§‹è¯„ä¼°
            const currentUrl = window.location.href;
            let maisiTestUrl = currentUrl.replace("ms_games_test_reward", "ms_games_test");

            if (sdk?.miniGameProxyData?.maisiToken) {
              const url = new URL(maisiTestUrl);
              url.searchParams.set("accessToken", sdk.miniGameProxyData.maisiToken);
              maisiTestUrl = url.toString();
            }
            window.location.replace(maisiTestUrl);
          }
        }
      }); // åŠ è½½å·²æ”¶é›†çš„ç¤¼å“æ•°æ®
      async function loadGiftData() {
        try {
          const collectedGifts = await sdk.personalPageStore.loadPageData("maisi_test", "testGift");
          if (collectedGifts && Array.isArray(collectedGifts)) {
            console.log("åŠ è½½å·²æ”¶é›†çš„ç¤¼å“:", collectedGifts);

            // æ›´æ–° assessmentConfig ä¸­çš„ isGiftCollected çŠ¶æ€
            assessmentConfig.forEach((item) => {
              if (collectedGifts.includes(item.displayName)) {
                item.isGiftCollected = true;
              }
            });
          }
        } catch (error) {
          console.error("åŠ è½½ç¤¼å“æ•°æ®å¤±è´¥:", error);
        }
      }

      // åˆå§‹åŒ–åº”ç”¨ç¨‹åº
      async function initializeApp() {
        await GetTestResultList();
        await loadGiftData(); // åŠ è½½ç¤¼å“æ•°æ®
        initPage();
        updateUIBasedOnVipStatus();

        window.parent.postMessage({ type: "gameLoaded" }, "*");

        setTimeout(() => {
          CommitGame();
        }, 1000);
      } // æ ¹æ®VIPçŠ¶æ€æ›´æ–°UI
      function updateUIBasedOnVipStatus() {
        const startBtn = document.getElementById("startBtn");
        const rewardDot = document.getElementById("rewardDot");
        const currentItem = assessmentConfig.find((item) => item.id === currentTabId);

        if (!currentItem.isFinished && !sdk.isVip) {
          // éVIPç”¨æˆ·æ˜¾ç¤ºæœªæŠ¥åçŠ¶æ€
          startBtn.textContent = "ç«‹å³æŠ¥å";
          rewardDot.classList.add("hidden");
        } else {
          // VIPç”¨æˆ·æ ¹æ®å®ŒæˆçŠ¶æ€æ˜¾ç¤ºä¸åŒæŒ‰é’®
          if (currentItem.isFinished) {
            if (currentItem.isGiftCollected) {
              startBtn.textContent = "ä½ å·²ç»é¢†å–è¿‡";
              rewardDot.classList.add("hidden");
            } else {
              startBtn.textContent = "é¢†å–å¥–åŠ±";
              rewardDot.classList.remove("hidden");
            }
          } else {
            startBtn.textContent = "ç«‹å³å¼€å§‹";
            rewardDot.classList.add("hidden");
          }
        }
      }

      async function GetTestResultList() {
        if (!sdk?.miniGameProxyData?.maisiToken) {
          if (window.location.hostname === "127.0.0.1") {
            sdk.miniGameProxyData = {
              maisiToken:
                "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0a2lkIjoiYmQ4MDljMmEtNTE3OC00OTMzLThmNzUtZTNlNmVhNjQzZjZmIiwidXNlcl9pZCI6IjIwOCIsInBob25lIjoiMTMwNjY5MzU3NzYiLCJleHAiOjE3NTczODMyODksInR5cGUiOiJhY2Nlc3MifQ.eT9cHazQmnPX9zcyaagjqZPFSeW-NIPUzI2KqD9CsGQ",
            };
          }
        }
        if (!sdk?.miniGameProxyData?.maisiToken) return null;
        const headers = {};
        headers["auth_token"] = `Bearer ${sdk?.miniGameProxyData?.maisiToken}`;
        headers["deviceType"] = 1; // pad
        try {
          const response = await fetch("https://api.maseai.com/srt/open/trialList", {
            headers: headers,
          });
          const data = await response.json();
          if (data.code === 200 && data.data) {
            console.log("ç”¨æˆ·æµ‹è¯„ä¿¡æ¯:", data.data);

            // æ›´æ–° assessmentConfig ä¸­çš„ isFinished çŠ¶æ€
            if (data.data.trialList && Array.isArray(data.data.trialList)) {
              data.data.trialList.forEach((trial) => {
                // æ ¹æ®åç§°åŒ¹é…æ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹
                const configItem = assessmentConfig.find((item) => item.displayName === trial.name);
                if (configItem) {
                  // æµ‹è¯„çŠ¶æ€ 0-å®Œæˆï¼Œ1-è¿›è¡Œä¸­ï¼Œ2-æŠ¥å‘Šç”Ÿæˆä¸­ï¼Œ3-æœªå¼€å§‹
                  configItem.isFinished = trial.status === 0 || trial.status === 2;
                  // å¦‚æœæœ‰userReportIdï¼Œè¯´æ˜å·²å®Œæˆæµ‹è¯„
                  if (trial.userReportId) {
                    configItem.isFinished = true;
                  }
                }
              });
            }

            return data.data;
          } else {
            console.error("APIè¿”å›é”™è¯¯:", data);
          }
          return null;
        } catch (error) {
          console.error("è·å–æµ‹è¯„ä¿¡æ¯å¤±è´¥:", error);
          return null;
        }
      } // æ¸¸æˆå¯åŠ¨æ£€æŸ¥
      function checkStartGame(timeoutMs) {
        if (!timeoutMs) {
          const urlParams = new URLSearchParams(window.location.search);
          timeoutMs = urlParams.get("parent") === "miniGameProxy" ? 3000 : 200;
        }

        let gameStarted = false;
        const waitForMinigameProxyWithTimeout = new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            if (!gameStarted) {
              resolve(null);
            }
          }, timeoutMs);

          let locationReceived = false;
          let miniGameProxyReceived = false;
          const messageHandler = function (e) {
            if (e.data.type === "locationResponse") {
              locationReceived = true;
              const searchPath = e.data.search;
              if (searchPath) {
                const params = new URLSearchParams(searchPath);
                const tabName = params.get("tab");
                if (tabName) {
                  const foundItem = assessmentConfig.find((item) => item.name === tabName);
                  if (foundItem) {
                    currentTabId = foundItem.id;
                  }
                }
              }
            } else if (e.data.type === "miniGameProxyDataResponse") {
              miniGameProxyReceived = true;
              sdk.token = e.data?.keepworkToken;
              sdk.isVip = e.data?.isVip;
              sdk.isTestCompleted = e.data?.isTestCompleted;
              sdk.isProfileCreated = e.data?.isProfileCreated;
              sdk.miniGameProxyData = e.data;
            }
            if (locationReceived && miniGameProxyReceived) {
              window.removeEventListener("message", messageHandler);
              clearTimeout(timeout);
              resolve(e.data);
            }
          };

          window.addEventListener("message", messageHandler);
          window.parent.postMessage({ type: "getLocation" }, "*");
          window.parent.postMessage({ type: "getMiniGameProxyData" }, "*");
        });

        waitForMinigameProxyWithTimeout
          .then(async () => {
            if (!gameStarted) {
              gameStarted = true;
              await initializeApp();
            }
          })
          .catch(async (error) => {
            if (!gameStarted) {
              gameStarted = true;
              await initializeApp();
            }
          });
      }

      // å¯åŠ¨æ¸¸æˆæ£€æŸ¥
      checkStartGame();
    </script>
  </body>
</html>