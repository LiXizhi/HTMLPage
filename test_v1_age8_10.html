<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è®¤çŸ¥èƒ½åŠ›æµ‹è¯„ç³»ç»Ÿ - 8-10å²</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 10px;
      }

      body {
        font-family: "PingFang SC", "PingFang TC", "-apple-system", "BlinkMacSystemFont", "Noto Sans SC", "Roboto", "Helvetica Neue", "Arial", "Microsoft YaHei", sans-serif;
        font-size: 1.4rem;
        line-height: 2.2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        width: 100%;
        height: 100vh;
        padding: 0;
        margin: 0;
        position: relative;
      }

      /* æ¬¢è¿é¡µé¢æ ·å¼ */
      .welcome-screen {
        background: white;
        padding: 4rem;
        text-align: center;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .welcome-content {
        width: 100%;
        padding: 0 2rem;
      }

      .welcome-title {
        font-size: 4.2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 2rem;
      }

      .welcome-subtitle {
        font-size: 2.4rem;
        color: #666;
        margin-bottom: 3rem;
        line-height: 3.2rem;
      }

      .test-info {
        background: #f8f9fa;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 3rem;
        text-align: left;
      }

      .test-info-item {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        font-size: 2rem;
      }

      .test-info-item:last-child {
        margin-bottom: 0;
      }

      .test-info-icon {
        width: 3rem;
        height: 3rem;
        margin-right: 1.2rem;
        color: #667eea;
      }

      .start-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 1rem;
        padding: 1.8rem 4.5rem;
        font-size: 2.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: 0 0.4rem 1.2rem rgba(102, 126, 234, 0.4);
      }

      .start-btn:hover {
        transform: translateY(-0.2rem);
        box-shadow: 0 0.6rem 1.6rem rgba(102, 126, 234, 0.5);
      }

      .start-btn:active {
        transform: translateY(0);
      }

      /* æµ‹è¯„è¿›è¡Œä¸­æ ·å¼ */
      .testing-screen {
        display: none;
        width: 100%;
        height: 100vh;
        background: white;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      /* å·¦ä¾§è¿›åº¦æ¡åŒºåŸŸ - ç³–è‘«èŠ¦æ ·å¼ */
      .progress-sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 12rem;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3rem 1rem;
        box-shadow: 0.2rem 0 1rem rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .progress-title {
        color: white;
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 2rem;
        text-align: center;
      }

      .progress-steps {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        position: relative;
        width: 100%;
        padding: 2rem 0;
      }

      /* ç³–è‘«èŠ¦çš„ç«¹ç­¾ - è¿æ¥çº¿ */
      .progress-line {
        position: absolute;
        left: 50%;
        top: 2rem;
        bottom: 2rem;
        width: 0.3rem;
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-50%);
        z-index: 1;
      }

      .progress-line-fill {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        transition: height 0.5s ease;
        height: 0%;
      }

      /* ç³–è‘«èŠ¦çš„æ¯é¢—ç³–çƒ */
      .progress-step {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

    .progress-circle {
      width: 5rem;
      height: 5rem;
      border-radius: 50%;
      background: #d8d4e8;
      border: 0.3rem solid #c5bdd9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #8b84a3;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 0.5rem;
    }

    .progress-step.active .progress-circle {
      background: #f5f3fa;
      color: #667eea;
      border-color: #e8e4f3;
      transform: scale(1.1);
      box-shadow: 0 0 2rem #e0dcf0;
    }

      .progress-step.completed .progress-circle {
        background: #4caf50;
        border-color: #4caf50;
        color: white;
      }

      .progress-step.completed .progress-circle::before {
        content: "âœ“";
        font-size: 2.5rem;
      }

      .progress-label {
        font-size: 1.4rem;
        color: rgba(255, 255, 255, 0.5);
        text-align: center;
        line-height: 1.6rem;
        max-width: 9rem;
        word-break: break-word;
      }

      .progress-step.active .progress-label {
        color: white;
        font-weight: 600;
      }

      .progress-step.completed .progress-label {
        color: rgba(255, 255, 255, 0.9);
      }

      .testing-header {
        display: none; /* éšè—åŸæ¥çš„é¡¶éƒ¨header */
      }

      .progress-container {
        display: none; /* éšè—åŸæ¥çš„è¿›åº¦æ¡ */
      }

      .progress-bar-bg {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 1rem;
        height: 1rem;
        overflow: hidden;
      }

      .progress-bar {
        background: white;
        height: 100%;
        border-radius: 1rem;
        transition: width 0.5s ease;
      }

      .progress-text {
        margin-top: 1rem;
        font-size: 1.4rem;
        opacity: 0.9;
      }

      .game-container {
        position: absolute;
        left: 12rem;
        top: 0;
        right: 0;
        bottom: 0;
        background: #f8f9fa;
      }

      .game-iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .game-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 10;
      }

      .game-overlay.hidden {
        display: none;
      }

      .game-title {
        font-size: 4.2rem;
        font-weight: 700;
        margin-bottom: 2rem;
      }

      .game-desc {
        font-size: 2.4rem;
        width: 90%;
        text-align: center;
        line-height: 3.4rem;
        margin-bottom: 3rem;
        opacity: 0.9;
      }

      .game-start-btn {
        background: #667eea;
        color: white;
        border: none;
        border-radius: 1rem;
        padding: 1.6rem 4rem;
        font-size: 2.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .game-start-btn:hover {
        background: #5568d3;
        transform: translateY(-0.2rem);
      }

      /* ç»“æœé¡µé¢æ ·å¼ */
      .result-screen {
        display: none;
        background: white;
        padding: 4rem;
        width: 100%;
        height: 100vh;
        overflow-y: auto;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .result-title {
        font-size: 3.2rem;
        font-weight: 700;
        color: #667eea;
        text-align: center;
        margin-bottom: 3rem;
      }

      .result-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1.5rem;
        padding: 3rem;
        margin-bottom: 3rem;
        text-align: center;
      }

      .overall-score {
        font-size: 6rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      .score-label {
        font-size: 1.8rem;
        opacity: 0.9;
      }

      .abilities-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(30rem, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
      }

      .ability-card {
        background: #f8f9fa;
        border-radius: 1rem;
        padding: 2rem;
      }

      .ability-name {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.5rem;
      }

      .ability-score {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
      }

      .ability-score-value {
        font-size: 3rem;
        font-weight: 700;
        color: #667eea;
        margin-right: 1rem;
      }

      .ability-score-max {
        font-size: 1.6rem;
        color: #999;
      }

      .ability-bar-bg {
        background: #e0e0e0;
        border-radius: 0.5rem;
        height: 0.8rem;
        overflow: hidden;
        margin-bottom: 1rem;
      }

      .ability-bar {
        height: 100%;
        border-radius: 0.5rem;
        transition: width 0.5s ease;
      }

      .ability-desc {
        font-size: 1.4rem;
        color: #666;
        line-height: 2rem;
      }

      .radar-chart-container {
        width: 90%;
        max-width: 50rem;
        margin: 0 auto 3rem;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 1rem;
      }

      .recommendations {
        background: #fff8e1;
        border-left: 0.4rem solid #ffc107;
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .recommendations-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #f57c00;
        margin-bottom: 1.5rem;
      }

      .recommendations-list {
        list-style: none;
      }

      .recommendations-list li {
        font-size: 1.4rem;
        color: #666;
        line-height: 2.2rem;
        margin-bottom: 1rem;
        padding-left: 2rem;
        position: relative;
      }

      .recommendations-list li::before {
        content: "ğŸ’¡";
        position: absolute;
        left: 0;
      }

      .action-buttons {
        display: flex;
        gap: 2rem;
        justify-content: center;
        margin-top: 3rem;
      }

      .btn {
        padding: 1.4rem 3rem;
        border-radius: 1rem;
        font-size: 1.6rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-secondary {
        background: white;
        color: #667eea;
        border: 0.2rem solid #667eea;
      }

      .btn:hover {
        transform: translateY(-0.2rem);
        box-shadow: 0 0.4rem 1.2rem rgba(0, 0, 0, 0.15);
      }

      .hidden {
        display: none !important;
      }

      /* åŠ è½½åŠ¨ç”» */
      .loading {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 0.3rem solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container" style="max-width: none !important; width: 100% !important">
      <!-- æ¬¢è¿é¡µé¢ -->
      <div id="welcomeScreen" class="welcome-screen" style="max-width: none !important; width: 100% !important">
        <div class="welcome-content" style="max-width: none !important">
          <h1 class="welcome-title">ğŸ§  éº¦æ€AIèƒ½åŠ›æµ‹è¯„</h1>
          <p class="welcome-subtitle">ä¸“ä¸º 4-16 å²è®¾è®¡è®¤çŸ¥èƒ½åŠ›è¯„ä¼°ä¸è®­ç»ƒ</p>

          <div class="test-info">
            <div class="test-info-item">
              <span class="test-info-icon">ğŸ“‹</span>
              <span><strong>æµ‹è¯„é¡¹ç›®ï¼š</strong>5 ä¸ªè®¤çŸ¥èƒ½åŠ›æ¸¸æˆ</span>
            </div>
            <div class="test-info-item">
              <span class="test-info-icon">â±ï¸</span>
              <span><strong>é¢„è®¡æ—¶é•¿ï¼š</strong>15-20 åˆ†é’Ÿ</span>
            </div>
            <div class="test-info-item">
              <span class="test-info-icon">ğŸ¯</span>
              <span><strong>è¯„ä¼°ç»´åº¦ï¼š</strong>è§†è§‰è®°å¿†ã€ç©ºé—´æ€ç»´ã€å·¥ä½œè®°å¿†ã€å½’çº³æ¨ç†ã€æ³¨æ„åŠ›</span>
            </div>
            <div class="test-info-item">
              <span class="test-info-icon">ğŸ’¡</span>
              <span><strong>æ¸©é¦¨æç¤ºï¼š</strong>è¯·åœ¨å®‰é™ç¯å¢ƒä¸‹å®Œæˆæµ‹è¯„ï¼Œç¡®ä¿æµ‹è¯„ç»“æœå‡†ç¡®</span>
            </div>
          </div>

          <button class="start-btn" onclick="startTest()">å¼€å§‹æµ‹è¯„</button>
        </div>
      </div>

      <!-- æµ‹è¯„è¿›è¡Œä¸­ -->
      <div id="testingScreen" class="testing-screen" style="max-width: none !important; width: 100% !important">
        <!-- å·¦ä¾§è¿›åº¦æ¡ -->
        <div class="progress-sidebar">
          <div class="progress-title">æµ‹è¯„è¿›åº¦</div>
          <div class="progress-steps">
            <div class="progress-line">
              <div class="progress-line-fill" id="progressLineFill"></div>
            </div>
            <div class="progress-step" id="step0">
              <div class="progress-circle">1</div>
              <div class="progress-label">æ—‹è½¬å®«æ®¿</div>
            </div>
            <div class="progress-step" id="step1">
              <div class="progress-circle">2</div>
              <div class="progress-label">å½±å­éª‘å£«</div>
            </div>
            <div class="progress-step" id="step2">
              <div class="progress-circle">3</div>
              <div class="progress-label">è„‘åŠ›åŒè½¨æˆ˜</div>
            </div>
            <div class="progress-step" id="step3">
              <div class="progress-circle">4</div>
              <div class="progress-label">å›¾å½¢æ‰¾èŒ¬</div>
            </div>
            <div class="progress-step" id="step4">
              <div class="progress-circle">5</div>
              <div class="progress-label">ä¸‰å¿ƒäºŒæ„</div>
            </div>
            <div class="progress-step" id="step5">
              <div class="progress-circle">ğŸ“Š</div>
              <div class="progress-label">æµ‹è¯„æŠ¥å‘Š</div>
            </div>
          </div>
        </div>

        <div class="testing-header">
          <h2 id="currentGameTitle" style="font-size: 2.4rem; font-weight: 600">æ­£åœ¨åŠ è½½...</h2>
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="progressText">è¿›åº¦ï¼š0/5</p>
          </div>
        </div>

        <div class="game-container">
          <iframe id="gameIframe" class="game-iframe" src=""></iframe>
          <div id="gameOverlay" class="game-overlay">
            <h2 class="game-title" id="overlayTitle">å‡†å¤‡å¼€å§‹</h2>
            <p class="game-desc" id="overlayDesc">æ¸¸æˆè¯´æ˜åŠ è½½ä¸­...</p>
            <button class="game-start-btn" onclick="startCurrentGame()">å¼€å§‹æ¸¸æˆ</button>
          </div>
        </div>
      </div>

      <!-- ç»“æœé¡µé¢ -->
      <div id="resultScreen" class="result-screen" style="max-width: none !important; width: 100% !important">
        <h1 class="result-title">ğŸ‰ æµ‹è¯„å®Œæˆï¼</h1>

        <div class="result-summary">
          <div class="overall-score" id="overallScore">85</div>
          <div class="score-label">ç»¼åˆè®¤çŸ¥èƒ½åŠ›å¾—åˆ†</div>
        </div>

        <div class="radar-chart-container">
          <canvas id="radarChart"></canvas>
        </div>

        <div class="abilities-container" id="abilitiesContainer">
          <!-- åŠ¨æ€ç”Ÿæˆèƒ½åŠ›å¡ç‰‡ -->
        </div>

        <div class="recommendations">
          <h3 class="recommendations-title">ğŸ’¡ ä¸ªæ€§åŒ–å»ºè®®</h3>
          <ul class="recommendations-list" id="recommendationsList">
            <!-- åŠ¨æ€ç”Ÿæˆå»ºè®® -->
          </ul>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="location.reload()">é‡æ–°æµ‹è¯„</button>
          <button class="btn btn-primary" onclick="downloadReport()">ä¸‹è½½æŠ¥å‘Š</button>
        </div>
      </div>
    </div>

    <script>
      // æµ‹è¯„é…ç½®
      const TEST_CONFIG = {
        games: [
          {
            id: "visual_rotate_mem",
            name: "æ—‹è½¬å®«æ®¿",
            file: "visual_rotate_mem",
            description: "è®°å¿†æ ¼å­çŸ©é˜µä¸­äº®èµ·æ–¹å—çš„ä½ç½®ï¼Œåœ¨çŸ©é˜µæ—‹è½¬åï¼Œæ‰¾åˆ°äº®èµ·è¿‡æ ¼å­çš„å¯¹åº”ä½ç½®",
            ability: "è§†è§‰è®°å¿†",
            config: { difficultyLevel: 12 }, // é€‚åˆ8-10å²çš„éš¾åº¦
            weight: 1.0,
            timeLimit: 180, // 3åˆ†é’Ÿ
          },
          {
            id: "guess_cubes",
            name: "å½±å­éª‘å£«",
            file: "guess_cubes",
            description: "æ ¹æ®ä¸¤ä¸ªæ–¹å‘çš„æŠ•å½±ï¼Œå®Œæˆå¯¹åº”çš„ä¸‰ç»´æ¨¡å‹ï¼Œé”»ç‚¼æ‚¨çš„ç©ºé—´æ€ç»´èƒ½åŠ›",
            ability: "ç©ºé—´æ€ç»´",
            config: { difficultyLevel: 3 },
            weight: 1.0,
            timeLimit: 180,
          },
          {
            id: "dual_n_back",
            name: "è„‘åŠ›åŒè½¨æˆ˜",
            file: "dual_n_back",
            description: "è®°ä¸‹çŸ©é˜µä¸­é—ªçƒæ–¹å—çš„é¢œè‰²ä¸ä½ç½®ï¼Œåœ¨è¯¥ä½ç½®é‡å¤é—ªçƒæ—¶ï¼Œåšå‡ºå¯¹åº”çš„ç­”æ¡ˆé€‰æ‹©",
            ability: "å·¥ä½œè®°å¿†",
            config: { difficultyLevel: 2 },
            weight: 1.0,
            timeLimit: 180,
          },
          {
            id: "graph_analogy",
            name: "å›¾å½¢æ‰¾èŒ¬",
            file: "graph_analogy",
            description: "è§‚å¯Ÿå›¾å½¢åºåˆ—çš„å˜åŒ–è§„å¾‹ï¼Œæ‰¾å‡ºéšè—çš„æ¨¡å¼å¹¶æ¨ç†å‡ºæ­£ç¡®ç­”æ¡ˆ",
            ability: "å½’çº³æ¨ç†",
            config: { difficultyLevel: 3 },
            weight: 1.0,
            timeLimit: 180,
          },
          {
            id: "attention_game",
            name: "ä¸‰å¿ƒäºŒæ„",
            file: "attention_game",
            description: "åŒæ—¶å…³æ³¨å¹¶å®Œæˆä¸¤ä¾§ä»»åŠ¡ï¼Œè®­ç»ƒåˆ†é…æ³¨æ„åŠ›",
            ability: "æ³¨æ„åŠ›",
            config: { difficultyLevel: 2 },
            weight: 1.0,
            timeLimit: 180,
          },
        ],
      };

      // å…¨å±€çŠ¶æ€
      let currentGameIndex = 0;
      let gameResults = [];
      let currentGameStartTime = 0;
      let gameTimeoutTimer = null;

      // å¼€å§‹æµ‹è¯„
      function startTest() {
        document.getElementById("welcomeScreen").classList.add("hidden");
        document.getElementById("testingScreen").style.display = "block";
        loadGame(0);
      }

      // åŠ è½½æ¸¸æˆ
      function loadGame(index) {
        if (index >= TEST_CONFIG.games.length) {
          showResults();
          return;
        }

        currentGameIndex = index;
        const game = TEST_CONFIG.games[index];

        // æ›´æ–°ç³–è‘«èŠ¦è¿›åº¦æ¡
        updateProgressSteps(index);

        // éšè—æ¸¸æˆè¯´æ˜è¦†ç›–å±‚ï¼Œç›´æ¥å¼€å§‹æ¸¸æˆ
        document.getElementById("gameOverlay").classList.add("hidden");

        // åŠ è½½iframe
        const iframe = document.getElementById("gameIframe");
        const currentUrl = new URL(window.location.href);
        const pathParts = currentUrl.pathname.split("/");
        const currentFilename = pathParts[pathParts.length - 1];
        const extensionMatch = currentFilename.match(/\.[^.]+$/);
        const extension = extensionMatch ? extensionMatch[0] : "";
        pathParts[pathParts.length - 1] = game.file + extension;
        const newUrl = currentUrl.origin + pathParts.join("/");
        iframe.src = newUrl;

        // è‡ªåŠ¨å¼€å§‹æ¸¸æˆ
        setTimeout(() => {
          iframe.contentWindow.postMessage(
            {
              type: "setGameConfig",
              config: JSON.stringify(game.config),
            },
            "*"
          );
        }, 500);

        // è®¾ç½®è¶…æ—¶
        currentGameStartTime = Date.now();
        if (gameTimeoutTimer) clearTimeout(gameTimeoutTimer);
        gameTimeoutTimer = setTimeout(() => {
          handleGameTimeout();
        }, game.timeLimit * 1000);
      }

      // æ›´æ–°ç³–è‘«èŠ¦è¿›åº¦æ˜¾ç¤º
      function updateProgressSteps(currentIndex) {
        // æ›´æ–°æ¯ä¸€æ­¥çš„çŠ¶æ€
        for (let i = 0; i < 6; i++) {
          // 5ä¸ªæ¸¸æˆ + 1ä¸ªæŠ¥å‘Š
          const step = document.getElementById(`step${i}`);
          if (!step) continue;

          step.classList.remove("active", "completed");

          if (i < currentIndex) {
            step.classList.add("completed");
          } else if (i === currentIndex) {
            step.classList.add("active");
          }
        }

        // æ›´æ–°è¿æ¥çº¿çš„å¡«å……é«˜åº¦
        const progressPercentage = (currentIndex / 6) * 100;
        document.getElementById("progressLineFill").style.height = progressPercentage + "%";
      }

      // å¼€å§‹å½“å‰æ¸¸æˆ
      function startCurrentGame() {
        const game = TEST_CONFIG.games[currentGameIndex];
        document.getElementById("gameOverlay").classList.add("hidden");

        // ç­‰å¾…æ¸¸æˆåŠ è½½å®Œæˆåå‘é€é…ç½®
        setTimeout(() => {
          const iframe = document.getElementById("gameIframe");
          iframe.contentWindow.postMessage(
            {
              type: "setGameConfig",
              config: JSON.stringify(game.config),
            },
            "*"
          );
        }, 500);

        // è®¾ç½®è¶…æ—¶
        currentGameStartTime = Date.now();
        if (gameTimeoutTimer) clearTimeout(gameTimeoutTimer);
        gameTimeoutTimer = setTimeout(() => {
          handleGameTimeout();
        }, game.timeLimit * 1000);
      }

      // æ¸¸æˆè¶…æ—¶å¤„ç†
      function handleGameTimeout() {
        const game = TEST_CONFIG.games[currentGameIndex];
        gameResults.push({
          gameId: game.id,
          gameName: game.name,
          ability: game.ability,
          score: 0,
          maxScore: 100,
          accuracy: 0,
          timeUsed: game.timeLimit,
          timeout: true,
        });

        // åŠ è½½ä¸‹ä¸€ä¸ªæ¸¸æˆ
        loadGame(currentGameIndex + 1);
      }

      // ç›‘å¬æ¸¸æˆæ¶ˆæ¯
      window.addEventListener("message", function (e) {
        const data = e.data;

        switch (data.type) {
          case "gameLoaded":
            console.log("æ¸¸æˆåŠ è½½å®Œæˆ");
            break;

          case "gameStarted":
            console.log("æ¸¸æˆå¼€å§‹");
            currentGameStartTime = Date.now();
            break;

          case "gameFinished":
            handleGameFinished(data.data);
            break;

          case "gameClosed":
            // å¦‚æœç”¨æˆ·ä¸­é€”é€€å‡ºæ¸¸æˆ
            if (currentGameIndex < TEST_CONFIG.games.length) {
              loadGame(currentGameIndex + 1);
            }
            break;
        }
      });

      // å¤„ç†æ¸¸æˆå®Œæˆ
      function handleGameFinished(gameData) {
        if (gameTimeoutTimer) clearTimeout(gameTimeoutTimer);

        const game = TEST_CONFIG.games[currentGameIndex];
        const timeUsed = (Date.now() - currentGameStartTime) / 1000;

        // è®¡ç®—æ ‡å‡†åŒ–åˆ†æ•° (0-100)
        let normalizedScore = 0;
        if (gameData.score !== undefined) {
          // æ ¹æ®ä¸åŒæ¸¸æˆçš„å¾—åˆ†æœºåˆ¶è¿›è¡Œæ ‡å‡†åŒ–
          normalizedScore = Math.min(100, Math.max(0, gameData.score / 10)); // å‡è®¾åŸå§‹åˆ†æ•°èŒƒå›´0-1000
        }

        // è®¡ç®—å‡†ç¡®ç‡
        let accuracy = 0;
        if (gameData.accuracy !== undefined) {
          accuracy = gameData.accuracy;
        } else if (gameData.correctCount !== undefined && gameData.totalCount !== undefined) {
          accuracy = gameData.totalCount > 0 ? (gameData.correctCount / gameData.totalCount) * 100 : 0;
        }

        gameResults.push({
          gameId: game.id,
          gameName: game.name,
          ability: game.ability,
          score: normalizedScore,
          maxScore: 100,
          accuracy: accuracy,
          timeUsed: timeUsed,
          rawData: gameData,
        });

        console.log("æ¸¸æˆå®Œæˆ:", gameResults[gameResults.length - 1]);

        // å»¶è¿ŸåŠ è½½ä¸‹ä¸€ä¸ªæ¸¸æˆ
        setTimeout(() => {
          loadGame(currentGameIndex + 1);
        }, 1000);
      }

      // æ˜¾ç¤ºç»“æœ
      function showResults() {
        // æ›´æ–°è¿›åº¦åˆ°æœ€åä¸€æ­¥ï¼ˆæŠ¥å‘Šï¼‰
        updateProgressSteps(5);

        // å»¶è¿Ÿä¸€ä¸‹å†åˆ‡æ¢åˆ°ç»“æœé¡µé¢ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦å®Œæˆ
        setTimeout(() => {
          document.getElementById("testingScreen").style.display = "none";
          document.getElementById("resultScreen").style.display = "block";

          // è®¡ç®—ç»¼åˆå¾—åˆ†å’Œå„é¡¹èƒ½åŠ›å¾—åˆ†
          const abilities = calculateAbilities();
          const overallScore = Math.round(abilities.overall);

          // æ˜¾ç¤ºç»¼åˆå¾—åˆ†
          document.getElementById("overallScore").textContent = overallScore;

          // åˆ›å»ºé›·è¾¾å›¾
          createRadarChart(abilities);

          // åˆ›å»ºèƒ½åŠ›å¡ç‰‡
          createAbilityCards(abilities);

          // ç”Ÿæˆå»ºè®®
          generateRecommendations(abilities);
        }, 1000);
      }

      // è®¡ç®—å„é¡¹èƒ½åŠ›å¾—åˆ†
      function calculateAbilities() {
        const abilityScores = {
          è§†è§‰è®°å¿†: 0,
          ç©ºé—´æ€ç»´: 0,
          å·¥ä½œè®°å¿†: 0,
          å½’çº³æ¨ç†: 0,
          æ³¨æ„åŠ›: 0,
        };

        const abilityCounts = {
          è§†è§‰è®°å¿†: 0,
          ç©ºé—´æ€ç»´: 0,
          å·¥ä½œè®°å¿†: 0,
          å½’çº³æ¨ç†: 0,
          æ³¨æ„åŠ›: 0,
        };

        // æ±‡æ€»å„æ¸¸æˆå¾—åˆ†
        gameResults.forEach((result) => {
          if (abilityScores[result.ability] !== undefined) {
            abilityScores[result.ability] += result.score;
            abilityCounts[result.ability]++;
          }
        });

        // è®¡ç®—å¹³å‡åˆ†
        const abilities = {};
        for (let ability in abilityScores) {
          abilities[ability] = abilityCounts[ability] > 0 ? abilityScores[ability] / abilityCounts[ability] : 0;
        }

        // è®¡ç®—ç»¼åˆå¾—åˆ†
        const scores = Object.values(abilities);
        abilities.overall = scores.reduce((a, b) => a + b, 0) / scores.length;

        return abilities;
      }

      // åˆ›å»ºé›·è¾¾å›¾
      function createRadarChart(abilities) {
        const ctx = document.getElementById("radarChart").getContext("2d");

        new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["è§†è§‰è®°å¿†", "ç©ºé—´æ€ç»´", "å·¥ä½œè®°å¿†", "å½’çº³æ¨ç†", "æ³¨æ„åŠ›"],
            datasets: [
              {
                label: "è®¤çŸ¥èƒ½åŠ›è¯„åˆ†",
                data: [abilities["è§†è§‰è®°å¿†"], abilities["ç©ºé—´æ€ç»´"], abilities["å·¥ä½œè®°å¿†"], abilities["å½’çº³æ¨ç†"], abilities["æ³¨æ„åŠ›"]],
                backgroundColor: "rgba(102, 126, 234, 0.2)",
                borderColor: "rgba(102, 126, 234, 1)",
                borderWidth: 2,
                pointBackgroundColor: "rgba(102, 126, 234, 1)",
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(102, 126, 234, 1)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20,
                  font: {
                    size: 12,
                  },
                },
                pointLabels: {
                  font: {
                    size: 14,
                    weight: "600",
                  },
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      // åˆ›å»ºèƒ½åŠ›å¡ç‰‡
      function createAbilityCards(abilities) {
        const container = document.getElementById("abilitiesContainer");
        container.innerHTML = "";

        const abilityDescriptions = {
          è§†è§‰è®°å¿†: "è®°ä½çœ‹åˆ°çš„å›¾åƒã€ä½ç½®ã€é¢œè‰²ç­‰è§†è§‰ä¿¡æ¯çš„èƒ½åŠ›",
          ç©ºé—´æ€ç»´: "ç†è§£å’Œæ“ä½œä¸‰ç»´ç©ºé—´ä¸­ç‰©ä½“çš„èƒ½åŠ›",
          å·¥ä½œè®°å¿†: "åœ¨è¿›è¡Œå¤æ‚ä»»åŠ¡æ—¶æš‚æ—¶å­˜å‚¨å’Œå¤„ç†ä¿¡æ¯çš„èƒ½åŠ›",
          å½’çº³æ¨ç†: "ä»å…·ä½“å®ä¾‹ä¸­æ€»ç»“è§„å¾‹ã€å‘ç°æ¨¡å¼çš„èƒ½åŠ›",
          æ³¨æ„åŠ›: "é›†ä¸­ç²¾åŠ›ã€åˆ†é…æ³¨æ„èµ„æºã€æŠµæŠ—å¹²æ‰°çš„èƒ½åŠ›",
        };

        const abilityColors = {
          è§†è§‰è®°å¿†: "#8A83FF",
          ç©ºé—´æ€ç»´: "#4E9DFC",
          å·¥ä½œè®°å¿†: "#96C944",
          å½’çº³æ¨ç†: "#FF9A00",
          æ³¨æ„åŠ›: "#FF6B9D",
        };

        for (let ability in abilities) {
          if (ability === "overall") continue;

          const score = Math.round(abilities[ability]);
          const percentage = score;

          const card = document.createElement("div");
          card.className = "ability-card";
          card.innerHTML = `
                    <div class="ability-name">${ability}</div>
                    <div class="ability-score">
                        <span class="ability-score-value">${score}</span>
                        <span class="ability-score-max">/ 100</span>
                    </div>
                    <div class="ability-bar-bg">
                        <div class="ability-bar" style="width: ${percentage}%; background-color: ${abilityColors[ability]}"></div>
                    </div>
                    <div class="ability-desc">${abilityDescriptions[ability]}</div>
                `;
          container.appendChild(card);
        }
      }

      // ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
      function generateRecommendations(abilities) {
        const recommendations = [];

        // æ‰¾å‡ºæœ€å¼ºå’Œæœ€å¼±çš„èƒ½åŠ›
        const abilityArray = [];
        for (let ability in abilities) {
          if (ability !== "overall") {
            abilityArray.push({ name: ability, score: abilities[ability] });
          }
        }
        abilityArray.sort((a, b) => b.score - a.score);

        const strongest = abilityArray[0];
        const weakest = abilityArray[abilityArray.length - 1];

        // åŸºäºç»¼åˆå¾—åˆ†ç»™å»ºè®®
        if (abilities.overall >= 80) {
          recommendations.push("ğŸ‰ æ•´ä½“è®¤çŸ¥èƒ½åŠ›ä¼˜ç§€ï¼å»ºè®®ç»§ç»­ä¿æŒï¼Œå¯ä»¥å°è¯•æ›´æœ‰æŒ‘æˆ˜æ€§çš„å­¦ä¹ ä»»åŠ¡ã€‚");
        } else if (abilities.overall >= 60) {
          recommendations.push("ğŸ‘ æ•´ä½“è®¤çŸ¥èƒ½åŠ›è‰¯å¥½ï¼Œè¿˜æœ‰æå‡ç©ºé—´ï¼Œå»ºè®®é’ˆå¯¹æ€§åœ°åŠ å¼ºè–„å¼±ç¯èŠ‚ã€‚");
        } else {
          recommendations.push("ğŸ’ª å»ºè®®åŠ å¼ºè®¤çŸ¥èƒ½åŠ›è®­ç»ƒï¼Œå¯ä»¥ä»æ„Ÿå…´è¶£çš„æ¸¸æˆå¼€å§‹ï¼Œå¾ªåºæ¸è¿›åœ°æå‡ã€‚");
        }

        // åŸºäºæœ€å¼ºèƒ½åŠ›ç»™å»ºè®®
        recommendations.push(`âœ¨ æ‚¨çš„ ${strongest.name} è¡¨ç°å‡ºè‰²ï¼è¿™æ˜¯å¾ˆå¥½çš„ä¼˜åŠ¿ï¼Œå¯ä»¥åœ¨å­¦ä¹ ä¸­å¤šåˆ©ç”¨è¿™ä¸€ä¼˜åŠ¿ã€‚`);

        // åŸºäºæœ€å¼±èƒ½åŠ›ç»™å»ºè®®
        if (weakest.score < 60) {
          const suggestions = {
            è§†è§‰è®°å¿†: "å»ºè®®å¤šåšè®°å¿†ç±»æ¸¸æˆï¼Œå¦‚è®°å¿†å¡ç‰‡ã€æ‰¾ä¸åŒç­‰ï¼Œå¸®åŠ©æå‡è§†è§‰è®°å¿†èƒ½åŠ›ã€‚",
            ç©ºé—´æ€ç»´: "å»ºè®®å¤šç©ç§¯æœ¨ã€æ‹¼å›¾ç±»æ¸¸æˆï¼ŒåŸ¹å…»ç©ºé—´æƒ³è±¡åŠ›å’Œä¸‰ç»´æ€ç»´èƒ½åŠ›ã€‚",
            å·¥ä½œè®°å¿†: "å»ºè®®ç»ƒä¹ å¿ƒç®—ã€å¤šä»»åŠ¡å¤„ç†ï¼Œé€æ­¥æå‡åŒæ—¶å¤„ç†å¤šé¡¹ä¿¡æ¯çš„èƒ½åŠ›ã€‚",
            å½’çº³æ¨ç†: "å»ºè®®å¤šåšé€»è¾‘æ¨ç†é¢˜ï¼ŒåŸ¹å…»è§‚å¯Ÿè§„å¾‹ã€æ€»ç»“æ¨¡å¼çš„èƒ½åŠ›ã€‚",
            æ³¨æ„åŠ›: "å»ºè®®è¿›è¡Œä¸“æ³¨åŠ›è®­ç»ƒï¼Œå¦‚èˆ’å°”ç‰¹æ–¹æ ¼ã€å†¥æƒ³ç»ƒä¹ ç­‰ï¼Œæå‡æ³¨æ„åŠ›æŒç»­æ—¶é—´ã€‚",
          };
          recommendations.push(`ğŸ“š ${weakest.name} æœ‰æå‡ç©ºé—´ã€‚${suggestions[weakest.name]}`);
        }

        // ç»¼åˆå»ºè®®
        recommendations.push("ğŸ¯ å»ºè®®æ¯å‘¨è¿›è¡Œ2-3æ¬¡è®¤çŸ¥è®­ç»ƒï¼Œæ¯æ¬¡15-20åˆ†é’Ÿï¼ŒæŒç»­è®­ç»ƒæ•ˆæœæ›´ä½³ã€‚");
        recommendations.push("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿å¯ä»¥é™ªä¼´å­©å­ä¸€èµ·è¿›è¡Œè®­ç»ƒï¼Œåœ¨æ¸¸æˆä¸­å­¦ä¹ ï¼Œåœ¨å¿«ä¹ä¸­æˆé•¿ã€‚");

        // æ˜¾ç¤ºå»ºè®®
        const list = document.getElementById("recommendationsList");
        list.innerHTML = "";
        recommendations.forEach((rec) => {
          const li = document.createElement("li");
          li.textContent = rec;
          list.appendChild(li);
        });
      }

      // ä¸‹è½½æŠ¥å‘Š
      function downloadReport() {
        // ç”ŸæˆæŠ¥å‘Šå†…å®¹
        const abilities = calculateAbilities();
        const date = new Date().toLocaleDateString("zh-CN");

        let reportText = `è®¤çŸ¥èƒ½åŠ›æµ‹è¯„æŠ¥å‘Š\n`;
        reportText += `æµ‹è¯„æ—¥æœŸï¼š${date}\n`;
        reportText += `é€‚ç”¨å¹´é¾„ï¼š8-10å²\n\n`;
        reportText += `ç»¼åˆå¾—åˆ†ï¼š${Math.round(abilities.overall)}/100\n\n`;
        reportText += `å„é¡¹èƒ½åŠ›å¾—åˆ†ï¼š\n`;

        for (let ability in abilities) {
          if (ability !== "overall") {
            reportText += `  ${ability}ï¼š${Math.round(abilities[ability])}/100\n`;
          }
        }

        reportText += `\næ¸¸æˆè¯¦æƒ…ï¼š\n`;
        gameResults.forEach((result, index) => {
          reportText += `${index + 1}. ${result.gameName} (${result.ability})\n`;
          reportText += `   å¾—åˆ†ï¼š${Math.round(result.score)}/100\n`;
          reportText += `   å‡†ç¡®ç‡ï¼š${result.accuracy.toFixed(1)}%\n`;
          reportText += `   ç”¨æ—¶ï¼š${result.timeUsed.toFixed(1)}ç§’\n\n`;
        });

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([reportText], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `è®¤çŸ¥èƒ½åŠ›æµ‹è¯„æŠ¥å‘Š_${date}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("æŠ¥å‘Šå·²ä¸‹è½½ï¼");
      }

      // é¡µé¢åŠ è½½å®Œæˆ
      window.addEventListener("load", function () {
        console.log("æµ‹è¯„ç³»ç»Ÿå·²åŠ è½½");
      });
    </script>
  </body>
</html>
