
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è½¬æ–‡æœ¬è¾“å…¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">è¯­éŸ³è½¬æ–‡æœ¬è¾“å…¥</h1>
        
        <div class="space-y-4">
            <div class="relative">
                <input 
                    type="text" 
                    id="speechInput" 
                    placeholder="ç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯­éŸ³è¾“å…¥..."
                    class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button 
                    id="micButton" 
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-500 hover:text-blue-500 transition-colors text-xl"
                    title="ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥"
                >
                    ğŸ¤
                </button>
            </div>
            
            <div id="status" class="text-sm text-gray-600 min-h-[40px] p-2 bg-gray-50 rounded border"></div>
            
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">è¯­è¨€é€‰æ‹©ï¼š</label>
                <select id="languageSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="zh-CN">ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰</option>
                    <option value="en-US">English (US)</option>
                    <option value="ja-JP">æ—¥æœ¬èª</option>
                    <option value="ko-KR">í•œêµ­ì–´</option>
                </select>
            </div>
            
            <div class="flex space-x-2">
                <button id="clearButton" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    æ¸…ç©º
                </button>
                <button id="startButton" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    å¼€å§‹è¯†åˆ«
                </button>
                <button id="stopButton" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" style="display: none;">
                    åœæ­¢è¯†åˆ«
                </button>
            </div>
            
            <div class="text-xs text-gray-500">
                <p><strong>ç³»ç»Ÿæ£€æµ‹ï¼š</strong></p>
                <div id="systemInfo" class="mt-1"></div>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400">
            <p class="text-sm text-yellow-800">
                <strong>æ³¨æ„ï¼š</strong>
                <br>â€¢ éœ€è¦åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨ï¼ˆæœ¬åœ°å¯ä½¿ç”¨localhostï¼‰
                <br>â€¢ éœ€è¦å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™
                <br>â€¢ æ¨èä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨
            </p>
        </div>
    </div>

    <script>
        class SpeechToText {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.isSupported = false;
                this.finalTranscript = '';
                this.init();
            }

            init() {
                this.checkSystemSupport();
                this.setupRecognition();
                this.bindEvents();
                this.updateSystemInfo();
            }

            checkSystemSupport() {
                // æ£€æŸ¥HTTPS
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                const hasWebkitSpeechRecognition = 'webkitSpeechRecognition' in window;
                const hasSpeechRecognition = 'SpeechRecognition' in window;
                
                this.isSupported = isSecure && (hasWebkitSpeechRecognition || hasSpeechRecognition);
                
                if (!isSecure) {
                    this.showStatus('é”™è¯¯ï¼šè¯­éŸ³è¯†åˆ«éœ€è¦HTTPSç¯å¢ƒã€‚è¯·ä½¿ç”¨https://æˆ–localhostè®¿é—®ã€‚', 'error');
                    return false;
                }
                
                if (!hasWebkitSpeechRecognition && !hasSpeechRecognition) {
                    this.showStatus('é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚è¯·ä½¿ç”¨Chromeã€Edgeç­‰ç°ä»£æµè§ˆå™¨ã€‚', 'error');
                    return false;
                }
                
                return true;
            }

            setupRecognition() {
                if (!this.isSupported) return;

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();

                    // é…ç½®å‚æ•°
                    this.recognition.continuous = false; // æ”¹ä¸ºfalseï¼Œé¿å…è‡ªåŠ¨åœæ­¢é—®é¢˜
                    this.recognition.interimResults = true;
                    this.recognition.lang = document.getElementById('languageSelect').value;
                    this.recognition.maxAlternatives = 1;

                    this.setupRecognitionEvents();
                    this.showStatus('è¯­éŸ³è¯†åˆ«å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"æŒ‰é’®å¼€å§‹ä½¿ç”¨', 'ready');
                    
                } catch (error) {
                    this.showStatus('é”™è¯¯ï¼šæ— æ³•åˆå§‹åŒ–è¯­éŸ³è¯†åˆ« - ' + error.message, 'error');
                }
            }

            setupRecognitionEvents() {
                this.recognition.onstart = () => {
                    console.log('Recognition started');
                    this.isListening = true;
                    this.updateUI();
                    this.showStatus('ğŸ”´ æ­£åœ¨ç›‘å¬ä¸­... è¯·å¼€å§‹è¯´è¯', 'listening');
                };

                this.recognition.onend = () => {
                    console.log('Recognition ended');
                    this.isListening = false;
                    this.updateUI();
                    
                    // å¦‚æœç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼Œæ˜¾ç¤ºç›¸åº”æ¶ˆæ¯
                    if (!this.manualStop) {
                        this.showStatus('è¯­éŸ³è¯†åˆ«å·²ç»“æŸï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"ç»§ç»­', 'ready');
                        // è‡ªåŠ¨é‡æ–°å¼€å§‹ï¼ˆå¯é€‰ï¼‰
                        setTimeout(() => {
                            if (!this.isListening) {
                                this.startRecognition();
                            }
                        }, 1000);
                    } else {
                        this.showStatus('è¯­éŸ³è¯†åˆ«å·²åœæ­¢', 'ready');
                        this.manualStop = false;
                    }
                };

                this.recognition.onresult = (event) => {
                    console.log('Recognition result received');
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        const confidence = event.results[i][0].confidence;
                        
                        console.log(`Result ${i}: ${transcript} (confidence: ${confidence})`);
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // æ›´æ–°è¾“å…¥æ¡†
                    const inputElement = document.getElementById('speechInput');
                    if (finalTranscript) {
                        inputElement.value += finalTranscript + ' ';
                        this.showStatus(`âœ… è¯†åˆ«å®Œæˆ: "${finalTranscript}"`, 'success');
                    }

                    // æ˜¾ç¤ºä¸´æ—¶ç»“æœ
                    if (interimTranscript) {
                        this.showStatus(`ğŸ¯ è¯†åˆ«ä¸­: "${interimTranscript}"`, 'interim');
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('Recognition error:', event.error);
                    this.isListening = false;
                    this.updateUI();
                    
                    let errorMessage = 'è¯†åˆ«å‡ºé”™: ';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage += 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³è¾“å…¥ï¼Œè¯·é‡æ–°å°è¯•';
                            // è‡ªåŠ¨é‡æ–°å¼€å§‹
                            setTimeout(() => this.startRecognition(), 1500);
                            break;
                        case 'audio-capture':
                            errorMessage += 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                            break;
                        case 'not-allowed':
                            errorMessage += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸è®¿é—®éº¦å…‹é£';
                            break;
                        case 'network':
                            errorMessage += 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                            break;
                        case 'service-not-allowed':
                            errorMessage += 'è¯­éŸ³æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    this.showStatus(errorMessage, 'error');
                };

                this.recognition.onnomatch = () => {
                    console.log('No match found');
                    this.showStatus('æœªèƒ½è¯†åˆ«è¯­éŸ³ï¼Œè¯·é‡æ–°å°è¯•', 'warning');
                };
            }

            bindEvents() {
                const micButton = document.getElementById('micButton');
                const startButton = document.getElementById('startButton');
                const stopButton = document.getElementById('stopButton');
                const clearButton = document.getElementById('clearButton');
                const languageSelect = document.getElementById('languageSelect');

                // éº¦å…‹é£æŒ‰é’®
                micButton.addEventListener('click', () => {
                    if (this.isListening) {
                        this.stopRecognition();
                    } else {
                        this.startRecognition();
                    }
                });

                // å¼€å§‹æŒ‰é’®
                startButton.addEventListener('click', () => this.startRecognition());

                // åœæ­¢æŒ‰é’®
                stopButton.addEventListener('click', () => this.stopRecognition());

                // æ¸…ç©ºæŒ‰é’®
                clearButton.addEventListener('click', () => {
                    document.getElementById('speechInput').value = '';
                    this.showStatus('è¾“å…¥å†…å®¹å·²æ¸…ç©º', 'info');
                });

                // è¯­è¨€é€‰æ‹©
                languageSelect.addEventListener('change', (e) => {
                    if (this.recognition) {
                        this.recognition.lang = e.target.value;
                        const selectedText = e.target.options[e.target.selectedIndex].text;
                        this.showStatus(`è¯­è¨€å·²åˆ‡æ¢ä¸º: ${selectedText}`, 'info');
                    }
                });
            }

            startRecognition() {
                if (!this.isSupported || !this.recognition) {
                    this.showStatus('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨', 'error');
                    return;
                }

                if (this.isListening) {
                    this.showStatus('è¯­éŸ³è¯†åˆ«å·²åœ¨è¿è¡Œä¸­', 'warning');
                    return;
                }

                try {
                    this.manualStop = false;
                    this.recognition.start();
                    console.log('Starting recognition...');
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    this.showStatus('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
                }
            }

            stopRecognition() {
                if (!this.recognition || !this.isListening) {
                    return;
                }

                try {
                    this.manualStop = true;
                    this.recognition.stop();
                    console.log('Stopping recognition...');
                } catch (error) {
                    console.error('Error stopping recognition:', error);
                    this.showStatus('åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
                }
            }

            updateUI() {
                const micButton = document.getElementById('micButton');
                const startButton = document.getElementById('startButton');
                const stopButton = document.getElementById('stopButton');
                
                if (this.isListening) {
                    micButton.textContent = 'ğŸ”´';
                    micButton.title = 'ç‚¹å‡»åœæ­¢è¯­éŸ³è¾“å…¥';
                    startButton.style.display = 'none';
                    stopButton.style.display = 'block';
                } else {
                    micButton.textContent = 'ğŸ¤';
                    micButton.title = 'ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥';
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                }
            }

            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                
                // æ¸…é™¤ä¹‹å‰çš„æ ·å¼
                statusElement.className = 'text-sm min-h-[40px] p-2 rounded border';
                
                switch (type) {
                    case 'error':
                        statusElement.className += ' text-red-700 bg-red-50 border-red-200';
                        break;
                    case 'listening':
                        statusElement.className += ' text-green-700 bg-green-50 border-green-200 font-medium animate-pulse';
                        break;
                    case 'success':
                        statusElement.className += ' text-green-700 bg-green-50 border-green-200';
                        break;
                    case 'interim':
                        statusElement.className += ' text-blue-700 bg-blue-50 border-blue-200 italic';
                        break;
                    case 'warning':
                        statusElement.className += ' text-yellow-700 bg-yellow-50 border-yellow-200';
                        break;
                    case 'ready':
                        statusElement.className += ' text-blue-700 bg-blue-50 border-blue-200';
                        break;
                    default:
                        statusElement.className += ' text-gray-700 bg-gray-50 border-gray-200';
                }
            }

            updateSystemInfo() {
                const systemInfo = document.getElementById('systemInfo');
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
                const hasAPI = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
                const userAgent = navigator.userAgent;
                
                let info = '';
                info += `ğŸŒ åè®®: ${location.protocol} ${isSecure ? 'âœ…' : 'âŒ'}<br>`;
                info += `ğŸ™ï¸ è¯­éŸ³API: ${hasAPI ? 'âœ…' : 'âŒ'}<br>`;
                info += `ğŸ’» æµè§ˆå™¨: ${this.getBrowserName(userAgent)}<br>`;
                info += `ğŸ“ æ”¯æŒçŠ¶æ€: ${this.isSupported ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`;
                
                systemInfo.innerHTML = info;
            }

            getBrowserName(userAgent) {
                if (userAgent.includes('Chrome')) return 'Chrome';
                if (userAgent.includes('Firefox')) return 'Firefox';
                if (userAgent.includes('Safari')) return 'Safari';
                if (userAgent.includes('Edge')) return 'Edge';
                return 'æœªçŸ¥';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Speech-to-Text...');
            window.speechToText = new SpeechToText();
        });

        // æ·»åŠ æƒé™è¯·æ±‚åŠŸèƒ½
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone permission granted');
                stream.getTracks().forEach(track => track.stop()); // åœæ­¢æµ
                return true;
            } catch (error) {
                console.error('Microphone permission denied:', error);
                return false;
            }
        }

        // é¡µé¢å¯è§æ€§æ”¹å˜æ—¶çš„å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.speechToText && window.speechToText.isListening) {
                window.speechToText.stopRecognition();
            }
        });
    </script>
</body>
</html>
