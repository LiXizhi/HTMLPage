<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‰∏áÂú£ËäÇÁ≥ñÊûúÁõí - Á•ûÁßòÂïÜÂüé</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.10"></script>
    <style>
      body {
        background: url("https://cdn.keepwork.com/maisi/activities/holloween/02.jpg") center/cover no-repeat fixed;
        height: 100vh;
        overflow: hidden;
        font-family: "Arial", sans-serif;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px) rotate(-5deg);
        }
        75% {
          transform: translateX(10px) rotate(5deg);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .float-anim {
        animation: float 3s ease-in-out infinite;
      }

      .spin-anim {
        animation: spin 1s linear infinite;
      }

      .shake-anim {
        animation: shake 0.5s ease-in-out;
      }

      .fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .pulse-anim {
        animation: pulse 2s ease-in-out infinite;
      }

      .glow {
        box-shadow: 0 0 20px rgba(255, 165, 0, 0.6), 0 0 40px rgba(255, 165, 0, 0.4);
      }

      .glow-purple {
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.6), 0 0 40px rgba(147, 51, 234, 0.4);
      }

      .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(255, 165, 0, 0.3);
      }

      .reward-card {
        backdrop-filter: blur(10px);
        background: rgba(45, 27, 61, 0.8);
      }

      .tab-active {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
      }

      .rarity-common {
        border-color: #9ca3af;
      }
      .rarity-rare {
        border-color: #3b82f6;
      }
      .rarity-epic {
        border-color: #a855f7;
      }
      .rarity-legendary {
        border-color: #eab308;
      }

      .badge-vip {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
        font-weight: bold;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        position: absolute;
        top: 8px;
        right: 8px;
      }

      .item-float {
        animation: float 3s ease-in-out infinite;
      }

      .owned-badge {
        background: rgba(34, 197, 94, 0.9);
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 10px;
        position: absolute;
        bottom: 0px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        white-space: nowrap;
      }

      .item-circle {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        backdrop-filter: blur(10px);
        background: rgba(45, 27, 61, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: absolute;
      }

      .item-circle:hover {
        transform: scale(1.15);
        background: rgba(45, 27, 61, 0.9);
        box-shadow: 0 5px 20px rgba(255, 165, 0, 0.4);
      }

      @keyframes highlight {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.8), 0 0 70px rgba(255, 165, 0, 0.6);
          background: rgba(255, 215, 0, 0.7);
        }
        50% {
          box-shadow: 0 0 50px rgba(255, 255, 100, 1), 0 0 80px rgba(255, 255, 0, 1), 0 0 100px rgba(255, 200, 0, 0.8);
          background: rgba(255, 230, 0, 0.9);
        }
      }

      .item-highlight {
        animation: 0.2s ease-in-out;
        transform: scale(1.2) !important;
        transition: transform 0.15s ease-out;
      }

      .item-dimmed {
        transform: scale(0.95) !important;
        opacity: 0.7;
        transition: transform 0.15s ease-in, opacity 0.15s ease-in;
      }

      .item-selected {
        box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.8);
        background: rgba(255, 200, 0, 0.6) !important;
        transform: scale(1.25);
        transition: all 0.3s ease;
      }

      @keyframes plusOne {
        0% {
          opacity: 0;
          transform: translateY(0) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translateY(-30px) scale(1.5);
        }
        100% {
          opacity: 0;
          transform: translateY(-60px) scale(1.2);
        }
      }

      .plus-one {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.6);
        animation: plusOne 1.5s ease-out forwards;
        pointer-events: none;
        z-index: 100;
      }

      /* Tree View Styles */
      .tree-view {
        width: 220px;
        height: calc(100vh - 80px);
        position: fixed;
        left: 0;
        top: 100px;
        overflow-y: auto;
        z-index: 30;
        padding-left: 20px;
      }

      .tree-category {
        cursor: pointer;
        padding: 12px 16px;
        position: relative;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .tree-category::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(255, 255, 255, 0.9);
      }

      .tree-category::after {
        content: "‚Ä¢";
        position: absolute;
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.9);
      }

      .tree-category:hover {
        color: rgba(255, 255, 255, 1);
      }

      .tree-category.active {
        background: linear-gradient(to right, rgba(168, 85, 247, 1), transparent);
        color: rgba(255, 255, 255, 1);
      }

      .tree-category.active::after {
        color: #a855f7;
      }

      .tree-icon {
        font-size: 1.5rem;
        margin-right: 8px;
      }

      .tree-title {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .tree-count {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 2px;
      }

      @media (max-width: 768px) {
        .tree-view {
          width: 180px;
        }
      }

      /* Red dot indicator for unvisited updates */
      .update-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 10px;
        height: 10px;
        background-color: #ef4444;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        z-index: 20;
      }
    </style>
  </head>
  <body>
    <!-- Â§¥ÈÉ® -->
    <header class="bg-gradient-to-r from-purple-900 to-orange-900 px-6 py-3 flex justify-between items-center relative z-10">
      <div>
        <h1 class="text-2xl font-bold text-orange-400">üéÉ Á≥ñÊûúÁõíÔºö‰∏áÂú£ËäÇÊ¥ªÂä® üéÉ</h1>
      </div>

      <!-- Áî®Êà∑‰ΩôÈ¢ù -->
      <div class="flex gap-3 text-base">
        <div class="bg-purple-900 bg-opacity-50 px-3 py-1 rounded-full">
          <span class="text-yellow-400">üç¨ </span>
          <span class="text-white font-bold" id="userCandyCoins">500</span>
          <span class="text-yellow-400"> Á≥ñÊûúÂ∏Å</span>
        </div>
      </div>
    </header>

    <!-- Â∑¶‰æßÂàÜÁ±ªÊ†ë -->
    <div class="tree-view">
      <div id="categoryList">
        <!-- ÂàÜÁ±ªÂàóË°®Â∞ÜÂú®ËøôÈáåÁîüÊàê -->
      </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="h-[calc(100vh-80px)] relative z-10" style="margin-left: 220px">
      <div class="container mx-auto h-full flex flex-col justify-center items-center p-6">
        <!-- ‰∏≠ÂøÉÁ≥ñÊûúÁ§ºÁõí -->
        <div class="relative w-full h-full">
          <!-- ‰∏≠ÂøÉÁ§ºÁõí -->
          <div class="absolute left-1/2 top-1/4 transform -translate-x-1/2 -translate-y-1/2 z-20">
            <div class="text-center">
              <div class="text-9xl mb-2">üéÅ</div>
              <h2 class="text-4xl font-bold text-orange-300 mb-2" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)">Á≥ñÊûúÁõí</h2>
              <p class="text-purple-200 text-sm" id="boxDescription" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)">ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÂèòË∫´ËçØ‰∏∏ÔºÅ</p>
            </div>
          </div>

          <!-- ÁéØÁªïÁöÑÁâ©ÂìÅ -->
          <div id="itemsCircle" class="absolute inset-0">
            <!-- Áâ©ÂìÅÂç°ÁâáÂ∞ÜÂú®ËøôÈáåÁîüÊàê -->
          </div>
        </div>

        <!-- Â∫ïÈÉ®Ë¥≠‰π∞ÊåâÈíÆ -->
        <div class="flex gap-4 mt-8">
          <button
            onclick="buyBox(1)"
            class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-8 rounded-xl transition transform hover:scale-105 shadow-lg hover:shadow-2xl"
          >
            ÊäΩÂèñ 1 Ê¨° - üç¨100
          </button>
          <button
            onclick="buyBox(10)"
            class="bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 px-8 rounded-xl transition transform hover:scale-105 shadow-lg hover:shadow-2xl"
          >
            ÊäΩÂèñ 10 Ê¨° - üç¨1000
          </button>
        </div>
        <!-- ÊèêÁ§∫ÊñáÂ≠ó -->
        <div class="text-center mt-4">
          <p class="text-white text-opacity-70 text-sm">ÁÇπÂáªÂõæÊ†áÁõ¥Êé•‰ΩøÁî®Ôºå‰ºöÂëòÊØèÊó•ÂèØÈ¢ÜÂèñ4000Á≥ñÊûúÂ∏Å</p>
        </div>
      </div>

      <!-- ÊØèÊó•Á§ºÁõíÊåâÈíÆ -->
      <div class="fixed bottom-8 right-8 z-30">
        <button
          id="giftBoxBtn"
          onclick="openDailyGift()"
          class="relative bg-white bg-opacity-20 backdrop-blur-sm border-2 border-gray-400 hover:bg-opacity-30 text-white font-bold p-6 rounded-full transition transform hover:scale-110 shadow-2xl pulse-anim"
          title="ÊØèÊó•Á§ºÁõí"
        >
          <span class="text-5xl">üç¨</span>
          <div id="redDot" class="absolute top-1 right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white"></div>
          <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap text-base font-bold text-white bg-purple-600 px-2 py-1 rounded-full shadow-lg">Á≥ñÊûúÁ§ºÁõí</div>
        </button>
      </div>

      <!-- ÊØèÊó•Á§ºÁõíÊ®°ÊÄÅÊ°Ü -->
      <div id="giftModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-2xl p-6 max-w-md w-full glow">
          <div class="text-center">
            <div class="text-7xl mb-4">üç¨</div>
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">ÊØèÊó•Á§ºÁõí</h2>
            <div id="giftContent" class="bg-black bg-opacity-30 rounded-lg p-6 mb-4">
              <!-- Á§ºÁõíÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <button
              onclick="closeGiftModal()"
              class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
            >
              ÂÖ≥Èó≠
            </button>
          </div>
        </div>
      </div>

      <!-- ÂºÄÁÆ±Âä®ÁîªÈÅÆÁΩ© -->
      <div id="openingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
          <div id="boxIcon" class="text-9xl mb-4 pulse-anim">üéÅ</div>
          <p class="text-white text-2xl font-bold" id="openingText">Ê≠£Âú®ÊâìÂºÄÁ≥ñÊûúÁõí...</p>
        </div>
      </div>

      <!-- Â•ñÂä±Â±ïÁ§∫Ê®°ÊÄÅÊ°Ü -->
      <div id="rewardModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-md w-full glow">
          <h2 class="text-2xl font-bold text-center text-yellow-300 mb-4">üéâ ÊÅ≠ÂñúËé∑Âæó üéâ</h2>
          <div id="rewardsList" class="space-y-3 mb-6 max-h-96 overflow-y-auto">
            <!-- Â•ñÂä±ÂàóË°® -->
          </div>
          <button
            onclick="closeRewardModal()"
            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
          >
            Â§™Ê£í‰∫ÜÔºÅ
          </button>
        </div>
      </div>

      <!-- Áâ©ÂìÅËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
      <div id="itemDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-md w-full glow">
          <div class="text-center mb-4">
            <div class="text-7xl mb-3" id="itemDetailIcon"></div>
            <h2 class="text-2xl font-bold text-yellow-300 mb-2" id="itemDetailName"></h2>
            <div class="text-sm text-orange-300" id="itemDetailRarity"></div>
          </div>
          <div class="bg-black bg-opacity-30 rounded-lg p-4 mb-4">
            <p class="text-purple-200 text-center" id="itemDetailDesc"></p>
          </div>
          <div id="itemDetailOwnedSection" class="hidden bg-green-900 bg-opacity-50 rounded-lg p-3 mb-4 text-center">
            <p class="text-green-300 font-bold">Â∑≤Êã•ÊúâÔºö<span id="itemDetailOwnedCount">0</span> ‰∏™</p>
          </div>
          <div class="flex gap-3">
            <button onclick="closeItemDetailModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition">ÂÖ≥Èó≠</button>
            <button
              id="itemDetailUseBtn"
              onclick="useItemFromDetail()"
              class="hidden flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition"
            >
              Á´ãÂç≥‰ΩøÁî®
            </button>
          </div>
        </div>
      </div>

      <!-- ÈÄöÁü•ÊèêÁ§∫Ê°Ü -->
      <div id="notificationModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-sm w-full glow fade-in-up">
          <div class="text-center">
            <div class="text-6xl mb-4" id="notificationIcon">‚ÑπÔ∏è</div>
            <p class="text-white text-xl font-bold mb-2" id="notificationTitle">ÊèêÁ§∫</p>
            <p class="text-purple-200 text-base mb-4" id="notificationMessage"></p>
            <button
              onclick="closeNotification()"
              class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
            >
              Á°ÆÂÆö
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000
      });
      console.log(`Keepwork SDK initialized token: ${sdk.token}`);

      // Page name for personal page store
      const pageName = "game_activity_candybox";

      // Get all visit data from localStorage
      function getVisitData() {
        const data = localStorage.getItem('game_activity_candybox_visits');
        return data ? JSON.parse(data) : {};
      }

      // Save visit data to localStorage
      function saveVisitData(data) {
        localStorage.setItem('game_activity_candybox_visits', JSON.stringify(data));
      }

      // Check if category needs update indicator
      function needsUpdateIndicator(category) {
        if (!category.updateDate) {
          return false;
        }

        const visitData = getVisitData();
        const lastVisit = visitData[category.id];

        if (!lastVisit) {
          return true; // Never visited
        }

        // Compare dates
        const updateTime = new Date(category.updateDate).getTime();
        const visitTime = new Date(lastVisit).getTime();

        return updateTime > visitTime;
      }

      // Update last visit date for category
      function updateLastVisit(categoryId) {
        const now = new Date().toISOString();
        const visitData = getVisitData();
        visitData[categoryId] = now;
        saveVisitData(visitData);
        console.log(`Updated lastVisit for ${categoryId}: ${now}`);
      }

      // Add indicator to category element
      function addUpdateIndicator(categoryElement) {
        // Check if indicator already exists
        if (categoryElement.querySelector('.update-indicator')) return;

        const indicator = document.createElement('span');
        indicator.className = 'update-indicator';
        categoryElement.appendChild(indicator);
      }

      // Remove indicator from category element
      function removeUpdateIndicator(categoryElement) {
        const indicator = categoryElement.querySelector('.update-indicator');
        if (indicator) {
          indicator.remove();
        }
      }

      // ‰ªéURLËé∑ÂèñVIPÂèÇÊï∞Âπ∂ÁºìÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºà‰∏ç‰ºöË¢´localStorageË¶ÜÁõñÔºâ
      const urlParams = new URLSearchParams(window.location.search);
      const vipParam = urlParams.get("vip");
      // vip can be null, "0", or "1"
      const isVipUser = vipParam === "1" || vipParam === "0";

      // Ê∏∏ÊàèÊï∞ÊçÆ
      let gameData = {
        candyCoins: 500,
        inventory: [],
        history: [],
        lastClaimDate: null, // ÊúÄÂêéÈ¢ÜÂèñÊó•Êúü
        lastClaimVipStatus: null, // ‰∏äÊ¨°È¢ÜÂèñÊó∂ÁöÑVIPÁä∂ÊÄÅ
      };

      // ÂàÜÁ±ªÈÖçÁΩÆ
      const categories = [
        {
          id: "zodiac",
          name: "ÂçÅ‰∫åÁîüËÇñÂèòË∫´ËçØ‰∏∏",
          icon: "üê≤",
          description: "ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÂçÅ‰∫åÁîüËÇñÂèòË∫´ËçØ‰∏∏ÔºÅ",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/02.jpg") center/cover no-repeat fixed',
          items: [
            { id: "zodiac_rat", cmd: "/avatar ZodiacMouse", name: "Èº†ËçØ‰∏∏", icon: "üê≠", rarity: "common", vipOnly: false, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÈº†30ÂàÜÈíü" },
            { id: "zodiac_ox", cmd: "/avatar ZodiacCow", name: "ÁâõËçØ‰∏∏", icon: "üêÆ", rarity: "common", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÁâõ30ÂàÜÈíü" },
            { id: "zodiac_tiger", cmd: "/avatar ZodiacTiger", name: "ËôéËçØ‰∏∏", icon: "üêØ", rarity: "rare", vipOnly: false, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñËôé30ÂàÜÈíü" },
            { id: "zodiac_rabbit", cmd: "/avatar ZodiacRabbit", name: "ÂÖîËçØ‰∏∏", icon: "üê∞", rarity: "rare", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÂÖî30ÂàÜÈíü" },
            { id: "zodiac_dragon", cmd: "/avatar ZodiacDragon", name: "ÈæôËçØ‰∏∏", icon: "üê≤", rarity: "epic", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÈæô30ÂàÜÈíü" },
            { id: "zodiac_snake", cmd: "/avatar ZodiacSnake", name: "ËõáËçØ‰∏∏", icon: "üêç", rarity: "epic", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñËõá30ÂàÜÈíü" },
            { id: "zodiac_horse", cmd: "/avatar ZodiacHorse", name: "È©¨ËçØ‰∏∏", icon: "üê¥", rarity: "epic", vipOnly: false, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÈ©¨30ÂàÜÈíü" },
            { id: "zodiac_goat", cmd: "/avatar ZodiacSheep", name: "ÁæäËçØ‰∏∏", icon: "üêê", rarity: "rare", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÁæä30ÂàÜÈíü" },
            { id: "zodiac_monkey", cmd: "/avatar ZodiacMonkey", name: "Áå¥ËçØ‰∏∏", icon: "üêµ", rarity: "rare", vipOnly: false, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÁå¥30ÂàÜÈíü" },
            { id: "zodiac_rooster", cmd: "/avatar ZodiacCock", name: "È∏°ËçØ‰∏∏", icon: "üêî", rarity: "common", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÈ∏°30ÂàÜÈíü" },
            { id: "zodiac_dog", cmd: "/avatar ZodiacDog", name: "ÁãóËçØ‰∏∏", icon: "üê∂", rarity: "legendary", vipOnly: true, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÁãó30ÂàÜÈíü" },
            { id: "zodiac_pig", cmd: "/avatar ZodiacPig", name: "Áå™ËçØ‰∏∏", icon: "üê∑", rarity: "legendary", vipOnly: false, type: "zodiac", effect: "ÂèòË∫´ÁîüËÇñÁå™30ÂàÜÈíü" },
          ],
        },
        {
          id: "pet",
          name: "Êä±Êä±ÈæôÂùêÈ™ëËçØ‰∏∏",
          icon: "üêâ",
          description: "ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÊä±Êä±ÈæôÂèòË∫´ËçØ‰∏∏ÔºÅ",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/03.jpg") center/cover no-repeat fixed',
          items: [
            { id: "pet_pumpkin_car", cmd: "/avatar -pet NanGuaChe", name: "ÂçóÁìúËΩ¶ËçØ‰∏∏", icon: "üéÉ", rarity: "common", vipOnly: false, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´ÂçóÁìúËΩ¶30ÂàÜÈíü" },
            { id: "pet_magic_carpet", cmd: "/avatar -pet MagicAwingCarpet", name: "È≠îÊ≥ïÈ£ûÊØØËçØ‰∏∏", icon: "üßµ", rarity: "rare", vipOnly: false, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´È≠îÊ≥ïÈ£ûÊØØ30ÂàÜÈíü" },
            { id: "pet_magic_broom", cmd: "/avatar -pet MagicBesom", name: "È≠îÊ≥ïÊâ´Â∏öËçØ‰∏∏", icon: "üßπ", rarity: "rare", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´È≠îÊ≥ïÊâ´Â∏ö30ÂàÜÈíü" },
            { id: "pet_elephant", cmd: "/avatar -pet Elephant", name: "Â§ßË±°ËçØ‰∏∏", icon: "üêò", rarity: "epic", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´Â§ßË±°30ÂàÜÈíü" },
            { id: "pet_golden_dragon", cmd: "/avatar -pet GoldenDragon_02", name: "ÈáëÂ±ûÁ≥ªÈæôËçØ‰∏∏", icon: "üê≤", rarity: "epic", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´ÈáëÂ±ûÁ≥ªÈæô30ÂàÜÈíü" },
            { id: "pet_phoenix", cmd: "/avatar -pet HorsePhoenix", name: "Á∫¢Âá§Âá∞ËçØ‰∏∏", icon: "ü¶Ö", rarity: "legendary", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´Á∫¢Âá§Âá∞30ÂàÜÈíü" },
            { id: "pet_silver_wolf", cmd: "/avatar -pet HorseSilverWolf", name: "Èì∂ÁãºËçØ‰∏∏", icon: "üê∫", rarity: "epic", vipOnly: false, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´Èì∂ÁãºÂùêÈ™ë30ÂàÜÈíü" },
            { id: "pet_pink_rabbit", cmd: "/avatar -pet GrilRabbit", name: "Á≤âÂÖîËçØ‰∏∏", icon: "üê∞", rarity: "rare", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´Á≤âËâ≤ÂÖîÂ≠ê30ÂàÜÈíü" },
            { id: "pet_dog_sled", cmd: "/avatar -pet xueqiao", name: "ÁãóÊãâÈõ™Ê©áËçØ‰∏∏", icon: "üõ∑", rarity: "rare", vipOnly: false, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´ÁãóÊãâÈõ™Ê©á30ÂàÜÈíü" },
            { id: "pet_pegasus", cmd: "/avatar -pet Pegasus", name: "È£ûÈ©¨ËçØ‰∏∏", icon: "ü¶Ñ", rarity: "legendary", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´È£ûÈ©¨30ÂàÜÈíü" },
            { id: "pet_smilodon", cmd: "/avatar -pet Smilodon", name: "ÂâëÈΩøËôéËçØ‰∏∏", icon: "üêØ", rarity: "epic", vipOnly: true, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´ÂâëÈΩøËôé30ÂàÜÈíü" },
            { id: "pet_tortoise", cmd: "/avatar -pet Tortoise01", name: "‰πåÈæüËçØ‰∏∏", icon: "üê¢", rarity: "common", vipOnly: false, type: "pet", effect: "Êä±Êä±ÈæôÂèòË∫´‰πåÈæüÂùêÈ™ë30ÂàÜÈíü" },
          ],
        },
        {
          id: "monster",
          name: "ÊÄ™Áâ©ÂèòË∫´ËçØ‰∏∏",
          icon: "üëπ",
          description: "ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÊÄ™Áâ©ÂèòË∫´ËçØ‰∏∏ÔºÅ",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/05.jpg") center/cover no-repeat fixed',
          items: [
            { id: "monster_treemonster", cmd: "/avatar TreeMonster", name: "Ê†ëÊÄ™ËçØ‰∏∏", icon: "üßü", rarity: "common", vipOnly: false, type: "monster", effect: "ÂèòË∫´Ê†ëÊÄ™30ÂàÜÈíü" },
            { id: "monster_pendaman", cmd: "/avatar pendaman", name: "ËÉñËææ‰∫∫ËçØ‰∏∏", icon: "üíÄ", rarity: "common", vipOnly: true, type: "monster", effect: "ÂèòË∫´ËÉñËææ‰∫∫30ÂàÜÈíü" },
            { id: "monster_drdoctor", cmd: "/avatar DrDoctor", name: "ÊÄ™ÂåªÁîüËçØ‰∏∏", icon: "üëª", rarity: "rare", vipOnly: false, type: "monster", effect: "ÂèòË∫´ÊÄ™ÂåªÁîü30ÂàÜÈíü" },
            { id: "monster_alexander", cmd: "/avatar Alexander", name: "ÂéãÊ¢®Â±±Â§ßËçØ‰∏∏", icon: "üßõ", rarity: "rare", vipOnly: true, type: "monster", effect: "ÂèòË∫´ÂéãÊ¢®Â±±Â§ß30ÂàÜÈíü" },
            { id: "monster_deathbubble", cmd: "/avatar DeathBubble", name: "Ê≠ª‰∫°Ê≥°Ê≥°ËçØ‰∏∏", icon: "üßü‚Äç‚ôÇÔ∏è", rarity: "epic", vipOnly: true, type: "monster", effect: "ÂèòË∫´Ê≠ª‰∫°Ê≥°Ê≥°30ÂàÜÈíü" },
            { id: "monster_evilsnowman", cmd: "/avatar EvilSnowman", name: "ÈÇ™ÊÅ∂Èõ™‰∫∫ËçØ‰∏∏", icon: "üê∫", rarity: "epic", vipOnly: true, type: "monster", effect: "ÂèòË∫´ÈÇ™ÊÅ∂Èõ™‰∫∫30ÂàÜÈíü" },
            { id: "monster_witch", cmd: "/avatar AD\n/scaling 2", name: "Â•≥Â∑´ËçØ‰∏∏", icon: "üßô‚Äç‚ôÄÔ∏è", rarity: "epic", vipOnly: false, type: "monster", effect: "ÂèòË∫´ÂêâËéâÂÆâ30ÂàÜÈíü" },
            { id: "monster_guard", cmd: "/avatar Guard", name: "ËøëÂç´ËçØ‰∏∏", icon: "üíÇ", rarity: "legendary", vipOnly: true, type: "monster", effect: "ÂèòË∫´ËøëÂç´30ÂàÜÈíü" },
          ],
        },
        {
          id: "magic",
          name: "È≠îÊ≥ïÂèòË∫´ËçØ‰∏∏",
          icon: "ü™Ñ",
          description: "ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÈ≠îÊ≥ïÂèòË∫´ËçØ‰∏∏ÔºÅ",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/04.jpg") center/cover no-repeat fixed',
          items: [
            { id: "magic_scale_2x", cmd: "/scaling 2", name: "ÊîæÂ§ß2ÂÄçËçØ‰∏∏", icon: "üîç", rarity: "common", vipOnly: false, type: "magic", effect: "ËßíËâ≤ÊîæÂ§ß2ÂÄç" },
            { id: "magic_scale_half", cmd: "/scaling 0.5", name: "Áº©Â∞è1ÂÄçËçØ‰∏∏", icon: "üî¨", rarity: "common", vipOnly: true, type: "magic", effect: "ËßíËâ≤Áº©Â∞è0.5ÂÄç" },
            { id: "magic_scale_quarter", cmd: "/scaling 0.25", name: "Áº©Â∞è4ÂÄçËçØ‰∏∏", icon: "üî¨", rarity: "rare", vipOnly: false, type: "magic", effect: "ËßíËâ≤Áº©Â∞è0.25ÂÄç" },
            { id: "magic_scale_1_5x", cmd: "/scaling 1.5", name: "ÊîæÂ§ß1.5ÂÄçËçØ‰∏∏", icon: "üîç", rarity: "common", vipOnly: true, type: "magic", effect: "ËßíËâ≤ÊîæÂ§ß1.5ÂÄç" },
          ],
        },
      ];

      // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁ±ª
      let currentCategory = categories[0];

      // Á®ÄÊúâÂ∫¶ÊùÉÈáç
      const rarityWeights = {
        common: 50,
        rare: 30,
        epic: 15,
        legendary: 5,
      };

      // ÂàùÂßãÂåñ
      async function init() {
        await loadGameData();
        renderCategoryTree();
        updateUI();

        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞Ê∏≤ÊüìÁâ©ÂìÅÂ∏ÉÂ±Ä
        window.addEventListener("resize", () => {
          renderAllItems();
        });
      }

      // ÊòæÁ§∫ÈÄöÁü•ÊèêÁ§∫Ê°Ü
      function showNotification(message, icon = "‚ÑπÔ∏è", title = "ÊèêÁ§∫") {
        document.getElementById("notificationIcon").textContent = icon;
        document.getElementById("notificationTitle").textContent = title;
        document.getElementById("notificationMessage").textContent = message;
        document.getElementById("notificationModal").classList.remove("hidden");
      }

      // ÂÖ≥Èó≠ÈÄöÁü•ÊèêÁ§∫Ê°Ü
      function closeNotification() {
        document.getElementById("notificationModal").classList.add("hidden");
      }

      // Ê∏≤ÊüìÂàÜÁ±ªÊ†ë
      function renderCategoryTree() {
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = "";

        categories.forEach((category, index) => {
          // ËÆ°ÁÆóËØ•ÂàÜÁ±ªÂ∑≤Êã•ÊúâÁöÑÁâ©ÂìÅÊï∞Èáè
          const ownedCount = category.items.filter((item) => {
            const invItem = gameData.inventory.find(inv => inv.id === item.id);
            return invItem && invItem.count > 0;
          }).length;

          const div = document.createElement("div");
          div.className = `tree-category ${index === 0 ? "active" : ""}`;
          div.onclick = () => selectCategory(category);
          div.setAttribute('data-category-id', category.id);

          div.innerHTML = `
            <div class="flex items-center">
              <div class="flex-1">
                <div class="tree-title">${category.name}</div>
                <div class="tree-count">Â∑≤Ëé∑Âæó ${ownedCount}/${category.items.length}</div>
              </div>
            </div>
          `;

          categoryList.appendChild(div);

          // Add red dot indicator if category has been updated
          if (needsUpdateIndicator(category)) {
            addUpdateIndicator(div);
          }
        });
      }

      // ÈÄâÊã©ÂàÜÁ±ª
      function selectCategory(category) {
        currentCategory = category;

        // Record visit and remove indicator
        updateLastVisit(category.id);

        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        const allCategories = document.querySelectorAll(".tree-category");
        allCategories.forEach((div, index) => {
          if (categories[index].id === category.id) {
            div.classList.add("active");
            // Remove red dot indicator from selected category
            removeUpdateIndicator(div);
          } else {
            div.classList.remove("active");
          }
        });

        // Êõ¥Êñ∞ËÉåÊôØ
        document.body.style.background = category.background;

        // Êõ¥Êñ∞Á≥ñÊûúÁõíÊèèËø∞
        const boxDescription = document.getElementById("boxDescription");
        if (boxDescription) {
          boxDescription.textContent = category.description || "ÊâìÂºÄÈöèÊú∫Ëé∑ÂæóÁ•ûÁßòÂèòË∫´ËçØ‰∏∏ÔºÅ";
        }

        // ÈáçÊñ∞Ê∏≤ÊüìÁâ©ÂìÅ
        renderAllItems();
      }

      // Âä†ËΩΩÊ∏∏ÊàèÊï∞ÊçÆÔºà‰ªéSDK personal page storeÔºâ
      async function loadGameData() {
        try {
          const saved = await sdk.personalPageStore.loadPageData(pageName, "gameData");
          if (saved) {
            gameData = saved;

            // Á°Æ‰øù candyCoins ÊòØÊúâÊïàÊï∞Â≠ó
            if (typeof gameData.candyCoins !== "number" || isNaN(gameData.candyCoins)) {
              gameData.candyCoins = 200;
            }

            // È™åËØÅinventoryÊ†ºÂºèÔºåÂ¶ÇÊûú‰∏çÊòØÂØπË±°Êï∞ÁªÑÂàôÊ∏ÖÁ©∫
            if (!Array.isArray(gameData.inventory) || 
                (gameData.inventory.length > 0 && typeof gameData.inventory[0] !== 'object')) {
              console.log("Incompatible inventory format detected, resetting inventory");
              gameData.inventory = [];
            }
          }
        } catch (e) {
          console.error("Error loading game data:", e);
          // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•Ôºå‰øùÊåÅÈªòËÆ§ÂÄº
        }
      }

      // ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆ
      async function saveGameData(forceFlush = false) {
        try {
          await sdk.personalPageStore.savePageData(pageName, "gameData", gameData, forceFlush);
        } catch (e) {
          console.error("Error saving game data:", e);
        }
      }

      // Êõ¥Êñ∞UI
      function updateUI() {
        // ÈôêÂà∂ÊúÄÂ§ßÂÄº‰∏∫99999
        if (gameData.candyCoins > 99999) {
          gameData.candyCoins = 99999;
        }
        document.getElementById("userCandyCoins").textContent = gameData.candyCoins;
        renderCategoryTree();
        renderAllItems();
        updateGiftBoxButton();
      }

      // Êõ¥Êñ∞Á§ºÁõíÊåâÈíÆÁä∂ÊÄÅ
      function updateGiftBoxButton() {
        const today = new Date().toDateString();
        const isSameDay = gameData.lastClaimDate === today;
        const vipStatusChanged = !isVipUser && gameData.lastClaimVipStatus === false && isVipUser === true;
        const canClaim = !gameData.lastClaimDate || !isSameDay || (isSameDay && vipStatusChanged);
        const redDot = document.getElementById("redDot");

        if (canClaim) {
          redDot.classList.remove("hidden");
        } else {
          redDot.classList.add("hidden");
        }
      }

      // ÊâìÂºÄÊØèÊó•Á§ºÁõí
      async function openDailyGift() {
        const today = new Date().toDateString();
        const isSameDay = gameData.lastClaimDate === today;
        const vipUpgraded = isSameDay && gameData.lastClaimVipStatus === false && isVipUser === true;
        const canClaim = !gameData.lastClaimDate || !isSameDay || vipUpgraded;
        const giftContent = document.getElementById("giftContent");

        if (canClaim) {
          const amount = isVipUser ? 4000 : 300;

          // Â¶ÇÊûúÊòØVIPÂçáÁ∫ßÊÉÖÂÜµÔºåÂè™Ë°•Â∑ÆÈ¢ù
          if (vipUpgraded) {
            const bonusAmount = 4000 - 300; // VIPÂ•ñÂä± - Â∑≤È¢ÜÂèñÁöÑÊôÆÈÄöÂ•ñÂä±
            gameData.candyCoins += bonusAmount;

            if (gameData.candyCoins > 99999) {
              gameData.candyCoins = 99999;
            }

            gameData.lastClaimVipStatus = true;
            await saveGameData(true);
            updateUI();

            giftContent.innerHTML = `
              <div class="text-center">
                <div class="text-6xl mb-4">üéâ‚ú®</div>
                <p class="text-white text-xl mb-2">ÊÅ≠ÂñúÂçáÁ∫ßVIPÔºÅ</p>
                <p class="text-yellow-300 text-3xl font-bold mb-2">üç¨ +${bonusAmount} Á≥ñÊûúÂ∏Å</p>
                <p class="text-purple-200 text-sm">VIPÂçáÁ∫ßË°•ÂèëÂ•ñÂä±</p>
                <p class="text-gray-400 text-xs mt-3">Â∑≤ÂèëÊîæVIP‰∏éÊôÆÈÄöÁî®Êà∑ÁöÑÂ∑ÆÈ¢ù</p>
              </div>
            `;
          } else {
            gameData.candyCoins += amount;

            if (gameData.candyCoins > 99999) {
              gameData.candyCoins = 99999;
            }

            gameData.lastClaimDate = today;
            gameData.lastClaimVipStatus = isVipUser;
            await saveGameData(true);
            updateUI();

            giftContent.innerHTML = `
              <div class="text-center">
                <div class="text-6xl mb-4">üéâ</div>
                <p class="text-white text-xl mb-2">ÊÅ≠ÂñúËé∑Âæó</p>
                <p class="text-yellow-300 text-3xl font-bold mb-2">üç¨ ${amount} Á≥ñÊûúÂ∏Å</p>
                <p class="text-purple-200 text-sm">${isVipUser ? "VIP‰ºöÂëò‰∏ìÂ±ûÂ•ñÂä±" : "ÊôÆÈÄöÁî®Êà∑Â•ñÂä±"}</p>
                ${!isVipUser ? '<p class="text-orange-300 text-xs mt-2">‚≠ê VIP‰ºöÂëòÊØèÊó•ÂèØÈ¢ÜÂèñ 4000 Á≥ñÊûúÂ∏Å</p>' : ""}
                <p class="text-gray-400 text-xs mt-3">ÊòéÂ§©ÂÜçÊù•È¢ÜÂèñÂêßÔºÅ</p>
              </div>
            `;
          }
        } else {
          giftContent.innerHTML = `
            <div class="text-center">
              <div class="text-6xl mb-4">üòä</div>
              <p class="text-white text-xl mb-2">‰ªäÂ§©Â∑≤ÁªèÈ¢ÜÂèñËøá‰∫Ü</p>
              <p class="text-purple-200">ÊòéÂ§©ÂÜçÊù•ÂêßÔºÅ</p>
              <p class="text-gray-400 text-xs mt-3">ÊØèÊó•ÂèØÈ¢ÜÂèñÔºö${isVipUser ? "4000" : "300"} Á≥ñÊûúÂ∏Å</p>
            </div>
          `;
        }

        document.getElementById("giftModal").classList.remove("hidden");
      }

      // ÂÖ≥Èó≠Á§ºÁõíÊ®°ÊÄÅÊ°Ü
      function closeGiftModal() {
        document.getElementById("giftModal").classList.add("hidden");
      }

      // Ë¥≠‰π∞Á≥ñÊûúÁõí
      function buyBox(count) {
        const cost = count === 1 ? 100 : 1000;

        if (gameData.candyCoins < cost) {
          showNotification(`ÈúÄË¶Å ${cost} Á≥ñÊûúÂ∏ÅÊâçËÉΩÊäΩÂèñÔºåÂΩìÂâçÁ≥ñÊûúÂ∏Å‰∏çË∂≥ÔºÅ\n\nüí° ÁÇπÂáªÂè≥‰∏ãËßíÁ≥ñÊûúÁ§ºÁõíÔºåÊØèÊó•È¢ÜÂèñÁ≥ñÊûúÂ∏Å`, "üí∞", "Á≥ñÊûúÂ∏Å‰∏çË∂≥");
          return;
        }

        gameData.candyCoins -= cost;
        openBoxes(count);
      }

      // Èü≥È¢ë‰∏ä‰∏ãÊñáÔºàÁî®‰∫éÊí≠ÊîæÂêÑÁßçÂ£∞Èü≥Ôºâ
      let audioContext = null;

      // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
      }

      // Êí≠ÊîæÂìíÂìíÂìíÂ£∞Èü≥ÔºàÊóãËΩ¨Êó∂Ôºâ
      function playTickSound() {
        const ctx = initAudio();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        oscillator.frequency.value = 800;
        oscillator.type = "square";

        gainNode.gain.setValueAtTime(0.08, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);

        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.05);
      }

      // Êí≠ÊîæÂºÄÂßãÊäΩÂèñÈü≥Êïà
      function playStartSound() {
        const ctx = initAudio();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        oscillator.frequency.value = 400;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);

        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
      }

      // Êí≠ÊîæÈÄâ‰∏≠Èü≥ÊïàÔºàËêΩÂú®Êüê‰∏™icon‰∏äÔºâ
      function playSelectSound() {
        const ctx = initAudio();

        // ÂàõÂª∫‰∏§‰∏™Èü≥Ë∞ÉÁöÑÂíåÂº¶
        [600, 800].forEach((freq, index) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          const startTime = ctx.currentTime + index * 0.05;
          gainNode.gain.setValueAtTime(0.12, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);

          oscillator.start(startTime);
          oscillator.stop(startTime + 0.3);
        });
      }

      // Êí≠ÊîæËé∑ÂæóÂ•ñÂä±Èü≥Êïà
      function playRewardSound() {
        const ctx = initAudio();

        // ‰∏äÂçáÁöÑÈü≥Èò∂
        [523, 659, 784, 1047].forEach((freq, index) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          const startTime = ctx.currentTime + index * 0.08;
          gainNode.gain.setValueAtTime(0.1, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);

          oscillator.start(startTime);
          oscillator.stop(startTime + 0.15);
        });
      }

      // ÂºÄÁÆ±Âä®Áîª
      async function openBoxes(count) {
        // Êí≠ÊîæÂºÄÂßãÈü≥Êïà
        playStartSound();

        // ÁîüÊàêÂ•ñÂä±
        const rewards = generateRewards(count);

        // Áõ¥Êé•ÊâßË°åÈó™ÁÉÅÂä®Áîª
        await playDrawAnimation(rewards);

        // ÊòæÁ§∫Â•ñÂä±ÂºπÁ™ó
        showRewards(rewards);
        await saveGameData(true);
        updateUI();
      }

      // Êí≠ÊîæÊäΩÂèñÂä®Áîª
      async function playDrawAnimation(rewards) {
        const circle = document.getElementById("itemsCircle");
        const items = circle.querySelectorAll(".item-circle");

        if (items.length === 0) return;

        // ËÆ°ÁÆóÂä®ÁîªÂèÇÊï∞ÔºöÊÄªÊó∂Èïø‰∏•Ê†ºÊéßÂà∂Âú®7-9Áßí
        const minDuration = 7000; // ÊúÄÂ∞è7Áßí
        const maxDuration = 9000; // ÊúÄÂ§ß9Áßí
        const targetDuration = minDuration + Math.random() * (maxDuration - minDuration); // ÈöèÊú∫7-9Áßí
        const itemCount = items.length;
        const baseDelay = 40; // Âü∫Á°ÄÈó¥ÈöîÔºàÂø´ÈÄüËµ∑ÂßãÔºâ
        const maxDelay = 500; // ÊúÄÂ§ßÂª∂ËøüÈòàÂÄºÔºåË∂ÖËøáÊ≠§ÂÄºÁõ¥Êé•ÂÅúÊ≠¢

        // Â§öËΩÆÂæ™ÁéØÈó™ÁÉÅÊâÄÊúâIconÔºåÂ∏¶ÈÄüÂ∫¶ÈòàÂÄºÂà§Êñ≠
        let elapsedTime = 0;
        let cycle = 0;

        let shouldStop = false;

        while (elapsedTime < targetDuration && !shouldStop) {
          // ‰ΩøÁî®ÊåáÊï∞ÂáΩÊï∞ÂÆûÁé∞ÂáèÈÄü
          const progress = elapsedTime / targetDuration;
          const slowdown = Math.pow(3, progress * 4); // ÊåáÊï∞ÂáèÈÄü
          const currentDelay = baseDelay * slowdown;

          // Â¶ÇÊûúÈÄüÂ∫¶Â§™ÊÖ¢ÔºàÂª∂ËøüË∂ÖËøáÈòàÂÄºÔºâÔºåÁõ¥Êé•ÂÅúÊ≠¢
          if (currentDelay > maxDelay) {
            break;
          }

          for (let i = 0; i < items.length; i++) {
            // Ê∏ÖÈô§ÊâÄÊúâÊïàÊûú
            items.forEach((item) => {
              item.classList.remove("item-highlight", "item-dimmed");
            });

            // ÂÖ∂‰ªñIconÁº©Â∞èÂèòÊöó
            items.forEach((item, idx) => {
              if (idx !== i) {
                item.classList.add("item-dimmed");
              }
            });

            // ÂΩìÂâçIconÈ´ò‰∫ÆÂπ∂ÊîæÂ§ß
            items[i].classList.add("item-highlight");
            items[i].classList.remove("item-dimmed");

            playTickSound(); // Êí≠ÊîæÂìíÂìíÂìíÂ£∞Èü≥
            await sleep(currentDelay);

            elapsedTime += currentDelay;

            // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÊó∂ÊàñÈÄüÂ∫¶ËøáÊÖ¢
            if (elapsedTime >= targetDuration || currentDelay > maxDelay) {
              shouldStop = true;
              break;
            }
          }

          cycle++;
          if (cycle > 50) break; // ÂÆâÂÖ®‰∏äÈôê
        }

        // Ê∏ÖÈô§ÊâÄÊúâÊïàÊûú
        items.forEach((item) => {
          item.classList.remove("item-highlight", "item-dimmed");
        });

        // ÈÄê‰∏™ÊòæÁ§∫ÊúÄÁªàÁªìÊûú
        for (let i = 0; i < rewards.length; i++) {
          const reward = rewards[i];

          // ÊâæÂà∞ÂØπÂ∫îÁöÑIconÂÖÉÁ¥†
          const targetIndex = itemPositions.findIndex((pos) => pos.item.id === reward.id);
          if (targetIndex === -1) continue;

          const targetItem = items[targetIndex];

          // Êí≠ÊîæÈÄâ‰∏≠Èü≥Êïà
          playSelectSound();

          // ÊúÄÁªàÈ´ò‰∫ÆÈÄâ‰∏≠
          targetItem.classList.add("item-selected");

          // ÊòæÁ§∫+1ÊïàÊûú
          const plusOne = document.createElement("div");
          plusOne.className = "plus-one";
          plusOne.textContent = "+1";
          targetItem.appendChild(plusOne);

          // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
          await sleep(800);

          // ÁßªÈô§+1ÂÖÉÁ¥†
          setTimeout(() => {
            if (plusOne.parentNode) {
              plusOne.remove();
            }
          }, 1500);
        }

        // Á≠âÂæÖ‰∏Ä‰∏ãÂÜçÁßªÈô§ÊâÄÊúâÈ´ò‰∫Æ
        await sleep(500);
        items.forEach((item) => item.classList.remove("item-selected"));
      }

      // ËæÖÂä©ÂáΩÊï∞ÔºöÂª∂Ëøü
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // ÁîüÊàêÂ•ñÂä±
      function generateRewards(count) {
        const rewards = [];

        for (let i = 0; i < count; i++) {
          let selectedReward;

          // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ÊäΩÂèñ‰∏îËÉåÂåÖ‰∏∫Á©∫Ôºå‰øùËØÅËé∑ÂæóÈùûVIP‰∏ìÂ±ûÁâ©ÂìÅ
          if (i === 0 && gameData.inventory.length === 0) {
            const freeItems = currentCategory.items.filter((item) => !item.vipOnly);
            if (freeItems.length > 0) {
              selectedReward = getRandomReward(freeItems);
            } else {
              selectedReward = getRandomReward(currentCategory.items);
            }
          } else {
            // ‰ªéÂΩìÂâçÂàÜÁ±ªËé∑ÂèñÂ•ñÂä±
            selectedReward = getRandomReward(currentCategory.items);
          }

          if (selectedReward) {
            // Ê∑ªÂä†Âà∞ËÉåÂåÖÔºàÂ≠òÂÇ®ÂÆåÊï¥Áâ©ÂìÅ‰ø°ÊÅØÔºâ
            const existingItem = gameData.inventory.find(inv => inv.id === selectedReward.id);
            if (existingItem) {
              existingItem.count++;
            } else {
              gameData.inventory.push({
                id: selectedReward.id,
                cmd: selectedReward.cmd,
                name: selectedReward.name,
                count: 1
              });
            }
            rewards.push(selectedReward);
          }
        }

        // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
        gameData.history.unshift({
          timestamp: Date.now(),
          count: count,
          rewards: rewards,
        });

        return rewards;
      }

      // Ê†πÊçÆÁ®ÄÊúâÂ∫¶ÈöèÊú∫Ëé∑ÂèñÂ•ñÂä±
      function getRandomReward(pool) {
        const rarity = getRandomRarity();
        const filtered = pool.filter((item) => item.rarity === rarity);

        if (filtered.length === 0) {
          return pool[Math.floor(Math.random() * pool.length)];
        }

        return filtered[Math.floor(Math.random() * filtered.length)];
      }

      // ÈöèÊú∫Ëé∑ÂèñÁ®ÄÊúâÂ∫¶
      function getRandomRarity() {
        const total = Object.values(rarityWeights).reduce((a, b) => a + b, 0);
        let random = Math.random() * total;

        for (const [rarity, weight] of Object.entries(rarityWeights)) {
          random -= weight;
          if (random <= 0) {
            return rarity;
          }
        }
        return "common";
      }

      // ÊòæÁ§∫Â•ñÂä±
      function showRewards(rewards) {
        const modal = document.getElementById("rewardModal");
        const list = document.getElementById("rewardsList");

        // Êí≠ÊîæËé∑ÂæóÂ•ñÂä±Èü≥Êïà
        playRewardSound();

        list.innerHTML = "";

        rewards.forEach((reward, index) => {
          const rarityColor = {
            common: "border-gray-400",
            rare: "border-blue-400",
            epic: "border-purple-400",
            legendary: "border-yellow-400",
          }[reward.rarity];

          const item = document.createElement("div");
          item.className = `reward-card rounded-lg p-4 border-2 ${rarityColor} fade-in-up relative`;
          item.style.animationDelay = `${index * 0.1}s`;

          item.innerHTML = `
                      ${reward.vipOnly ? '<div class="badge-vip">VIP‰∏ìÂ±û</div>' : ""}
                      <div class="flex items-center gap-3">
                          <div class="text-4xl">${reward.icon}</div>
                          <div class="flex-1">
                              <div class="font-bold text-yellow-300">${reward.name}</div>
                              <div class="text-xs text-purple-200">${reward.effect}</div>
                              ${reward.vipOnly && !isVipUser ? '<div class="text-xs text-orange-400 mt-1">‚≠ê ÈúÄË¶ÅVIP‰ºöÂëòÊâçËÉΩ‰ΩøÁî®</div>' : ""}
                          </div>
                      </div>
                  `;

          list.appendChild(item);
        });

        modal.classList.remove("hidden");
      }

      // ÂÖ≥Èó≠Â•ñÂä±Ê®°ÊÄÅÊ°Ü
      function closeRewardModal() {
        document.getElementById("rewardModal").classList.add("hidden");
      }

      // Áâ©ÂìÅ‰ΩçÁΩÆÊï∞ÊçÆÔºàÁî®‰∫éÁ¢∞ÊíûÊ£ÄÊµãÔºâ
      let itemPositions = [];

      // Ê∏≤ÊüìÊâÄÊúâÁâ©ÂìÅ
      function renderAllItems() {
        const circle = document.getElementById("itemsCircle");
        circle.innerHTML = "";

        // ‰ΩøÁî®ÂΩìÂâçÂàÜÁ±ªÁöÑÁâ©ÂìÅ
        const allItems = currentCategory.items;

        // Âü∫‰∫éÁúüÂÆûÁ™óÂè£Â§ßÂ∞èËÆ°ÁÆó‰∏≠ÂøÉÂíåÂçäÂæÑ
        const treeViewWidth = 220; // Tree view width from CSS
        const windowWidth = window.innerWidth - treeViewWidth;
        const windowHeight = window.innerHeight - 80; // ÂáèÂéªheaderÈ´òÂ∫¶
        const centerX = windowWidth / 2 - 90; // Á™óÂè£Ê∞¥Âπ≥‰∏≠ÂøÉ
        const centerY = windowHeight / 2 - 130; // Á™óÂè£ÂûÇÁõ¥‰∏≠ÂøÉ
        const radiusX = Math.min(windowWidth * 0.5 - 100, 450); // Ê∞¥Âπ≥ÂçäÂæÑÔºàÊ§≠ÂúÜÈïøËΩ¥ÔºâÔºåÈôêÂà∂ÊúÄÂ§ßÂÄº
        const radiusY = Math.min(windowHeight * 0.3, 200); // ÂûÇÁõ¥ÂçäÂæÑÔºàÊ§≠ÂúÜÁü≠ËΩ¥ÔºâÔºåÈôêÂà∂ÊúÄÂ§ßÂÄº

        // Âè™Âú®‰∏ãÂçäÈÉ®ÂàÜÊéíÂàóÔºà‰ªéÂ∑¶‰∏ãÂà∞Âè≥‰∏ãÁöÑÂçäÊ§≠ÂúÜÔºâ
        const startAngle = Math.PI * -0.3; // Ëµ∑ÂßãËßíÂ∫¶Á®çÂæÆÂêë‰∏äÔºåÈÅøÂÖçËæπÁºò
        const endAngle = Math.PI * 1.3; // ÁªìÊùüËßíÂ∫¶Á®çÂæÆÂêë‰∏äÔºåÈÅøÂÖçËæπÁºò
        const angleRange = endAngle - startAngle;
        const angleStep = angleRange / (allItems.length - 1);

        // ÂàùÂßãÂåñ‰ΩçÁΩÆÊï∞ÁªÑ
        itemPositions = [];

        allItems.forEach((item, index) => {
          // ËÆ°ÁÆóÊ§≠ÂúÜ‰ΩçÁΩÆÔºà‰∏ãÂçäÈÉ®ÂàÜÔºâ
          const angle = startAngle + angleStep * index;
          const x = centerX + radiusX * Math.cos(angle);
          const y = centerY + radiusY * Math.sin(angle);

          // Â≠òÂÇ®‰ΩçÁΩÆ‰ø°ÊÅØ
          itemPositions.push({
            x: x,
            y: y,
            item: item,
            index: index,
          });
        });

        // Ëß£ÂÜ≥ÈáçÂè†ÈóÆÈ¢ò
        resolveCollisions();

        // Ê∏≤ÊüìÂÖÉÁ¥†
        itemPositions.forEach((pos, index) => {
          const item = pos.item;
          // ËÆ°ÁÆóÊã•ÊúâÊï∞ÈáèÔºà‰∏çÂåÖÊã¨Â∑≤‰ΩøÁî®ÁöÑÔºâ
          const invItem = gameData.inventory.find(inv => inv.id === item.id);
          const ownedCount = invItem ? invItem.count : 0;
          const isOwned = ownedCount > 0;
          const isLocked = item.vipOnly && !isVipUser;

          const rarityColor = {
            common: "rgba(156, 163, 175, 0.6)",
            rare: "rgba(59, 130, 246, 0.6)",
            epic: "rgba(168, 85, 247, 0.6)",
            legendary: "rgba(234, 179, 8, 0.6)",
          }[item.rarity];

          const div = document.createElement("div");
          div.className = `item-circle item-float`;
          div.style.left = `${pos.x}px`;
          div.style.top = `${pos.y}px`;
          div.style.border = `3px solid ${rarityColor}`;
          div.style.animationDelay = `${pos.index * 0.2}s`;
          div.onclick = () => showItemDetail(item, ownedCount);

          div.innerHTML = `
                    ${item.vipOnly ? '<div class="badge-vip" style="font-size: 0.6rem; padding: 1px 6px; top: 2px; right: 2px;">VIP</div>' : ""}
                    ${isOwned ? `<div class="owned-badge">Â∑≤Ëé∑Âæó(${ownedCount})</div>` : ""}
                    <div class="text-5xl mb-1">${item.icon}</div>
                    <div class="text-yellow-300 font-bold" style="font-size: 1rem;">${item.name}</div>
                `;

          circle.appendChild(div);
        });
      }

      // Á¢∞ÊíûÊ£ÄÊµãÂíåÂàÜÁ¶ª
      function resolveCollisions() {
        const itemRadius = 65; // ÂçäÂæÑÔºà130pxÁõ¥ÂæÑÁöÑ‰∏ÄÂçäÔºâ
        const minDistance = itemRadius * 2 + 10; // ÊúÄÂ∞èË∑ùÁ¶ªÔºàÊ∑ªÂä†10pxÈó¥ÈöôÔºâ
        const maxIterations = 100; // ÊúÄÂ§ßËø≠‰ª£Ê¨°Êï∞
        const damping = 0.5; // ÈòªÂ∞ºÁ≥ªÊï∞ÔºåÊéßÂà∂Êé®Âä®ÂäõÂ∫¶

        for (let iteration = 0; iteration < maxIterations; iteration++) {
          let hasCollision = false;

          for (let i = 0; i < itemPositions.length; i++) {
            for (let j = i + 1; j < itemPositions.length; j++) {
              const pos1 = itemPositions[i];
              const pos2 = itemPositions[j];

              // ËÆ°ÁÆóË∑ùÁ¶ª
              const dx = pos2.x - pos1.x;
              const dy = pos2.y - pos1.y;
              const distance = Math.sqrt(dx * dx + dy * dy);

              // Â¶ÇÊûúÈáçÂè†
              if (distance < minDistance) {
                hasCollision = true;

                // ËÆ°ÁÆóÊé®ÂºÄÁöÑÊñπÂêëÂíåÂäõÂ∫¶
                const overlap = minDistance - distance;
                const angle = Math.atan2(dy, dx);

                // Êé®ÂºÄÁöÑË∑ùÁ¶ªÔºàÊØè‰∏™Áâ©ÂìÅÁßªÂä®‰∏ÄÂçäÔºâ
                const pushDistance = (overlap / 2) * damping;

                // Êõ¥Êñ∞‰ΩçÁΩÆ
                pos1.x -= Math.cos(angle) * pushDistance;
                pos1.y -= Math.sin(angle) * pushDistance;
                pos2.x += Math.cos(angle) * pushDistance;
                pos2.y += Math.sin(angle) * pushDistance;
              }
            }
          }

          // Â¶ÇÊûúÊ≤°ÊúâÁ¢∞Êíû‰∫ÜÔºåÊèêÂâçÈÄÄÂá∫
          if (!hasCollision) {
            break;
          }
        }
      }

      // ÊòæÁ§∫Áâ©ÂìÅËØ¶ÊÉÖ
      let currentDetailItem = null;

      function showItemDetail(item, ownedCount) {
        currentDetailItem = item;
        const isLocked = item.vipOnly && !isVipUser;

        const rarityName = {
          common: "ÊôÆÈÄö",
          rare: "Á®ÄÊúâ",
          epic: "Âè≤ËØó",
          legendary: "‰º†ËØ¥",
        }[item.rarity];

        document.getElementById("itemDetailIcon").textContent = item.icon;
        document.getElementById("itemDetailName").textContent = item.name;
        document.getElementById("itemDetailRarity").textContent = `${rarityName}ÂìÅË¥®${item.vipOnly ? " ‚Ä¢ VIP‰∏ìÂ±û" : ""}`;
        document.getElementById("itemDetailDesc").textContent = item.effect;

        if (ownedCount > 0) {
          document.getElementById("itemDetailOwnedSection").classList.remove("hidden");
          document.getElementById("itemDetailOwnedCount").textContent = ownedCount;

          const useBtn = document.getElementById("itemDetailUseBtn");
          useBtn.classList.remove("hidden");

          if (isLocked) {
            useBtn.classList.add("opacity-50", "cursor-not-allowed");
            useBtn.classList.remove("hover:from-orange-600", "hover:to-orange-700");
            useBtn.innerHTML = "üîí ‰ΩøÁî®";
          } else {
            useBtn.classList.remove("opacity-50", "cursor-not-allowed");
            useBtn.classList.add("hover:from-orange-600", "hover:to-orange-700");
            useBtn.textContent = "Á´ãÂç≥‰ΩøÁî®";
          }
        } else {
          document.getElementById("itemDetailOwnedSection").classList.add("hidden");
          document.getElementById("itemDetailUseBtn").classList.add("hidden");
        }

        document.getElementById("itemDetailModal").classList.remove("hidden");
      }

      function closeItemDetailModal() {
        document.getElementById("itemDetailModal").classList.add("hidden");
        currentDetailItem = null;
      }

      async function useItemFromDetail() {
        if (!currentDetailItem) return;

        // Ê£ÄÊü•VIPÊùÉÈôê
        if (currentDetailItem.vipOnly && !isVipUser) {
          showNotification("ËØ•Áâ©ÂìÅ‰∏∫VIP‰∏ìÂ±ûÔºåÈúÄË¶ÅVIP‰ºöÂëòÊâçËÉΩ‰ΩøÁî®ÔºÅ", "üîí", "VIP‰∏ìÂ±û");
          return;
        }

        // ÊâæÂà∞ËÉåÂåÖ‰∏≠ÁöÑËØ•Áâ©ÂìÅ
        const invItem = gameData.inventory.find(inv => inv.id === currentDetailItem.id);
        if (!invItem || invItem.count <= 0) return;

        // ‰øùÂ≠òÁâ©ÂìÅ‰ø°ÊÅØÔºàÂú®ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü‰πãÂâçÔºâ
        const itemToUse = currentDetailItem;

        // ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        closeItemDetailModal();

        // ÊòæÁ§∫‰ΩøÁî®ÊïàÊûú
        showNotification(`${itemToUse.effect}`, itemToUse.icon, `Â∑≤‰ΩøÁî® ${itemToUse.name}`);

        // Â¶ÇÊûúÁâ©ÂìÅÊúâcmdÂ±ûÊÄßÔºåÂèëÈÄÅÊ∂àÊÅØÁªôÁà∂Á™óÂè£ÊâßË°åÂëΩ‰ª§
        if (itemToUse.cmd) {
          window.parent.postMessage(
            {
              type: "GameLogic.RunCommand",
              command: itemToUse.cmd,
              itemName: itemToUse.name,
            },
            "*"
          );
          window.parent.postMessage({ type: "closeGameCommon" }, "*");
        }

        // ‰ªéËÉåÂåÖ‰∏≠ÂáèÂ∞ëÊï∞ÈáèÊàñÁßªÈô§
        invItem.count--;
        if (invItem.count <= 0) {
          const index = gameData.inventory.findIndex(inv => inv.id === itemToUse.id);
          if (index !== -1) {
            gameData.inventory.splice(index, 1);
          }
        }

        await saveGameData(true);
        updateUI();
      }

      // ÂàùÂßãÂåñÊ∏∏Êàè
      init();
    </script>
  </body>
</html>
