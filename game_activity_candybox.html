<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸‡åœ£èŠ‚ç³–æœç›’ - ç¥ç§˜å•†åŸ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.10"></script>
    <style>
      body {
        background: url("https://cdn.keepwork.com/maisi/activities/holloween/02.jpg") center/cover no-repeat fixed;
        height: 100vh;
        overflow: hidden;
        font-family: "Arial", sans-serif;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px) rotate(-5deg);
        }
        75% {
          transform: translateX(10px) rotate(5deg);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .float-anim {
        animation: float 3s ease-in-out infinite;
      }

      .spin-anim {
        animation: spin 1s linear infinite;
      }

      .shake-anim {
        animation: shake 0.5s ease-in-out;
      }

      .fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .pulse-anim {
        animation: pulse 2s ease-in-out infinite;
      }

      .glow {
        box-shadow: 0 0 20px rgba(255, 165, 0, 0.6), 0 0 40px rgba(255, 165, 0, 0.4);
      }

      .glow-purple {
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.6), 0 0 40px rgba(147, 51, 234, 0.4);
      }

      .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(255, 165, 0, 0.3);
      }

      .reward-card {
        backdrop-filter: blur(10px);
        background: rgba(45, 27, 61, 0.8);
      }

      .tab-active {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
      }

      .rarity-common {
        border-color: #9ca3af;
      }
      .rarity-rare {
        border-color: #3b82f6;
      }
      .rarity-epic {
        border-color: #a855f7;
      }
      .rarity-legendary {
        border-color: #eab308;
      }

      .badge-vip {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
        font-weight: bold;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        position: absolute;
        top: 8px;
        right: 8px;
      }

      .item-float {
        animation: float 3s ease-in-out infinite;
      }

      .owned-badge {
        background: rgba(34, 197, 94, 0.9);
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 10px;
        position: absolute;
        bottom: 0px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        white-space: nowrap;
      }

      .item-circle {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        backdrop-filter: blur(10px);
        background: rgba(45, 27, 61, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: absolute;
      }

      .item-circle:hover {
        transform: scale(1.15);
        background: rgba(45, 27, 61, 0.9);
        box-shadow: 0 5px 20px rgba(255, 165, 0, 0.4);
      }

      @keyframes highlight {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.8), 0 0 70px rgba(255, 165, 0, 0.6);
          background: rgba(255, 215, 0, 0.7);
        }
        50% {
          box-shadow: 0 0 50px rgba(255, 255, 100, 1), 0 0 80px rgba(255, 255, 0, 1), 0 0 100px rgba(255, 200, 0, 0.8);
          background: rgba(255, 230, 0, 0.9);
        }
      }

      .item-highlight {
        animation: 0.2s ease-in-out;
        transform: scale(1.2) !important;
        transition: transform 0.15s ease-out;
      }

      .item-dimmed {
        transform: scale(0.95) !important;
        opacity: 0.7;
        transition: transform 0.15s ease-in, opacity 0.15s ease-in;
      }

      .item-selected {
        box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.8);
        background: rgba(255, 200, 0, 0.6) !important;
        transform: scale(1.25);
        transition: all 0.3s ease;
      }

      @keyframes plusOne {
        0% {
          opacity: 0;
          transform: translateY(0) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translateY(-30px) scale(1.5);
        }
        100% {
          opacity: 0;
          transform: translateY(-60px) scale(1.2);
        }
      }

      .plus-one {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.6);
        animation: plusOne 1.5s ease-out forwards;
        pointer-events: none;
        z-index: 100;
      }

      /* Tree View Styles */
      .tree-view {
        width: 220px;
        height: calc(100vh - 80px);
        position: fixed;
        left: 0;
        top: 100px;
        overflow-y: auto;
        z-index: 30;
        padding-left: 20px;
      }

      .tree-category {
        cursor: pointer;
        padding: 12px 16px;
        position: relative;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .tree-category::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(255, 255, 255, 0.9);
      }

      .tree-category::after {
        content: "â€¢";
        position: absolute;
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.9);
      }

      .tree-category:hover {
        color: rgba(255, 255, 255, 1);
      }

      .tree-category.active {
        background: linear-gradient(to right, rgba(168, 85, 247, 1), transparent);
        color: rgba(255, 255, 255, 1);
      }

      .tree-category.active::after {
        color: #a855f7;
      }

      .tree-icon {
        font-size: 1.5rem;
        margin-right: 8px;
      }

      .tree-title {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .tree-count {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 2px;
      }

      @media (max-width: 768px) {
        .tree-view {
          width: 180px;
        }
      }

      /* Red dot indicator for unvisited updates */
      .update-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 10px;
        height: 10px;
        background-color: #ef4444;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        z-index: 20;
      }
    </style>
  </head>
  <body>
    <!-- å¤´éƒ¨ -->
    <header class="bg-gradient-to-r from-purple-900 to-orange-900 px-6 py-3 flex justify-between items-center relative z-10">
      <div>
        <h1 class="text-2xl font-bold text-orange-400">ğŸƒ ç³–æœç›’ï¼šä¸‡åœ£èŠ‚æ´»åŠ¨ ğŸƒ</h1>
      </div>

      <!-- ç”¨æˆ·ä½™é¢ -->
      <div class="flex gap-3 text-base">
        <div class="bg-purple-900 bg-opacity-50 px-3 py-1 rounded-full">
          <span class="text-yellow-400">ğŸ¬ </span>
          <span class="text-white font-bold" id="userCandyCoins">500</span>
          <span class="text-yellow-400"> ç³–æœå¸</span>
        </div>
      </div>
    </header>

    <!-- å·¦ä¾§åˆ†ç±»æ ‘ -->
    <div class="tree-view">
      <div id="categoryList">
        <!-- åˆ†ç±»åˆ—è¡¨å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="h-[calc(100vh-80px)] relative z-10" style="margin-left: 220px">
      <div class="container mx-auto h-full flex flex-col justify-center items-center p-6">
        <!-- ä¸­å¿ƒç³–æœç¤¼ç›’ -->
        <div class="relative w-full h-full">
          <!-- ä¸­å¿ƒç¤¼ç›’ -->
          <div class="absolute left-1/2 top-1/4 transform -translate-x-1/2 -translate-y-1/2 z-20">
            <div class="text-center">
              <div class="text-9xl mb-2">ğŸ</div>
              <h2 class="text-4xl font-bold text-orange-300 mb-2" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)">ç³–æœç›’</h2>
              <p class="text-purple-200 text-sm" id="boxDescription" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)">æ‰“å¼€éšæœºè·å¾—ç¥ç§˜å˜èº«è¯ä¸¸ï¼</p>
            </div>
          </div>

          <!-- ç¯ç»•çš„ç‰©å“ -->
          <div id="itemsCircle" class="absolute inset-0">
            <!-- ç‰©å“å¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
          </div>
        </div>

        <!-- åº•éƒ¨è´­ä¹°æŒ‰é’® -->
        <div class="flex gap-4 mt-8">
          <button
            onclick="buyBox(1)"
            class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-8 rounded-xl transition transform hover:scale-105 shadow-lg hover:shadow-2xl"
          >
            æŠ½å– 1 æ¬¡ - ğŸ¬100
          </button>
          <button
            onclick="buyBox(10)"
            class="bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 px-8 rounded-xl transition transform hover:scale-105 shadow-lg hover:shadow-2xl"
          >
            æŠ½å– 10 æ¬¡ - ğŸ¬1000
          </button>
        </div>
        <!-- æç¤ºæ–‡å­— -->
        <div class="text-center mt-4">
          <p class="text-white text-opacity-70 text-sm">ç‚¹å‡»å›¾æ ‡ç›´æ¥ä½¿ç”¨ï¼Œä¼šå‘˜æ¯æ—¥å¯é¢†å–4000ç³–æœå¸</p>
        </div>
      </div>

      <!-- æ¯æ—¥ç¤¼ç›’æŒ‰é’® -->
      <div class="fixed bottom-8 right-8 z-30">
        <button
          id="giftBoxBtn"
          onclick="openDailyGift()"
          class="relative bg-white bg-opacity-20 backdrop-blur-sm border-2 border-gray-400 hover:bg-opacity-30 text-white font-bold p-6 rounded-full transition transform hover:scale-110 shadow-2xl pulse-anim"
          title="æ¯æ—¥ç¤¼ç›’"
        >
          <span class="text-5xl">ğŸ¬</span>
          <div id="redDot" class="absolute top-1 right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white"></div>
          <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap text-base font-bold text-white bg-purple-600 px-2 py-1 rounded-full shadow-lg">ç³–æœç¤¼ç›’</div>
        </button>
      </div>

      <!-- æ¯æ—¥ç¤¼ç›’æ¨¡æ€æ¡† -->
      <div id="giftModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-2xl p-6 max-w-md w-full glow">
          <div class="text-center">
            <div class="text-7xl mb-4">ğŸ¬</div>
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">æ¯æ—¥ç¤¼ç›’</h2>
            <div id="giftContent" class="bg-black bg-opacity-30 rounded-lg p-6 mb-4">
              <!-- ç¤¼ç›’å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <button
              onclick="closeGiftModal()"
              class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
            >
              å…³é—­
            </button>
          </div>
        </div>
      </div>

      <!-- å¼€ç®±åŠ¨ç”»é®ç½© -->
      <div id="openingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
          <div id="boxIcon" class="text-9xl mb-4 pulse-anim">ğŸ</div>
          <p class="text-white text-2xl font-bold" id="openingText">æ­£åœ¨æ‰“å¼€ç³–æœç›’...</p>
        </div>
      </div>

      <!-- å¥–åŠ±å±•ç¤ºæ¨¡æ€æ¡† -->
      <div id="rewardModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-md w-full glow">
          <h2 class="text-2xl font-bold text-center text-yellow-300 mb-4">ğŸ‰ æ­å–œè·å¾— ğŸ‰</h2>
          <div id="rewardsList" class="space-y-3 mb-6 max-h-96 overflow-y-auto">
            <!-- å¥–åŠ±åˆ—è¡¨ -->
          </div>
          <button
            onclick="closeRewardModal()"
            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
          >
            å¤ªæ£’äº†ï¼
          </button>
        </div>
      </div>

      <!-- ç‰©å“è¯¦æƒ…æ¨¡æ€æ¡† -->
      <div id="itemDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-md w-full glow">
          <div class="text-center mb-4">
            <div class="text-7xl mb-3" id="itemDetailIcon"></div>
            <h2 class="text-2xl font-bold text-yellow-300 mb-2" id="itemDetailName"></h2>
            <div class="text-sm text-orange-300" id="itemDetailRarity"></div>
          </div>
          <div class="bg-black bg-opacity-30 rounded-lg p-4 mb-4">
            <p class="text-purple-200 text-center" id="itemDetailDesc"></p>
          </div>
          <div id="itemDetailOwnedSection" class="hidden bg-green-900 bg-opacity-50 rounded-lg p-3 mb-4 text-center">
            <p class="text-green-300 font-bold">å·²æ‹¥æœ‰ï¼š<span id="itemDetailOwnedCount">0</span> ä¸ª</p>
          </div>
          <div class="flex gap-3">
            <button onclick="closeItemDetailModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition">å…³é—­</button>
            <button
              id="itemDetailUseBtn"
              onclick="useItemFromDetail()"
              class="hidden flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition"
            >
              ç«‹å³ä½¿ç”¨
            </button>
          </div>
        </div>
      </div>

      <!-- é€šçŸ¥æç¤ºæ¡† -->
      <div id="notificationModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-orange-900 rounded-2xl p-6 max-w-sm w-full glow fade-in-up">
          <div class="text-center">
            <div class="text-6xl mb-4" id="notificationIcon">â„¹ï¸</div>
            <p class="text-white text-xl font-bold mb-2" id="notificationTitle">æç¤º</p>
            <p class="text-purple-200 text-base mb-4" id="notificationMessage"></p>
            <button
              onclick="closeNotification()"
              class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105"
            >
              ç¡®å®š
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000
      });
      console.log(`Keepwork SDK initialized token: ${sdk.token}`);

      // Page name for personal page store
      const pageName = "game_activity_candybox";

      // Get all visit data from localStorage
      function getVisitData() {
        const data = localStorage.getItem('game_activity_candybox_visits');
        return data ? JSON.parse(data) : {};
      }

      // Save visit data to localStorage
      function saveVisitData(data) {
        localStorage.setItem('game_activity_candybox_visits', JSON.stringify(data));
      }

      // Check if category needs update indicator
      function needsUpdateIndicator(category) {
        if (!category.updateDate) {
          return false;
        }

        const visitData = getVisitData();
        const lastVisit = visitData[category.id];

        if (!lastVisit) {
          return true; // Never visited
        }

        // Compare dates
        const updateTime = new Date(category.updateDate).getTime();
        const visitTime = new Date(lastVisit).getTime();

        return updateTime > visitTime;
      }

      // Update last visit date for category
      function updateLastVisit(categoryId) {
        const now = new Date().toISOString();
        const visitData = getVisitData();
        visitData[categoryId] = now;
        saveVisitData(visitData);
        console.log(`Updated lastVisit for ${categoryId}: ${now}`);
      }

      // Add indicator to category element
      function addUpdateIndicator(categoryElement) {
        // Check if indicator already exists
        if (categoryElement.querySelector('.update-indicator')) return;

        const indicator = document.createElement('span');
        indicator.className = 'update-indicator';
        categoryElement.appendChild(indicator);
      }

      // Remove indicator from category element
      function removeUpdateIndicator(categoryElement) {
        const indicator = categoryElement.querySelector('.update-indicator');
        if (indicator) {
          indicator.remove();
        }
      }

      // ä»URLè·å–VIPå‚æ•°å¹¶ç¼“å­˜åˆ°å…¨å±€å˜é‡ï¼ˆä¸ä¼šè¢«localStorageè¦†ç›–ï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      const vipParam = urlParams.get("vip");
      // vip can be null, "0", or "1"
      const isVipUser = vipParam === "1" || vipParam === "0";

      // æ¸¸æˆæ•°æ®
      let gameData = {
        candyCoins: 500,
        inventory: [],
        history: [],
        lastClaimDate: null, // æœ€åé¢†å–æ—¥æœŸ
        lastClaimVipStatus: null, // ä¸Šæ¬¡é¢†å–æ—¶çš„VIPçŠ¶æ€
      };

      // åˆ†ç±»é…ç½®
      const categories = [
        {
          id: "zodiac",
          name: "åäºŒç”Ÿè‚–å˜èº«è¯ä¸¸",
          icon: "ğŸ²",
          description: "æ‰“å¼€éšæœºè·å¾—ç¥ç§˜åäºŒç”Ÿè‚–å˜èº«è¯ä¸¸ï¼",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/02.jpg") center/cover no-repeat fixed',
          items: [
            { id: "zodiac_rat", cmd: "/avatar ZodiacMouse", name: "é¼ è¯ä¸¸", icon: "ğŸ­", rarity: "common", vipOnly: false, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–é¼ 30åˆ†é’Ÿ" },
            { id: "zodiac_ox", cmd: "/avatar ZodiacCow", name: "ç‰›è¯ä¸¸", icon: "ğŸ®", rarity: "common", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–ç‰›30åˆ†é’Ÿ" },
            { id: "zodiac_tiger", cmd: "/avatar ZodiacTiger", name: "è™è¯ä¸¸", icon: "ğŸ¯", rarity: "rare", vipOnly: false, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–è™30åˆ†é’Ÿ" },
            { id: "zodiac_rabbit", cmd: "/avatar ZodiacRabbit", name: "å…”è¯ä¸¸", icon: "ğŸ°", rarity: "rare", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–å…”30åˆ†é’Ÿ" },
            { id: "zodiac_dragon", cmd: "/avatar ZodiacDragon", name: "é¾™è¯ä¸¸", icon: "ğŸ²", rarity: "epic", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–é¾™30åˆ†é’Ÿ" },
            { id: "zodiac_snake", cmd: "/avatar ZodiacSnake", name: "è›‡è¯ä¸¸", icon: "ğŸ", rarity: "epic", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–è›‡30åˆ†é’Ÿ" },
            { id: "zodiac_horse", cmd: "/avatar ZodiacHorse", name: "é©¬è¯ä¸¸", icon: "ğŸ´", rarity: "epic", vipOnly: false, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–é©¬30åˆ†é’Ÿ" },
            { id: "zodiac_goat", cmd: "/avatar ZodiacSheep", name: "ç¾Šè¯ä¸¸", icon: "ğŸ", rarity: "rare", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–ç¾Š30åˆ†é’Ÿ" },
            { id: "zodiac_monkey", cmd: "/avatar ZodiacMonkey", name: "çŒ´è¯ä¸¸", icon: "ğŸµ", rarity: "rare", vipOnly: false, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–çŒ´30åˆ†é’Ÿ" },
            { id: "zodiac_rooster", cmd: "/avatar ZodiacCock", name: "é¸¡è¯ä¸¸", icon: "ğŸ”", rarity: "common", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–é¸¡30åˆ†é’Ÿ" },
            { id: "zodiac_dog", cmd: "/avatar ZodiacDog", name: "ç‹—è¯ä¸¸", icon: "ğŸ¶", rarity: "legendary", vipOnly: true, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–ç‹—30åˆ†é’Ÿ" },
            { id: "zodiac_pig", cmd: "/avatar ZodiacPig", name: "çŒªè¯ä¸¸", icon: "ğŸ·", rarity: "legendary", vipOnly: false, type: "zodiac", effect: "å˜èº«ç”Ÿè‚–çŒª30åˆ†é’Ÿ" },
          ],
        },
        {
          id: "pet",
          name: "æŠ±æŠ±é¾™åéª‘è¯ä¸¸",
          icon: "ğŸ‰",
          description: "æ‰“å¼€éšæœºè·å¾—ç¥ç§˜æŠ±æŠ±é¾™å˜èº«è¯ä¸¸ï¼",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/03.jpg") center/cover no-repeat fixed',
          items: [
            { id: "pet_pumpkin_car", cmd: "/avatar -pet NanGuaChe", name: "å—ç“œè½¦è¯ä¸¸", icon: "ğŸƒ", rarity: "common", vipOnly: false, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«å—ç“œè½¦30åˆ†é’Ÿ" },
            { id: "pet_magic_carpet", cmd: "/avatar -pet MagicAwingCarpet", name: "é­”æ³•é£æ¯¯è¯ä¸¸", icon: "ğŸ§µ", rarity: "rare", vipOnly: false, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«é­”æ³•é£æ¯¯30åˆ†é’Ÿ" },
            { id: "pet_magic_broom", cmd: "/avatar -pet MagicBesom", name: "é­”æ³•æ‰«å¸šè¯ä¸¸", icon: "ğŸ§¹", rarity: "rare", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«é­”æ³•æ‰«å¸š30åˆ†é’Ÿ" },
            { id: "pet_elephant", cmd: "/avatar -pet Elephant", name: "å¤§è±¡è¯ä¸¸", icon: "ğŸ˜", rarity: "epic", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«å¤§è±¡30åˆ†é’Ÿ" },
            { id: "pet_golden_dragon", cmd: "/avatar -pet GoldenDragon_02", name: "é‡‘å±ç³»é¾™è¯ä¸¸", icon: "ğŸ²", rarity: "epic", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«é‡‘å±ç³»é¾™30åˆ†é’Ÿ" },
            { id: "pet_phoenix", cmd: "/avatar -pet HorsePhoenix", name: "çº¢å‡¤å‡°è¯ä¸¸", icon: "ğŸ¦…", rarity: "legendary", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«çº¢å‡¤å‡°30åˆ†é’Ÿ" },
            { id: "pet_silver_wolf", cmd: "/avatar -pet HorseSilverWolf", name: "é“¶ç‹¼è¯ä¸¸", icon: "ğŸº", rarity: "epic", vipOnly: false, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«é“¶ç‹¼åéª‘30åˆ†é’Ÿ" },
            { id: "pet_pink_rabbit", cmd: "/avatar -pet GrilRabbit", name: "ç²‰å…”è¯ä¸¸", icon: "ğŸ°", rarity: "rare", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«ç²‰è‰²å…”å­30åˆ†é’Ÿ" },
            { id: "pet_dog_sled", cmd: "/avatar -pet xueqiao", name: "ç‹—æ‹‰é›ªæ©‡è¯ä¸¸", icon: "ğŸ›·", rarity: "rare", vipOnly: false, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«ç‹—æ‹‰é›ªæ©‡30åˆ†é’Ÿ" },
            { id: "pet_pegasus", cmd: "/avatar -pet Pegasus", name: "é£é©¬è¯ä¸¸", icon: "ğŸ¦„", rarity: "legendary", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«é£é©¬30åˆ†é’Ÿ" },
            { id: "pet_smilodon", cmd: "/avatar -pet Smilodon", name: "å‰‘é½¿è™è¯ä¸¸", icon: "ğŸ¯", rarity: "epic", vipOnly: true, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«å‰‘é½¿è™30åˆ†é’Ÿ" },
            { id: "pet_tortoise", cmd: "/avatar -pet Tortoise01", name: "ä¹Œé¾Ÿè¯ä¸¸", icon: "ğŸ¢", rarity: "common", vipOnly: false, type: "pet", effect: "æŠ±æŠ±é¾™å˜èº«ä¹Œé¾Ÿåéª‘30åˆ†é’Ÿ" },
          ],
        },
        {
          id: "monster",
          name: "æ€ªç‰©å˜èº«è¯ä¸¸",
          icon: "ğŸ‘¹",
          description: "æ‰“å¼€éšæœºè·å¾—ç¥ç§˜æ€ªç‰©å˜èº«è¯ä¸¸ï¼",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/05.jpg") center/cover no-repeat fixed',
          items: [
            { id: "monster_treemonster", cmd: "/avatar TreeMonster", name: "æ ‘æ€ªè¯ä¸¸", icon: "ğŸ§Ÿ", rarity: "common", vipOnly: false, type: "monster", effect: "å˜èº«æ ‘æ€ª30åˆ†é’Ÿ" },
            { id: "monster_pendaman", cmd: "/avatar pendaman", name: "èƒ–è¾¾äººè¯ä¸¸", icon: "ğŸ’€", rarity: "common", vipOnly: true, type: "monster", effect: "å˜èº«èƒ–è¾¾äºº30åˆ†é’Ÿ" },
            { id: "monster_drdoctor", cmd: "/avatar DrDoctor", name: "æ€ªåŒ»ç”Ÿè¯ä¸¸", icon: "ğŸ‘»", rarity: "rare", vipOnly: false, type: "monster", effect: "å˜èº«æ€ªåŒ»ç”Ÿ30åˆ†é’Ÿ" },
            { id: "monster_alexander", cmd: "/avatar Alexander", name: "å‹æ¢¨å±±å¤§è¯ä¸¸", icon: "ğŸ§›", rarity: "rare", vipOnly: true, type: "monster", effect: "å˜èº«å‹æ¢¨å±±å¤§30åˆ†é’Ÿ" },
            { id: "monster_deathbubble", cmd: "/avatar DeathBubble", name: "æ­»äº¡æ³¡æ³¡è¯ä¸¸", icon: "ğŸ§Ÿâ€â™‚ï¸", rarity: "epic", vipOnly: true, type: "monster", effect: "å˜èº«æ­»äº¡æ³¡æ³¡30åˆ†é’Ÿ" },
            { id: "monster_evilsnowman", cmd: "/avatar EvilSnowman", name: "é‚ªæ¶é›ªäººè¯ä¸¸", icon: "ğŸº", rarity: "epic", vipOnly: true, type: "monster", effect: "å˜èº«é‚ªæ¶é›ªäºº30åˆ†é’Ÿ" },
            { id: "monster_witch", cmd: "/avatar AD\n/scaling 2", name: "å¥³å·«è¯ä¸¸", icon: "ğŸ§™â€â™€ï¸", rarity: "epic", vipOnly: false, type: "monster", effect: "å˜èº«å‰è‰å®‰30åˆ†é’Ÿ" },
            { id: "monster_guard", cmd: "/avatar Guard", name: "è¿‘å«è¯ä¸¸", icon: "ğŸ’‚", rarity: "legendary", vipOnly: true, type: "monster", effect: "å˜èº«è¿‘å«30åˆ†é’Ÿ" },
          ],
        },
        {
          id: "magic",
          name: "é­”æ³•å˜èº«è¯ä¸¸",
          icon: "ğŸª„",
          description: "æ‰“å¼€éšæœºè·å¾—ç¥ç§˜é­”æ³•å˜èº«è¯ä¸¸ï¼",
          updateDate: "2025-10-24",
          background: 'url("https://cdn.keepwork.com/maisi/activities/holloween/04.jpg") center/cover no-repeat fixed',
          items: [
            { id: "magic_scale_2x", cmd: "/scaling 2", name: "æ”¾å¤§2å€è¯ä¸¸", icon: "ğŸ”", rarity: "common", vipOnly: false, type: "magic", effect: "è§’è‰²æ”¾å¤§2å€" },
            { id: "magic_scale_half", cmd: "/scaling 0.5", name: "ç¼©å°1å€è¯ä¸¸", icon: "ğŸ”¬", rarity: "common", vipOnly: true, type: "magic", effect: "è§’è‰²ç¼©å°0.5å€" },
            { id: "magic_scale_quarter", cmd: "/scaling 0.25", name: "ç¼©å°4å€è¯ä¸¸", icon: "ğŸ”¬", rarity: "rare", vipOnly: false, type: "magic", effect: "è§’è‰²ç¼©å°0.25å€" },
            { id: "magic_scale_1_5x", cmd: "/scaling 1.5", name: "æ”¾å¤§1.5å€è¯ä¸¸", icon: "ğŸ”", rarity: "common", vipOnly: true, type: "magic", effect: "è§’è‰²æ”¾å¤§1.5å€" },
          ],
        },
      ];

      // å½“å‰é€‰ä¸­çš„åˆ†ç±»
      let currentCategory = categories[0];

      // ç¨€æœ‰åº¦æƒé‡
      const rarityWeights = {
        common: 50,
        rare: 30,
        epic: 15,
        legendary: 5,
      };

      // åˆå§‹åŒ–
      async function init() {
        await loadGameData();
        renderCategoryTree();
        updateUI();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“ç‰©å“å¸ƒå±€
        window.addEventListener("resize", () => {
          renderAllItems();
        });
      }

      // æ˜¾ç¤ºé€šçŸ¥æç¤ºæ¡†
      function showNotification(message, icon = "â„¹ï¸", title = "æç¤º") {
        document.getElementById("notificationIcon").textContent = icon;
        document.getElementById("notificationTitle").textContent = title;
        document.getElementById("notificationMessage").textContent = message;
        document.getElementById("notificationModal").classList.remove("hidden");
      }

      // å…³é—­é€šçŸ¥æç¤ºæ¡†
      function closeNotification() {
        document.getElementById("notificationModal").classList.add("hidden");
      }

      // æ¸²æŸ“åˆ†ç±»æ ‘
      function renderCategoryTree() {
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = "";

        categories.forEach((category, index) => {
          // è®¡ç®—è¯¥åˆ†ç±»å·²æ‹¥æœ‰çš„ç‰©å“æ•°é‡
          const ownedCount = category.items.filter((item) => {
            const invItem = gameData.inventory.find(inv => inv.id === item.id);
            return invItem && invItem.count > 0;
          }).length;

          const div = document.createElement("div");
          div.className = `tree-category ${index === 0 ? "active" : ""}`;
          div.onclick = () => selectCategory(category);
          div.setAttribute('data-category-id', category.id);

          div.innerHTML = `
            <div class="flex items-center">
              <div class="flex-1">
                <div class="tree-title">${category.name}</div>
                <div class="tree-count">å·²è·å¾— ${ownedCount}/${category.items.length}</div>
              </div>
            </div>
          `;

          categoryList.appendChild(div);

          // Add red dot indicator if category has been updated
          if (needsUpdateIndicator(category)) {
            addUpdateIndicator(div);
          }
        });
      }

      // é€‰æ‹©åˆ†ç±»
      function selectCategory(category) {
        currentCategory = category;

        // Record visit and remove indicator
        updateLastVisit(category.id);

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        const allCategories = document.querySelectorAll(".tree-category");
        allCategories.forEach((div, index) => {
          if (categories[index].id === category.id) {
            div.classList.add("active");
            // Remove red dot indicator from selected category
            removeUpdateIndicator(div);
          } else {
            div.classList.remove("active");
          }
        });

        // æ›´æ–°èƒŒæ™¯
        document.body.style.background = category.background;

        // æ›´æ–°ç³–æœç›’æè¿°
        const boxDescription = document.getElementById("boxDescription");
        if (boxDescription) {
          boxDescription.textContent = category.description || "æ‰“å¼€éšæœºè·å¾—ç¥ç§˜å˜èº«è¯ä¸¸ï¼";
        }

        // é‡æ–°æ¸²æŸ“ç‰©å“
        renderAllItems();
      }

      // åŠ è½½æ¸¸æˆæ•°æ®ï¼ˆä»SDK personal page storeï¼‰
      async function loadGameData() {
        try {
          const saved = await sdk.personalPageStore.loadPageData(pageName, "gameData");
          if (saved) {
            gameData = saved;

            // ç¡®ä¿ candyCoins æ˜¯æœ‰æ•ˆæ•°å­—
            if (typeof gameData.candyCoins !== "number" || isNaN(gameData.candyCoins)) {
              gameData.candyCoins = 200;
            }

            // éªŒè¯inventoryæ ¼å¼ï¼Œå¦‚æœä¸æ˜¯å¯¹è±¡æ•°ç»„åˆ™æ¸…ç©º
            if (!Array.isArray(gameData.inventory) || 
                (gameData.inventory.length > 0 && typeof gameData.inventory[0] !== 'object')) {
              console.log("Incompatible inventory format detected, resetting inventory");
              gameData.inventory = [];
            }
          }
        } catch (e) {
          console.error("Error loading game data:", e);
          // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¿æŒé»˜è®¤å€¼
        }
      }

      // ä¿å­˜æ¸¸æˆæ•°æ®
      async function saveGameData(forceFlush = false) {
        try {
          await sdk.personalPageStore.savePageData(pageName, "gameData", gameData, forceFlush);
        } catch (e) {
          console.error("Error saving game data:", e);
        }
      }

      // æ›´æ–°UI
      function updateUI() {
        // é™åˆ¶æœ€å¤§å€¼ä¸º99999
        if (gameData.candyCoins > 99999) {
          gameData.candyCoins = 99999;
        }
        document.getElementById("userCandyCoins").textContent = gameData.candyCoins;
        renderCategoryTree();
        renderAllItems();
        updateGiftBoxButton();
      }

      // æ›´æ–°ç¤¼ç›’æŒ‰é’®çŠ¶æ€
      function updateGiftBoxButton() {
        const today = new Date().toDateString();
        const isSameDay = gameData.lastClaimDate === today;
        const vipStatusChanged = !isVipUser && gameData.lastClaimVipStatus === false && isVipUser === true;
        const canClaim = !gameData.lastClaimDate || !isSameDay || (isSameDay && vipStatusChanged);
        const redDot = document.getElementById("redDot");

        if (canClaim) {
          redDot.classList.remove("hidden");
        } else {
          redDot.classList.add("hidden");
        }
      }

      // æ‰“å¼€æ¯æ—¥ç¤¼ç›’
      async function openDailyGift() {
        const today = new Date().toDateString();
        const isSameDay = gameData.lastClaimDate === today;
        const vipUpgraded = isSameDay && gameData.lastClaimVipStatus === false && isVipUser === true;
        const canClaim = !gameData.lastClaimDate || !isSameDay || vipUpgraded;
        const giftContent = document.getElementById("giftContent");

        if (canClaim) {
          const amount = isVipUser ? 4000 : 300;

          // å¦‚æœæ˜¯VIPå‡çº§æƒ…å†µï¼Œåªè¡¥å·®é¢
          if (vipUpgraded) {
            const bonusAmount = 4000 - 300; // VIPå¥–åŠ± - å·²é¢†å–çš„æ™®é€šå¥–åŠ±
            gameData.candyCoins += bonusAmount;

            if (gameData.candyCoins > 99999) {
              gameData.candyCoins = 99999;
            }

            gameData.lastClaimVipStatus = true;
            await saveGameData(true);
            updateUI();

            giftContent.innerHTML = `
              <div class="text-center">
                <div class="text-6xl mb-4">ğŸ‰âœ¨</div>
                <p class="text-white text-xl mb-2">æ­å–œå‡çº§VIPï¼</p>
                <p class="text-yellow-300 text-3xl font-bold mb-2">ğŸ¬ +${bonusAmount} ç³–æœå¸</p>
                <p class="text-purple-200 text-sm">VIPå‡çº§è¡¥å‘å¥–åŠ±</p>
                <p class="text-gray-400 text-xs mt-3">å·²å‘æ”¾VIPä¸æ™®é€šç”¨æˆ·çš„å·®é¢</p>
              </div>
            `;
          } else {
            gameData.candyCoins += amount;

            if (gameData.candyCoins > 99999) {
              gameData.candyCoins = 99999;
            }

            gameData.lastClaimDate = today;
            gameData.lastClaimVipStatus = isVipUser;
            await saveGameData(true);
            updateUI();

            giftContent.innerHTML = `
              <div class="text-center">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <p class="text-white text-xl mb-2">æ­å–œè·å¾—</p>
                <p class="text-yellow-300 text-3xl font-bold mb-2">ğŸ¬ ${amount} ç³–æœå¸</p>
                <p class="text-purple-200 text-sm">${isVipUser ? "VIPä¼šå‘˜ä¸“å±å¥–åŠ±" : "æ™®é€šç”¨æˆ·å¥–åŠ±"}</p>
                ${!isVipUser ? '<p class="text-orange-300 text-xs mt-2">â­ VIPä¼šå‘˜æ¯æ—¥å¯é¢†å– 4000 ç³–æœå¸</p>' : ""}
                <p class="text-gray-400 text-xs mt-3">æ˜å¤©å†æ¥é¢†å–å§ï¼</p>
              </div>
            `;
          }
        } else {
          giftContent.innerHTML = `
            <div class="text-center">
              <div class="text-6xl mb-4">ğŸ˜Š</div>
              <p class="text-white text-xl mb-2">ä»Šå¤©å·²ç»é¢†å–è¿‡äº†</p>
              <p class="text-purple-200">æ˜å¤©å†æ¥å§ï¼</p>
              <p class="text-gray-400 text-xs mt-3">æ¯æ—¥å¯é¢†å–ï¼š${isVipUser ? "4000" : "300"} ç³–æœå¸</p>
            </div>
          `;
        }

        document.getElementById("giftModal").classList.remove("hidden");
      }

      // å…³é—­ç¤¼ç›’æ¨¡æ€æ¡†
      function closeGiftModal() {
        document.getElementById("giftModal").classList.add("hidden");
      }

      // è´­ä¹°ç³–æœç›’
      function buyBox(count) {
        const cost = count === 1 ? 100 : 1000;

        if (gameData.candyCoins < cost) {
          showNotification(`éœ€è¦ ${cost} ç³–æœå¸æ‰èƒ½æŠ½å–ï¼Œå½“å‰ç³–æœå¸ä¸è¶³ï¼\n\nğŸ’¡ ç‚¹å‡»å³ä¸‹è§’ç³–æœç¤¼ç›’ï¼Œæ¯æ—¥é¢†å–ç³–æœå¸`, "ğŸ’°", "ç³–æœå¸ä¸è¶³");
          return;
        }

        gameData.candyCoins -= cost;
        openBoxes(count);
      }

      // éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨äºæ’­æ”¾å„ç§å£°éŸ³ï¼‰
      let audioContext = null;

      // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
      }

      // æ’­æ”¾å“’å“’å“’å£°éŸ³ï¼ˆæ—‹è½¬æ—¶ï¼‰
      function playTickSound() {
        const ctx = initAudio();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        oscillator.frequency.value = 800;
        oscillator.type = "square";

        gainNode.gain.setValueAtTime(0.08, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);

        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.05);
      }

      // æ’­æ”¾å¼€å§‹æŠ½å–éŸ³æ•ˆ
      function playStartSound() {
        const ctx = initAudio();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        oscillator.frequency.value = 400;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);

        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
      }

      // æ’­æ”¾é€‰ä¸­éŸ³æ•ˆï¼ˆè½åœ¨æŸä¸ªiconä¸Šï¼‰
      function playSelectSound() {
        const ctx = initAudio();

        // åˆ›å»ºä¸¤ä¸ªéŸ³è°ƒçš„å’Œå¼¦
        [600, 800].forEach((freq, index) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          const startTime = ctx.currentTime + index * 0.05;
          gainNode.gain.setValueAtTime(0.12, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);

          oscillator.start(startTime);
          oscillator.stop(startTime + 0.3);
        });
      }

      // æ’­æ”¾è·å¾—å¥–åŠ±éŸ³æ•ˆ
      function playRewardSound() {
        const ctx = initAudio();

        // ä¸Šå‡çš„éŸ³é˜¶
        [523, 659, 784, 1047].forEach((freq, index) => {
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          const startTime = ctx.currentTime + index * 0.08;
          gainNode.gain.setValueAtTime(0.1, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);

          oscillator.start(startTime);
          oscillator.stop(startTime + 0.15);
        });
      }

      // å¼€ç®±åŠ¨ç”»
      async function openBoxes(count) {
        // æ’­æ”¾å¼€å§‹éŸ³æ•ˆ
        playStartSound();

        // ç”Ÿæˆå¥–åŠ±
        const rewards = generateRewards(count);

        // ç›´æ¥æ‰§è¡Œé—ªçƒåŠ¨ç”»
        await playDrawAnimation(rewards);

        // æ˜¾ç¤ºå¥–åŠ±å¼¹çª—
        showRewards(rewards);
        await saveGameData(true);
        updateUI();
      }

      // æ’­æ”¾æŠ½å–åŠ¨ç”»
      async function playDrawAnimation(rewards) {
        const circle = document.getElementById("itemsCircle");
        const items = circle.querySelectorAll(".item-circle");

        if (items.length === 0) return;

        // è®¡ç®—åŠ¨ç”»å‚æ•°ï¼šæ€»æ—¶é•¿ä¸¥æ ¼æ§åˆ¶åœ¨7-9ç§’
        const minDuration = 7000; // æœ€å°7ç§’
        const maxDuration = 9000; // æœ€å¤§9ç§’
        const targetDuration = minDuration + Math.random() * (maxDuration - minDuration); // éšæœº7-9ç§’
        const itemCount = items.length;
        const baseDelay = 40; // åŸºç¡€é—´éš”ï¼ˆå¿«é€Ÿèµ·å§‹ï¼‰
        const maxDelay = 500; // æœ€å¤§å»¶è¿Ÿé˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼ç›´æ¥åœæ­¢

        // å¤šè½®å¾ªç¯é—ªçƒæ‰€æœ‰Iconï¼Œå¸¦é€Ÿåº¦é˜ˆå€¼åˆ¤æ–­
        let elapsedTime = 0;
        let cycle = 0;

        let shouldStop = false;

        while (elapsedTime < targetDuration && !shouldStop) {
          // ä½¿ç”¨æŒ‡æ•°å‡½æ•°å®ç°å‡é€Ÿ
          const progress = elapsedTime / targetDuration;
          const slowdown = Math.pow(3, progress * 4); // æŒ‡æ•°å‡é€Ÿ
          const currentDelay = baseDelay * slowdown;

          // å¦‚æœé€Ÿåº¦å¤ªæ…¢ï¼ˆå»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼‰ï¼Œç›´æ¥åœæ­¢
          if (currentDelay > maxDelay) {
            break;
          }

          for (let i = 0; i < items.length; i++) {
            // æ¸…é™¤æ‰€æœ‰æ•ˆæœ
            items.forEach((item) => {
              item.classList.remove("item-highlight", "item-dimmed");
            });

            // å…¶ä»–Iconç¼©å°å˜æš—
            items.forEach((item, idx) => {
              if (idx !== i) {
                item.classList.add("item-dimmed");
              }
            });

            // å½“å‰Iconé«˜äº®å¹¶æ”¾å¤§
            items[i].classList.add("item-highlight");
            items[i].classList.remove("item-dimmed");

            playTickSound(); // æ’­æ”¾å“’å“’å“’å£°éŸ³
            await sleep(currentDelay);

            elapsedTime += currentDelay;

            // å†æ¬¡æ£€æŸ¥æ˜¯å¦è¶…æ—¶æˆ–é€Ÿåº¦è¿‡æ…¢
            if (elapsedTime >= targetDuration || currentDelay > maxDelay) {
              shouldStop = true;
              break;
            }
          }

          cycle++;
          if (cycle > 50) break; // å®‰å…¨ä¸Šé™
        }

        // æ¸…é™¤æ‰€æœ‰æ•ˆæœ
        items.forEach((item) => {
          item.classList.remove("item-highlight", "item-dimmed");
        });

        // é€ä¸ªæ˜¾ç¤ºæœ€ç»ˆç»“æœ
        for (let i = 0; i < rewards.length; i++) {
          const reward = rewards[i];

          // æ‰¾åˆ°å¯¹åº”çš„Iconå…ƒç´ 
          const targetIndex = itemPositions.findIndex((pos) => pos.item.id === reward.id);
          if (targetIndex === -1) continue;

          const targetItem = items[targetIndex];

          // æ’­æ”¾é€‰ä¸­éŸ³æ•ˆ
          playSelectSound();

          // æœ€ç»ˆé«˜äº®é€‰ä¸­
          targetItem.classList.add("item-selected");

          // æ˜¾ç¤º+1æ•ˆæœ
          const plusOne = document.createElement("div");
          plusOne.className = "plus-one";
          plusOne.textContent = "+1";
          targetItem.appendChild(plusOne);

          // ç­‰å¾…åŠ¨ç”»å®Œæˆ
          await sleep(800);

          // ç§»é™¤+1å…ƒç´ 
          setTimeout(() => {
            if (plusOne.parentNode) {
              plusOne.remove();
            }
          }, 1500);
        }

        // ç­‰å¾…ä¸€ä¸‹å†ç§»é™¤æ‰€æœ‰é«˜äº®
        await sleep(500);
        items.forEach((item) => item.classList.remove("item-selected"));
      }

      // è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿ
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // ç”Ÿæˆå¥–åŠ±
      function generateRewards(count) {
        const rewards = [];

        for (let i = 0; i < count; i++) {
          let selectedReward;

          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æŠ½å–ä¸”èƒŒåŒ…ä¸ºç©ºï¼Œä¿è¯è·å¾—éVIPä¸“å±ç‰©å“
          if (i === 0 && gameData.inventory.length === 0) {
            const freeItems = currentCategory.items.filter((item) => !item.vipOnly);
            if (freeItems.length > 0) {
              selectedReward = getRandomReward(freeItems);
            } else {
              selectedReward = getRandomReward(currentCategory.items);
            }
          } else {
            // ä»å½“å‰åˆ†ç±»è·å–å¥–åŠ±
            selectedReward = getRandomReward(currentCategory.items);
          }

          if (selectedReward) {
            // æ·»åŠ åˆ°èƒŒåŒ…ï¼ˆå­˜å‚¨å®Œæ•´ç‰©å“ä¿¡æ¯ï¼‰
            const existingItem = gameData.inventory.find(inv => inv.id === selectedReward.id);
            if (existingItem) {
              existingItem.count++;
            } else {
              gameData.inventory.push({
                id: selectedReward.id,
                cmd: selectedReward.cmd,
                name: selectedReward.name,
                count: 1
              });
            }
            rewards.push(selectedReward);
          }
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        gameData.history.unshift({
          timestamp: Date.now(),
          count: count,
          rewards: rewards,
        });

        return rewards;
      }

      // æ ¹æ®ç¨€æœ‰åº¦éšæœºè·å–å¥–åŠ±
      function getRandomReward(pool) {
        const rarity = getRandomRarity();
        const filtered = pool.filter((item) => item.rarity === rarity);

        if (filtered.length === 0) {
          return pool[Math.floor(Math.random() * pool.length)];
        }

        return filtered[Math.floor(Math.random() * filtered.length)];
      }

      // éšæœºè·å–ç¨€æœ‰åº¦
      function getRandomRarity() {
        const total = Object.values(rarityWeights).reduce((a, b) => a + b, 0);
        let random = Math.random() * total;

        for (const [rarity, weight] of Object.entries(rarityWeights)) {
          random -= weight;
          if (random <= 0) {
            return rarity;
          }
        }
        return "common";
      }

      // æ˜¾ç¤ºå¥–åŠ±
      function showRewards(rewards) {
        const modal = document.getElementById("rewardModal");
        const list = document.getElementById("rewardsList");

        // æ’­æ”¾è·å¾—å¥–åŠ±éŸ³æ•ˆ
        playRewardSound();

        list.innerHTML = "";

        rewards.forEach((reward, index) => {
          const rarityColor = {
            common: "border-gray-400",
            rare: "border-blue-400",
            epic: "border-purple-400",
            legendary: "border-yellow-400",
          }[reward.rarity];

          const item = document.createElement("div");
          item.className = `reward-card rounded-lg p-4 border-2 ${rarityColor} fade-in-up relative`;
          item.style.animationDelay = `${index * 0.1}s`;

          item.innerHTML = `
                      ${reward.vipOnly ? '<div class="badge-vip">VIPä¸“å±</div>' : ""}
                      <div class="flex items-center gap-3">
                          <div class="text-4xl">${reward.icon}</div>
                          <div class="flex-1">
                              <div class="font-bold text-yellow-300">${reward.name}</div>
                              <div class="text-xs text-purple-200">${reward.effect}</div>
                              ${reward.vipOnly && !isVipUser ? '<div class="text-xs text-orange-400 mt-1">â­ éœ€è¦VIPä¼šå‘˜æ‰èƒ½ä½¿ç”¨</div>' : ""}
                          </div>
                      </div>
                  `;

          list.appendChild(item);
        });

        modal.classList.remove("hidden");
      }

      // å…³é—­å¥–åŠ±æ¨¡æ€æ¡†
      function closeRewardModal() {
        document.getElementById("rewardModal").classList.add("hidden");
      }

      // ç‰©å“ä½ç½®æ•°æ®ï¼ˆç”¨äºç¢°æ’æ£€æµ‹ï¼‰
      let itemPositions = [];

      // æ¸²æŸ“æ‰€æœ‰ç‰©å“
      function renderAllItems() {
        const circle = document.getElementById("itemsCircle");
        circle.innerHTML = "";

        // ä½¿ç”¨å½“å‰åˆ†ç±»çš„ç‰©å“
        const allItems = currentCategory.items;

        // åŸºäºçœŸå®çª—å£å¤§å°è®¡ç®—ä¸­å¿ƒå’ŒåŠå¾„
        const treeViewWidth = 220; // Tree view width from CSS
        const windowWidth = window.innerWidth - treeViewWidth;
        const windowHeight = window.innerHeight - 80; // å‡å»headeré«˜åº¦
        const centerX = windowWidth / 2 - 90; // çª—å£æ°´å¹³ä¸­å¿ƒ
        const centerY = windowHeight / 2 - 130; // çª—å£å‚ç›´ä¸­å¿ƒ
        const radiusX = Math.min(windowWidth * 0.5 - 100, 450); // æ°´å¹³åŠå¾„ï¼ˆæ¤­åœ†é•¿è½´ï¼‰ï¼Œé™åˆ¶æœ€å¤§å€¼
        const radiusY = Math.min(windowHeight * 0.3, 200); // å‚ç›´åŠå¾„ï¼ˆæ¤­åœ†çŸ­è½´ï¼‰ï¼Œé™åˆ¶æœ€å¤§å€¼

        // åªåœ¨ä¸‹åŠéƒ¨åˆ†æ’åˆ—ï¼ˆä»å·¦ä¸‹åˆ°å³ä¸‹çš„åŠæ¤­åœ†ï¼‰
        const startAngle = Math.PI * -0.3; // èµ·å§‹è§’åº¦ç¨å¾®å‘ä¸Šï¼Œé¿å…è¾¹ç¼˜
        const endAngle = Math.PI * 1.3; // ç»“æŸè§’åº¦ç¨å¾®å‘ä¸Šï¼Œé¿å…è¾¹ç¼˜
        const angleRange = endAngle - startAngle;
        const angleStep = angleRange / (allItems.length - 1);

        // åˆå§‹åŒ–ä½ç½®æ•°ç»„
        itemPositions = [];

        allItems.forEach((item, index) => {
          // è®¡ç®—æ¤­åœ†ä½ç½®ï¼ˆä¸‹åŠéƒ¨åˆ†ï¼‰
          const angle = startAngle + angleStep * index;
          const x = centerX + radiusX * Math.cos(angle);
          const y = centerY + radiusY * Math.sin(angle);

          // å­˜å‚¨ä½ç½®ä¿¡æ¯
          itemPositions.push({
            x: x,
            y: y,
            item: item,
            index: index,
          });
        });

        // è§£å†³é‡å é—®é¢˜
        resolveCollisions();

        // æ¸²æŸ“å…ƒç´ 
        itemPositions.forEach((pos, index) => {
          const item = pos.item;
          // è®¡ç®—æ‹¥æœ‰æ•°é‡ï¼ˆä¸åŒ…æ‹¬å·²ä½¿ç”¨çš„ï¼‰
          const invItem = gameData.inventory.find(inv => inv.id === item.id);
          const ownedCount = invItem ? invItem.count : 0;
          const isOwned = ownedCount > 0;
          const isLocked = item.vipOnly && !isVipUser;

          const rarityColor = {
            common: "rgba(156, 163, 175, 0.6)",
            rare: "rgba(59, 130, 246, 0.6)",
            epic: "rgba(168, 85, 247, 0.6)",
            legendary: "rgba(234, 179, 8, 0.6)",
          }[item.rarity];

          const div = document.createElement("div");
          div.className = `item-circle item-float`;
          div.style.left = `${pos.x}px`;
          div.style.top = `${pos.y}px`;
          div.style.border = `3px solid ${rarityColor}`;
          div.style.animationDelay = `${pos.index * 0.2}s`;
          div.onclick = () => showItemDetail(item, ownedCount);

          div.innerHTML = `
                    ${item.vipOnly ? '<div class="badge-vip" style="font-size: 0.6rem; padding: 1px 6px; top: 2px; right: 2px;">VIP</div>' : ""}
                    ${isOwned ? `<div class="owned-badge">å·²è·å¾—(${ownedCount})</div>` : ""}
                    <div class="text-5xl mb-1">${item.icon}</div>
                    <div class="text-yellow-300 font-bold" style="font-size: 1rem;">${item.name}</div>
                `;

          circle.appendChild(div);
        });
      }

      // ç¢°æ’æ£€æµ‹å’Œåˆ†ç¦»
      function resolveCollisions() {
        const itemRadius = 65; // åŠå¾„ï¼ˆ130pxç›´å¾„çš„ä¸€åŠï¼‰
        const minDistance = itemRadius * 2 + 10; // æœ€å°è·ç¦»ï¼ˆæ·»åŠ 10pxé—´éš™ï¼‰
        const maxIterations = 100; // æœ€å¤§è¿­ä»£æ¬¡æ•°
        const damping = 0.5; // é˜»å°¼ç³»æ•°ï¼Œæ§åˆ¶æ¨åŠ¨åŠ›åº¦

        for (let iteration = 0; iteration < maxIterations; iteration++) {
          let hasCollision = false;

          for (let i = 0; i < itemPositions.length; i++) {
            for (let j = i + 1; j < itemPositions.length; j++) {
              const pos1 = itemPositions[i];
              const pos2 = itemPositions[j];

              // è®¡ç®—è·ç¦»
              const dx = pos2.x - pos1.x;
              const dy = pos2.y - pos1.y;
              const distance = Math.sqrt(dx * dx + dy * dy);

              // å¦‚æœé‡å 
              if (distance < minDistance) {
                hasCollision = true;

                // è®¡ç®—æ¨å¼€çš„æ–¹å‘å’ŒåŠ›åº¦
                const overlap = minDistance - distance;
                const angle = Math.atan2(dy, dx);

                // æ¨å¼€çš„è·ç¦»ï¼ˆæ¯ä¸ªç‰©å“ç§»åŠ¨ä¸€åŠï¼‰
                const pushDistance = (overlap / 2) * damping;

                // æ›´æ–°ä½ç½®
                pos1.x -= Math.cos(angle) * pushDistance;
                pos1.y -= Math.sin(angle) * pushDistance;
                pos2.x += Math.cos(angle) * pushDistance;
                pos2.y += Math.sin(angle) * pushDistance;
              }
            }
          }

          // å¦‚æœæ²¡æœ‰ç¢°æ’äº†ï¼Œæå‰é€€å‡º
          if (!hasCollision) {
            break;
          }
        }
      }

      // æ˜¾ç¤ºç‰©å“è¯¦æƒ…
      let currentDetailItem = null;

      function showItemDetail(item, ownedCount) {
        currentDetailItem = item;
        const isLocked = item.vipOnly && !isVipUser;

        const rarityName = {
          common: "æ™®é€š",
          rare: "ç¨€æœ‰",
          epic: "å²è¯—",
          legendary: "ä¼ è¯´",
        }[item.rarity];

        document.getElementById("itemDetailIcon").textContent = item.icon;
        document.getElementById("itemDetailName").textContent = item.name;
        document.getElementById("itemDetailRarity").textContent = `${rarityName}å“è´¨${item.vipOnly ? " â€¢ VIPä¸“å±" : ""}`;
        document.getElementById("itemDetailDesc").textContent = item.effect;

        if (ownedCount > 0) {
          document.getElementById("itemDetailOwnedSection").classList.remove("hidden");
          document.getElementById("itemDetailOwnedCount").textContent = ownedCount;

          const useBtn = document.getElementById("itemDetailUseBtn");
          useBtn.classList.remove("hidden");

          if (isLocked) {
            useBtn.classList.add("opacity-50", "cursor-not-allowed");
            useBtn.classList.remove("hover:from-orange-600", "hover:to-orange-700");
            useBtn.innerHTML = "ğŸ”’ ä½¿ç”¨";
          } else {
            useBtn.classList.remove("opacity-50", "cursor-not-allowed");
            useBtn.classList.add("hover:from-orange-600", "hover:to-orange-700");
            useBtn.textContent = "ç«‹å³ä½¿ç”¨";
          }
        } else {
          document.getElementById("itemDetailOwnedSection").classList.add("hidden");
          document.getElementById("itemDetailUseBtn").classList.add("hidden");
        }

        document.getElementById("itemDetailModal").classList.remove("hidden");
      }

      function closeItemDetailModal() {
        document.getElementById("itemDetailModal").classList.add("hidden");
        currentDetailItem = null;
      }

      async function useItemFromDetail() {
        if (!currentDetailItem) return;

        // æ£€æŸ¥VIPæƒé™
        if (currentDetailItem.vipOnly && !isVipUser) {
          showNotification("è¯¥ç‰©å“ä¸ºVIPä¸“å±ï¼Œéœ€è¦VIPä¼šå‘˜æ‰èƒ½ä½¿ç”¨ï¼", "ğŸ”’", "VIPä¸“å±");
          return;
        }

        // æ‰¾åˆ°èƒŒåŒ…ä¸­çš„è¯¥ç‰©å“
        const invItem = gameData.inventory.find(inv => inv.id === currentDetailItem.id);
        if (!invItem || invItem.count <= 0) return;

        // ä¿å­˜ç‰©å“ä¿¡æ¯ï¼ˆåœ¨å…³é—­æ¨¡æ€æ¡†ä¹‹å‰ï¼‰
        const itemToUse = currentDetailItem;

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        closeItemDetailModal();

        // æ˜¾ç¤ºä½¿ç”¨æ•ˆæœ
        showNotification(`${itemToUse.effect}`, itemToUse.icon, `å·²ä½¿ç”¨ ${itemToUse.name}`);

        // å¦‚æœç‰©å“æœ‰cmdå±æ€§ï¼Œå‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£æ‰§è¡Œå‘½ä»¤
        if (itemToUse.cmd) {
          window.parent.postMessage(
            {
              type: "GameLogic.RunCommand",
              command: itemToUse.cmd,
              itemName: itemToUse.name,
            },
            "*"
          );
          window.parent.postMessage({ type: "closeGameCommon" }, "*");
        }

        // ä»èƒŒåŒ…ä¸­å‡å°‘æ•°é‡æˆ–ç§»é™¤
        invItem.count--;
        if (invItem.count <= 0) {
          const index = gameData.inventory.findIndex(inv => inv.id === itemToUse.id);
          if (index !== -1) {
            gameData.inventory.splice(index, 1);
          }
        }

        await saveGameData(true);
        updateUI();
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      init();
    </script>
  </body>
</html>
