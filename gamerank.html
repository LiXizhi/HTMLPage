<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏排行榜</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        html, body { 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        
        /* Ensure game list can scroll when content exceeds container */
        .game-list-scroll {
            min-height: 200px;
            overflow-y: scroll !important; /* Force scroll even without content overflow */
        }          
        /* Leaderboard scrollable area */
        .leaderboard-scroll {
            overflow-y: scroll !important;
            max-height: 77vh; /* Force maximum height to ensure scrolling */
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        .game-item:hover { background: rgba(102, 126, 234, 0.1); transform: translateX(4px); }
        .game-item.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .leaderboard-item:nth-child(1) { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); }
        .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #cd7f32, #daa520); }
        .tab-active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .age-button:hover { background: rgba(102, 126, 234, 0.1); }
        .age-button.active { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .user-highlight { border: 3px solid #10b981; background: rgba(16, 185, 129, 0.1); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }        
        .layout-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; flex-shrink: 0; }
        .main-content { flex: 1; min-width: 0; overflow: hidden; }        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu { display: none; }
        .dropdown-menu:hover { display: block; }
        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 8px;
            background: transparent;
        }
        @media (max-width: 768px) {
            .layout-container { flex-direction: column; }
            .sidebar { width: 100%; min-height: auto; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 整体布局容器 -->
    <div class="layout-container">
        <!-- 左侧游戏列表 -->
        <div class="sidebar bg-white shadow-lg flex flex-col">
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-4 pb-2">
                    <h2 class="text-lg font-bold mb-4 text-gray-800">得分排行榜</h2>
                </div>                
                <div class="flex-1 overflow-y-auto px-4 pb-2 game-list-scroll">
                    <div id="gameList" class="space-y-2">
                        <!-- 游戏项目将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>            <!-- 分数提交区域 -->
            <div class="p-4 bg-gray-50 border-t">
                <div class="space-y-3">
                    <button 
                        onclick="showScoreDialog()" 
                        class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition-all"
                        id="submitButton"
                    >
                        🏆 提交成绩
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">为了保护隐私，需要手工提交分数</p>
            </div>
        </div>
        <div class="main-content flex flex-col">
            <!-- 顶部控制栏 -->
            <div class="bg-white shadow-sm p-4 border-b">
                <div class="flex items-center justify-between">
                    
                    <div class="flex items-center space-x-6">
                        <!-- 周榜/月榜切换 -->
                        <div class="flex space-x-3">
                            <button id="weeklyTab" class="tab-active px-6 py-2 rounded-lg font-bold transition-all" onclick="switchTab('weekly')">
                                📅 周榜
                            </button>
                            <button id="monthlyTab" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-bold transition-all hover:bg-gray-300" onclick="switchTab('monthly')">
                                📊 月榜
                            </button>
                        </div>
                        <div class="text-sm text-gray-500">
                            在线用户: <span class="font-bold text-green-600">1,234</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 排行榜内容 -->
            <div class="flex-1 p-2">
                <div class="bg-white rounded-xl shadow-sm h-full flex flex-col">
                    <div class="p-6 border-b">
                        <div class="flex items-center justify-between">
                            <!-- 动态标题和下拉菜单 -->
                            <div class="dropdown relative">
                                <button class="flex items-center text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors cursor-pointer">
                                    <span>🏅 </span>
                                    <span id="rankingTitle">混龄总榜周榜</span>
                                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>                                
                                <!-- 下拉菜单 -->
                                <div class="dropdown-menu absolute top-full left-0 mt-2 w-48 bg-white border rounded-lg shadow-lg z-10">
                                    <div class="py-2 text-lg">
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('all')">🏆 混龄总榜</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('5-6')">👶 5-6岁</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('7-8')">🧒 7-8岁</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('9-10')">👦 9-10岁</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('11-12')">👧 11-12岁</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('13+')">🧑 13岁以上</a>
                                    </div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600">
                                总计: <span id="totalPlayers" class="font-bold text-blue-600">100</span> 人
                            </div>
                        </div>
                    </div>                      
                    <div class="flex-1 overflow-hidden">
                        <div id="leaderboardList" class="h-full min-h-[400px] overflow-y-auto leaderboard-scroll">
                            <!-- 排行榜项目将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <div id="scoreInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-4xl w-full max-h-[80vh] shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4">🏆</div>
                <h3 class="text-3xl font-bold mb-6 text-gray-800" id="submitDialogTitle">提交成绩</h3>
                
                <!-- 游戏信息显示 - 改为网格布局 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">当前训练</div>
                        <div class="text-xl font-bold text-green-700" id="dialogCurrentGame">-</div>
                    </div>
                      <div class="bg-purple-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">当前分数</div>
                        <div class="text-xl font-bold text-purple-700" id="dialogCurrentScore">暂无记录</div>
                        <div class="text-sm text-gray-500 mt-1" id="dialogUserAge">（年龄未设置）</div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">预估排名</div>
                        <div class="text-xl font-bold text-yellow-700" id="dialogUserRank">未上榜</div>
                    </div>                </div>
                
                <!-- 说明文字 -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                    <p class="text-base text-gray-700 leading-relaxed">
                        <strong>为了保护隐私，需要手工提交分数。</strong>您的分数将显示在相应年龄组的排行榜中，帮助您了解自己的训练水平。
                    </p>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="closeScoreDialog()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg text-lg font-bold hover:bg-gray-400 transition-all">
                        取消
                    </button>
                    <button onclick="submitScoreFromDialog()" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold hover:from-green-700 hover:to-blue-700 transition-all">
                        提交分数
                    </button>
                </div>
            </div>
        </div>
    </div>    <!-- 错误提示模态框 -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-md shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4 text-red-500">⚠️</div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">提交失败</h3>
                <p id="errorModalText" class="text-gray-600 mb-6 text-lg leading-relaxed"></p>
                <button onclick="closeErrorModal()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-3 rounded-lg font-bold hover:from-red-600 hover:to-red-700 transition-all">
                    知道了
                </button>
            </div>
        </div>
    </div>

    <!-- 成功提示模态框 -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-md shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4">🎉</div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">分数提交成功！</h3>
                <p class="text-gray-600 mb-2">你的分数已加入排行榜</p>
                <p id="rankInfo" class="text-lg font-bold text-blue-600 mb-6"></p>
                <button onclick="closeModal()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition-all">
                    太棒了！
                </button>
            </div>
        </div>
    </div><script>
          // 游戏配置和用户数据
        let gameConfig = {
            games: {
                puzzle: { name: '益智解谜', icon: '🧩', desc: '挑战你的智力' },
                racing: { name: '极速赛车', icon: '🏎️', desc: '速度与激情' },
                shooting: { name: '射击大师', icon: '🎯', desc: '考验你的准度' },
                platform: { name: '跳跃冒险', icon: '🦘', desc: '平台跳跃游戏' },
                music: { name: '音乐节拍', icon: '🎵', desc: '节奏感挑战' },
                card: { name: '记忆卡牌', icon: '🃏', desc: '记忆力训练' },
                sudoku: { name: '数独游戏', icon: '🔢', desc: '逻辑推理数字游戏' },
                memory: { name: '记忆大师', icon: '🧠', desc: '训练记忆力' },
                math: { name: '数学挑战', icon: '➕', desc: '数学运算能力' },
                word: { name: '单词游戏', icon: '📝', desc: '英语单词挑战' },
                color: { name: '颜色记忆', icon: '🎨', desc: '颜色位置记忆' },
                cube: { name: '立方体', icon: '📦', desc: '3D空间思维' },
                chess: { name: '五子棋', icon: '⚫', desc: '策略对战游戏' },
                water: { name: '倒水游戏', icon: '🧪', desc: '逻辑推理倒水' },
                shape: { name: '图形计数', icon: '🔺', desc: '视觉计数训练' }
            },
            userAge: 9,
            userScores: {
                puzzle: 85,
                racing: 92,
                shooting: 78,
            }
        };        let games = gameConfig.games || {};
        let userAge = (gameConfig.userAge !== undefined && gameConfig.userAge !== null) ? gameConfig.userAge : null; // 用户年龄，从配置中获取
        let userGameScores = gameConfig.userScores || {}; // 用户各游戏的分数，从配置中获取// 默认游戏数据（作为后备）
        const defaultGames = gameConfig.games;
            
        function generateGameList() {
            const gameListContainer = document.getElementById('gameList');
            gameListContainer.innerHTML = '';
            
            const gameKeys = Object.keys(games);
            if (gameKeys.length === 0) {
                gameListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">暂无游戏数据</p>';
                return;
            }
              gameKeys.forEach((gameId, index) => {
                const game = games[gameId];
                const isActive = gameId === currentGame; // 基于当前游戏ID判断是否激活
                
                const gameItem = document.createElement('div');
                gameItem.className = `game-item ${isActive ? 'active' : ''} cursor-pointer p-4 rounded-lg transition-all duration-200`;
                gameItem.setAttribute('data-game-id', gameId);
                gameItem.addEventListener('click', () => selectGame(gameId));
                
                // 显示用户在该游戏的分数
                const userScore = userGameScores[gameId];
                const scoreDisplay = userScore ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full ml-2">${userScore}分</span>` : '';
                
                gameItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">${game.icon}</span>
                            <div>
                                <h3 class="font-bold">${game.name}</h3>
                                <p class="text-sm opacity-80">${game.desc || '暂无描述'}</p>
                            </div>
                        </div>
                        ${scoreDisplay}
                    </div>
                `;
                
                gameListContainer.appendChild(gameItem);
            });
              // 设置第一个游戏为当前游戏并更新界面（仅在没有当前游戏时）
            if (gameKeys.length > 0) {
                // 如果没有当前游戏或当前游戏不存在于列表中，才设置为第一个游戏
                if (!currentGame || !gameKeys.includes(currentGame)) {
                    currentGame = gameKeys[0];
                }
                updateUserInfo();
            }
        }          function updateUserInfo(){
            // Update any user info displays if needed
            // For now, this function can remain empty but available for future use
            console.log('User info updated - Age:', userAge, 'Scores:', userGameScores);
        }
        // 消息监听器
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    gameConfig = e.data.data;
                    try {
                        // gameConfig is now a JSON object                        
                        if (gameConfig && typeof gameConfig === 'object') {
                            games = gameConfig.games || defaultGames;
                            userAge = (gameConfig.userAge !== undefined && gameConfig.userAge !== null) ? gameConfig.userAge : null;
                            userGameScores = gameConfig.userScores || {};
                        } else {
                            // Fallback to defaults
                            games = defaultGames;
                            userAge = null;
                            userGameScores = {};
                        }
                    } catch (error) {
                        console.error('Error processing game config:', error);
                        games = defaultGames;
                        userAge = null;
                        userGameScores = {};
                    }
                    
                    generateGameList();
                    initializeData();
                    updateUserInfo();
                    
                    // 如果有用户年龄，自动切换到对应年龄组
                    if (userAge) {
                        const targetAgeGroup = getAgeGroup(userAge);
                        currentAgeGroup = targetAgeGroup;
                        updateAgeButtons();
                    }
                    
                    updateTitle();
                    updateLeaderboard();
                    console.log('Game config updated:', { games, userAge, userGameScores });
                    break;
                case 'getGameStats':
                    // 发送游戏统计数据
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            currentGame: currentGame,
                            games: Object.keys(games),
                            userAge: userAge,
                            userGameScores: userGameScores,
                            leaderboardData: leaderboardData
                        }
                    }, '*');
                    break;
            }
        });

        // 年龄组配置
        const ageGroups = {
            'all': { name: '混龄总榜', emoji: '🏆', filter: () => true },
            '5-6': { name: '5-6岁', emoji: '👶', filter: (age) => age >= 5 && age <= 6 },
            '7-8': { name: '7-8岁', emoji: '🧒', filter: (age) => age >= 7 && age <= 8 },
            '9-10': { name: '9-10岁', emoji: '👦', filter: (age) => age >= 9 && age <= 10 },
            '11-12': { name: '11-12岁', emoji: '👧', filter: (age) => age >= 11 && age <= 12 },
            '13+': { name: '13岁以上', emoji: '🧑', filter: (age) => age >= 13 }
        };

        let currentGame = 'puzzle';
        let currentTab = 'weekly';
        let currentAgeGroup = 'all';
        let leaderboardData = {};

        // 初始化模拟数据
        function initializeData() {
            Object.keys(games).forEach(gameId => {
                leaderboardData[gameId] = {
                    weekly: generateMockData(),
                    monthly: generateMockData()
                };
            });
        }

        // 生成模拟排行榜数据
        function generateMockData() {
            const names = ['小明', '小红', '小刚', '小丽', '小华', '小王', '小李', '小张', '小陈', '小赵', '小周', '小吴', '小郑', '小冯', '小孙'];
            const data = [];
            for (let i = 0; i < 120; i++) {
                data.push({
                    rank: i + 1,
                    name: names[Math.floor(Math.random() * names.length)] + (i + 1),
                    score: 100000 - i * 800 + Math.floor(Math.random() * 600),
                    age: Math.floor(Math.random() * 14) + 5 // 5-18岁
                });
            }
            return data.sort((a, b) => b.score - a.score);
        }

        // 更新标题
        function updateTitle() {
            const tabName = currentTab === 'weekly' ? '周榜' : '月榜';
            const ageName = ageGroups[currentAgeGroup].name;
            document.getElementById('rankingTitle').textContent = `${ageName}${tabName}`;
        }        // 从下拉菜单选择排行榜
        function selectLeaderboard(ageGroup) {
            event.preventDefault();
            currentAgeGroup = ageGroup;
            
            // 更新按钮状态
            updateAgeButtons();
            updateTitle();
            updateLeaderboard();
        }

        // 更新榜单类型按钮状态
        function updateTabButtons() {
            document.querySelectorAll('[id$="Tab"]').forEach(btn => {
                btn.className = 'bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-bold transition-all hover:bg-gray-300';
            });
            document.getElementById(currentTab + 'Tab').className = 'tab-active px-6 py-2 rounded-lg font-bold transition-all';
        }

        // 更新年龄组按钮状态
        function updateAgeButtons() {
            document.querySelectorAll('.age-button').forEach((btn, index) => {
                btn.classList.remove('active');
                const groups = ['all', '5-6', '7-8', '9-10', '11-12', '13+'];
                if (groups[index] === currentAgeGroup) {
                    btn.classList.add('active');
                }
            });
        }        // 选择游戏
        function selectGame(gameId) {
            currentGame = gameId;
            
            // 更新游戏选择样式
            document.querySelectorAll('.game-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-game-id') === gameId) {
                    item.classList.add('active');
                }
            });
            
            // 更新用户信息显示
            updateUserInfo();
            
            // 切换游戏后，自动显示当前用户年龄的榜
            if (userAge) {
                const targetAgeGroup = getAgeGroup(userAge);
                currentAgeGroup = targetAgeGroup;
                updateAgeButtons();
                updateTitle();
            }
            
            updateLeaderboard();
        }

        // 切换榜单类型
        function switchTab(tab) {
            currentTab = tab;
            updateTabButtons();
            updateTitle();
            updateLeaderboard();
        }

        // 选择年龄组
        function selectAge(ageGroup) {
            currentAgeGroup = ageGroup;
            updateAgeButtons();
            updateTitle();
            updateLeaderboard();
        }

        // 更新排行榜
        function updateLeaderboard() {
            if (!currentGame) return;

            let data = [...leaderboardData[currentGame][currentTab]];

            // 应用年龄组筛选
            if (currentAgeGroup !== 'all') {
                data = data.filter(item => ageGroups[currentAgeGroup].filter(item.age));
            }

            document.getElementById('totalPlayers').textContent = data.length;

            const listContainer = document.getElementById('leaderboardList');
            listContainer.innerHTML = '';

            if (data.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <div class="text-6xl mb-4">🎯</div>
                            <p class="text-xl">暂无${ageGroups[currentAgeGroup].name}的玩家记录</p>
                            <p class="text-sm mt-2">快来成为第一个上榜的玩家吧！</p>
                        </div>
                    </div>
                `;
                return;
            }

            data.slice(0, 100).forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `leaderboard-item flex items-center justify-between p-4 border-b hover:bg-gray-50 transition-all ${index < 3 ? 'text-white font-bold' : ''} ${item.name === '我' ? 'user-highlight' : ''}`;
                
                let rankDisplay = index + 1;
                let rankIcon = '';
                if (index === 0) rankIcon = '🥇';
                else if (index === 1) rankIcon = '🥈';
                else if (index === 2) rankIcon = '🥉';                // 根据排名设置不同的文字颜色
                let textColorClass = '';
                let subTextColorClass = '';
                if (index === 0) {
                    // 第一名：深金色文字
                    textColorClass = 'text-yellow-900';
                    subTextColorClass = 'text-yellow-800 opacity-80';
                } else if (index === 1) {
                    // 第二名：深灰色文字
                    textColorClass = 'text-gray-700';
                    subTextColorClass = 'text-gray-600 opacity-80';
                } else if (index === 2) {
                    // 第三名：深棕色文字
                    textColorClass = 'text-amber-900';
                    subTextColorClass = 'text-amber-800 opacity-80';
                } else {
                    // 其他名次：原来的颜色
                    textColorClass = 'text-gray-800';
                    subTextColorClass = 'text-gray-500';
                }

                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-3xl font-bold mr-4 min-w-[60px] text-center ${index < 3 ? textColorClass : 'text-gray-600'}">
                            ${rankIcon || rankDisplay}
                        </div>
                        <div class="flex items-center">
                            <div class="mr-4">
                                <div class="text-lg font-bold ${textColorClass}">${item.name}</div>
                                <div class="text-sm ${subTextColorClass}">${item.age}岁 ${item.name === '我' ? '(你)' : ''}</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${textColorClass}">${item.score.toLocaleString()}</div>
                        <div class="text-sm ${subTextColorClass}">分数</div>
                    </div>
                `;
                
                listContainer.appendChild(div);
            });
        }

        // 根据年龄确定年龄组
        function getAgeGroup(age) {
            if (age >= 5 && age <= 6) return '5-6';
            if (age >= 7 && age <= 8) return '7-8';
            if (age >= 9 && age <= 10) return '9-10';
            if (age >= 11 && age <= 12) return '11-12';
            if (age >= 13) return '13+';
            return 'all';
        }        // 显示提交错误消息（使用弹窗模态框）
        function showSubmitError(message) {
            const errorModalText = document.getElementById('errorModalText');
            errorModalText.textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        // 隐藏提交错误消息
        function hideSubmitError() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        // 关闭错误模态框
        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }        function showScoreDialog() {
            // 更新对话框标题，不显示用户年龄
            const tabName = currentTab === 'weekly' ? '周榜' : '月榜';
            const ageName = ageGroups[currentAgeGroup].name;
            document.getElementById('submitDialogTitle').textContent = `提交成绩 - ${ageName}${tabName}`;
            
            // 更新对话框中的信息
            document.getElementById('dialogCurrentGame').textContent = games[currentGame] ? games[currentGame].name : '-';
            
            const currentScore = userGameScores[currentGame];
            document.getElementById('dialogCurrentScore').textContent = currentScore ? `${currentScore.toLocaleString()} 分` : '暂无记录';
            
            // 显示用户年龄
            const ageText = userAge ? `（${userAge}岁）` : '（年龄未设置）';
            document.getElementById('dialogUserAge').textContent = ageText;
            
            // 计算并显示预估排名
            updateEstimatedRank();
            
            // 显示对话框
            document.getElementById('scoreInfoModal').classList.remove('hidden');
        }
        function updateEstimatedRank() {
            if (!userAge || !leaderboardData[currentGame]) {
                document.getElementById('dialogUserRank').textContent = '需要设置年龄';
                return;
            }
            
            const currentScore = userGameScores[currentGame];
            if (!currentScore) {
                document.getElementById('dialogUserRank').textContent = '暂无分数记录';
                return;
            }
            
            // 混合榜可以无视年龄，其他榜单需要检查年龄组是否匹配
            if (currentAgeGroup !== 'all') {
                const targetAgeGroup = getAgeGroup(userAge);
                if (currentAgeGroup !== targetAgeGroup) {
                    document.getElementById('dialogUserRank').textContent = '该榜与用户年龄不符';
                    return;
                }
            }
            
            // 计算用户在当前年龄组的排名
            const data = leaderboardData[currentGame][currentTab];
            const filteredData = currentAgeGroup === 'all' ? data : data.filter(item => ageGroups[currentAgeGroup].filter(item.age));
            
            // 添加用户分数到排行榜中进行排序（临时计算）
            const tempData = [...filteredData];
            // 移除之前的用户记录（如果存在）
            const existingUserIndex = tempData.findIndex(item => item.name === '我');
            if (existingUserIndex !== -1) {
                tempData.splice(existingUserIndex, 1);
            }
            
            // 添加新的用户分数
            tempData.push({
                name: '我',
                score: currentScore,
                age: userAge
            });
            tempData.sort((a, b) => b.score - a.score);
              const userRank = tempData.findIndex(item => item.name === '我') + 1;
            const totalPlayers = tempData.length;            
            document.getElementById('dialogUserRank').textContent = `第 ${userRank} 位`;
        }
        function submitScoreFromDialog() {
            if (userAge === null || userAge === undefined) {
                showSubmitError('用户年龄未设置，请设置年龄后再提交分数');
                return;
            }

            // 混合榜可以无视年龄，其他榜单需要检查年龄组是否匹配
            if (currentAgeGroup !== 'all') {
                const targetAgeGroup = getAgeGroup(userAge);
                if (currentAgeGroup !== targetAgeGroup) {
                    // 年龄不符时直接关闭对话框
                    closeScoreDialog();
                    return;
                }
            }

            const currentScore = userGameScores[currentGame];
            if (!currentScore || currentScore <= 0) {
                showSubmitError('当前训练暂无有效分数记录');
                return;
            }

            // 关闭对话框
            closeScoreDialog();
            
            // 调用原有的提交分数逻辑
            submitScoreInternal(currentScore);
        }        // 关闭提交成绩对话框
        function closeScoreDialog() {
            document.getElementById('scoreInfoModal').classList.add('hidden');
        }

        // 内部提交分数函数（重命名原submitScore函数）
        function submitScoreInternal(score) {
            // 更新用户游戏分数
            userGameScores[currentGame] = score;

            // 移除之前的用户记录
            ['weekly', 'monthly'].forEach(tab => {
                leaderboardData[currentGame][tab] = leaderboardData[currentGame][tab].filter(item => item.name !== '我');
            });

            // 添加到排行榜数据
            const userEntry = {
                rank: 0,
                name: '我',
                score: score,
                age: userAge
            };

            // 添加到所有相关榜单
            ['weekly', 'monthly'].forEach(tab => {
                leaderboardData[currentGame][tab].push(userEntry);
                leaderboardData[currentGame][tab].sort((a, b) => b.score - a.score);
                // 重新计算排名
                leaderboardData[currentGame][tab].forEach((item, index) => {
                    item.rank = index + 1;
                });
            });

            // 自动切换到对应年龄组
            const targetAgeGroup = getAgeGroup(userAge);
            currentAgeGroup = targetAgeGroup;
            updateAgeButtons();
            updateTitle();

            // 获取用户排名信息
            const userRank = leaderboardData[currentGame][currentTab].findIndex(item => item.name === '我') + 1;
            document.getElementById('rankInfo').textContent = `你在${games[currentGame].name}中排名第 ${userRank} 位！`;

            // 更新用户信息显示
            updateUserInfo();
            
            // 重新生成游戏列表以显示更新的分数
            generateGameList();

            // 显示成功提示
            document.getElementById('successModal').classList.remove('hidden');

            updateLeaderboard();

            setTimeout(() => {
                const userItem = document.querySelector('.user-highlight');
                if (userItem) {
                    userItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
            
            window.parent.postMessage({ 
                type: 'scoreUpdated', 
                data: {
                    game: currentGame,
                    score: score,
                    userGameScores: userGameScores
                }
            }, '*');
        }
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        
        function initializePage() {
            if (!games || Object.keys(games).length === 0) {
                games = defaultGames;
            }
            
            generateGameList();
            initializeData();
            updateUserInfo();
            updateTitle();
            updateLeaderboard();

            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                errorModal.addEventListener('click', function(e) {
                    if (e.target === errorModal) {
                        closeErrorModal();
                    }
                });
            }
            
            window.parent.postMessage({ type: 'gameLoaded' }, '*');
        }
        initializePage();
    </script>
</body>
</html>

