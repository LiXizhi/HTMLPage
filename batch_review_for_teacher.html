<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>智能作业批改系统 · H5 (KeepWork存储)</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#eef6ff",
                100: "#d9ebff",
                200: "#b6d7ff",
                300: "#85bdff",
                400: "#539dff",
                500: "#2b7fff",
                600: "#0f5ff1",
                700: "#0a49c4",
                800: "#093e9d",
                900: "#0b367f",
              },
            },
          },
        },
      };
    </script>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?ver=1.0.7"></script>
    <style>
      .scrollbar-thin::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 8px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Toast Styles */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
      }

      .toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 12px 16px;
        margin-bottom: 8px;
        min-width: 300px;
        max-width: 400px;
        border-left: 4px solid;
        pointer-events: auto;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-color: #10b981;
      }

      .toast.error {
        border-color: #ef4444;
      }

      .toast.warning {
        border-color: #f59e0b;
      }

      .toast.info {
        border-color: #3b82f6;
      }

      .toast-icon {
        flex-shrink: 0;
        width: 16px;
        height: 16px;
      }

      .toast-message {
        flex: 1;
        font-size: 14px;
        color: #374151;
      }

      .toast-close {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        border: none;
        background: none;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Streaming text styles */
      #streamingText {
        font-family: 'Courier New', monospace;
        line-height: 1.4;
      }

      .streaming-cursor::after {
        content: '|';
        animation: blink 1s infinite;
        color: #6b7280;
      }

      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <!-- App Container -->
    <div class="min-h-screen flex flex-col">
      <!-- Header with Tabs -->
      <header class="bg-white border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <div class="flex items-center gap-2">
            <div class="h-9 p-2 rounded-lg bg-brand-600 flex items-center justify-center text-white font-bold">AI批改</div>
          </div>
          
          <!-- Tabs in header -->
          <div class="flex gap-2 ml-6">
            <button data-tab="grading" class="tab-btn px-4 py-2 text-sm rounded-lg bg-brand-50 text-brand-700 border border-brand-200">批改</button>
            <button data-tab="reports" class="tab-btn px-4 py-2 text-sm rounded-lg text-slate-600 hover:bg-slate-100">报告</button>
            <button data-tab="analytics" class="tab-btn px-4 py-2 text-sm rounded-lg text-slate-600 hover:bg-slate-100">分析</button>
            <button data-tab="settings" class="tab-btn px-4 py-2 text-sm rounded-lg text-slate-600 hover:bg-slate-100">设置</button>
          </div>
          
          <div class="flex-1"></div>

          <!-- Current Class Selector -->
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600 hidden sm:block">当前班级</label>
            <select id="currentClassSelect" class="px-3 py-1.5 border rounded-lg text-sm"></select>
            <button id="btnManageClasses" class="px-3 py-1.5 bg-slate-800 text-white rounded-lg text-sm">班级管理</button>
          </div>
        </div>
      </header>

      <!-- Main -->
      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 py-6">
          <!-- Tab: Grading -->
          <section id="tab-grading" class="tab-panel">
            <!-- Alert: API Key missing -->
            <div id="apiKeyAlert" class="hidden mb-4 p-3 rounded-md bg-yellow-50 border border-yellow-200 text-yellow-900 text-sm">
              未配置 Doubao API Key，已自动启用“模拟批改模式”。请前往“设置”中配置 API 后再进行真实批改。
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Left column: Theme & Prompt -->
              <div class="lg:col-span-1 space-y-4">
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold">批改主题</h2>
                    <button id="btnPromptSettings" class="px-3 py-1.5 bg-slate-600 text-white text-sm rounded-lg">设置</button>
                  </div>

                  <select id="themeSelect" class="w-full border rounded-lg px-3 py-2">
                    <option value="math">数学作业</option>
                    <option value="english">英语作文</option>
                    <option value="chinese">语文作文</option>
                    <option value="custom">自定义/全科学</option>
                  </select>

                  <!-- Hidden inputs for storing prompt settings -->
                  <textarea id="promptTextarea" class="hidden"></textarea>
                  <input id="maxScoreInput" type="hidden" value="100" />
                  <select id="levelToggle" class="hidden">
                    <option value="on" selected>是</option>
                    <option value="off">否</option>
                  </select>
                </div>

                <div class="bg-white border border-slate-200 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold">图片上传与识别</h2>
                    <button id="btnClearImages" class="px-3 py-1 text-sm border rounded-lg text-rose-700 border-rose-300 hover:bg-rose-50">清空所有图片</button>
                  </div>
                  <div class="border-2 border-dashed rounded-xl p-4 text-center">
                    <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
                    <button id="btnChooseFiles" class="px-4 py-2 bg-brand-600 text-white rounded-lg">选择图片</button>
                    <p class="text-xs text-slate-500 mt-2">支持多张图片，自动 OCR 识别学生姓名。支持多学科混合批改。</p>
                  </div>
                  <div id="ocrProgress" class="hidden mt-3 text-sm text-slate-600"></div>
                </div>

                <div class="bg-white border border-slate-200 rounded-xl p-4">
                  <h2 class="font-semibold mb-3">批改执行</h2>
                  <div class="space-y-2">
                    <button id="btnStartGrading" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">开始批改</button>
                    <button id="btnSaveReport" class="w-full py-2 bg-slate-800 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>保存为报告</button>
                  </div>
                  <p class="text-xs text-slate-500 mt-2">支持多学科混合批改。切换主题时不会重置已有图片状态。只有手动删除图片才会移除。</p>
                  <div id="gradingProgress" class="hidden mt-3 text-sm text-slate-600"></div>
                  <div id="streamingStatus" class="hidden mt-2 text-xs text-gray-500 border-l-2 border-gray-300 pl-3">
                    <div class="font-medium mb-1">AI 响应:</div>
                    <div id="streamingText" class="whitespace-pre-wrap max-h-32 overflow-y-auto"></div>
                  </div>
                </div>
              </div>

              <!-- Right column: Image list and results -->
              <div class="lg:col-span-2 space-y-6">
                <!-- Uploaded images -->
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold">已上传图片</h2>
                    <div class="text-sm text-slate-500">共 <span id="imgCount">0</span> 张</div>
                  </div>
                  <div id="imageGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                  <div id="unmatchedNotice" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-900"></div>
                </div>

                <!-- Grading results -->
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="font-semibold">批改结果（当前批次）</h2>
                    <div class="text-sm text-slate-500">班级：<span id="currentClassName">-</span></div>
                  </div>
                  <div class="overflow-auto scrollbar-thin">
                    <table class="min-w-full text-sm">
                      <thead>
                        <tr class="text-left text-slate-500 border-b">
                          <th class="py-2 pr-3">学生</th>
                          <th class="py-2 pr-3">图片</th>
                          <th class="py-2 pr-3">主题</th>
                          <th class="py-2 pr-3">分数</th>
                          <th class="py-2 pr-3">等级</th>
                          <th class="py-2 pr-3">概述</th>
                          <th class="py-2">详情</th>
                        </tr>
                      </thead>
                      <tbody id="resultsTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Tab: Reports -->
          <section id="tab-reports" class="tab-panel hidden">
            <div class="bg-white border border-slate-200 rounded-xl p-4">
              <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">班级报告存档</h2>
                <div class="flex items-center gap-2">
                  <select id="reportThemeFilter" class="border rounded-lg px-3 py-1.5 text-sm">
                    <option value="">全部主题</option>
                    <option value="math">数学作业</option>
                    <option value="english">英语作文</option>
                    <option value="chinese">语文作文</option>
                    <option value="custom">自定义/全学科</option>
                  </select>
                </div>
              </div>
              <div id="reportsList" class="space-y-3"></div>
            </div>
          </section>

          <!-- Tab: Analytics -->
          <section id="tab-analytics" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 bg-white border border-slate-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                  <h2 class="font-semibold">班级平均分趋势</h2>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-600">主题</label>
                    <select id="analyticsThemeFilter" class="border rounded-lg px-3 py-1.5 text-sm">
                      <option value="">全部</option>
                      <option value="math">数学作业</option>
                      <option value="english">英语作文</option>
                      <option value="chinese">语文作文</option>
                      <option value="custom">自定义/全学科</option>
                    </select>
                  </div>
                </div>
                <canvas id="avgChart" height="140"></canvas>
              </div>
              <div class="lg:col-span-1 bg-white border border-slate-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                  <h2 class="font-semibold">最近一次报告排名</h2>
                  <button id="btnExportLatestCSV" class="text-sm px-3 py-1.5 border rounded-lg">导出 CSV</button>
                </div>
                <div id="rankingList" class="space-y-2"></div>
              </div>
            </div>

            <div class="mt-6 bg-white border border-slate-200 rounded-xl p-4">
              <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">学生个人趋势</h2>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-600">选择学生</label>
                  <select id="studentTrendSelect" class="border rounded-lg px-3 py-1.5 text-sm"></select>
                </div>
              </div>
              <canvas id="studentChart" height="120"></canvas>
            </div>
          </section>

          <!-- Tab: Settings -->
          <section id="tab-settings" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white border border-slate-200 rounded-xl p-4">
                <h2 class="font-semibold mb-3">AI 服务提供商</h2>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-slate-600 mb-2">选择 AI 服务</label>
                    <select id="aiProviderSelect" class="w-full border rounded-lg px-3 py-2">
                      <option value="doubao">Doubao (豆包) - 自有 API Key</option>
                      <option value="keepwork">Keepwork SDK - 无需配置</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">选择使用哪种 AI 服务进行批改</p>
                  </div>
                </div>
              </div>
              <div id="doubaoSettings" class="bg-white border border-slate-200 rounded-xl p-4">
                <h2 class="font-semibold mb-3">Doubao API 设置</h2>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-slate-600 mb-1">API Key</label>
                    <input id="apiKeyInput" type="password" placeholder="sk-..." class="w-full border rounded-lg px-3 py-2" />
                    <p class="text-xs text-slate-500 mt-1">仅保存在本地浏览器，不会上传。</p>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-600 mb-1">模型名称</label>
                    <input id="modelInput" type="text" value="ep-xxxxxxxx" class="w-full border rounded-lg px-3 py-2" />
                    <p class="text-xs text-slate-500 mt-1">例如：ep-xxxxxxxx（在火山方舟后台创建的终端点）</p>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-600 mb-1">Chat Completions Endpoint</label>
                    <input id="endpointInput" type="text" value="https://ark.cn-beijing.volces.com/api/v3/chat/completions" class="w-full border rounded-lg px-3 py-2" />
                    <p class="text-xs text-slate-500 mt-1">默认为 Doubao/火山方舟 Chat Completions 接口</p>
                  </div>

                  <div class="flex gap-2">
                    <button id="btnSaveApiSettings" class="px-4 py-2 bg-brand-600 text-white rounded-lg">保存设置</button>
                    <button id="btnTestDoubaoLLM" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">测试 LLM</button>
                  </div>
                </div>
              </div>
              <div id="keepworkSettings" class="bg-white border border-slate-200 rounded-xl p-4 hidden">
                <h2 class="font-semibold mb-3">Keepwork SDK 设置</h2>
                <div class="space-y-3">
                  <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800">使用 Keepwork SDK 无需额外配置，将自动使用内置的 AI 服务。</p>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnSaveKeepworkSettings" class="px-4 py-2 bg-brand-600 text-white rounded-lg">保存设置</button>
                    <button id="btnTestKeepworkLLM" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">测试 LLM</button>
                  </div>
                </div>
              </div>
              <div class="bg-white border border-slate-200 rounded-xl p-4">
                <h2 class="font-semibold mb-3">智能识别与匹配设置</h2>
                <div class="grid grid-cols-1 gap-3">
                  <div>
                    <label class="block text-sm text-slate-600 mb-1">匹配敏感度</label>
                    <select id="matchSensitivity" class="w-full border rounded-lg px-3 py-2">
                      <option value="strict">严格（完整匹配）</option>
                      <option value="loose" selected>宽松（包含匹配）</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">使用 AI 大模型进行智能文字识别，支持中英文混合识别</p>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="flex items-center gap-2">
                    <input id="sendImageToggle" type="checkbox" class="h-4 w-4" />
                    <label for="sendImageToggle" class="text-sm text-slate-700">尝试将图片以 Base64 形式发送给模型（可能不被某些模型支持）</label>
                  </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                  <button id="btnSeedDemo" class="px-4 py-2 border rounded-lg">一键填充示例数据</button>
                  <button id="btnClearAll" class="px-4 py-2 border rounded-lg text-rose-700 border-rose-300">清空全部数据</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Modal: Class Management -->
    <div id="classModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
      <div class="bg-white w-full max-w-3xl rounded-xl p-5">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold text-lg">班级管理</h3>
          <button id="closeClassModal" class="p-2 rounded-lg hover:bg-slate-100">&times;</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div>
            <h4 class="font-semibold mb-2">班级列表</h4>
            <div id="classList" class="space-y-2 max-h-80 overflow-auto scrollbar-thin"></div>
            <div class="mt-3 flex gap-2">
              <input id="newClassName" type="text" placeholder="新班级名称" class="flex-1 border rounded-lg px-3 py-2" />
              <button id="btnAddClass" class="px-3 py-2 bg-brand-600 text-white rounded-lg">添加</button>
            </div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">学生管理</h4>
            <div class="text-sm text-slate-600 mb-2">当前班级：<span id="manageClassName">-</span></div>
            <div id="studentList" class="space-y-2 max-h-64 overflow-auto scrollbar-thin border rounded-lg p-2"></div>
            <div class="mt-3">
              <label class="block text-sm text-slate-600 mb-1">批量导入（每行一个姓名）</label>
              <textarea
                id="bulkStudentsInput"
                class="w-full border rounded-lg px-3 py-2 h-28"
                placeholder="张三
李四
王五"
              ></textarea>
              <div class="mt-2 flex gap-2">
                <button id="btnImportStudents" class="px-3 py-2 border rounded-lg">导入</button>
                <button id="btnClearStudents" class="px-3 py-2 border rounded-lg text-rose-700 border-rose-300">清空学生</button>
              </div>
            </div>
            </div>
          </div>
          <div class="mt-4 text-right"></div>
            <button id="saveClassChanges" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">保存更改</button>
          </div>
          </div>
        </div>
        <!-- Modal: Result Detail -->
        <div id="detailModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
          <div class="bg-white w-full max-w-2xl rounded-xl p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">批改详情</h3>
            <button id="closeDetailModal" class="p-2 rounded-lg hover:bg-slate-100">&times;</button>
          </div>
          <div id="detailContent" class="mt-3 text-sm whitespace-pre-wrap"></div>
          </div>
        </div>

        <!-- Modal: Prompt Settings -->
        <div id="promptModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
          <div class="bg-white w-full max-w-4xl rounded-xl p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">提示词设置</h3>
            <button id="closePromptModal" class="p-2 rounded-lg hover:bg-slate-100">&times;</button>
          </div>
          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
            <div class="flex items-center justify-between mb-3">
              <label class="block text-slate-600">可编辑提示词:</label>
              <button id="btnResetPrompt" class="px-3 py-1.5 border rounded-lg">重置默认</button>
            </div>
            <textarea id="promptModalTextarea" class="w-full border rounded-lg px-3 py-2 h-80 text-sm" placeholder="在此编辑提示词..."></textarea>
            </div>
            <div>
            <h4 class="font-semibold mb-3">参数设置</h4>
            <div class="space-y-4">
              <div>
              <label class="block text-sm text-slate-600 mb-1">最高分</label>
              <input id="maxScoreModalInput" type="number" value="100" class="w-full border rounded-lg px-3 py-2" />
              </div>
              <div>
              <label class="block text-sm text-slate-600 mb-1">是否返回等级</label>
              <select id="levelModalToggle" class="w-full border rounded-lg px-3 py-2">
                <option value="on" selected>是</option>
                <option value="off">否</option>
              </select>
              </div>
              <div class="mt-6 space-y-2">
              <button id="btnSavePromptSettings" class="w-full px-4 py-2 bg-emerald-600 text-white rounded-lg">保存设置</button>
              <button id="btnCancelPromptSettings" class="w-full px-4 py-2 border rounded-lg">取消</button>
              </div>
            </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Modal: Test LLM -->
        <div id="testLLMModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
          <div class="bg-white w-full max-w-3xl rounded-xl p-5">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-lg">测试 LLM 连接</h3>
              <button id="closeTestLLMModal" class="p-2 rounded-lg hover:bg-slate-100">&times;</button>
            </div>
            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm text-slate-600 mb-2">测试消息</label>
                <textarea id="testLLMInput" class="w-full border rounded-lg px-3 py-2 h-24 text-sm" placeholder="输入测试消息，例如：你好，请回复一个简单的问候。">你好，请简单介绍一下自己。</textarea>
              </div>
              <div class="flex gap-2">
                <button id="btnRunLLMTest" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">开始测试</button>
                <button id="btnCancelLLMTest" class="px-4 py-2 border rounded-lg">取消</button>
              </div>
              <div id="testLLMProgress" class="hidden">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p class="text-sm text-blue-800">正在测试 LLM 连接...</p>
                </div>
              </div>
              <div id="testLLMResult" class="hidden">
                <label class="block text-sm text-slate-600 mb-2">测试结果</label>
                <div class="border rounded-lg p-3 bg-slate-50 min-h-[100px] max-h-[300px] overflow-y-auto">
                  <pre id="testLLMResultContent" class="text-sm whitespace-pre-wrap"></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
      // LLM API integration (from characterAI.html)
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });

      const LSK = {
        classes: "classes",
        currentClassId: "currentClassId",
        reports: "reports",
        settings: "settings",
      };

      function uid(prefix = "id") {
        return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
      }

      const LS = {
        get: async (k, d) => {
          try {
            const data = await sdk.personalPageStore.loadPageData("smart_grader", k);
            return structuredClone(data ?? d);
          } catch (e) {
            console.warn("读取数据失败，使用默认值", e);
            return d;
          }
        },
        set: async (k, v, bFlush) => {
          try {
            await sdk.personalPageStore.savePageData("smart_grader", k, v, bFlush);
          } catch (e) {
            console.warn("保存数据失败", e);
          }
        },
      };
      
      // Legacy functions for backward compatibility
      function saveLS(key, value, bFlush) {
        return LS.set(key, value, bFlush);
      }
      async function loadLS(key, def = null) {
        return await LS.get(key, def);
      }

      function formatDate(d) {
        const dt = d instanceof Date ? d : new Date(d);
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, "0");
        const day = String(dt.getDate()).padStart(2, "0");
        const hh = String(dt.getHours()).padStart(2, "0");
        const mm = String(dt.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      }

      function downloadFile(filename, text) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      function normalize(str) {
        return (str || "")
          .toLowerCase()
          .replace(/\s+/g, "")
          .replace(/[·•．.\-—_]/g, "");
      }
      function ensureArray(x) {
        return Array.isArray(x) ? x : x ? [x] : [];
      }

      // ---------- Toast Notifications ----------
      function showToast(message, type = "info", duration = 4000) {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = {
          success: "✓",
          error: "✕",
          warning: "⚠",
          info: "ℹ",
        };

        toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close">×</button>
              `;

        container.appendChild(toast);

        // Show toast with animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        const autoRemove = setTimeout(() => {
          removeToast(toast);
        }, duration);

        // Manual close
        toast.querySelector(".toast-close").addEventListener("click", () => {
          clearTimeout(autoRemove);
          removeToast(toast);
        });
      }

      function removeToast(toast) {
        toast.classList.remove("show");
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }

      // ---------- App State ----------
      const state = {
        classes: [],
        currentClassId: null,
        images: [], // {id, file, url, ocrText, detectedName, studentId, status}
        results: [], // {imageId, studentId, studentName, score, maxScore, level, summary, detail, raw, imageName}
        reports: [],
        grading: {
          isRunning: false,
          isPaused: false,
          currentIndex: 0,
        },
        settings: {
          aiProvider: "keepwork", // "doubao" or "keepwork" - default to keepwork when no API key
          apiKey: "",
          model: "doubao-seed-1-6-flash-250615",
          endpoint: "https://ark.cn-beijing.volces.com/api/v3/chat/completions",
          matchSensitivity: "loose",
          sendImageBase64: false,
        },
        charts: {
          avg: null,
          student: null,
        },
      };

      // ---------- Defaults ----------
      const defaultPrompts = {
        math: `你是一名严谨的数学老师。请根据 OCR 识别的“学生作答文本”进行批改：
      - 找出每步主要错误点并简要解释
      - 给出本题/本套作业的得分，满分为 {{MAX_SCORE}}
      - 指出改进建议
      - 如能识别多个小题，请分别简述
      输出 JSON（不要多余前后缀）：
      {
        "score": 0-{{MAX_SCORE}},
        "max_score": {{MAX_SCORE}},
        "level": "A/B/C/D",
        "comments": "总体评价",
        "mistakes": [{"item":"小题/步骤","reason":"错误原因","fix":"改进建议"}]
      }`,
        english: `你是一名英语作文老师。请根据学生作文文本进行评分与反馈：
      - 从内容（20）、结构（20）、语言（40）、拼写/标点（20）四方面简评
      - 总分满分 {{MAX_SCORE}}，给出总体评分
      - 指出最值得改进的三点
      输出 JSON（不要多余前后缀）：
      {
        "score": 0-{{MAX_SCORE}},
        "max_score": {{MAX_SCORE}},
        "level": "A/B/C/D",
        "comments": "总体评价",
        "mistakes": [{"item":"方面","reason":"问题","fix":"建议"}]
      }`,
        chinese: `你是一名语文作文老师。请从立意、结构、语言和文采进行点评：
      - 指出亮点与不足
      - 总分满分 {{MAX_SCORE}}，给出总体评分与等级
      - 给出三条具体修改建议
      输出 JSON（不要多余前后缀）：
      {
        "score": 0-{{MAX_SCORE}},
        "max_score": {{MAX_SCORE}},
        "level": "A/B/C/D",
        "comments": "总体评价",
        "mistakes": [{"item":"方面","reason":"问题","fix":"建议"}]
      }`,
        custom: `请根据以下"学生作答文本"进行批改与评分，满分 {{MAX_SCORE}}：

    **适用学科：**
    - 数学：检查计算步骤、公式应用、逻辑推理的正确性
    - 语文：从内容表达、语言运用、结构组织、书写规范等方面评价
    - 英语：关注语法准确性、词汇运用、表达流畅度、拼写规范
    - 物理/化学：重点检查公式运用、实验步骤、单位换算、概念理解
    - 生物：评估概念掌握、图表分析、实验设计、术语使用
    - 历史/地理：考查史实准确性、地理知识点、分析能力、表述逻辑
    - 其他学科：根据学科特点进行针对性评价

    **评分要求：**
    - 准确识别学科类型并采用相应评分标准
    - 指出主要错误点并给出具体改进建议
    - 综合考虑知识掌握度、答题规范性、表达清晰度

    输出 JSON（不要多余前后缀）：
    {
      "score": 0-{{MAX_SCORE}},
      "max_score": {{MAX_SCORE}},
      "level": "A/B/C/D",
      "comments": "总体评价（包含学科识别）",
      "mistakes": [{"item":"知识点/方面","reason":"错误原因","fix":"具体改进建议"}]
    }`,
      };

      // ---------- DOM ----------
      const els = {};
      function qs(id) {
        return document.getElementById(id);
      }

      function cacheDOM() {
        els.currentClassSelect = qs("currentClassSelect");
        els.btnManageClasses = qs("btnManageClasses");
        
        els.apiKeyAlert = qs("apiKeyAlert");

        els.themeSelect = qs("themeSelect");
        els.promptTextarea = qs("promptTextarea");
        els.maxScoreInput = qs("maxScoreInput");
        els.levelToggle = qs("levelToggle");
        els.btnPromptSettings = qs("btnPromptSettings");

        els.fileInput = qs("fileInput");
        els.btnChooseFiles = qs("btnChooseFiles");
        els.btnClearImages = qs("btnClearImages");
        els.ocrProgress = qs("ocrProgress");

        els.btnStartGrading = qs("btnStartGrading");
        els.btnSaveReport = qs("btnSaveReport");
        els.gradingProgress = qs("gradingProgress");
        els.streamingStatus = qs("streamingStatus");
        els.streamingText = qs("streamingText");

        els.imgCount = qs("imgCount");
        els.imageGrid = qs("imageGrid");
        els.unmatchedNotice = qs("unmatchedNotice");

        els.currentClassName = qs("currentClassName");
        els.resultsTbody = qs("resultsTbody");

        // Reports
        els.reportThemeFilter = qs("reportThemeFilter");
        els.reportsList = qs("reportsList");

        // Analytics
        els.analyticsThemeFilter = qs("analyticsThemeFilter");
        els.avgChart = qs("avgChart");
        els.rankingList = qs("rankingList");
        els.btnExportLatestCSV = qs("btnExportLatestCSV");
        els.studentTrendSelect = qs("studentTrendSelect");
        els.studentChart = qs("studentChart");        // Settings
        els.aiProviderSelect = qs("aiProviderSelect");
        els.apiKeyInput = qs("apiKeyInput");
        els.modelInput = qs("modelInput");
        els.endpointInput = qs("endpointInput");
        els.matchSensitivity = qs("matchSensitivity");
        els.sendImageToggle = qs("sendImageToggle");
        els.btnSaveApiSettings = qs("btnSaveApiSettings");
        els.btnSaveKeepworkSettings = qs("btnSaveKeepworkSettings");
        els.btnTestDoubaoLLM = qs("btnTestDoubaoLLM");
        els.btnTestKeepworkLLM = qs("btnTestKeepworkLLM");
        els.btnSeedDemo = qs("btnSeedDemo");
        els.btnClearAll = qs("btnClearAll");

        // Modals
        els.classModal = qs("classModal");
        els.closeClassModal = qs("closeClassModal");
        els.classList = qs("classList");
        els.studentList = qs("studentList");
        els.newClassName = qs("newClassName");
        els.btnAddClass = qs("btnAddClass");
        els.manageClassName = qs("manageClassName");
        els.bulkStudentsInput = qs("bulkStudentsInput");
        els.btnImportStudents = qs("btnImportStudents");
        els.btnClearStudents = qs("btnClearStudents");
        els.saveClassChanges = qs("saveClassChanges");
        els.detailModal = qs("detailModal");
        els.closeDetailModal = qs("closeDetailModal");
        els.detailContent = qs("detailContent");

        // Prompt Settings Modal
        els.promptModal = qs("promptModal");
        els.closePromptModal = qs("closePromptModal");
        els.promptModalTextarea = qs("promptModalTextarea");
        els.maxScoreModalInput = qs("maxScoreModalInput");
        els.levelModalToggle = qs("levelModalToggle");
        els.btnResetPrompt = qs("btnResetPrompt");
        els.btnSavePromptSettings = qs("btnSavePromptSettings");
        els.btnCancelPromptSettings = qs("btnCancelPromptSettings");

        // Test LLM Modal
        els.testLLMModal = qs("testLLMModal");
        els.closeTestLLMModal = qs("closeTestLLMModal");
        els.testLLMInput = qs("testLLMInput");
        els.btnRunLLMTest = qs("btnRunLLMTest");
        els.btnCancelLLMTest = qs("btnCancelLLMTest");
        els.testLLMProgress = qs("testLLMProgress");
        els.testLLMResult = qs("testLLMResult");
        els.testLLMResultContent = qs("testLLMResultContent");
      }

      async function initFromStorage() {
        const storedClasses = await loadLS(LSK.classes, []);
        const storedReports = await loadLS(LSK.reports, []);
        const storedSettings = await loadLS(LSK.settings, state.settings);
        const storedCurrent = await loadLS(LSK.currentClassId, null);

        // Ensure data integrity - always use arrays
        state.classes = ensureArray(storedClasses);
        state.reports = ensureArray(storedReports);
        state.settings = { ...state.settings, ...storedSettings };
        state.currentClassId = storedCurrent || (state.classes[0]?.id ?? null);

        // Validate and fix classes structure
        state.classes.forEach((cls) => {
          if (!Array.isArray(cls.students)) {
            console.warn(`Class ${cls.name} has invalid students array, fixing...`);
            cls.students = [];
          }
        });

        // Create default class if no classes exist
        if (state.classes.length === 0) {
          const defaultClass = {
            id: uid("class"),
            name: "默认班级",
            students: [{ id: uid("stu"), name: "学生1" }],
          };
          state.classes.push(defaultClass);
          state.currentClassId = defaultClass.id;
          await persistAll();
        }        // set settings UI
        // Auto-select Keepwork if API key is empty
        if (!state.settings.apiKey || state.settings.apiKey.trim() === "") {
          state.settings.aiProvider = "keepwork";
        }
        
        els.aiProviderSelect.value = state.settings.aiProvider || "keepwork";
        els.apiKeyInput.value = state.settings.apiKey || "";
        els.modelInput.value = state.settings.model || "keepwork-pro";
        els.endpointInput.value = state.settings.endpoint || "https://ark.cn-beijing.volces.com/api/v3/chat/completions";
        els.matchSensitivity.value = state.settings.matchSensitivity || "loose";
        els.sendImageToggle.checked = !!state.settings.sendImageBase64;

        updateApiKeyAlert();
        updateProviderSettings();
      }

      async function persistAll() {
        await saveLS(LSK.classes, state.classes);
        await saveLS(LSK.reports, state.reports);
        await saveLS(LSK.settings, state.settings);
        await saveLS(LSK.currentClassId, state.currentClassId, true);
      }

      // ---------- UI Render ----------
      function renderClassesToHeader() {
        els.currentClassSelect.innerHTML = "";
        
        // Ensure state.classes is an array
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array, initializing to empty array");
          state.classes = [];
        }
        
        state.classes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          els.currentClassSelect.appendChild(opt);
        });
        els.currentClassSelect.value = state.currentClassId || "";
        const cls = getCurrentClass();
        els.currentClassName.textContent = cls ? cls.name : "-";
      }

      function renderClassModal() {
        // Classes
        els.classList.innerHTML = "";
        
        // Ensure state.classes is an array
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array in renderClassModal, initializing to empty array");
          state.classes = [];
        }
        
        state.classes.forEach((c) => {
          const div = document.createElement("div");
          div.className = "flex items-center justify-between p-2 border rounded-lg";
          
          // Ensure c.students is an array before accessing its length
          if (!Array.isArray(c.students)) {
            console.warn(`Class ${c.name} students is not an array, initializing to empty array`);
            c.students = [];
          }
          
          div.innerHTML = `
                <div class="flex-1">
                  <div class="font-medium">${c.name}</div>
                  <div class="text-xs text-slate-500">学生数：${c.students.length}</div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-act="switch" data-id="${c.id}" class="px-2 py-1 text-sm border rounded-lg ${state.currentClassId === c.id ? "bg-slate-900 text-white" : ""}">切换</button>
                  <button data-act="rename" data-id="${c.id}" class="px-2 py-1 text-sm border rounded-lg">重命名</button>
                  <button data-act="delete" data-id="${c.id}" class="px-2 py-1 text-sm border rounded-lg text-rose-700 border-rose-300">删除</button>
                </div>
              `;
          els.classList.appendChild(div);
        });

        const cls = getCurrentClass();
        els.manageClassName.textContent = cls ? cls.name : "-";

        // Students
        renderStudentList();
      }

      function renderStudentList() {
        const cls = getCurrentClass();
        els.studentList.innerHTML = "";
        if (!cls) return;
        
        // Ensure cls.students is an array before using array methods
        if (!Array.isArray(cls.students)) {
          console.warn("cls.students is not an array in renderStudentList, initializing to empty array");
          cls.students = [];
        }
        
        cls.students.forEach((s) => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between p-2 border rounded-lg";
          row.innerHTML = `
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs">${s.name.slice(0, 1)}</div>
                  <div>${s.name}</div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-act="rename-stu" data-id="${s.id}" class="px-2 py-1 text-sm border rounded-lg">重命名</button>
                  <button data-act="del-stu" data-id="${s.id}" class="px-2 py-1 text-sm border rounded-lg text-rose-700 border-rose-300">删除</button>
                </div>
              `;
          els.studentList.appendChild(row);
        });
      }

      function renderImageGrid() {
        els.imgCount.textContent = state.images.length;
        els.imageGrid.innerHTML = "";
        const classStudents = getCurrentClass()?.students || [];

        state.images.forEach((img) => {
          const container = document.createElement("div");
          container.className = "border rounded-xl p-3 relative";
          container.innerHTML = `
                <button data-act="remove-image" data-id="${img.id}" class="absolute top-2 right-2 w-6 h-6 bg-rose-500 hover:bg-rose-600 text-white rounded-full text-xs flex items-center justify-center z-10" title="删除此图片">×</button>
                <div class="aspect-[4/3] bg-slate-100 rounded-lg overflow-hidden mb-2">
                  <img src="${img.url}" alt="${img.file?.name || "image"}" class="w-full h-full object-contain">
                </div>
                <div class="text-xs text-slate-500 mb-2 line-clamp-2">${img.ocrText ? img.ocrText : "等待 OCR..."}</div>
                <div class="grid grid-cols-1 gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-sm">识别学生：</span>
                    <span class="text-sm font-medium ${img.studentId ? "text-emerald-700" : "text-amber-700"}">${img.detectedName || "未识别"}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm">手动指定：</label>
                    <select data-image="${img.id}" class="manual-select border rounded-lg px-2 py-1 text-sm flex-1">
                      <option value="">未指定</option>
                      ${classStudents.map((s) => `<option value="${s.id}" ${s.id === img.studentId ? "selected" : ""}>${s.name}</option>`).join("")}
                    </select>
                  </div>
                  <div class="flex items-center justify-between">
                    <div class="text-xs ${img.status === "error" ? "text-rose-700" : img.status === "已批改" ? "text-emerald-700" : img.status === "已识别" ? "text-blue-700" : img.status === "未批改" ? "text-orange-700" : "text-slate-500"}">状态：${img.status || "待处理"}</div>
                    ${img.status === "已批改" ? `<button data-act="regrade-image" data-id="${img.id}" class="text-xs px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-md" title="重新批改此图片">重新批改</button>` : 
                      (img.studentId && (img.status === "已识别" || img.status === "未批改")) ? `<button data-act="grade-single-image" data-id="${img.id}" class="text-xs px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md" title="批改此图片">单独批改</button>` : ""}
                  </div>
                  ${img.theme ? `<div class="text-xs text-slate-400">批改主题：${formatTheme(img.theme)}</div>` : ""}
                </div>
              `;
          els.imageGrid.appendChild(container);
        });

        // Unmatched notice
        const unmatched = state.images.filter((x) => !x.studentId);
        if (unmatched.length) {
          els.unmatchedNotice.classList.remove("hidden");
          els.unmatchedNotice.textContent = `有 ${unmatched.length} 张图片未能识别/匹配到学生姓名，请手动选择后再开始批改。`;
        } else {
          els.unmatchedNotice.classList.add("hidden");
        }
      }

      function renderResultsTable() {
        els.resultsTbody.innerHTML = "";
        state.results.forEach((r) => {
          const tr = document.createElement("tr");
          tr.className = "border-b";
          tr.innerHTML = `
                <td class="py-2 pr-3">${r.studentName}</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">${r.imageName || "-"}</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">${r.theme ? formatTheme(r.theme) : "-"}</td>
                <td class="py-2 pr-3 font-semibold">${r.score ?? "-"}/${r.maxScore ?? "-"}</td>
                <td class="py-2 pr-3">${r.level ?? "-"}</td>
                <td class="py-2 pr-3 text-slate-600">
                  <div class="line-clamp-2">${r.summary || r.comments || "-"}</div>
                </td>
                <td class="py-2">
                  <button data-id="${r.imageId}" class="btn-detail px-3 py-1.5 text-sm border rounded-lg">查看</button>
                </td>
              `;
          els.resultsTbody.appendChild(tr);
        });
        
        // 更新保存按钮状态和提示文字
        const hasResults = state.results.length > 0;
        els.btnSaveReport.disabled = !hasResults;
        
        if (hasResults) {
          els.btnSaveReport.textContent = `保存为报告 (${state.results.length}份)`;
          els.btnSaveReport.title = "保存当前批改结果到本地存档";
        } else {
          els.btnSaveReport.textContent = "保存为报告";
          els.btnSaveReport.title = "请先完成作业批改";
        }
      }

      function renderReportsList() {
        const clsId = state.currentClassId;
        const themeFilter = els.reportThemeFilter.value;
        
        // Ensure state.reports is an array before using array methods
        if (!Array.isArray(state.reports)) {
          console.warn("state.reports is not an array in renderReportsList, initializing to empty array");
          state.reports = [];
        }
        
        const list = state.reports
          .filter((r) => r.classId === clsId)
          .filter((r) => !themeFilter || r.theme === themeFilter)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        els.reportsList.innerHTML = "";
        if (!list.length) {
          els.reportsList.innerHTML = `<div class="p-4 text-slate-500 text-sm">暂无报告</div>`;
          return;
        }
        list.forEach((rep) => {
          const div = document.createElement("div");
          const avg = (rep.summary?.classAvg ?? 0).toFixed(1);
          const min = rep.summary?.min ?? "-";
          const max = rep.summary?.max ?? "-";
          div.className = "border rounded-xl p-4";
          div.innerHTML = `
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-semibold">${formatTheme(rep.theme)} · ${formatDate(rep.date)}</div>
                    <div class="text-xs text-slate-500">班级：${getClassById(rep.classId)?.name || "-"}</div>
                  </div>
                  <div class="text-sm text-slate-600">平均 ${avg}，最高 ${max}，最低 ${min}</div>
                </div>
                <div class="mt-3 overflow-auto scrollbar-thin">
                  <table class="min-w-full text-sm">
                    <thead>
                      <tr class="text-left text-slate-500 border-b">
                        <th class="py-2 pr-3">学生</th>
                        <th class="py-2 pr-3">分数</th>
                        <th class="py-2 pr-3">等级</th>
                        <th class="py-2 pr-3">摘要</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${rep.results
                        .map(
                          (r) => `
                        <tr class="border-b">
                          <td class="py-2 pr-3">${r.studentName}</td>
                          <td class="py-2 pr-3">${r.score}/${r.maxScore}</td>
                          <td class="py-2 pr-3">${r.level || "-"}</td>
                          <td class="py-2 pr-3 text-slate-600"><div class="line-clamp-2">${r.summary || r.comments || "-"}</div></td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
                <div class="mt-3 flex gap-2">
                  <button data-id="${rep.id}" data-act="export-json" class="px-3 py-1.5 text-sm border rounded-lg">导出 JSON</button>
                  <button data-id="${rep.id}" data-act="export-csv" class="px-3 py-1.5 text-sm border rounded-lg">导出 CSV</button>
                  <button data-id="${rep.id}" data-act="delete-report" class="px-3 py-1.5 text-sm border rounded-lg text-rose-700 border-rose-300">删除</button>
                </div>
              `;
          els.reportsList.appendChild(div);
        });
      }

      function formatTheme(t) {
        return { math: "数学作业", english: "英语作文", chinese: "语文作文", custom: "自定义" }[t] || t;
      }

      function updateApiKeyAlert() {
        if (state.settings.aiProvider === "keepwork" || !state.settings.apiKey || state.settings.apiKey.trim() === "") {
          // When using Keepwork or no API key, hide the alert since Keepwork SDK will be used
          els.apiKeyAlert.classList.add("hidden");
        } else {
          els.apiKeyAlert.classList.add("hidden");
        }
      }

      function updateProviderSettings() {
        const provider = state.settings.aiProvider || "doubao";
        if (provider === "keepwork") {
          document.getElementById("doubaoSettings").classList.add("hidden");
          document.getElementById("keepworkSettings").classList.remove("hidden");
        } else {
          document.getElementById("doubaoSettings").classList.remove("hidden");
          document.getElementById("keepworkSettings").classList.add("hidden");
        }
      }

      // ---------- Classes & Students ----------
      function getCurrentClass() {
        // Ensure state.classes is an array before using array methods
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array in getCurrentClass");
          state.classes = [];
        }
        return state.classes.find((c) => c.id === state.currentClassId) || null;
      }
      function getClassById(id) {
        // Ensure state.classes is an array before using array methods
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array in getClassById");
          state.classes = [];
        }
        return state.classes.find((c) => c.id === id) || null;
      }
      function getStudentById(classId, studentId) {
        return getClassById(classId)?.students.find((s) => s.id === studentId) || null;
      }

      async function addClass(name) {
        if (!name.trim()) return;
        // Ensure state.classes is an array before using array methods
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array in addClass, initializing to empty array");
          state.classes = [];
        }
        state.classes.push({ id: uid("class"), name: name.trim(), students: [] });
        if (!state.currentClassId) state.currentClassId = state.classes[0].id;
        await persistAll();
        renderClassesToHeader();
        renderClassModal();
      }
      async function deleteClass(id) {
        // Ensure state.classes is an array before using array methods
        if (!Array.isArray(state.classes)) {
          console.warn("state.classes is not an array in deleteClass, initializing to empty array");
          state.classes = [];
        }
        const i = state.classes.findIndex((c) => c.id === id);
        if (i >= 0) state.classes.splice(i, 1);
        if (state.currentClassId === id) {
          state.currentClassId = state.classes[0]?.id || null;
        }
        await persistAll();
        renderClassesToHeader();
        renderClassModal();
      }
      async function renameClass(id, newName) {
        const c = getClassById(id);
        if (!c) return;
        c.name = newName.trim() || c.name;
        await persistAll();
        renderClassesToHeader();
        renderClassModal();
      }
      async function importStudents(text) {
        const cls = getCurrentClass();
        if (!cls) return;
        
        // Ensure cls.students is an array before using array methods
        if (!Array.isArray(cls.students)) {
          console.warn("cls.students is not an array in importStudents, initializing to empty array");
          cls.students = [];
        }
        
        const names = (text || "")
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter(Boolean);
        const existed = new Set(cls.students.map((s) => normalize(s.name)));
        names.forEach((n) => {
          const key = normalize(n);
          if (!existed.has(key)) {
            cls.students.push({ id: uid("stu"), name: n });
            existed.add(key);
          }
        });
        await persistAll();
        renderClassModal();
        refreshStudentSelects(); // also refresh image cards
      }
      async function clearStudents() {
        const cls = getCurrentClass();
        if (!cls) return;
        cls.students = [];
        await persistAll();
        renderClassModal();
        refreshStudentSelects();
      }
      async function renameStudent(stuId, newName) {
        const cls = getCurrentClass();
        if (!cls) return;
        
        // Ensure cls.students is an array before using array methods
        if (!Array.isArray(cls.students)) {
          console.warn("cls.students is not an array in renameStudent, initializing to empty array");
          cls.students = [];
        }
        
        const s = cls.students.find((x) => x.id === stuId);
        if (!s) return;
        s.name = (newName || s.name).trim();
        await persistAll();
        renderClassModal();
        refreshStudentSelects();
      }
      async function deleteStudent(stuId) {
        const cls = getCurrentClass();
        if (!cls) return;
        
        // Ensure cls.students is an array before using array methods
        if (!Array.isArray(cls.students)) {
          console.warn("cls.students is not an array in deleteStudent, initializing to empty array");
          cls.students = [];
        }
        
        const i = cls.students.findIndex((x) => x.id === stuId);
        if (i >= 0) cls.students.splice(i, 1);
        // clear mapping in images
        state.images.forEach((img) => {
          if (img.studentId === stuId) {
            img.studentId = null;
            img.detectedName = null;
          }
        });
        await persistAll();
        renderClassModal();
        refreshStudentSelects();
        renderImageGrid();
      }

      function removeImage(imageId) {
        const imgIndex = state.images.findIndex(img => img.id === imageId);
        if (imgIndex >= 0) {
          // 从images数组中移除图片
          state.images.splice(imgIndex, 1);
          
          // 同时移除相关的批改结果
          state.results = state.results.filter(result => result.imageId !== imageId);
          
          // 更新UI
          renderImageGrid();
          renderResultsTable();
          
          showToast("图片已删除", "success");
        }
      }

      function clearAllImages() {
        if (confirm("确认删除所有图片？此操作不可撤销。")) {
          state.images = [];
          state.results = [];
          // 重置批改状态
          state.grading.isRunning = false;
          state.grading.isPaused = false;
          state.grading.currentIndex = 0;
          
          renderImageGrid();
          renderResultsTable();
          updateGradingButton();
          showToast("所有图片已清空", "success");
        }
      }

      async function regradeImage(imageId) {
        const img = state.images.find(x => x.id === imageId);
        if (!img) {
          showToast("图片未找到", "error");
          return;
        }

        if (!img.studentId) {
          showToast("请先为图片指定学生", "warning");
          return;
        }

        const cls = getCurrentClass();
        if (!cls) {
          showToast("请先选择班级", "warning");
          return;
        }

        const theme = els.themeSelect.value;
        const prompt = els.promptTextarea.value || defaultPrompts[theme] || defaultPrompts.custom;
        const maxScore = parseInt(els.maxScoreInput.value) || 100;

        try {
          // 显示批改进度
          showToast("正在重新批改图片...", "info");
          
          // 更新图片状态
          img.status = "批改中";
          renderImageGrid();

          // 移除旧的批改结果
          state.results = state.results.filter(r => r.imageId !== imageId);

          // 执行批改
          const result = await gradeOne(img, cls.name, theme, prompt, maxScore);
          
          if (result.error) {
            img.status = "批改失败";
            img.theme = theme; // 记录批改时使用的主题
            state.results.push({
              imageId: img.id,
              studentId: img.studentId,
              studentName: getStudentById(state.currentClassId, img.studentId)?.name || "未知",
              score: null,
              maxScore: maxScore,
              level: "-",
              summary: `错误：${result.error}`,
              detail: result.raw ? JSON.stringify(result.raw, null, 2) : result.error,
              raw: result.raw || null,
              imageName: img.file?.name || "-",
              theme: theme,
            });
            showToast("重新批改失败", "error");
          } else {
            img.status = "已批改";
            img.theme = theme; // 记录批改时使用的主题
            state.results.push({
              imageId: img.id,
              studentId: img.studentId,
              studentName: getStudentById(state.currentClassId, img.studentId)?.name || "未知",
              score: result.score,
              maxScore: result.maxScore,
              level: result.level,
              summary: result.summary,
              detail: result.detail,
              raw: result.raw,
              imageName: img.file?.name || "-",
              theme: theme,
            });
            showToast("重新批改完成", "success");
          }

          // 更新UI
          renderImageGrid();
          renderResultsTable();
          
        } catch (error) {
          console.error("重新批改失败:", error);
          img.status = "批改失败";
          renderImageGrid();
          showToast("重新批改过程中发生错误", "error");
        }
      }

      async function gradeSingleImage(imageId) {
        const img = state.images.find(x => x.id === imageId);
        if (!img) {
          showToast("图片不存在", "error");
          return;
        }
        
        if (!img.studentId) {
          showToast("请先选择学生", "warning");
          return;
        }
        
        const cls = getCurrentClass();
        if (!cls) {
          showToast("请先选择班级", "warning");
          return;
        }
        
        // 检查批改设置 - 从界面控件获取当前设置
        const theme = els.themeSelect.value;
        const prompt = els.promptTextarea.value.trim();
        const maxScore = Number(els.maxScoreInput.value) || 100;
        
        if (!theme || !prompt) {
          showToast("请先设置批改主题和提示词", "warning");
          return;
        }
        
        try {
          img.status = "批改中";
          renderImageGrid();
          showToast("正在批改图片...", "info");
          
          // Show streaming status for single image grading too
          showStreamingStatus();
          
          const result = await gradeOne(img, cls.name, theme, prompt, maxScore);
          
          console.log("单独批改结果:", result);
          
          if (result.error) {
            img.status = "批改失败";
            console.error("批改失败详情:", result.error);
            console.log("LLM原始响应:", result.raw);
            showToast("批改失败: " + result.error, "error");
          } else {
            // 保存批改结果
            const resultData = {
              id: uid("result"),
              imageId: img.id,
              studentId: img.studentId,
              studentName: getStudentById(state.currentClassId, img.studentId)?.name || img.detectedName,
              className: cls.name,
              theme,
              timestamp: new Date().toISOString(),
              ...result
            };
            
            console.log("保存批改结果:", resultData);
            
            // 移除旧的结果（如果存在）
            const existingIndex = state.results.findIndex(r => r.imageId === img.id);
            if (existingIndex >= 0) {
              state.results.splice(existingIndex, 1);
            }
            
            state.results.push(resultData);
            img.status = "已批改";
            img.theme = theme;
            
            showToast("批改完成", "success");
            
            // 更新显示
            renderImageGrid();
            renderResultsTable();
            
            // 如果当前在结果页面，刷新结果
            if (document.querySelector('.tab-content[data-tab="results"]')) {
              renderResultsTable();
            }
          }
        } catch (error) {
          console.error("单独批改失败:", error);
          img.status = "批改失败";
          renderImageGrid();
          showToast("批改过程中发生错误", "error");
        }
      }

      function refreshStudentSelects() {
        // refresh dropdowns on image cards
        renderImageGrid();
        // refresh student trend select
        const cls = getCurrentClass();
        els.studentTrendSelect.innerHTML = "";
        if (cls) {
          // Ensure cls.students is an array before using array methods
          if (!Array.isArray(cls.students)) {
            console.warn("cls.students is not an array in refreshStudentSelects, initializing to empty array");
            cls.students = [];
          }
          els.studentTrendSelect.innerHTML = `<option value="">选择学生</option>` + cls.students.map((s) => `<option value="${s.id}">${s.name}</option>`).join("");
        }
      }

      // ---------- Tabs ----------
      function initTabs() {
        const btns = document.querySelectorAll(".tab-btn");
        btns.forEach((btn) => {
          btn.addEventListener("click", () => {
            btns.forEach((b) => b.classList.remove("bg-white", "border-x", "border-t", "border-slate-200", "text-slate-900"));
            btns.forEach((b) => b.classList.add("text-slate-600"));
            btn.classList.add("bg-white", "border-x", "border-t", "border-slate-200", "text-slate-900");
            const tab = btn.dataset.tab;
            document.querySelectorAll(".tab-panel").forEach((p) => p.classList.add("hidden"));
            qs(`tab-${tab}`).classList.remove("hidden");
            if (tab === "analytics") buildAnalytics();
            if (tab === "reports") renderReportsList();
          });
        });
      }      // ---------- LLM-based OCR ----------
      async function performLLMOCR(imageFile) {
        try {
          const imageBase64 = await fileToDataURL(imageFile);

          const messages = [
            {
              role: "system",
              content: "你是一个专业的文字识别助手。请仔细识别图片中的所有文字内容，包括学生姓名、题目和答案。请以json格式返回识别结果，结构为：{\"content\": \"识别到的完整文字内容\", \"username\": \"学生姓名（如果能识别到）\"}。如果没有识别到学生姓名，username字段设为空字符串。",
            },
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: "请识别这张图片中的所有文字内容，特别注意学生姓名。请按照图片中的实际布局输出完整文字到content字段，如果能识别到学生姓名则填入username字段。以json格式返回：{\"content\": \"result text\", \"username\": \"if any\"}",
                },
                {
                  type: "image_url",
                  image_url: {
                    url: imageBase64,
                  },
                },
              ],
            },
          ];

          // Show streaming status for OCR
          showStreamingStatus();

          const result = await callLLM(messages, { 
            stream: true, // Enable streaming for OCR
            callback: (streamingText) => {
              updateStreamingText(streamingText);
            }
          });

          // Hide streaming status when done
          hideStreamingStatus();

          if (result.ok) {
            try {
              const jsonResponse = safeParseJSON(result.text);
              // Return the structured response with content and username
              return {
                content: jsonResponse.content || result.text.trim(),
                username: jsonResponse.username || ""
              };
            } catch (parseError) {
              // Fallback to original text if JSON parsing fails
              return {
                content: result.text.trim(),
                username: ""
              };
            }
          } else {
            console.error("LLM OCR error:", result.error);
            return {
              content: "",
              username: ""
            };
          }
        } catch (error) {
          console.error("OCR processing error:", error);
          // Hide streaming status on error
          hideStreamingStatus();
          return {
            content: "",
            username: ""
          };
        }
      }

      // ---------- OCR Processing ----------
      async function runOCRForImages() {
        const { matchSensitivity } = state.settings;
        const cls = getCurrentClass();
        if (!cls) return;

        // 只处理待OCR的图片，不重复处理已识别的图片
        const pendingImages = state.images.filter(img => img.status === "待 OCR");
        if (pendingImages.length === 0) {
          return; // 没有需要识别的图片
        }

        els.ocrProgress.classList.remove("hidden");
        els.ocrProgress.textContent = `正在识别 0/${pendingImages.length} ...`;

        let i = 0;
        for (const img of pendingImages) {
          i++;
          els.ocrProgress.textContent = `正在识别 ${i}/${pendingImages.length}：${img.file?.name || img.id}`;
          img.status = "OCR 中";
          renderImageGrid();

          try {
            const ocrResult = await performLLMOCR(img.file);
            img.ocrText = ocrResult.content;
            
            console.log("OCR结果:", {
              filename: img.file?.name,
              content: ocrResult.content,
              username: ocrResult.username
            });

            // Name match - prioritize username from OCR if available
            let matched = null;
            
            // First try to match using the extracted username
            if (ocrResult.username && ocrResult.username.trim()) {
              const extractedName = normalize(ocrResult.username.trim());
              console.log("尝试匹配用户名:", extractedName);
              for (const s of cls.students) {
                const sn = normalize(s.name);
                if (matchSensitivity === "strict" ? 
                    extractedName === sn || extractedName.includes(sn) : 
                    extractedName.includes(sn) || sn.includes(extractedName)) {
                  matched = s;
                  console.log("用户名匹配成功:", s.name);
                  break;
                }
              }
            }
            
            // If no match from username, fallback to searching in full content
            if (!matched) {
              const ntext = normalize(ocrResult.content);
              console.log("在全文中搜索学生姓名:", ntext);
              for (const s of cls.students) {
                const sn = normalize(s.name);
                if (matchSensitivity === "strict" ? ntext.includes(sn) && sn.length > 0 && new RegExp(sn).test(ntext) : ntext.includes(sn)) {
                  matched = s;
                  console.log("全文匹配成功:", s.name);
                  break;
                }
              }
            }
            
            if (matched) {
              img.studentId = matched.id;
              img.detectedName = matched.name;
              img.status = "未批改";  // 识别到学生后状态为未批改，等待批改
              console.log("最终识别结果:", matched.name);
            } else {
              img.studentId = null;
              img.detectedName = null;
              img.status = "未识别";
              console.log("未能识别到学生姓名");
            }
          } catch (e) {
            console.error("OCR error for image:", img.file?.name, e);
            img.status = "error";
            img.ocrText = "";
            img.studentId = null;
            img.detectedName = null;
          }
          renderImageGrid();
        }
        els.ocrProgress.textContent = `识别完成：${pendingImages.length} 张新图片`;
        setTimeout(() => els.ocrProgress.classList.add("hidden"), 1500);
      }

      // ---------- LLM API Integration ----------
      function buildMessages({ studentName, className, theme, prompt, maxScore, ocrText, imageBase64 }) {
        const system = `你是一名严格且友好的老师，负责${formatTheme(theme)}的作业批改。严格按照指令输出 JSON。`;
        const finalPrompt = prompt.replaceAll("{{MAX_SCORE}}", String(maxScore || 100));

        const userParts = [
          { type: "text", text: `班级：${className}\n学生：${studentName}\n主题：${formatTheme(theme)}\n` },
          { type: "text", text: `批改指令：\n${finalPrompt}\n` },
          { type: "text", text: `学生作答文本（OCR）：\n${ocrText || "(OCR 未识别到文本)"}\n` },
        ];

        if (imageBase64 && state.settings.sendImageBase64) {
          userParts.push({ type: "image_url", image_url: { url: imageBase64 } });
        }

        // For Ark/Doubao v3, content supports multimodal parts for some models; if not supported, API may ignore.
        return [
          { role: "system", content: system },
          { role: "user", content: userParts },
        ];
      }

      async function callLLM(messages, options = {}) {
        const { stream = true, callback = null } = options;
        
        // Use Keepwork SDK if API key is empty or provider is set to keepwork
        if (state.settings.aiProvider === "keepwork" || !state.settings.apiKey || state.settings.apiKey.trim() === "") {
          try {
            // Use sdk.aiChat.chat directly with messages array
            let fullResponse = '';
            const response = await sdk.aiChat.chat({
              messages: messages,
              model: 'keepwork-pro',
              temperature: 0,
              stream: stream,
              onMessage: stream ? (chunk) => {
                fullResponse = chunk;
                if(callback) callback(chunk);
              } : undefined
            });
            
            const finalText = stream ? fullResponse : response;
            return { ok: true, text: finalText };
          } catch (error) {
            console.error("Keepwork LLM error:", error);
            return { ok: false, error: error.message || String(error) };
          }
        }

        // Use Doubao API
        try {
          const requestBody = {
            model: state.settings.model,
            messages,
            temperature: 0.2,
            ...(JSON.stringify(messages).toLowerCase().includes('json') && { response_format: { type: "json_object" } }),
          };
          
          // Add stream parameter if streaming is enabled
          if (stream) {
            requestBody.stream = true;
          }
          
          const resp = await fetch(state.settings.endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${state.settings.apiKey}`,
            },
            body: JSON.stringify(requestBody),
          });
          
          if (!resp.ok) {
            const errText = await resp.text();
            return { ok: false, error: `HTTP ${resp.status}: ${errText}` };
          }
          
          if (stream) {
            // Handle streaming response
            const reader = resp.body?.getReader();
            const decoder = new TextDecoder('utf-8');
            let fullResponse = '';
            let buffer = '';
            
            if (reader) {
              while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    const jsonData = line.substring(6);
                    if (jsonData === '[DONE]') {
                      break;
                    }
                    
                    try {
                      const data = JSON.parse(jsonData);
                      const content = data?.choices?.[0]?.delta?.content || '';
                      if (content) {
                        fullResponse += content;
                        if(callback)
                          callback(fullResponse);
                      }
                    } catch (e) {
                      console.warn('Failed to parse streaming data:', e);
                    }
                  }
                }
              }
            }
            
            // Ensure no "data: " prefix remains in the final response
            if (fullResponse.startsWith('data: ')) {
              fullResponse = fullResponse.substring(6);
            }
            
            return { ok: true, text: fullResponse };
          } else {
            // Handle non-streaming response
            const data = await resp.json();
            const text = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.message?.[0]?.text || "";
            return { ok: true, text };
          }
        } catch (e) {
          return { ok: false, error: e.message || String(e) };
        }
      }

      function safeParseJSON(text) {
        if (!text) return null;
        
        // strip code fences if any
        let cleaned = text
          .replace(/^```(json)?/i, "")
          .replace(/```$/, "")
          .trim();
        
        // 尝试直接解析
        try {
          return JSON.parse(cleaned);
        } catch (e1) {
          console.log("第一次JSON解析失败:", e1.message);
        }
        
        // 尝试找到JSON对象
        const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            return JSON.parse(jsonMatch[0]);
          } catch (e2) {
            console.log("第二次JSON解析失败:", e2.message);
          }
        }
        
        // 尝试更宽松的匹配 - 找第一个{到最后一个}
        const firstBrace = cleaned.indexOf('{');
        const lastBrace = cleaned.lastIndexOf('}');
        if (firstBrace >= 0 && lastBrace > firstBrace) {
          const jsonStr = cleaned.substring(firstBrace, lastBrace + 1);
          try {
            return JSON.parse(jsonStr);
          } catch (e3) {
            console.log("第三次JSON解析失败:", e3.message);
          }
        }
        
        // 尝试处理常见的格式问题
        try {
          // 移除可能的前后缀文本
          let processed = cleaned;
          
          // 移除回答前的说明文本
          processed = processed.replace(/^[^{]*({[\s\S]*})[^}]*$/, '$1');
          
          // 处理单引号改双引号
          processed = processed.replace(/'/g, '"');
          
          // 处理属性名没有引号的情况（简单处理）
          processed = processed.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
          
          return JSON.parse(processed);
        } catch (e4) {
          console.log("第四次JSON解析失败:", e4.message);
          console.log("原始文本:", text);
        }
        
        return null;
      }

      async function gradeOne(imageItem, className, theme, prompt, maxScore) {
        const student = getStudentById(state.currentClassId, imageItem.studentId);
        const studentName = student?.name || imageItem.detectedName || "未知学生";

        const base64 = state.settings.sendImageBase64 ? await fileToDataURL(imageItem.file) : null;

        const messages = buildMessages({
          studentName,
          className,
          theme,
          prompt,
          maxScore,
          ocrText: imageItem.ocrText,
          imageBase64: base64,
        });

        // Show streaming status and enable streaming with callback
        showStreamingStatus();
        
        const res = await callLLM(messages, {
          stream: true,
          callback: (streamingText) => {
            updateStreamingText(streamingText);
          }
        });
        
        // Hide streaming status when done
        hideStreamingStatus();
        
        if (!res.ok) {
          return { error: res.error };
        }
        
        console.log("LLM原始响应:", res.text);
        
        const parsed = safeParseJSON(res.text);
        if (!parsed) {
          console.error("JSON解析失败，原始响应:", res.text);
          // 尝试从文本中提取有用信息，即使JSON解析失败
          const scoreMatch = res.text.match(/(?:score|得分|分数)["']?\s*:\s*(\d+)/i);
          const commentsMatch = res.text.match(/(?:comments|评语|评价)["']?\s*:\s*["']([^"']+)["']/i);
          
          if (scoreMatch || commentsMatch) {
            // 即使JSON解析失败，如果能提取到基本信息，仍然认为是成功的
            return {
              score: scoreMatch ? Number(scoreMatch[1]) : 0,
              maxScore: maxScore,
              level: "未知",
              summary: commentsMatch ? commentsMatch[1] : "JSON解析失败，但提取到部分信息",
              detail: res.text,
              raw: { 
                parseFailed: true, 
                extractedScore: scoreMatch ? scoreMatch[1] : null,
                extractedComments: commentsMatch ? commentsMatch[1] : null,
                originalText: res.text
              },
            };
          }
          
          return { error: "模型未返回有效 JSON。", raw: res.text };
        }
        return {
          score: Number(parsed.score),
          maxScore: Number(parsed.max_score || maxScore),
          level: parsed.level || "",
          summary: parsed.comments || "",
          detail: JSON.stringify(parsed, null, 2),
          raw: parsed,
        };
      }

      function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function startGrading() {
        const cls = getCurrentClass();
        if (!cls) {
          showToast("请先创建并选择班级", "warning");
          return;
        }
        if (!state.images.length) {
          showToast("请先上传图片", "warning");
          return;
        }

        // Ensure all mapped
        const unresolved = state.images.filter((x) => !x.studentId);
        if (unresolved.length) {
          showToast(`仍有 ${unresolved.length} 张图片未匹配到学生，请手动选择后再开始。`, "warning");
          return;
        }

        const theme = els.themeSelect.value;
        const prompt = els.promptTextarea.value || defaultPrompts[theme] || defaultPrompts.custom;
        const maxScore = Number(els.maxScoreInput.value || 100);

        // 如果不是继续模式，只清除当前主题相关的结果，支持多学科混合
        if (!state.grading.isPaused) {
          // 不完全清空results，而是让后续处理中遇到重复的图片时覆盖结果
          state.grading.currentIndex = 0;
        }
        
        state.grading.isRunning = true;
        state.grading.isPaused = false;
        
        els.gradingProgress.classList.remove("hidden");
        updateGradingButton();

        const totalImages = state.images.length;
        let idx = state.grading.currentIndex;
        
        for (let i = idx; i < totalImages; i++) {
          // 检查是否应该暂停
          if (state.grading.isPaused) {
            state.grading.currentIndex = i;
            hideStreamingStatus(); // Hide streaming when pausing
            els.gradingProgress.textContent = `批改已暂停：${i}/${totalImages}`;
            updateGradingButton();
            return;
          }
          
          const img = state.images[i];
          els.gradingProgress.textContent = `批改进度：${i + 1}/${totalImages}（${img.file?.name || img.id}）`;
          
          // 只跳过已经批改过的图片，避免重复调用LLM批改
          // 已识别但未批改的图片仍需要进行批改
          if (img.status === "已批改") {
            console.log(`跳过已批改图片: ${img.file?.name || img.id}`);
            // 确保已批改的结果在results中
            const existingResult = state.results.find(r => r.imageId === img.id);
            if (!existingResult) {
              console.log("已批改图片但未找到结果，跳过");
            }
            continue;
          }
          
          const result = await gradeOne(img, cls.name, theme, prompt, maxScore);
          
          // 移除该图片的旧结果（如果有的话），避免重复
          state.results = state.results.filter(r => r.imageId !== img.id);
          
          if (result.error) {
            img.status = "批改失败";
            img.theme = theme; // 记录批改时使用的主题
            state.results.push({
              imageId: img.id,
              studentId: img.studentId,
              studentName: getStudentById(state.currentClassId, img.studentId)?.name || "未知",
              score: null,
              maxScore: maxScore,
              level: "-",
              summary: `错误：${result.error}`,
              detail: result.raw ? JSON.stringify(result.raw, null, 2) : result.error,
              raw: result.raw || null,
              imageName: img.file?.name || "-",
              theme: theme,
            });
          } else {
            img.status = "已批改";
            img.theme = theme; // 记录批改时使用的主题
            state.results.push({
              imageId: img.id,
              studentId: img.studentId,
              studentName: getStudentById(state.currentClassId, img.studentId)?.name || "未知",
              score: result.score,
              maxScore: result.maxScore,
              level: result.level,
              summary: result.summary,
              detail: result.detail,
              raw: result.raw,
              imageName: img.file?.name || "-",
              theme: theme,
            });
          }
          renderImageGrid();
          renderResultsTable();
        }

        // 批改完成
        state.grading.isRunning = false;
        state.grading.isPaused = false;
        state.grading.currentIndex = 0;
        
        hideStreamingStatus(); // Hide streaming when batch grading completes
        els.gradingProgress.textContent = `批改完成`;
        setTimeout(() => els.gradingProgress.classList.add("hidden"), 1500);
        updateGradingButton();
        els.btnSaveReport.disabled = false;
      }

      function pauseGrading() {
        if (state.grading.isRunning) {
          state.grading.isPaused = true;
          showToast("批改已暂停", "info");
        }
      }

      function updateGradingButton() {
        if (state.grading.isRunning && !state.grading.isPaused) {
          // 正在批改中
          els.btnStartGrading.textContent = "暂停批改";
          els.btnStartGrading.className = "w-full py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg";
          els.btnStartGrading.disabled = false;
        } else if (state.grading.isPaused) {
          // 已暂停
          els.btnStartGrading.textContent = "继续批改";
          els.btnStartGrading.className = "w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg";
          els.btnStartGrading.disabled = false;
        } else {
          // 未开始或已完成
          els.btnStartGrading.textContent = "开始批改";
          els.btnStartGrading.className = "w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed";
          els.btnStartGrading.disabled = false;
        }
      }

      // Streaming status helpers
      function showStreamingStatus() {
        if (els.streamingStatus) {
          els.streamingStatus.classList.remove("hidden");
          els.streamingText.textContent = "";
          els.streamingText.classList.add("streaming-cursor");
        }
      }

      function updateStreamingText(text) {
        if (els.streamingText) {
          // Truncate very long text to prevent UI issues
          const maxLength = 500;
          let displayText = text;
          if (text.length > maxLength) {
            displayText = text.substring(0, maxLength) + "...";
          }
          
          els.streamingText.textContent = displayText;
          
          // Auto-scroll to bottom if text overflows
          els.streamingText.scrollTop = els.streamingText.scrollHeight;
        }
      }

      function hideStreamingStatus() {
        if (els.streamingStatus) {
          els.streamingStatus.classList.add("hidden");
          if (els.streamingText) {
            els.streamingText.classList.remove("streaming-cursor");
          }
        }
      }
      async function saveReport() {
        console.log("保存报告被调用，当前结果数量：", state.results.length);
        
        if (!state.results.length) {
          showToast("暂无可保存结果，请先完成批改", "warning");
          return;
        }
        
        const cls = getCurrentClass();
        if (!cls) {
          showToast("请先选择班级", "error");
          return;
        }
        
        const theme = els.themeSelect.value;
        const prompt = els.promptTextarea.value;
        const date = new Date().toISOString();

        try {
          // Aggregate
          const scores = state.results.map((r) => Number(r.score)).filter((s) => !isNaN(s));
          const classAvg = scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
          const min = scores.length ? Math.min(...scores) : 0;
          const max = scores.length ? Math.max(...scores) : 0;

          const report = {
            id: uid("rep"),
            classId: state.currentClassId,
            className: cls.name,
            theme,
            date,
            prompt,
            results: state.results,
            summary: { classAvg: Math.round(classAvg * 100) / 100, min, max, count: state.results.length },
          };
          
          state.reports.push(report);
          await persistAll();
          
          console.log("报告保存成功：", report);
          showToast(`报告已保存到本地存档 (${state.results.length}份作业)`, "success");
          renderReportsList();
          
          // 提供下载选项
          setTimeout(() => {
            if (confirm("是否需要导出报告为文本文件？")) {
              downloadReport(report);
            }
          }, 1000);
          
        } catch (error) {
          console.error("保存报告时出错：", error);
          showToast("保存报告时出错，请重试", "error");
        }
      }
      
      function downloadReport(report) {
        try {
          let content = `智能作业批改报告\n`;
          content += `======================\n\n`;
          content += `班级：${report.className}\n`;
          content += `主题：${report.theme}\n`;
          content += `生成时间：${formatDate(report.date)}\n`;
          content += `批改提示：${report.prompt}\n\n`;
          
          content += `统计摘要：\n`;
          content += `- 总计作业数：${report.summary.count}\n`;
          content += `- 平均分：${report.summary.classAvg}\n`;
          content += `- 最高分：${report.summary.max}\n`;
          content += `- 最低分：${report.summary.min}\n\n`;
          
          content += `详细结果：\n`;
          content += `======================\n`;
          report.results.forEach((r, i) => {
            content += `${i + 1}. ${r.studentName}\n`;
            content += `   得分：${r.score}/${r.maxScore}\n`;
            content += `   等级：${r.level || '未评级'}\n`;
            content += `   评语：${r.summary || r.comments || '无评语'}\n`;
            if (r.detail) {
              content += `   详细反馈：${r.detail}\n`;
            }
            content += `\n`;
          });
          
          const filename = `作业批改报告_${report.className}_${report.theme}_${new Date().toISOString().split('T')[0]}.txt`;
          downloadFile(filename, content);
          showToast("报告文件已下载", "success");
        } catch (error) {
          console.error("下载报告时出错：", error);
          showToast("下载报告时出错", "error");
        }
      }

      // ---------- Analytics ----------
      function buildAnalytics() {
        buildAvgChart();
        buildRanking();
        buildStudentChart();
      }

      function buildAvgChart() {
        const clsId = state.currentClassId;
        const themeFilter = els.analyticsThemeFilter.value;
        const list = state.reports
          .filter((r) => r.classId === clsId)
          .filter((r) => !themeFilter || r.theme === themeFilter)
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = list.map((r) => formatDate(r.date));
        const data = list.map((r) => Number(r.summary?.classAvg || 0).toFixed(1));

        if (state.charts.avg) {
          state.charts.avg.destroy();
        }
        state.charts.avg = new Chart(els.avgChart, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "平均分",
                data,
                tension: 0.3,
                borderColor: "#2b7fff",
                backgroundColor: "rgba(43,127,255,0.15)",
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, suggestedMax: 100 } },
          },
        });
      }

      function buildRanking() {
        const clsId = state.currentClassId;
        const classReports = state.reports.filter((r) => r.classId === clsId);
        if (!classReports.length) {
          els.rankingList.innerHTML = `<div class="text-sm text-slate-500">暂无报告</div>`;
          return;
        }
        const latest = classReports.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const ranked = [...latest.results].sort((a, b) => Number(b.score || 0) - Number(a.score || 0));

        els.rankingList.innerHTML = "";
        ranked.forEach((r, i) => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between p-2 border rounded-lg";
          row.innerHTML = `
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 rounded-full ${i < 3 ? "bg-amber-200" : "bg-slate-200"} flex items-center justify-center text-xs">${i + 1}</div>
                  <div>${r.studentName}</div>
                </div>
                <div class="font-medium">${r.score}/${r.maxScore}</div>
              `;
          els.rankingList.appendChild(row);
        });

        els.btnExportLatestCSV.onclick = () => {
          const lines = ["名次,学生,分数,满分,等级,摘要"];
          ranked.forEach((r, i) => {
            const summary = (r.summary || "").replace(/\n/g, " ").replace(/,/g, "，");
            lines.push(`${i + 1},${r.studentName},${r.score},${r.maxScore},${r.level || ""},${summary}`);
          });
          downloadFile(`ranking_${formatDate(latest.date)}.csv`, lines.join("\n"));
        };
      }

      function buildStudentChart() {
        const stuId = els.studentTrendSelect.value;
        const clsId = state.currentClassId;

        const recs = state.reports
          .filter((r) => r.classId === clsId)
          .map((r) => ({ date: r.date, theme: r.theme, row: r.results.find((x) => x.studentId === stuId) }))
          .filter((x) => x.row)
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = recs.map((x) => formatDate(x.date));
        const data = recs.map((x) => Number(x.row.score || 0));

        if (state.charts.student) {
          state.charts.student.destroy();
        }
        state.charts.student = new Chart(els.studentChart, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "得分",
                data,
                backgroundColor: "#10b981",
              },
            ],
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, suggestedMax: 100 } },
          },
        });
      }

      // ---------- Events ----------
      function bindEvents() {
        // Tabs
        initTabs();

        // Header
        els.btnManageClasses.addEventListener("click", () => {
          renderClassModal();
          els.classModal.classList.remove("hidden");
          els.classModal.classList.add("flex");
        });
        
        els.currentClassSelect.addEventListener("change", async (e) => {
          state.currentClassId = e.target.value;
          await persistAll();
          renderClassesToHeader();
          renderReportsList();
          refreshStudentSelects();
        });

        // Modals
        els.closeClassModal.addEventListener("click", () => {
          els.classModal.classList.add("hidden");
          els.classModal.classList.remove("flex");
        });
        els.classList.addEventListener("click", async (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if (act === "switch") {
            state.currentClassId = id;
            await persistAll();
            renderClassesToHeader();
            renderClassModal();
          } else if (act === "rename") {
            const c = getClassById(id);
            const name = prompt("输入新班级名", c?.name || "");
            if (name) await renameClass(id, name);
          } else if (act === "delete") {
            if (confirm("确认删除该班级及其关联报告？此操作不可撤销。")) {
              // Also delete reports
              state.reports = state.reports.filter((r) => r.classId !== id);
              await deleteClass(id);
              await persistAll();
              renderReportsList();
            }
          }
        });
        els.btnAddClass.addEventListener("click", async () => await addClass(els.newClassName.value));
        els.saveClassChanges.addEventListener("click", async () => {
          await persistAll();
          showToast("已保存班级与学生更改", "success");
          els.classModal.classList.add("hidden");
          els.classModal.classList.remove("flex");
          renderClassesToHeader();
        });
        els.studentList.addEventListener("click", async (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if (act === "rename-stu") {
            const s = getStudentById(state.currentClassId, id);
            const name = prompt("输入新学生姓名", s?.name || "");
            if (name) await renameStudent(id, name);
          } else if (act === "del-stu") {
            if (confirm("确认删除该学生？")) await deleteStudent(id);
          }
        });
        els.btnImportStudents.addEventListener("click", async () => await importStudents(els.bulkStudentsInput.value));
        els.btnClearStudents.addEventListener("click", async () => {
          if (confirm("确认清空当前班级全部学生？")) await clearStudents();
        });

        // Upload & OCR
        els.btnChooseFiles.addEventListener("click", () => els.fileInput.click());
        els.btnClearImages.addEventListener("click", clearAllImages);
        els.fileInput.addEventListener("change", async (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          const added = files.map((f) => ({
            id: uid("img"),
            file: f,
            url: URL.createObjectURL(f),
            ocrText: "",
            detectedName: null,
            studentId: null,
            status: "待 OCR",
          }));
          state.images.push(...added);
          renderImageGrid();
          await runOCRForImages();
        });

        // Manual assign student mapping
        els.imageGrid.addEventListener("change", (e) => {
          const sel = e.target.closest(".manual-select");
          if (!sel) return;
          const imageId = sel.getAttribute("data-image");
          const img = state.images.find((x) => x.id === imageId);
          const val = sel.value;
          if (img) {
            img.studentId = val || null;
            img.detectedName = val ? getStudentById(state.currentClassId, val)?.name || null : img.detectedName;
            // 如果手动选择了学生，且当前状态不是已批改，则设置为未批改（如果有OCR文本）或已识别（如果没有OCR文本但手动选择了学生）
            if (val && img.status !== "已批改") {
              img.status = img.ocrText ? "未批改" : "已识别";
            } else if (!val) {
              // 如果取消选择学生，根据OCR情况设置状态
              img.status = "未识别";
            }
            renderImageGrid();
          }
        });

        // Image removal and regrade
        els.imageGrid.addEventListener("click", (e) => {
          const removeBtn = e.target.closest("[data-act='remove-image']");
          if (removeBtn) {
            const imageId = removeBtn.getAttribute("data-id");
            if (confirm("确认删除此图片？")) {
              removeImage(imageId);
            }
            return;
          }
          
          const regradeBtn = e.target.closest("[data-act='regrade-image']");
          if (regradeBtn) {
            const imageId = regradeBtn.getAttribute("data-id");
            if (confirm("确认重新批改此图片？这将覆盖现有的批改结果。")) {
              regradeImage(imageId);
            }
            return;
          }
          
          const gradeSingleBtn = e.target.closest("[data-act='grade-single-image']");
          if (gradeSingleBtn) {
            const imageId = gradeSingleBtn.getAttribute("data-id");
            gradeSingleImage(imageId);
            return;
          }
        });

        // Grading
        els.btnStartGrading.addEventListener("click", () => {
          if (state.grading.isRunning && !state.grading.isPaused) {
            // 正在批改中，点击暂停
            pauseGrading();
          } else {
            // 开始批改或继续批改
            startGrading();
          }
        });
        els.btnSaveReport.addEventListener("click", async () => await saveReport());

        // Results detail
        els.resultsTbody.addEventListener("click", (e) => {
          const btn = e.target.closest(".btn-detail");
          if (!btn) return;
          const id = btn.getAttribute("data-id");
          const r = state.results.find((x) => x.imageId === id);
          if (!r) return;
          els.detailContent.textContent = r.detail || "无";
          els.detailModal.classList.remove("hidden");
          els.detailModal.classList.add("flex");
        });
        els.closeDetailModal.addEventListener("click", () => {
          els.detailModal.classList.add("hidden");
          els.detailModal.classList.remove("flex");
        });

        // Prompt Settings Modal
        els.btnPromptSettings.addEventListener("click", () => {
          // Load current settings into modal
          els.promptModalTextarea.value = els.promptTextarea.value || defaultPrompts[els.themeSelect.value] || defaultPrompts.custom;
          els.maxScoreModalInput.value = els.maxScoreInput.value || 100;
          els.levelModalToggle.value = els.levelToggle.value || "on";
          els.promptModal.classList.remove("hidden");
          els.promptModal.classList.add("flex");
        });
        els.closePromptModal.addEventListener("click", () => {
          els.promptModal.classList.add("hidden");
          els.promptModal.classList.remove("flex");
        });
        els.btnResetPrompt.addEventListener("click", () => {
          const theme = els.themeSelect.value;
          const maxScore = Number(els.maxScoreModalInput.value || 100);
          const p = (defaultPrompts[theme] || defaultPrompts.custom).replaceAll("{{MAX_SCORE}}", String(maxScore));
          els.promptModalTextarea.value = p;
        });
        els.btnSavePromptSettings.addEventListener("click", () => {
          els.promptTextarea.value = els.promptModalTextarea.value;
          els.maxScoreInput.value = els.maxScoreModalInput.value;
          els.levelToggle.value = els.levelModalToggle.value;
          els.promptModal.classList.add("hidden");
          els.promptModal.classList.remove("flex");
          showToast("提示词设置已保存", "success");
        });
        els.btnCancelPromptSettings.addEventListener("click", () => {
          els.promptModal.classList.add("hidden");
          els.promptModal.classList.remove("flex");
        });

        // Reports
        els.reportThemeFilter.addEventListener("change", renderReportsList);
        els.reportsList.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          const rep = state.reports.find((r) => r.id === id);
          if (!rep) return;
          if (act === "export-json") {
            downloadFile(`report_${formatDate(rep.date)}.json`, JSON.stringify(rep, null, 2));
          } else if (act === "export-csv") {
            const lines = ["学生,分数,满分,等级,摘要,主题,日期"];
            rep.results.forEach((r) => {
              const summary = (r.summary || "").replace(/\n/g, " ").replace(/,/g, "，");
              lines.push(`${r.studentName},${r.score},${r.maxScore},${r.level || ""},${summary},${formatTheme(rep.theme)},${formatDate(rep.date)}`);
            });
            downloadFile(`report_${formatDate(rep.date)}.csv`, lines.join("\n"));
          } else if (act === "delete-report") {
            if (confirm("确认删除该报告？")) {
              state.reports = state.reports.filter((x) => x.id !== id);
              persistAll();
              renderReportsList();
            }
          }
        }); // Analytics
        els.analyticsThemeFilter.addEventListener("change", buildAnalytics);
        els.studentTrendSelect.addEventListener("change", buildStudentChart);
        els.btnExportLatestCSV.addEventListener("click", () => {}); // set in buildRanking

        // Settings
        els.aiProviderSelect.addEventListener("change", async () => {
          state.settings.aiProvider = els.aiProviderSelect.value;
          updateProviderSettings();
          updateApiKeyAlert();
        });
        
        // Auto-switch provider based on API key presence
        els.apiKeyInput.addEventListener("input", () => {
          const apiKey = els.apiKeyInput.value.trim();
          if (!apiKey) {
            // No API key, switch to Keepwork
            state.settings.aiProvider = "keepwork";
            els.aiProviderSelect.value = "keepwork";
          } else {
            // API key provided, switch to Doubao
            state.settings.aiProvider = "doubao";
            els.aiProviderSelect.value = "doubao";
          }
          updateProviderSettings();
          updateApiKeyAlert();
        });
        
        els.btnSaveApiSettings.addEventListener("click", async () => {
          const apiKey = els.apiKeyInput.value.trim();
          
          // Auto-switch provider based on API key presence
          if (!apiKey) {
            state.settings.aiProvider = "keepwork";
            els.aiProviderSelect.value = "keepwork";
          } else {
            state.settings.aiProvider = "doubao";
            els.aiProviderSelect.value = "doubao";
          }
          
          state.settings.apiKey = apiKey;
          state.settings.model = els.modelInput.value.trim();
          state.settings.endpoint = els.endpointInput.value.trim();
          state.settings.matchSensitivity = els.matchSensitivity.value;
          state.settings.sendImageBase64 = !!els.sendImageToggle.checked;
          
          await persistAll();
          updateApiKeyAlert();
          updateProviderSettings();
          
          const providerName = state.settings.aiProvider === "keepwork" ? "Keepwork" : "Doubao";
          showToast(`${providerName} 设置已保存`, "success");
        });
        
        els.btnSaveKeepworkSettings.addEventListener("click", async () => {
          state.settings.aiProvider = "keepwork";
          await persistAll();
          updateApiKeyAlert();
          
          showToast("Keepwork 设置已保存", "success");
        });
        
        // Test LLM buttons
        els.btnTestDoubaoLLM.addEventListener("click", () => {
          openTestLLMModal("doubao");
        });
        
        els.btnTestKeepworkLLM.addEventListener("click", () => {
          openTestLLMModal("keepwork");
        });
        
        // Test LLM Modal
        els.closeTestLLMModal.addEventListener("click", closeTestLLMModal);
        els.btnCancelLLMTest.addEventListener("click", closeTestLLMModal);
        els.btnRunLLMTest.addEventListener("click", () => {
          const provider = els.testLLMModal.dataset.provider;
          testLLM(provider === "current" ? null : provider);
        });
        
        // Click outside to close modals
        els.testLLMModal.addEventListener("click", (e) => {
          if (e.target === els.testLLMModal) closeTestLLMModal();
        });
        
        els.btnSeedDemo.addEventListener("click", async () => await seedDemoData());
        els.btnClearAll.addEventListener("click", () => {
          if (!confirm("确认清空全部数据（班级、报告、设置、缓存图片）？此操作不可恢复。")) return;
          location.reload();
        });
      }

      // ---------- Test LLM Functions ----------
      function openTestLLMModal(provider) {
        els.testLLMModal.dataset.provider = provider;
        const modalTitle = els.testLLMModal.querySelector('h3');
        if (provider === "doubao") {
          modalTitle.textContent = "测试 Doubao LLM 连接";
        } else if (provider === "keepwork") {
          modalTitle.textContent = "测试 Keepwork LLM 连接";
        } else {
          modalTitle.textContent = "测试 LLM 连接";
        }
        
        // Reset modal state
        els.testLLMProgress.classList.add("hidden");
        els.testLLMResult.classList.add("hidden");
        els.testLLMInput.value = "你好，请简单介绍一下自己。";
        els.testLLMResultContent.textContent = "";
        
        els.testLLMModal.classList.remove("hidden");
        els.testLLMModal.classList.add("flex");
      }

      function closeTestLLMModal() {
        els.testLLMModal.classList.add("hidden");
        els.testLLMModal.classList.remove("flex");
      }

      async function testLLM(provider = null) {
        const testMessage = els.testLLMInput.value.trim();
        if (!testMessage) {
          showToast("请输入测试消息", "warning");
          return;
        }

        // Use current provider if not specified
        const targetProvider = provider || state.settings.aiProvider;
        
        // Show progress
        els.testLLMProgress.classList.remove("hidden");
        els.testLLMResult.classList.add("hidden");
        els.btnRunLLMTest.disabled = true;
        els.btnRunLLMTest.textContent = "测试中...";

        try {
          // Build simple test messages
          const messages = [
              {
                "role": "user",
                "content": [
                  {
                    "type": "text",
                    "text": "what is your name?"
                  },
                ]
              }
            ]

          console.log(`Testing ${targetProvider} LLM with message:`, testMessage);
          
          const startTime = Date.now();
          
          // Hide progress and show result container immediately for streaming
          els.testLLMProgress.classList.add("hidden");
          els.testLLMResult.classList.remove("hidden");
          els.testLLMResultContent.textContent = `正在测试 ${targetProvider.toUpperCase()}...`;
          
          const result = await callLLM(messages, {
            stream: true,
            callback: (chunk) => {
              // Update the content as streaming progresses
              els.testLLMResultContent.textContent = `🔄 正在接收响应...\n\n${targetProvider.toUpperCase()} 响应:\n${chunk}`;
            }
          });
          
          const endTime = Date.now();
          const duration = endTime - startTime;

          if (result.ok) {
            els.testLLMResultContent.textContent = `✅ 测试成功 (${duration}ms)\n\n${targetProvider.toUpperCase()} 响应:\n${result.text}`;
            showToast(`${targetProvider.toUpperCase()} LLM 连接测试成功`, "success");
          } else {
            els.testLLMResultContent.textContent = `❌ 测试失败\n\n错误信息:\n${result.error}`;
            showToast(`${targetProvider.toUpperCase()} LLM 连接测试失败`, "error");
          }

        } catch (error) {
          console.error("Test LLM error:", error);
          els.testLLMProgress.classList.add("hidden");
          els.testLLMResult.classList.remove("hidden");
          els.testLLMResultContent.textContent = `❌ 测试异常\n\n错误信息:\n${error.message || String(error)}`;
          showToast("LLM 测试过程中发生异常", "error");
        } finally {
          // Reset button state
          els.btnRunLLMTest.disabled = false;
          els.btnRunLLMTest.textContent = "开始测试";
        }
      }

      // ---------- Demo Data ----------
      async function seedDemoData() {
        if (!state.classes.length) {
          state.classes = [
            {
              id: uid("class"),
              name: "高一(1)班",
              students: [
                { id: uid("stu"), name: "张三" },
                { id: uid("stu"), name: "李四" },
                { id: uid("stu"), name: "王五" },
                { id: uid("stu"), name: "赵六" },
              ],
            },
            {
              id: uid("class"),
              name: "高一(2)班",
              students: [
                { id: uid("stu"), name: "陈七" },
                { id: uid("stu"), name: "孙八" },
              ],
            },
          ];
          state.currentClassId = state.classes[0].id;
        }
        // Demo reports
        if (!state.reports.length) {
          const c0 = state.classes[0];
          if (c0) {
            // Ensure c0.students is an array before using array methods
            if (!Array.isArray(c0.students)) {
              console.warn("c0.students is not an array in seedDemoData, initializing to empty array");
              c0.students = [];
            }
            
            const mkRep = (daysAgo, theme) => {
              const date = new Date(Date.now() - daysAgo * 86400000).toISOString();
              const results = c0.students.map((s) => {
              const score = Math.floor(60 + Math.random() * 40);
              return {
                imageId: uid("img"),
                studentId: s.id,
                studentName: s.name,
                score,
                maxScore: 100,
                level: score >= 90 ? "A" : score >= 80 ? "B" : score >= 70 ? "C" : "D",
                summary: "总体表现良好，注意细节与规范。",
                detail: JSON.stringify({ score, max_score: 100, level: "B", comments: "不错", mistakes: [] }, null, 2),
                raw: null,
                imageName: "-",
              };
            });
            const scores = results.map((r) => r.score);
            const report = {
              id: uid("rep"),
              classId: c0.id,
              theme,
              date,
              prompt: defaultPrompts[theme],
              results,
              summary: {
                classAvg: scores.reduce((a, b) => a + b, 0) / scores.length,
                min: Math.min(...scores),
                max: Math.max(...scores),
                count: results.length,
              },
            };
            state.reports.push(report);
          };
          mkRep(15, "math");
          mkRep(7, "english");
          mkRep(3, "math");
          }
        }
        await persistAll();
        renderClassesToHeader();
        renderReportsList();
        refreshStudentSelects();
        showToast("已填充示例数据", "success");
      }

      async function StartPage() {
        try {
          cacheDOM();
          await initFromStorage();
          
          // Additional safety check to ensure state.classes is always an array
          if (!Array.isArray(state.classes)) {
            console.warn("state.classes is not an array after initFromStorage, resetting to empty array");
            state.classes = [];
          }
          if (!Array.isArray(state.reports)) {
            console.warn("state.reports is not an array after initFromStorage, resetting to empty array");
            state.reports = [];
          }
          
          bindEvents();
          renderClassesToHeader();
          refreshStudentSelects();
          // default prompt
          els.themeSelect.value = "math";
          els.maxScoreInput.value = 100;
          els.levelToggle.value = "on";
          els.promptTextarea.value = (defaultPrompts["math"] || "").replaceAll("{{MAX_SCORE}}", "100");
        } catch (error) {
          console.error("Error during StartPage initialization:", error);
          showToast("初始化失败，请刷新页面重试", "error");
        }
        // 初始化按钮状态
        updateGradingButton();
      }
      StartPage();
    </script>
  </body>
</html>
