<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¶…æ£’å‡æœŸè®¡åˆ’</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        body {
            font-family: 'Comic Neue', cursive;
        }

        .activity-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .time-plan-area {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .activity-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .time-slot {
            min-height: 120px;
            transition: background-color 0.3s ease;
        }

        .time-slot.drag-over {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .star {
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .completed-task {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .time-exceeded {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        .time-warning {
            border-color: #f59e0b !important;
            background-color: #fffbeb !important;
        }

        .diy-activity {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .diy-input {
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            color: white;
        }

        .diy-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .drag-placeholder {
            background-color: #e5e7eb;
            border: 2px dashed #9ca3af;
            min-height: 60px;
            border-radius: 8px;
        }

        .dragging {
            opacity: 0.5;
        }

        .drop-zone {
            height: 20px;
            margin: 4px 0;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: transparent;
            border: 1px dashed transparent;
        }

        .drop-zone.drag-over {
            height: 40px;
            background-color: #3b82f6;
            opacity: 0.8;
            border: 2px dashed #1d4ed8;
        }
        
        /* Make the entire activity item wrapper act as a drop zone when dragging */
        .dragging ~ .activity-item-wrapper,
        .activity-item-wrapper:hover .drop-zone {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* Increase sensitivity for empty drop zones */
        .drop-zone-empty {
            min-height: 60px;
            padding: 8px;
        }

        .drop-zone-empty {
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            transition: all 0.2s ease;
            padding: 16px;
            margin: 8px 0;
        }

        .drop-zone-empty.drag-over {
            background-color: #dbeafe;
            border-color: #3b82f6;
            border-style: solid;
            min-height: 100px;
        }

        .activity-item-wrapper {
            position: relative;
        }
        
        /* Visual feedback when dragging */
        body.dragging-active .drop-zone {
            border: 1px dashed #9ca3af;
            background-color: rgba(156, 163, 175, 0.1);
        }
        
        body.dragging-active .time-slot {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        /* Improve hover states for better UX */
        .activity-item-wrapper:hover .drop-zone {
            opacity: 0.6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* ä½œæ¯æ—¶é—´è®¾ç½®æ ·å¼ */
        input[type="time"] {
            font-family: 'Comic Neue', cursive;
            font-size: 14px;
        }
        
        input[type="time"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .schedule-message {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- æ¨¡æ¿ç®¡ç†åŒº -->
        <div class="bg-white rounded-xl p-4 mb-4 shadow-lg">
            <div class="flex items-center justify-center space-x-4 flex-wrap">
                <span class="text-lg font-bold text-blue-600">ğŸ“‹ è®¡åˆ’æ¨¡æ¿:</span>
                <div class="relative">
                    <input type="text" id="templateCombobox" list="templateList" 
                           placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡æ¿åç§°" 
                           class="px-3 py-2 border-2 border-blue-300 rounded-lg min-w-48"
                           onchange="handleTemplateSelect()"
                           oninput="handleTemplateInput()" />
                    <datalist id="templateList">
                        <!-- æ¨¡æ¿é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </datalist>
                </div>
                <button onclick="saveCurrentTemplate()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                    ğŸ’¾ ä¿å­˜æ¨¡æ¿
                </button>
                <button onclick="deleteCurrentTemplate()"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                    ğŸ—‘ï¸ åˆ é™¤æ¨¡æ¿
                </button>
            </div>
            

        </div>

        <div class="grid lg:grid-cols-3 gap-6" style="height: calc(100vh - 180px);">
            <!-- æ´»åŠ¨é€‰æ‹©åŒº -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 shadow-lg h-full flex flex-col">
                    <h2 class="text-2xl font-bold text-center text-purple-600 mb-4">ğŸˆ é€‰æ‹©æ´»åŠ¨</h2>
                    <div class="activity-list flex-1">
                        <div class="grid grid-cols-1 gap-3" id="activities">
                            <!-- æ´»åŠ¨å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´è®¡åˆ’åŒº -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 shadow-lg h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h2 class="text-2xl font-bold text-purple-600">â° æˆ‘çš„ä¸€å¤©è®¡åˆ’</h2>
                        <div class="flex space-x-4 text-sm">
                            <div>
                                <span class="text-lg">â­ å®Œæˆ: </span>
                                <span id="score" class="text-xl font-bold text-yellow-500">0</span>
                                <span> / </span>
                                <span id="total" class="text-xl font-bold text-gray-500">0</span>
                            </div>
                            <div>
                                <span class="text-lg">â° æ€»è®¡: </span>
                                <span id="totalPlannedTime" class="text-xl font-bold text-blue-500">0</span>
                                <span> åˆ†é’Ÿ</span>
                            </div>
                        </div>
                    </div>
                    <div class="time-plan-area flex-1">
                        <div class="space-y-4" id="timeSlots">
                            <!-- æ—¶é—´æ®µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¥–åŠ±å±•ç¤ºåŒº -->
        <div id="rewards" class="mt-4 text-center hidden">
            <div class="bg-yellow-100 border-4 border-yellow-400 rounded-xl p-4">
                <h3 class="text-xl font-bold text-yellow-600 mb-2">ğŸ‰ å¤ªæ£’äº†ï¼</h3>
                <p class="text-yellow-700">ä½ å®Œæˆäº†ä»Šå¤©çš„è®¡åˆ’ï¼è·å¾—äº†ä¸€é¢—æ˜Ÿæ˜Ÿ â­</p>
            </div>
        </div>
    </div>

    <script>
        // æ´»åŠ¨æ•°æ® - å¢åŠ é»˜è®¤æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
        const activities = [
            { id: 'study', name: 'ğŸ“š å­¦ä¹ æ—¶é—´', emoji: 'ğŸ“š', color: 'bg-blue-100 border-blue-300', defaultDuration: 60 },
            { id: 'read', name: 'ğŸ“– é˜…è¯»', emoji: 'ğŸ“–', color: 'bg-green-100 border-green-300', defaultDuration: 30 },
            { id: 'exercise', name: 'ğŸƒ è¿åŠ¨', emoji: 'ğŸƒ', color: 'bg-red-100 border-red-300', defaultDuration: 45 },
            { id: 'play', name: 'ğŸ® æ¸¸æˆ', emoji: 'ğŸ®', color: 'bg-purple-100 border-purple-300', defaultDuration: 60 },
            { id: 'art', name: 'ğŸ¨ ç”»ç”»æ‰‹å·¥', emoji: 'ğŸ¨', color: 'bg-pink-100 border-pink-300', defaultDuration: 45 },
            { id: 'music', name: 'ğŸµ éŸ³ä¹', emoji: 'ğŸµ', color: 'bg-yellow-100 border-yellow-300', defaultDuration: 30 },
            { id: 'help', name: 'ğŸ  å¸®å¿™åšå®¶åŠ¡', emoji: 'ğŸ ', color: 'bg-orange-100 border-orange-300', defaultDuration: 30 },
            { id: 'outdoor', name: 'ğŸŒ³ æˆ·å¤–æ´»åŠ¨', emoji: 'ğŸŒ³', color: 'bg-teal-100 border-teal-300', defaultDuration: 60 },
            { id: 'friend', name: 'ğŸ‘« å’Œæœ‹å‹ç©', emoji: 'ğŸ‘«', color: 'bg-indigo-100 border-indigo-300', defaultDuration: 30 },
            { id: 'rest', name: 'ğŸ˜´ ä¼‘æ¯', emoji: 'ğŸ˜´', color: 'bg-gray-100 border-gray-300', defaultDuration: 30 },
            { id: 'meal', name: 'ğŸ½ï¸ åƒé¥­', emoji: 'ğŸ½ï¸', color: 'bg-amber-100 border-amber-300', defaultDuration: 30 },
            { id: 'create', name: 'âœ¨ è‡ªç”±åˆ›ä½œ', emoji: 'âœ¨', color: 'bg-violet-100 border-violet-300', defaultDuration: 45 }
        ];

        let customActivities = []; // å­˜å‚¨è‡ªå®šä¹‰æ´»åŠ¨

        // æ—¶é—´æ®µé…ç½®
        let timeSlotConfig = {
            morning: { name: 'ğŸŒ… ä¸Šåˆ', maxHours: 3, start: '09:00', end: '12:00' },
            afternoon: { name: 'â˜€ï¸ ä¸‹åˆ', maxHours: 3, start: '14:00', end: '17:00' },
            evening: { name: 'ğŸŒ™ æ™šä¸Š', maxHours: 2, start: '19:00', end: '24:00' }
        };

        let currentPlan = {};
        let completedTasks = {};
        let activityDurations = {}; // å­˜å‚¨æ¯ä¸ªæ´»åŠ¨å®ä¾‹çš„æ—¶é•¿
        let templates = {}; // å­˜å‚¨è®¡åˆ’æ¨¡æ¿
        let currentTemplate = null; // å½“å‰é€‰ä¸­çš„æ¨¡æ¿åç§°
        
        // ä½œæ¯æ—¶é—´é…ç½®
        let scheduleSettings = {
            wakeUpTime: '07:00',
            bedTime: '22:00'
        };

        // è°ƒæ•´æ´»åŠ¨æ—¶é—´ï¼ˆæ–°å¢å‡½æ•°ï¼Œæ”¯æŒ+/-5åˆ†é’Ÿæ­¥è¿›ï¼‰
        function adjustActivityTime(slotId, instanceId, adjustment) {
            const activityItem = currentPlan[slotId]?.find(item => item.instanceId === instanceId);
            if (!activityItem) return;

            const newDuration = activityItem.duration + adjustment;
            
            // ç¡®ä¿æ—¶é—´ä¸å°‘äº5åˆ†é’Ÿï¼Œä¸è¶…è¿‡120åˆ†é’Ÿ
            if (newDuration < 5) {
                showWarningMessage('æ´»åŠ¨æ—¶é—´ä¸èƒ½å°‘äº5åˆ†é’Ÿï¼');
                return;
            }
            if (newDuration > 120) {
                showWarningMessage('æ´»åŠ¨æ—¶é—´ä¸èƒ½è¶…è¿‡120åˆ†é’Ÿï¼');
                return;
            }

            // åªæœ‰åœ¨å¢åŠ æ—¶é—´æ—¶æ‰æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
            if (adjustment > 0) {
                // è®¡ç®—å…¶ä»–æ´»åŠ¨çš„æ€»æ—¶é•¿
                const otherActivitiesTime = currentPlan[slotId]
                    .filter(item => item.instanceId !== instanceId)
                    .reduce((total, item) => total + item.duration, 0);

                const maxTime = timeSlotConfig[slotId].maxHours * 60;

                if (otherActivitiesTime + newDuration > maxTime) {
                    showWarningMessage(`æ—¶é—´è¶…é™ï¼${timeSlotConfig[slotId].name}æœ€å¤š${maxTime}åˆ†é’Ÿï¼Œå…¶ä»–æ´»åŠ¨å·²ç”¨${otherActivitiesTime}åˆ†é’Ÿã€‚`);
                    return;
                }
            }

            // æ›´æ–°æ—¶é•¿
            activityItem.duration = newDuration;
            if (!activityDurations[slotId]) {
                activityDurations[slotId] = {};
            }
            activityDurations[slotId][instanceId] = newDuration;

            updateSlotDisplay(slotId);
            updateTimeUsed(slotId);
            updateTotalPlannedTime();
            autoSaveTemplate();
        }

        // ç”Ÿæˆæ—¶é•¿é€‰é¡¹
        function generateDurationOptions(selectedValue = 30) {
            let options = '';
            for (let minutes = 10; minutes <= 120; minutes += 10) {
                const selected = minutes === selectedValue ? 'selected' : '';
                options += `<option value="${minutes}" ${selected}>${minutes}åˆ†é’Ÿ</option>`;
            }
            return options;
        }

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // åŠ è½½ä½œæ¯æ—¶é—´è®¾ç½®
            loadScheduleSettings();
            
            // åˆå§‹åŒ–æ¨¡æ¿ç³»ç»Ÿï¼ˆä¸åˆ›å»ºé»˜è®¤æ¨¡æ¿ï¼‰
            initializeDefaultTemplates();
            
            // åŠ è½½æ¨¡æ¿
            loadTemplates();

            // åŠ è½½è‡ªå®šä¹‰æ´»åŠ¨
            loadCustomActivities();

            // ç”Ÿæˆæ´»åŠ¨å¡ç‰‡
            generateActivityCards();

            // ç”Ÿæˆæ—¶é—´æ®µ
            generateTimeSlots();

            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            Object.keys(timeSlotConfig).forEach(slotId => {
                updateTimeUsed(slotId);
            });

            // åˆå§‹åŒ–æ€»è®¡åˆ’æ—¶é—´
            updateTotalPlannedTime();

            // è‡ªåŠ¨åŠ è½½æ¨¡æ¿æˆ–æç¤ºç”¨æˆ·åˆ›å»ºæ–°æ¨¡æ¿
            autoLoadTemplate();
        }

        // ç”Ÿæˆæ´»åŠ¨å¡ç‰‡
        function generateActivityCards() {
            const container = document.getElementById('activities');
            if (!container) return;

            container.innerHTML = '';

            // æ‰€æœ‰æ´»åŠ¨ï¼ˆé¢„è®¾ + è‡ªå®šä¹‰ï¼‰
            const allActivities = [...activities, ...customActivities];

            allActivities.forEach(activity => {
                const card = document.createElement('div');
                card.className = `activity-card ${activity.color} border-2 rounded-lg p-3 cursor-pointer select-none`;
                card.draggable = true;
                card.dataset.activityId = activity.id;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="text-3xl">${activity.emoji}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <span class="text-xl font-bold">${activity.name.replace(activity.emoji + ' ', '')}</span>
                                    <span class="text-xl font-bold text-blue-600">${activity.defaultDuration}åˆ†é’Ÿ</span>
                                </div>
                            </div>
                        </div>
                        ${activity.custom ? `<button onclick="removeCustomActivity('${activity.id}')" class="text-red-500 hover:text-red-700 text-lg ml-2">âœ•</button>` : ''}
                    </div>
                `;

                // Add drag event listeners
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', activity.id);
                    card.classList.add('opacity-50');
                });

                card.addEventListener('dragend', (e) => {
                    card.classList.remove('opacity-50');
                });

                container.appendChild(card);
            });

            // æ·»åŠ DIYå¡ç‰‡
            const diyCard = document.createElement('div');
            diyCard.className = 'diy-activity border-2 rounded-lg p-3 cursor-pointer select-none';
            diyCard.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">âœ¨</div>
                    <div class="flex-1">
                        <input type="text" placeholder="è‡ªå®šä¹‰æ´»åŠ¨åç§°" 
                               class="diy-input w-full text-lg font-bold bg-transparent border-none outline-none"
                               onkeypress="handleDiyInput(event, this)" />
                        <div class="text-sm mt-1 opacity-70">æŒ‰å›è½¦æ·»åŠ </div>
                    </div>
                </div>
            `;

            container.appendChild(diyCard);
        }

        // ç”Ÿæˆæ—¶é—´æ®µ
        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            if (!container) return;

            container.innerHTML = '';

            Object.keys(timeSlotConfig).forEach(slotId => {
                const config = timeSlotConfig[slotId];
                const slotDiv = document.createElement('div');
                slotDiv.className = 'time-slot border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50';
                slotDiv.dataset.timeSlot = slotId;
                slotDiv.setAttribute('data-time-slot', slotId);
                
                // ä¸ºä¸Šåˆæ—¶é—´æ®µæ·»åŠ èµ·åºŠæ—¶é—´è®¾ç½®ï¼Œä¸ºæ™šä¸Šæ—¶é—´æ®µæ·»åŠ ç¡è§‰æ—¶é—´è®¾ç½®
                let timeSettingHTML = '';
                if (slotId === 'morning') {
                    timeSettingHTML = `
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-green-600 font-medium">ğŸŒ… èµ·åºŠ:</span>
                            <input type="time" id="wakeUpTime" value="${scheduleSettings.wakeUpTime}" 
                                   class="px-2 py-1 border border-green-300 rounded text-xs"
                                   onchange="updateSchedule()" />
                        </div>
                    `;
                } else if (slotId === 'evening') {
                    timeSettingHTML = `
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-purple-600 font-medium">ğŸŒ™ ç¡è§‰:</span>
                            <input type="time" id="bedTime" value="${scheduleSettings.bedTime}" 
                                   class="px-2 py-1 border border-purple-300 rounded text-xs"
                                   onchange="updateSchedule()" />
                        </div>
                    `;
                }
                
                slotDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-xl font-bold text-gray-700">${config.name} (${config.start}-${config.end})</h3>
                            ${timeSettingHTML}
                        </div>
                        <div class="text-lg">
                            <span class="font-bold">æ—¶é—´: </span>
                            <span id="timeUsed-${slotId}" class="text-blue-600 font-bold">0</span>
                            <span class="text-gray-500"> / ${config.maxHours * 60} åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    <div class="planned-activities space-y-2" data-slot="${slotId}">
                        <p class="text-gray-500 text-sm">æ‹–æ‹½æ´»åŠ¨åˆ°è¿™é‡Œ</p>
                    </div>
                `;

                // Add drag and drop event listeners
                slotDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    slotDiv.classList.add('drag-over');
                });

                slotDiv.addEventListener('dragleave', (e) => {
                    // Only remove drag-over if we're actually leaving the slot
                    if (!slotDiv.contains(e.relatedTarget)) {
                        slotDiv.classList.remove('drag-over');
                    }
                });

                slotDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    slotDiv.classList.remove('drag-over');

                    const activityId = e.dataTransfer.getData('text/plain');
                    
                    // Check if it's a move operation or a new activity
                    try {
                        const dragData = JSON.parse(activityId);
                        if (dragData.type === 'move') {
                            // This is handled by dropAtPosition function
                            return;
                        }
                    } catch (error) {
                        // This is a new activity from the left panel
                        addActivityToSlot(slotId, activityId);
                    }
                });

                container.appendChild(slotDiv);
            });
        }

        // æ·»åŠ æ´»åŠ¨åˆ°æ—¶é—´æ®µ
        function addActivityToSlot(slotId, activityId) {
            const allActivities = getAllActivities();
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return;

            if (!currentPlan[slotId]) {
                currentPlan[slotId] = [];
            }

            // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ´»åŠ¨å®ä¾‹ID
            const instanceId = `${slotId}_${activityId}_${Date.now()}`;

            // æ£€æŸ¥æ—¶é—´é™åˆ¶
            const currentUsed = calculateTimeUsed(slotId);
            const maxTime = timeSlotConfig[slotId].maxHours * 60;

            if (currentUsed + activity.defaultDuration > maxTime) {
                showWarningMessage(`æ—¶é—´ä¸å¤Ÿäº†ï¼${timeSlotConfig[slotId].name}æœ€å¤šåªèƒ½å®‰æ’${maxTime}åˆ†é’Ÿï¼Œå½“å‰å·²ç”¨${currentUsed}åˆ†é’Ÿã€‚`);
                return;
            }

            currentPlan[slotId].push({
                activityId: activityId,
                instanceId: instanceId,
                duration: activity.defaultDuration
            });

            if (!activityDurations[slotId]) {
                activityDurations[slotId] = {};
            }
            activityDurations[slotId][instanceId] = activity.defaultDuration;

            updateSlotDisplay(slotId);
            updateTimeUsed(slotId);
            updateTotalPlannedTime();
            updateScore();
            autoSaveTemplate();
        }

        // è®¡ç®—æ—¶é—´æ®µå·²ä½¿ç”¨æ—¶é—´
        function calculateTimeUsed(slotId) {
            const activities = currentPlan[slotId] || [];
            return activities.reduce((total, activityItem) => total + activityItem.duration, 0);
        }

        // æ›´æ–°æ—¶é—´ä½¿ç”¨æ˜¾ç¤º
        function updateTimeUsed(slotId) {
            const used = calculateTimeUsed(slotId);
            const maxTime = timeSlotConfig[slotId].maxHours * 60;
            const element = document.getElementById(`timeUsed-${slotId}`);
            const slotElement = document.querySelector(`[data-time-slot="${slotId}"]`);

            if (element) {
                element.textContent = used;

                // æ ¹æ®ä½¿ç”¨æƒ…å†µè®¾ç½®é¢œè‰²
                if (used > maxTime) {
                    element.className = 'text-red-600 font-bold';
                    if (slotElement) slotElement.classList.add('time-exceeded');
                } else if (used > maxTime * 0.8) {
                    element.className = 'text-orange-600 font-semibold';
                    if (slotElement) {
                        slotElement.classList.remove('time-exceeded');
                        slotElement.classList.add('time-warning');
                    }
                } else {
                    element.className = 'text-blue-600';
                    if (slotElement) {
                        slotElement.classList.remove('time-exceeded', 'time-warning');
                    }
                }
            }
        }

        // æ›´æ–°æ´»åŠ¨æ—¶é•¿
        function updateActivityDuration(slotId, instanceId, newDuration) {
            newDuration = parseInt(newDuration);

            // æŸ¥æ‰¾æ´»åŠ¨é¡¹
            const activityItem = currentPlan[slotId]?.find(item => item.instanceId === instanceId);
            if (!activityItem) return;

            // è®¡ç®—å…¶ä»–æ´»åŠ¨çš„æ€»æ—¶é•¿
            const otherActivitiesTime = currentPlan[slotId]
                .filter(item => item.instanceId !== instanceId)
                .reduce((total, item) => total + item.duration, 0);

            const maxTime = timeSlotConfig[slotId].maxHours * 60;

            if (otherActivitiesTime + newDuration > maxTime) {
                showWarningMessage(`æ—¶é—´è¶…é™ï¼${timeSlotConfig[slotId].name}æœ€å¤š${maxTime}åˆ†é’Ÿï¼Œå…¶ä»–æ´»åŠ¨å·²ç”¨${otherActivitiesTime}åˆ†é’Ÿã€‚`);
                // æ¢å¤åŸå€¼
                updateSlotDisplay(slotId);
                return;
            }

            // æ›´æ–°æ—¶é•¿
            activityItem.duration = newDuration;
            if (!activityDurations[slotId]) {
                activityDurations[slotId] = {};
            }
            activityDurations[slotId][instanceId] = newDuration;

            updateTimeUsed(slotId);
            updateTotalPlannedTime();
            autoSaveTemplate();
        }

        // æ›´æ–°æ—¶é—´æ®µæ˜¾ç¤º
        function updateSlotDisplay(slotId) {
            const container = document.querySelector(`[data-slot="${slotId}"]`);
            if (!container) return;

            const activities = currentPlan[slotId] || [];

            if (activities.length === 0) {
                container.innerHTML = '<div class="drop-zone drop-zone-empty" data-slot="' + slotId + '" data-position="empty" style="min-height: 80px; display: flex; align-items: center; justify-content: center;"><p class="text-gray-500 text-sm">æ‹–æ‹½æ´»åŠ¨åˆ°è¿™é‡Œ</p></div>';
                // Add event listeners for the empty drop zone
                const emptyDropZone = container.querySelector('.drop-zone-empty');
                addDropZoneEventListeners(emptyDropZone);
                return;
            }

            let htmlContent = `<div class="drop-zone drop-zone-top" data-slot="${slotId}" data-position="before-first" style="height: 20px; margin: 8px 0;"></div>`;
            
            htmlContent += activities.map((activityItem, index) => {
                const allActivities = getAllActivities();
                const activity = allActivities.find(a => a.id === activityItem.activityId);
                if (!activity) return '';

                const isCompleted = completedTasks[slotId]?.includes(activityItem.instanceId);
                const startTime = calculateActivityStartTime(slotId, index);
                const endTime = calculateActivityEndTime(slotId, index);

                return `
                    <div class="activity-item-wrapper" style="margin: 4px 0;">
                        <div class="flex items-center justify-between bg-white rounded-lg p-3 ${isCompleted ? 'completed-task' : ''}" draggable="true" data-instance-id="${activityItem.instanceId}" data-slot-id="${slotId}">
                            <div class="flex items-center space-x-3 flex-1">
                                <span class="text-2xl">${activity.emoji}</span>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-xl font-bold">${activity.name.replace(activity.emoji + ' ', '')}</span>
                                            <span class="text-sm text-gray-600 font-medium">â° ${startTime} - ${endTime}</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="adjustActivityTime('${slotId}', '${activityItem.instanceId}', -5)"
                                                    class="bg-red-500 hover:bg-red-600 text-white font-bold w-8 h-8 rounded-full text-sm">
                                                âˆ’
                                            </button>
                                            <span class="text-lg font-semibold text-blue-600">${activityItem.duration}åˆ†</span>
                                            <button onclick="adjustActivityTime('${slotId}', '${activityItem.instanceId}', 5)"
                                                    class="bg-green-500 hover:bg-green-600 text-white font-bold w-8 h-8 rounded-full text-sm">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="toggleComplete('${slotId}', '${activityItem.instanceId}')" 
                                        class="text-lg ${isCompleted ? 'text-green-500' : 'text-gray-400'} hover:text-green-600 ml-3">
                                    ${isCompleted ? 'âœ…' : 'â­•'}
                                </button>
                                <button onclick="removeActivity('${slotId}', '${activityItem.instanceId}')" 
                                        class="text-red-500 hover:text-red-700 text-lg ml-2">
                                    âŒ
                                </button>
                            </div>
                        </div>
                        <div class="drop-zone drop-zone-bottom" data-slot="${slotId}" data-position="after-${activityItem.instanceId}" style="height: 20px; margin: 8px 0;"></div>
                    </div>
                `;
            }).filter(item => item !== '').join('');

            container.innerHTML = htmlContent;
            
            // Add event listeners to all drop zones and draggable items
            addDropZoneEventListeners(container.querySelector('.drop-zone-top'));
            
            container.querySelectorAll('.drop-zone-bottom').forEach(dropZone => {
                addDropZoneEventListeners(dropZone);
            });
            
            container.querySelectorAll('[draggable="true"]').forEach(draggableItem => {
                addDraggableEventListeners(draggableItem);
            });
        }
        
        // Add event listeners to drop zones
        function addDropZoneEventListeners(dropZone) {
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
                // Also highlight the parent time slot
                const timeSlot = dropZone.closest('.time-slot');
                if (timeSlot) timeSlot.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                // Only remove drag-over if we're actually leaving the drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                    // Remove time slot highlight if no other drop zones are active
                    const timeSlot = dropZone.closest('.time-slot');
                    if (timeSlot && !timeSlot.querySelector('.drop-zone.drag-over')) {
                        timeSlot.classList.remove('drag-over');
                    }
                }
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                // Remove time slot highlight
                const timeSlot = dropZone.closest('.time-slot');
                if (timeSlot) timeSlot.classList.remove('drag-over');
                dropAtPosition(e);
            });
        }
        
        // Add event listeners to draggable items
        function addDraggableEventListeners(draggableItem) {
            if (!draggableItem) return;
            
            draggableItem.addEventListener('dragstart', (e) => {
                const slotId = e.target.dataset.slotId;
                const instanceId = e.target.dataset.instanceId;
                dragStart(e, slotId, instanceId);
            });
            
            draggableItem.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                // Clean up any remaining drag-over classes
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            });
        }

        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        function toggleComplete(slotId, instanceId) {
            if (!completedTasks[slotId]) {
                completedTasks[slotId] = [];
            }

            const index = completedTasks[slotId].indexOf(instanceId);
            if (index > -1) {
                completedTasks[slotId].splice(index, 1);
            } else {
                completedTasks[slotId].push(instanceId);
            }

            updateSlotDisplay(slotId);
            updateScore();
            autoSaveTemplate();

            // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            if (isAllCompleted()) {
                showRewards();
            }
        }

        // ç§»é™¤æ´»åŠ¨
        function removeActivity(slotId, instanceId) {
            if (currentPlan[slotId]) {
                const index = currentPlan[slotId].findIndex(item => item.instanceId === instanceId);
                if (index > -1) {
                    currentPlan[slotId].splice(index, 1);
                }
            }

            if (completedTasks[slotId]) {
                const index = completedTasks[slotId].indexOf(instanceId);
                if (index > -1) {
                    completedTasks[slotId].splice(index, 1);
                }
            }

            if (activityDurations[slotId]) {
                delete activityDurations[slotId][instanceId];
            }

            updateSlotDisplay(slotId);
            updateTimeUsed(slotId);
            updateTotalPlannedTime();
            updateScore();
            autoSaveTemplate();
        }

        // æ›´æ–°æ€»è®¡åˆ’æ—¶é—´
        function updateTotalPlannedTime() {
            let totalPlanned = 0;

            Object.keys(currentPlan).forEach(slotId => {
                const activities = currentPlan[slotId] || [];
                totalPlanned += activities.reduce((total, item) => total + item.duration, 0);
            });

            const element = document.getElementById('totalPlannedTime');
            if (element) {
                element.textContent = totalPlanned;
            }
        }

        // æ›´æ–°åˆ†æ•°
        function updateScore() {
            let totalTasks = 0;
            let completedCount = 0;

            Object.keys(currentPlan).forEach(slotId => {
                totalTasks += currentPlan[slotId].length;
                if (completedTasks[slotId]) {
                    completedCount += completedTasks[slotId].length;
                }
            });

            document.getElementById('score').textContent = completedCount;
            document.getElementById('total').textContent = totalTasks;
        }

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
        function isAllCompleted() {
            let totalTasks = 0;
            let completedCount = 0;

            Object.keys(currentPlan).forEach(slotId => {
                totalTasks += currentPlan[slotId].length;
                if (completedTasks[slotId]) {
                    completedCount += completedTasks[slotId].length;
                }
            });

            return totalTasks > 0 && completedCount === totalTasks;
        }

        // æ˜¾ç¤ºå¥–åŠ±
        function showRewards() {
            const rewardsDiv = document.getElementById('rewards');
            rewardsDiv.classList.remove('hidden');
            rewardsDiv.classList.add('bounce');

            setTimeout(() => {
                rewardsDiv.classList.remove('bounce');
            }, 3000);
        }

        // åˆå§‹åŒ–æ¨¡æ¿ï¼ˆä¸åˆ›å»ºé»˜è®¤æ¨¡æ¿ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±åˆ›å»ºï¼‰
        function initializeDefaultTemplates() {
            const saved = localStorage.getItem('planTemplates');
            let savedTemplates = saved ? JSON.parse(saved) : {};
            
            templates = savedTemplates;
        }

        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        function loadTemplates() {
            const saved = localStorage.getItem('planTemplates');
            if (saved) {
                templates = JSON.parse(saved);
            }
            updateTemplateSelect();
        }

        // æ›´æ–°æ¨¡æ¿ä¸‹æ‹‰åˆ—è¡¨
        function updateTemplateSelect() {
            const datalist = document.getElementById('templateList');
            datalist.innerHTML = '';
            
            // åªæ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡æ¿é€‰é¡¹
            Object.keys(templates).forEach(templateName => {
                const option = document.createElement('option');
                option.value = templateName;
                datalist.appendChild(option);
            });
        }

        // å¤„ç†æ¨¡æ¿é€‰æ‹©
        function handleTemplateSelect() {
            const templateName = document.getElementById('templateCombobox').value.trim();
            if (!templateName || templateName === currentTemplate) return;
            
            if (currentTemplate && Object.keys(currentPlan).length > 0) {
                autoSaveTemplate();
            }

            currentTemplate = templateName;
            loadTemplateData(templateName);
            showSuccessMessage(`æ¨¡æ¿ "${templateName}" åŠ è½½æˆåŠŸï¼`);
        }

        // å¤„ç†æ¨¡æ¿è¾“å…¥
        function handleTemplateInput() {
            // å®æ—¶æœç´¢åŠŸèƒ½å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        }

        // æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
        function showWarningMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded shadow-lg z-50';
            messageDiv.innerHTML = `<div class="flex items-center"><span class="text-2xl mr-2">âš ï¸</span><span>${message}</span></div>`;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-400 text-green-700 p-4 rounded shadow-lg z-50';
            messageDiv.innerHTML = `<div class="flex items-center"><span class="text-2xl mr-2">âœ…</span><span>${message}</span></div>`;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // ä¿å­˜å½“å‰æ¨¡æ¿
        function saveCurrentTemplate() {
            const templateName = document.getElementById('templateCombobox').value.trim();
            if (!templateName) {
                showWarningMessage('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼');
                return;
            }
            if (templates[templateName] && templateName !== currentTemplate) {
                showOverwriteConfirmation(templateName);
                return;
            }
            saveTemplateData(templateName);
        }

        // åˆ é™¤å½“å‰æ¨¡æ¿
        function deleteCurrentTemplate() {
            const templateName = document.getElementById('templateCombobox').value.trim();
            if (!templateName) {
                showWarningMessage('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ¨¡æ¿ï¼');
                return;
            }
            showDeleteConfirmation(templateName);
        }

        // ä¿å­˜æ¨¡æ¿æ•°æ®
        function saveTemplateData(templateName) {
            currentTemplate = templateName;
            templates[templateName] = {
                plan: JSON.parse(JSON.stringify(currentPlan)),
                durations: JSON.parse(JSON.stringify(activityDurations)),
                completed: JSON.parse(JSON.stringify(completedTasks)),
                scheduleSettings: JSON.parse(JSON.stringify(scheduleSettings)),
                customActivities: JSON.parse(JSON.stringify(customActivities))
            };
            localStorage.setItem('planTemplates', JSON.stringify(templates));
            updateTemplateSelect();
            document.getElementById('templateCombobox').value = templateName;
            showSuccessMessage(`æ¨¡æ¿ "${templateName}" ä¿å­˜æˆåŠŸï¼`);
        }

        // æ˜¾ç¤ºè¦†ç›–ç¡®è®¤å¯¹è¯æ¡†
        function showOverwriteConfirmation(templateName) {
            if (confirm(`æ¨¡æ¿ "${templateName}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                saveTemplateData(templateName);
            }
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function showDeleteConfirmation(templateName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateName}" å—ï¼Ÿ`)) {
                delete templates[templateName];
                localStorage.setItem('planTemplates', JSON.stringify(templates));
                updateTemplateSelect();
                
                if (currentTemplate === templateName) {
                    const remainingTemplates = Object.keys(templates);
                    if (remainingTemplates.length > 0) {
                        currentTemplate = remainingTemplates[0];
                        document.getElementById('templateCombobox').value = currentTemplate;
                        loadTemplateData(currentTemplate);
                    }
                }
                showSuccessMessage(`æ¨¡æ¿ "${templateName}" åˆ é™¤æˆåŠŸï¼`);
            }
        }

        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        function toggleComplete(slotId, instanceId) {
            if (!completedTasks[slotId]) {
                completedTasks[slotId] = [];
            }

            const index = completedTasks[slotId].indexOf(instanceId);
            if (index > -1) {
                completedTasks[slotId].splice(index, 1);
            } else {
                completedTasks[slotId].push(instanceId);
            }

            updateSlotDisplay(slotId);
            updateScore();
            autoSaveTemplate();

            if (isAllCompleted()) {
                showRewards();
            }
        }

        // ç§»é™¤æ´»åŠ¨
        function removeActivity(slotId, instanceId) {
            if (currentPlan[slotId]) {
                const index = currentPlan[slotId].findIndex(item => item.instanceId === instanceId);
                if (index > -1) {
                    currentPlan[slotId].splice(index, 1);
                }
            }

            if (completedTasks[slotId]) {
                const index = completedTasks[slotId].indexOf(instanceId);
                if (index > -1) {
                    completedTasks[slotId].splice(index, 1);
                }
            }

            if (activityDurations[slotId]) {
                delete activityDurations[slotId][instanceId];
            }

            updateSlotDisplay(slotId);
            updateTimeUsed(slotId);
            updateTotalPlannedTime();
            updateScore();
            autoSaveTemplate();
        }

        // è‡ªå®šä¹‰æ´»åŠ¨å¤„ç†
        function handleDiyInput(event, input) {
            if (event.key === 'Enter') {
                const activityName = input.value.trim();
                if (activityName) {
                    addCustomActivity(activityName);
                    input.value = '';
                }
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰æ´»åŠ¨
        function addCustomActivity(name) {
            const id = 'custom_' + Date.now();
            const newActivity = {
                id: id,
                name: 'âœ¨ ' + name,
                emoji: 'âœ¨',
                color: 'bg-gradient-to-r from-purple-100 to-pink-100 border-purple-300',
                defaultDuration: 30,
                custom: true
            };
            
            customActivities.push(newActivity);
            saveCustomActivities();
            generateActivityCards();
            showSuccessMessage(`è‡ªå®šä¹‰æ´»åŠ¨ "${name}" æ·»åŠ æˆåŠŸï¼`);
        }

        // åˆ é™¤è‡ªå®šä¹‰æ´»åŠ¨
        function removeCustomActivity(activityId) {
            customActivities = customActivities.filter(activity => activity.id !== activityId);
            saveCustomActivities();
            generateActivityCards();
            showSuccessMessage('è‡ªå®šä¹‰æ´»åŠ¨åˆ é™¤æˆåŠŸï¼');
        }

        // ä¿å­˜è‡ªå®šä¹‰æ´»åŠ¨åˆ°localStorage
        function saveCustomActivities() {
            localStorage.setItem('customActivities', JSON.stringify(customActivities));
        }

        // åŠ è½½ä½œæ¯æ—¶é—´è®¾ç½®
        function loadScheduleSettings() {
            const saved = localStorage.getItem('scheduleSettings');
            if (saved) {
                scheduleSettings = JSON.parse(saved);
            }
        }

        // æ›´æ–°ä½œæ¯æ—¶é—´
        function updateSchedule() {
            const wakeUpInput = document.getElementById('wakeUpTime');
            const bedTimeInput = document.getElementById('bedTime');
            
            if (wakeUpInput) {
                scheduleSettings.wakeUpTime = wakeUpInput.value;
            }
            if (bedTimeInput) {
                scheduleSettings.bedTime = bedTimeInput.value;
            }
            
            localStorage.setItem('scheduleSettings', JSON.stringify(scheduleSettings));
            autoSaveTemplate();
            showSuccessMessage('ä½œæ¯æ—¶é—´æ›´æ–°æˆåŠŸï¼');
        }

        // è®¡ç®—æ´»åŠ¨å¼€å§‹æ—¶é—´
        function calculateActivityStartTime(slotId, index) {
            const config = timeSlotConfig[slotId];
            const startHour = parseInt(config.start.split(':')[0]);
            const startMinute = parseInt(config.start.split(':')[1]);
            
            let totalMinutes = startHour * 60 + startMinute;
            
            const activities = currentPlan[slotId] || [];
            for (let i = 0; i < index; i++) {
                totalMinutes += activities[i].duration;
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // è®¡ç®—æ´»åŠ¨ç»“æŸæ—¶é—´
        function calculateActivityEndTime(slotId, index) {
            const config = timeSlotConfig[slotId];
            const startHour = parseInt(config.start.split(':')[0]);
            const startMinute = parseInt(config.start.split(':')[1]);
            
            let totalMinutes = startHour * 60 + startMinute;
            
            const activities = currentPlan[slotId] || [];
            for (let i = 0; i <= index; i++) {
                totalMinutes += activities[i].duration;
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°æ¨¡æ¿ä¸‹æ‹‰åˆ—è¡¨
        function updateTemplateSelect() {
            const datalist = document.getElementById('templateList');
            datalist.innerHTML = '';
            
            // åªæ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡æ¿é€‰é¡¹
            Object.keys(templates).forEach(templateName => {
                const option = document.createElement('option');
                option.value = templateName;
                datalist.appendChild(option);
            });
        }

        // å–æ¶ˆè¦†ç›–
        function cancelOverwrite() {
            const confirmDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (confirmDiv) {
                confirmDiv.remove();
            }
        }

        // ç¡®è®¤è¦†ç›–
        function confirmOverwrite(templateName) {
            const confirmDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (confirmDiv) {
                confirmDiv.remove();
            }
            saveTemplateData(templateName);
        }

        // åŠ è½½æ¨¡æ¿
        function loadTemplate() {
            const templateName = document.getElementById('templateCombobox').value;
            if (!templateName) return;

            if (templateName === currentTemplate) return; // å·²ç»æ˜¯å½“å‰æ¨¡æ¿

            // è‡ªåŠ¨ä¿å­˜å½“å‰è¿›åº¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (currentTemplate && Object.keys(currentPlan).length > 0) {
                autoSaveTemplate();
            }

            currentTemplate = templateName;
            loadTemplateData(templateName);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSuccessMessage(`æ¨¡æ¿ "${templateName}" åŠ è½½æˆåŠŸï¼`);
        }

        // åˆ é™¤æ¨¡æ¿
        function deleteTemplate() {
            const templateName = document.getElementById('templateCombobox').value;
            if (!templateName) {
                // æ˜¾ç¤ºæç¤ºä½†ä¸ç”¨alert
                document.getElementById('templateCombobox').style.borderColor = '#ef4444';
                setTimeout(() => {
                    document.getElementById('templateCombobox').style.borderColor = '';
                }, 2000);
                return;
            }

            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            showDeleteConfirmation(templateName);
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function showDeleteConfirmation(templateName) {
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-lg">
                    <div class="text-center">
                        <div class="text-4xl mb-3">ğŸ—‘ï¸</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ç¡®è®¤åˆ é™¤</h3>
                        <p class="text-gray-600 mb-4">ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateName}" å—ï¼Ÿ</p>
                        <div class="flex space-x-3 justify-center">
                            <button onclick="cancelDelete()" 
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                                å–æ¶ˆ
                            </button>
                            <button onclick="confirmDelete('${templateName}')" 
                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
        }

        // å–æ¶ˆåˆ é™¤
        function cancelDelete() {
            const confirmDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (confirmDiv) {
                confirmDiv.remove();
            }
        }

        // ç¡®è®¤åˆ é™¤
        function confirmDelete(templateName) {
            const confirmDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (confirmDiv) {
                confirmDiv.remove();
            }

            delete templates[templateName];
            localStorage.setItem('planTemplates', JSON.stringify(templates));

            // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡æ¿
            const remainingTemplates = Object.keys(templates);
            if (remainingTemplates.length > 0) {
                currentTemplate = remainingTemplates[0];
                updateTemplateSelect();
                document.getElementById('templateCombobox').value = currentTemplate;
                loadTemplateData(currentTemplate);
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSuccessMessage(`æ¨¡æ¿ "${templateName}" åˆ é™¤æˆåŠŸï¼`);
        }

        // è‡ªåŠ¨ä¿å­˜æ¨¡æ¿
        function autoSaveTemplate() {
            if (currentTemplate) {
                templates[currentTemplate] = {
                    plan: JSON.parse(JSON.stringify(currentPlan)),
                    durations: JSON.parse(JSON.stringify(activityDurations)),
                    completed: JSON.parse(JSON.stringify(completedTasks)),
                    customActivities: JSON.parse(JSON.stringify(customActivities)),
                    scheduleSettings: JSON.parse(JSON.stringify(scheduleSettings))
                };

                localStorage.setItem('planTemplates', JSON.stringify(templates));
                // ä¿å­˜å½“å‰ä½¿ç”¨çš„æ¨¡æ¿åç§°
                localStorage.setItem('currentTemplate', currentTemplate);
                // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨ä»¥ç¡®ä¿æ–°æ¨¡æ¿æ˜¾ç¤º
                updateTemplateSelect();
            }
        }

        // è‡ªåŠ¨åŠ è½½æ¨¡æ¿
        function autoLoadTemplate() {
            // é¦–å…ˆå°è¯•åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡æ¿
            const lastUsedTemplate = localStorage.getItem('currentTemplate');
            
            if (lastUsedTemplate && templates[lastUsedTemplate]) {
                currentTemplate = lastUsedTemplate;
                document.getElementById('templateCombobox').value = lastUsedTemplate;
                loadTemplateData(lastUsedTemplate);
            } else if (Object.keys(templates).length > 0) {
                // å¦‚æœæ²¡æœ‰ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡æ¿ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡æ¿
                const firstTemplate = Object.keys(templates)[0];
                currentTemplate = firstTemplate;
                document.getElementById('templateCombobox').value = firstTemplate;
                loadTemplateData(firstTemplate);
            } else {
                // æ²¡æœ‰ä»»ä½•æ¨¡æ¿ï¼Œæç¤ºç”¨æˆ·åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡æ¿
                currentTemplate = null;
                document.getElementById('templateCombobox').value = '';
                showWarningMessage('æ¬¢è¿ä½¿ç”¨è®¡åˆ’åˆ¶å®šå™¨ï¼è¯·å…ˆåˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªè®¡åˆ’æ¨¡æ¿ï¼šåœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ¨¡æ¿åç§°ï¼Œå®‰æ’å¥½æ´»åŠ¨åç‚¹å‡»"ä¿å­˜æ¨¡æ¿"æŒ‰é’®ã€‚');
            }
        }

        // åŠ è½½æ¨¡æ¿æ•°æ®
        function loadTemplateData(templateName) {
            const template = templates[templateName];
            if (!template) return;

            // åŠ è½½æ¨¡æ¿æ•°æ®
            currentPlan = JSON.parse(JSON.stringify(template.plan || {}));
            activityDurations = JSON.parse(JSON.stringify(template.durations || {}));
            completedTasks = JSON.parse(JSON.stringify(template.completed || {}));

            // åŠ è½½ä½œæ¯æ—¶é—´è®¾ç½®
            if (template.scheduleSettings) {
                scheduleSettings = JSON.parse(JSON.stringify(template.scheduleSettings));
                document.getElementById('wakeUpTime').value = scheduleSettings.wakeUpTime;
                document.getElementById('bedTime').value = scheduleSettings.bedTime;
                updateTimeSlotConfig();
            }

            // åŠ è½½è‡ªå®šä¹‰æ´»åŠ¨
            if (template.customActivities) {
                customActivities = JSON.parse(JSON.stringify(template.customActivities));
                saveCustomActivities();
                generateActivityCards();
            }

            // é‡æ–°ç”Ÿæˆæ—¶é—´æ®µ
            generateTimeSlots();

            // æ›´æ–°æ˜¾ç¤º
            Object.keys(timeSlotConfig).forEach(slotId => {
                updateSlotDisplay(slotId);
                updateTimeUsed(slotId);
            });

            updateScore();
            updateTotalPlannedTime();
            document.getElementById('rewards').classList.add('hidden');
        }

        // æ¯æ—¥æ‰“å¡åŠŸèƒ½ï¼ˆå½“å‰ç‰ˆæœ¬æš‚æœªå®ç°å¯¹åº”çš„HTMLå…ƒç´ ï¼‰
        function dailyCheckIn() {
            const date = new Date().toISOString().split('T')[0];

            // åŠ è½½æ‰“å¡è®°å½•
            let checkInRecord = {};
            const saved = localStorage.getItem('dailyCheckIn');
            if (saved) {
                checkInRecord = JSON.parse(saved);
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¡
            if (checkInRecord[date]) {
                showSuccessMessage(`${date} å·²ç»æ‰“å¡è¿‡äº†ï¼æ‰“å¡æ—¶é—´: ${checkInRecord[date].time}ï¼Œå¿ƒæƒ…: ${checkInRecord[date].mood}`);
                return;
            }

            // æ˜¾ç¤ºæ‰“å¡å¯¹è¯æ¡†
            showCheckInDialog(date, checkInRecord);
        }

        // æ˜¾ç¤ºæ‰“å¡å¯¹è¯æ¡†
        function showCheckInDialog(date, checkInRecord) {
            const dialogDiv = document.createElement('div');
            dialogDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialogDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-lg">
                    <div class="text-center">
                        <div class="text-4xl mb-3">ğŸŒŸ</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ä»Šæ—¥æ‰“å¡</h3>
                        <p class="text-gray-600 mb-4">ä»Šå¤©çš„å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ</p>
                        <input type="text" id="moodInput" placeholder="è¾“å…¥è¡¨æƒ…ç¬¦å·æˆ–æè¿°" value="ğŸ˜Š"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 text-center">
                        <div class="flex space-x-3 justify-center">
                            <button onclick="cancelCheckIn()" 
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                                å–æ¶ˆ
                            </button>
                            <button onclick="confirmCheckIn('${date}')" 
                                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">
                                æ‰“å¡
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialogDiv);
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const input = document.getElementById('moodInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        // å–æ¶ˆæ‰“å¡
        function cancelCheckIn() {
            const dialogDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (dialogDiv) {
                dialogDiv.remove();
            }
        }

        // ç¡®è®¤æ‰“å¡
        function confirmCheckIn(date) {
            const mood = document.getElementById('moodInput')?.value || 'ğŸ˜Š';
            
            // åŠ è½½æ‰“å¡è®°å½•
            let checkInRecord = {};
            const saved = localStorage.getItem('dailyCheckIn');
            if (saved) {
                checkInRecord = JSON.parse(saved);
            }
            
            const checkInTime = new Date().toLocaleString();
            checkInRecord[date] = {
                time: checkInTime,
                mood: mood,
                plannedTasks: Object.keys(currentPlan).reduce((total, slotId) =>
                    total + (currentPlan[slotId] || []).length, 0),
                completedTasks: Object.keys(completedTasks).reduce((total, slotId) =>
                    total + (completedTasks[slotId] || []).length, 0)
            };

            localStorage.setItem('dailyCheckIn', JSON.stringify(checkInRecord));

            // å…³é—­å¯¹è¯æ¡†
            cancelCheckIn();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(`ğŸ‰ æ‰“å¡æˆåŠŸï¼å¿ƒæƒ…: ${mood}ï¼Œè®¡åˆ’ä»»åŠ¡: ${checkInRecord[date].plannedTasks}ï¼Œå®Œæˆä»»åŠ¡: ${checkInRecord[date].completedTasks}`);
        }

        // æ›´æ–°æ‰“å¡æŒ‰é’®çŠ¶æ€ï¼ˆå½“å‰ç‰ˆæœ¬æš‚æœªå®ç°å¯¹åº”çš„HTMLå…ƒç´ ï¼‰
        function updateCheckInButton() {
            // åŠŸèƒ½æš‚æ—¶ä¿ç•™ï¼Œç­‰å¾…UIå®ç°
            return;
        }

        // æ˜¾ç¤ºæ‰“å¡å†å²ï¼ˆå½“å‰ç‰ˆæœ¬æš‚æœªå®ç°å¯¹åº”çš„HTMLå…ƒç´ ï¼‰
        function showCheckInHistory() {
            const saved = localStorage.getItem('dailyCheckIn');
            const history = saved ? JSON.parse(saved) : {};

            if (Object.keys(history).length === 0) {
                showWarningMessage('è¿˜æ²¡æœ‰æ‰“å¡è®°å½•å‘¢ï¼');
                return;
            }

            // æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†
            const sortedDates = Object.keys(history).sort().reverse();
            let historyHTML = '<div class="max-h-80 overflow-y-auto">';

            sortedDates.slice(0, 10).forEach(date => { // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
                const record = history[date];
                const completionRate = record.plannedTasks > 0 ?
                    Math.round((record.completedTasks / record.plannedTasks) * 100) : 0;

                historyHTML += `
                    <div class="border-b border-gray-200 py-3">
                        <div class="font-semibold text-gray-800">${date}</div>
                        <div class="text-sm text-gray-600">
                            å¿ƒæƒ…: ${record.mood} | å®Œæˆç‡: ${completionRate}%<br>
                            ä»»åŠ¡: ${record.completedTasks}/${record.plannedTasks}
                        </div>
                    </div>
                `;
            });

            historyHTML += '</div>';

            const dialogDiv = document.createElement('div');
            dialogDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialogDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-lg">
                    <div class="text-center mb-4">
                        <div class="text-3xl mb-2">ğŸ“‹</div>
                        <h3 class="text-lg font-bold text-gray-800">æ‰“å¡å†å²è®°å½•</h3>
                    </div>
                    ${historyHTML}
                    <div class="mt-4 text-center">
                        <button onclick="closeCheckInModal()" 
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialogDiv);
        }

        // å…³é—­æ‰“å¡å†å²å¼¹çª—ï¼ˆå½“å‰ç‰ˆæœ¬æš‚æœªå®ç°å¯¹åº”çš„HTMLå…ƒç´ ï¼‰
        function closeCheckInModal() {
            const dialogDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (dialogDiv) {
                dialogDiv.remove();
            }
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        // document.getElementById('checkInModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeCheckInModal();
        //     }
        // });

        // æ—¥æœŸå˜åŒ–æ—¶åŠ è½½å¯¹åº”è®¡åˆ’
        // document.getElementById('planDate').addEventListener('change', () => {
        //     loadPlan();
        //     updateCheckInButton();
        // });

        // å¤„ç†DIYè¾“å…¥
        function handleDiyInput(event, input) {
            if (event.key === 'Enter') {
                const activityName = input.value.trim();
                if (activityName) {
                    addCustomActivity(activityName);
                    input.value = '';
                }
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰æ´»åŠ¨
        function addCustomActivity(name) {
            const id = 'custom_' + Date.now();
            const newActivity = {
                id: id,
                name: 'âœ¨ ' + name,
                emoji: 'âœ¨',
                color: 'bg-purple-100 border-purple-300',
                defaultDuration: 30,
                custom: true
            };

            customActivities.push(newActivity);
            saveCustomActivities();
            generateActivityCards();
        }

        // ç§»é™¤è‡ªå®šä¹‰æ´»åŠ¨
        function removeCustomActivity(activityId) {
            customActivities = customActivities.filter(activity => activity.id !== activityId);
            saveCustomActivities();
            generateActivityCards();
        }

        // ä¿å­˜è‡ªå®šä¹‰æ´»åŠ¨åˆ°localStorage
        function saveCustomActivities() {
            localStorage.setItem('customActivities', JSON.stringify(customActivities));
        }

        // ä»localStorageåŠ è½½è‡ªå®šä¹‰æ´»åŠ¨
        function loadCustomActivities() {
            const saved = localStorage.getItem('customActivities');
            if (saved) {
                customActivities = JSON.parse(saved);
            }
        }

        // è·å–æ‰€æœ‰æ´»åŠ¨ï¼ˆé¢„è®¾ + è‡ªå®šä¹‰ï¼‰
        function getAllActivities() {
            return [...activities, ...customActivities];
        }

        // è®©activitieså˜é‡å…¨å±€å¯è®¿é—®
        window.activities = activities;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        initializePage();

        // æ‹–æ‹½å¼€å§‹
        function dragStart(e, slotId, instanceId) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                slotId: slotId,
                instanceId: instanceId,
                type: 'move'
            }));
            e.target.classList.add('dragging');
        }

        // æ‹–æ‹½æ”¾ç½®åˆ°æŒ‡å®šä½ç½®
        function dropAtPosition(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const data = e.dataTransfer.getData('text/plain');
            let dragData;
            
            try {
                dragData = JSON.parse(data);
            } catch {
                // If it's not a move operation, it might be a new activity from the left panel
                const activityId = data;
                const targetSlotId = e.target.dataset.slot;
                if (targetSlotId && activityId) {
                    addActivityToSlot(targetSlotId, activityId);
                }
                return;
            }
            
            if (dragData.type !== 'move') return;
            
            const { slotId: sourceSlotId, instanceId: sourceInstanceId } = dragData;
            const targetSlotId = e.target.dataset.slot;
            const position = e.target.dataset.position;
            
            // ç§»é™¤æ‹–æ‹½æ ·å¼
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            if (!position || !targetSlotId) return;
            
            // æ‰¾åˆ°æºæ´»åŠ¨
            const sourceActivity = currentPlan[sourceSlotId]?.find(item => item.instanceId === sourceInstanceId);
            if (!sourceActivity) return;
            
            // å¦‚æœæ‹–æ‹½åˆ°ä¸åŒæ—¶é—´æ®µ
            if (sourceSlotId !== targetSlotId) {
                // æ£€æŸ¥ç›®æ ‡æ—¶é—´æ®µæ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´
                const targetUsed = calculateTimeUsed(targetSlotId);
                const maxTime = timeSlotConfig[targetSlotId].maxHours * 60;
                
                if (targetUsed + sourceActivity.duration > maxTime) {
                    showWarningMessage(`æ—¶é—´ä¸å¤Ÿäº†ï¼${timeSlotConfig[targetSlotId].name}æœ€å¤šåªèƒ½å®‰æ’${maxTime}åˆ†é’Ÿï¼Œå½“å‰å·²ç”¨${targetUsed}åˆ†é’Ÿã€‚`);
                    return;
                }
                
                // ä»æºæ—¶é—´æ®µç§»é™¤
                const sourceIndex = currentPlan[sourceSlotId].findIndex(item => item.instanceId === sourceInstanceId);
                if (sourceIndex >= 0) {
                    currentPlan[sourceSlotId].splice(sourceIndex, 1);
                }
                
                // æ¸…ç†æºæ—¶é—´æ®µçš„æ—¶é•¿è®°å½•
                if (activityDurations[sourceSlotId]) {
                    delete activityDurations[sourceSlotId][sourceInstanceId];
                }
                
                // æ·»åŠ åˆ°ç›®æ ‡æ—¶é—´æ®µ
                if (!currentPlan[targetSlotId]) {
                    currentPlan[targetSlotId] = [];
                }
                
                // ç¡®å®šæ’å…¥ä½ç½®
                let insertIndex = 0;
                if (position === 'empty') {
                    insertIndex = 0;
                } else if (position === 'before-first') {
                    insertIndex = 0;
                } else if (position.startsWith('before-')) {
                    const targetInstanceId = position.replace('before-', '');
                    insertIndex = currentPlan[targetSlotId].findIndex(item => item.instanceId === targetInstanceId);
                    if (insertIndex === -1) insertIndex = 0;
                } else if (position.startsWith('after-')) {
                    const targetInstanceId = position.replace('after-', '');
                    insertIndex = currentPlan[targetSlotId].findIndex(item => item.instanceId === targetInstanceId);
                    if (insertIndex === -1) {
                        insertIndex = currentPlan[targetSlotId].length;
                    } else {
                        insertIndex += 1;
                    }
                }
                
                currentPlan[targetSlotId].splice(insertIndex, 0, sourceActivity);
                
                // æ›´æ–°æ´»åŠ¨æ—¶é•¿è®°å½•
                if (!activityDurations[targetSlotId]) {
                    activityDurations[targetSlotId] = {};
                }
                activityDurations[targetSlotId][sourceInstanceId] = sourceActivity.duration;
                
                // æ›´æ–°æ˜¾ç¤º
                updateSlotDisplay(sourceSlotId);
                updateSlotDisplay(targetSlotId);
                updateTimeUsed(sourceSlotId);
                updateTimeUsed(targetSlotId);
            } else {
                // åŒä¸€æ—¶é—´æ®µå†…é‡æ–°æ’åº
                const activities = currentPlan[sourceSlotId];
                const sourceIndex = activities.findIndex(item => item.instanceId === sourceInstanceId);
                
                if (sourceIndex >= 0) {
                    // ç§»é™¤æºå…ƒç´ 
                    const [movedActivity] = activities.splice(sourceIndex, 1);
                    
                    // ç¡®å®šæ–°çš„æ’å…¥ä½ç½®
                    let insertIndex = 0;
                    if (position === 'empty') {
                        insertIndex = 0;
                    } else if (position === 'before-first') {
                        insertIndex = 0;
                    } else if (position.startsWith('before-')) {
                        const targetInstanceId = position.replace('before-', '');
                        insertIndex = activities.findIndex(item => item.instanceId === targetInstanceId);
                        if (insertIndex === -1) insertIndex = 0;
                    } else if (position.startsWith('after-')) {
                        const targetInstanceId = position.replace('after-', '');
                        insertIndex = activities.findIndex(item => item.instanceId === targetInstanceId);
                        if (insertIndex === -1) {
                            insertIndex = activities.length;
                        } else {
                            insertIndex += 1;
                        }
                    }
                    
                    // æ’å…¥åˆ°æ–°ä½ç½®
                    activities.splice(insertIndex, 0, movedActivity);
                    
                    updateSlotDisplay(sourceSlotId);
                }
            }
            
            updateTotalPlannedTime();
            autoSaveTemplate();
        }

        // æ‹–æ‹½æ”¾ç½®
        function dropActivity(e, targetSlotId, targetInstanceId) {
            e.preventDefault();
            e.stopPropagation();
            
            const data = e.dataTransfer.getData('text/plain');
            let dragData;
            
            try {
                dragData = JSON.parse(data);
            } catch {
                // å¦‚æœä¸æ˜¯ç§»åŠ¨æ“ä½œï¼Œå¯èƒ½æ˜¯ä»å·¦ä¾§æ‹–æ‹½çš„æ´»åŠ¨
                return;
            }
            
            if (dragData.type !== 'move') return;
            
            const { slotId: sourceSlotId, instanceId: sourceInstanceId } = dragData;
            
            // ç§»é™¤æ‹–æ‹½æ ·å¼
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
            
            // å¦‚æœæ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸æ‰§è¡Œæ“ä½œ
            if (sourceSlotId === targetSlotId && sourceInstanceId === targetInstanceId) {
                return;
            }
            
            // æ‰¾åˆ°æºæ´»åŠ¨
            const sourceActivity = currentPlan[sourceSlotId]?.find(item => item.instanceId === sourceInstanceId);
            if (!sourceActivity) return;
            
            // å¦‚æœæ‹–æ‹½åˆ°ä¸åŒæ—¶é—´æ®µ
            if (sourceSlotId !== targetSlotId) {
                // æ£€æŸ¥ç›®æ ‡æ—¶é—´æ®µæ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´
                const targetUsed = calculateTimeUsed(targetSlotId);
                const maxTime = timeSlotConfig[targetSlotId].maxHours * 60;
                
                if (targetUsed + sourceActivity.duration > maxTime) {
                    showWarningMessage(`æ—¶é—´ä¸å¤Ÿäº†ï¼${timeSlotConfig[targetSlotId].name}æœ€å¤šåªèƒ½å®‰æ’${maxTime}åˆ†é’Ÿï¼Œå½“å‰å·²ç”¨${targetUsed}åˆ†é’Ÿã€‚`);
                    return;
                }
                
                // ä»æºæ—¶é—´æ®µç§»é™¤
                removeActivity(sourceSlotId, sourceInstanceId);
                
                // æ·»åŠ åˆ°ç›®æ ‡æ—¶é—´æ®µ
                if (!currentPlan[targetSlotId]) {
                    currentPlan[targetSlotId] = [];
                }
                
                // æ‰¾åˆ°ç›®æ ‡ä½ç½®
                const targetIndex = currentPlan[targetSlotId].findIndex(item => item.instanceId === targetInstanceId);
                if (targetIndex >= 0) {
                    currentPlan[targetSlotId].splice(targetIndex, 0, sourceActivity);
                } else {
                    currentPlan[targetSlotId].push(sourceActivity);
                }
                
                // æ›´æ–°æ´»åŠ¨æ—¶é•¿è®°å½•
                if (!activityDurations[targetSlotId]) {
                    activityDurations[targetSlotId] = {};
                }
                activityDurations[targetSlotId][sourceInstanceId] = sourceActivity.duration;
                
                // æ¸…ç†æºæ—¶é—´æ®µçš„æ—¶é•¿è®°å½•
                if (activityDurations[sourceSlotId]) {
                    delete activityDurations[sourceSlotId][sourceInstanceId];
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateSlotDisplay(sourceSlotId);
                updateSlotDisplay(targetSlotId);
                updateTimeUsed(sourceSlotId);
                updateTimeUsed(targetSlotId);
            } else {
                // åŒä¸€æ—¶é—´æ®µå†…é‡æ–°æ’åº
                const activities = currentPlan[sourceSlotId];
                const sourceIndex = activities.findIndex(item => item.instanceId === sourceInstanceId);
                const targetIndex = activities.findIndex(item => item.instanceId === targetInstanceId);
                
                if (sourceIndex >= 0 && targetIndex >= 0 && sourceIndex !== targetIndex) {
                    // ç§»é™¤æºå…ƒç´ 
                    const [movedActivity] = activities.splice(sourceIndex, 1);
                    // æ’å…¥åˆ°ç›®æ ‡ä½ç½®
                    const newTargetIndex = sourceIndex < targetIndex ? targetIndex - 1 : targetIndex;
                    activities.splice(newTargetIndex, 0, movedActivity);
                    
                    updateSlotDisplay(sourceSlotId);
                }
            }
            
            updateTotalPlannedTime();
            autoSaveTemplate();
        }

        // ä½œæ¯æ—¶é—´ç›¸å…³å‡½æ•°
        
        // æ›´æ–°ä½œæ¯æ—¶é—´è®¾ç½®
        function updateSchedule() {
            const wakeUpTime = document.getElementById('wakeUpTime')?.value || scheduleSettings.wakeUpTime;
            const bedTime = document.getElementById('bedTime')?.value || scheduleSettings.bedTime;
            
            scheduleSettings.wakeUpTime = wakeUpTime;
            scheduleSettings.bedTime = bedTime;
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('scheduleSettings', JSON.stringify(scheduleSettings));
            
            // æ›´æ–°æ—¶é—´æ®µé…ç½®
            updateTimeSlotConfig();
            
            // é‡æ–°ç”Ÿæˆæ—¶é—´æ®µæ˜¾ç¤º
            generateTimeSlots();
            
            // æ›´æ–°æ‰€æœ‰æ—¶é—´æ®µçš„æ˜¾ç¤ºï¼ˆè¿™ä¼šé‡æ–°è®¡ç®—å¼€å§‹æ—¶é—´ï¼‰
            Object.keys(timeSlotConfig).forEach(slotId => {
                updateSlotDisplay(slotId);
                updateTimeUsed(slotId);
            });
            
            // è‡ªåŠ¨ä¿å­˜å½“å‰æ¨¡æ¿
            autoSaveTemplate();
            
            showScheduleUpdateMessage();
        }
        
        // æ˜¾ç¤ºä½œæ¯æ—¶é—´æ›´æ–°æç¤º
        function showScheduleUpdateMessage() {
            const wakeUpTime = scheduleSettings.wakeUpTime;
            const bedTime = scheduleSettings.bedTime;
            
            // è®¡ç®—ç¡çœ æ—¶é•¿
            const wakeUpMinutes = parseInt(wakeUpTime.split(':')[0]) * 60 + parseInt(wakeUpTime.split(':')[1]);
            const bedMinutes = parseInt(bedTime.split(':')[0]) * 60 + parseInt(bedTime.split(':')[1]);
            let sleepDuration;
            
            if (bedMinutes > wakeUpMinutes) {
                // åŒä¸€å¤©ç¡è§‰ï¼ˆæ¯”å¦‚æ—©ä¸Š7ç‚¹èµ·åºŠï¼Œæ™šä¸Š10ç‚¹ç¡è§‰ï¼‰
                sleepDuration = (24 * 60 - bedMinutes) + wakeUpMinutes;
            } else {
                // è·¨å¤©ç¡è§‰ï¼ˆæ¯”å¦‚æ™šä¸Š11ç‚¹ç¡è§‰ï¼Œç¬¬äºŒå¤©æ—©ä¸Š7ç‚¹èµ·åºŠï¼‰
                sleepDuration = wakeUpMinutes - bedMinutes;
            }
            
            const sleepHours = Math.floor(sleepDuration / 60);
            const sleepMinutesLeft = sleepDuration % 60;
            
            // åˆ›å»ºä¸´æ—¶æç¤ºå…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-green-100 border-2 border-green-400 rounded-lg p-4 shadow-lg z-50 schedule-message';
            messageDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">â°</span>
                    <div>
                        <div class="font-bold text-green-700">ä½œæ¯æ—¶é—´å·²æ›´æ–°ï¼</div>
                        <div class="text-sm text-green-600">
                            èµ·åºŠ: ${wakeUpTime} | ç¡è§‰: ${bedTime}<br>
                            ç¡çœ æ—¶é•¿: ${sleepHours}å°æ—¶${sleepMinutesLeft}åˆ†é’Ÿ
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // æ ¹æ®ä½œæ¯æ—¶é—´æ›´æ–°æ—¶é—´æ®µé…ç½®
        function updateTimeSlotConfig() {
            const wakeUpTime = scheduleSettings.wakeUpTime;
            const bedTime = scheduleSettings.bedTime;
            
            // è§£ææ—¶é—´
            const wakeUpHour = parseInt(wakeUpTime.split(':')[0]);
            const wakeUpMinute = parseInt(wakeUpTime.split(':')[1]);
            const bedHour = parseInt(bedTime.split(':')[0]);
            const bedMinute = parseInt(bedTime.split(':')[1]);
            
            // è®¡ç®—å„æ—¶é—´æ®µ
            const morningStart = wakeUpTime;
            const morningEndHour = Math.min(wakeUpHour + 4, 12); // æœ€å¤šåˆ°ä¸­åˆ12ç‚¹
            const morningEnd = `${morningEndHour.toString().padStart(2, '0')}:00`;
            
            const afternoonStart = morningEndHour < 12 ? morningEnd : '12:00';
            const afternoonEndHour = Math.min(parseInt(afternoonStart.split(':')[0]) + 5, 18); // æœ€å¤šåˆ°æ™šä¸Š6ç‚¹
            const afternoonEnd = `${afternoonEndHour.toString().padStart(2, '0')}:00`;
            
            const eveningStart = afternoonEndHour < 18 ? afternoonEnd : '18:00';
            const eveningEnd = bedTime;
            
            // æ›´æ–°é…ç½®
            timeSlotConfig.morning.start = morningStart;
            timeSlotConfig.morning.end = morningEnd;
            timeSlotConfig.afternoon.start = afternoonStart;
            timeSlotConfig.afternoon.end = afternoonEnd;
            timeSlotConfig.evening.start = eveningStart;
            timeSlotConfig.evening.end = eveningEnd;
            
            // é‡æ–°ç”Ÿæˆæ—¶é—´æ®µ
            generateTimeSlots();
        }

        // è‡ªåŠ¨ä¿å­˜æ¨¡æ¿
        function autoSaveTemplate() {
            if (currentTemplate) {
                templates[currentTemplate] = {
                    plan: JSON.parse(JSON.stringify(currentPlan)),
                    durations: JSON.parse(JSON.stringify(activityDurations)),
                    completed: JSON.parse(JSON.stringify(completedTasks)),
                    scheduleSettings: JSON.parse(JSON.stringify(scheduleSettings)),
                    customActivities: JSON.parse(JSON.stringify(customActivities))
                };
                localStorage.setItem('planTemplates', JSON.stringify(templates));
            }
        }

        // é€šç”¨æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                           type === 'warning' ? 'bg-yellow-100 border-yellow-400 text-yellow-700' :
                           'bg-blue-100 border-blue-400 text-blue-700';
            
            messageDiv.className = `fixed top-4 right-4 ${bgColor} border-l-4 p-4 rounded shadow-lg z-50 schedule-message`;
            messageDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-lg">${type === 'success' ? 'âœ…' : 'âš ï¸'}</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-lg hover:opacity-70">Ã—</button>
                </div>
            `;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }
    </script>
</body>

</html>