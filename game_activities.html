<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>活动中心</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            position: relative;
            min-height: 100vh;
            min-height: 100dvh; /* 动态视口高度 */
        }
        
        .star-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* 自定义滚动条样式 */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-glow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.1);
        }
        
        .active-tab {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .reward-card {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            transition: transform 0.3s ease;
        }
        
        .reward-card:hover {
            transform: translateY(-2px);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* 响应式设计 - 基础分辨率 1282x720 */
        .signin-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .signin-header {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex: 0 0 60%;
        }
        
        .signin-cards-container {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e0f2fe 0%,rgb(151, 180, 231) 50%,rgb(151, 180, 254) 100%);
            padding: 1rem;
        }
        
        .cumulative-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .cumulative-header {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex: 0 0 65%;
        }
        
        .cumulative-cards-container {
            flex: 0 0 35%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e0f2fe 0%,rgb(151, 180, 231) 50%,rgb(151, 180, 254) 100%);
            padding: 1rem;
        }
        
        .day-card {
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .day-card:hover {
            transform: scale(1.05);
        }
        
        /* 全屏适配 */
        .app-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            overflow: hidden;
            max-width: none;
            margin: 0;
        }
        
        .sidebar {
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .content-area {
            flex: 1;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 移动端汉堡菜单 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        /* 触控优化 */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-card {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Loading Animation */
        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .loading-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 1.5rem;
            font-size: 1.125rem;
            font-weight: 500;
            animation: pulse-text 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .error-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            z-index: 10;
            padding: 2rem;
        }
        
        .error-container.show {
            display: flex;
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .error-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .error-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .retry-btn {
            background: white;
            color: #f5576c;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .retry-btn:active {
            transform: translateY(0);
        }
        
        /* Red dot indicator for unvisited updates */
        .update-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
            z-index: 20;
        }
        
        .tab-btn {
            position: relative;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .iframe-container iframe.loaded {
            opacity: 1;
        }
        
    </style>
</head>
<body class="star-bg min-h-screen">
    <div class="app-container">
        <div class="flex w-full bg-white shadow-2xl h-full">
        <!-- 左侧导航 -->
        <div class="sidebar w-48 gradient-bg p-4 flex flex-col">
            <div class="text-white text-xl font-bold mb-6 text-center">
                活动中心
            </div>
            
            <nav class="space-y-3 flex-1">
                <button id="tab_signin" onclick="switchTab('signin')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    7日签到
                </button>
                <button id="tab_vip" onclick="switchTab('vip')" class="tab-btn active-tab w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 flex items-center shadow-lg" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);">
                    <span class="mr-2">👑</span>
                    麦思星球会员
                </button>
                <button id="tab_candybox" onclick="switchTab('candybox')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center relative overflow-visible">
                    <span class="mr-2">🍬</span>
                    糖果盒
                    <span class="absolute -top-2 -left-2 bg-orange-500 text-white text-xs px-2 py-0.5 rounded transform -rotate-12 shadow-lg font-bold whitespace-nowrap" style="z-index: 10;">🎃 万圣节</span>
                </button>
                <button id="tab_contest" onclick="switchTab('contest')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    <span class="mr-2">🏆</span>
                    创作大赛
                    <span class="absolute -top-2 -left-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded transform -rotate-12 shadow-lg font-bold whitespace-nowrap animate-pulse" style="z-index: 10;">🔥 火热报名中</span>
                </button>
                <button id="tab_mai_si_test" onclick="switchTab('mai_si_test')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    麦思测评
                </button>
                <button id="tab_paracraft_tips" onclick="switchTab('paracraft_tips')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    创作者学堂
                </button>
                <!-- <button id="tab_referral" onclick="switchTab('referral')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    <span class="mr-2">🎁</span>
                    拉新奖励
                </button>
                
                <button id="tab_contest" onclick="switchTab('contest')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    <span class="mr-2">🏆</span>
                    家园大赛
                </button>
                
                <button id="tab_feedback" onclick="switchTab('feedback')" class="tab-btn w-full text-white py-3 px-4 rounded-lg font-medium text-left transition-all duration-300 hover:bg-white hover:bg-opacity-20 flex items-center">
                    <span class="mr-2">✍️</span>
                    活动投稿
                </button> -->
  
            </nav>
        </div>

        <!-- 右侧内容区域 -->
        <div class="content-area flex-1" id="contentArea">
            <!-- iframe容器将动态创建 -->
        </div>
    </div>
    <script>
        // Get all visit data from localStorage
        function getVisitData() {
            const data = localStorage.getItem('game_activities_visits');
            return data ? JSON.parse(data) : {};
        }
        
        // Save visit data to localStorage
        function saveVisitData(data) {
            localStorage.setItem('game_activities_visits', JSON.stringify(data));
        }
        
        // Check if page needs update indicator
        function needsUpdateIndicator(tabId) {
            const config = iframeConfig[tabId];
            if (!config || !config.updateDate) {
                return false;
            }
            
            const visitData = getVisitData();
            const lastVisit = visitData[tabId];
            
            if (!lastVisit) {
                return true; // Never visited
            }
            
            // Compare dates
            const updateTime = new Date(config.updateDate).getTime();
            const visitTime = new Date(lastVisit).getTime();
            
            return updateTime > visitTime;
        }
        
        // Update last visit date
        function updateLastVisit(tabId) {
            const now = new Date().toISOString();
            const visitData = getVisitData();
            visitData[tabId] = now;
            saveVisitData(visitData);
            console.log(`Updated lastVisit for ${tabId}: ${now}`);
            
            // Remove indicator
            const button = document.getElementById(`tab_${tabId}`);
            if (button) {
                const indicator = button.querySelector('.update-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        // Add indicator to button
        function addUpdateIndicator(tabId) {
            const button = document.getElementById(`tab_${tabId}`);
            if (!button) return;
            
            // Check if indicator already exists
            if (button.querySelector('.update-indicator')) return;
            
            const indicator = document.createElement('span');
            indicator.className = 'update-indicator';
            button.appendChild(indicator);
        }
        
        // Initialize all indicators
        function initializeIndicators() {
            Object.keys(iframeConfig).forEach(tabId => {
                if (needsUpdateIndicator(tabId)) {
                    addUpdateIndicator(tabId);
                }
            });
        }
        
        // iframe配置
        const iframeConfig = {
            signin: {
                id: 'game_activity_checkin',
                url: 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_checkin',
                title: '7日签到',
                updateDate: '2025-10-24'
            },
            vip: {
                id: 'game_activity_vip', 
                url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/msplanet_vip',
                // url: 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_vip2',
                title: '会员奖励',
                updateDate: '2025-10-24'
            },
            mai_si_test:{
                id: 'game_activity_mai_si_test',
                url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_test',
                title: '麦思测评',
                updateDate: '2025-10-24'
            },
            paracraft_tips:{
                id: 'game_activity_paracraft_tips',
                url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/paracraft_tips',
                title: '创作学堂',
                updateDate: '2025-10-24'
            },
            candybox: {
                id: 'game_activity_candybox',
                url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_candybox',
                title: '糖果盒',
                updateDate: '2025-10-24'
            },
            contest: {
                id: 'game_activity_contest',
                url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_contest',
                title: '创作大赛',
                updateDate: '2025-10-24'
            },
            referral: {
                id: 'game_activity_referral',
                url: 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_referral', 
                title: '拉新奖励',
            },
            feedback: {
                id: 'game_activity_feedback',
                url: 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/game_activity_feedback',
                title: '活动投稿'
            }
        };

        // 创建单个iframe容器
        function createIframeContainer(tabId) {
            const config = iframeConfig[tabId];
            if (!config) return null;
            
            const contentArea = document.getElementById('contentArea');
            
            // 创建tab内容容器
            const tabContent = document.createElement('div');
            tabContent.id = config.id;
            tabContent.className = 'tab-content';
            tabContent.style.display = 'none';
            
            // 创建iframe容器
            const iframeContainer = document.createElement('div');
            iframeContainer.className = 'iframe-container';
            
            // 创建loading容器
            const loadingContainer = document.createElement('div');
            loadingContainer.className = 'loading-container';
            loadingContainer.id = `loading_${tabId}`;
            loadingContainer.innerHTML = `
                <div class="spinner"></div>
                <div class="loading-text">加载中...</div>
            `;
            
            // 创建error容器
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-container';
            errorContainer.id = `error_${tabId}`;
            errorContainer.innerHTML = `
                <div class="error-icon">⚠️</div>
                <div class="error-text">加载失败</div>
                <div class="error-message">无法加载内容，请检查网络连接后重试</div>
                <button class="retry-btn" onclick="retryLoad('${tabId}')">🔄 重试</button>
            `;
            
            // 创建iframe
            const iframe = document.createElement('iframe');
            iframe.id = `${tabId}_iframe`;
            iframe.src = '';
            
            // 组装结构
            iframeContainer.appendChild(loadingContainer);
            iframeContainer.appendChild(errorContainer);
            iframeContainer.appendChild(iframe);
            tabContent.appendChild(iframeContainer);
            contentArea.appendChild(tabContent);
            
            return tabContent;
        }

        function switchTab(tabId, targetButton = null) {
            // 隐藏所有内容
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.classList.add('hidden');
                content.style.display = 'none';
            });
            
            // 移除所有按钮的激活状态
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active-tab'));
            
            const activeButton = targetButton || document.getElementById("tab_" + tabId);
            // 确保找到按钮且按钮有classList属性
            if (activeButton && activeButton.classList) {
                activeButton.classList.add('active-tab');
            }
            
            // Record visit and remove indicator
            updateLastVisit(tabId);
            
            // 检查是否有对应的iframe配置
            if (iframeConfig[tabId]) {
                loadTabInIframe(tabId);
            } else {
                // 显示原始内容
                document.getElementById(tabId).classList.remove('hidden');
                document.getElementById(tabId).style.display = 'block';
            }
        }
        
        // Timeout configuration (in milliseconds)
        const IFRAME_LOAD_TIMEOUT = 15000; // 15 seconds
        const loadingTimers = {};
        
        function loadTabInIframe(tabId) {
            const config = iframeConfig[tabId];
            if (!config) return;
            
            // 检查容器是否存在，不存在则创建
            let iframeContainer = document.getElementById(config.id);
            if (!iframeContainer) {
                iframeContainer = createIframeContainer(tabId);
                if (!iframeContainer) return;
            }
            
            const iframe = iframeContainer.querySelector('iframe');
            const loadingElement = document.getElementById(`loading_${tabId}`);
            const errorElement = document.getElementById(`error_${tabId}`);
            
            // 检查当前iframe是否已经加载了相同的内容
            if (iframe.src === config.url || iframe.src.endsWith(config.url)) {
                // 如果是相同的iframe内容，只需要显示容器即可
                iframeContainer.classList.remove('hidden');
                iframeContainer.style.display = 'block';
                return;
            }
            
            // 重置状态
            iframe.classList.remove('loaded');
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            }
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            
            // 清除之前的定时器
            if (loadingTimers[tabId]) {
                clearTimeout(loadingTimers[tabId]);
            }
            
            // 设置加载超时
            loadingTimers[tabId] = setTimeout(() => {
                console.error(`${config.title} 加载超时`);
                showLoadError(tabId);
            }, IFRAME_LOAD_TIMEOUT);
            
            // 设置iframe加载事件
            iframe.onload = function() {
                clearTimeout(loadingTimers[tabId]);
                console.log(`${config.title} 加载成功`);
                hideLoading(tabId);
                iframe.classList.add('loaded');
            };
            
            iframe.onerror = function() {
                clearTimeout(loadingTimers[tabId]);
                console.error(`${config.title} 加载失败`);
                showLoadError(tabId);
            };
            
            // Append all URL params to iframe URL
            let iframeSrc = config.url;
            const urlParams = new URLSearchParams(window.location.search);
            if(window.miniGameProxyData)
            {
                // check if user is vip, if so, append vip=1 to url params
                if(window.miniGameProxyData.local_vip)
                {
                    urlParams.set("vip", "0"); // for free local vip
                }
                if(window.miniGameProxyData.isVip)
                {
                    urlParams.set("vip", "1"); // for real vip
                }
            }
            
            // Forward all URL parameters to the iframe
            if (urlParams.toString()) {
                const separator = config.url.includes('?') ? '&' : '?';
                iframeSrc = `${config.url}${separator}${urlParams.toString()}`;
            }
            
            iframe.src = iframeSrc;
            
            // 显示iframe容器
            iframeContainer.classList.remove('hidden');
            iframeContainer.style.display = 'block';
            
            console.log(`开始加载${config.title}到iframe: ${config.id}`);
        }
        
        function hideLoading(tabId) {
            const loadingElement = document.getElementById(`loading_${tabId}`);
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }
        
        function showLoadError(tabId) {
            const loadingElement = document.getElementById(`loading_${tabId}`);
            const errorElement = document.getElementById(`error_${tabId}`);
            
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            if (errorElement) {
                errorElement.classList.add('show');
            }
        }
        
        function retryLoad(tabId) {
            const config = iframeConfig[tabId];
            const errorElement = document.getElementById(`error_${tabId}`);
            const iframe = document.getElementById(`${tabId}_iframe`);
            
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            
            // 重置iframe src强制重新加载
            if (iframe) {
                iframe.src = '';
                setTimeout(() => {
                    loadTabInIframe(tabId);
                }, 100);
            }
        }
        
        function showSuccessMessage(message) {
            // 创建成功提示
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showErrorMessage(message) {
            // 创建错误提示
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

         window.addEventListener('message', function (e) {
            if (!e.data || !e.data.type) {
                return;
            }
            try {
                switch (e.data.type) {
                    case 'setGameConfig':
                        if (e.data.data) {
                            game_config = e.data.data;
                            const configData = JSON.parse(game_config);
                            console.log('游戏配置：', configData);

                            // 根据配置类型进行不同处理
                            if (configData.type === 'dailycheckin') {
                                const dailycheckinIframe = document.getElementById('signin_iframe');
                                console.log(dailycheckinIframe)
                                if (dailycheckinIframe && dailycheckinIframe.contentWindow) {
                                    dailycheckinIframe.contentWindow.postMessage({
                                        type: 'updateSignConfig',
                                        data: configData
                                    }, '*');
                                }
                            }
                        }
                        break;
                    case "loadSignConfig":
                        if (window.parent) {
                            window.parent.postMessage({ type: 'loadSignConfig' }, '*');
                        }
                        break;
                    case "getSigninReward":
                        if (window.parent) {
                            window.parent.postMessage({ type: 'getSigninReward', data: e.data.data }, '*');
                        }
                        break;
                    case "locationResponse":
                        const searchPath = e.data.search;
                        let tabToSwitch = 'candybox'; // Default tab
                        
                        if (searchPath) {
                            const params = new URLSearchParams(searchPath);
                            const iframeType = params.get('type');
                            if (iframeType) {
                                tabToSwitch = iframeType;
                            }
                        } else if (e.data.tab) {
                            tabToSwitch = e.data.tab;
                        }
                        
                        switchTab(tabToSwitch);
                        break;
                    case "miniGameProxyDataResponse":
                        window.miniGameProxyData = e.data;
                        break;
                    case "closeGameCommon":
                    case "GameLogic.RunCommand":
                    case "vipPayResult":
                        // 直接转发消息给父窗口
                        if (window.parent != window) {
                            window.parent.postMessage(e.data, '*');
                        }
                        break;
                    case "navigate":
                        // 处理导航消息
                        if (e.data.url) {
                            console.log('导航到URL:', e.data.url);
                            if (window.parent !== window) {
                                // 如果在iframe中，发送消息给父窗口处理导航
                                window.parent.postMessage({ 
                                    type: 'navigate', 
                                    url: e.data.url,
                                    navigateType: e.data.navigateType || 'openGame'
                                }, '*');
                            } else {
                                // 如果不在iframe中，直接跳转
                                window.location.href = e.data.url;
                            }
                        }
                        break;
                    case "getLocation":
                        // 处理获取位置信息的请求
                        const currentLocation = window.location.href;
                        e.source.postMessage({
                            type: 'locationResponse',
                            href: encodeURIComponent(currentLocation),
                            search: window.location.search
                        }, '*');
                        break;
                    default:
                        console.log('Unknown message type:', e.data.type);
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        });
        

        // Only request location when not in proxy mode
        const urlParams = new URLSearchParams(window.location.search);
        const isProxyMode = urlParams.get("parent") === "miniGameProxy";

        if (isProxyMode) {
            window.parent.postMessage({ type: 'getLocation' }, '*');
            window.parent.postMessage({ type: "getMiniGameProxyData" }, "*");
        }
        else{
            // If not in proxy mode, load the default tab directly
            switchTab('vip');
        }
        
        // Initialize update indicators after page loads
        setTimeout(() => {
            initializeIndicators();
        }, 500);
    </script>
</body>
</html>