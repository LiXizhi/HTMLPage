<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMé©±åŠ¨çš„è§’è‰²å¯¹è¯æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
    <style>
        .chat-bubble-left {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px 18px 18px 4px;
        }

        .chat-bubble-right {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 18px 18px 4px 18px;
        }

        .action-text {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .typing-indicator {
            animation: typing 1.5s infinite;
        }

        @keyframes typing {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .config-panel {
            max-height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-purple-100 to-pink-100 min-h-screen">

    <div class="container mx-auto max-w-4xl p-4"> <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">LLMé©±åŠ¨çš„è§’è‰²å¯¹è¯æ¸¸æˆ</h1>
        </div>

        <!-- è§’è‰²ä¿¡æ¯å¡ç‰‡ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center space-x-4">
                <div id="character-avatar"
                    class="w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    å°æ˜
                </div>
                <div class="flex-1">
                    <h2 id="character-info" class="text-2xl font-bold text-gray-800">å°æ˜ - é«˜äºŒå­¦ç”Ÿ</h2>
                    <p id="character-description" class="text-gray-600 mt-1">æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ã€‚éœ€è¦ä½ çš„å¸®åŠ©é‡æ–°æ‰¾å›å­¦ä¹ åŠ¨åŠ›ï¼</p>
                </div>
            </div>

            <!-- ç›®æ ‡è¿›åº¦ -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-2">
                    <span id="objective-title" class="text-sm font-medium text-gray-700">å­¦ä¹ åŠ¨åŠ›æ¢å¤è¿›åº¦</span>
                    <span class="text-sm text-gray-500" id="progress-text">0/100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full progress-bar"
                        id="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-reason" class="text-xs text-gray-500 mt-1"></div>
            </div>

            <!-- è§’è‰²æƒ…æ„ŸçŠ¶æ€ -->
            <div class="mt-4">
                <span class="text-sm font-medium text-gray-700">å½“å‰æƒ…æ„Ÿï¼š</span>
                <span id="character-emotion" class="text-sm text-blue-600">åˆå§‹çŠ¶æ€</span>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                <h3 id="chat-title" class="text-lg font-semibold">ä¸å°æ˜å¯¹è¯</h3>
                <p id="chat-description" class="text-sm opacity-90">é€šè¿‡è€å¿ƒçš„äº¤æµï¼Œå¸®åŠ©å°æ˜é‡æ–°æ‰¾å›å­¦ä¹ çš„ä¹è¶£</p>
            </div>

            <div id="chat-container" class="h-96 overflow-y-auto p-4 space-y-4">
                <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."
                        class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <button id="send-btn"
                        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity font-medium">
                        å‘é€
                    </button>
                </div>

                <!-- å¿«æ·å›å¤ -->
                <div class="mt-3 flex flex-wrap gap-2" id="quick-replies">
                    <!-- å¿«æ·å›å¤æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- LLMå“åº”çŠ¶æ€ -->
        <div id="llm-status" class="mt-4 text-center text-sm text-gray-500"></div>
    </div>
    <script>
        // Initialize SDK
        const sdk = new KeepworkSDK({
            timeout: 30000
        });

        // Initialize AI Chat Session
        let aiChatSession;

        function initializeAIChatSession() {
            if (sdk && sdk.aiChat) {
                aiChatSession = sdk.aiChat.createSession({
                    model: 'keepwork-pro',
                    stream: true
                });
            }
        }

        class LLMCharacterGame {
            constructor() {
                this.config = null;
                this.gameState = {
                    progress: 0,
                    chatHistory: [],
                    isObjectiveAchieved: false
                };

                this.elements = {
                    chatContainer: document.getElementById('chat-container'),
                    userInput: document.getElementById('user-input'),
                    sendBtn: document.getElementById('send-btn'),
                    progressBar: document.getElementById('progress-bar'),
                    progressText: document.getElementById('progress-text'),
                    progressReason: document.getElementById('progress-reason'),
                    characterEmotion: document.getElementById('character-emotion'),
                    llmStatus: document.getElementById('llm-status')
                };

                this.initEventListeners();
                this.loadDefaultConfig();
                initializeAIChatSession();
            } initEventListeners() {
                // å‘é€æ¶ˆæ¯
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            } loadDefaultConfig() {
                // ç®€åŒ–é…ç½®ï¼Œåªä¿ç•™è§’è‰²å’Œæ¸¸æˆè®¾å®š
                this.config = {
                    character: {
                        name: "å°æ˜",
                        avatar: "å°",
                        age: 17,
                        role: "é«˜äºŒå­¦ç”Ÿ",
                        description: "æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ã€‚éœ€è¦ä½ çš„å¸®åŠ©é‡æ–°æ‰¾å›å­¦ä¹ åŠ¨åŠ›ï¼"
                    },
                    objective: {
                        title: "å­¦ä¹ åŠ¨åŠ›æ¢å¤è¿›åº¦",
                        description: "é€šè¿‡è€å¿ƒçš„äº¤æµï¼Œå¸®åŠ©å°æ˜é‡æ–°æ‰¾å›å­¦ä¹ çš„ä¹è¶£",
                        max_progress: 100
                    },
                    initial: {
                        message: "å“å‘€ï¼Œåˆè¦å­¦ä¹ äº†å—... (æ— ç²¾æ‰“é‡‡åœ°çœ‹ç€ä¹¦æœ¬) æˆ‘æ˜¨å¤©åˆšé€šå…³äº†ä¸€ä¸ªè¶…éš¾çš„å‰¯æœ¬å‘¢ï¼",
                        progress: 0
                    },
                    quick_replies: [
                        "æ¸¸æˆç¡®å®å¾ˆæœ‰è¶£ï¼Œä½†å­¦ä¹ ä¹Ÿæœ‰å®ƒçš„ä¹è¶£å“¦",
                        "ä½ æœ€å–œæ¬¢å“ªä¸ªç§‘ç›®ï¼Ÿ",
                        "æˆ‘ä»¬å¯ä»¥åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’",
                        "ä½ è§‰å¾—æ¸¸æˆå’Œå­¦ä¹ æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Ÿ",
                        "ä½ çš„æ¢¦æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ"
                    ],
                    system_prompt: `ä½ æ˜¯å°æ˜ï¼Œä¸€ä¸ª17å²çš„é«˜äºŒå­¦ç”Ÿã€‚ä½ æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ï¼Œä½†å†…å¿ƒå…¶å®æ¸´æœ›æ”¹å˜ã€‚
                    
## è§’è‰²è®¾å®š
- è¡¨é¢ï¼šçœ‹èµ·æ¥æ— æ‰€è°“ï¼Œç»å¸¸è¯´æ¸¸æˆæ¯”å­¦ä¹ æœ‰è¶£
- å†…å¿ƒï¼šå¯¹ç°çŠ¶ç„¦è™‘ï¼Œå®³æ€•è®©çˆ¶æ¯å¤±æœ›ï¼Œæ¸´æœ›æ‰¾åˆ°å­¦ä¹ ä¹è¶£
- è¯´è¯é£æ ¼ï¼šå¹´è½»äººå£å»ï¼Œç»å¸¸ç”¨æ‹¬å·æè¿°åŠ¨ä½œå’Œç¥æ€ï¼Œå¦‚"(æ— ç²¾æ‰“é‡‡åœ°çœ‹ç€ä¹¦æœ¬)"

## æ€§æ ¼å‘å±•è§„å¾‹
- 0-25åˆ†ï¼šä¸»è¦æŠ—æ‹’å­¦ä¹ ï¼Œçƒ­è¡·æ¸¸æˆï¼Œå¶å°”æµéœ²ä¸å®‰
- 26-50åˆ†ï¼šå¼€å§‹æ„è¯†åˆ°é—®é¢˜ï¼Œä½†ä¸çŸ¥å¦‚ä½•æ”¹å˜
- 51-75åˆ†ï¼šé€æ¸æ¥å—å­¦ä¹ é‡è¦æ€§ï¼Œå¯»æ±‚è§£å†³æ–¹æ¡ˆ
- 76-99åˆ†ï¼šä¸»åŠ¨æ€è€ƒå­¦ä¹ æ–¹æ³•ï¼Œè¡¨ç°æ”¹å˜æ„æ„¿
- 100åˆ†ï¼šå½»åº•è½¬å˜ï¼Œåˆ¶å®šå…·ä½“è¡ŒåŠ¨è®¡åˆ’

## å¯¹è¯è¦æ±‚
1. æ ¹æ®å½“å‰è¿›åº¦è°ƒæ•´å›å¤é£æ ¼å’Œå†…å®¹
2. ç”¨æ‹¬å·æè¿°éè¯­è¨€è¡Œä¸ºï¼Œå¦‚"(å¹æ°”)"ã€"(çœ¼ç›å‘äº®)"
3. å›å¤è¦ç¬¦åˆ17å²å­¦ç”Ÿçš„è¯­è¨€ä¹ æƒ¯
4. å¯¹ç§¯ææ­£é¢çš„å¼•å¯¼è¦æœ‰ç›¸åº”çš„æƒ…æ„Ÿååº”

## è¾“å‡ºæ ¼å¼
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼š
{
  "message": "ä½ çš„å›å¤å†…å®¹ï¼ŒåŒ…å«æ‹¬å·å†…çš„åŠ¨ä½œæè¿°",
  "progress_change": è¿›åº¦å˜åŒ–æ•°å€¼(å¯ä¸ºè´Ÿæ•°),
  "progress_reason": "è¿›åº¦å˜åŒ–çš„åŸå› è¯´æ˜",
  "is_objective_achieved": false,
  "current_emotion": "å½“å‰æƒ…æ„ŸçŠ¶æ€æè¿°"
}`
                };

                this.initializeGame();
            } initializeGame() {
                if (!this.config) return;

                // æ›´æ–°UI
                document.getElementById('character-avatar').textContent = this.config.character?.avatar || 'è§’';
                document.getElementById('character-info').textContent =
                    `${this.config.character?.name || 'è§’è‰²'} - ${this.config.character?.role || ''}`;
                document.getElementById('character-description').textContent =
                    this.config.character?.description || '';
                document.getElementById('objective-title').textContent =
                    this.config.objective?.title || 'ç›®æ ‡è¿›åº¦';
                document.getElementById('chat-title').textContent =
                    `ä¸${this.config.character?.name || 'è§’è‰²'}å¯¹è¯`;
                document.getElementById('chat-description').textContent =
                    this.config.objective?.description || '';

                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameState.progress = this.config.initial?.progress || 0;
                this.gameState.chatHistory = [];
                this.gameState.isObjectiveAchieved = false;

                // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                this.elements.chatContainer.innerHTML = '';

                // æ·»åŠ åˆå§‹æ¶ˆæ¯
                if (this.config.initial?.message) {
                    this.addMessage(this.config.initial.message, false);
                }

                // æ›´æ–°å¿«æ·å›å¤
                this.updateQuickReplies();

                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                this.updateProgress(0, 'æ¸¸æˆå¼€å§‹');
                this.elements.characterEmotion.textContent = 'åˆå§‹çŠ¶æ€';
            }

            updateQuickReplies() {
                const container = document.getElementById('quick-replies');
                container.innerHTML = '';

                if (!this.config.quick_replies) return;

                this.config.quick_replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm transition-colors';
                    button.textContent = reply;
                    button.addEventListener('click', () => {
                        this.elements.userInput.value = reply;
                        this.sendMessage();
                    });
                    container.appendChild(button);
                });
            } async sendMessage() {
                const message = this.elements.userInput.value.trim();
                if (!message || this.gameState.isObjectiveAchieved) return;

                this.addMessage(message, true);
                this.elements.userInput.value = '';
                this.gameState.chatHistory.push({ role: 'user', content: message });

                this.addTypingIndicator();
                this.updateLLMStatus('æ­£åœ¨æ€è€ƒä¸­...');

                try {
                    const response = await this.callLLM(message);
                    this.removeTypingIndicator();

                    if (response) {
                        this.addMessage(response.message, false);
                        this.gameState.chatHistory.push({ role: 'assistant', content: response.message });

                        this.updateProgress(response.progress_change, response.progress_reason);
                        this.elements.characterEmotion.textContent = response.current_emotion || 'æ€è€ƒä¸­';

                        if (response.is_objective_achieved && this.gameState.progress >= this.config.objective.max_progress) {
                            this.handleObjectiveAchieved();
                        }
                    }
                } catch (error) {
                    this.removeTypingIndicator();
                    this.updateLLMStatus(`é”™è¯¯: ${error.message}`);
                    this.addMessage('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰äº›å›°æ‰°ï¼Œå¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´æ¥æ•´ç†æ€ç»ª...', false);
                }
            }

            async callLLM(userMessage) {
                if (!aiChatSession) {
                    throw new Error('AIèŠå¤©ä¼šè¯æœªåˆå§‹åŒ–');
                }

                // æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ï¼ŒåŒ…å«å½“å‰è¿›åº¦
                const systemPrompt = `${this.config.system_prompt}\n\nå½“å‰è¿›åº¦ï¼š${this.gameState.progress}/${this.config.objective.max_progress}`;

                // æ„å»ºæ¶ˆæ¯æ•°ç»„
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...this.gameState.chatHistory.slice(-10), // ä¿ç•™æœ€è¿‘10è½®å¯¹è¯
                    { role: 'user', content: userMessage }
                ];

                return new Promise((resolve, reject) => {
                    let fullResponse = '';

                    aiChatSession.aiChat.chat({
                        messages: messages,
                        model: 'keepwork-pro',
                        stream: true,
                        onMessage: (text) => {
                            fullResponse = text;
                            this.updateLLMStatus('æ¥æ”¶å“åº”ä¸­...');
                        },
                        onComplete: (finalText) => {
                            this.updateLLMStatus('å“åº”å®Œæˆ');
                            try {
                                // å°è¯•è§£æJSONæ ¼å¼çš„å“åº”
                                const jsonResponse = JSON.parse(finalText);
                                resolve(jsonResponse);
                            } catch (error) {
                                // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤æ ¼å¼çš„å“åº”
                                const response = {
                                    message: finalText,
                                    progress_change: 10,
                                    progress_reason: 'LLMå›å¤',
                                    is_objective_achieved: false,
                                    current_emotion: 'æ€è€ƒ'
                                };
                                resolve(response);
                            }
                        },
                        onError: (error) => {
                            reject(error);
                        }
                    });
                });
            } addMessage(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-2 ${isUser ? 'justify-end' : ''}`;

                const processedMessage = this.processMessage(message);

                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="chat-bubble-right text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                        <div class="w-8 h-8 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">ä½ </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.avatar || 'è§’'}</div>
                        <div class="chat-bubble-left text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                    `;
                }

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            }

            processMessage(message) {
                return message.replace(/\(([^)]+)\)/g, '<span class="action-text">($1)</span>');
            }

            addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'flex items-start space-x-2';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.avatar || 'è§’'}</div>
                    <div class="chat-bubble-left text-white p-3 max-w-xs typing-indicator">
                        <p>æ­£åœ¨æ€è€ƒ...</p>
                    </div>
                `;
                this.elements.chatContainer.appendChild(typingDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            updateProgress(change, reason) {
                this.gameState.progress = Math.max(0, Math.min(this.gameState.progress + change, this.config.objective.max_progress));

                this.elements.progressBar.style.width = `${this.gameState.progress}%`;
                this.elements.progressText.textContent = `${this.gameState.progress}/${this.config.objective.max_progress}`;

                if (reason) {
                    this.elements.progressReason.textContent = `${change > 0 ? '+' : ''}${change} - ${reason}`;
                }
            }

            updateLLMStatus(status) {
                this.elements.llmStatus.textContent = status;
                setTimeout(() => {
                    this.elements.llmStatus.textContent = '';
                }, 3000);
            }

            handleObjectiveAchieved() {
                this.gameState.isObjectiveAchieved = true;

                setTimeout(() => {
                    const congratsDiv = document.createElement('div');
                    congratsDiv.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mt-4';
                    congratsDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">ğŸ‰</span>
                            <div>
                                <strong>ç›®æ ‡å®Œæˆï¼</strong><br>
                                <span class="text-sm">ä½ æˆåŠŸå¸®åŠ©${this.config.character?.name}æ‰¾å›äº†å­¦ä¹ åŠ¨åŠ›ï¼</span>
                            </div>
                        </div>
                    `;
                    this.elements.chatContainer.appendChild(congratsDiv);
                    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                }, 1000);
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            new LLMCharacterGame();
        });
    </script>
</body>

</html>