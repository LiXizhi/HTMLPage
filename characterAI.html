<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²AIå¯¹è¯æ¸¸æˆ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
    <style>
        .chat-bubble-left {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px 18px 18px 4px;
        }

        .chat-bubble-right {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 18px 18px 4px 18px;
        }

        .action-text {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .typing-indicator {
            animation: typing 1.5s infinite;
        }

        @keyframes typing {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .config-panel {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* æµå¼æ¶ˆæ¯æ ·å¼ */
        .streaming-message .chat-bubble-left {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: streaming-pulse 1.5s ease-in-out infinite;
        }

        .streaming-cursor {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            animation: cursor-blink 1s infinite;
        }

        @keyframes streaming-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
        }

        @keyframes cursor-blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* è¯­éŸ³æ’­æ”¾æŒ‰é’®æ ·å¼ */
        .audio-btn {
            background: rgba(86, 60, 233, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
            align-self: flex-end;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            background: rgba(58, 141, 236, 0.8);
            transform: scale(1.1);
        }

        .audio-btn.playing {
            background: rgba(0, 255, 0, 0.8);
            animation: audio-pulse 1s infinite;
        }

        @keyframes audio-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-purple-100 to-pink-100 overflow-hidden">

    <div class="flex h-screen"> <!-- å·¦ä¾§è§’è‰²ä¿¡æ¯åŒºåŸŸ -->
        <div class="w-1/3 bg-white shadow-lg p-6 overflow-y-auto">
            <!-- è§’è‰²ä¿¡æ¯å¡ç‰‡ -->
            <div class="mb-6">
                <div class="flex items-center space-x-4 mb-6">
                    <div id="character-avatar"
                        class="w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                        å°
                    </div>
                    <div class="flex-1">
                        <h2 id="character-info" class="text-2xl font-bold text-gray-800">å°æ˜ - é«˜äºŒå­¦ç”Ÿ</h2>
                        <p id="character-description" class="text-gray-600 mt-1">æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ã€‚éœ€è¦ä½ çš„å¸®åŠ©é‡æ–°æ‰¾å›å­¦ä¹ åŠ¨åŠ›ï¼</p>
                    </div>
                </div>

                <!-- ç›®æ ‡è¿›åº¦ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span id="objective-title" class="text-sm font-medium text-gray-700">è¿›åº¦</span>
                        <span class="text-sm text-gray-500" id="progress-text">0/100</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full progress-bar"
                            id="progress-bar" style="width: 0%"></div>
                    </div>
                </div> <!-- è§’è‰²å†…å¿ƒæƒ³æ³• -->
                <div class="mb-6">
                    <span class="text-lg text-gray-700">å†…å¿ƒæƒ³æ³•ï¼š</span>
                    <div id="inner-thoughts" class="mt-2 text-base text-gray-600 max-h-32 overflow-y-auto">
                    </div>
                </div>
            </div>

            <!-- LLMå“åº”çŠ¶æ€ -->
            <div id="llm-status" class="text-center text-sm text-gray-500"></div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="flex-1 flex flex-col bg-white shadow-lg">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                <h3 id="chat-title" class="text-lg font-semibold">ä¸å°æ˜å¯¹è¯</h3>
                <p id="chat-description" class="text-sm opacity-90">é€šè¿‡è€å¿ƒçš„äº¤æµï¼Œå¸®åŠ©å°æ˜é‡æ–°æ‰¾å›å­¦ä¹ çš„ä¹è¶£</p>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."
                        class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <button id="send-btn"
                        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity font-medium">
                        å‘é€
                    </button>
                </div>

                <!-- å¿«æ·å›å¤ -->
                <div class="mt-3 flex flex-wrap gap-2" id="quick-replies">
                    <!-- å¿«æ·å›å¤æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize SDK
        const sdk = new KeepworkSDK({
            timeout: 30000
        });
        console.log(`Keepwork SDK initialized token: ${sdk.token}`);

        // Initialize AI Chat Session
        let aiChatSession;

        function initializeAIChatSession() {
            if (sdk && sdk.aiChat) {
                aiChatSession = sdk.aiChat.createSession({
                    model: 'keepwork-pro',
                    stream: true
                });
            }
        }

        class LLMCharacterGame {
            constructor() {
                this.config = null;
                this.gameState = {
                    progress: 0,
                    chatHistory: [],
                    isObjectiveAchieved: false
                };                // éŸ³é¢‘æ’­æ”¾æ§åˆ¶
                this.currentAudioController = null; // å½“å‰æ’­æ”¾çš„éŸ³é¢‘æ§åˆ¶å™¨
                this.currentPlayingButton = null;   // å½“å‰æ’­æ”¾çš„æŒ‰é’®
                this.audioCache = new Map();        // ç¼“å­˜éŸ³é¢‘URLï¼Œkeyä¸ºæ–‡æœ¬ï¼Œvalueä¸ºURL

                this.elements = {
                    chatContainer: document.getElementById('chat-container'),
                    userInput: document.getElementById('user-input'),
                    sendBtn: document.getElementById('send-btn'),
                    progressBar: document.getElementById('progress-bar'),
                    progressText: document.getElementById('progress-text'),
                    innerThoughts: document.getElementById('inner-thoughts'),
                    llmStatus: document.getElementById('llm-status')
                };

                this.initEventListeners();
                this.loadDefaultConfig();
                initializeAIChatSession();
            }

            initEventListeners() {
                // å‘é€æ¶ˆæ¯
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            loadDefaultConfig() {                // ç®€åŒ–é…ç½®ï¼Œåªä¿ç•™è§’è‰²å’Œæ¸¸æˆè®¾å®š
                this.config = {
                    character: {
                        name: "å°æ˜",
                        age: 17,
                        gender: "male",
                        role: "é«˜äºŒå­¦ç”Ÿ",
                        description: "æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ã€‚éœ€è¦ä½ çš„å¸®åŠ©é‡æ–°æ‰¾å›å­¦ä¹ åŠ¨åŠ›ï¼"
                    },
                    objective: {
                        title: "å­¦ä¹ åŠ¨åŠ›æ¢å¤è¿›åº¦",
                        description: "é€šè¿‡è€å¿ƒçš„äº¤æµï¼Œå¸®åŠ©å°æ˜é‡æ–°æ‰¾å›å­¦ä¹ çš„ä¹è¶£",
                        max_progress: 100
                    },
                    initial: {
                        message: "å“å‘€ï¼Œåˆè¦å­¦ä¹ äº†å—... (æ— ç²¾æ‰“é‡‡åœ°çœ‹ç€ä¹¦æœ¬) æˆ‘æ˜¨å¤©åˆšé€šå…³äº†ä¸€ä¸ªè¶…éš¾çš„å‰¯æœ¬å‘¢ï¼",
                        progress: 0
                    },
                    quick_replies: [
                        "æ¸¸æˆç¡®å®å¾ˆæœ‰è¶£ï¼Œä½†å­¦ä¹ ä¹Ÿæœ‰å®ƒçš„ä¹è¶£å“¦",
                        "ä½ æœ€å–œæ¬¢å“ªä¸ªç§‘ç›®ï¼Ÿ",
                        "æˆ‘ä»¬å¯ä»¥åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’",
                        "ä½ è§‰å¾—æ¸¸æˆå’Œå­¦ä¹ æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„ï¼Ÿ",
                        "ä½ çš„æ¢¦æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ"
                    ], system_prompt: `ä½ æ˜¯å°æ˜ï¼Œä¸€ä¸ª17å²çš„é«˜äºŒå­¦ç”Ÿã€‚ä½ æœ€è¿‘æ²‰è¿·æ¸¸æˆï¼Œå­¦ä¹ æˆç»©ä¸‹æ»‘ï¼Œä½†å†…å¿ƒå…¶å®æ¸´æœ›æ”¹å˜ã€‚
                    
## è§’è‰²è®¾å®š
- è¡¨é¢ï¼šçœ‹èµ·æ¥æ— æ‰€è°“ï¼Œç»å¸¸è¯´æ¸¸æˆæ¯”å­¦ä¹ æœ‰è¶£
- å†…å¿ƒï¼šå¯¹ç°çŠ¶ç„¦è™‘ï¼Œå®³æ€•è®©çˆ¶æ¯å¤±æœ›ï¼Œæ¸´æœ›æ‰¾åˆ°å­¦ä¹ ä¹è¶£
- è¯´è¯é£æ ¼ï¼šå¹´è½»äººå£å»ï¼Œç»å¸¸ç”¨æ‹¬å·æè¿°åŠ¨ä½œå’Œç¥æ€ï¼Œå¦‚"(æ— ç²¾æ‰“é‡‡åœ°çœ‹ç€ä¹¦æœ¬)"

## æ€§æ ¼å‘å±•è§„å¾‹
- 0-25åˆ†ï¼šä¸»è¦æŠ—æ‹’å­¦ä¹ ï¼Œçƒ­è¡·æ¸¸æˆï¼Œå¶å°”æµéœ²ä¸å®‰
- 26-50åˆ†ï¼šå¼€å§‹æ„è¯†åˆ°é—®é¢˜ï¼Œä½†ä¸çŸ¥å¦‚ä½•æ”¹å˜
- 51-75åˆ†ï¼šé€æ¸æ¥å—å­¦ä¹ é‡è¦æ€§ï¼Œå¯»æ±‚è§£å†³æ–¹æ¡ˆ
- 76-99åˆ†ï¼šä¸»åŠ¨æ€è€ƒå­¦ä¹ æ–¹æ³•ï¼Œè¡¨ç°æ”¹å˜æ„æ„¿
- 100åˆ†ï¼šå½»åº•è½¬å˜ï¼Œåˆ¶å®šå…·ä½“è¡ŒåŠ¨è®¡åˆ’

## å¯¹è¯è¦æ±‚
1. æ ¹æ®å½“å‰å¯¹è¯å†…å®¹å’Œå†å²å‘å±•åˆ¤æ–­å½“å‰åº”æœ‰çš„è¿›åº¦ç™¾åˆ†æ¯”(0-100)
2. ç”¨æ‹¬å·æè¿°éè¯­è¨€è¡Œä¸ºï¼Œå¦‚"(å¹æ°”)"ã€"(çœ¼ç›å‘äº®)"
3. å›å¤è¦ç¬¦åˆ17å²å­¦ç”Ÿçš„è¯­è¨€ä¹ æƒ¯
4. å¯¹ç§¯ææ­£é¢çš„å¼•å¯¼è¦æœ‰ç›¸åº”çš„æƒ…æ„Ÿååº”

## è¾“å‡ºæ ¼å¼
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼š
{
  "message": "ä½ çš„å›å¤å†…å®¹ï¼ŒåŒ…å«æ‹¬å·å†…çš„åŠ¨ä½œæè¿°",
  "progress_percentage": å½“å‰å­¦ä¹ åŠ¨åŠ›æ¢å¤çš„ç»å¯¹è¿›åº¦ç™¾åˆ†æ¯”(0-100çš„æ•´æ•°),
  "progress_reason": "å½“å‰è¿›åº¦ç™¾åˆ†æ¯”çš„åŸå› è¯´æ˜",
  "inner_thoughts": "ä½ æ­¤åˆ»çœŸå®çš„å†…å¿ƒæƒ³æ³•å’Œæ„Ÿå—"
}`,
                    completion_messages: {
                        title: "ç›®æ ‡å®Œæˆï¼",
                        description: "ä½ æˆåŠŸå¸®åŠ©${character_name}æ‰¾å›äº†å­¦ä¹ åŠ¨åŠ›ï¼",
                        icon: "ğŸ‰"
                    }
                };

                this.initializeGame();
            }

            initializeGame() {
                if (!this.config) return;                // æ›´æ–°UI
                document.getElementById('character-avatar').textContent = this.config.character?.name?.[0] || 'è§’';
                document.getElementById('character-info').textContent =
                    `${this.config.character?.name || 'è§’è‰²'} - ${this.config.character?.role || ''}`;
                document.getElementById('character-description').textContent =
                    this.config.character?.description || '';
                document.getElementById('objective-title').textContent =
                    this.config.objective?.title || 'ç›®æ ‡è¿›åº¦';
                document.getElementById('chat-title').textContent =
                    `ä¸${this.config.character?.name || 'è§’è‰²'}å¯¹è¯`;
                document.getElementById('chat-description').textContent =
                    this.config.objective?.description || '';                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameState.progress = this.config.initial?.progress || 0;
                this.gameState.chatHistory = [];
                this.gameState.isObjectiveAchieved = false;

                // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                this.elements.chatContainer.innerHTML = '';

                // æ·»åŠ åˆå§‹æ¶ˆæ¯
                if (this.config.initial?.message) {
                    this.addMessage(this.config.initial.message, false);
                }

                // æ›´æ–°å¿«æ·å›å¤
                this.updateQuickReplies();                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                this.updateProgress(0, 'æ¸¸æˆå¼€å§‹');
            }

            updateQuickReplies() {
                const container = document.getElementById('quick-replies');
                container.innerHTML = '';

                if (!this.config.quick_replies) return;

                this.config.quick_replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm transition-colors';
                    button.textContent = reply;
                    button.addEventListener('click', () => {
                        this.elements.userInput.value = reply;
                        this.sendMessage();
                    });
                    container.appendChild(button);
                });
            }

            async sendMessage() {
                const message = this.elements.userInput.value.trim();
                if (!message || this.gameState.isObjectiveAchieved) return;

                // ç¦ç”¨è¾“å…¥æ§ä»¶
                this.elements.sendBtn.disabled = true;
                this.elements.userInput.disabled = true;

                this.addMessage(message, true);
                this.elements.userInput.value = '';
                this.gameState.chatHistory.push({ role: 'user', content: message });

                this.addTypingIndicator();
                this.updateLLMStatus('æ­£åœ¨è¿æ¥AI...'); try {
                    const response = await this.callLLM(message); if (response) {
                        // æµå¼æ¶ˆæ¯å·²ç»åœ¨callLLMä¸­å¤„ç†äº†ï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°æ¸¸æˆçŠ¶æ€
                        this.gameState.chatHistory.push({ role: 'assistant', content: response.message });                        // è®¡ç®—è¿›åº¦å˜åŒ–å€¼
                        const oldProgress = this.gameState.progress;
                        const newProgress = Math.min(100, Math.max(0, response.progress_percentage || 0));
                        const progressChange = newProgress - oldProgress;                        // æ›´æ–°è¿›åº¦åˆ°æ–°çš„ç»å¯¹å€¼
                        this.updateProgressToValue(newProgress, response.progress_reason);
                        if (response.inner_thoughts) {
                            this.addInnerThought(response.inner_thoughts);
                        }

                        // åœ¨æœ€åä¸€æ¡æ¶ˆæ¯ä¸‹é¢æ·»åŠ è¿›åº¦æ˜¾ç¤º
                        this.addProgressIndicator(progressChange, response.progress_reason);

                        if (newProgress >= this.config.objective.max_progress) {
                            this.handleObjectiveAchieved();
                        }
                    }
                } catch (error) {
                    this.removeTypingIndicator();
                    this.updateLLMStatus(`é”™è¯¯: ${error.message}`);
                    this.addMessage('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰äº›å›°æ‰°ï¼Œå¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´æ¥æ•´ç†æ€ç»ª...', false);
                } finally {
                    // é‡æ–°å¯ç”¨è¾“å…¥æ§ä»¶
                    this.elements.sendBtn.disabled = false;
                    this.elements.userInput.disabled = false;
                    this.elements.userInput.focus();
                }
            }            // Helper function to extract all response fields using regex
            extractResponseFields(text) {
                const fields = {
                    message: '',
                    progress_percentage: null,
                    progress_reason: '',
                    inner_thoughts: ''
                };

                // Extract message field
                const messageRegex = /"message"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const messageMatch = messageRegex.exec(text);
                if (messageMatch) {
                    fields.message = messageMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                // Extract progress_percentage field
                const progressPercentageRegex = /"progress_percentage"\s*:\s*(\d+)/;
                const progressPercentageMatch = progressPercentageRegex.exec(text);
                if (progressPercentageMatch) {
                    fields.progress_percentage = parseInt(progressPercentageMatch[1]);
                }

                // Extract progress_reason field
                const progressReasonRegex = /"progress_reason"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const progressReasonMatch = progressReasonRegex.exec(text);
                if (progressReasonMatch) {
                    fields.progress_reason = progressReasonMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                // Extract inner_thoughts field
                const thoughtsRegex = /"inner_thoughts"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const thoughtsMatch = thoughtsRegex.exec(text);
                if (thoughtsMatch) {
                    fields.inner_thoughts = thoughtsMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                return fields;
            } updateStreamingStatus(fields) {
                // åªåœ¨æµå¼ä¼ è¾“è¿‡ç¨‹ä¸­ä¸´æ—¶æ›´æ–°å†…å¿ƒæƒ³æ³•åŒºåŸŸçš„çŠ¶æ€
                if (fields.inner_thoughts) {
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸´æ—¶çš„æµå¼æ˜¾ç¤ºæ•ˆæœï¼Œå¦‚æœéœ€è¦çš„è¯
                }
            } async callLLM(userMessage) {
                if (!aiChatSession) {
                    throw new Error('AIèŠå¤©ä¼šè¯æœªåˆå§‹åŒ–');
                }

                // ä½¿ç”¨åŸå§‹çš„ç³»ç»Ÿæç¤ºè¯ï¼Œä¸åŒ…å«å½“å‰è¿›åº¦
                const systemPrompt = this.config.system_prompt;

                // å…ˆæ·»åŠ ç³»ç»Ÿæç¤ºè¯åˆ°ä¼šè¯ä¸­ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
                if (aiChatSession.messages.length === 0) {
                    aiChatSession.messages.push({ role: 'system', content: systemPrompt });
                }
                try {
                    let streamingMessageDiv = null;
                    let accumulatedText = '';
                    let jsonResponse = null;

                    const finalText = await aiChatSession.send(userMessage, {
                        onMessage: (text) => {
                            accumulatedText = text;
                            this.updateLLMStatus('æ¥æ”¶å“åº”ä¸­...');

                            // ä½¿ç”¨helperå‡½æ•°æå–æ‰€æœ‰å­—æ®µ
                            const fields = this.extractResponseFields(text);

                            // å°è¯•è§£æå®Œæ•´JSON
                            try {
                                jsonResponse = JSON.parse(text);
                            } catch (e) {
                                // JSONå¯èƒ½ä¸å®Œæ•´ï¼Œç»§ç»­ç­‰å¾…
                            }

                            // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœè¿˜åœ¨ï¼‰
                            if (!streamingMessageDiv) {
                                this.removeTypingIndicator();
                                // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
                                streamingMessageDiv = this.addStreamingMessage();
                            }

                            // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹ï¼Œåªæ˜¾ç¤ºmessageéƒ¨åˆ†
                            if (fields.message) {
                                this.updateStreamingMessage(streamingMessageDiv, fields.message);
                            }

                            // æ›´æ–°æµå¼çŠ¶æ€æ˜¾ç¤º
                            this.updateStreamingStatus(fields);
                        }, onComplete: (finalText) => {
                            this.updateLLMStatus('å“åº”å®Œæˆ');

                            // ç¡®ä¿ä½¿ç”¨æœ€ç»ˆæ–‡æœ¬è§£æJSON
                            if (!jsonResponse) {
                                try {
                                    jsonResponse = JSON.parse(finalText);
                                } catch (e) {
                                    const fields = this.extractResponseFields(finalText);
                                    jsonResponse = {
                                        message: fields.message || finalText,
                                        progress_percentage: fields.progress_percentage !== null ? fields.progress_percentage : 0,
                                        progress_reason: fields.progress_reason || 'ç§¯æäº¤æµ',
                                        inner_thoughts: fields.inner_thoughts || 'æ­£åœ¨æ€è€ƒ'
                                    };
                                }
                            }

                            if (streamingMessageDiv) {
                                // å®Œæˆæµå¼æ˜¾ç¤ºï¼Œè½¬æ¢ä¸ºæ™®é€šæ¶ˆæ¯
                                this.finalizeStreamingMessage(streamingMessageDiv);
                            }
                        }, onError: (error) => {
                            if (streamingMessageDiv) {
                                this.removeStreamingMessage(streamingMessageDiv);
                            }
                            throw error;
                        }
                    });

                    // è¿”å›è§£æåçš„å“åº”
                    return jsonResponse;
                } catch (error) {
                    throw error;
                }
            } addMessage(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-2 ${isUser ? 'justify-end' : ''}`;

                const processedMessage = this.processMessage(message);

                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="chat-bubble-right text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                        <div class="w-8 h-8 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">ä½ </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || 'è§’'}</div>
                        <div class="chat-bubble-left text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                        <button class="audio-btn" title="æ’­æ”¾è¯­éŸ³" onclick="game.playMessageAudio('${this.escapeForAttribute(message)}', this)">
                            ğŸ”Š
                        </button>
                    `;
                }

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } processMessage(message) {
                return message.replace(/\(([^)]+)\)/g, '<span class="action-text">($1)</span>');
            }

            // è½¬ä¹‰å­—ç¬¦ä¸²ç”¨äºHTMLå±æ€§
            escapeForAttribute(str) {
                return str.replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/\\/g, '\\\\');
            }

            // ç§»é™¤æ‹¬å·å†…å®¹ç”¨äºè¯­éŸ³æ’­æ”¾
            removeBracketsContent(text) {
                // ç§»é™¤ä¸­æ–‡æ‹¬å·å’Œè‹±æ–‡æ‹¬å·ä¸­çš„å†…å®¹
                return text.replace(/\([^)]*\)/g, '').replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '').trim();
            }            // æ’­æ”¾æ¶ˆæ¯è¯­éŸ³
            async playMessageAudio(messageText, buttonElement) {
                try {
                    // å¦‚æœæ²¡æœ‰ä¼ å…¥æŒ‰é’®å…ƒç´ ï¼Œé€šè¿‡æ–‡æœ¬å†…å®¹æŸ¥æ‰¾
                    let currentButton = buttonElement;
                    if (!currentButton) {
                        const audioButtons = document.querySelectorAll('.audio-btn');
                        audioButtons.forEach(btn => {
                            const bubble = btn.closest('.chat-bubble-left');
                            if (bubble) {
                                const content = bubble.querySelector('p') || bubble.querySelector('.streaming-content');
                                if (content && content.textContent.includes(messageText.substring(0, 20))) {
                                    currentButton = btn;
                                }
                            }
                        });
                    }

                    // å¦‚æœå½“å‰æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾
                    if (this.currentPlayingButton) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªæŒ‰é’®ï¼Œåˆ™åœæ­¢æ’­æ”¾
                        if (currentButton === this.currentPlayingButton) {
                            this.stopCurrentAudio();
                            return;
                        } else {
                            // åœæ­¢å½“å‰æ’­æ”¾ï¼Œå¼€å§‹æ–°çš„æ’­æ”¾
                            this.stopCurrentAudio();
                        }
                    }

                    // è¿‡æ»¤æ‰æ‹¬å·ä¸­çš„å†…å®¹
                    const textToRead = this.removeBracketsContent(messageText);

                    if (!textToRead.trim()) {
                        console.log('æ²¡æœ‰å¯æ’­æ”¾çš„æ–‡æœ¬å†…å®¹');
                        return;
                    }

                    if (!currentButton) {
                        console.log('æ‰¾ä¸åˆ°å¯¹åº”çš„éŸ³é¢‘æŒ‰é’®');
                        return;
                    }

                    // è®¾ç½®æ’­æ”¾çŠ¶æ€
                    currentButton.classList.add('playing');
                    currentButton.innerHTML = 'â¸ï¸';
                    currentButton.title = 'åœæ­¢è¯­éŸ³';

                    // ä¿å­˜å½“å‰æ’­æ”¾ä¿¡æ¯
                    this.currentPlayingButton = currentButton;                    // ä½¿ç”¨SDKæ’­æ”¾è¯­éŸ³
                    try {
                        let audio_url;

                        // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰è¯¥æ–‡æœ¬çš„éŸ³é¢‘URL
                        if (this.audioCache.has(textToRead)) {
                            audio_url = this.audioCache.get(textToRead);
                            console.log('ä½¿ç”¨ç¼“å­˜çš„éŸ³é¢‘URL');
                        } else {
                            // ä»SDKè·å–æ–°çš„éŸ³é¢‘URL
                            const result = await sdk.speech.textToAudio(textToRead, {
                                gender: this.config.character?.gender,
                                age: this.config.character?.age
                            });

                            if (result && result.data) {
                                audio_url = result.data;
                                // ç¼“å­˜éŸ³é¢‘URL
                                this.audioCache.set(textToRead, audio_url);
                                console.log('ç¼“å­˜æ–°çš„éŸ³é¢‘URL');
                            } else {
                                throw new Error('æ— æ³•è·å–éŸ³é¢‘URL');
                            }
                        }

                        if (audio_url) {
                            // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
                            const audio = new Audio(audio_url);

                            // ç¡®ä¿éŸ³é¢‘ä¸å¾ªç¯æ’­æ”¾
                            audio.loop = false;

                            // ä¿å­˜éŸ³é¢‘æ§åˆ¶å™¨å¼•ç”¨
                            this.currentAudioController = audio;

                            // éŸ³é¢‘æ’­æ”¾å®Œæˆäº‹ä»¶
                            audio.addEventListener('ended', () => {
                                console.log('éŸ³é¢‘æ’­æ”¾å®Œæˆ');
                                this.stopCurrentAudio();
                            });

                            // éŸ³é¢‘å‡ºé”™äº‹ä»¶
                            audio.addEventListener('error', (e) => {
                                console.error('éŸ³é¢‘æ’­æ”¾å‡ºé”™:', e);
                                this.stopCurrentAudio();
                            });

                            // éŸ³é¢‘åŠ è½½å®Œæˆåå¼€å§‹æ’­æ”¾
                            audio.addEventListener('canplay', () => {
                                // ç¡®ä¿å½“å‰æŒ‰é’®ä»ç„¶æ˜¯æ­£ç¡®çš„æŒ‰é’®ï¼ˆé˜²æ­¢å¿«é€Ÿç‚¹å‡»å¯¼è‡´çš„çŠ¶æ€æ··ä¹±ï¼‰
                                if (this.currentPlayingButton === currentButton && this.currentAudioController === audio) {
                                    audio.play().catch(error => {
                                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                                        this.stopCurrentAudio();
                                    });
                                }
                            });

                            // åŠ è½½éŸ³é¢‘
                            audio.load();
                        }
                    } catch (audioError) {
                        console.error('è¯­éŸ³æ’­æ”¾å‡ºé”™:', audioError);
                        this.stopCurrentAudio();
                    }

                } catch (error) {
                    console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
                    this.stopCurrentAudio();
                }
            }            // åœæ­¢å½“å‰éŸ³é¢‘æ’­æ”¾
            stopCurrentAudio() {
                // åœæ­¢å¹¶æ¸…ç†éŸ³é¢‘
                if (this.currentAudioController) {
                    this.currentAudioController.pause();
                    this.currentAudioController.currentTime = 0;
                    this.currentAudioController = null;
                }

                // é‡ç½®æŒ‰é’®çŠ¶æ€
                if (this.currentPlayingButton) {
                    this.currentPlayingButton.classList.remove('playing');
                    this.currentPlayingButton.innerHTML = 'ğŸ”Š';
                    this.currentPlayingButton.title = 'æ’­æ”¾è¯­éŸ³';
                    this.currentPlayingButton = null;
                }
            }

            addStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-2 streaming-message';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || 'è§’'}</div>
                    <div class="chat-bubble-left text-white p-3 max-w-xs">
                        <p class="streaming-content"></p>
                        <span class="streaming-cursor">â–‹</span>
                    </div>
                `;
                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                return messageDiv;
            }

            updateStreamingMessage(messageDiv, text) {
                const contentElement = messageDiv.querySelector('.streaming-content');
                if (contentElement) {
                    contentElement.innerHTML = this.processMessage(text);
                    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                }
            } finalizeStreamingMessage(messageDiv) {
                const cursor = messageDiv.querySelector('.streaming-cursor');
                if (cursor) {
                    cursor.remove();
                }
                messageDiv.classList.remove('streaming-message');

                // ä¸ºå®Œæˆçš„æµå¼æ¶ˆæ¯æ·»åŠ è¯­éŸ³æ’­æ”¾æŒ‰é’®
                const contentElement = messageDiv.querySelector('.streaming-content');
                if (contentElement) {
                    const messageText = contentElement.textContent || contentElement.innerText;
                    const audioBtn = document.createElement('button');
                    audioBtn.className = 'audio-btn';
                    audioBtn.title = 'æ’­æ”¾è¯­éŸ³';
                    audioBtn.innerHTML = 'ğŸ”Š';
                    audioBtn.onclick = () => this.playMessageAudio(messageText, audioBtn);
                    messageDiv.appendChild(audioBtn);
                }
            }

            removeStreamingMessage(messageDiv) {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            } addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'flex items-start space-x-2';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || 'è§’'}</div>
                    <div class="chat-bubble-left text-white p-3 max-w-xs typing-indicator">
                        <p>æ­£åœ¨æ€è€ƒ...</p>
                    </div>
                `;
                this.elements.chatContainer.appendChild(typingDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            addProgressIndicator(progressChange, progressReason) {
                if (!progressChange || progressChange === 0) return;

                const progressDiv = document.createElement('div');
                progressDiv.className = 'flex justify-center my-2';

                const progressText = progressChange > 0 ? `+${progressChange}` : `${progressChange}`;
                const progressEmoji = progressChange > 0 ? 'ğŸ˜„' : 'ğŸ˜';

                progressDiv.innerHTML = `
                    <div class="bg-gray-100 rounded-full px-3 py-1 text-sm text-gray-600">
                        ${progressEmoji}${progressText}ï¼ˆ${progressReason}ï¼‰
                    </div>
                `;

                this.elements.chatContainer.appendChild(progressDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } updateProgress(change, reason) {
                this.gameState.progress = Math.max(0, Math.min(this.gameState.progress + change, this.config.objective.max_progress)); this.elements.progressBar.style.width = `${this.gameState.progress}%`;
                this.elements.progressText.textContent = `${this.gameState.progress}/${this.config.objective.max_progress}`;
            }

            updateProgressToValue(newProgress, reason) {
                this.gameState.progress = Math.max(0, Math.min(newProgress, this.config.objective.max_progress)); this.elements.progressBar.style.width = `${this.gameState.progress}%`;
                this.elements.progressText.textContent = `${this.gameState.progress}/${this.config.objective.max_progress}`;
            }

            addInnerThought(thought) {
                if (!thought || thought.trim() === '') return;

                const thoughtDiv = document.createElement('div');
                thoughtDiv.className = 'mb-1 p-2 bg-blue-50 rounded text-blue-700 text-base border-l-2 border-blue-300';
                thoughtDiv.textContent = thought;

                this.elements.innerThoughts.appendChild(thoughtDiv);

                // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°çš„å†…å¿ƒæƒ³æ³•
                this.elements.innerThoughts.scrollTop = this.elements.innerThoughts.scrollHeight;

                // é™åˆ¶æ˜¾ç¤ºçš„å†…å¿ƒæƒ³æ³•æ•°é‡ï¼Œé¿å…è¿‡å¤šå ç”¨ç©ºé—´
                const maxThoughts = 5;
                const thoughts = this.elements.innerThoughts.children;
                while (thoughts.length > maxThoughts) {
                    this.elements.innerThoughts.removeChild(thoughts[0]);
                }
            }

            updateLLMStatus(status) {
                this.elements.llmStatus.textContent = status;
                setTimeout(() => {
                    this.elements.llmStatus.textContent = '';
                }, 3000);
            }

            handleObjectiveAchieved() {
                this.gameState.isObjectiveAchieved = true;

                setTimeout(() => {
                    const congratsDiv = document.createElement('div');
                    congratsDiv.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mt-4';

                    // Get messages from config with template replacement
                    const title = this.config.completion_messages?.title || 'ç›®æ ‡å®Œæˆï¼';
                    const description = (this.config.completion_messages?.description || 'ä½ æˆåŠŸå¸®åŠ©${character_name}æ‰¾å›äº†å­¦ä¹ åŠ¨åŠ›ï¼')
                        .replace('${character_name}', this.config.character?.name || 'è§’è‰²');
                    const icon = this.config.completion_messages?.icon || 'ğŸ‰';

                    congratsDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${icon}</span>
                            <div>
                                <strong>${title}</strong><br>
                                <span class="text-sm">${description}</span>
                            </div>
                        </div>
                    `;
                    this.elements.chatContainer.appendChild(congratsDiv);
                    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                }, 1000);
            }
        }

        // åˆ›å»ºæ¸¸æˆå®ä¾‹å¹¶ä¿å­˜ä¸ºå…¨å±€å˜é‡
        const game = new LLMCharacterGame();

    </script>
</body>

</html>