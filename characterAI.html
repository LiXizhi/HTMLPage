<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色AI对话游戏</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js"></script>
    <style>
        .chat-bubble-left {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px 18px 18px 4px;
        }

        .chat-bubble-right {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 18px 18px 4px 18px;
        }

        .action-text {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .typing-indicator {
            animation: typing 1.5s infinite;
        }

        @keyframes typing {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .config-panel {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* 流式消息样式 */
        .streaming-message .chat-bubble-left {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: streaming-pulse 1.5s ease-in-out infinite;
        }

        .streaming-cursor {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            animation: cursor-blink 1s infinite;
        }

        @keyframes streaming-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
        }

        @keyframes cursor-blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* 语音播放按钮样式 */
        .audio-btn {
            background: rgba(86, 60, 233, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
            align-self: flex-end;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            background: rgba(58, 141, 236, 0.8);
            transform: scale(1.1);
        }

        .audio-btn.playing {
            background: rgba(0, 255, 0, 0.8);
            animation: audio-pulse 1s infinite;
        }

        @keyframes audio-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-purple-100 to-pink-100 overflow-hidden">

    <div class="flex h-screen"> <!-- 左侧角色信息区域 -->
        <div class="w-1/3 bg-white shadow-lg p-6 overflow-y-auto">
            <!-- 角色信息卡片 -->
            <div class="mb-6">
                <div class="flex items-center space-x-4 mb-6">
                    <div id="character-avatar"
                        class="w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                        小
                    </div>
                    <div class="flex-1">
                        <h2 id="character-info" class="text-2xl font-bold text-gray-800">小明 - 高二学生</h2>
                        <p id="character-description" class="text-gray-600 mt-1">最近沉迷游戏，学习成绩下滑。需要你的帮助重新找回学习动力！</p>
                    </div>
                </div>

                <!-- 目标进度 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span id="objective-title" class="text-sm font-medium text-gray-700">进度</span>
                        <span class="text-sm text-gray-500" id="progress-text">0/100</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full progress-bar"
                            id="progress-bar" style="width: 0%"></div>
                    </div>
                </div> <!-- 角色内心想法 -->
                <div class="mb-6">
                    <span class="text-lg text-gray-700">内心想法：</span>
                    <div id="inner-thoughts" class="mt-2 text-base text-gray-600 max-h-32 overflow-y-auto">
                    </div>
                </div>
            </div>

            <!-- LLM响应状态 -->
            <div id="llm-status" class="text-center text-sm text-gray-500"></div>
        </div>

        <!-- 右侧聊天区域 -->
        <div class="flex-1 flex flex-col bg-white shadow-lg">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                <h3 id="chat-title" class="text-lg font-semibold">与小明对话</h3>
                <p id="chat-description" class="text-sm opacity-90">通过耐心的交流，帮助小明重新找回学习的乐趣</p>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- 对话内容将在这里动态生成 -->
            </div>

            <!-- 输入区域 -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="输入你想说的话..."
                        class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <button id="send-btn"
                        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity font-medium">
                        发送
                    </button>
                </div>

                <!-- 快捷回复 -->
                <div class="mt-3 flex flex-wrap gap-2" id="quick-replies">
                    <!-- 快捷回复按钮将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize SDK
        const sdk = new KeepworkSDK({
            timeout: 30000
        });
        console.log(`Keepwork SDK initialized token: ${sdk.token}`);

        // Initialize AI Chat Session
        let aiChatSession;

        function initializeAIChatSession() {
            if (sdk && sdk.aiChat) {
                aiChatSession = sdk.aiChat.createSession({
                    model: 'keepwork-pro',
                    stream: true
                });
            }
        }

        class LLMCharacterGame {
            constructor() {
                this.config = null;
                this.gameState = {
                    progress: 0,
                    chatHistory: [],
                    isObjectiveAchieved: false
                };                // 音频播放控制
                this.currentAudioController = null; // 当前播放的音频控制器
                this.currentPlayingButton = null;   // 当前播放的按钮
                this.audioCache = new Map();        // 缓存音频URL，key为文本，value为URL

                this.elements = {
                    chatContainer: document.getElementById('chat-container'),
                    userInput: document.getElementById('user-input'),
                    sendBtn: document.getElementById('send-btn'),
                    progressBar: document.getElementById('progress-bar'),
                    progressText: document.getElementById('progress-text'),
                    innerThoughts: document.getElementById('inner-thoughts'),
                    llmStatus: document.getElementById('llm-status')
                };

                this.initEventListeners();
                this.loadDefaultConfig();
                initializeAIChatSession();
            }

            initEventListeners() {
                // 发送消息
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            loadDefaultConfig() {                // 简化配置，只保留角色和游戏设定
                this.config = {
                    character: {
                        name: "小明",
                        age: 17,
                        gender: "male",
                        role: "高二学生",
                        description: "最近沉迷游戏，学习成绩下滑。需要你的帮助重新找回学习动力！"
                    },
                    objective: {
                        title: "学习动力恢复进度",
                        description: "通过耐心的交流，帮助小明重新找回学习的乐趣",
                        max_progress: 100
                    },
                    initial: {
                        message: "哎呀，又要学习了吗... (无精打采地看着书本) 我昨天刚通关了一个超难的副本呢！",
                        progress: 0
                    },
                    quick_replies: [
                        "游戏确实很有趣，但学习也有它的乐趣哦",
                        "你最喜欢哪个科目？",
                        "我们可以制定一个学习计划",
                        "你觉得游戏和学习有什么相似之处？",
                        "你的梦想是什么？"
                    ], system_prompt: `你是小明，一个17岁的高二学生。你最近沉迷游戏，学习成绩下滑，但内心其实渴望改变。
                    
## 角色设定
- 表面：看起来无所谓，经常说游戏比学习有趣
- 内心：对现状焦虑，害怕让父母失望，渴望找到学习乐趣
- 说话风格：年轻人口吻，经常用括号描述动作和神态，如"(无精打采地看着书本)"

## 性格发展规律
- 0-25分：主要抗拒学习，热衷游戏，偶尔流露不安
- 26-50分：开始意识到问题，但不知如何改变
- 51-75分：逐渐接受学习重要性，寻求解决方案
- 76-99分：主动思考学习方法，表现改变意愿
- 100分：彻底转变，制定具体行动计划

## 对话要求
1. 根据当前对话内容和历史发展判断当前应有的进度百分比(0-100)
2. 用括号描述非语言行为，如"(叹气)"、"(眼睛发亮)"
3. 回复要符合17岁学生的语言习惯
4. 对积极正面的引导要有相应的情感反应

## 输出格式
你必须严格按照以下JSON格式输出，不要有任何其他内容：
{
  "message": "你的回复内容，包含括号内的动作描述",
  "progress_percentage": 当前学习动力恢复的绝对进度百分比(0-100的整数),
  "progress_reason": "当前进度百分比的原因说明",
  "inner_thoughts": "你此刻真实的内心想法和感受"
}`,
                    completion_messages: {
                        title: "目标完成！",
                        description: "你成功帮助${character_name}找回了学习动力！",
                        icon: "🎉"
                    }
                };

                this.initializeGame();
            }

            initializeGame() {
                if (!this.config) return;                // 更新UI
                document.getElementById('character-avatar').textContent = this.config.character?.name?.[0] || '角';
                document.getElementById('character-info').textContent =
                    `${this.config.character?.name || '角色'} - ${this.config.character?.role || ''}`;
                document.getElementById('character-description').textContent =
                    this.config.character?.description || '';
                document.getElementById('objective-title').textContent =
                    this.config.objective?.title || '目标进度';
                document.getElementById('chat-title').textContent =
                    `与${this.config.character?.name || '角色'}对话`;
                document.getElementById('chat-description').textContent =
                    this.config.objective?.description || '';                // 重置游戏状态
                this.gameState.progress = this.config.initial?.progress || 0;
                this.gameState.chatHistory = [];
                this.gameState.isObjectiveAchieved = false;

                // 清空聊天区域
                this.elements.chatContainer.innerHTML = '';

                // 添加初始消息
                if (this.config.initial?.message) {
                    this.addMessage(this.config.initial.message, false);
                }

                // 更新快捷回复
                this.updateQuickReplies();                // 更新进度显示
                this.updateProgress(0, '游戏开始');
            }

            updateQuickReplies() {
                const container = document.getElementById('quick-replies');
                container.innerHTML = '';

                if (!this.config.quick_replies) return;

                this.config.quick_replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm transition-colors';
                    button.textContent = reply;
                    button.addEventListener('click', () => {
                        this.elements.userInput.value = reply;
                        this.sendMessage();
                    });
                    container.appendChild(button);
                });
            }

            async sendMessage() {
                const message = this.elements.userInput.value.trim();
                if (!message || this.gameState.isObjectiveAchieved) return;

                // 禁用输入控件
                this.elements.sendBtn.disabled = true;
                this.elements.userInput.disabled = true;

                this.addMessage(message, true);
                this.elements.userInput.value = '';
                this.gameState.chatHistory.push({ role: 'user', content: message });

                this.addTypingIndicator();
                this.updateLLMStatus('正在连接AI...'); try {
                    const response = await this.callLLM(message); if (response) {
                        // 流式消息已经在callLLM中处理了，这里只需要更新游戏状态
                        this.gameState.chatHistory.push({ role: 'assistant', content: response.message });                        // 计算进度变化值
                        const oldProgress = this.gameState.progress;
                        const newProgress = Math.min(100, Math.max(0, response.progress_percentage || 0));
                        const progressChange = newProgress - oldProgress;                        // 更新进度到新的绝对值
                        this.updateProgressToValue(newProgress, response.progress_reason);
                        if (response.inner_thoughts) {
                            this.addInnerThought(response.inner_thoughts);
                        }

                        // 在最后一条消息下面添加进度显示
                        this.addProgressIndicator(progressChange, response.progress_reason);

                        if (newProgress >= this.config.objective.max_progress) {
                            this.handleObjectiveAchieved();
                        }
                    }
                } catch (error) {
                    this.removeTypingIndicator();
                    this.updateLLMStatus(`错误: ${error.message}`);
                    this.addMessage('抱歉，我现在有些困扰，可能需要一点时间来整理思绪...', false);
                } finally {
                    // 重新启用输入控件
                    this.elements.sendBtn.disabled = false;
                    this.elements.userInput.disabled = false;
                    this.elements.userInput.focus();
                }
            }            // Helper function to extract all response fields using regex
            extractResponseFields(text) {
                const fields = {
                    message: '',
                    progress_percentage: null,
                    progress_reason: '',
                    inner_thoughts: ''
                };

                // Extract message field
                const messageRegex = /"message"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const messageMatch = messageRegex.exec(text);
                if (messageMatch) {
                    fields.message = messageMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                // Extract progress_percentage field
                const progressPercentageRegex = /"progress_percentage"\s*:\s*(\d+)/;
                const progressPercentageMatch = progressPercentageRegex.exec(text);
                if (progressPercentageMatch) {
                    fields.progress_percentage = parseInt(progressPercentageMatch[1]);
                }

                // Extract progress_reason field
                const progressReasonRegex = /"progress_reason"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const progressReasonMatch = progressReasonRegex.exec(text);
                if (progressReasonMatch) {
                    fields.progress_reason = progressReasonMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                // Extract inner_thoughts field
                const thoughtsRegex = /"inner_thoughts"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/;
                const thoughtsMatch = thoughtsRegex.exec(text);
                if (thoughtsMatch) {
                    fields.inner_thoughts = thoughtsMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\\\/g, '\\');
                }

                return fields;
            } updateStreamingStatus(fields) {
                // 只在流式传输过程中临时更新内心想法区域的状态
                if (fields.inner_thoughts) {
                    // 可以在这里添加临时的流式显示效果，如果需要的话
                }
            } async callLLM(userMessage) {
                if (!aiChatSession) {
                    throw new Error('AI聊天会话未初始化');
                }

                // 使用原始的系统提示词，不包含当前进度
                const systemPrompt = this.config.system_prompt;

                // 先添加系统提示词到会话中（如果还没有的话）
                if (aiChatSession.messages.length === 0) {
                    aiChatSession.messages.push({ role: 'system', content: systemPrompt });
                }
                try {
                    let streamingMessageDiv = null;
                    let accumulatedText = '';
                    let jsonResponse = null;

                    const finalText = await aiChatSession.send(userMessage, {
                        onMessage: (text) => {
                            accumulatedText = text;
                            this.updateLLMStatus('接收响应中...');

                            // 使用helper函数提取所有字段
                            const fields = this.extractResponseFields(text);

                            // 尝试解析完整JSON
                            try {
                                jsonResponse = JSON.parse(text);
                            } catch (e) {
                                // JSON可能不完整，继续等待
                            }

                            // 移除打字指示器（如果还在）
                            if (!streamingMessageDiv) {
                                this.removeTypingIndicator();
                                // 创建流式消息容器
                                streamingMessageDiv = this.addStreamingMessage();
                            }

                            // 更新流式消息内容，只显示message部分
                            if (fields.message) {
                                this.updateStreamingMessage(streamingMessageDiv, fields.message);
                            }

                            // 更新流式状态显示
                            this.updateStreamingStatus(fields);
                        }, onComplete: (finalText) => {
                            this.updateLLMStatus('响应完成');

                            // 确保使用最终文本解析JSON
                            if (!jsonResponse) {
                                try {
                                    jsonResponse = JSON.parse(finalText);
                                } catch (e) {
                                    const fields = this.extractResponseFields(finalText);
                                    jsonResponse = {
                                        message: fields.message || finalText,
                                        progress_percentage: fields.progress_percentage !== null ? fields.progress_percentage : 0,
                                        progress_reason: fields.progress_reason || '积极交流',
                                        inner_thoughts: fields.inner_thoughts || '正在思考'
                                    };
                                }
                            }

                            if (streamingMessageDiv) {
                                // 完成流式显示，转换为普通消息
                                this.finalizeStreamingMessage(streamingMessageDiv);
                            }
                        }, onError: (error) => {
                            if (streamingMessageDiv) {
                                this.removeStreamingMessage(streamingMessageDiv);
                            }
                            throw error;
                        }
                    });

                    // 返回解析后的响应
                    return jsonResponse;
                } catch (error) {
                    throw error;
                }
            } addMessage(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-2 ${isUser ? 'justify-end' : ''}`;

                const processedMessage = this.processMessage(message);

                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="chat-bubble-right text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                        <div class="w-8 h-8 bg-gradient-to-r from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">你</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || '角'}</div>
                        <div class="chat-bubble-left text-white p-3 max-w-xs">
                            <p>${processedMessage}</p>
                        </div>
                        <button class="audio-btn" title="播放语音" onclick="game.playMessageAudio('${this.escapeForAttribute(message)}', this)">
                            🔊
                        </button>
                    `;
                }

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } processMessage(message) {
                return message.replace(/\(([^)]+)\)/g, '<span class="action-text">($1)</span>');
            }

            // 转义字符串用于HTML属性
            escapeForAttribute(str) {
                return str.replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/\\/g, '\\\\');
            }

            // 移除括号内容用于语音播放
            removeBracketsContent(text) {
                // 移除中文括号和英文括号中的内容
                return text.replace(/\([^)]*\)/g, '').replace(/（[^）]*）/g, '').trim();
            }            // 播放消息语音
            async playMessageAudio(messageText, buttonElement) {
                try {
                    // 如果没有传入按钮元素，通过文本内容查找
                    let currentButton = buttonElement;
                    if (!currentButton) {
                        const audioButtons = document.querySelectorAll('.audio-btn');
                        audioButtons.forEach(btn => {
                            const bubble = btn.closest('.chat-bubble-left');
                            if (bubble) {
                                const content = bubble.querySelector('p') || bubble.querySelector('.streaming-content');
                                if (content && content.textContent.includes(messageText.substring(0, 20))) {
                                    currentButton = btn;
                                }
                            }
                        });
                    }

                    // 如果当前有音频正在播放
                    if (this.currentPlayingButton) {
                        // 如果点击的是同一个按钮，则停止播放
                        if (currentButton === this.currentPlayingButton) {
                            this.stopCurrentAudio();
                            return;
                        } else {
                            // 停止当前播放，开始新的播放
                            this.stopCurrentAudio();
                        }
                    }

                    // 过滤掉括号中的内容
                    const textToRead = this.removeBracketsContent(messageText);

                    if (!textToRead.trim()) {
                        console.log('没有可播放的文本内容');
                        return;
                    }

                    if (!currentButton) {
                        console.log('找不到对应的音频按钮');
                        return;
                    }

                    // 设置播放状态
                    currentButton.classList.add('playing');
                    currentButton.innerHTML = '⏸️';
                    currentButton.title = '停止语音';

                    // 保存当前播放信息
                    this.currentPlayingButton = currentButton;                    // 使用SDK播放语音
                    try {
                        let audio_url;

                        // 检查缓存中是否已有该文本的音频URL
                        if (this.audioCache.has(textToRead)) {
                            audio_url = this.audioCache.get(textToRead);
                            console.log('使用缓存的音频URL');
                        } else {
                            // 从SDK获取新的音频URL
                            const result = await sdk.speech.textToAudio(textToRead, {
                                gender: this.config.character?.gender,
                                age: this.config.character?.age
                            });

                            if (result && result.data) {
                                audio_url = result.data;
                                // 缓存音频URL
                                this.audioCache.set(textToRead, audio_url);
                                console.log('缓存新的音频URL');
                            } else {
                                throw new Error('无法获取音频URL');
                            }
                        }

                        if (audio_url) {
                            // 创建音频元素
                            const audio = new Audio(audio_url);

                            // 确保音频不循环播放
                            audio.loop = false;

                            // 保存音频控制器引用
                            this.currentAudioController = audio;

                            // 音频播放完成事件
                            audio.addEventListener('ended', () => {
                                console.log('音频播放完成');
                                this.stopCurrentAudio();
                            });

                            // 音频出错事件
                            audio.addEventListener('error', (e) => {
                                console.error('音频播放出错:', e);
                                this.stopCurrentAudio();
                            });

                            // 音频加载完成后开始播放
                            audio.addEventListener('canplay', () => {
                                // 确保当前按钮仍然是正确的按钮（防止快速点击导致的状态混乱）
                                if (this.currentPlayingButton === currentButton && this.currentAudioController === audio) {
                                    audio.play().catch(error => {
                                        console.error('音频播放失败:', error);
                                        this.stopCurrentAudio();
                                    });
                                }
                            });

                            // 加载音频
                            audio.load();
                        }
                    } catch (audioError) {
                        console.error('语音播放出错:', audioError);
                        this.stopCurrentAudio();
                    }

                } catch (error) {
                    console.error('语音播放失败:', error);
                    this.stopCurrentAudio();
                }
            }            // 停止当前音频播放
            stopCurrentAudio() {
                // 停止并清理音频
                if (this.currentAudioController) {
                    this.currentAudioController.pause();
                    this.currentAudioController.currentTime = 0;
                    this.currentAudioController = null;
                }

                // 重置按钮状态
                if (this.currentPlayingButton) {
                    this.currentPlayingButton.classList.remove('playing');
                    this.currentPlayingButton.innerHTML = '🔊';
                    this.currentPlayingButton.title = '播放语音';
                    this.currentPlayingButton = null;
                }
            }

            addStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-2 streaming-message';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || '角'}</div>
                    <div class="chat-bubble-left text-white p-3 max-w-xs">
                        <p class="streaming-content"></p>
                        <span class="streaming-cursor">▋</span>
                    </div>
                `;
                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                return messageDiv;
            }

            updateStreamingMessage(messageDiv, text) {
                const contentElement = messageDiv.querySelector('.streaming-content');
                if (contentElement) {
                    contentElement.innerHTML = this.processMessage(text);
                    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                }
            } finalizeStreamingMessage(messageDiv) {
                const cursor = messageDiv.querySelector('.streaming-cursor');
                if (cursor) {
                    cursor.remove();
                }
                messageDiv.classList.remove('streaming-message');

                // 为完成的流式消息添加语音播放按钮
                const contentElement = messageDiv.querySelector('.streaming-content');
                if (contentElement) {
                    const messageText = contentElement.textContent || contentElement.innerText;
                    const audioBtn = document.createElement('button');
                    audioBtn.className = 'audio-btn';
                    audioBtn.title = '播放语音';
                    audioBtn.innerHTML = '🔊';
                    audioBtn.onclick = () => this.playMessageAudio(messageText, audioBtn);
                    messageDiv.appendChild(audioBtn);
                }
            }

            removeStreamingMessage(messageDiv) {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            } addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'flex items-start space-x-2';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${this.config.character?.name?.[0] || '角'}</div>
                    <div class="chat-bubble-left text-white p-3 max-w-xs typing-indicator">
                        <p>正在思考...</p>
                    </div>
                `;
                this.elements.chatContainer.appendChild(typingDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            addProgressIndicator(progressChange, progressReason) {
                if (!progressChange || progressChange === 0) return;

                const progressDiv = document.createElement('div');
                progressDiv.className = 'flex justify-center my-2';

                const progressText = progressChange > 0 ? `+${progressChange}` : `${progressChange}`;
                const progressEmoji = progressChange > 0 ? '😄' : '😞';

                progressDiv.innerHTML = `
                    <div class="bg-gray-100 rounded-full px-3 py-1 text-sm text-gray-600">
                        ${progressEmoji}${progressText}（${progressReason}）
                    </div>
                `;

                this.elements.chatContainer.appendChild(progressDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            } updateProgress(change, reason) {
                this.gameState.progress = Math.max(0, Math.min(this.gameState.progress + change, this.config.objective.max_progress)); this.elements.progressBar.style.width = `${this.gameState.progress}%`;
                this.elements.progressText.textContent = `${this.gameState.progress}/${this.config.objective.max_progress}`;
            }

            updateProgressToValue(newProgress, reason) {
                this.gameState.progress = Math.max(0, Math.min(newProgress, this.config.objective.max_progress)); this.elements.progressBar.style.width = `${this.gameState.progress}%`;
                this.elements.progressText.textContent = `${this.gameState.progress}/${this.config.objective.max_progress}`;
            }

            addInnerThought(thought) {
                if (!thought || thought.trim() === '') return;

                const thoughtDiv = document.createElement('div');
                thoughtDiv.className = 'mb-1 p-2 bg-blue-50 rounded text-blue-700 text-base border-l-2 border-blue-300';
                thoughtDiv.textContent = thought;

                this.elements.innerThoughts.appendChild(thoughtDiv);

                // 自动滚动到最新的内心想法
                this.elements.innerThoughts.scrollTop = this.elements.innerThoughts.scrollHeight;

                // 限制显示的内心想法数量，避免过多占用空间
                const maxThoughts = 5;
                const thoughts = this.elements.innerThoughts.children;
                while (thoughts.length > maxThoughts) {
                    this.elements.innerThoughts.removeChild(thoughts[0]);
                }
            }

            updateLLMStatus(status) {
                this.elements.llmStatus.textContent = status;
                setTimeout(() => {
                    this.elements.llmStatus.textContent = '';
                }, 3000);
            }

            handleObjectiveAchieved() {
                this.gameState.isObjectiveAchieved = true;

                setTimeout(() => {
                    const congratsDiv = document.createElement('div');
                    congratsDiv.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mt-4';

                    // Get messages from config with template replacement
                    const title = this.config.completion_messages?.title || '目标完成！';
                    const description = (this.config.completion_messages?.description || '你成功帮助${character_name}找回了学习动力！')
                        .replace('${character_name}', this.config.character?.name || '角色');
                    const icon = this.config.completion_messages?.icon || '🎉';

                    congratsDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${icon}</span>
                            <div>
                                <strong>${title}</strong><br>
                                <span class="text-sm">${description}</span>
                            </div>
                        </div>
                    `;
                    this.elements.chatContainer.appendChild(congratsDiv);
                    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                }, 1000);
            }
        }

        // 创建游戏实例并保存为全局变量
        const game = new LLMCharacterGame();

    </script>
</body>

</html>