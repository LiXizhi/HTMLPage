
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>抱抱龙的精神之海</title>
        <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
        <style>
            .cosmic-bg {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f0f23 50%, #1a1a2e 75%, #16213e 100%);
                position: relative;
                overflow: hidden;
            }
            
            .cosmic-bg::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                            radial-gradient(circle at 40% 80%, rgba(119, 198, 255, 0.3) 0%, transparent 50%);
                pointer-events: none;
            }
            
            .star {
                position: absolute;
                background: white;
                border-radius: 50%;
                animation: twinkle 2s infinite;
            }
            
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 1; }
            }
            
            /* 抱抱龙动画 */
            .dragon-float {
                animation: float 3s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
            }
            
            /* 抱抱龙身体 */
            .dragon-body {
                width: 96px;
                height: 96px;
                background: linear-gradient(135deg, #4ade80, #22c55e);
                border-radius: 50%;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
            }
            
            /* 眼睛 */
            .dragon-eye {
                width: 56px;
                height: 56px;
                background: white;
                border-radius: 50%;
                position: relative;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .dragon-pupil {
                width: 36px;
                height: 36px;
                background: #1f2937;
                border-radius: 50%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            
            .dragon-highlight {
                width: 12px;
                height: 12px;
                background: white;
                border-radius: 50%;
                position: absolute;
                top: 6px;
                left: 6px;
            }
            
            /* 眨眼动画 */
            .dragon-eye.blink {
                animation: blink 0.15s ease-in-out;
            }
            
            @keyframes blink {
                0%, 100% { height: 56px; }
                50% { height: 6px; }
            }
            
            /* 嘴巴 */
            .dragon-mouth {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 8px;
                border: 2px solid #6b7280;
                border-top: none;
                border-radius: 0 0 20px 20px;
                background: transparent;
            }
            
            /* 说话动画 */
            .dragon-body.speaking {
                animation: speaking 0.6s ease-in-out infinite;
            }
            
            @keyframes speaking {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            
            .chat-bubble {
                animation: slideIn 0.3s ease-out;
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .voice-pulse {
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            /* 打字动画 */
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .typing-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #9ca3af;
                animation: typing 1.4s infinite;
            }
            
            .typing-dot:nth-child(1) { animation-delay: 0.2s; }
            .typing-dot:nth-child(2) { animation-delay: 0.4s; }
            .typing-dot:nth-child(3) { animation-delay: 0.6s; }
            
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-10px); }
            }
            
            /* 隐藏滚动条 */
            #chatMessages::-webkit-scrollbar {
                display: none;
            }
            
            .error-message {
                color: #ef4444;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
            }
            
            .success-message {
                color: #22c55e;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
            }
            
            /* 响应式布局 */
            @media (min-width: 768px) {
                .main-container {
                    display: flex;
                    max-width: 1200px;
                    margin: 0 auto;
                    height: 100vh;
                }
                
                .left-panel {
                    width: 300px;
                    padding: 2rem;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    border-right: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .right-panel {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    min-height: 100vh;
                }
                
                .dragon-body {
                    width: 120px;
                    height: 120px;
                }
                
                .dragon-eye {
                    width: 70px;
                    height: 70px;
                }
                
                .dragon-pupil {
                    width: 45px;
                    height: 45px;
                }
                
                .dragon-highlight {
                    width: 15px;
                    height: 15px;
                    top: 8px;
                    left: 8px;
                }
                
                @keyframes blink {
                    0%, 100% { height: 70px; }
                    50% { height: 8px; }
                }
            }
        </style>
    </head>
    <body class="cosmic-bg min-h-screen text-white relative">
        <!-- 星星背景 -->
        <div class="absolute inset-0 pointer-events-none">
            <div class="star w-1 h-1" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 20%; left: 80%; animation-delay: 0.5s;"></div>
            <div class="star w-1 h-1" style="top: 70%; left: 20%; animation-delay: 1s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 80%; left: 90%; animation-delay: 1.5s;"></div>
            <div class="star w-1 h-1" style="top: 30%; left: 70%; animation-delay: 2s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 50%; left: 15%; animation-delay: 2.5s;"></div>
        </div>

        <!-- 配置面板 -->
        <div class="fixed top-4 right-4 z-20">
            <button id="configBtn" class="bg-gray-800 bg-opacity-50 text-white p-2 rounded-lg hover:bg-opacity-70 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </div>

        <!-- 配置弹窗 -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="configModal">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-md mx-4 w-full">
                <h3 class="text-lg font-semibold mb-4 text-center">API 配置</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">API Token:</label>
                        <input type="password" id="apiToken" placeholder="请输入您的API Token" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">API地址:</label>
                        <input type="text" id="apiUrl" value="https://api.keepwork.com/core/v0" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">模型:</label>
                        <select id="modelSelect" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="keepwork-pro">keepwork-pro</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" id="saveConfigBtn">
                            保存
                        </button>
                        <button class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors" id="cancelConfigBtn">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="relative z-10 main-container">
            <!-- 左侧面板 (桌面版) -->
            <div class="left-panel hidden md:flex">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-white mb-2">精神之海</h1>
                    <p class="text-gray-300 mb-8">与你的AI伙伴开始心灵对话</p>
                    
                    <div class="dragon-float inline-block mb-4">
                        <div class="dragon-body" id="dragonBodyDesktop">
                            <div class="dragon-eye" id="dragonEyeDesktop">
                                <div class="dragon-pupil">
                                    <div class="dragon-highlight"></div>
                                </div>
                            </div>
                            <div class="dragon-mouth"></div>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-semibold mb-2">抱抱龙</h2>
                    <p class="text-gray-300" id="dragonStatusDesktop">准备聊天</p>
                </div>
            </div>

            <!-- 右侧面板 / 移动版主面板 -->
            <div class="right-panel md:p-6">
                <!-- 移动版头部 -->
                <div class="md:hidden">
                    <header class="p-4 text-center">
                        <h1 class="text-2xl font-bold text-white">精神之海</h1>
                        <p class="text-sm text-gray-300 mt-1">与你的AI伙伴开始心灵对话</p>
                    </header>

                    <div class="text-center py-4">
                        <div class="dragon-float inline-block mb-4">
                            <div class="dragon-body" id="dragonBodyMobile">
                                <div class="dragon-eye" id="dragonEyeMobile">
                                    <div class="dragon-pupil">
                                        <div class="dragon-highlight"></div>
                                    </div>
                                </div>
                                <div class="dragon-mouth"></div>
                            </div>
                        </div>
                        <h2 class="text-lg font-semibold">抱抱龙</h2>
                        <p class="text-sm text-gray-300" id="dragonStatusMobile">准备聊天</p>
                    </div>
                </div>

                <!-- 聊天区域 -->
                <div class="flex-1 flex flex-col">
                    <!-- 聊天消息区域 -->
                    <div class="flex-1 px-4 pb-4">
                    <div class="space-y-4 h-[calc(100vh-250px)] md:h-[calc(100vh-200px)] overflow-y-auto scroll-smooth scrollbar-hide" id="chatMessages">
                            <div class="chat-bubble">
                                <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                                    <p class="text-sm">你好，主人！今天感觉怎么样？</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 输入区域 -->
                    <div class="p-4 border-t border-gray-600 border-opacity-30">
                        <div class="flex items-center space-x-2">
                            <button class="voice-pulse w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-700 transition-colors" id="voiceBtn">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                </svg>
                            </button>
                            <input type="text" placeholder="输入你的想法..." class="flex-1 bg-gray-800 bg-opacity-50 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" id="messageInput">
                            <button class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-700 transition-colors" id="sendBtn">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                        <div class="error-message" id="errorMessage"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 语音识别状态 -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="voiceModal">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-sm mx-4 text-center">
                <div class="voice-pulse w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold mb-2">正在聆听...</h3>
                <p class="text-sm text-gray-300 mb-4">说出你的想法吧</p>
                <button class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors" id="stopVoiceBtn">
                    停止录音
                </button>
            </div>
        </div>

        <script>
            class HugDragonChat {
                constructor() {
                    this.messages = [
                        { role: 'system', content: '你是抱抱龙' }
                    ];
                    this.isExecuting = false;
                    this.abortController = null;
                    
                    // 配置
                    this.config = {
                        apiUrl: 'https://api.keepwork.com/core/v0',
                        token: this.getTokenFromUrl(),
                        model: 'keepwork-pro',
                        temperature: 0.7,
                        siteUsername: 'demo'
                    };
                    
                    this.initializeElements();
                    this.bindEvents();
                    this.loadSettings();
                    this.startBlinking();
                    this.updateDragonStatus();
                }

                getTokenFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('token');
                }

                initializeElements() {
                    // 聊天相关
                    this.messageInput = document.getElementById('messageInput');
                    this.sendBtn = document.getElementById('sendBtn');
                    this.voiceBtn = document.getElementById('voiceBtn');
                    this.chatMessages = document.getElementById('chatMessages');
                    this.errorMessage = document.getElementById('errorMessage');
                    
                    // 抱抱龙相关
                    this.dragonBodyMobile = document.getElementById('dragonBodyMobile');
                    this.dragonEyeMobile = document.getElementById('dragonEyeMobile');
                    this.dragonStatusMobile = document.getElementById('dragonStatusMobile');
                    this.dragonBodyDesktop = document.getElementById('dragonBodyDesktop');
                    this.dragonEyeDesktop = document.getElementById('dragonEyeDesktop');
                    this.dragonStatusDesktop = document.getElementById('dragonStatusDesktop');
                    
                    // 语音相关
                    this.voiceModal = document.getElementById('voiceModal');
                    this.stopVoiceBtn = document.getElementById('stopVoiceBtn');
                    
                    // 配置相关
                    this.configBtn = document.getElementById('configBtn');
                    this.configModal = document.getElementById('configModal');
                    this.apiUrlInput = document.getElementById('apiUrl');
                    this.apiTokenInput = document.getElementById('apiToken');
                    this.modelSelect = document.getElementById('modelSelect');
                    this.saveConfigBtn = document.getElementById('saveConfigBtn');
                    this.cancelConfigBtn = document.getElementById('cancelConfigBtn');
                }

                bindEvents() {
                    // 聊天事件
                    this.sendBtn.addEventListener('click', () => this.sendMessage());
                    this.messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                    
                    // 语音事件
                    this.voiceBtn.addEventListener('click', () => this.startVoiceRecording());
                    this.stopVoiceBtn.addEventListener('click', () => this.voiceModal.classList.add('hidden'));
                    
                    // 配置事件
                    this.configBtn.addEventListener('click', () => this.showConfigModal());
                    this.saveConfigBtn.addEventListener('click', () => this.saveSettings());
                    this.cancelConfigBtn.addEventListener('click', () => this.hideConfigModal());
                    
                    // 点击模态框外部关闭
                    this.configModal.addEventListener('click', (e) => {
                        if (e.target === this.configModal) {
                            this.hideConfigModal();
                        }
                    });
                }

                showConfigModal() {
                    this.updateConfigUI();
                    this.configModal.classList.remove('hidden');
                }

                hideConfigModal() {
                    this.configModal.classList.add('hidden');
                }

                updateConfigUI() {
                    this.apiUrlInput.value = this.config.apiUrl;
                    this.apiTokenInput.value = this.config.token || '';
                    this.modelSelect.value = this.config.model;
                }

                loadSettings() {
                    const saved = localStorage.getItem('hugdragon_settings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.config = { ...this.config, ...settings };
                    }
                }

                saveSettings() {
                    this.config.apiUrl = this.apiUrlInput.value;
                    this.config.token = this.apiTokenInput.value;
                    this.config.model = this.modelSelect.value;
                    
                    localStorage.setItem('hugdragon_settings', JSON.stringify(this.config));
                    this.updateDragonStatus();
                    this.showError('设置已保存', 'success');
                    this.hideConfigModal();
                }

                updateDragonStatus() {
                    const status = this.config.token ? '在线 · 准备聊天' : '匿名模式 · 准备聊天';
                    // 移除token验证，允许匿名访问
                    const isReady = true;
                    
                    if (this.dragonStatusMobile) {
                        this.dragonStatusMobile.textContent = status;
                    }
                    if (this.dragonStatusDesktop) {
                        this.dragonStatusDesktop.textContent = status;
                    }
                    
                    this.sendBtn.disabled = !isReady;
                }

                showError(message, type = 'error') {
                    this.errorMessage.textContent = message;
                    this.errorMessage.className = type === 'error' ? 'error-message' : 'success-message';
                    setTimeout(() => {
                        this.errorMessage.textContent = '';
                    }, 3000);
                }

                // 抱抱龙动画
                blinkEye() {
                    if (this.dragonEyeMobile) {
                        this.dragonEyeMobile.classList.add('blink');
                        setTimeout(() => {
                            this.dragonEyeMobile.classList.remove('blink');
                        }, 150);
                    }
                    if (this.dragonEyeDesktop) {
                        this.dragonEyeDesktop.classList.add('blink');
                        setTimeout(() => {
                            this.dragonEyeDesktop.classList.remove('blink');
                        }, 150);
                    }
                }

                startBlinking() {
                    setInterval(() => {
                        if (Math.random() < 0.3) {
                            this.blinkEye();
                        }
                    }, 2000);
                }

                startSpeaking() {
                    if (this.dragonBodyMobile) {
                        this.dragonBodyMobile.classList.add('speaking');
                    }
                    if (this.dragonBodyDesktop) {
                        this.dragonBodyDesktop.classList.add('speaking');
                    }
                }

                stopSpeaking() {
                    if (this.dragonBodyMobile) {
                        this.dragonBodyMobile.classList.remove('speaking');
                    }
                    if (this.dragonBodyDesktop) {
                        this.dragonBodyDesktop.classList.remove('speaking');
                    }
                }

                // 添加消息到界面
                addUserMessage(message) {
                    const userMsg = document.createElement('div');
                    userMsg.className = 'chat-bubble flex justify-end';
                    userMsg.innerHTML = `
                        <div class="bg-purple-500 bg-opacity-80 rounded-2xl p-3 max-w-xs">
                            <p class="text-sm">${message}</p>
                        </div>
                    `;
                    this.chatMessages.appendChild(userMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }

                addDragonMessage(message) {
                    const dragonMsg = document.createElement('div');
                    dragonMsg.className = 'chat-bubble';
                    dragonMsg.innerHTML = `
                        <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                            <p class="text-sm">${message}</p>
                        </div>
                    `;
                    this.chatMessages.appendChild(dragonMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    return dragonMsg;
                }

                addTypingIndicator() {
                    const typingMsg = document.createElement('div');
                    typingMsg.className = 'chat-bubble';
                    typingMsg.id = 'typing-indicator';
                    typingMsg.innerHTML = `
                        <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    `;
                    this.chatMessages.appendChild(typingMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    return typingMsg;
                }

                removeTypingIndicator() {
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                }

                // 发送消息
                async sendMessage() {
                    const message = this.messageInput.value.trim();
                    if (!message || this.isExecuting) return;

                    this.isExecuting = true;
                    this.sendBtn.disabled = true;
                    this.messageInput.disabled = true;
                    this.messageInput.value = '';

                    // 添加用户消息
                    this.addUserMessage(message);
                    this.messages.push({ role: 'user', content: message });

                    // 添加打字指示器
                    const typingIndicator = this.addTypingIndicator();
                    this.startSpeaking();

                    // 创建取消控制器
                    this.abortController = new AbortController();

                    try {
                        const chatAPIRequest = {
                            messages: this.messages,
                            model: this.config.model,
                            stream: true,
                            siteUsername: this.config.siteUsername,
                            modId: 'hugdragon-mod-id',
                            temperature: this.config.temperature
                        };

                        // 根据是否有token决定请求头
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        
                        if (this.config.token) {
                            headers['Authorization'] = `Bearer ${this.config.token}`;
                        }

                        const response = await fetch(`${this.config.apiUrl}/gpt/chat`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(chatAPIRequest),
                            signal: this.abortController.signal
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                throw new Error('请求过于频繁，请稍后再试');
                            } else if (response.status === 401) {
                                throw new Error('API访问被拒绝，建议配置Token以获得更好的服务');
                            } else {
                                throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                            }
                        }

                        // 移除打字指示器
                        this.removeTypingIndicator();

                        // 添加助手消息容器
                        const assistantMessageDiv = this.addDragonMessage('');
                        const messageContent = assistantMessageDiv.querySelector('.text-sm');

                        let assistantResponse = '';
                        const reader = response.body?.getReader();
                        const decoder = new TextDecoder('utf-8');
                        let buffer = '';

                        if (reader) {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                buffer += decoder.decode(value, { stream: true });
                                const lines = buffer.split('\n');
                                
                                buffer = lines.pop() || '';
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        const jsonData = line.substring(6);
                                        if (jsonData === '[DONE]') {
                                            break;
                                        }
                                        
                                        try {
                                            const data = JSON.parse(jsonData);
                                            if (data.result) {
                                                assistantResponse += data.result;
                                                messageContent.textContent = assistantResponse;
                                                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                                            }
                                        } catch (e) {
                                            console.warn('解析流数据失败:', e);
                                        }
                                    }
                                }
                            }
                        }

                        // 添加完整回复到消息历史
                        this.messages.push({ role: 'assistant', content: assistantResponse });

                    } catch (error) {
                        this.removeTypingIndicator();
                        console.error('错误:', error);
                        this.showError(`错误: ${error.message}`);
                    } finally {
                        this.isExecuting = false;
                        this.sendBtn.disabled = false;
                        this.messageInput.disabled = false;
                        this.messageInput.focus();
                        this.stopSpeaking();
                    }
                }

                // 语音功能（模拟）
                startVoiceRecording() {
                    this.voiceModal.classList.remove('hidden');
                    // 模拟语音识别
                    setTimeout(() => {
                        this.voiceModal.classList.add('hidden');
                        const voiceMessage = "这是通过语音输入的消息";
                        this.messageInput.value = voiceMessage;
                    }, 3000);
                }
            }
            let game_config = null;
            let gameLoaded = false;
            window.addEventListener('message', function (e) {
                switch (e.data.type) {
                    case 'setGameConfig':
                        game_config = e.data.data;
                        
                        try {
                            let configData;
                            let token = "";
                            configData = JSON.parse(game_config);
                            //console.log('游戏配置：', configData);
                            token = configData.token || "";
                            
                            // 自动登录逻辑
                            if(token) {
                                // 获取已存在的HugDragonChat实例或创建新实例
                                const chatApp = window.hugDragonChat || new HugDragonChat();
                                // 保存token到配置
                                chatApp.config.token = token;
                                localStorage.setItem('hugdragon_settings', 
                                    JSON.stringify(chatApp.config));
                                
                                // 更新UI状态
                                chatApp.updateDragonStatus();
                                
                                // 提示登录成功
                                //chatApp.showError('自动登录成功', 'success');
                                // 保存实例引用
                                window.hugDragonChat = chatApp;
                            }
                        } catch (e) {
                            console.error('解析配置失败:', e);
                        }
                        break;
                }
            });
            setTimeout(() => {
                gameLoaded = true;
                window.parent.postMessage({ type: 'gameLoaded',data: { 
                    gameName: 'mindeye'
                } }, '*');
            }, 100);
            // 初始化
            document.addEventListener('DOMContentLoaded', () => {
                new HugDragonChat();
            });
        </script>
    </body>
</html>
