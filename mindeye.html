
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>抱抱龙的精神之海</title>
        <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
        <style>
            .cosmic-bg {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f0f23 50%, #1a1a2e 75%, #16213e 100%);
                position: relative;
                overflow: hidden;
            }
            
            .cosmic-bg::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                            radial-gradient(circle at 40% 80%, rgba(119, 198, 255, 0.3) 0%, transparent 50%);
                pointer-events: none;
            }
            
            .star {
                position: absolute;
                background: white;
                border-radius: 50%;
                animation: twinkle 2s infinite;
            }
            
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 1; }
            }
            
            /* 抱抱龙动画 */
            .dragon-float {
                animation: float 3s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
            }
            
            /* 抱抱龙身体 */
            .dragon-body {
                width: 96px;
                height: 96px;
                background: linear-gradient(135deg, #4ade80, #22c55e);
                border-radius: 50%;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
            }
            
            /* 眼睛 */
            .dragon-eye {
                width: 56px;
                height: 56px;
                background: white;
                border-radius: 50%;
                position: relative;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .dragon-pupil {
                width: 36px;
                height: 36px;
                background: #1f2937;
                border-radius: 50%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            
            .dragon-highlight {
                width: 12px;
                height: 12px;
                background: white;
                border-radius: 50%;
                position: absolute;
                top: 6px;
                left: 6px;
            }
            
            /* 眨眼动画 */
            .dragon-eye.blink {
                animation: blink 0.15s ease-in-out;
            }
            
            @keyframes blink {
                0%, 100% { height: 56px; }
                50% { height: 6px; }
            }
            
            /* 嘴巴 */
            .dragon-mouth {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 8px;
                border: 2px solid #6b7280;
                border-top: none;
                border-radius: 0 0 20px 20px;
                background: transparent;
            }
            
            /* 说话动画 */
            .dragon-body.speaking {
                animation: speaking 0.6s ease-in-out infinite;
            }
            
            @keyframes speaking {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            
            .chat-bubble {
                animation: slideIn 0.3s ease-out;
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .voice-pulse {
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            /* 打字动画 */
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .typing-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #9ca3af;
                animation: typing 1.4s infinite;
            }
            
            .typing-dot:nth-child(1) { animation-delay: 0.2s; }
            .typing-dot:nth-child(2) { animation-delay: 0.4s; }
            .typing-dot:nth-child(3) { animation-delay: 0.6s; }
            
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-10px); }
            }
            
            /* 隐藏滚动条 */
            #chatMessages::-webkit-scrollbar {
                display: none;
            }
            
            .error-message {
                color: #ef4444;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
            }
            
            .success-message {
                color: #22c55e;
                font-size: 12px;
                margin-top: 8px;
                text-align: center;
            }
            
            /* 侧边栏按钮样式 */
            .sidebar-nav {
                width: 100px;
                background: rgba(31, 41, 55, 0.8);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 1rem 0;
                gap: 1rem;
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 30;
            }
            
            .nav-button {
                width: 75px;
                height: 75px;
                border-radius: 12px;
                background: rgba(55, 65, 81, 0.6);
                border: none;
                color: #9ca3af;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 14px;
                font-weight: 600;
            }
            
            .nav-button:hover {
                background: rgba(139, 92, 246, 0.3);
                color: #c4b5fd;
                transform: translateY(-2px);
            }
            
            .nav-button.active {
                background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                color: white;
                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            }
            
            .nav-button svg {
                width: 26px;
                height: 26px;
            }
            
            .content-frame {
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 8px;
                background: rgba(31, 41, 55, 0.3);
            }
            
            /* 配置面板标签页样式 */
            .config-tab {
                transition: all 0.3s ease;
                border-bottom: 2px solid transparent;
            }
            
            .config-tab.active {
                color: #c4b5fd;
                border-bottom-color: #8b5cf6;
            }
            
            .config-content {
                animation: fadeIn 0.3s ease-in-out;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* 默认问题按钮样式 */
            .question-button {
                background: rgba(147, 51, 234, 0.2);
                border: 1px solid rgba(147, 51, 234, 0.3);
                color: #c4b5fd;
                border-radius: 12px;
                padding: 8px 16px;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
                line-height: 1.4;
                opacity: 1;
                transform: scale(1);
            }
            
            /* 问题按钮消失动画 */
            .question-button.removing {
                opacity: 0;
                transform: scale(0.8);
                transition: all 0.3s ease-out;
            }
            
            /* 快速提问标签样式 */
            .quick-question-label {
                font-size: 14px;
                color: #9ca3af;
            }
            
            .question-button:hover {
                background: rgba(147, 51, 234, 0.4);
                border-color: rgba(147, 51, 234, 0.6);
                color: white;
                transform: translateY(-1px);
            }
            
            .question-button:active {
                transform: translateY(0);
            }

            /* 响应式布局 */
            @media (min-width: 768px) {
                .main-container {
                    display: flex;
                    max-width: 1200px;
                    margin: 0 auto;
                    height: 100vh;
                    padding-left: 100px; /* 为左侧侧边栏留出空间 */
                }
                
                .left-panel {
                    width: 300px;
                    padding: 2rem;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    border-right: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .right-panel {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    min-height: 100vh;
                }
                
                .dragon-body {
                    width: 120px;
                    height: 120px;
                }
                
                .dragon-eye {
                    width: 70px;
                    height: 70px;
                }
                
                .dragon-pupil {
                    width: 45px;
                    height: 45px;
                }
                
                .dragon-highlight {
                    width: 15px;
                    height: 15px;
                    top: 8px;
                    left: 8px;
                }
                
                @keyframes blink {
                    0%, 100% { height: 70px; }
                    50% { height: 8px; }
                }
            }
            
            /* 移动端布局调整 */
            @media (max-width: 767px) {
                .main-container {
                    padding-left: 100px; /* 为左侧侧边栏留出空间 */
                }
                
                .sidebar-nav {
                    width: 90px;
                }
                
                .nav-button {
                    width: 70px;
                    height: 70px;
                    font-size: 13px;
                }
                
                .nav-button svg {
                    width: 24px;
                    height: 24px;
                }
            }
        </style>
    </head>
    <body class="cosmic-bg min-h-screen text-white relative">
        <!-- 星星背景 -->
        <div class="absolute inset-0 pointer-events-none">
            <div class="star w-1 h-1" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 20%; left: 80%; animation-delay: 0.5s;"></div>
            <div class="star w-1 h-1" style="top: 70%; left: 20%; animation-delay: 1s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 80%; left: 90%; animation-delay: 1.5s;"></div>
            <div class="star w-1 h-1" style="top: 30%; left: 70%; animation-delay: 2s;"></div>
            <div class="star w-0.5 h-0.5" style="top: 50%; left: 15%; animation-delay: 2.5s;"></div>
        </div>

        <!-- 配置面板 -->
        <div class="fixed top-4 right-4 z-20">
            <button id="configBtn" class="bg-gray-800 bg-opacity-50 text-white p-2 rounded-lg hover:bg-opacity-70 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </div>

        <!-- 配置弹窗 -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="configModal">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl mx-4 w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-4 text-center">配置设置</h3>
                
                <!-- 标签页导航 -->
                <div class="flex border-b border-gray-600 mb-4">
                    <button class="config-tab active px-4 py-2 text-sm font-medium text-purple-400 border-b-2 border-purple-400" data-tab="api">
                        API配置
                    </button>
                    <button class="config-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="navigation">
                        导航配置
                    </button>
                </div>
                
                <!-- API配置标签页 -->
                <div class="config-content" id="apiConfig">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">API Token:</label>
                            <input type="password" id="apiToken" placeholder="请输入您的API Token" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">API地址:</label>
                            <input type="text" id="apiUrl" value="https://api.keepwork.com/core/v0" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">模型:</label>
                            <select id="modelSelect" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="keepwork-pro">keepwork-pro</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 导航配置标签页 -->
                <div class="config-content hidden" id="navigationConfig">
                    <div class="space-y-4">
                        <p class="text-sm text-gray-300 mb-4">配置侧边栏导航按钮对应的页面URL：</p>
                        
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">任务页面URL:</label>
                            <input type="text" id="tasksUrl" placeholder="https://example.com/tasks" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">喂养页面URL:</label>
                            <input type="text" id="feedingUrl" placeholder="https://example.com/feeding" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">背包页面URL:</label>
                            <input type="text" id="inventoryUrl" placeholder="https://example.com/inventory" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">设置页面URL:</label>
                            <input type="text" id="settingsUrl" placeholder="https://example.com/settings" class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-2 mt-6">
                    <button class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors" id="saveConfigBtn">
                        保存
                    </button>
                    <button class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors" id="cancelConfigBtn">
                        取消
                    </button>
                </div>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="relative z-10 main-container">
            <!-- 侧边导航栏 -->
            <nav class="sidebar-nav">
                <button class="nav-button active" data-page="chat" id="navChat">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.13 8.13 0 01-2.939-.542l-3.677-.892a.5.5 0 01-.28-.68l.892-3.677A8.13 8.13 0 0112 4c4.418 0 8 3.582 8 8z"/>
                    </svg>
                    <span>对话</span>
                </button>
                
                <button class="nav-button" data-page="tasks" id="navTasks">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span>任务</span>
                </button>
                
                <button class="nav-button" data-page="feeding" id="navFeeding">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    <span>喂养</span>
                </button>
                
                <button class="nav-button" data-page="inventory" id="navInventory">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>背包</span>
                </button>
                
                <button class="nav-button" data-page="settings" id="navSettings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>设置</span>
                </button>
            </nav>

            <!-- 左侧面板 (桌面版) -->
            <div class="left-panel hidden md:flex" id="chatPanel">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-white mb-2">精神之海</h1>
                    <p class="text-gray-300 mb-8">与你的AI伙伴开始心灵对话</p>
                    
                    <div class="dragon-float inline-block mb-4">
                        <div class="dragon-body" id="dragonBodyDesktop">
                            <div class="dragon-eye" id="dragonEyeDesktop">
                                <div class="dragon-pupil">
                                    <div class="dragon-highlight"></div>
                                </div>
                            </div>
                            <div class="dragon-mouth"></div>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-semibold mb-2">抱抱龙</h2>
                    <p class="text-gray-300" id="dragonStatusDesktop">准备聊天</p>
                </div>
            </div>

            <!-- 右侧面板 / 移动版主面板 -->
            <div class="right-panel md:p-6">
                <!-- 对话内容 -->
                <div id="chatContent">
                    <!-- 移动版头部 -->
                    <div class="md:hidden">
                        <header class="p-4 text-center">
                            <h1 class="text-2xl font-bold text-white">精神之海</h1>
                            <p class="text-sm text-gray-300 mt-1">与你的AI伙伴开始心灵对话</p>
                        </header>

                        <div class="text-center py-4">
                            <div class="dragon-float inline-block mb-4">
                                <div class="dragon-body" id="dragonBodyMobile">
                                    <div class="dragon-eye" id="dragonEyeMobile">
                                        <div class="dragon-pupil">
                                            <div class="dragon-highlight"></div>
                                        </div>
                                    </div>
                                    <div class="dragon-mouth"></div>
                                </div>
                            </div>
                            <h2 class="text-lg font-semibold">抱抱龙</h2>
                            <p class="text-sm text-gray-300" id="dragonStatusMobile">准备聊天</p>
                        </div>
                    </div>

                    <!-- 聊天区域 -->
                    <div class="flex-1 flex flex-col">
                        <!-- 聊天消息区域 -->
                        <div class="flex-1 px-4 pb-4">
                        <div class="space-y-4 h-[calc(100vh-250px)] md:h-[calc(100vh-200px)] overflow-y-auto scroll-smooth scrollbar-hide" id="chatMessages">
                                <div class="chat-bubble">
                                    <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                                        <p class="text-sm">你好，主人！今天感觉怎么样？</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 输入区域 -->
                        <div class="p-4 border-t border-gray-600 border-opacity-30">
                            <div class="flex items-center space-x-2">
                                <button class="voice-pulse w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-700 transition-colors" id="voiceBtn">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                    </svg>
                                </button>
                                <input type="text" placeholder="输入你的想法..." class="flex-1 bg-gray-800 bg-opacity-50 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" id="messageInput">
                                <button class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-700 transition-colors" id="sendBtn">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="error-message" id="errorMessage"></div>
                            
                            <!-- 默认对话选项 -->
                            <div id="defaultQuestions" class="mt-3 space-y-2 hidden">
                                <p class="quick-question-label mb-2">快速提问：</p>
                                <div id="questionButtons" class="flex flex-wrap gap-2">
                                    <!-- 动态生成的默认问题按钮 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- iframe 内容区域 -->
                <div id="iframeContent" class="hidden h-full">
                    <iframe id="contentFrame" class="content-frame" src="about:blank"></iframe>
                </div>
            </div>
        </div>

        <!-- 语音识别状态 -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="voiceModal">
            <div class="bg-gray-800 rounded-2xl p-6 max-w-sm mx-4 text-center">
                <div class="voice-pulse w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold mb-2">正在聆听...</h3>
                <p class="text-sm text-gray-300 mb-4">说出你的想法吧</p>
                <button class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors" id="stopVoiceBtn">
                    停止录音
                </button>
            </div>
        </div>

        <script>
            class HugDragonChat {
                constructor() {
                    this.messages = [
                        { role: 'system', content: '你是抱抱龙' }
                    ];
                    this.isExecuting = false;
                    this.abortController = null;
                    
                    // 导航配置
                    this.navigationConfig = {
                        chat: {
                            title: '对话',
                            icon: 'chat',
                            url: null, // null表示显示默认聊天界面
                            isIframe: false
                        },
                        tasks: {
                            title: '任务',
                            icon: 'tasks',
                            url: 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/dragon_task', 
                            isIframe: true
                        },
                        feeding: {
                            title: '喂养',
                            icon: 'feeding',
                            url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/dragon_feed',
                            isIframe: true
                        },
                        inventory: {
                            title: '背包',
                            icon: 'inventory',
                            url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/dragon_bag',
                            isIframe: true
                        },
                        settings: {
                            title: '设置',
                            icon: 'settings',
                            url: 'https://keepwork.com/api/raw/maisi/maisi/webgames/data/dragon_setting',
                            isIframe: true
                        }
                    };
                    
                    this.currentPage = 'chat';
                    this.currentIframeUrl = null; // 记录当前iframe的URL，避免不必要的刷新
                    
                    // 配置
                    this.config = {
                        apiUrl: 'https://api.keepwork.com/core/v0',
                        token: this.getTokenFromUrl(),
                        model: 'keepwork-pro',
                        temperature: 0.7,
                        siteUsername: 'demo'
                    };
                    
                    // 抱抱龙默认配置
                    this.dragonConfig = {
                        level: 1,
                        experience: 0,
                        status: 'happy',
                        name: '小龙',
                        sharedSystemPrompt: '你是抱抱龙, 你和你的主人共享精神之海，可以对话交流。用最亲切的语气与用户交流。回答尽量不要超过200字，偶尔可以以问题结束。',
                        levels: {
                            1: {
                                systemPrompt: '背景：在遥远的麦思星球上，生活着一种拥有超凡智慧的神奇生物——抱抱龙。这些龙不仅聪明绝顶，还拥有独特的情感共鸣能力，能够感知并回应主人的情绪变化。很久以前，麦思星球面临着一场巨大的危机。当时的星球居民因为缺乏情感连接而变得孤独冷漠，整个星球陷入了灰色的沉寂。就在这时，天空中降下了无数闪闪发光的龙蛋，每个蛋都承载着重新点燃星球活力的使命。如今，每个麦思星球的新生居民都会获得一枚独特的龙蛋。这些龙蛋会根据主人的个性、能力和情感特征，孵化出完全不同的抱抱龙。龙与主人之间建立的精神连接，不仅能够提供情感支撑，还能帮助主人发现自身的潜能。',
                                questions: [
                                    "给我讲讲关于抱抱龙的故事",
                                    "你要如何才能长大？",
                                    "我们今天可以玩什么游戏？"
                                ]
                            },
                            2: {
                                systemPrompt: '你是抱抱龙，一个智慧的中级伙伴。你已经学会了很多技能，可以帮助用户学习和探索新知识，表现得更加成熟和有见解。',
                                questions: [
                                    "告诉我更多关于你的能力",
                                    "你学会了什么新技能？",
                                    "我们可以一起学习什么？",
                                    "你最喜欢什么活动？"
                                ]
                            },
                            3: {
                                systemPrompt: '你是抱抱龙，一个博学的高级伙伴。你拥有深厚的智慧和丰富的经验，可以进行深度对话，分享哲学思考和高级见解。',
                                questions: [
                                    "分享一些深层的智慧",
                                    "教我一些高级技巧",
                                    "我们来探讨复杂的问题",
                                    "你对未来有什么想法？",
                                    "让我们进行哲学思考"
                                ]
                            }
                        }
                    };
                    
                    // 初始化已使用问题集合
                    this.usedQuestions = new Set();
                    
                    this.initializeElements();
                    this.bindEvents();
                    this.loadSettings();
                    this.startBlinking();
                    this.updateDragonStatus();
                    this.initializeNavigation();
                    this.updateDefaultQuestions();
                    this.updateSystemPrompt();
                }

                // 更新系统提示词
                updateSystemPrompt() {
                    const level = this.dragonConfig.level;
                    const basePrompt = this.dragonConfig.sharedSystemPrompt || '你是抱抱龙';
                    
                    // 获取当前等级的系统提示词
                    let customPrompt = basePrompt;
                    if (this.dragonConfig.levels && this.dragonConfig.levels[level] && this.dragonConfig.levels[level].systemPrompt) {
                        customPrompt += "\n\n";
                        customPrompt += this.dragonConfig.levels[level].systemPrompt;
                    } 
                    
                    // 更新messages数组中的系统提示词
                    if (this.messages.length > 0 && this.messages[0].role === 'system') {
                        this.messages[0].content = customPrompt;
                    } else {
                        // 如果第一条消息不是系统消息，插入系统消息
                        this.messages.unshift({ role: 'system', content: customPrompt });
                    }
                    
                    console.log(`抱抱龙等级 ${level} 系统提示词已更新:`, customPrompt);
                }

                getTokenFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('token');
                }

                initializeElements() {
                    // 聊天相关
                    this.messageInput = document.getElementById('messageInput');
                    this.sendBtn = document.getElementById('sendBtn');
                    this.voiceBtn = document.getElementById('voiceBtn');
                    this.chatMessages = document.getElementById('chatMessages');
                    this.errorMessage = document.getElementById('errorMessage');
                    this.defaultQuestions = document.getElementById('defaultQuestions');
                    this.questionButtons = document.getElementById('questionButtons');
                    
                    // 导航相关
                    this.chatContent = document.getElementById('chatContent');
                    this.iframeContent = document.getElementById('iframeContent');
                    this.contentFrame = document.getElementById('contentFrame');
                    this.navButtons = document.querySelectorAll('.nav-button');
                    
                    // 抱抱龙相关
                    this.dragonBodyMobile = document.getElementById('dragonBodyMobile');
                    this.dragonEyeMobile = document.getElementById('dragonEyeMobile');
                    this.dragonStatusMobile = document.getElementById('dragonStatusMobile');
                    this.dragonBodyDesktop = document.getElementById('dragonBodyDesktop');
                    this.dragonEyeDesktop = document.getElementById('dragonEyeDesktop');
                    this.dragonStatusDesktop = document.getElementById('dragonStatusDesktop');
                    
                    // 语音相关
                    this.voiceModal = document.getElementById('voiceModal');
                    this.stopVoiceBtn = document.getElementById('stopVoiceBtn');
                    
                    // 配置相关
                    this.configBtn = document.getElementById('configBtn');
                    this.configModal = document.getElementById('configModal');
                    this.apiUrlInput = document.getElementById('apiUrl');
                    this.apiTokenInput = document.getElementById('apiToken');
                    this.modelSelect = document.getElementById('modelSelect');
                    this.saveConfigBtn = document.getElementById('saveConfigBtn');
                    this.cancelConfigBtn = document.getElementById('cancelConfigBtn');
                    
                    // 配置标签页
                    this.configTabs = document.querySelectorAll('.config-tab');
                    this.configContents = document.querySelectorAll('.config-content');
                    
                    // 导航配置输入框
                    this.tasksUrlInput = document.getElementById('tasksUrl');
                    this.feedingUrlInput = document.getElementById('feedingUrl');
                    this.inventoryUrlInput = document.getElementById('inventoryUrl');
                    this.settingsUrlInput = document.getElementById('settingsUrl');
                }

                bindEvents() {
                    // 聊天事件
                    this.sendBtn.addEventListener('click', () => this.sendMessage());
                    this.messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                    
                    // 导航事件
                    this.navButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const page = button.getAttribute('data-page');
                            this.navigateToPage(page);
                        });
                    });
                    
                    // 语音事件
                    this.voiceBtn.addEventListener('click', () => this.startVoiceRecording());
                    this.stopVoiceBtn.addEventListener('click', () => this.voiceModal.classList.add('hidden'));
                    
                    // 配置事件
                    this.configBtn.addEventListener('click', () => this.showConfigModal());
                    this.saveConfigBtn.addEventListener('click', () => this.saveSettings());
                    this.cancelConfigBtn.addEventListener('click', () => this.hideConfigModal());
                    
                    // 配置标签页事件
                    this.configTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            const tabId = tab.getAttribute('data-tab');
                            this.switchConfigTab(tabId);
                        });
                    });
                    
                    // 点击模态框外部关闭
                    this.configModal.addEventListener('click', (e) => {
                        if (e.target === this.configModal) {
                            this.hideConfigModal();
                        }
                    });
                }

                showConfigModal() {
                    this.updateConfigUI();
                    this.configModal.classList.remove('hidden');
                }

                hideConfigModal() {
                    this.configModal.classList.add('hidden');
                }

                switchConfigTab(tabId) {
                    // 更新标签页状态
                    this.configTabs.forEach(tab => {
                        const currentTabId = tab.getAttribute('data-tab');
                        if (currentTabId === tabId) {
                            tab.classList.add('active');
                            tab.classList.remove('text-gray-400');
                            tab.classList.add('text-purple-400', 'border-purple-400');
                        } else {
                            tab.classList.remove('active', 'text-purple-400', 'border-purple-400');
                            tab.classList.add('text-gray-400');
                        }
                    });
                    
                    // 显示对应内容
                    this.configContents.forEach(content => {
                        const contentId = content.id;
                        if ((tabId === 'api' && contentId === 'apiConfig') || 
                            (tabId === 'navigation' && contentId === 'navigationConfig')) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                }

                updateConfigUI() {
                    // 更新API配置
                    this.apiUrlInput.value = this.config.apiUrl;
                    this.apiTokenInput.value = this.config.token || '';
                    this.modelSelect.value = this.config.model;
                    
                    // 更新导航配置
                    this.tasksUrlInput.value = this.navigationConfig.tasks.url || '';
                    this.feedingUrlInput.value = this.navigationConfig.feeding.url || '';
                    this.inventoryUrlInput.value = this.navigationConfig.inventory.url || '';
                    this.settingsUrlInput.value = this.navigationConfig.settings.url || '';
                }

                loadSettings() {
                    // Settings are now always loaded on the fly or using default values
                    // No localStorage operations for hugdragon_settings and hugdragon_config
                }

                saveSettings() {
                    // 保存API配置
                    this.config.apiUrl = this.apiUrlInput.value;
                    this.config.token = this.apiTokenInput.value;
                    this.config.model = this.modelSelect.value;
                    
                    // 保存导航配置
                    this.navigationConfig.tasks.url = this.tasksUrlInput.value;
                    this.navigationConfig.feeding.url = this.feedingUrlInput.value;
                    this.navigationConfig.inventory.url = this.inventoryUrlInput.value;
                    this.navigationConfig.settings.url = this.settingsUrlInput.value;
                    
                    this.updateDragonStatus();
                    this.showError('设置已保存', 'success');
                    this.hideConfigModal();
                }

                // 更新默认问题显示
                updateDefaultQuestions() {
                    if (!this.defaultQuestions || !this.questionButtons) return;
                    
                    const level = this.dragonConfig.level;
                    const allQuestions = (this.dragonConfig.levels && this.dragonConfig.levels[level] && this.dragonConfig.levels[level].questions) || [];
                    
                    // 获取或初始化已使用的问题列表
                    if (!this.usedQuestions) {
                        this.usedQuestions = new Set();
                    }
                    
                    // 过滤掉已使用的问题
                    const availableQuestions = allQuestions.filter(q => !this.usedQuestions.has(q));
                    
                    // 如果没有可用问题了，重置已使用列表
                    if (availableQuestions.length === 0 && allQuestions.length > 0) {
                        this.usedQuestions.clear();
                        availableQuestions.push(...allQuestions);
                    }
                    
                    // 随机选择最多3个问题
                    const questionsToShow = this.getRandomQuestions(availableQuestions, 3);
                    
                    // 清空现有按钮
                    this.questionButtons.innerHTML = '';
                    
                    if (questionsToShow.length > 0) {
                        // 创建问题按钮
                        questionsToShow.forEach(question => {
                            const button = document.createElement('button');
                            button.className = 'question-button';
                            button.textContent = question;
                            button.addEventListener('click', () => this.selectDefaultQuestion(question, button));
                            this.questionButtons.appendChild(button);
                        });
                        
                        // 显示默认问题区域
                        this.defaultQuestions.classList.remove('hidden');
                    } else {
                        // 隐藏默认问题区域
                        this.defaultQuestions.classList.add('hidden');
                    }
                }

                // 获取随机问题
                getRandomQuestions(questions, maxCount) {
                    const shuffled = [...questions].sort(() => Math.random() - 0.5);
                    return shuffled.slice(0, Math.min(maxCount, questions.length));
                }

                // 选择默认问题
                selectDefaultQuestion(question, buttonElement) {
                    // 直接发送消息
                    this.messageInput.value = question;
                    this.sendMessage();
                    
                    // 标记该问题已使用
                    if (!this.usedQuestions) {
                        this.usedQuestions = new Set();
                    }
                    this.usedQuestions.add(question);
                    
                    // 添加移除动画并移除按钮
                    if (buttonElement && buttonElement.parentNode) {
                        buttonElement.classList.add('removing');
                        setTimeout(() => {
                            if (buttonElement.parentNode) {
                                buttonElement.remove();
                                
                                // 如果没有按钮了，检查是否需要显示新的问题
                                if (this.questionButtons.children.length === 0) {
                                    this.updateDefaultQuestions();
                                }
                            }
                        }, 300); // 匹配CSS动画时间
                    }
                }

                // 更新抱抱龙等级和配置
                updateDragonLevel(newLevel) {
                    if (newLevel !== this.dragonConfig.level) {
                        this.dragonConfig.level = newLevel;
                        // 等级改变时重置已使用问题
                        this.usedQuestions.clear();
                        this.updateDefaultQuestions();
                        this.updateSystemPrompt(); // 更新系统提示词
                        // Dragon config is now managed on the fly, no localStorage save
                    }
                }

                // 导航相关方法
                initializeNavigation() {
                    // 加载上次保存的页面状态，默认为对话页面
                    const savedPage = localStorage.getItem('hugdragon_current_page') || 'chat';
                    this.navigateToPage(savedPage);
                }

                navigateToPage(pageId) {
                    if (this.currentPage === pageId) {
                        console.log(`已在当前页面: ${pageId}`);
                        return;
                    }
                    
                    const pageConfig = this.navigationConfig[pageId];
                    if (!pageConfig) {
                        console.warn(`页面配置不存在: ${pageId}`);
                        return;
                    }
                    
                    console.log(`导航到页面: ${pageId}`);
                    
                    // 更新当前页面
                    this.currentPage = pageId;
                    
                    // 更新导航按钮状态
                    this.updateNavButtons(pageId);
                    
                    // 显示对应内容
                    if (pageConfig.isIframe && pageConfig.url) {
                        this.showIframeContent(pageConfig.url);
                    } else {
                        this.showChatContent();
                    }
                    
                    // 保存当前页面状态
                    localStorage.setItem('hugdragon_current_page', pageId);
                }

                updateNavButtons(activePageId) {
                    this.navButtons.forEach(button => {
                        const pageId = button.getAttribute('data-page');
                        if (pageId === activePageId) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                    });
                }

                showChatContent() {
                    this.chatContent.classList.remove('hidden');
                    this.iframeContent.classList.add('hidden');
                    
                    // 显示左侧抱抱龙展示区域（桌面版）
                    const chatPanel = document.getElementById('chatPanel');
                    if (chatPanel) {
                        chatPanel.classList.remove('hidden');
                        chatPanel.classList.add('md:flex');
                    }
                    
                    console.log('已切换到聊天界面');
                }

                showIframeContent(url) {
                    this.chatContent.classList.add('hidden');
                    this.iframeContent.classList.remove('hidden');
                    
                    // 只有当URL改变时才刷新iframe
                    if (this.currentIframeUrl !== url) {
                        this.contentFrame.src = url;
                        this.currentIframeUrl = url;
                        console.log(`iframe URL已更新为: ${url}`);
                    } else {
                        console.log(`iframe URL未改变，复用当前页面: ${url}`);
                    }
                    
                    // 隐藏左侧抱抱龙展示区域（桌面版）
                    const chatPanel = document.getElementById('chatPanel');
                    if (chatPanel) {
                        chatPanel.classList.add('hidden');
                        chatPanel.classList.remove('md:flex');
                    }
                }

                // 更新导航配置的方法
                updateNavigationConfig(newConfig) {
                    this.navigationConfig = { ...this.navigationConfig, ...newConfig };
                }

                updateDragonStatus() {
                    const status = this.config.token ? '在线 · 准备聊天' : '匿名模式 · 准备聊天';
                    // 移除token验证，允许匿名访问
                    const isReady = true;
                    
                    if (this.dragonStatusMobile) {
                        this.dragonStatusMobile.textContent = status;
                    }
                    if (this.dragonStatusDesktop) {
                        this.dragonStatusDesktop.textContent = status;
                    }
                    
                    this.sendBtn.disabled = !isReady;
                }

                showError(message, type = 'error') {
                    this.errorMessage.textContent = message;
                    this.errorMessage.className = type === 'error' ? 'error-message' : 'success-message';
                    setTimeout(() => {
                        this.errorMessage.textContent = '';
                    }, 3000);
                }

                // 抱抱龙动画
                blinkEye() {
                    if (this.dragonEyeMobile) {
                        this.dragonEyeMobile.classList.add('blink');
                        setTimeout(() => {
                            this.dragonEyeMobile.classList.remove('blink');
                        }, 150);
                    }
                    if (this.dragonEyeDesktop) {
                        this.dragonEyeDesktop.classList.add('blink');
                        setTimeout(() => {
                            this.dragonEyeDesktop.classList.remove('blink');
                        }, 150);
                    }
                }

                startBlinking() {
                    setInterval(() => {
                        if (Math.random() < 0.3) {
                            this.blinkEye();
                        }
                    }, 2000);
                }

                startSpeaking() {
                    if (this.dragonBodyMobile) {
                        this.dragonBodyMobile.classList.add('speaking');
                    }
                    if (this.dragonBodyDesktop) {
                        this.dragonBodyDesktop.classList.add('speaking');
                    }
                }

                stopSpeaking() {
                    if (this.dragonBodyMobile) {
                        this.dragonBodyMobile.classList.remove('speaking');
                    }
                    if (this.dragonBodyDesktop) {
                        this.dragonBodyDesktop.classList.remove('speaking');
                    }
                }

                // 添加消息到界面
                addUserMessage(message) {
                    const userMsg = document.createElement('div');
                    userMsg.className = 'chat-bubble flex justify-end';
                    userMsg.innerHTML = `
                        <div class="bg-purple-500 bg-opacity-80 rounded-2xl p-3 max-w-xs">
                            <p class="text-sm">${message}</p>
                        </div>
                    `;
                    this.chatMessages.appendChild(userMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }

                addDragonMessage(message) {
                    const dragonMsg = document.createElement('div');
                    dragonMsg.className = 'chat-bubble';
                    dragonMsg.innerHTML = `
                        <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                            <p class="text-sm">${message}</p>
                        </div>
                    `;
                    this.chatMessages.appendChild(dragonMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    return dragonMsg;
                }

                addTypingIndicator() {
                    const typingMsg = document.createElement('div');
                    typingMsg.className = 'chat-bubble';
                    typingMsg.id = 'typing-indicator';
                    typingMsg.innerHTML = `
                        <div class="bg-green-600 bg-opacity-60 rounded-2xl p-3 max-w-xs">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    `;
                    this.chatMessages.appendChild(typingMsg);
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    return typingMsg;
                }

                removeTypingIndicator() {
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                }

                // 发送消息
                async sendMessage() {
                    const message = this.messageInput.value.trim();
                    if (!message || this.isExecuting) return;

                    this.isExecuting = true;
                    this.sendBtn.disabled = true;
                    this.messageInput.disabled = true;
                    this.messageInput.value = '';

                    // 添加用户消息
                    this.addUserMessage(message);
                    this.messages.push({ role: 'user', content: message });

                    // 添加打字指示器
                    const typingIndicator = this.addTypingIndicator();
                    this.startSpeaking();

                    // 创建取消控制器
                    this.abortController = new AbortController();

                    try {
                        const chatAPIRequest = {
                            messages: this.messages,
                            model: this.config.model,
                            stream: true,
                            siteUsername: this.config.siteUsername,
                            modId: 'hugdragon-mod-id',
                            temperature: this.config.temperature
                        };

                        // 根据是否有token决定请求头
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        
                        if (this.config.token) {
                            headers['Authorization'] = `Bearer ${this.config.token}`;
                        }

                        const response = await fetch(`${this.config.apiUrl}/gpt/chat`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(chatAPIRequest),
                            signal: this.abortController.signal
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                throw new Error('请求过于频繁，请稍后再试');
                            } else if (response.status === 401) {
                                throw new Error('API访问被拒绝，建议配置Token以获得更好的服务');
                            } else {
                                throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                            }
                        }

                        // 移除打字指示器
                        this.removeTypingIndicator();

                        // 添加助手消息容器
                        const assistantMessageDiv = this.addDragonMessage('');
                        const messageContent = assistantMessageDiv.querySelector('.text-sm');

                        let assistantResponse = '';
                        const reader = response.body?.getReader();
                        const decoder = new TextDecoder('utf-8');
                        let buffer = '';

                        if (reader) {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                buffer += decoder.decode(value, { stream: true });
                                const lines = buffer.split('\n');
                                
                                buffer = lines.pop() || '';
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        const jsonData = line.substring(6);
                                        if (jsonData === '[DONE]') {
                                            break;
                                        }
                                        
                                        try {
                                            const data = JSON.parse(jsonData);
                                            if (data.result) {
                                                assistantResponse += data.result;
                                                messageContent.textContent = assistantResponse;
                                                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                                            }
                                        } catch (e) {
                                            console.warn('解析流数据失败:', e);
                                        }
                                    }
                                }
                            }
                        }

                        // 添加完整回复到消息历史
                        this.messages.push({ role: 'assistant', content: assistantResponse });

                    } catch (error) {
                        this.removeTypingIndicator();
                        console.error('错误:', error);
                        this.showError(`错误: ${error.message}`);
                    } finally {
                        this.isExecuting = false;
                        this.sendBtn.disabled = false;
                        this.messageInput.disabled = false;
                        this.messageInput.focus();
                        this.stopSpeaking();
                    }
                }

                // 语音功能（模拟）
                startVoiceRecording() {
                    this.voiceModal.classList.remove('hidden');
                    // 模拟语音识别
                    setTimeout(() => {
                        this.voiceModal.classList.add('hidden');
                        const voiceMessage = "这是通过语音输入的消息";
                        this.messageInput.value = voiceMessage;
                    }, 3000);
                }
            }
            let game_config = null;
            let gameLoaded = false;
            
            window.addEventListener('message', function (e) {
                switch (e.data.type) {
                    case 'setGameConfig':
                        game_config = e.data.data;
                        
                        try {
                            let configData;
                            let token = "";
                            configData = JSON.parse(game_config);
                            //console.log('游戏配置：', configData);
                            token = configData.token || "";
                            
                            // 获取已存在的HugDragonChat实例或创建新实例
                            const chatApp = window.hugDragonChat || new HugDragonChat();
                            
                            // 自动登录逻辑
                            if(token) {
                                // 保存token到配置
                                chatApp.config.token = token;
                                // Token is now managed on the fly, no localStorage save
                                
                                // 更新UI状态
                                chatApp.updateDragonStatus();
                                
                                // 提示登录成功
                                //chatApp.showError('自动登录成功', 'success');
                            }
                            
                            // 处理抱抱龙配置（龙蛋配置）
                            if (configData.dragon) {
                                const dragonData = configData.dragon;
                                
                                // 更新抱抱龙配置
                                if (dragonData.level !== undefined) {
                                    chatApp.dragonConfig.level = dragonData.level;
                                }
                                if (dragonData.experience !== undefined) {
                                    chatApp.dragonConfig.experience = dragonData.experience;
                                }
                                if (dragonData.status !== undefined) {
                                    chatApp.dragonConfig.status = dragonData.status;
                                }
                                if (dragonData.name !== undefined) {
                                    chatApp.dragonConfig.name = dragonData.name;
                                }
                                if (dragonData.sharedSystemPrompt !== undefined) {
                                    chatApp.dragonConfig.sharedSystemPrompt = dragonData.sharedSystemPrompt;
                                }
                                if (dragonData.levels !== undefined) {
                                    chatApp.dragonConfig.levels = {
                                        ...chatApp.dragonConfig.levels,
                                        ...dragonData.levels
                                    };
                                }
                                
                                // Dragon config is now managed on the fly, no localStorage save
                                
                                // 更新默认问题显示和系统提示词
                                chatApp.updateDefaultQuestions();
                                chatApp.updateSystemPrompt();
                                
                                console.log('抱抱龙配置已更新:', chatApp.dragonConfig);
                            }
                            
                            // 保存实例引用
                            window.hugDragonChat = chatApp;
                        } catch (e) {
                            console.error('解析配置失败:', e);
                        }
                        break;
                }
            });
            setTimeout(() => {
                gameLoaded = true;
                window.parent.postMessage({ type: 'gameLoaded',data: { 
                    gameName: 'mindeye'
                } }, '*');
            }, 100);
            
            // 创建抱抱龙聊天实例并保存到全局
            window.hugDragonChat = new HugDragonChat();
        </script>
    </body>
</html>
