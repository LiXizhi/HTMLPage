<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>麦思星球 - 注册</title>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?ver=1.0.7"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .register-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 400px;
        position: relative;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .icon {
        width: 60px;
        height: 60px;
        margin: 0 auto 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
      }

      .register-title {
        font-size: 24px;
        color: #333;
        font-weight: 600;
        margin: 0;
      }

      .register-subtitle {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .input-container {
        position: relative;
      }

      .input-field {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-field.error {
        border-color: #e74c3c;
        background-color: #fdf2f2;
      }

      .input-field::placeholder {
        color: #999;
      }

      .captcha-container {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .captcha-input {
        flex: 1;
      }

      .captcha-canvas {
        width: 120px;
        height: 50px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        cursor: pointer;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        color: #333;
        letter-spacing: 2px;
        user-select: none;
      }

      .captcha-canvas:hover {
        border-color: #667eea;
      }

      .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 5px;
        display: none;
      }

      .register-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .register-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .register-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .login-link {
        text-align: center;
        margin-top: 20px;
        color: #666;
        font-size: 14px;
      }

      .login-link a {
        color: #667eea;
        text-decoration: none;
      }

      .login-link a:hover {
        text-decoration: underline;
      }

      .password-strength {
        margin-top: 5px;
        height: 3px;
        background: #e1e5e9;
        border-radius: 2px;
        overflow: hidden;
      }

      .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak {
        background: #e74c3c;
        width: 33%;
      }

      .strength-medium {
        background: #f39c12;
        width: 66%;
      }

      .strength-strong {
        background: #27ae60;
        width: 100%;
      }

      .password-tips {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      /* 响应式设计 */
      @media (max-width: 480px) {
        .register-container {
          padding: 30px 20px;
        }

        .captcha-container {
          flex-direction: column;
          align-items: stretch;
        }

        .captcha-canvas {
          width: 100%;
          height: 45px;
        }
      }

      /* 加载动画 */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 成功提示 */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.error {
        background: #e74c3c;
      }
    </style>
  </head>

  <body>
    <div class="register-container">
      <div class="header">
        <h1 class="register-title">创建您的麦思星球账号</h1>
      </div>

      <form id="registerForm" novalidate>
        <!-- 用户名 -->
        <div class="form-group">
          <div class="input-container">
            <input type="text" id="username" class="input-field" placeholder="请输入用户名" maxlength="20" autocomplete="username" />
            <div id="usernameError" class="error-message"></div>
          </div>
        </div>

        <!-- 密码 -->
        <div class="form-group">
          <div class="input-container">
            <input type="password" id="password" class="input-field" placeholder="请输入密码（不少于6位）" autocomplete="new-password" />
            <div class="password-strength">
              <div id="passwordStrengthBar" class="password-strength-bar"></div>
            </div>
            <div class="password-tips">密码长度不少于6位，建议包含字母和数字</div>
            <div id="passwordError" class="error-message"></div>
          </div>
        </div>

        <!-- 确认密码 -->
        <div class="form-group">
          <div class="input-container">
            <input type="password" id="confirmPassword" class="input-field" placeholder="请再次输入密码" autocomplete="new-password" />
            <div id="confirmPasswordError" class="error-message"></div>
          </div>
        </div>

        <!-- 验证码 -->
        <div class="form-group">
          <div class="input-container">
            <div class="captcha-container">
              <input type="text" id="captcha" class="input-field captcha-input" placeholder="请输入验证码" maxlength="4" autocomplete="off" />
              <div id="captchaCanvas" class="captcha-canvas" title="点击刷新验证码">
                <span id="captchaText">ABCD</span>
              </div>
            </div>
            <div id="captchaError" class="error-message"></div>
          </div>
        </div>

        <!-- 注册按钮 -->
        <button type="submit" id="registerBtn" class="register-btn">注册账号</button>
      </form>

      <!-- 登录链接 -->
      <div class="login-link">已有账号？<a href="javascript:void(0)" onclick="goToLogin()">立即登录</a></div>
    </div>

    <script>
      // 表单元素
      const registerForm = document.getElementById("registerForm");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const captchaInput = document.getElementById("captcha");
      const captchaCanvas = document.getElementById("captchaCanvas");
      const captchaText = document.getElementById("captchaText");
      const registerBtn = document.getElementById("registerBtn");
      const passwordStrengthBar = document.getElementById("passwordStrengthBar");

      // 验证码相关
      let currentCaptcha = "";

      // 生成随机验证码
      function generateCaptcha() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = "";
        for (let i = 0; i < 4; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      // 刷新验证码
      function refreshCaptcha() {
        currentCaptcha = generateCaptcha();
        captchaText.textContent = currentCaptcha;
        // 添加一些随机样式增加难度
        const colors = ["#333", "#666", "#999", "#e74c3c", "#3498db", "#27ae60"];
        captchaText.style.color = colors[Math.floor(Math.random() * colors.length)];
        captchaText.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
      }

      // 初始化验证码
      refreshCaptcha();

      // 点击刷新验证码
      captchaCanvas.addEventListener("click", refreshCaptcha);

      // 用户名验证
      function validateUsername(username) {
        if (!username) {
          return "请输入用户名";
        }
        if (!/^[A-Za-z]/.test(username)) {
          return "用户名必须以字母开头";
        }
        if (username.length < 3) {
          return "用户名不能少于3位";
        }
        if (username.length > 20) {
          return "用户名不能超过20位";
        }
        if (!/^[A-Za-z\d]+$/.test(username)) {
          return "用户名只能包含数字、字母";
        }
        if (/^(P|p)\d+/.test(username)) {
          return "请勿用字母P+数字格式创建账号";
        }
        return null;
      }

      // 密码强度检测
      function checkPasswordStrength(password) {
        if (password.length < 6) return 0;

        let strength = 0;
        // 长度
        if (password.length >= 8) strength++;
        // 包含数字
        if (/\d/.test(password)) strength++;
        // 包含字母
        if (/[a-zA-Z]/.test(password)) strength++;
        // 包含特殊字符
        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) strength++;

        return Math.min(strength, 3);
      }

      // 更新密码强度显示
      function updatePasswordStrength(password) {
        const strength = checkPasswordStrength(password);
        passwordStrengthBar.className = "password-strength-bar";

        if (password.length === 0) {
          passwordStrengthBar.style.width = "0%";
        } else if (strength === 1) {
          passwordStrengthBar.className += " strength-weak";
        } else if (strength === 2) {
          passwordStrengthBar.className += " strength-medium";
        } else {
          passwordStrengthBar.className += " strength-strong";
        }
      }

      // 密码验证
      function validatePassword(password) {
        if (!password) {
          return "请输入密码";
        }
        if (password.length < 6) {
          return "密码不能少于6位";
        }
        if (password.length > 24) {
          return "密码不能超过24位";
        }
        return null;
      }

      // 确认密码验证
      function validateConfirmPassword(password, confirmPassword) {
        if (!confirmPassword) {
          return "请再次输入密码";
        }
        if (password !== confirmPassword) {
          return "两次输入的密码不一致";
        }
        return null;
      }

      // 验证码验证
      function validateCaptcha(captcha) {
        if (!captcha) {
          return "请输入验证码";
        }
        if (captcha.toUpperCase() !== currentCaptcha) {
          return "验证码错误";
        }
        return null;
      }

      // 显示错误信息
      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.add("error");
        error.textContent = message;
        error.style.display = "block";
      }

      // 隐藏错误信息
      function hideError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        input.classList.remove("error");
        error.style.display = "none";
      }

      // 显示消息提示
      function showToast(message, isError = false) {
        // 移除已存在的toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.className = `toast ${isError ? "error" : ""}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // 显示动画
        setTimeout(() => toast.classList.add("show"), 100);

        // 3秒后自动消失
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // 实时验证事件
      usernameInput.addEventListener("input", function () {
        hideError("username", "usernameError");
        const error = validateUsername(this.value.trim());
        if (error && this.value.trim()) {
          showError("username", "usernameError", error);
        }
      });

      passwordInput.addEventListener("input", function () {
        hideError("password", "passwordError");
        updatePasswordStrength(this.value);

        const error = validatePassword(this.value);
        if (error && this.value) {
          showError("password", "passwordError", error);
        }

        // 如果确认密码已输入，重新验证
        if (confirmPasswordInput.value) {
          hideError("confirmPassword", "confirmPasswordError");
          const confirmError = validateConfirmPassword(this.value, confirmPasswordInput.value);
          if (confirmError) {
            showError("confirmPassword", "confirmPasswordError", confirmError);
          }
        }
      });

      confirmPasswordInput.addEventListener("input", function () {
        hideError("confirmPassword", "confirmPasswordError");
        const error = validateConfirmPassword(passwordInput.value, this.value);
        if (error && this.value) {
          showError("confirmPassword", "confirmPasswordError", error);
        }
      });

      captchaInput.addEventListener("input", function () {
        hideError("captcha", "captchaError");
        // 自动转换为大写
        this.value = this.value.toUpperCase();
      });

      // 表单提交
      registerForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const captcha = captchaInput.value.trim();

        // 验证所有字段
        let hasError = false;

        const usernameError = validateUsername(username);
        if (usernameError) {
          showError("username", "usernameError", usernameError);
          hasError = true;
        }

        const passwordError = validatePassword(password);
        if (passwordError) {
          showError("password", "passwordError", passwordError);
          hasError = true;
        }

        const confirmPasswordError = validateConfirmPassword(password, confirmPassword);
        if (confirmPasswordError) {
          showError("confirmPassword", "confirmPasswordError", confirmPasswordError);
          hasError = true;
        }

        const captchaError = validateCaptcha(captcha);
        if (captchaError) {
          showError("captcha", "captchaError", captchaError);
          hasError = true;
        }

        if (hasError) {
          return;
        }

        // 开始注册
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<span class="loading"></span> 注册中...';
        try {
          // 调用注册API
          const result = await registerUser(username, password);

          showToast("注册成功！即将跳转到登录页面...");

          // 2秒后跳转到登录页面
          setTimeout(() => {
            goToLogin(username);
          }, 2000);
        } catch (error) {
          console.error("Form submission error:", error);

          // 使用 registerUser 函数已经处理过的错误消息
          let errorMessage = error.message || "注册失败，请稍后重试";

          // 检查是否为特定的错误代码，需要显示在对应字段下方
          if (error.errorCode === 3) {
            // 用户名已存在，显示在用户名字段下方
            showError("username", "usernameError", errorMessage);
          } else if (error.errorCode === 2 || error.errorCode === 8 || error.errorCode === 99) {
            // 用户名格式或敏感词错误，显示在用户名字段下方
            showError("username", "usernameError", errorMessage);
          } else if (error.errorCode === 4 || error.errorCode === 5) {
            // 验证码相关错误，显示在验证码字段下方
            showError("captcha", "captchaError", errorMessage);
          } else {
            // 其他错误显示在toast中
            showToast(errorMessage, true);
          }

          refreshCaptcha(); // 刷新验证码
        } finally {
          registerBtn.disabled = false;
          registerBtn.textContent = "注册账号";
        }
      }); // Initialize KeepworkSDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });
      async function registerUser(username, password) {
        try {
          // 使用正确的注册端点和参数
          const response = await sdk.post("/users/register", {
            username: username,
            password: password,
            platform: "WEB", // 添加平台信息
            //key: captchaSvg.key, // 添加验证码key
            //captcha: captchaInput.value.trim(), // 添加验证码
            skipLimit: false, // 不跳过限制检查
            channel: 60, // for maisi user
          });
          return response;
        } catch (error) {
          console.error("Registration API error:", error);

          // 增强错误处理
          let errorMessage = "注册失败，请稍后重试";
          let errorData = null;

          // 尝试从多个位置解析错误数据
          if (error.response && error.response.data) {
            errorData = error.response.data;
          } else if (error.message) {
            // 检查错误消息是否包含JSON格式的错误信息
            // 例如: "Request failed after 1 attempts. Last error: HTTP 400: {"code":3,"message":"用户已存在"}"
            const jsonMatch = error.message.match(/HTTP \d+:\s*({.*})/);
            if (jsonMatch) {
              try {
                errorData = JSON.parse(jsonMatch[1]);
              } catch (parseError) {
                console.warn("Failed to parse JSON from error message:", parseError);
              }
            }
          }

          // 如果成功解析到错误数据，根据错误代码提供具体错误信息
          if (errorData && errorData.code !== undefined) {
            console.log("Parsed error data:", errorData);
            switch (errorData.code) {
              case 2:
                errorMessage = "用户名格式不正确，必须以字母开头，包含字母和数字，长度4-40位";
                break;
              case 3:
                errorMessage = "用户名已被占用，请换一个用户名";
                break;
              case 4:
                errorMessage = "验证码已过期，请重新获取";
                break;
              case 5:
                errorMessage = "验证码错误，请检查后重试";
                break;
              case 8:
                errorMessage = "用户名包含敏感词，请更换用户名";
                break;
              case 22:
                errorMessage = "手机号已被绑定";
                break;
              case 25:
                errorMessage = "邮箱已被使用";
                break;
              case 99:
                errorMessage = "不允许使用机构用户名格式";
                break;
              default:
                if (errorData.message) {
                  errorMessage = errorData.message;
                }
                break;
            }
          } else if (errorData && errorData.message) {
            errorMessage = errorData.message;
          }
          const enhancedError = new Error(errorMessage);
          enhancedError.response = error.response;
          enhancedError.errorCode = errorData ? errorData.code : null;
          throw enhancedError;
        }
      } // 跳转到登录页面
      function goToLogin(username) {
        if (window.parent && window.parent !== window) {
          // 通知父窗口关闭注册窗口
          window.parent.postMessage(
            {
              type: "registerSuccess",
              username: username || "",
            },
            "*"
          );
        } else {
          // 直接跳转到登录页面
          window.location.href = "ms_games_login.html";
        }
      }

      // 阻止页面缩放
      document.addEventListener("touchstart", function (e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      });

      // 阻止双击缩放
      let lastTouchEnd = 0;
      document.addEventListener("touchend", function (e) {
        const now = new Date().getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      });
    </script>
  </body>
</html>
