<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>意见反馈中心</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/keepworkSDK.iife.js?v=1.0.3"></script>
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block !important;
      }
      .tab-button {
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }
      .tab-button.active {
        background-color: #3b82f6 !important;
        color: white !important;
        border-bottom-color: #1d4ed8 !important;
      }
      .tab-button:hover:not(.active) {
        background-color: #f3f4f6;
        color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4">
      <!-- Tab Navigation -->
      <div class="bg-white rounded-lg shadow-sm mb-6">        <div class="flex border-b">
          <button id="tab-content" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-600" onclick="showTab('content')">
            <span class="block text-lg mb-1">📢</span>
            内容举报
          </button>
          <button id="tab-bug" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-600" onclick="showTab('bug')">
            <span class="block text-lg mb-1">🐛</span>
            BUG汇报
          </button>
          <button id="tab-feedback" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-600" onclick="showTab('feedback')">
            <span class="block text-lg mb-1">💡</span>
            用户意见
          </button>
          <button id="tab-report-history" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-600" onclick="showTab('report-history')">
            <span class="block text-lg mb-1">📋</span>
            提交历史
          </button>
        </div>
      </div>      <!-- Tab Contents -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <!-- 内容举报 Tab -->
        <div id="content" class="tab-content">
          <form id="content-form" class="space-y-6" onsubmit="submitForm(event, 'content')">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">举报类型 *</label>
              <select name="report-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="">请选择举报类型</option>
                <option value="ai-content">AI生成内容</option>
                <option value="product-content">产品内容</option>
                <option value="online-player">在线玩家</option>
                <option value="inappropriate-content">不当内容</option>
                <option value="spam">垃圾信息</option>
                <option value="copyright">版权侵犯</option>
                <option value="other">其他</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">用户ID（可选）</label>
              <input name="user-id" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入相关用户ID" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">举报内容 *</label>
              <textarea
                name="report-content"
                rows="6"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="请详细描述举报内容，包括具体的违规行为、时间、地点等信息"
                required
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">联系方式（可选）</label>
              <input
                name="contact"
                type="text"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="邮箱或手机号，方便我们联系您"
              />
            </div>

            <button type="submit" class="w-full bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-colors font-medium">提交举报</button>
          </form>
        </div>        <!-- BUG汇报 Tab -->
        <div id="bug" class="tab-content">
          <form id="bug-form" class="space-y-6" onsubmit="submitForm(event, 'bug')">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">BUG类型 *</label>
              <select name="bug-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="">请选择BUG类型</option>
                <option value="functional">功能异常</option>
                <option value="ui">界面显示问题</option>
                <option value="performance">性能问题</option>
                <option value="compatibility">兼容性问题</option>
                <option value="crash">程序崩溃</option>
                <option value="data">数据错误</option>
                <option value="other">其他</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">严重程度 *</label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" name="severity" value="low" class="mr-2" required />
                  <span class="text-green-600">轻微</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="severity" value="medium" class="mr-2" />
                  <span class="text-yellow-600">一般</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="severity" value="high" class="mr-2" />
                  <span class="text-orange-600">严重</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="severity" value="critical" class="mr-2" />
                  <span class="text-red-600">紧急</span>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">设备信息</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input name="os" type="text" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="操作系统 (如: iOS 15.0)" />
                <input name="device" type="text" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="设备型号 (如: iPhone 13)" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">BUG描述 *</label>
              <textarea
                name="bug-description"
                rows="6"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="请详细描述BUG的具体表现、复现步骤、预期结果和实际结果"
                required
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">复现步骤</label>
              <textarea
                name="reproduce-steps"
                rows="4"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="1. 打开应用&#10;2. 点击某个按钮&#10;3. 发生错误&#10;请按步骤详细说明"
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">联系邮箱</label>
              <input name="email" type="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="your@email.com" />
            </div>

            <button type="submit" class="w-full bg-orange-600 text-white py-3 px-6 rounded-lg hover:bg-orange-700 transition-colors font-medium">提交BUG报告</button>
          </form>
        </div>

        <!-- 用户意见 Tab -->
        <div id="feedback" class="tab-content">
          <form id="feedback-form" class="space-y-6" onsubmit="submitForm(event, 'feedback')">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">意见类型 *</label>
              <select name="feedback-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="">请选择意见类型</option>
                <option value="feature-request">功能建议</option>
                <option value="improvement">改进建议</option>
                <option value="complaint">投诉</option>
                <option value="compliment">表扬</option>
                <option value="question">咨询</option>
                <option value="other">其他</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">具体意见 *</label>
              <textarea
                name="feedback-content"
                rows="6"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="请详细描述您的意见或建议，我们会认真考虑您的每一条反馈"
                required
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">使用频率</label>
              <select name="usage-frequency" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">请选择使用频率</option>
                <option value="daily">每天</option>
                <option value="weekly">每周</option>
                <option value="monthly">每月</option>
                <option value="rarely">偶尔</option>
                <option value="first-time">第一次使用</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">联系方式（可选）</label>
              <input
                name="contact-info"
                type="text"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="如需回复，请留下邮箱或手机号"
              />
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium">提交意见</button>
          </form>
        </div>

        <!-- 提交历史 Tab -->
        <div id="report-history" class="tab-content">
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold text-gray-900">提交历史</h3>
              <button onclick="loadReportHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">刷新</button>
            </div>
            <div id="report-history-content" class="space-y-4">
              <div class="text-center text-gray-500 py-8">正在加载历史记录...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
        <div class="flex items-center">
          <span class="text-green-600 mr-2">✅</span>
          <p class="text-green-800">提交成功！我们会尽快处理您的反馈，感谢您的参与！</p>
        </div>
      </div>
    </div>
    <script>
      // Initialize SDK
      const sdk = new KeepworkSDK({
        timeout: 30000,
      });      // 全局变量
      let currentTab = "content"; // Tab切换函数
      function showTab(tabName) {
        console.log("Switching to tab:", tabName);

        // 隐藏所有tab内容
        const allTabs = ["content", "bug", "feedback", "report-history"];
        allTabs.forEach((tab) => {
          const tabElement = document.getElementById(tab);
          const tabButton = document.getElementById("tab-" + tab);

          if (tabElement) {
            tabElement.classList.remove("active");
            tabElement.style.display = "none";
          }
          if (tabButton) {
            tabButton.classList.remove("active");
          }
        });

        // 显示选中的tab
        const activeTab = document.getElementById(tabName);
        const activeButton = document.getElementById("tab-" + tabName);

        if (activeTab) {
          activeTab.classList.add("active");
          activeTab.style.display = "block";
        }
        if (activeButton) {
          activeButton.classList.add("active");
        }

        // 更新当前tab
        currentTab = tabName;

        // 如果切换到历史记录页面，则加载数据
        if (tabName === "report-history") {
          loadReportHistory();
        }

        // 更新URL参数
        const url = new URL(window.location);
        url.searchParams.set("tab", tabName);
        window.history.replaceState({}, "", url);

        console.log("Tab switched successfully to:", tabName);
      }

      // 生成人类可读的提交文本
      function generateReadableText(formData, formType) {
        const now = new Date();
        const timestamp = now.toLocaleString("zh-CN");        let text = "";

        if (formType === "content") {
          const typeMap = {
            "ai-content": "AI生成内容",
            "product-content": "产品内容",
            "online-player": "在线玩家",
            "inappropriate-content": "不当内容",
            spam: "垃圾信息",
            copyright: "版权侵犯",
            other: "其他",
          };

          text =
            `【内容举报】\n` +
            `提交时间: ${timestamp}\n` +
            `举报类型: ${typeMap[formData.get("report-type")] || formData.get("report-type")}\n` +
            `用户ID: ${formData.get("user-id") || "未提供"}\n` +
            `举报内容: ${formData.get("report-content")}\n` +
            `联系方式: ${formData.get("contact") || "未提供"}\n`;
        } else if (formType === "bug") {
          const bugTypeMap = {
            functional: "功能异常",
            ui: "界面显示问题",
            performance: "性能问题",
            compatibility: "兼容性问题",
            crash: "程序崩溃",
            data: "数据错误",
            other: "其他",
          };

          const severityMap = {
            low: "轻微",
            medium: "一般",
            high: "严重",
            critical: "紧急",
          };

          text =
            `【BUG汇报】\n` +
            `提交时间: ${timestamp}\n` +
            `BUG类型: ${bugTypeMap[formData.get("bug-type")] || formData.get("bug-type")}\n` +
            `严重程度: ${severityMap[formData.get("severity")] || formData.get("severity")}\n` +
            `操作系统: ${formData.get("os") || "未提供"}\n` +
            `设备型号: ${formData.get("device") || "未提供"}\n` +
            `BUG描述: ${formData.get("bug-description")}\n` +
            `复现步骤: ${formData.get("reproduce-steps") || "未提供"}\n` +
            `联系邮箱: ${formData.get("email") || "未提供"}\n`;
        } else if (formType === "feedback") {
          const feedbackTypeMap = {
            "feature-request": "功能建议",
            improvement: "改进建议",
            compliment: "表扬",
            complaint: "投诉",
            question: "咨询",
            other: "其他",
          };

          const frequencyMap = {
            daily: "每天",
            weekly: "每周",
            monthly: "每月",
            rarely: "偶尔",
            "first-time": "第一次使用",
          };

          text =
            `【用户意见】\n` +
            `提交时间: ${timestamp}\n` +
            `意见类型: ${feedbackTypeMap[formData.get("feedback-type")] || formData.get("feedback-type")}\n` +
            `具体意见: ${formData.get("feedback-content")}\n` +
            `使用频率: ${frequencyMap[formData.get("usage-frequency")] || formData.get("usage-frequency") || "未提供"}\n` +
            `联系方式: ${formData.get("contact-info") || "未提供"}\n`;
        }

        return text;
      } // 表单提交函数
      async function submitForm(event, formType) {
        event.preventDefault();

        // 收集表单数据
        const formData = new FormData(event.target);

        // 生成人类可读文本
        const readableText = generateReadableText(formData, formType);

        // 在控制台输出
        console.log("=== 提交内容 ===");
        console.log(readableText);

        try {
          // 生成存储键（报告类型 + 日期）
          const now = new Date();
          const dateStr = now.toISOString().split("T")[0].replace(/-/g, ""); // YYYYMMDD格式
          const timeStr = now.toTimeString().split(" ")[0].replace(/:/g, ""); // HHMMSS格式
          const storageKey = `reports.${formType}-${dateStr}`;

          // 保存到SDK personalPageStore
          await sdk.personalPageStore.savePageData("maisi_user_report", storageKey, readableText, true);

          console.log(`报告已保存到: maisi_user_report/${storageKey}`);
          console.log("=== 提交完成 ===");

          // 显示成功消息
          const successMessage = document.getElementById("success-message");
          successMessage.classList.remove("hidden");

          // 滚动到成功消息
          successMessage.scrollIntoView({ behavior: "smooth" });          // 重置表单
          event.target.reset();

          // 根据API文档格式化请求参数
          const feedbackData = {
            source: 0, // 0: keepwork
            objectType: 10, // 10: 消息
            type: 0, // 0: 其它（默认值，可以根据具体需求调整）
            content: {
              formType: formType,
              readableText: readableText,
              timestamp: new Date().toISOString()
            },
            description: readableText.split('\n').slice(0, 2).join(' ') // 使用前两行作为简要说明
          };

          await sdk.post("/feedbacks", feedbackData);

          // 3秒后隐藏成功消息
          setTimeout(() => {
            successMessage.classList.add("hidden");
          }, 3000);
        } catch (error) {
          console.error("保存报告失败:", error);
        }
      } // 加载提交历史
      async function loadReportHistory() {
        const historyContent = document.getElementById("report-history-content");

        try {
          historyContent.innerHTML = '<div class="text-center text-gray-500 py-8">正在加载历史记录...</div>';          // 获取所有保存的报告数据 - 使用loadPageData而不是loadAllPageData
          const allDataRaw = await sdk.personalPageStore.loadPageData("maisi_user_report", "reports");
          console.log("Raw data loaded:", allDataRaw);

          let allData = {};
          if (allDataRaw && typeof allDataRaw === "object") {
            allData = allDataRaw;
          } else {
            // 如果没有数据或格式不正确，尝试构建数据结构
            console.log("No existing data structure found, creating empty structure");
          }

          console.log("Processed data:", allData);
          console.log("Data keys:", Object.keys(allData));

          if (!allData || Object.keys(allData).length === 0) {
            historyContent.innerHTML = '<div class="text-center text-gray-500 py-8">暂无提交记录</div>';
            return;
          }// 生成HTML
          let html = "";
          Object.entries(allData).forEach(([key, content]) => {
            const reportInfo = parseReportKey(key);
            const displayTime = formatDateTime(extractTimeFromKey(key));

            html += `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium px-2 py-1 rounded-full ${getTypeColor(reportInfo.type)}">
                                        ${getTypeLabel(reportInfo.type)}
                                    </span>
                                    <span class="text-sm text-gray-500">${displayTime}</span>
                                </div>
                                <button onclick="deleteReport('${key}')" class="text-red-500 hover:text-red-700 text-sm">
                                    删除
                                </button>
                            </div>
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border">${content}</pre>
                        </div>
                    `;
          });

          historyContent.innerHTML = html;
        } catch (error) {
          console.error("加载历史记录失败:", error);
          historyContent.innerHTML = '<div class="text-center text-red-500 py-8">加载失败，请重试</div>';
        }
      } // 删除报告
      async function deleteReport(key) {
        try {
            // 保存更新后的数据结构
            await sdk.personalPageStore.deletePageData("maisi_user_report", `reports.${key}`, true);

            console.log(`已删除报告: ${key}`);
            loadReportHistory(); // 重新加载列表
          
        } catch (error) {
          console.error("删除报告失败:", error);
        }
      }      // 辅助函数：从存储键中提取时间戳
      function extractTimeFromKey(key) {
        console.log("Extracting time from key:", key);
        
        // Remove "reports." prefix if it exists
        const cleanKey = key.startsWith("reports.") ? key.substring(8) : key;
        console.log("Clean key:", cleanKey);
        
        const parts = cleanKey.split("-");
        console.log("Key parts:", parts);
        
        if (parts.length >= 2) {
          const dateStr = parts[1]; // YYYYMMDD
          console.log("Date string:", dateStr);
          
          if (dateStr && dateStr.length >= 8) {
            const year = parseInt(dateStr.substring(0, 4));
            const month = parseInt(dateStr.substring(4, 6)) - 1; // 月份从0开始
            const day = parseInt(dateStr.substring(6, 8));
            
            console.log("Parsed date parts:", { year, month, day });
            
            if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
              const timestamp = new Date(year, month, day).getTime();
              console.log("Generated timestamp:", timestamp);
              return timestamp;
            }
          }
        }
        
        console.log("Failed to parse date, returning current time");
        return Date.now(); // 返回当前时间作为备用
      }

      // 辅助函数：解析存储键
      function parseReportKey(key) {
        console.log("Parsing report key:", key);
        
        // Remove "reports." prefix if it exists
        const cleanKey = key.startsWith("reports.") ? key.substring(8) : key;
        console.log("Clean key for parsing:", cleanKey);
        
        const parts = cleanKey.split("-");
        console.log("Parsed key parts:", parts);
        
        const result = {
          type: parts[0] || "unknown",
          date: parts[1] || "",
        };
        
        console.log("Parsed result:", result);
        return result;
      }      // 辅助函数：格式化日期时间
      function formatDateTime(timestamp) {
        if (!timestamp || timestamp === 0) {
          return "未知时间";
        }
        
        try {
          const date = new Date(timestamp);
          if (isNaN(date.getTime())) {
            return "无效日期";
          }
          
          return date.toLocaleString("zh-CN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        } catch (error) {
          console.error("Error formatting date:", error);
          return "日期格式错误";
        }
      }// 辅助函数：获取报告类型颜色
      function getTypeColor(type) {
        switch (type) {
          case "content":
            return "bg-red-100 text-red-800";
          case "bug":
            return "bg-orange-100 text-orange-800";
          case "feedback":
            return "bg-blue-100 text-blue-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      // 辅助函数：获取报告类型标签
      function getTypeLabel(type) {
        switch (type) {
          case "content":
            return "内容举报";
          case "bug":
            return "BUG汇报";
          case "feedback":
            return "用户意见";
          default:
            return "未知类型";
        }
      }// 页面初始化
      
      // 从URL获取tab参数
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get("tab");        // 设置初始tab
      const initialTab = tabParam && ["content", "bug", "feedback", "report-history"].includes(tabParam) ? tabParam : "content";

      showTab(initialTab);
    </script>
  </body>
</html>
