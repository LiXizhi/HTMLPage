
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ¿€æ´»ç ç”Ÿæˆä¸éªŒè¯ç³»ç»Ÿ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <script src="https://cdn.keepwork.com/sdk/libs/qrcode.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center text-indigo-900 mb-8">ğŸ® æ¿€æ´»ç ç®¡ç†ç³»ç»Ÿ</h1>
        
        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchTab('generate')" id="tab-generate" class="px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600">
                    ç”Ÿæˆæ¿€æ´»ç 
                </button>
                <button onclick="switchTab('verify')" id="tab-verify" class="px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600">
                    éªŒè¯æ¿€æ´»ç 
                </button>
                <button onclick="switchTab('print')" id="tab-print" class="px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600">
                    æ‰“å°æ¿€æ´»ç 
                </button>
            </div>

            <!-- ç”Ÿæˆæ¿€æ´»ç é¢æ¿ -->
            <div id="panel-generate" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Encoded Secret
                    </label>
                    <input type="text" id="encodedSecret" value="paracraft" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ç”Ÿæˆæ—¥æœŸ
                        </label>
                        <input type="date" id="generateDate" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ç”Ÿæˆæ•°é‡
                        </label>
                        <input type="number" id="quantity" value="10" min="1" max="1000"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="generateCodes()" 
                        class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ğŸ¯ ç”Ÿæˆæ¿€æ´»ç 
                    </button>
                    <button onclick="exportToCSV()" id="exportBtn" disabled
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        ğŸ“Š å¯¼å‡ºCSV
                    </button>
                </div>

                <div id="generatedCodes" class="hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-800">ç”Ÿæˆçš„æ¿€æ´»ç ï¼š</h3>
                        <button onclick="copyAllCodes()" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition flex items-center gap-2">
                            ğŸ“‹ å¤åˆ¶å…¨éƒ¨
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <div id="codesList" class="space-y-2"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        å…±ç”Ÿæˆ <span id="totalCodes" class="font-bold text-indigo-600">0</span> ä¸ªæ¿€æ´»ç 
                    </p>
                </div>
            </div>

            <!-- éªŒè¯æ¿€æ´»ç é¢æ¿ -->
            <div id="panel-verify" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Encoded Secret (ç”¨äºéªŒè¯)
                    </label>
                    <input type="text" id="verifyEncodedSecret" value="paracraft" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æ¿€æ´»ç 
                    </label>
                    <input type="text" id="activationCode" placeholder="XXXX-XXXX-XXXX-XXXX" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase">
                </div>

                <button onclick="verifyCode()" 
                    class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    ğŸ” éªŒè¯æ¿€æ´»ç 
                </button>

                <div id="verifyResult" class="hidden">
                    <div id="resultContent" class="p-4 rounded-lg"></div>
                </div>
            </div>

            <!-- æ‰“å°æ¿€æ´»ç é¢æ¿ -->
            <div id="panel-print" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å¡ç‰‡é£æ ¼æ¨¡æ¿
                    </label>
                    <select id="styleTemplate" onchange="updateTemplatePreview()" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="modern">ğŸ¨ ç°ä»£ç®€çº¦</option>
                        <option value="classic">ğŸ“œ ç»å…¸é›…è‡´</option>
                        <option value="gaming">ğŸ® æ¸¸æˆç”µç«</option>
                        <option value="gradient">ğŸŒˆ æ¸å˜ç‚«å½©</option>
                        <option value="minimal">âšª æç®€é»‘ç™½</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æ ‡é¢˜æ–‡å­—
                    </label>
                    <input type="text" id="printTitle" value="æ¸¸æˆæ¿€æ´»ç " 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æè¿°æ–‡å­—ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <textarea id="printDescription" rows="2" placeholder="ä¾‹å¦‚ï¼šè¯·å¦¥å–„ä¿ç®¡æ¿€æ´»ç ï¼Œé—å¤±ä¸è¡¥" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">æ‰«æäºŒç»´ç ä¸‹è½½App</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            èƒŒæ™¯å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰
                        </label>
                        <input type="text" id="bgImageUrl" placeholder="https://..." 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            èƒŒæ™¯é¢œè‰²ï¼ˆå¯é€‰ï¼‰
                        </label>
                        <div class="flex gap-2">
                            <input type="color" id="bgColor" value="#ffffff" 
                                class="w-20 h-10 px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <button type="button" onclick="clearBgColor()" 
                                class="flex-1 px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                æ¸…é™¤èƒŒæ™¯è‰²
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ç½‘å€ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <input type="text" id="printUrl" value="https://xq.maseai.com" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" checked id="useQrCode" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="useQrCode" class="ml-2 text-sm font-medium text-gray-700">
                        ä½¿ç”¨äºŒç»´ç æ˜¾ç¤ºç½‘å€
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æ¿€æ´»ç åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
                    </label>
                    <textarea id="printCodes" rows="10" placeholder="XXXX-XXXX-XXXX-XXXX&#10;YYYY-YYYY-YYYY-YYYY&#10;ZZZZ-ZZZZ-ZZZZ-ZZZZ" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æ¯è¡Œå¡ç‰‡æ•°é‡
                    </label>
                    <select id="columnsPerRow" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="2" selected>2åˆ—</option>
                        <option value="3">3åˆ—</option>
                    </select>
                </div>

                <button onclick="generatePrintCards()" 
                    class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    ğŸ–¨ï¸ ç”Ÿæˆæ‰“å°å¡ç‰‡
                </button>

                <div id="printPreview" class="hidden mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ‰“å°é¢„è§ˆ</h3>
                        <button onclick="printCards()" 
                            class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                            ğŸ–¨ï¸ æ‰“å°
                        </button>
                    </div>
                    <div id="cardsContainer" class="grid grid-cols-1 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ActivationCodeGenerator - æ¿€æ´»ç ç”Ÿæˆä¸éªŒè¯ç±»
         * æ— ä¾èµ–çš„ç‹¬ç«‹ç±»ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹å¤ç”¨
         * 
         * ç¼–ç æ ¼å¼ï¼ˆå›ºå®š16å­—ç¬¦ XXXX-XXXX-XXXX-XXXXï¼‰ï¼š
         * - å‰4ä½ï¼šæ—¥æœŸç¼–ç +éšæœºç›ï¼ˆbase36ï¼‰
         * - ä¸­4ä½ï¼šç´¢å¼•ç¼–ç +éšæœºç›ï¼ˆbase36ï¼‰
         * - å8ä½ï¼šæ ¡éªŒå’Œï¼ˆåŸºäºencodedSecret+date+index+randomSaltï¼‰
         * 
         * ä½¿ç”¨ç¤ºä¾‹ï¼š
         * const generator = new ActivationCodeGenerator();
         * const code = generator.generate('paracraft', '2024-10-17', 0);
         * const result = generator.verify(code, 'paracraft');
         */
        class ActivationCodeGenerator {
            constructor() {
                this.BASE_DATE = '2020-01-01';
                this.SALT_MIN = 1;
                this.SALT_MAX = 100;
            }

            /**
             * ç”Ÿæˆæ¿€æ´»ç 
             * @param {string} encodedSecret - ç¼–ç å¯†é’¥
             * @param {string} date - æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
             * @param {number} index - ç´¢å¼•å·
             * @returns {string} æ ¼å¼åŒ–çš„æ¿€æ´»ç  (XXXX-XXXX-XXXX-XXXX)
             */
            generate(encodedSecret, date, index) {
                const randomSalt = Math.floor(Math.random() * (this.SALT_MAX - this.SALT_MIN + 1)) + this.SALT_MIN;
                
                const dayNum = this._dateToNumber(date);
                const datePart = this._toBase36(dayNum + randomSalt, 4);
                const indexPart = this._toBase36(index + randomSalt, 4);
                
                const checksumSeed = `${encodedSecret}|${date}|${index}|${randomSalt}`;
                const checksum = this._hashString(checksumSeed);
                const checksumPart = this._toBase36(checksum, 8);
                
                const code = datePart + indexPart + checksumPart;
                
                return `${code.substr(0,4)}-${code.substr(4,4)}-${code.substr(8,4)}-${code.substr(12,4)}`;
            }

            /**
             * éªŒè¯æ¿€æ´»ç 
             * @param {string} code - æ¿€æ´»ç 
             * @param {string} expectedEncodedSecret - æœŸæœ›çš„ç¼–ç å¯†é’¥
             * @returns {object} éªŒè¯ç»“æœ { valid: boolean, encodedSecret?, date?, index?, salt?, reason? }
             */
            verify(code, expectedEncodedSecret) {
                try {
                    const cleanCode = code.replace(/-/g, '').toUpperCase();
                    
                    if (cleanCode.length !== 16) {
                        return { valid: false, reason: 'æ¿€æ´»ç é•¿åº¦é”™è¯¯' };
                    }
                    
                    const datePart = cleanCode.substr(0, 4);
                    const indexPart = cleanCode.substr(4, 4);
                    const checksumPart = cleanCode.substr(8, 8);
                    
                    const dayNumWithSalt = this._fromBase36(datePart);
                    const indexWithSalt = this._fromBase36(indexPart);
                    const receivedChecksum = checksumPart;
                    
                    for (let salt = this.SALT_MIN; salt <= this.SALT_MAX; salt++) {
                        const dayNum = dayNumWithSalt - salt;
                        const index = indexWithSalt - salt;
                        const date = this._numberToDate(dayNum);
                        
                        const checksumSeed = `${expectedEncodedSecret}|${date}|${index}|${salt}`;
                        const expectedChecksum = this._toBase36(this._hashString(checksumSeed), 8);
                        
                        if (receivedChecksum === expectedChecksum) {
                            return {
                                valid: true,
                                encodedSecret: expectedEncodedSecret,
                                date: date,
                                index: index,
                                salt: salt
                            };
                        }
                    }
                    
                    return { valid: false, reason: 'æ ¡éªŒå’Œä¸åŒ¹é…ï¼ˆç¼–ç å¯†é’¥é”™è¯¯ï¼‰' };
                    
                } catch (e) {
                    return { valid: false, reason: 'éªŒè¯å¼‚å¸¸: ' + e.message };
                }
            }

            // ç§æœ‰æ–¹æ³•ï¼šè®¡ç®—å­—ç¬¦ä¸²å“ˆå¸Œå€¼
            _hashString(text) {
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) - hash) + text.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }

            // ç§æœ‰æ–¹æ³•ï¼šæ•°å­—è½¬36è¿›åˆ¶å­—ç¬¦ä¸²
            _toBase36(num, length) {
                let result = num.toString(36).toUpperCase();
                while (result.length < length) {
                    result = '0' + result;
                }
                return result.substr(-length);
            }

            // ç§æœ‰æ–¹æ³•ï¼š36è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ•°å­—
            _fromBase36(str) {
                return parseInt(str, 36);
            }

            // ç§æœ‰æ–¹æ³•ï¼šæ—¥æœŸè½¬æ¢ä¸ºå¤©æ•°
            _dateToNumber(dateStr) {
                const baseDate = new Date(this.BASE_DATE);
                const targetDate = new Date(dateStr);
                const days = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
                return days;
            }

            // ç§æœ‰æ–¹æ³•ï¼šå¤©æ•°è½¬æ¢ä¸ºæ—¥æœŸ
            _numberToDate(days) {
                const baseDate = new Date(this.BASE_DATE);
                const targetDate = new Date(baseDate.getTime() + days * 1000 * 60 * 60 * 24);
                return targetDate.toISOString().split('T')[0];
            }
        }

        // ========== ä»¥ä¸‹æ˜¯é¡µé¢äº¤äº’ä»£ç  ==========
        
        const codeGenerator = new ActivationCodeGenerator();
        let generatedCodesData = [];

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('generateDate').valueAsDate = new Date();
        
        // Clear the cleared flag when user changes background color manually
        document.getElementById('bgColor').addEventListener('input', function() {
            delete this.dataset.cleared;
        });

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            const generateTab = document.getElementById('tab-generate');
            const verifyTab = document.getElementById('tab-verify');
            const printTab = document.getElementById('tab-print');
            const generatePanel = document.getElementById('panel-generate');
            const verifyPanel = document.getElementById('panel-verify');
            const printPanel = document.getElementById('panel-print');

            // Reset all tabs
            generateTab.className = 'px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600';
            verifyTab.className = 'px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600';
            printTab.className = 'px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600';
            generatePanel.classList.add('hidden');
            verifyPanel.classList.add('hidden');
            printPanel.classList.add('hidden');

            // Activate selected tab
            if (tab === 'generate') {
                generateTab.className = 'px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600';
                generatePanel.classList.remove('hidden');
            } else if (tab === 'verify') {
                verifyTab.className = 'px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600';
                verifyPanel.classList.remove('hidden');
            } else if (tab === 'print') {
                printTab.className = 'px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600';
                printPanel.classList.remove('hidden');
            }
        }

        // ç”Ÿæˆå¤šä¸ªæ¿€æ´»ç 
        function generateCodes() {
            const encodedSecret = document.getElementById('encodedSecret').value;
            const date = document.getElementById('generateDate').value;
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!encodedSecret || !date || !quantity) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }

            generatedCodesData = [];
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';

            for (let i = 0; i < quantity; i++) {
                const code = codeGenerator.generate(encodedSecret, date, i);
                generatedCodesData.push({
                    åºå·: i + 1,
                    æ¿€æ´»ç : code,
                    ç”Ÿæˆæ—¥æœŸ: date,
                    EncodedSecret: encodedSecret
                });

                const codeItem = document.createElement('div');
                codeItem.className = 'flex items-center justify-between bg-white p-3 rounded border border-gray-200';
                codeItem.innerHTML = `
                    <span class="font-mono text-sm">${i + 1}. ${code}</span>
                    <button onclick="copyCode('${code}')" class="text-indigo-600 hover:text-indigo-800 text-sm">å¤åˆ¶</button>
                `;
                codesList.appendChild(codeItem);
            }

            document.getElementById('generatedCodes').classList.remove('hidden');
            document.getElementById('totalCodes').textContent = quantity;
            document.getElementById('exportBtn').disabled = false;
        }

        // å¤åˆ¶æ¿€æ´»ç 
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('æ¿€æ´»ç å·²å¤åˆ¶: ' + code);
            });
        }

        // å¤åˆ¶å…¨éƒ¨æ¿€æ´»ç ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
        function copyAllCodes() {
            if (generatedCodesData.length === 0) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ¿€æ´»ç ï¼');
                return;
            }

            const allCodes = generatedCodesData.map(item => item.æ¿€æ´»ç ).join('\n');
            navigator.clipboard.writeText(allCodes).then(() => {
                alert(`å·²å¤åˆ¶ ${generatedCodesData.length} ä¸ªæ¿€æ´»ç åˆ°å‰ªè´´æ¿ï¼`);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥: ' + err.message);
            });
        }

        // å¯¼å‡ºåˆ°CSV
        function exportToCSV() {
            if (generatedCodesData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ¿€æ´»ç ï¼');
                return;
            }

            // Generate CSV content with one activation code per line
            const csvContent = generatedCodesData.map(item => item.æ¿€æ´»ç ).join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const date = document.getElementById('generateDate').value;
            link.setAttribute('href', url);
            link.setAttribute('download', `æ¿€æ´»ç _${date}_${generatedCodesData.length}ä¸ª.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // éªŒè¯æ¿€æ´»ç 
        function verifyCode() {
            const code = document.getElementById('activationCode').value.toUpperCase().trim();
            const encodedSecret = document.getElementById('verifyEncodedSecret').value;

            if (!code || !encodedSecret) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }

            // ç§»é™¤è¿å­—ç¬¦
            const cleanCode = code.replace(/-/g, '');

            if (cleanCode.length !== 16) {
                showVerifyResult(false, 'æ¿€æ´»ç æ ¼å¼é”™è¯¯ï¼');
                return;
            }

            // ä½¿ç”¨ç±»æ–¹æ³•éªŒè¯
            const result = codeGenerator.verify(code, encodedSecret);

            if (result.valid) {
                showVerifyResult(true, 
                    `æ¿€æ´»ç æœ‰æ•ˆï¼<br>` +
                    `ç”Ÿæˆæ—¥æœŸ: ${result.date}<br>` +
                    `åºå·: ${result.index + 1}<br>` +
                    `éšæœºç›: ${result.salt}<br>` +
                    `Encoded Secret: ${result.encodedSecret}`
                );
            } else {
                showVerifyResult(false, `æ¿€æ´»ç æ— æ•ˆ: ${result.reason}`);
            }
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function showVerifyResult(success, message) {
            const resultDiv = document.getElementById('verifyResult');
            const contentDiv = document.getElementById('resultContent');

            if (success) {
                contentDiv.className = 'p-4 rounded-lg bg-green-100 border border-green-300';
                contentDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">âœ…</span>
                        <div>
                            <p class="font-semibold text-green-800">éªŒè¯æˆåŠŸ</p>
                            <p class="text-sm text-green-700">${message}</p>
                        </div>
                    </div>
                `;
            } else {
                contentDiv.className = 'p-4 rounded-lg bg-red-100 border border-red-300';
                contentDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">âŒ</span>
                        <div>
                            <p class="font-semibold text-red-800">éªŒè¯å¤±è´¥</p>
                            <p class="text-sm text-red-700">${message}</p>
                        </div>
                    </div>
                `;
            }

            resultDiv.classList.remove('hidden');
        }

        // å¡ç‰‡é£æ ¼æ¨¡æ¿é…ç½®
        const styleTemplates = {
            modern: {
                name: 'ç°ä»£ç®€çº¦',
                cardBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                titleColor: '#ffffff',
                codeBoxBg: 'rgba(255, 255, 255, 0.95)',
                codeColor: '#667eea',
                textColor: '#ffffff',
                borderColor: 'transparent',
                shadow: '0 10px 30px rgba(0,0,0,0.3)'
            },
            classic: {
                name: 'ç»å…¸é›…è‡´',
                cardBg: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
                titleColor: '#2c3e50',
                codeBoxBg: '#ffffff',
                codeColor: '#2c3e50',
                textColor: '#34495e',
                borderColor: '#bdc3c7',
                shadow: '0 4px 15px rgba(0,0,0,0.1)'
            },
            gaming: {
                name: 'æ¸¸æˆç”µç«',
                cardBg: 'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)',
                titleColor: '#00ff88',
                codeBoxBg: 'rgba(0, 255, 136, 0.1)',
                codeColor: '#00ff88',
                textColor: '#00ff88',
                borderColor: '#00ff88',
                shadow: '0 0 20px rgba(0, 255, 136, 0.3)'
            },
            gradient: {
                name: 'æ¸å˜ç‚«å½©',
                cardBg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                titleColor: '#ffffff',
                codeBoxBg: 'rgba(255, 255, 255, 0.9)',
                codeColor: '#f5576c',
                textColor: '#ffffff',
                borderColor: 'transparent',
                shadow: '0 8px 25px rgba(245, 87, 108, 0.4)'
            },
            minimal: {
                name: 'æç®€é»‘ç™½',
                cardBg: '#ffffff',
                titleColor: '#000000',
                codeBoxBg: '#000000',
                codeColor: '#ffffff',
                textColor: '#000000',
                borderColor: '#000000',
                shadow: '0 2px 10px rgba(0,0,0,0.1)'
            }
        };

        // Generate QR code as data URL for efficient rendering
        function generateQRCodeDataURL(text, size = 120) {
            const canvas = document.createElement('canvas');
            const qr = new QRCode(canvas, {
                text: text,
                width: size,
                height: size,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            // Get canvas from QRCode element
            const qrCanvas = canvas.querySelector('canvas') || canvas;
            return qrCanvas.toDataURL('image/png');
        }

        // Update template preview when selection changes
        function updateTemplatePreview() {
            // Could add a small preview here if needed
        }

        // Clear background color
        function clearBgColor() {
            const bgColorInput = document.getElementById('bgColor');
            bgColorInput.value = '#ffffff';
            bgColorInput.dataset.cleared = 'true';
        }

        // ç”Ÿæˆæ‰“å°å¡ç‰‡
        function generatePrintCards() {
            const title = document.getElementById('printTitle').value.trim();
            const description = document.getElementById('printDescription').value.trim();
            const url = document.getElementById('printUrl').value.trim();
            const useQrCode = document.getElementById('useQrCode').checked;
            const codesText = document.getElementById('printCodes').value.trim();
            const styleTemplate = document.getElementById('styleTemplate').value;
            const bgImageUrl = document.getElementById('bgImageUrl').value.trim();
            const bgColorInput = document.getElementById('bgColor');
            const bgColor = bgColorInput.dataset.cleared === 'true' ? '' : bgColorInput.value;
            const columnsPerRow = document.getElementById('columnsPerRow').value;
            
            // Clear the flag after reading
            delete bgColorInput.dataset.cleared;

            if (!codesText) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ¿€æ´»ç ï¼');
                return;
            }

            // Parse activation codes (one per line)
            const codes = codesText.split('\n')
                .map(code => code.trim())
                .filter(code => code.length > 0);

            if (codes.length === 0) {
                alert('æ²¡æœ‰æœ‰æ•ˆçš„æ¿€æ´»ç ï¼');
                return;
            }

            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';
            
            // Apply column layout based on selection
            const columnClass = columnsPerRow === '3' ? 'md:grid-cols-3' : 'md:grid-cols-2';
            cardsContainer.className = `grid grid-cols-1 ${columnClass} gap-4`;

            // Get style template
            const style = styleTemplates[styleTemplate];

            // Pre-generate QR code data URL once for all cards (efficient for thousands of codes)
            let qrDataURL = null;
            if (url && useQrCode) {
                try {
                    // Create a temporary container for QR generation
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);
                    
                    new QRCode(tempDiv, {
                        text: url,
                        width: 120,
                        height: 120,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    // Get canvas and convert to data URL
                    const canvas = tempDiv.querySelector('canvas');
                    if (canvas) {
                        qrDataURL = canvas.toDataURL('image/png');
                    }
                    
                    // Clean up
                    document.body.removeChild(tempDiv);
                } catch (e) {
                    console.error('QR code generation error:', e);
                }
            }

            // Generate cards using document fragment for better performance
            const fragment = document.createDocumentFragment();
            const is3Column = columnsPerRow === '3';

            codes.forEach((code, index) => {
                const card = document.createElement('div');
                card.className = `rounded-lg print-card ${is3Column ? 'p-4' : 'p-6'}`;
                card.style.pageBreakInside = 'avoid';
                card.style.boxShadow = style.shadow;
                card.style.border = `2px solid ${style.borderColor}`;
                
                // Apply background
                if (bgImageUrl) {
                    card.style.backgroundImage = `url('${bgImageUrl}')`;
                    card.style.backgroundSize = 'cover';
                    card.style.backgroundPosition = 'center';
                } else if (bgColor && bgColor !== '' && bgColor !== '#ffffff') {
                    card.style.backgroundColor = bgColor;
                } else {
                    card.style.background = style.cardBg;
                }
                
                let cardHTML = '';
                
                // Title - adjust size for 3-column layout
                if (title) {
                    const titleSize = is3Column ? 'text-lg' : 'text-xl';
                    const titleMargin = is3Column ? 'mb-3' : 'mb-4';
                    cardHTML += `<h3 class="${titleSize} font-bold text-center ${titleMargin}" style="color: ${style.titleColor}">${title}</h3>`;
                }
                
                // Description
                if (description) {
                    cardHTML += `<p class="text-xs text-center mb-3" style="color: ${style.textColor}; opacity: 0.9"></p>`;
                }
                
                // Activation code
                // Calculate font size based on code length and column layout to keep it on single line
                const codeLength = code.length;
                let fontSize = '1.5rem'; // 24px default
                let letterSpacing = '0.1em';
                let minHeight = '80px';
                let padding = '0 0.5rem';
                
                if (is3Column) {
                    // More aggressive sizing for 3-column layout
                    minHeight = '60px';
                    if (codeLength > 20) {
                        fontSize = '0.75rem'; // 12px for long codes in 3 columns
                        letterSpacing = '0.02em';
                        padding = '0 0.25rem';
                    } else if (codeLength > 16) {
                        fontSize = '0.875rem'; // 14px for medium codes in 3 columns
                        letterSpacing = '0.05em';
                        padding = '0 0.35rem';
                    } else {
                        fontSize = '1rem'; // 16px for shorter codes in 3 columns
                        letterSpacing = '0.075em';
                    }
                } else {
                    // 2-column layout sizing
                    if (codeLength > 24) {
                        fontSize = '0.875rem'; // 14px for very long codes
                        letterSpacing = '0.025em';
                    } else if (codeLength > 20) {
                        fontSize = '1rem'; // 16px for long codes
                        letterSpacing = '0.05em';
                    } else if (codeLength > 16) {
                        fontSize = '1.25rem'; // 20px for medium codes
                        letterSpacing = '0.075em';
                    }
                }
                
                cardHTML += `
                    <div class="rounded-lg px-2 py-3 mb-3" style="background: ${style.codeBoxBg}; min-height: ${minHeight}; display: flex; flex-direction: column; justify-content: center;">
                        <p class="font-mono font-bold text-center" style="color: ${style.codeColor}; font-size: ${fontSize}; letter-spacing: ${letterSpacing}; white-space: nowrap; word-break: keep-all; overflow-wrap: normal; padding: ${padding}; line-height: 1.4;">${code}</p>
                    </div>
                `;
                
                // Description between code and QR code
                if (description) {
                    const descSize = is3Column ? 'text-xs' : 'text-sm';
                    const descMargin = is3Column ? 'mb-2' : 'mb-3';
                    cardHTML += `<p class="${descSize} text-center ${descMargin}" style="color: ${style.textColor}; opacity: 0.9">${description}</p>`;
                }
                
                // URL section
                if (url) {
                    const qrSize = is3Column ? 100 : 120;
                    if (useQrCode && qrDataURL) {
                        // Use pre-generated QR code data URL (very efficient!)
                        cardHTML += `
                            <div class="flex flex-col items-center ${is3Column ? 'mt-2' : 'mt-4'}">
                                <img src="${qrDataURL}" width="${qrSize}" height="${qrSize}" class="bg-white p-2 rounded" alt="QR Code" />
                            </div>
                        `;
                    } else if (url) {
                        const urlMargin = is3Column ? 'mt-2' : 'mt-4';
                        const urlSize = is3Column ? 'text-xs' : 'text-sm';
                        cardHTML += `
                            <div class="${urlMargin} text-center">
                                <p class="${urlSize} mb-1" style="color: ${style.textColor}">è®¿é—®åœ°å€</p>
                                <p class="${urlSize} break-all" style="color: ${style.textColor}; opacity: 0.9">${url}</p>
                            </div>
                        `;
                    }
                }
                
                card.innerHTML = cardHTML;
                fragment.appendChild(card);
            });

            // Append all cards at once (efficient DOM operation)
            cardsContainer.appendChild(fragment);

            document.getElementById('printPreview').classList.remove('hidden');
        }

        // æ‰“å°å¡ç‰‡
        function printCards() {
            const printPreview = document.getElementById('printPreview');
            const cardsContainer = document.getElementById('cardsContainer');
            
            if (!cardsContainer.innerHTML) {
                alert('æ²¡æœ‰å¯æ‰“å°çš„å¡ç‰‡ï¼');
                return;
            }

            // Create print styles
            const style = document.createElement('style');
            style.textContent = `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    #cardsContainer, #cardsContainer * {
                        visibility: visible;
                    }
                    #cardsContainer {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                    }
                    .print-card {
                        page-break-inside: avoid;
                        margin-bottom: 20px;
                    }
                }
            `;
            document.head.appendChild(style);

            // Trigger print
            window.print();

            // Clean up
            setTimeout(() => {
                document.head.removeChild(style);
            }, 1000);
        }
    </script>
</body>
</html>
