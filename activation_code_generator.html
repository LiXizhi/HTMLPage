
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ¿€æ´»ç ç”Ÿæˆä¸éªŒè¯ç³»ç»Ÿ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center text-indigo-900 mb-8">ğŸ® æ¿€æ´»ç ç®¡ç†ç³»ç»Ÿ</h1>
        
        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchTab('generate')" id="tab-generate" class="px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600">
                    ç”Ÿæˆæ¿€æ´»ç 
                </button>
                <button onclick="switchTab('verify')" id="tab-verify" class="px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600">
                    éªŒè¯æ¿€æ´»ç 
                </button>
            </div>

            <!-- ç”Ÿæˆæ¿€æ´»ç é¢æ¿ -->
            <div id="panel-generate" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Encoded Secret
                    </label>
                    <input type="text" id="encodedSecret" value="paracraft" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ç”Ÿæˆæ—¥æœŸ
                        </label>
                        <input type="date" id="generateDate" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ç”Ÿæˆæ•°é‡
                        </label>
                        <input type="number" id="quantity" value="10" min="1" max="1000"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="generateCodes()" 
                        class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ğŸ¯ ç”Ÿæˆæ¿€æ´»ç 
                    </button>
                    <button onclick="exportToCSV()" id="exportBtn" disabled
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        ğŸ“Š å¯¼å‡ºCSV
                    </button>
                </div>

                <div id="generatedCodes" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">ç”Ÿæˆçš„æ¿€æ´»ç ï¼š</h3>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <div id="codesList" class="space-y-2"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        å…±ç”Ÿæˆ <span id="totalCodes" class="font-bold text-indigo-600">0</span> ä¸ªæ¿€æ´»ç 
                    </p>
                </div>
            </div>

            <!-- éªŒè¯æ¿€æ´»ç é¢æ¿ -->
            <div id="panel-verify" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Encoded Secret (ç”¨äºéªŒè¯)
                    </label>
                    <input type="text" id="verifyEncodedSecret" value="paracraft" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        æ¿€æ´»ç 
                    </label>
                    <input type="text" id="activationCode" placeholder="XXXX-XXXX-XXXX-XXXX" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase">
                </div>

                <button onclick="verifyCode()" 
                    class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    ğŸ” éªŒè¯æ¿€æ´»ç 
                </button>

                <div id="verifyResult" class="hidden">
                    <div id="resultContent" class="p-4 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ActivationCodeGenerator - æ¿€æ´»ç ç”Ÿæˆä¸éªŒè¯ç±»
         * æ— ä¾èµ–çš„ç‹¬ç«‹ç±»ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹å¤ç”¨
         * 
         * ç¼–ç æ ¼å¼ï¼ˆå›ºå®š16å­—ç¬¦ XXXX-XXXX-XXXX-XXXXï¼‰ï¼š
         * - å‰4ä½ï¼šæ—¥æœŸç¼–ç +éšæœºç›ï¼ˆbase36ï¼‰
         * - ä¸­4ä½ï¼šç´¢å¼•ç¼–ç +éšæœºç›ï¼ˆbase36ï¼‰
         * - å8ä½ï¼šæ ¡éªŒå’Œï¼ˆåŸºäºencodedSecret+date+index+randomSaltï¼‰
         * 
         * ä½¿ç”¨ç¤ºä¾‹ï¼š
         * const generator = new ActivationCodeGenerator();
         * const code = generator.generate('paracraft', '2024-10-17', 0);
         * const result = generator.verify(code, 'paracraft');
         */
        class ActivationCodeGenerator {
            constructor() {
                this.BASE_DATE = '2020-01-01';
                this.SALT_MIN = 1;
                this.SALT_MAX = 100;
            }

            /**
             * ç”Ÿæˆæ¿€æ´»ç 
             * @param {string} encodedSecret - ç¼–ç å¯†é’¥
             * @param {string} date - æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
             * @param {number} index - ç´¢å¼•å·
             * @returns {string} æ ¼å¼åŒ–çš„æ¿€æ´»ç  (XXXX-XXXX-XXXX-XXXX)
             */
            generate(encodedSecret, date, index) {
                const randomSalt = Math.floor(Math.random() * (this.SALT_MAX - this.SALT_MIN + 1)) + this.SALT_MIN;
                
                const dayNum = this._dateToNumber(date);
                const datePart = this._toBase36(dayNum + randomSalt, 4);
                const indexPart = this._toBase36(index + randomSalt, 4);
                
                const checksumSeed = `${encodedSecret}|${date}|${index}|${randomSalt}`;
                const checksum = this._hashString(checksumSeed);
                const checksumPart = this._toBase36(checksum, 8);
                
                const code = datePart + indexPart + checksumPart;
                
                return `${code.substr(0,4)}-${code.substr(4,4)}-${code.substr(8,4)}-${code.substr(12,4)}`;
            }

            /**
             * éªŒè¯æ¿€æ´»ç 
             * @param {string} code - æ¿€æ´»ç 
             * @param {string} expectedEncodedSecret - æœŸæœ›çš„ç¼–ç å¯†é’¥
             * @returns {object} éªŒè¯ç»“æœ { valid: boolean, encodedSecret?, date?, index?, salt?, reason? }
             */
            verify(code, expectedEncodedSecret) {
                try {
                    const cleanCode = code.replace(/-/g, '').toUpperCase();
                    
                    if (cleanCode.length !== 16) {
                        return { valid: false, reason: 'æ¿€æ´»ç é•¿åº¦é”™è¯¯' };
                    }
                    
                    const datePart = cleanCode.substr(0, 4);
                    const indexPart = cleanCode.substr(4, 4);
                    const checksumPart = cleanCode.substr(8, 8);
                    
                    const dayNumWithSalt = this._fromBase36(datePart);
                    const indexWithSalt = this._fromBase36(indexPart);
                    const receivedChecksum = checksumPart;
                    
                    for (let salt = this.SALT_MIN; salt <= this.SALT_MAX; salt++) {
                        const dayNum = dayNumWithSalt - salt;
                        const index = indexWithSalt - salt;
                        const date = this._numberToDate(dayNum);
                        
                        const checksumSeed = `${expectedEncodedSecret}|${date}|${index}|${salt}`;
                        const expectedChecksum = this._toBase36(this._hashString(checksumSeed), 8);
                        
                        if (receivedChecksum === expectedChecksum) {
                            return {
                                valid: true,
                                encodedSecret: expectedEncodedSecret,
                                date: date,
                                index: index,
                                salt: salt
                            };
                        }
                    }
                    
                    return { valid: false, reason: 'æ ¡éªŒå’Œä¸åŒ¹é…ï¼ˆç¼–ç å¯†é’¥é”™è¯¯ï¼‰' };
                    
                } catch (e) {
                    return { valid: false, reason: 'éªŒè¯å¼‚å¸¸: ' + e.message };
                }
            }

            // ç§æœ‰æ–¹æ³•ï¼šè®¡ç®—å­—ç¬¦ä¸²å“ˆå¸Œå€¼
            _hashString(text) {
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) - hash) + text.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }

            // ç§æœ‰æ–¹æ³•ï¼šæ•°å­—è½¬36è¿›åˆ¶å­—ç¬¦ä¸²
            _toBase36(num, length) {
                let result = num.toString(36).toUpperCase();
                while (result.length < length) {
                    result = '0' + result;
                }
                return result.substr(-length);
            }

            // ç§æœ‰æ–¹æ³•ï¼š36è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ•°å­—
            _fromBase36(str) {
                return parseInt(str, 36);
            }

            // ç§æœ‰æ–¹æ³•ï¼šæ—¥æœŸè½¬æ¢ä¸ºå¤©æ•°
            _dateToNumber(dateStr) {
                const baseDate = new Date(this.BASE_DATE);
                const targetDate = new Date(dateStr);
                const days = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
                return days;
            }

            // ç§æœ‰æ–¹æ³•ï¼šå¤©æ•°è½¬æ¢ä¸ºæ—¥æœŸ
            _numberToDate(days) {
                const baseDate = new Date(this.BASE_DATE);
                const targetDate = new Date(baseDate.getTime() + days * 1000 * 60 * 60 * 24);
                return targetDate.toISOString().split('T')[0];
            }
        }

        // ========== ä»¥ä¸‹æ˜¯é¡µé¢äº¤äº’ä»£ç  ==========
        
        const codeGenerator = new ActivationCodeGenerator();
        let generatedCodesData = [];

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('generateDate').valueAsDate = new Date();

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            const generateTab = document.getElementById('tab-generate');
            const verifyTab = document.getElementById('tab-verify');
            const generatePanel = document.getElementById('panel-generate');
            const verifyPanel = document.getElementById('panel-verify');

            if (tab === 'generate') {
                generateTab.className = 'px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600';
                verifyTab.className = 'px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600';
                generatePanel.classList.remove('hidden');
                verifyPanel.classList.add('hidden');
            } else {
                verifyTab.className = 'px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600';
                generateTab.className = 'px-6 py-3 font-semibold text-gray-500 hover:text-indigo-600';
                verifyPanel.classList.remove('hidden');
                generatePanel.classList.add('hidden');
            }
        }

        // ç”Ÿæˆå¤šä¸ªæ¿€æ´»ç 
        function generateCodes() {
            const encodedSecret = document.getElementById('encodedSecret').value;
            const date = document.getElementById('generateDate').value;
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!encodedSecret || !date || !quantity) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }

            generatedCodesData = [];
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';

            for (let i = 0; i < quantity; i++) {
                const code = codeGenerator.generate(encodedSecret, date, i);
                generatedCodesData.push({
                    åºå·: i + 1,
                    æ¿€æ´»ç : code,
                    ç”Ÿæˆæ—¥æœŸ: date,
                    EncodedSecret: encodedSecret
                });

                const codeItem = document.createElement('div');
                codeItem.className = 'flex items-center justify-between bg-white p-3 rounded border border-gray-200';
                codeItem.innerHTML = `
                    <span class="font-mono text-sm">${i + 1}. ${code}</span>
                    <button onclick="copyCode('${code}')" class="text-indigo-600 hover:text-indigo-800 text-sm">å¤åˆ¶</button>
                `;
                codesList.appendChild(codeItem);
            }

            document.getElementById('generatedCodes').classList.remove('hidden');
            document.getElementById('totalCodes').textContent = quantity;
            document.getElementById('exportBtn').disabled = false;
        }

        // å¤åˆ¶æ¿€æ´»ç 
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('æ¿€æ´»ç å·²å¤åˆ¶: ' + code);
            });
        }

        // å¯¼å‡ºåˆ°CSV
        function exportToCSV() {
            if (generatedCodesData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ¿€æ´»ç ï¼');
                return;
            }

            // Generate CSV content with one activation code per line
            const csvContent = generatedCodesData.map(item => item.æ¿€æ´»ç ).join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const date = document.getElementById('generateDate').value;
            link.setAttribute('href', url);
            link.setAttribute('download', `æ¿€æ´»ç _${date}_${generatedCodesData.length}ä¸ª.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // éªŒè¯æ¿€æ´»ç 
        function verifyCode() {
            const code = document.getElementById('activationCode').value.toUpperCase().trim();
            const encodedSecret = document.getElementById('verifyEncodedSecret').value;

            if (!code || !encodedSecret) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }

            // ç§»é™¤è¿å­—ç¬¦
            const cleanCode = code.replace(/-/g, '');

            if (cleanCode.length !== 16) {
                showVerifyResult(false, 'æ¿€æ´»ç æ ¼å¼é”™è¯¯ï¼');
                return;
            }

            // ä½¿ç”¨ç±»æ–¹æ³•éªŒè¯
            const result = codeGenerator.verify(code, encodedSecret);

            if (result.valid) {
                showVerifyResult(true, 
                    `æ¿€æ´»ç æœ‰æ•ˆï¼<br>` +
                    `ç”Ÿæˆæ—¥æœŸ: ${result.date}<br>` +
                    `åºå·: ${result.index + 1}<br>` +
                    `éšæœºç›: ${result.salt}<br>` +
                    `Encoded Secret: ${result.encodedSecret}`
                );
            } else {
                showVerifyResult(false, `æ¿€æ´»ç æ— æ•ˆ: ${result.reason}`);
            }
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function showVerifyResult(success, message) {
            const resultDiv = document.getElementById('verifyResult');
            const contentDiv = document.getElementById('resultContent');

            if (success) {
                contentDiv.className = 'p-4 rounded-lg bg-green-100 border border-green-300';
                contentDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">âœ…</span>
                        <div>
                            <p class="font-semibold text-green-800">éªŒè¯æˆåŠŸ</p>
                            <p class="text-sm text-green-700">${message}</p>
                        </div>
                    </div>
                `;
            } else {
                contentDiv.className = 'p-4 rounded-lg bg-red-100 border border-red-300';
                contentDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">âŒ</span>
                        <div>
                            <p class="font-semibold text-red-800">éªŒè¯å¤±è´¥</p>
                            <p class="text-sm text-red-700">${message}</p>
                        </div>
                    </div>
                `;
            }

            resultDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
