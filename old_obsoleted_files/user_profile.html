<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é’å°‘å¹´ç”¨æˆ·ç”»åƒ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
        width: 100%;
        height: 100vh;
        overflow: hidden;
        position: relative;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(168, 85, 247, 0.1);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(168, 85, 247, 0.3);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(168, 85, 247, 0.5);
      }

      .profile-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(168, 85, 247, 0.15);
        margin: 10px;
        width: calc(100% - 20px);
        height: calc(100% - 20px);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }

      .profile-container.loaded {
        opacity: 1;
      }

      .header {
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        color: white;
        padding: 12px 25px;
        border-radius: 12px 12px 0 0;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
      }

      .header-title {
        display: inline-block;
        flex: 1;
      }

      .refresh-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .refresh-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .refresh-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .content {
        flex: 1;
        display: flex;
        padding: 15px;
        gap: 15px;
      }

      .left-panel {
        flex-shrink: 0;
        width: 280px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .personal-info {
        background: linear-gradient(135deg, #faf5ff 0%, #fdf2f8 100%);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 2px solid #e879f9;
        transition: box-shadow 0.3s ease;
      }

      .personal-info:hover {
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.25);
      }

      .avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
      }

      .nickName {
        font-size: 20px;
        font-weight: bold;
        color: #581c87;
        margin-bottom: 8px;
      }
      .userName {
        color: #a855f7;
        font-size: 13px;
        margin-bottom: 12px;
      }

      /* ä¿®æ”¹æ˜µç§°æŒ‰é’®æ ·å¼ */
      .edit-nickname-btn {
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
        width: 100%;
        box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
      }

      .edit-nickname-btn:hover {
        background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
      }

      .edit-nickname-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(168, 85, 247, 0.3);
      }

      /* ä¿®æ”¹æ˜µç§°å¼¹çª—æ ·å¼ */
      .nickname-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
      }

      .nickname-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nickname-modal-content {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        width: 95%;
        max-width: 450px;
        animation: slideIn 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .nickname-modal-header {
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .nickname-modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
      }

      .nickname-modal-body {
        padding: 30px 25px;
      }

      .nickname-input-group {
        margin-bottom: 20px;
      }

      .nickname-input-label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #374151;
        font-size: 14px;
      }

      .nickname-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .nickname-input:focus {
        outline: none;
        border-color: #a855f7;
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
      }

      .nickname-input.error {
        border-color: #ef4444;
        background-color: #fef2f2;
      }

      .nickname-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 5px;
        line-height: 1.4;
      }

      .nickname-error {
        font-size: 12px;
        color: #ef4444;
        margin-top: 5px;
        display: none;
      }

      .nickname-modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      .nickname-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
      }

      .nickname-btn-cancel {
        background: #f3f4f6;
        color: #374151;
      }

      .nickname-btn-cancel:hover {
        background: #e5e7eb;
      }

      .nickname-btn-confirm {
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        color: white;
      }

      .nickname-btn-confirm:hover {
        background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
      }
      .nickname-btn-confirm:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Toast æ¶ˆæ¯æç¤ºæ ·å¼ */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        animation: toastFadeIn 0.3s ease-in;
      }

      .toast.success {
        background: rgba(34, 197, 94, 0.9);
      }

      .toast.warning {
        background: rgba(245, 158, 11, 0.9);
      }

      .toast.error {
        background: rgba(239, 68, 68, 0.9);
      }

      @keyframes toastFadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .radar-container {
        background: linear-gradient(135deg, #faf5ff 0%, #fdf2f8 100%);
        border-radius: 12px;
        padding: 10px;
        border: 2px solid #e879f9;
        flex: 1;
        transition: box-shadow 0.3s ease;
      }

      .radar-container:hover {
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.25);
      }

      .radar-title {
        text-align: center;
        font-weight: bold;
        color: #581c87;
        margin-bottom: 10px;
        font-size: 15px;
      }

      .radar-chart-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
        position: relative;
      }

      .radar-chart {
        width: 100% !important;
        height: 100% !important;
        max-width: min(100%, 300px);
        max-height: min(100%, 300px);
      }

      /* Canvasé«˜DPIä¼˜åŒ– */
      #radarChart {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
        image-rendering: optimizeQuality;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }

      .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* é¡¶å±‚ä¸¤ä¸ªæ¿å—åŒæ’æ˜¾ç¤ºçš„å®¹å™¨ */
      .section-row {
        display: flex;
        gap: 10px;
      }
      .section-row .ability-section {
        flex: 1;
        margin-bottom: 0;
      }

      .ability-section {
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: row; /* æ”¹ä¸ºæ¨ªå‘å¸ƒå±€ */
      }

      .ability-section.renzhi-section {
        flex-shrink: 0;
        flex: initial;
      }

      .section-header {
        background: #a8d8ea;
        color: #2d3436;
        padding: 0 16px;
        font-weight: bold;
        font-size: clamp(14px, 2.2vw, 18px); /* å¢å¤§å­—ä½“ */
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
      }

      /* ä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢œè‰² */
      .cognitive-section .section-header {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed); /* ç´«è‰² */
        color: white;
      }

      .strategy-section .section-header {
        background: linear-gradient(135deg, #3b82f6, #2563eb); /* è“è‰² */
        color: white;
      }

      .motivation-section .section-header {
        background: linear-gradient(135deg, #10b981, #059669); /* ç»¿è‰² */
        color: white;
      }

      .emotion-section .section-header {
        background: linear-gradient(135deg, #f59e0b, #d97706); /* æ©™è‰² */
        color: white;
      }

      .quality-section .section-header {
        background: linear-gradient(135deg, #ef4444, #dc2626); /* çº¢è‰² */
        color: white;
      }

      .section-content {
        flex: 1;
        display: flex;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 2px;
        background: #e9ecef;
        height: 100%;
      }

      /* å †å ä¸¤è¡Œçš„å®¹å™¨ä¸è¡Œï¼Œç”¨äºâ€œè®¤çŸ¥èƒ½åŠ›â€è¿‡å¤šæœ«çº§æŒ‡æ ‡çš„å¸ƒå±€ */
      .section-content--stack {
        display: flex;
        flex-direction: column;
        gap: 1px;
        background: #e9ecef;
        height: 100%;
        flex: 1;
      }
      .section-content-row {
        display: flex;
        gap: 2px;
        flex: 1;
      }

      .ability-item {
        box-sizing: border-box;
        background: white;
        padding: 8px; /* å¢åŠ å†…è¾¹è· */
        text-align: center;
        font-size: 12px; /* å¢å¤§å­æ ‡é¢˜å­—ä½“ */
        transition: all 0.2s ease;
        cursor: pointer;
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        margin-left: -1px;
        margin-top: -1px;
      }

      .ability-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .ability-item:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .ability-label {
        color: #636e72;
        font-size: 19px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
        font-weight: 500; /* å¢åŠ å­—é‡ */
      }

      .ability-value {
        font-weight: bold;
        color: #2d3436;
        font-size: 22px; /* å¢å¤§æ•°å€¼å­—ä½“ */
      }

      .ability-value.empty {
        color: #d8b4fe;
      }
      .ability-score-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .ability-emoji {
        font-size: 16px;
        line-height: 1;
      }

      .ability-value.empty {
        color: #ddd;
      }

      /* æƒ…ç»ªæ™ºåŠ›å’Œå­¦ä¹ å“è´¨æ¨ªå‘å¸ƒå±€ */
      .emotion-quality-row {
        display: flex;
        gap: 10px;
        margin-bottom: 1vh;
      }

      .emotion-quality-row .ability-section {
        flex: 1;
        margin-bottom: 0;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-size: clamp(14px, 3vw, 20px);
        color: #a855f7;
      }

      /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
      @media (hover: none) and (pointer: coarse) {
        .ability-item {
          min-height: 44px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          cursor: pointer;
          transition: background-color 0.2s ease;
        }

        .ability-item:active {
          background-color: #f0f0f0;
        }

        .section-header {
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
      }
      /* Modalæ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        position: relative;
      }

      .modal-header {
        background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 40px;
        font-weight: bold;
      }

      .close {
        color: white;
        font-size: 4rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s ease;
      }

      .close:hover {
        color: #f0f0f0;
      }

      .modal-body {
        padding: 30px;
      }

      .ability-info {
        text-align: left;
      }

      .ability-name {
        font-size: 40px;
        font-weight: bold;
        color: #2d3436;
        margin-bottom: 10px;
        text-align: center;
      }

      .ability-description {
        font-size: 30px;
        line-height: 1.6;
        color: #636e72;
        text-align: justify;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div class="profile-container" id="profileContainer">
      <div class="header">
        <span class="header-title">ä¸ªäººä¿¡æ¯</span>
        <button class="refresh-btn" onclick="refreshPage()">
          <span>ğŸ”„</span>
          <span>åˆ·æ–°</span>
        </button>
      </div>

      <div class="content">
        <div class="left-panel">
          <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
          <div class="personal-info">
            <div class="avatar">ğŸ‘¤</div>
            <div class="nickName">ç”¨æˆ·æ˜µç§°ï¼š</div>
            <div class="userName">è´¦å·ï¼š</div>
            <button class="edit-nickname-btn" onclick="showEditNicknameModal()">ä¿®æ”¹æ˜µç§°</button>
            <div class="user-info-extra" style="display: none"></div>
          </div>
          <!-- é›·è¾¾å›¾ -->
          <div class="radar-container">
            <div class="radar-title">ç»¼åˆèƒ½åŠ›</div>
            <div class="radar-chart-container">
              <canvas id="radarChart" class="radar-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="right-panel">
          <!-- è®¤çŸ¥èƒ½åŠ› -->
          <div class="ability-section cognitive-section">
            <div class="section-header">è®¤çŸ¥èƒ½åŠ›</div>
            <div class="section-content">
              <div class="ability-item">
                <div class="ability-label">é›†ä¸­æ€§æ³¨æ„åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="focusedAttention">-</div>
                  <div class="ability-emoji" id="focusedAttention-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">é€‰æ‹©æ€§æ³¨æ„åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="selectiveAttention">-</div>
                  <div class="ability-emoji" id="selectiveAttention-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è½¬ç§»æ€§æ³¨æ„åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="shiftingAttention">-</div>
                  <div class="ability-emoji" id="shiftingAttention-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">åˆ†é…æ€§æ³¨æ„åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="distributedAttention">-</div>
                  <div class="ability-emoji" id="distributedAttention-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è§†è§‰è®°å¿†</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="visualMemory">-</div>
                  <div class="ability-emoji" id="visualMemory-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å¬è§‰è®°å¿†</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="auditoryMemory">-</div>
                  <div class="ability-emoji" id="auditoryMemory-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å·¥ä½œè®°å¿†</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="workingMemory">-</div>
                  <div class="ability-emoji" id="workingMemory-emoji"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- æ€ç»´èƒ½åŠ› -->
          <div class="ability-section cognitive-section">
            <div class="section-header">æ€ç»´èƒ½åŠ›</div>
            <div class="section-content">
              <div class="ability-item">
                <div class="ability-label">å½’çº³æ¨ç†èƒ½åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="inductiveReasoning">-</div>
                  <div class="ability-emoji" id="inductiveReasoning-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">æ¼”ç»æ¨ç†èƒ½åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="deductiveReasoning">-</div>
                  <div class="ability-emoji" id="deductiveReasoning-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">ç±»æ¯”æ¨ç†èƒ½åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="analogicalReasoning">-</div>
                  <div class="ability-emoji" id="analogicalReasoning-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è¨€è¯­ç†è§£èƒ½åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="verbalComprehension">-</div>
                  <div class="ability-emoji" id="verbalComprehension-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">æŠ½è±¡æ¨ç†èƒ½åŠ›</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="abstractReasoning">-</div>
                  <div class="ability-emoji" id="abstractReasoning-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è§†è§‰ç©ºé—´æ™ºèƒ½</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="visualSpatialIntelligence">-</div>
                  <div class="ability-emoji" id="visualSpatialIntelligence-emoji"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- å­¦ä¹ ç­–ç•¥ -->
          <div class="ability-section strategy-section">
            <div class="section-header">å­¦ä¹ ç­–ç•¥</div>
            <div class="section-content">
              <div class="ability-item">
                <div class="ability-label">å¤è¿°ç­–ç•¥</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="elaborationStrategy">-</div>
                  <div class="ability-emoji" id="elaborationStrategy-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">ç²¾ç»†åŠ å·¥ç­–ç•¥</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="detailedProcessingStrategy">-</div>
                  <div class="ability-emoji" id="detailedProcessingStrategy-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">ç»„ç»‡ç­–ç•¥</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="organizationalStrategy">-</div>
                  <div class="ability-emoji" id="organizationalStrategy-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å…ƒè®¤çŸ¥è®¡åˆ’</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="metacognitivePlanning">-</div>
                  <div class="ability-emoji" id="metacognitivePlanning-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å…ƒè®¤çŸ¥ç›‘æ§</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="metacognitiveMonitoring">-</div>
                  <div class="ability-emoji" id="metacognitiveMonitoring-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å…ƒè®¤çŸ¥è°ƒèŠ‚</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="metacognitiveRegulation">-</div>
                  <div class="ability-emoji" id="metacognitiveRegulation-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">åŠªåŠ›ç®¡ç†</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="effortManagement">-</div>
                  <div class="ability-emoji" id="effortManagement-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">æ—¶é—´ç®¡ç†</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="timeManagement">-</div>
                  <div class="ability-emoji" id="timeManagement-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å¤–ç•Œèµ„æºåˆ©ç”¨</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="externalResourceUtilization">-</div>
                  <div class="ability-emoji" id="externalResourceUtilization-emoji"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- å­¦ä¹ åŠ¨æœº -->
          <div class="ability-section motivation-section">
            <div class="section-header">å­¦ä¹ åŠ¨æœº</div>
            <div class="section-content">
              <div class="ability-item">
                <div class="ability-label">æˆé•¿</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="growth">-</div>
                  <div class="ability-emoji" id="growth-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è‡ªä¸»</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="autonomy">-</div>
                  <div class="ability-emoji" id="autonomy-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">äº’åŠ¨</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="interaction">-</div>
                  <div class="ability-emoji" id="interaction-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">å…´è¶£</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="interest">-</div>
                  <div class="ability-emoji" id="interest-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">è®¤å¯</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="recognition">-</div>
                  <div class="ability-emoji" id="recognition-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">ç«äº‰</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="competition">-</div>
                  <div class="ability-emoji" id="competition-emoji"></div>
                </div>
              </div>
              <div class="ability-item">
                <div class="ability-label">ç‰©è´¨å¥–åŠ±</div>
                <div class="ability-score-container">
                  <div class="ability-value" id="materialReward">-</div>
                  <div class="ability-emoji" id="materialReward-emoji"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- æƒ…ç»ªæ™ºåŠ›å’Œå­¦ä¹ å“è´¨ -->
          <div class="emotion-quality-row">
            <!-- æƒ…ç»ªæ™ºåŠ› -->
            <div class="ability-section emotion-section">
              <div class="section-header">æƒ…ç»ªæ™ºåŠ›</div>
              <div class="section-content">
                <div class="ability-item">
                  <div class="ability-label">æƒ…ç»ªæ„ŸçŸ¥ç†è§£</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="emotionalAwareness">-</div>
                    <div class="ability-emoji" id="emotionalAwareness-emoji"></div>
                  </div>
                </div>
                <div class="ability-item">
                  <div class="ability-label">æƒ…ç»ªè°ƒèŠ‚è¡¨è¾¾</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="emotionalRegulation">-</div>
                    <div class="ability-emoji" id="emotionalRegulation-emoji"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- å­¦ä¹ å“è´¨ -->
            <div class="ability-section quality-section">
              <div class="section-header">å­¦ä¹ å“è´¨</div>
              <div class="section-content">
                <div class="ability-item">
                  <div class="ability-label">è´£ä»»å¿ƒ</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="responsibility">-</div>
                    <div class="ability-emoji" id="responsibility-emoji"></div>
                  </div>
                </div>
                <div class="ability-item">
                  <div class="ability-label">ä¸¥è°¨æ€§</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="seriousness">-</div>
                    <div class="ability-emoji" id="seriousness-emoji"></div>
                  </div>
                </div>
                <div class="ability-item">
                  <div class="ability-label">åšæ¯…æ€§</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="perseverance">-</div>
                    <div class="ability-emoji" id="perseverance-emoji"></div>
                  </div>
                </div>
                <div class="ability-item">
                  <div class="ability-label">åˆ›æ–°æ€§</div>
                  <div class="ability-score-container">
                    <div class="ability-value" id="creativity">-</div>
                    <div class="ability-emoji" id="creativity-emoji"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modalå¼¹æ¡† -->
    <div id="abilityModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">èƒ½åŠ›è¯¦æƒ…</h3>
          <span class="close" onclick="closeAbilityModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="ability-info">
            <div class="ability-name" id="modalAbilityName"></div>
            <div class="ability-description" id="modalAbilityDescription"></div>
          </div>
          <div class="game-info" id="gameInfo" style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #eee; display: none">
            <h4 style="margin-bottom: 20px; color: #333; font-size: 32px">ç›¸å…³æ¸¸æˆ</h4>
            <div class="game-name" id="modalGameName" style="color: #007bff; cursor: pointer; text-decoration: underline; font-weight: bold; font-size: 28px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹æ˜µç§°å¼¹çª— -->
    <div id="nicknameModal" class="nickname-modal">
      <div class="nickname-modal-content">
        <div class="nickname-modal-header">
          <h3>ä¿®æ”¹æ˜µç§°</h3>
        </div>
        <div class="nickname-modal-body">
          <div class="nickname-input-group">
            <label class="nickname-input-label">æ–°æ˜µç§°</label>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="è¯·è¾“å…¥æ–°æ˜µç§°" maxlength="16" />
            <div class="nickname-hint">
              â€¢ é¦–æ¬¡ä¿®æ”¹å…è´¹ï¼Œä¹‹åæ¯æ¬¡10çŸ¥è¯†å¸<br />
              â€¢ ä¸èƒ½ä¸ºç©º<br />
              â€¢ ä¸èƒ½è¶…è¿‡10ä¸ªä¸­æ–‡å­—æˆ–16ä¸ªè‹±æ–‡å­—æ¯
            </div>
            <div class="nickname-error" id="nicknameError">æ˜µç§°æ ¼å¼ä¸æ­£ç¡®</div>
          </div>
          <div class="nickname-modal-buttons">
            <button class="nickname-btn nickname-btn-cancel" onclick="closeEditNicknameModal()">å–æ¶ˆ</button>
            <button class="nickname-btn nickname-btn-confirm" id="confirmNicknameBtn" onclick="confirmNickname()">ç¡®è®¤ä¿®æ”¹</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let radarChart;
      let abilityConfig = null;
      let profileData = {};
      let userInfoData = {};
      let miniGameProxyData = {};
      // åˆ·æ–°æŒ‰é’®é˜²æŠ–è®¡æ—¶å™¨
      let _refreshPageTimer = null;
      let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      let isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;
      const isLandscape = () => window.innerWidth > window.innerHeight;
      const getScreenSize = () => ({
        width: window.innerWidth,
        height: window.innerHeight,
        ratio: window.devicePixelRatio || 1,
      });
      const chartLabels = ["è®¤çŸ¥èƒ½åŠ›", "å­¦ä¹ ç­–ç•¥", "å­¦ä¹ åŠ¨æœº", "æƒ…ç»ªæ™ºåŠ›", "å­¦ä¹ å“è´¨"];

      class KeepworkProxy {
        constructor() {
          this.requestId = 0;
          this.pendingRequests = new Map();
          this.debugMode = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";

          // ç›‘å¬çˆ¶é¡µé¢çš„å“åº”
          window.addEventListener("message", (event) => {
            if (event.data.type === "keepworkResponse") {
              const { requestId, success, data, error } = event.data;
              const request = this.pendingRequests.get(requestId);

              if (request) {
                this.pendingRequests.delete(requestId);
                if (this.debugMode) {
                  console.debug("KeepworkProxy response received:", { requestId, success, data, error });
                }
                if (success) {
                  request.resolve(data);
                } else {
                  request.reject(new Error(error));
                }
              }
            }
          });
        }

        _sendRequest(method, args = []) {
          return new Promise((resolve, reject) => {
            const requestId = ++this.requestId;

            this.pendingRequests.set(requestId, { resolve, reject });

            if (this.debugMode) {
              console.debug("KeepworkProxy sending request:", { method, args, requestId });
            }

            // è®¾ç½®è¶…æ—¶
            setTimeout(() => {
              if (this.pendingRequests.has(requestId)) {
                this.pendingRequests.delete(requestId);
                reject(new Error("Keepwork operation timeout"));
              }
            }, 10000); // keepworkæ“ä½œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´

            // å‘é€è¯·æ±‚åˆ°çˆ¶é¡µé¢
            window.parent.parent.postMessage(
              {
                type: "keepwork",
                method,
                args,
                requestId,
              },
              "*"
            );
          });
        }

        // é€šç”¨æ–¹æ³•è°ƒç”¨
        async call(method, ...args) {
          return await this._sendRequest(method, args);
        }

        // æ”¯æŒæ·±å±‚æ–¹æ³•è°ƒç”¨ï¼Œå¦‚ keepwork.some.deep.method
        _createProxy(basePath = "") {
          return new Proxy(this, {
            get: (target, prop) => {
              if (typeof prop === "string" && !prop.startsWith("_") && prop !== "constructor") {
                const fullPath = basePath ? basePath + "." + prop : prop;

                // å¦‚æœæ˜¯å·²å®šä¹‰çš„æ–¹æ³•ï¼Œç›´æ¥è¿”å›
                if (target[prop] && typeof target[prop] === "function") {
                  return target[prop].bind(target);
                }

                // å¦‚æœæ˜¯å·²å®šä¹‰çš„å±æ€§ï¼Œç›´æ¥è¿”å›
                if (target[prop]) {
                  return target[prop];
                }

                // å¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†
                return this._createProxy(fullPath);
              }
              return target[prop];
            },
            apply: (target, thisArg, argArray) => {
              // å½“ä½œä¸ºå‡½æ•°è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œè¿œç¨‹æ–¹æ³•è°ƒç”¨
              return target._sendRequest(basePath, argArray);
            },
          });
        }

        // åˆ›å»ºä»£ç†å®ä¾‹
        createProxy() {
          return this._createProxy();
        }
      }

      window.parentKeepwork = new KeepworkProxy().createProxy();

      // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
      window.addEventListener("message", async function (event) {
        console.log("æ”¶åˆ°æ¶ˆæ¯", event.data);
        if (event.data && event.data.type === "setGameConfig") {
          if (event.data.from === "ms_games") {
            const data = event.data.data;
            if (data && Array.isArray(data)) {
              const abilityConfig = await getAbilityConfig();
              const miniGameFinishInfo = await getMiniGameFinishInfo();

              // æ„å»ºprofileDataå¯¹è±¡ï¼ŒåŸºäºminiGameFinishInfoå’ŒabilityConfig
              const profileData = {};

              // éå†æ¯ä¸ªèƒ½åŠ›
              for (const [abilityKey, abilityInfo] of Object.entries(abilityConfig)) {
                let gameMaxScore = 0;
                let hasValidGameScore = false;

                // éå†è¯¥èƒ½åŠ›å…³è”çš„æ¸¸æˆï¼Œè®¡ç®—æ¸¸æˆæœ€é«˜åˆ†
                if (abilityInfo.games && Array.isArray(abilityInfo.games)) {
                  for (const game of abilityInfo.games) {
                    const gameResult = miniGameFinishInfo[game.name];
                    if (gameResult && gameResult.completed && typeof gameResult.score === "number") {
                      gameMaxScore = Math.max(gameMaxScore, gameResult.score);
                      hasValidGameScore = true;
                    }
                  }
                }

                // ä»dataæ•°ç»„ä¸­è·å–å¯¹åº”çš„scoreå€¼
                const dataItem = data.find((item) => item.quotaName === abilityInfo.label);
                const dataScore = dataItem ? dataItem.score : 0;

                // è®¾ç½®è¯¥èƒ½åŠ›çš„åˆ†æ•°
                profileData[abilityKey] = {
                  score: dataScore || 0, // ä½¿ç”¨dataæ•°ç»„ä¸­çš„scoreå€¼
                  test_score: hasValidGameScore ? gameMaxScore : null, // ä½¿ç”¨æ¸¸æˆæœ€é«˜åˆ†ï¼Œæ²¡æœ‰åˆ™ä¸ºnull
                };
              }

              console.log("ä»æ¸¸æˆæˆç»©æ„å»ºçš„profileData:", profileData);

              // è°ƒç”¨updateProfileæ›´æ–°ç•Œé¢
              updateProfile(profileData);
              // åŸºäºå½“å‰æ•°æ®åŠ¨æ€æ›´æ–°é›·è¾¾å›¾
              updateRadarChartFromCaps(data);
            }
            const userInfo = event.data.userInfo;
            const nickNameElement = document.querySelector(".nickName");
            const userNameElement = document.querySelector(".userName");
            nickNameElement.textContent = `ç”¨æˆ·æ˜µç§°ï¼š${userInfo.name || "æœªçŸ¥ç”¨æˆ·"}`;
            userNameElement.textContent = `è´¦å·ï¼š${userInfo.phone || "æœªçŸ¥è´¦å·"}`;
          } else {
            profileData = event.data.data.profileData;
            userInfoData = event.data.data.userInfoData;
            profileData && updateProfile(profileData);
            userInfoData && updateUserInfo(userInfoData);
          }
        }
      });

      // é¡µé¢åŠ è½½å®Œæˆåå‘é€æ¶ˆæ¯
      window.addEventListener("load", async function () {
        window.parent.postMessage({ type: "requestProfileData" }, "*");

        // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame
        requestAnimationFrame(() => {
          initRadarChart();
          // adjustLayout();
          if (isTouch) {
            addTouchEvents();
          }

          // åˆå§‹åŒ–èƒ½åŠ›é¡¹ç‚¹å‡»äº‹ä»¶
          initAbilityItemEvents();

          // æ·»åŠ åŠ è½½å®Œæˆçš„è§†è§‰åé¦ˆ
          const container = document.getElementById("profileContainer");
          container.classList.add("loaded");

          // é¢„åŠ è½½ä¼˜åŒ–
          preloadOptimizations();
        });
      });

      // é¢„è®¾ç½®ä¸€äº›æ ·å¼ä»¥é¿å…é—ªçƒ
      const container = document.getElementById("profileContainer");
      if (container) {
        container.style.visibility = "visible";
      }

      // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
      showLoadingIndicator();

      // åˆ·æ–°é¡µé¢å‡½æ•°ï¼ˆé˜²æŠ–ï¼‰
      async function refreshPage() {
        // 300ms é˜²æŠ–ï¼šè¿ç»­ç‚¹å‡»åªåœ¨æ¾æ‰‹åæ‰§è¡Œä¸€æ¬¡
        if (_refreshPageTimer) clearTimeout(_refreshPageTimer);
        _refreshPageTimer = setTimeout(async () => {
          _refreshPageTimer = null;
          if (miniGameProxyData.maisiToken) {
            // todo
          } else if (miniGameProxyData.keepworkUserInfo?.username) {
            try {
              const response = await fetch(`https://gw.yujingceping.com/evaluation/dm/report/quotaList?sid=${miniGameProxyData.keepworkUserInfo.username}`, {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                },
              });
              const data = await response.json();
              if (data.code === 200) {
                await window.parentKeepwork.call("personalPageStore.savePageData", "maisiAI_userCaps", null, data.data);
                miniGameProxyData.maisiUserCaps = data.data.map((item) => {
                  switch (item.quotaName) {
                    case "è§†è§‰å·¥ä½œè®°å¿†":
                    case "å¬è§‰å·¥ä½œè®°å¿†":
                      item.quotaName = item.quotaName.replace("å·¥ä½œ", "");
                      break;
                    case "çœ‹åˆ†è¾¨":
                      item.quotaName = "è§†åˆ†è¾¨";
                      break;
                    case "çœ‹è®°å¿†":
                      item.quotaName = "è§†è®°å¿†";
                      break;
                  }
                  return item;
                });
                onMessage({ data: miniGameProxyData });
              }
            } catch (_) {}
          }
        }, 300);
      }

      async function getAbilityConfig() {
        try {
          if (abilityConfig) return abilityConfig;
          const response = await fetch(`https://api.keepwork.com/core/v0/repos/${encodeURIComponent("maisi/maisi")}/files/${encodeURIComponent("maisi/maisi/webgames/data/config")}.md`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (response.ok) {
            const config = await response.json();
            const gameList = config.gameList;
            abilityConfig = config.abilityConfig;
            gameList.forEach((game) => {
              game.abilities?.forEach((ability) => {
                if (abilityConfig[ability]) {
                  abilityConfig[ability].games = abilityConfig[ability].games || [];
                  abilityConfig[ability].games.push({
                    name: game.name,
                    title: game.title,
                  });
                }
              });
            });
            return abilityConfig;
          }
        } catch (error) {
          console.error("è·å–èƒ½åŠ›é…ç½®å¤±è´¥:", error);
        }
      }

      async function getMiniGameFinishInfo() {
        try {
          const miniGameFinishInfo = await window.parentKeepwork.call("personalPageStore.loadPageData", "maisiAI", "miniGameFinishInfo");
          console.log("è·å–ç”¨æˆ·æµ‹è¯•æˆç»©:", miniGameFinishInfo);
          return miniGameFinishInfo;
        } catch (error) {
          console.warn("è·å–ç”¨æˆ·æˆç»©å¤±è´¥:", error);
          // const urlParams = new URLSearchParams(window.location.search)
          // const maisiToken = urlParams.get('maisiToken')
          // console.log('ä½¿ç”¨maisiToken:', maisiToken)
          // await window.parentKeepwork.call('setToken', maisiToken)
          // const miniGameFinishInfo = await window.parentKeepwork.call(
          //   'personalPageStore.loadPageData',
          //   'maisiAI',
          //   'miniGameFinishInfo'
          // )
          // console.log('è·å–ç”¨æˆ·æµ‹è¯•æˆç»©:', miniGameFinishInfo)
          // return miniGameFinishInfo
        }
      }

      // é¢„åŠ è½½ä¼˜åŒ–
      function preloadOptimizations() {
        // é¢„è®¡ç®—ä¸€äº›å€¼ä»¥æé«˜æ€§èƒ½
        const screenSize = getScreenSize();

        // ç¼“å­˜DOMå…ƒç´ 
        window.cachedElements = {
          container: document.getElementById("profileContainer"),
          content: document.querySelector(".content"),
          leftPanel: document.querySelector(".left-panel"),
          rightPanel: document.querySelector(".right-panel"),
          radarContainer: document.querySelector(".radar-container"),
        };

        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
        hideLoadingIndicator();
      }

      // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
      function showLoadingIndicator() {
        const loadingDiv = document.querySelector(".loading");
        if (loadingDiv) {
          loadingDiv.style.display = "flex";
        }
      }

      // éšè—åŠ è½½æŒ‡ç¤ºå™¨
      function hideLoadingIndicator() {
        const loadingDiv = document.querySelector(".loading");
        if (loadingDiv) {
          loadingDiv.style.opacity = "0";
          setTimeout(() => {
            loadingDiv.style.display = "none";
          }, 300);
        }
      }

      // é˜²æŠ–å‡½æ•°
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      async function OnClickProfileItem(abilityId) {
        const abilityConfig = await getAbilityConfig();
        const config = abilityConfig[abilityId];
        if (config && config.games) {
          // è¿™é‡Œæš‚æ—¶åªå–ç¬¬ä¸€ä¸ªæ¸¸æˆä¿¡æ¯
          showAbilityModal(config, config.games[0]);
        } else {
          console.warn(`æœªæ‰¾åˆ°èƒ½åŠ›é…ç½®: ${abilityId} ${config.label}`);
        }
      }

      // æ˜¾ç¤ºèƒ½åŠ›è¯¦æƒ…å¼¹æ¡†
      function showAbilityModal(config, gameInfo = null) {
        const modal = document.getElementById("abilityModal");
        const modalAbilityName = document.getElementById("modalAbilityName");
        const modalAbilityDescription = document.getElementById("modalAbilityDescription");
        const gameInfoDiv = document.getElementById("gameInfo");
        const modalGameName = document.getElementById("modalGameName");

        modalAbilityName.textContent = config.label;
        modalAbilityDescription.textContent = config.description;

        // å¤„ç†gameä¿¡æ¯
        if (gameInfo) {
          try {
            modalGameName.textContent = gameInfo.title;
            modalGameName.onclick = function () {
              closeAbilityModal();
              window.parent.postMessage(
                {
                  type: "gameNameClicked",
                  gameInfo: { ...gameInfo, decodeName: gameInfo.title },
                },
                "*"
              );
            };
            gameInfoDiv.style.display = "block";
          } catch (e) {
            console.error("Base64è§£ç å¤±è´¥:", e);
            gameInfoDiv.style.display = "none";
          }
        } else {
          gameInfoDiv.style.display = "none";
        }
        modal.classList.add("show");
        modal.style.display = "flex";
      } // å…³é—­èƒ½åŠ›è¯¦æƒ…å¼¹æ¡†
      function closeAbilityModal() {
        const modal = document.getElementById("abilityModal");
        modal.classList.remove("show");
        modal.style.display = "none";
      }

      // æ˜¾ç¤ºä¿®æ”¹æ˜µç§°å¼¹çª—
      function showEditNicknameModal() {
        const modal = document.getElementById("nicknameModal");
        const input = document.getElementById("nicknameInput");
        const errorDiv = document.getElementById("nicknameError");
        const confirmBtn = document.getElementById("confirmNicknameBtn");

        // é‡ç½®è¡¨å•çŠ¶æ€
        input.value = "";
        input.classList.remove("error");
        errorDiv.style.display = "none";
        confirmBtn.disabled = false;

        modal.classList.add("show");
        modal.style.display = "flex"; // èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
          input.focus();
        }, 100);

        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶æ·»åŠ æ–°çš„å®æ—¶éªŒè¯
        input.removeEventListener("input", handleNicknameInput);
        input.addEventListener("input", handleNicknameInput);
      }

      // æ˜µç§°è¾“å…¥å®æ—¶éªŒè¯å¤„ç†å‡½æ•°
      function handleNicknameInput() {
        const value = this.value.trim();
        const errorDiv = document.getElementById("nicknameError");

        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
        this.classList.remove("error");
        errorDiv.style.display = "none";

        if (value) {
          const length = getStringLength(value);
          if (length > 16) {
            this.classList.add("error");
            errorDiv.textContent = "æ˜µç§°ä¸èƒ½è¶…è¿‡10ä¸ªä¸­æ–‡å­—æˆ–16ä¸ªè‹±æ–‡å­—æ¯";
            errorDiv.style.display = "block";
          }
        }
      }

      // å…³é—­ä¿®æ”¹æ˜µç§°å¼¹çª—
      function closeEditNicknameModal() {
        const modal = document.getElementById("nicknameModal");
        modal.classList.remove("show");
        modal.style.display = "none";
      }

      // ç¡®è®¤ä¿®æ”¹æ˜µç§°
      async function confirmNickname() {
        const input = document.getElementById("nicknameInput");
        const errorDiv = document.getElementById("nicknameError");
        const confirmBtn = document.getElementById("confirmNicknameBtn");
        const nickname = input.value.trim();
        // éªŒè¯æ˜µç§°
        if (!nickname) {
          showNicknameError("æ˜µç§°ä¸èƒ½ä¸ºç©º");
          return;
        }

        // æ£€æŸ¥é•¿åº¦ï¼ˆä¸­æ–‡å­—ç¬¦æŒ‰2ä¸ªå­—ç¬¦è®¡ç®—ï¼‰
        const length = getStringLength(nickname);
        if (length > 16) {
          showNicknameError("æ˜µç§°ä¸èƒ½è¶…è¿‡10ä¸ªä¸­æ–‡å­—æˆ–16ä¸ªè‹±æ–‡å­—æ¯");
          return;
        }

        // ç®€å•çš„æ•æ„Ÿè¯æ£€æŸ¥ï¼ˆå®¢æˆ·ç«¯é¢„æ£€ï¼ŒæœåŠ¡å™¨ç«¯ä¼šæœ‰æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼‰
        const sensitiveWords = ["ç®¡ç†å‘˜", "admin", "ç³»ç»Ÿ", "system"];
        if (sensitiveWords.some((word) => nickname.toLowerCase().includes(word.toLowerCase()))) {
          showNicknameError("æ˜µç§°åŒ…å«æ•æ„Ÿè¯ï¼Œè¯·é‡æ–°è¾“å…¥");
          return;
        }
        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
        confirmBtn.disabled = true;
        confirmBtn.textContent = "ä¿®æ”¹ä¸­...";
        try {
          // è°ƒç”¨Keepwork APIæ›´æ–°æ˜µç§°
          const profile = await window.parentKeepwork.call("get", "/users/profile", {});
          console.log("å½“å‰ç”¨æˆ·ä¿¡æ¯:", profile);
          // Check if nickname has actually changed
          if (profile?.nickname === nickname) {
            // Nickname hasn't changed, close modal and show message
            closeEditNicknameModal();
            showToast("æ˜µç§°æœªæ”¹å˜", "warning");
            return;
          }

          const result = await window.parentKeepwork.call("put", "/users/update", {
            nickname: nickname,
          });

          console.log("æ˜µç§°ä¿®æ”¹APIè¿”å›ç»“æœ:", result);

          // æ£€æŸ¥APIè¿”å›ç»“æœï¼Œ {"code":8,"message":"å†…å®¹ä¸åˆæ³•,åŒ…å«æ•æ„Ÿè¯"}
          if (result === true || result === "true") {
            // æ›´æ–°æ˜¾ç¤ºçš„æ˜µç§°
            const nickNameElement = document.querySelector(".nickName");
            nickNameElement.textContent = `ç”¨æˆ·æ˜µç§°ï¼š${nickname}`;

            // å…³é—­å¼¹çª—
            closeEditNicknameModal();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast("æ˜µç§°ä¿®æ”¹æˆåŠŸï¼", "success");

            // inform parent(paracraft) to update profile data
            window.parent.postMessage({ type: "updateProfile", data: { nickname } }, "*");
          } else {
            // APIè¿”å›å¤±è´¥ç»“æœ - è¿™ç§æƒ…å†µä¸å¤ªå¯èƒ½å‘ç”Ÿï¼Œå› ä¸ºå¤±è´¥é€šå¸¸ä¼šæŠ›å‡ºå¼‚å¸¸
            showNicknameError("æ˜µç§°ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•");
          }
        } catch (error) {
          // æ£€æŸ¥é”™è¯¯æ¶ˆæ¯æ˜¯å¦åŒ…å«JSONæ ¼å¼çš„é”™è¯¯ä¿¡æ¯
          // ä¾‹å¦‚: "Request failed after 1 attempts. Last error: HTTP 400: {"code":3,"message":"ç”¨æˆ·å·²å­˜åœ¨"}"
          let errorData;
          const jsonMatch = error?.message.match(/HTTP \d+:\s*({.*})/);
          if (jsonMatch) {
            try {
              errorData = JSON.parse(jsonMatch[1]);
            } catch (parseError) {
              console.warn("Failed to parse JSON from error message:", parseError);
            }
          }
          console.error("ä¿®æ”¹æ˜µç§°APIè°ƒç”¨å¤±è´¥:", error);

          // å¤„ç†ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
          let errorMessage = "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";

          // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥è‡ªæœåŠ¡å™¨çš„é”™è¯¯å“åº”
          if (errorData && typeof errorData === "object") {
            if (errorData.code) {
              // æ ¹æ®é”™è¯¯ç æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
              switch (errorData.code) {
                case 39:
                  errorMessage = "çŸ¥è¯†è±†ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹æ˜µç§°";
                  break;
                case 40:
                  errorMessage = "æ˜µç§°é•¿åº¦è¶…å‡ºé™åˆ¶";
                  break;
                case 8:
                  errorMessage = "æ˜µç§°åŒ…å«æ•æ„Ÿè¯ï¼Œè¯·é‡æ–°è¾“å…¥";
                  break;
                default:
                  errorMessage = `ä¿®æ”¹å¤±è´¥ (é”™è¯¯ç : ${errorData.code})`;
              }
            } else if (errorData.message) {
              errorMessage = errorData.message;
            }
          }

          showNicknameError(errorMessage);
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          confirmBtn.disabled = false;
          confirmBtn.textContent = "ç¡®è®¤ä¿®æ”¹";
        }
      }

      // æ˜¾ç¤ºæ˜µç§°é”™è¯¯ä¿¡æ¯
      function showNicknameError(message) {
        const input = document.getElementById("nicknameInput");
        const errorDiv = document.getElementById("nicknameError");

        input.classList.add("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      } // è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ï¼ˆä¸­æ–‡å­—ç¬¦æŒ‰2ä¸ªå­—ç¬¦è®¡ç®—ï¼‰
      function getStringLength(str) {
        let length = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          // ä¸­æ–‡å­—ç¬¦èŒƒå›´
          if (char >= 0x4e00 && char <= 0x9fff) {
            length += 2;
          } else {
            length += 1;
          }
        }
        return length;
      }

      // æ˜¾ç¤ºToastæ¶ˆæ¯
      function showToast(message, type = "success", duration = 3000) {
        // ç§»é™¤å·²å­˜åœ¨çš„toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // åˆ›å»ºæ–°çš„toastå…ƒç´ 
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(toast);

        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, duration);
      }

      // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹æ¡†
      document.addEventListener("click", function (event) {
        const modal = document.getElementById("abilityModal");
        if (event.target === modal) {
          closeAbilityModal();
        }

        const nicknameModal = document.getElementById("nicknameModal");
        if (event.target === nicknameModal) {
          closeEditNicknameModal();
        }
      });

      // ESCé”®å…³é—­å¼¹æ¡†
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeAbilityModal();
          closeEditNicknameModal();
        }
      });

      // åˆå§‹åŒ–èƒ½åŠ›é¡¹ç‚¹å‡»äº‹ä»¶
      function initAbilityItemEvents() {
        const abilityItems = document.querySelectorAll(".ability-item");
        abilityItems.forEach((item) => {
          const abilityValueElement = item.querySelector(".ability-value");
          if (abilityValueElement && abilityValueElement.id) {
            const abilityId = abilityValueElement.id;
            item.addEventListener("click", function () {
              OnClickProfileItem(abilityId);
            });

            // æ·»åŠ è§†è§‰åé¦ˆ
            item.style.cursor = "pointer";
          }
        });
      }

      // è§¦æ‘¸äº‹ä»¶å¤„ç†ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
      function addTouchEvents() {
        const abilityItems = document.querySelectorAll(".ability-item");
        const sectionHeaders = document.querySelectorAll(".section-header");

        // ä¸ºèƒ½åŠ›é¡¹æ·»åŠ è§¦æ‘¸äº‹ä»¶
        abilityItems.forEach((item) => {
          let touchStartTime = 0;

          item.addEventListener(
            "touchstart",
            function (e) {
              touchStartTime = Date.now();
              this.style.backgroundColor = "#e3f2fd";
              this.style.transform = "scale(0.98)";

              // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
              if (navigator.vibrate) {
                navigator.vibrate(10);
              }
            },
            { passive: true }
          );

          item.addEventListener(
            "touchend",
            function (e) {
              const touchDuration = Date.now() - touchStartTime;
              const delay = touchDuration < 100 ? 150 : 50;

              setTimeout(() => {
                this.style.backgroundColor = "white";
                this.style.transform = "";
              }, delay);
            },
            { passive: true }
          );

          item.addEventListener(
            "touchcancel",
            function (e) {
              this.style.backgroundColor = "white";
              this.style.transform = "";
            },
            { passive: true }
          );
        });

        // ä¸ºèŠ‚æ ‡é¢˜æ·»åŠ è§¦æ‘¸äº‹ä»¶
        sectionHeaders.forEach((header) => {
          header.addEventListener(
            "touchstart",
            function (e) {
              this.style.transform = "translateY(-1px) scale(0.99)";
            },
            { passive: true }
          );

          header.addEventListener(
            "touchend",
            function (e) {
              setTimeout(() => {
                this.style.transform = "";
              }, 100);
            },
            { passive: true }
          );
        });
      }

      // åŠ¨æ€è°ƒæ•´å¸ƒå±€ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
      function adjustLayout() {
        const elements = window.cachedElements || {
          container: document.getElementById("profileContainer"),
          content: document.querySelector(".content"),
          leftPanel: document.querySelector(".left-panel"),
          rightPanel: document.querySelector(".right-panel"),
          radarContainer: document.querySelector(".radar-container"),
        };

        const screenSize = getScreenSize();

        // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´å¸ƒå±€
        if (screenSize.width < 768) {
          elements.content.style.flexDirection = "column";
          elements.leftPanel.style.width = "100%";
          elements.rightPanel.style.width = "100%";
        } else {
          elements.content.style.flexDirection = "row";
          elements.leftPanel.style.width = "";
          elements.rightPanel.style.width = "";
        }

        // è°ƒæ•´é›·è¾¾å›¾å¤§å°å¹¶é‡æ–°ä¼˜åŒ–Canvasåˆ†è¾¨ç‡
        if (elements.radarContainer && radarChart) {
          // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ€§èƒ½
          requestAnimationFrame(() => {
            const canvas = document.getElementById("radarChart");
            if (canvas) {
              // é‡æ–°ä¼˜åŒ–Canvasé«˜DPIæ˜¾ç¤º
              optimizeCanvasForHighDPI(canvas);
              // è°ƒæ•´å›¾è¡¨å¤§å°
              radarChart.resize();
              // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿æ¸…æ™°åº¦
              radarChart.update("none");
            }
          });
        }
      }

      // é˜²æ­¢åŒå‡»ç¼©æ”¾
      document.addEventListener(
        "touchstart",
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        },
        { passive: false }
      );

      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (e) {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            e.preventDefault();
          }
          lastTouchEnd = now;
        },
        { passive: false }
      );

      // ä¼˜åŒ–Canvasé«˜DPIæ˜¾ç¤º
      function optimizeCanvasForHighDPI(canvas) {
        const ctx = canvas.getContext("2d");
        const devicePixelRatio = window.devicePixelRatio || 1;
        const backingStoreRatio = ctx.webkitBackingStorePixelRatio || ctx.mozBackingStorePixelRatio || ctx.msBackingStorePixelRatio || ctx.oBackingStorePixelRatio || ctx.backingStorePixelRatio || 1;

        const ratio = devicePixelRatio / backingStoreRatio;

        if (devicePixelRatio !== backingStoreRatio) {
          const oldWidth = canvas.width;
          const oldHeight = canvas.height;

          canvas.width = oldWidth * ratio;
          canvas.height = oldHeight * ratio;

          canvas.style.width = oldWidth + "px";
          canvas.style.height = oldHeight + "px";

          ctx.scale(ratio, ratio);
        }

        return ratio;
      }

      function initRadarChart() {
        const canvas = document.getElementById("radarChart");
        const ctx = canvas.getContext("2d");

        // ä¼˜åŒ–Canvasé«˜DPIæ˜¾ç¤º
        // const pixelRatio = optimizeCanvasForHighDPI(canvas);
        const pixelRatio = 1;

        // è®¾ç½®CanvasæŠ—é”¯é½¿
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        radarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: "60åˆ†åŸºå‡†çº¿",
                data: [60, 60, 60, 60, 60],
                backgroundColor: "transparent",
                borderColor: "#ffcc00",
                borderWidth: 2 * pixelRatio,
                borderDash: [5 * pixelRatio, 5 * pixelRatio],
                pointRadius: 0,
                pointHoverRadius: 0,
              },
              {
                label: "90åˆ†åŸºå‡†çº¿",
                data: [90, 90, 90, 90, 90],
                backgroundColor: "transparent",
                borderColor: "#00cc00",
                borderWidth: 2 * pixelRatio,
                borderDash: [5 * pixelRatio, 5 * pixelRatio],
                pointRadius: 0,
                pointHoverRadius: 0,
              },
              {
                label: "æˆ‘çš„èƒ½åŠ›",
                data: [0, 0, 0, 0, 0],
                backgroundColor: "rgba(116, 185, 255, 0.2)",
                borderColor: "rgba(116, 185, 255, 1)",
                borderWidth: 2 * pixelRatio,
                pointBackgroundColor: "rgba(116, 185, 255, 1)",
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(116, 185, 255, 1)",
                pointRadius: 4 * pixelRatio,
                pointHoverRadius: 6 * pixelRatio,
              },
            ],
          },
          options: {
            responsive: true,
            devicePixelRatio: window.devicePixelRatio || 1,
            animation: {
              duration: 1000,
              easing: "easeInOutQuart",
            },
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  font: {
                    size: Math.max(12 * pixelRatio, 12),
                  },
                  padding: 20 * pixelRatio,
                  usePointStyle: true,
                },
              },
            },
            scales: {
              r: {
                startAngle: 0, // è®©é¦–ä¸ªç»´åº¦ä½äºæ­£ä¸Šæ–¹
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20,
                  font: {
                    size: Math.max(10 * pixelRatio, 10),
                  },
                  backdropPadding: 2 * pixelRatio,
                },
                pointLabels: {
                  font: {
                    size: 12,
                    family: "Arial, sans-serif",
                  },
                  padding: 3 * pixelRatio,
                  color: "#333",
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                  lineWidth: 1 * pixelRatio,
                },
                angleLines: {
                  color: "rgba(0, 0, 0, 0.1)",
                  lineWidth: 1 * pixelRatio,
                },
              },
            },
          },
        });

        // å­˜å‚¨pixelRatioä¾›åç»­ä½¿ç”¨
        window.canvasPixelRatio = pixelRatio;
      }

      function updateUserInfo(data) {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        const fields = ["nickName", "userName"];
        fields.forEach((field) => {
          const element = document.querySelector(`.${field}`);
          if (element) {
            const value = data[field];
            if (value !== undefined && value !== null && value !== "") {
              if (field == "nickName") {
                element.textContent = "ç”¨æˆ·æ˜µç§°ï¼š" + decodeURIComponent(escape(atob(value)));
              } else if (field == "userName") {
                element.textContent = "è´¦å·ï¼š" + value;
              }
            } else {
              element.textContent = "-";
            }
          }
        });
      }

      function updateProfile(data) {
        // æ›´æ–°å„é¡¹èƒ½åŠ›å€¼
        const fields = [
          "focusedAttention",
          "selectiveAttention",
          "shiftingAttention",
          "distributedAttention",
          "visualMemory",
          "auditoryMemory",
          "workingMemory",
          "inductiveReasoning",
          "deductiveReasoning",
          "analogicalReasoning",
          "verbalComprehension",
          "abstractReasoning",
          "visualSpatialIntelligence",
          "elaborationStrategy",
          "detailedProcessingStrategy",
          "organizationalStrategy",
          "metacognitivePlanning",
          "metacognitiveMonitoring",
          "metacognitiveRegulation",
          "effortManagement",
          "timeManagement",
          "externalResourceUtilization",
          "growth",
          "autonomy",
          "interaction",
          "interest",
          "recognition",
          "competition",
          "materialReward",
          "emotionalAwareness",
          "emotionalRegulation",
          "responsibility",
          "seriousness",
          "perseverance",
          "creativity",
        ];

        fields.forEach((field) => {
          const element = document.getElementById(field);
          if (element) {
            const fieldData = data[field];
            if (fieldData && typeof fieldData === "object") {
              // æ–°æ•°æ®æ ¼å¼ï¼šåŒ…å«scoreå’Œtest_score
              const score = fieldData.score;
              const testScore = fieldData.test_score;
              if (score !== undefined && score !== null && score !== "" && score !== "0" && score !== 0) {
                if (testScore !== null && testScore !== undefined && score !== testScore) {
                  element.innerHTML = `${score}<span style="color: #888; font-size: 0.9em;">(${testScore})</span>`;
                } else {
                  element.textContent = `${score}`;
                }
                element.classList.remove("empty");

                // æ›´æ–°emojiå›¾æ ‡
                updateEmojiForAbility(field, Number(score), testScore !== null ? Number(testScore) : null);
              } else {
                element.textContent = "-";
                element.classList.add("empty");

                // æ¸…ç©ºemoji
                updateEmojiForAbility(field, null);
              }
            } else {
              // å…¼å®¹æ—§æ•°æ®æ ¼å¼
              const value = fieldData;
              if (value !== undefined && value !== null && value !== "" && value !== "0" && value !== 0) {
                element.textContent = value;
                element.classList.remove("empty");

                // æ›´æ–°emojiå›¾æ ‡
                updateEmojiForAbility(field, Number(value));
              } else {
                element.textContent = "-";
                element.classList.add("empty");

                // æ¸…ç©ºemoji
                updateEmojiForAbility(field, null);
              }
            }
          }
        });

        // é›·è¾¾å›¾æ›´æ–°æ”¹ä¸ºç”±å¤–éƒ¨åŸºäº caps æ•°æ®é©±åŠ¨
      }

      function updateEmojiForAbility(abilityId, score, testScore = null) {
        const emojiElement = document.querySelector(`#${abilityId}`)?.parentElement?.querySelector(".ability-emoji");
        if (!emojiElement) return;

        // ä¼˜å…ˆå¤„ç†æ— åˆ†æ•°æƒ…å†µ
        if (score === null || score === undefined || isNaN(score)) {
          emojiElement.innerHTML = "";
          return;
        }

        // é»˜è®¤æ ¹æ®åˆ†æ•°æ˜¾ç¤º
        let emoji = "";
        let color = "";

        if (score < 60) {
          emoji = "â¬‡";
          color = "#e74c3c";
        } else if (score < 80) {
          emoji = "â¡";
          color = "#f39c12";
        } else {
          emoji = "â¬†";
          color = "#27ae60";
        }

        // å¦‚æœæœ‰testScoreä¸”ä¸scoreä¸åŒï¼Œä¼˜å…ˆæ˜¾ç¤ºå¯¹æ¯”ç»“æœ
        if (testScore !== null && testScore !== undefined && !isNaN(testScore) && score !== testScore) {
          if (testScore > score) {
            emoji = "â¬†";
            color = "#27ae60";
          } else if (testScore < score) {
            emoji = "â¬‡";
            color = "#e74c3c";
          } else {
            emoji = "â¡";
            color = "#f39c12";
          }
        }

        emojiElement.innerHTML = `<span style="color: ${color}; font-weight: bold; font-size: 20px;">${emoji}</span>`;
      }

      function updateRadarChart(data) {
        if (!radarChart) {
          // é¿å…é‡å¤åˆ›å»º intervalï¼Œåªå…è®¸ä¸€ä¸ªç­‰å¾…å®šæ—¶å™¨
          if (!window._radarChartInitWaiting) {
            window._radarChartInitWaiting = true;
            const interval = setInterval(() => {
              if (radarChart) {
                clearInterval(interval);
                window._radarChartInitWaiting = false;
                updateRadarChart(data);
              }
            }, 50);
          }
          return;
        }

        // è®¡ç®—å„ç»´åº¦å¹³å‡å€¼
        const cognitiveAvg = calculateAverage(data, [
          "focusedAttention",
          "selectiveAttention",
          "shiftingAttention",
          "distributedAttention",
          "visualMemory",
          "auditoryMemory",
          "workingMemory",
          "inductiveReasoning",
          "deductiveReasoning",
          "analogicalReasoning",
          "verbalComprehension",
          "abstractReasoning",
          "visualSpatialIntelligence",
        ]);

        const strategyAvg = calculateAverage(data, [
          "elaborationStrategy",
          "detailedProcessingStrategy",
          "organizationalStrategy",
          "metacognitivePlanning",
          "metacognitiveMonitoring",
          "metacognitiveRegulation",
          "effortManagement",
          "timeManagement",
          "externalResourceUtilization",
        ]);

        const motivationAvg = calculateAverage(data, ["growth", "autonomy", "interaction", "interest", "recognition", "competition", "materialReward"]);

        const emotionAvg = calculateAverage(data, ["emotionalAwareness", "emotionalRegulation"]);

        const qualityAvg = calculateAverage(data, ["responsibility", "seriousness", "perseverance", "creativity"]);

        radarChart.data.datasets[2].data = [cognitiveAvg, strategyAvg, motivationAvg, emotionAvg, qualityAvg];
        radarChart.update();
      }

      // åŸºäº caps åˆ—è¡¨ï¼ˆmaisiUserCaps æˆ–åŒç»“æ„ï¼‰åŠ¨æ€è®¡ç®—ç»´åº¦å¹¶æ›´æ–°é›·è¾¾å›¾ï¼ˆæ ¹èŠ‚ç‚¹ä¸ªæ•°=ç»´åº¦æ•°ï¼‰
      function updateRadarChartFromCaps(capsList) {
        if (!Array.isArray(capsList)) return;

        if (!radarChart) {
          if (!window._radarChartInitWaitingCaps) {
            window._radarChartInitWaitingCaps = true;
            const interval = setInterval(() => {
              if (radarChart) {
                clearInterval(interval);
                window._radarChartInitWaitingCaps = false;
                updateRadarChartFromCaps(capsList);
              }
            }, 50);
          }
          return;
        }

        // ä½¿ç”¨ä¸€å±‚æ ‘ï¼šæ¯ä¸ªæ ¹èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªç»´åº¦ï¼ˆè‡ªåŠ¨å¯ä¸º 5 è¾¹æˆ– 6 è¾¹ç­‰ï¼‰
        const tree = buildTree(capsList);
        const labels = [];
        const values = [];

        tree.forEach((root) => {
          const title = root.quotaName || "";
          const nums = [];
          if (Array.isArray(root.children) && root.children.length > 0) {
            root.children.forEach((c) => {
              if (c && typeof c.score === "number" && !isNaN(c.score)) nums.push(c.score);
            });
          } else if (typeof root.score === "number" && !isNaN(root.score)) {
            nums.push(root.score);
          }
          const avg = nums.length ? Math.round(nums.reduce((s, v) => s + v, 0) / nums.length) : 0;
          labels.push(title);
          values.push(avg);
        });

        if (labels.length === 0) return;

        // å°†â€œè®¤çŸ¥èƒ½åŠ›â€æ—‹è½¬åˆ°é¦–ä½ï¼Œç¡®ä¿å‡ºç°åœ¨é¡¶éƒ¨
        const idx = labels.indexOf("è®¤çŸ¥èƒ½åŠ›");
        const rotatedLabels = idx > 0 ? labels.slice(idx).concat(labels.slice(0, idx)) : labels;
        const rotatedValues = idx > 0 ? values.slice(idx).concat(values.slice(0, idx)) : values;

        // åŒæ­¥æ›´æ–°å›¾è¡¨çš„ labels ä¸ä¸‰æ¡æ•°æ®é›†é•¿åº¦
        radarChart.data.labels = rotatedLabels;
        // åŸºå‡†çº¿é•¿åº¦åŒ¹é…
        radarChart.data.datasets[0].data = Array(rotatedLabels.length).fill(60);
        radarChart.data.datasets[1].data = Array(rotatedLabels.length).fill(90);
        radarChart.data.datasets[2].data = rotatedValues;
        radarChart.update();
      }

      function getDimensionIndex(sectionClass) {
        switch (sectionClass) {
          case "cognitive-section":
            return 0;
          case "strategy-section":
            return 1;
          case "motivation-section":
            return 2;
          case "emotion-section":
            return 3;
          case "quality-section":
            return 4;
          default:
            return -1;
        }
      }

      function calculateAverage(data, fields) {
        const validValues = fields
          .map((field) => data[field].score)
          .filter((value) => value !== undefined && value !== null && value !== "" && !isNaN(value))
          .map((value) => Number(value));

        if (validValues.length === 0) return 0;
        return Math.round(validValues.reduce((sum, value) => sum + value, 0) / validValues.length);
      }

      /**
       * å°†æ‰å¹³æ•°æ®è½¬ä¸ºæ ‘ç»“æ„
       * - çˆ¶å­å…³ç³»ï¼šquotaPid â†’ quotaId
       * - quotaPid ä¸º 0 æˆ–æœªæ‰¾åˆ°çˆ¶èŠ‚ç‚¹çš„è§†ä¸ºæ ¹
       * - é»˜è®¤å¯¹æ¯å±‚æŒ‰ depthã€quotaId å‡åºæ’åº
       * @param {Item[]} list
       * @returns {(Item & { children: any[] })[]}
       */
      function buildTree(list) {
        const map = new Map();
        const roots = [];

        // é¢„åˆ›å»ºèŠ‚ç‚¹
        for (const it of list) {
          map.set(it.quotaId, { ...it, children: [] });
        }

        // æ„å»ºçˆ¶->å­æ˜ å°„ï¼ˆä½¿ç”¨åŸå§‹å±‚çº§å…³ç³»ï¼‰
        const idToChildren = new Map();
        for (const node of map.values()) {
          const pid = node.quotaPid;
          if (pid && map.has(pid)) {
            if (!idToChildren.has(pid)) idToChildren.set(pid, []);
            idToChildren.get(pid).push(node);
          }
        }

        // æ ¹ï¼šæ— çˆ¶æˆ–çˆ¶ä¸å­˜åœ¨
        for (const node of map.values()) {
          const pid = node.quotaPid;
          if (!pid || !map.has(pid)) {
            roots.push(node);
          }
        }

        // æ”¶é›†æŸä¸ªçˆ¶èŠ‚ç‚¹ä¸‹æ•´æ£µå­æ ‘çš„â€œæœ«çº§å¶å­â€ï¼ˆæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼‰
        const collectLeaves = (startId) => {
          const leaves = [];
          const stack = (idToChildren.get(startId) || []).slice();
          const visited = new Set();
          while (stack.length) {
            const cur = stack.pop();
            if (!cur || visited.has(cur.quotaId)) continue;
            visited.add(cur.quotaId);
            const kids = idToChildren.get(cur.quotaId);
            if (kids && kids.length) {
              // ç»§ç»­å‘ä¸‹
              for (const k of kids) stack.push(k);
            } else {
              // æ²¡æœ‰æ›´æ·±å±‚å­©å­ï¼Œå³ä¸ºæœ«çº§å¶å­
              leaves.push(cur);
            }
          }
          return leaves;
        };

        // ä»…æŒ‚è½½ä¸€å±‚ï¼šæ¯ä¸ªæ ¹èŠ‚ç‚¹çš„ children ä¸ºå…¶æ•´æ£µå­æ ‘çš„æœ«çº§å¶å­
        for (const r of roots) {
          r.children = collectLeaves(r.quotaId);

          // æŒ‰â€œç›´æ¥ä¸Šçº§â€ä¸ºâ€œæ€ç»´èƒ½åŠ›â€æ¥æ ‡è®°æœ«çº§å­é¡¹éšè—åˆ†æ•°ï¼ˆä¸Šçº§ä¸ä¸€å®šæ˜¯æ ¹ï¼‰
          if (Array.isArray(r.children)) {
            r.children.forEach((ch) => {
              if (!ch) return;
              const parent = map.get(ch.quotaPid);
              if (!parent) return;
              const isThinkingParent = parent.quotaName === "æ€ç»´èƒ½åŠ›" || parent.levelName === "æ€ç»´èƒ½åŠ›";
              if (isThinkingParent) ch.hideScore = true;
            });
          }
        }

        // æ’åºï¼šæ ¹ä¸å…¶å¶å­å­èŠ‚ç‚¹
        const sortArr = (arr) => arr.sort((a, b) => a.depth - b.depth || a.quotaId - b.quotaId);
        sortArr(roots);
        for (const r of roots) sortArr(r.children);

        return roots;
      }

      /**
       * å°†æ ‘æ•°æ®æ¸²æŸ“åˆ°å³ä¾§é¢æ¿ï¼ˆè¦†ç›–åŸæœ‰å†…å®¹ï¼‰
       * @param {Array} tree
       */
      function renderTreeToRightPanel(tree) {
        const rightPanel = document.querySelector(".right-panel");
        if (!rightPanel) return;
        // è¦†ç›–ç°æœ‰å†…å®¹
        rightPanel.innerHTML = "";

        const frag = document.createDocumentFragment();
        const handled = new Set();
        // æ”¯æŒå¤šç»„é¡¶å±‚åŒºå—åŒæ’æ˜¾ç¤ºï¼ˆæ¯ç»„å¯åŒ…å«å¤šä¸ªæŒ‡æ ‡ï¼Œæ•´ç»„å¹¶æ’å±•ç¤ºï¼‰
        const rowGroups = [
          // æ¯ä¸ªå­æ•°ç»„ä»£è¡¨ä¸€è¡Œå¯å¹¶æ’æ˜¾ç¤ºçš„é¡¶å±‚æŒ‡æ ‡åç§°é›†åˆ
          ["è¿åŠ¨åè°ƒ", "æƒ…ç»ªèƒ½åŠ›"],
          ["æƒ…ç»ªæ™ºåŠ›", "å­¦ä¹ å“è´¨", "å­¦ä¹ ç›¸å…³æ€§æ ¼"],
        ];

        // 1) ä¿è¯â€œè®¤çŸ¥èƒ½åŠ›â€æ€»åœ¨ç¬¬ä¸€è¡Œæ˜¾ç¤º
        const cognitiveNode = tree.find((n) => n.quotaName === "è®¤çŸ¥èƒ½åŠ›");
        if (cognitiveNode) {
          frag.appendChild(createSectionFromNode(cognitiveNode));
          handled.add(cognitiveNode.quotaId);
        }

        for (let i = 0; i < tree.length; i++) {
          const node = tree[i];
          if (handled.has(node.quotaId)) continue;

          // è‹¥è¯¥èŠ‚ç‚¹å±äºæŸä¸€è¡Œåˆ†ç»„ï¼Œåˆ™å°†è¯¥ç»„å†…æœªå¤„ç†çš„æ‰€æœ‰èŠ‚ç‚¹ä¸€èµ·å¹¶æ’å±•ç¤º
          const group = rowGroups.find((g) => g.includes(node.quotaName));
          if (group) {
            const groupNodes = group.map((name) => tree.find((n) => n.quotaName === name)).filter((n) => n && !handled.has(n.quotaId));

            if (groupNodes.length > 0) {
              const row = document.createElement("div");
              row.className = "section-row";
              groupNodes.forEach((n) => {
                row.appendChild(createSectionFromNode(n));
                handled.add(n.quotaId);
              });
              frag.appendChild(row);
              continue;
            }
          }

          // ä¸åœ¨ä»»ä½•åˆ†ç»„ä¸­ï¼Œæˆ–åˆ†ç»„å†…å…¶ä½™æˆå‘˜ä¸å­˜åœ¨æ—¶ï¼Œå•ç‹¬æ¸²æŸ“
          frag.appendChild(createSectionFromNode(node));
          handled.add(node.quotaId);
        }
        rightPanel.appendChild(frag);

        // åˆ†é…å”¯ä¸€çš„å¤´éƒ¨é¢œè‰²ï¼Œè®¤çŸ¥èƒ½åŠ›å›ºå®šç´«è‰²ï¼Œå…¶å®ƒé¿å…ä½¿ç”¨ç´«è‰²
        try {
          applyUniqueHeaderColors(rightPanel);
        } catch (_) {}

        // æ–°å†…å®¹æ³¨å…¥åï¼Œé‡æ–°ç»‘å®šäº‹ä»¶
        try {
          initAbilityItemEvents && initAbilityItemEvents();
        } catch (_) {}
        try {
          if (isTouch) addTouchEvents && addTouchEvents();
        } catch (_) {}
      }

      // ä¸ºæ¯ä¸ª section-header åˆ†é…å”¯ä¸€é¢œè‰²ï¼ˆè¶…å‡ºè°ƒè‰²æ¿æ•°é‡åå¾ªç¯ï¼‰
      function applyUniqueHeaderColors(container) {
        const purple = "linear-gradient(135deg, #8b5cf6, #7c3aed)";
        // ä¸åŒ…å«ç´«è‰²çš„è°ƒè‰²æ¿
        const palette = [
          "linear-gradient(135deg, #3b82f6, #2563eb)", // è“
          "linear-gradient(135deg, #10b981, #059669)", // ç»¿
          "linear-gradient(135deg, #f59e0b, #d97706)", // æ©™
          "linear-gradient(135deg, #ef4444, #dc2626)", // çº¢
          "linear-gradient(135deg, #ec4899, #db2777)", // ç²‰
          "linear-gradient(135deg, #14b8a6, #0d9488)", // é’
          "linear-gradient(135deg, #22c55e, #16a34a)", // ç¿ 
          "linear-gradient(135deg, #06b6d4, #0891b2)", // æ¹–è“
          "linear-gradient(135deg, #f43f5e, #e11d48)", // ç«çº¢
          "linear-gradient(135deg, #64748b, #475569)", // è“ç°
        ];
        const headers = [...container.querySelectorAll(".section-header")];

        // å…ˆç»™â€œè®¤çŸ¥èƒ½åŠ›â€è®¾ç½®ç´«è‰²
        let paletteIndex = 0;
        headers.forEach((h) => {
          if (h.textContent && h.textContent.trim() === "è®¤çŸ¥èƒ½åŠ›") {
            h.style.background = purple;
            h.style.color = "#fff";
          }
        });

        // å…¶å®ƒ header ä¾æ¬¡åˆ†é…éç´«è‰²
        headers.forEach((h) => {
          if (h.textContent && h.textContent.trim() === "è®¤çŸ¥èƒ½åŠ›") return;
          const color = palette[paletteIndex % palette.length];
          paletteIndex++;
          h.style.background = color;
          h.style.color = "#fff";
        });
      }

      // æ ¹æ®æ ‡é¢˜å…³é”®å­—æ˜ å°„åˆ°åŸæœ¬çš„æ ·å¼ç±»ï¼Œç”¨äºç»™ section-header ç€è‰²
      function getSectionClassByName(name = "") {
        const n = String(name);
        if (/è®¤çŸ¥|æ€ç»´|æ³¨æ„|è®°å¿†|æ¨ç†|ç†è§£|ç©ºé—´/.test(n)) return "cognitive-section";
        if (/ç­–ç•¥|ç»„ç»‡|å…ƒè®¤çŸ¥|æ—¶é—´|åŠªåŠ›|èµ„æº/.test(n)) return "strategy-section";
        if (/åŠ¨æœº|æˆé•¿|è‡ªä¸»|äº’åŠ¨|å…´è¶£|è®¤å¯|ç«äº‰|ç‰©è´¨/.test(n)) return "motivation-section";
        if (/æƒ…ç»ª|æƒ…æ„Ÿ/.test(n)) return "emotion-section";
        if (/å“è´¨|è´£ä»»|ä¸¥è°¨|åšæ¯…|åˆ›æ–°/.test(n)) return "quality-section";
        return "cognitive-section"; // é»˜è®¤ç»™ä¸ªé€šç”¨çš„é…è‰²
      }

      /**
       * é€’å½’åˆ›å»ºåŒºå—ï¼šæœ‰å­èŠ‚ç‚¹çš„ä½œä¸ºä¸€ä¸ª sectionï¼Œæ— å­èŠ‚ç‚¹çš„ä½œä¸ºä¸€ä¸ª ability-item
       * @param {any} node
       * @returns {HTMLElement}
       */
      function createSectionFromNode(node) {
        // è‹¥æ— å­èŠ‚ç‚¹ï¼Œä½œä¸ºå¶å­æ¸²æŸ“
        if (!node.children || node.children.length === 0) {
          return createAbilityItem(node);
        }

        const section = document.createElement("div");
        // æ ¹æ®æ ‡é¢˜æ˜ å°„åˆ°ä¸åŒçš„ä¸»é¢˜ç±»ï¼Œä»¥ç»§æ‰¿ .section-header çš„ä¸åŒé¢œè‰²
        section.className = "ability-section " + getSectionClassByName(node.quotaName);

        const header = document.createElement("div");
        header.className = "section-header";
        header.textContent = node.quotaName || "";
        section.appendChild(header);

        // è®¤çŸ¥èƒ½åŠ›ï¼šå°†æœ«çº§æŒ‡æ ‡åˆ†æˆä¸¤è¡Œæ˜¾ç¤º
        if (node.quotaName === "è®¤çŸ¥èƒ½åŠ›" && node.children.length > 6) {
          const wrapper = document.createElement("div");
          wrapper.className = "section-content--stack";

          const row1 = document.createElement("div");
          row1.className = "section-content-row";
          const row2 = document.createElement("div");
          row2.className = "section-content-row";

          const mid = Math.ceil(node.children.length / 2);
          const first = node.children.slice(0, mid);
          const second = node.children.slice(mid);

          first.forEach((child) => row1.appendChild(createAbilityItem(child)));
          second.forEach((child) => row2.appendChild(createAbilityItem(child)));

          wrapper.appendChild(row1);
          wrapper.appendChild(row2);
          section.appendChild(wrapper);
          section.classList.add("renzhi-section");
        } else {
          const content = document.createElement("div");
          content.className = "section-content";
          node.children.forEach((child) => {
            content.appendChild(createAbilityItem(child));
          });
          section.appendChild(content);
        }
        return section;
      }

      /**
       * åˆ›å»ºå¶å­èŠ‚ç‚¹è¡¨ç¤ºå—
       * @param {any} node
       * @returns {HTMLElement}
       */
      function createAbilityItem(node) {
        const item = document.createElement("div");
        item.className = "ability-item";

        const label = document.createElement("div");
        label.className = "ability-label";
        label.textContent = node.quotaName || "";
        // ç­‰çº§å¾½æ ‡ï¼ˆå¯é€‰ï¼‰
        if (node.levelName) {
          const levelTag = document.createElement("span");
          levelTag.style.marginLeft = "6px";
          levelTag.style.fontSize = "12px";
          levelTag.style.color = "#666";
          levelTag.textContent = `(${node.levelName})`;
          label.appendChild(levelTag);
        }

        const scoreContainer = document.createElement("div");
        scoreContainer.className = "ability-score-container";

        const value = document.createElement("div");
        value.className = "ability-value";
        // const shouldHide = node && node.hideScore === true
        const shouldHide = ["æ¯”è¾ƒå’Œåˆ†ç±»", "å¯¹åº”æ€ç»´", "ç©ºé—´æ€ç»´", "åºåˆ—æ¨ç†", "æ•°é‡æ¨ç†"].includes(node.quotaName);
        const hasScore = !shouldHide && node.score !== undefined && node.score !== null && node.score !== "";
        value.textContent = hasScore ? String(node.score) : "-";
        if (node.totalImprovement && node.totalImprovement > 0) {
          value.innerHTML = `${value.textContent}<span style="color: #888; font-size: 0.9em;">+${node.totalImprovement}</span>`;
        }
        if (!hasScore) value.classList.add("empty");

        const emoji = document.createElement("div");
        emoji.className = "ability-emoji";
        // æ ¹æ® levelName å±•ç¤ºè¶‹åŠ¿å›¾æ ‡ï¼šå¾…æå‡ / è‰¯å¥½ / ä¼˜å¼‚
        {
          const lvl = (node.levelName || "").trim();
          let emojiChar = "";
          let color = "";
          if (lvl === "å¾…æå‡") {
            emojiChar = "â¬‡";
            color = "#e74c3c";
          } else if (lvl === "è‰¯å¥½") {
            emojiChar = "â¡";
            color = "#f39c12";
          } else if (lvl === "ä¼˜å¼‚") {
            emojiChar = "â¬†";
            color = "#27ae60";
          }
          if (emojiChar) {
            emoji.style.color = color;
            emoji.style.fontWeight = "bold";
            emoji.style.fontSize = "20px";
            emoji.textContent = emojiChar;
          }
        }

        scoreContainer.appendChild(value);
        scoreContainer.appendChild(emoji);

        item.appendChild(label);
        item.appendChild(scoreContainer);

        return item;
      }

      function onMessage(e) {
        const data = e.data || {};
        console.log("æ¥æ”¶åˆ°æ¶ˆæ¯:", data);
        if (data.type === "miniGameProxyDataResponse") {
          // console.log('miniGameProxyDataResponse:', data)
          if (Object.keys(miniGameProxyData).length === 0) {
            miniGameProxyData = data;
          }
          const abilityConfig = data.abilityConfig;
          const miniGameFinishInfo = data.miniGameFinishInfo;

          // æ„å»ºprofileDataå¯¹è±¡ï¼ŒåŸºäºminiGameFinishInfoå’ŒabilityConfig
          const profileData = {};

          // éå†æ¯ä¸ªèƒ½åŠ›
          for (const [abilityKey, abilityInfo] of Object.entries(abilityConfig)) {
            let gameMaxScore = 0;
            let hasValidGameScore = false;

            // éå†è¯¥èƒ½åŠ›å…³è”çš„æ¸¸æˆï¼Œè®¡ç®—æ¸¸æˆæœ€é«˜åˆ†
            if (abilityInfo.games && Array.isArray(abilityInfo.games)) {
              for (const game of abilityInfo.games) {
                const gameResult = miniGameFinishInfo[game.name];
                if (gameResult && gameResult.completed && typeof gameResult.score === "number") {
                  gameMaxScore = Math.max(gameMaxScore, gameResult.score);
                  hasValidGameScore = true;
                }
              }
            }

            // ä»dataæ•°ç»„ä¸­è·å–å¯¹åº”çš„scoreå€¼
            const dataItem = data.maisiUserCaps?.find((item) => item.quotaName === abilityInfo.label);
            const dataScore = dataItem ? dataItem.score : 0;

            // è®¾ç½®è¯¥èƒ½åŠ›çš„åˆ†æ•°
            profileData[abilityKey] = {
              score: dataScore || 0, // ä½¿ç”¨dataæ•°ç»„ä¸­çš„scoreå€¼
              test_score: hasValidGameScore ? gameMaxScore : null, // ä½¿ç”¨æ¸¸æˆæœ€é«˜åˆ†ï¼Œæ²¡æœ‰åˆ™ä¸ºnull
              totalImprovement: dataItem ? dataItem.totalImprovement || 0 : 0,
            };
          }

          // console.log('ä»æ¸¸æˆæˆç»©æ„å»ºçš„profileData:', profileData)

          // è°ƒç”¨updateProfileæ›´æ–°ç•Œé¢
          updateProfile(profileData);
          // åŸºäº maisiUserCaps åŠ¨æ€æ›´æ–°é›·è¾¾å›¾
          if (Array.isArray(data.maisiUserCaps)) {
            data.maisiUserCaps = data.maisiUserCaps.filter((item) => typeof item === "object");
            updateRadarChartFromCaps(data.maisiUserCaps);
          }

          // åŸºäº maisiUserCaps æ¸²æŸ“æ ‘å¹¶è¦†ç›–å³ä¾§é¢æ¿
          if (Array.isArray(data.maisiUserCaps)) {
            try {
              const tree = buildTree(data.maisiUserCaps);
              console.log("æ„å»ºçš„æ ‘ç»“æ„:", tree);
              renderTreeToRightPanel(tree);
            } catch (e) {
              console.warn("æ¸²æŸ“æ ‘ç»“æ„å¤±è´¥:", e);
            }
          }

          try {
            const rp = document.querySelector(".right-panel");
            if (rp) applyUniqueHeaderColors(rp);
          } catch (_) {}

          const userInfo = data.maisiUserInfo || data.keepworkUserInfo;
          const nickNameElement = document.querySelector(".nickName");
          const userNameElement = document.querySelector(".userName");
          nickNameElement.textContent = `ç”¨æˆ·æ˜µç§°ï¼š${userInfo.name || userInfo.nickName || userInfo.username || "æœªçŸ¥ç”¨æˆ·"}`;
          userNameElement.textContent = `è´¦å·ï¼š${userInfo.phone || userInfo.username || "æœªçŸ¥è´¦å·"}`;
        }
      }
      window.addEventListener("message", onMessage);

      if (window.parent && window.parent.parent && window.parent !== window.parent.parent) {
        window.parent.parent.postMessage(
          {
            type: "getMiniGameProxyData",
          },
          "*"
        );
      }
    </script>
  </body>
</html>
