<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç§‘äº”å­æ£‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .game-board {
            position: relative;
            width: 480px;
            height: 480px;
            background-color: #deb887;
            border: 3px solid #8b4513;
            margin: 0 auto;
        }
        
        /* æ‰‹æœºç«¯æ£‹ç›˜é€‚é… */
        @media (max-width: 640px) {
            .game-board {
                width: min(90vw, 360px);
                height: min(90vw, 360px);
                max-width: 360px;
                max-height: 360px;
            }
            
            .board-cell {
                width: calc(min(90vw, 360px) / 15);
                height: calc(min(90vw, 360px) / 15);
            }
            
            .piece {
                width: calc(min(90vw, 360px) / 15 - 4px);
                height: calc(min(90vw, 360px) / 15 - 4px);
                font-size: calc(min(90vw, 360px) / 30);
            }
            
            .science-grid {
                width: calc(min(90vw, 360px) / 18);
                height: calc(min(90vw, 360px) / 18);
                font-size: calc(min(90vw, 360px) / 40);
            }
        }
        
        .board-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .board-cell {
            position: absolute;
            width: 32px;
            height: 32px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        .board-cell:hover:not(.has-piece) {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .piece {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 15;
        }
        
        .piece.black { 
            background-color: #000; 
            color: #fff;
        }
        
        .piece.white { 
            background-color: #fff; 
            color: #000;
        }
        
        .piece.black.science { 
            background-color: #000;
            color: #ffd700;
            font-size: 14px;
            border: 2px solid #333;
        }
        
        .piece.white.science { 
            background-color: #fff;
            color: #ffd700;
            font-size: 14px;
            border: 2px solid #333;
        }
        
        .science-grid {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transform: translate(-50%, -50%);
            z-index: 5;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
        }
        
        .science-grid.chinese { 
            background-color: #ef4444; 
            color: white;
        }
        
        .science-grid.math { 
            background-color: #3b82f6; 
            color: white;
        }
        
        .science-grid.english { 
            background-color: #10b981; 
            color: white;
        }

        .piece-selector-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid transparent;
        }

        .piece-selector-container.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }

        .piece-selector {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .piece-selector:hover {
            transform: scale(1.1);
        }

        .piece-selector.black {
            background-color: #000;
            color: #fff;
        }

        .piece-selector.white {
            background-color: #fff;
            color: #000;
        }

        .piece-selector.black.science {
            background-color: #000;
            color: #ffd700;
            font-size: 16px;
        }

        .piece-selector.white.science {
            background-color: #fff;
            color: #ffd700;
            font-size: 16px;
        }

        .piece-selector.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* æ‰‹æœºç«¯å¸ƒå±€ä¼˜åŒ– */
        @media (max-width: 640px) {
            .max-w-6xl {
                max-width: 100% !important;
            }
            
            body {
                padding: 8px !important;
            }
            
            .game-container {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .piece-selector-container {
                flex-direction: column;
                gap: 4px;
                padding: 6px;
            }
            
            .piece-selector-container span {
                font-size: 12px;
            }
            
            .control-bar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .control-bar > div {
                text-align: center;
            }
            
            .piece-selectors {
                display: flex;
                justify-content: center;
                gap: 16px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto game-container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">å­¦ç§‘äº”å­æ£‹</h1>
        
        <!-- æ¸¸æˆæ§åˆ¶æ  -->
        <div class="bg-white rounded-lg p-4 mb-6 shadow">
            <div class="flex justify-between items-center control-bar">
                <div class="text-lg font-semibold">
                    å½“å‰ç©å®¶: <span id="currentPlayer" class="text-blue-600">é»‘æ–¹</span>
                </div>
                
                <!-- æ£‹å­é€‰æ‹©å™¨ -->
                <div class="flex items-center space-x-4 piece-selectors">
                    <!-- æ™®é€šæ£‹å­é€‰æ‹© -->
                    <div id="normalPieceContainer" class="piece-selector-container selected">
                        <div id="normalPieceSelector" class="piece-selector black">
                            â—
                        </div>
                        <span class="text-sm font-medium">æ™®é€šå­</span>
                    </div>
                    
                    <!-- ç§‘å­¦æ£‹å­é€‰æ‹© -->
                    <div id="sciencePieceContainer" class="piece-selector-container">
                        <div id="sciencePieceSelector" class="piece-selector black science">
                            â˜…
                        </div>
                        <span class="text-sm font-medium">ç§‘å­¦å­</span>
                        <span id="scienceCount" class="text-xs text-gray-500">(å‰©ä½™: 2)</span>
                    </div>
                </div>
                
                <div>
                    <button id="resetBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>

        <!-- æ£‹ç›˜ -->
        <div class="flex justify-center mb-6">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
                <div id="gameBoard" class="game-board">
                    <!-- æ£‹ç›˜çº¿æ¡ -->
                    <svg class="board-lines" width="100%" height="100%">
                        <!-- å‚ç›´çº¿ -->
                        <defs>
                            <pattern id="grid" width="32" height="32" patternUnits="userSpaceOnUse">
                                <path d="M 32 0 L 0 0 0 32" fill="none" stroke="#8b4513" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <!-- æ¨ªçº¿ -->
                        <g id="horizontal-lines"></g>
                        <!-- ç«–çº¿ -->
                        <g id="vertical-lines"></g>
                        <!-- æ˜Ÿä½ -->
                        <g id="star-points"></g>
                    </svg>
                    <!-- æ£‹ç›˜æ ¼å­ -->
                    <div id="board-cells"></div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç»Ÿè®¡ -->
        <div class="bg-white rounded-lg p-4 mb-6 shadow">
            <h3 class="font-semibold mb-3 text-center">æ¸¸æˆç»Ÿè®¡</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold mb-2 flex items-center">
                        <div class="w-4 h-4 bg-black rounded-full mr-2"></div>
                        é»‘æ–¹
                    </h4>                    <div class="space-y-1 text-sm">
                        <div>å¾—åˆ†: <span id="blackScore" class="font-bold text-lg">0</span></div>
                        <div>ç§‘å­¦å­å‰©ä½™: <span id="blackScience" class="font-bold">2</span></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold mb-2 flex items-center">
                        <div class="w-4 h-4 bg-white border-2 border-gray-800 rounded-full mr-2"></div>
                        ç™½æ–¹
                    </h4>                    <div class="space-y-1 text-sm">
                        <div>å¾—åˆ†: <span id="whiteScore" class="font-bold text-lg">0</span></div>
                        <div>ç§‘å­¦å­å‰©ä½™: <span id="whiteScience" class="font-bold">2</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆè®¾ç½® -->
        <div class="bg-white rounded-lg p-4 mb-6 shadow">
            <h3 class="font-semibold mb-3">æ¸¸æˆè®¾ç½®</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="flex items-center space-x-3">
                    <label class="text-sm font-medium">ç§‘å­¦æ ¼æ•°é‡:</label>
                    <input type="range" id="scienceGridCount" min="0" max="30" value="12" class="flex-1">
                    <span id="scienceGridValue" class="text-sm font-bold w-8">12</span>
                </div>
                <div class="flex items-center space-x-3">
                    <label class="text-sm font-medium">ç§‘å­¦å­æ•°é‡:</label>
                    <input type="range" id="sciencePieceCount" min="0" max="5" value="2" class="flex-1">
                    <span id="sciencePieceValue" class="text-sm font-bold w-8">2</span>
                </div>
            </div>
            <div class="mt-3 text-center">
                <button id="applySettings" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">åº”ç”¨è®¾ç½®</button>
            </div>
        </div>

        <!-- æ¸¸æˆè§„åˆ™ -->
        <div class="bg-white rounded-lg p-6 shadow">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æ¸¸æˆè§„åˆ™</h2>
            <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-700">
                <div>
                    <h3 class="font-semibold mb-2">åŸºæœ¬è§„åˆ™ï¼š</h3>
                    <ul class="space-y-1">
                        <li>â€¢ è½®æµä¸‹æ£‹ï¼Œè¿æˆäº”å­çº¿è·å¾—åˆ†æ•°</li>
                        <li>â€¢ åœ¨ç§‘å­¦æ ¼ä¸‹æ£‹éœ€è¦ç­”å¯¹ç›¸åº”é¢˜ç›®</li>
                        <li>â€¢ ä½¿ç”¨ç§‘å­¦å­éœ€è¦ç­”é¢˜ï¼ˆä»»æ„å­¦ç§‘ï¼‰</li>
                        <li>â€¢ ç­”é”™éœ€è¦æ¢ä½ç½®ä¸‹æ™®é€šæ£‹å­</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">è®¡åˆ†è§„åˆ™ï¼š</h3>
                    <ul class="space-y-1">
                        <li>â€¢ æ™®é€šäº”å­è¿çº¿ï¼š<span class="font-bold text-blue-600">1åˆ†</span></li>
                        <li>â€¢ å«2ä¸ªåŒç±»ç§‘å­¦æ ¼/ç§‘å­¦å­ï¼š<span class="font-bold text-red-600">2åˆ†</span></li>
                        <li>â€¢ ç§‘å­¦æ ¼ï¼š<span class="bg-red-500 text-white px-1 rounded">è¯­</span> <span class="bg-blue-500 text-white px-1 rounded">æ•°</span> <span class="bg-green-500 text-white px-1 rounded">å¤–</span></li>
                        <li>â€¢ æ€»åˆ†é«˜è€…è·èƒœ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­”é¢˜å¼¹çª— -->
    <div id="questionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">ç­”é¢˜æŒ‘æˆ˜</h3>
            <div class="mb-4">
                <div class="text-sm text-gray-600 mb-2">å­¦ç§‘ï¼š<span id="questionSubject" class="font-semibold"></span></div>
                <div id="questionText" class="text-base mb-4"></div>
                <div id="questionOptions" class="space-y-2">
                    <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelAnswer" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button id="submitAnswer" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">æäº¤</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-center">æ¸¸æˆç»“æŸ</h3>
            <div id="gameResult" class="text-center mb-4"></div>
            <div class="flex justify-center">
                <button id="newGameBtn" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">å†æ¥ä¸€å±€</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const gameConfig = {
            scienceGridCount: 12,
            sciencePieceCount: 2
        };

        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            board: Array(15).fill().map(() => Array(15).fill(null)),
            currentPlayer: 'black',
            selectedPieceType: 'normal', // 'normal' æˆ– 'science'
            blackScore: 0,
            whiteScore: 0,
            blackScience: 2,
            whiteScience: 2,
            blackCorrect: 0,
            blackTotal: 0,
            whiteCorrect: 0,
            whiteTotal: 0,
            scienceGrids: [],
            selectedAnswer: null,
            pendingMove: null,
            scoredLines: new Set()
        };

        // é¢˜åº“
        const questionBank = {
            chinese: [
                { question: "ä¸‹åˆ—å“ªä¸ªå­—çš„è¯»éŸ³æ­£ç¡®ï¼Ÿ", options: ["qiÃ¡ngå£®", "jiÃ ngå£®", "zhuÃ ngå£®", "chuÃ¡ngå£®"], answer: 2 },
                { question: "\"æ˜¥èš•åˆ°æ­»ä¸æ–¹å°½\"çš„ä¸‹ä¸€å¥æ˜¯ï¼Ÿ", options: ["èœ¡ç‚¬æˆç°æ³ªå§‹å¹²", "èœ¡çƒ›æˆç°æ³ªå§‹å¹²", "æ˜¥èš•åˆ°æ­»ä¸æ–¹å°½", "çº¢é¢œå¼ƒè½©å†•"], answer: 0 },
                { question: "\"ä¸‰é¡¾èŒ…åº\"è¯´çš„æ˜¯å“ªä½å†å²äººç‰©ï¼Ÿ", options: ["åˆ˜å¤‡", "å…³ç¾½", "å¼ é£", "è¯¸è‘›äº®"], answer: 0 },
                { question: "ä¸‹åˆ—è¯è¯­ä¸­ï¼Œé”™åˆ«å­—æ˜¯ï¼Ÿ", options: ["å†æ¥å†å‰", "å†æ¥å†åŠ±", "åšæŒä¸æ‡ˆ", "æŒä¹‹ä»¥æ’"], answer: 1 },
                { question: "\"åºŠå‰æ˜æœˆå…‰\"çš„ä½œè€…æ˜¯ï¼Ÿ", options: ["æœç”«", "æç™½", "ç‹ç»´", "å­Ÿæµ©ç„¶"], answer: 1 }
            ],
            math: [
                { question: "25 + 17 = ?", options: ["42", "41", "43", "40"], answer: 0 },
                { question: "ä¸€ä¸ªä¸‰è§’å½¢çš„å†…è§’å’Œæ˜¯å¤šå°‘åº¦ï¼Ÿ", options: ["90Â°", "180Â°", "270Â°", "360Â°"], answer: 1 },
                { question: "12 Ã— 8 = ?", options: ["84", "96", "88", "92"], answer: 1 },
                { question: "åœ†çš„é¢ç§¯å…¬å¼æ˜¯ï¼Ÿ", options: ["Ï€r", "2Ï€r", "Ï€rÂ²", "2Ï€rÂ²"], answer: 2 },
                { question: "64 Ã· 8 = ?", options: ["6", "7", "8", "9"], answer: 2 }
            ],
            english: [
                { question: "\"Hello\"çš„ä¸­æ–‡æ„æ€æ˜¯ï¼Ÿ", options: ["å†è§", "ä½ å¥½", "è°¢è°¢", "å¯¹ä¸èµ·"], answer: 1 },
                { question: "è‹±è¯­ä¸­\"è‹¹æœ\"æ€ä¹ˆè¯´ï¼Ÿ", options: ["Orange", "Banana", "Apple", "Grape"], answer: 2 },
                { question: "\"Thank you\"çš„å›ç­”é€šå¸¸æ˜¯ï¼Ÿ", options: ["Hello", "Goodbye", "You're welcome", "Sorry"], answer: 2 },
                { question: "ä¸€å‘¨æœ‰å‡ å¤©ï¼Ÿè‹±è¯­æ€ä¹ˆè¯´ï¼Ÿ", options: ["Six days", "Seven days", "Five days", "Eight days"], answer: 1 },
                { question: "\"Good morning\"æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ", options: ["æ™šä¸Šå¥½", "ä¸‹åˆå¥½", "æ—©ä¸Šå¥½", "æ™šå®‰"], answer: 2 }
            ]
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            createBoard();
            generateScienceGrids();
            updateDisplay();
            updatePieceSelectors();
            initSettings();
        }

        // åˆå§‹åŒ–è®¾ç½®
        function initSettings() {
            const gridSlider = document.getElementById('scienceGridCount');
            const pieceSlider = document.getElementById('sciencePieceCount');
            const gridValue = document.getElementById('scienceGridValue');
            const pieceValue = document.getElementById('sciencePieceValue');

            gridSlider.addEventListener('input', () => {
                gridValue.textContent = gridSlider.value;
            });

            pieceSlider.addEventListener('input', () => {
                pieceValue.textContent = pieceSlider.value;
            });

            document.getElementById('applySettings').addEventListener('click', applySettings);
        }

        // åº”ç”¨è®¾ç½®
        function applySettings() {
            gameConfig.scienceGridCount = parseInt(document.getElementById('scienceGridCount').value);
            gameConfig.sciencePieceCount = parseInt(document.getElementById('sciencePieceCount').value);
            
            // é‡ç½®æ¸¸æˆï¼ˆè¿™ä¼šé‡æ–°ç”Ÿæˆç§‘å­¦æ ¼ï¼‰
            resetGame();
        }

        // åˆ›å»ºæ£‹ç›˜
        function createBoard() {
            const board = document.getElementById('gameBoard');
            const cellsContainer = document.getElementById('board-cells');
            cellsContainer.innerHTML = '';
            
            // ç»˜åˆ¶æ£‹ç›˜çº¿æ¡
            drawBoardLines();
            
            // è·å–å½“å‰æ£‹ç›˜å°ºå¯¸
            const boardRect = board.getBoundingClientRect();
            const boardSize = Math.min(boardRect.width, boardRect.height);
            const cellSize = boardSize / 15;
            
            // åˆ›å»ºæ£‹ç›˜äº¤ç‚¹
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    // è®¡ç®—ä½ç½®ï¼ˆäº¤ç‚¹ä½ç½®ï¼‰
                    const x = cellSize / 2 + j * cellSize;
                    const y = cellSize / 2 + i * cellSize;
                    cell.style.left = x + 'px';
                    cell.style.top = y + 'px';
                    
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    cellsContainer.appendChild(cell);
                }
            }
        }

        // ç»˜åˆ¶æ£‹ç›˜çº¿æ¡
        function drawBoardLines() {
            const hLines = document.getElementById('horizontal-lines');
            const vLines = document.getElementById('vertical-lines');
            const starPoints = document.getElementById('star-points');
            
            hLines.innerHTML = '';
            vLines.innerHTML = '';
            starPoints.innerHTML = '';
            
            const board = document.getElementById('gameBoard');
            const boardRect = board.getBoundingClientRect();
            const boardSize = Math.min(boardRect.width, boardRect.height);
            const cellSize = boardSize / 15;
            const offset = cellSize / 2;
            
            // æ¨ªçº¿
            for (let i = 0; i < 15; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', offset);
                line.setAttribute('y1', offset + i * cellSize);
                line.setAttribute('x2', boardSize - offset);
                line.setAttribute('y2', offset + i * cellSize);
                line.setAttribute('stroke', '#8b4513');
                line.setAttribute('stroke-width', '1');
                hLines.appendChild(line);
            }
            
            // ç«–çº¿
            for (let j = 0; j < 15; j++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', offset + j * cellSize);
                line.setAttribute('y1', offset);
                line.setAttribute('x2', offset + j * cellSize);
                line.setAttribute('y2', boardSize - offset);
                line.setAttribute('stroke', '#8b4513');
                line.setAttribute('stroke-width', '1');
                vLines.appendChild(line);
            }
            
            // æ˜Ÿä½ç‚¹
            const starPositions = [[3,3], [3,11], [7,7], [11,3], [11,11]];
            starPositions.forEach(([row, col]) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', offset + col * cellSize);
                circle.setAttribute('cy', offset + row * cellSize);
                circle.setAttribute('r', '3');
                circle.setAttribute('fill', '#8b4513');
                starPoints.appendChild(circle);
            });
        }

        // ç”Ÿæˆç§‘å­¦æ ¼
        function generateScienceGrids() {
            // æ¸…é™¤ç°æœ‰çš„ç§‘å­¦æ ¼æ˜¾ç¤ºï¼Œä½†ä¿ç•™æ•°æ®
            const existingGrids = document.querySelectorAll('.science-grid');
            existingGrids.forEach(grid => grid.remove());
            
            // å¦‚æœå·²æœ‰ç§‘å­¦æ ¼æ•°æ®ï¼Œåªé‡æ–°æ¸²æŸ“ä½ç½®
            if (gameState.scienceGrids.length > 0) {
                renderScienceGrids();
                return;
            }
            
            // é¦–æ¬¡ç”Ÿæˆç§‘å­¦æ ¼æ•°æ®
            gameState.scienceGrids = [];
            const subjects = ['chinese', 'math', 'english'];
            const positions = [];
            
            // ç”Ÿæˆæ‰€æœ‰å¯èƒ½ä½ç½®ï¼ˆé¿å¼€è¾¹ç¼˜å’Œä¸­å¿ƒæ˜Ÿä½ï¼‰
            for (let i = 2; i < 13; i++) {
                for (let j = 2; j < 13; j++) {
                    if (i === 7 && j === 7) continue;
                    positions.push([i, j]);
                }
            }
            
            // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„ä½ç½®
            const gridsPerSubject = Math.floor(gameConfig.scienceGridCount / 3);
            const extraGrids = gameConfig.scienceGridCount % 3;
            
            for (let s = 0; s < 3; s++) {
                const count = gridsPerSubject + (s < extraGrids ? 1 : 0);
                for (let i = 0; i < count; i++) {
                    if (positions.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * positions.length);
                    const [row, col] = positions.splice(randomIndex, 1)[0];
                    gameState.scienceGrids.push({ row, col, subject: subjects[s] });
                }
            }
            
            renderScienceGrids();
        }

        // æ¸²æŸ“ç§‘å­¦æ ¼ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œç”¨äºresizeæ—¶é‡æ–°å®šä½ï¼‰
        function renderScienceGrids() {
            gameState.scienceGrids.forEach(grid => {
                const scienceDiv = document.createElement('div');
                scienceDiv.className = `science-grid ${grid.subject}`;
                const text = grid.subject === 'chinese' ? 'è¯­' : grid.subject === 'math' ? 'æ•°' : 'å¤–';
                scienceDiv.textContent = text;
                
                // è®¡ç®—ä½ç½® - å“åº”å¼
                const board = document.getElementById('gameBoard');
                const boardRect = board.getBoundingClientRect();
                const boardSize = Math.min(boardRect.width, boardRect.height);
                const cellSize = boardSize / 15;
                const x = cellSize / 2 + grid.col * cellSize;
                const y = cellSize / 2 + grid.row * cellSize;
                scienceDiv.style.left = x + 'px';
                scienceDiv.style.top = y + 'px';
                
                document.getElementById('board-cells').appendChild(scienceDiv);
            });
        }

        // æ›´æ–°æ£‹å­é€‰æ‹©å™¨
        function updatePieceSelectors() {
            const normalContainer = document.getElementById('normalPieceContainer');
            const scienceContainer = document.getElementById('sciencePieceContainer');
            const normalSelector = document.getElementById('normalPieceSelector');
            const scienceSelector = document.getElementById('sciencePieceSelector');
            const scienceCount = document.getElementById('scienceCount');

            // æ›´æ–°é€‰æ‹©å™¨é¢œè‰²
            if (gameState.currentPlayer === 'black') {
                normalSelector.className = 'piece-selector black';
                normalSelector.textContent = 'â—';
                scienceSelector.className = 'piece-selector black science';
                scienceSelector.textContent = 'â˜…';
            } else {
                normalSelector.className = 'piece-selector white';
                normalSelector.textContent = 'â—';
                scienceSelector.className = 'piece-selector white science';
                scienceSelector.textContent = 'â˜…';
            }

            // æ›´æ–°ç§‘å­¦å­æ•°é‡æ˜¾ç¤ºå’Œå¯ç”¨æ€§
            const remaining = gameState.currentPlayer === 'black' ? gameState.blackScience : gameState.whiteScience;
            scienceCount.textContent = `(å‰©ä½™: ${remaining})`;
            
            if (remaining <= 0) {
                scienceSelector.classList.add('disabled');
                scienceContainer.style.opacity = '0.5';
            } else {
                scienceSelector.classList.remove('disabled');
                scienceContainer.style.opacity = '1';
            }

            // é‡ç½®é€‰æ‹©çŠ¶æ€
            normalContainer.classList.remove('selected');
            scienceContainer.classList.remove('selected');

            // å¦‚æœç§‘å­¦å­ä¸å¯ç”¨ï¼Œå¼ºåˆ¶é€‰æ‹©æ™®é€šæ£‹å­
            if (remaining <= 0 && gameState.selectedPieceType === 'science') {
                gameState.selectedPieceType = 'normal';
            }

            // è®¾ç½®é€‰ä¸­çŠ¶æ€
            if (gameState.selectedPieceType === 'science') {
                scienceContainer.classList.add('selected');
            } else {
                normalContainer.classList.add('selected');
            }
        }

        // å¤„ç†æ£‹ç›˜ç‚¹å‡»
        function handleCellClick(row, col) {
            if (gameState.board[row][col]) return; // å·²æœ‰æ£‹å­
            
            const isScience = gameState.scienceGrids.find(g => g.row === row && g.col === col);
            const isUsingSciencePiece = gameState.selectedPieceType === 'science';
            
            if (isScience || isUsingSciencePiece) {
                // éœ€è¦ç­”é¢˜
                const subject = isScience ? isScience.subject : 'random';
                showQuestion(subject, row, col);
            } else {
                // ç›´æ¥ä¸‹æ£‹
                placePiece(row, col, false);
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion(subject, row, col) {
            gameState.pendingMove = { row, col, isScience: gameState.selectedPieceType === 'science' };
            
            let questions;
            if (subject === 'random') {
                const subjects = ['chinese', 'math', 'english'];
                subject = subjects[Math.floor(Math.random() * 3)];
            }
            questions = questionBank[subject];
            
            const question = questions[Math.floor(Math.random() * questions.length)];
            
            document.getElementById('questionSubject').textContent = 
                subject === 'chinese' ? 'è¯­æ–‡' : subject === 'math' ? 'æ•°å­¦' : 'è‹±è¯­';
            document.getElementById('questionText').textContent = question.question;
            
            const optionsDiv = document.getElementById('questionOptions');
            optionsDiv.innerHTML = '';
            question.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-gray-100';
                label.innerHTML = `
                    <input type="radio" name="answer" value="${index}" class="form-radio">
                    <span>${option}</span>
                `;
                optionsDiv.appendChild(label);
            });
            
            gameState.selectedAnswer = null;
            gameState.currentQuestion = question;
            document.getElementById('questionModal').classList.remove('hidden');
            document.getElementById('questionModal').classList.add('flex');
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆï¼');
                return;
            }
            
            const answer = parseInt(selected.value);
            const isCorrect = answer === gameState.currentQuestion.answer;
            
            // æ›´æ–°ç»Ÿè®¡
            if (gameState.currentPlayer === 'black') {
                gameState.blackTotal++;
                if (isCorrect) gameState.blackCorrect++;
            } else {
                gameState.whiteTotal++;
                if (isCorrect) gameState.whiteCorrect++;
            }
            
            // å…³é—­å¼¹çª—
            document.getElementById('questionModal').classList.add('hidden');
            document.getElementById('questionModal').classList.remove('flex');
            
            if (isCorrect) {
                // ç­”å¯¹äº†ï¼Œå¯ä»¥ä¸‹æ£‹
                const { row, col, isScience } = gameState.pendingMove;
                placePiece(row, col, isScience);
            } else {
                // ç­”é”™äº†ï¼Œéœ€è¦é‡æ–°é€‰æ‹©ä½ç½®
                alert('ç­”é”™äº†ï¼è¯·é‡æ–°é€‰æ‹©ä½ç½®ä¸‹æ™®é€šæ£‹å­');
                gameState.selectedPieceType = 'normal';
                updatePieceSelectors();
            }
            
            updateDisplay();
        }

        // ä¸‹æ£‹
        function placePiece(row, col, isScience) {
            gameState.board[row][col] = {
                player: gameState.currentPlayer,
                isScience: isScience,
                scienceType: isScience ? 'any' : null
            };
            
            // æ›´æ–°ç§‘å­¦å­æ•°é‡
            if (isScience) {
                if (gameState.currentPlayer === 'black') {
                    gameState.blackScience--;
                } else {
                    gameState.whiteScience--;
                }
            }
            
            // æ¸²æŸ“æ£‹å­
            renderPiece(row, col);
            
            // æ£€æŸ¥è¿çº¿
            checkLines();
            
            // åˆ‡æ¢ç©å®¶
            gameState.currentPlayer = gameState.currentPlayer === 'black' ? 'white' : 'black';
            gameState.selectedPieceType = 'normal'; // é‡ç½®ä¸ºæ™®é€šæ£‹å­
            
            updateDisplay();
            updatePieceSelectors();
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸ
            if (isGameOver()) {
                setTimeout(showGameOver, 500);
            }
        }

        // æ¸²æŸ“æ£‹å­ - ä¿®æ”¹ä»¥æ”¯æŒå“åº”å¼å’Œç§‘å­¦æ ¼æ ‡è¯†
        function renderPiece(row, col) {
            const piece = document.createElement('div');
            const pieceData = gameState.board[row][col];
            
            piece.className = `piece ${pieceData.player}`;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç§‘å­¦æ ¼ä¸Š
            const scienceGrid = gameState.scienceGrids.find(g => g.row === row && g.col === col);
            
            if (pieceData.isScience) {
                piece.classList.add('science');
                piece.textContent = 'â˜…';
            } else if (scienceGrid) {
                // åœ¨ç§‘å­¦æ ¼ä¸Šçš„æ™®é€šæ£‹å­ï¼Œæ˜¾ç¤ºå­¦ç§‘æ ‡è¯†
                const text = scienceGrid.subject === 'chinese' ? 'è¯­' : 
                           scienceGrid.subject === 'math' ? 'æ•°' : 'å¤–';
                piece.textContent = text;
                piece.style.fontSize = '14px';
                piece.style.fontWeight = 'bold';
                // é»‘å­ç™½å­—ï¼Œç™½å­é»‘å­—
                if (pieceData.player === 'black') {
                    piece.style.color = '#fff';
                } else {
                    piece.style.color = '#000';
                }
            }
            
            // è®¡ç®—ä½ç½® - å“åº”å¼
            const board = document.getElementById('gameBoard');
            const boardRect = board.getBoundingClientRect();
            const boardSize = Math.min(boardRect.width, boardRect.height);
            const cellSize = boardSize / 15;
            const x = cellSize / 2 + col * cellSize;
            const y = cellSize / 2 + row * cellSize;
            piece.style.position = 'absolute';
            piece.style.left = x + 'px';
            piece.style.top = y + 'px';
            piece.style.transform = 'translate(-50%, -50%)';
            piece.style.zIndex = '15';
            
            document.getElementById('board-cells').appendChild(piece);
            
            // æ ‡è®°cellå·²æœ‰æ£‹å­
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cell) {
                cell.classList.add('has-piece');
            }
        }

        // æ£€æŸ¥è¿çº¿
        function checkLines() {
            const directions = [[0,1], [1,0], [1,1], [1,-1]];
            
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) continue;
                    
                    const player = gameState.board[i][j].player;
                    
                    for (let [dx, dy] of directions) {
                        const line = [[i, j]];
                        
                        // å‘å‰æœç´¢
                        let x = i + dx, y = j + dy;
                        while (x >= 0 && x < 15 && y >= 0 && y < 15 && 
                               gameState.board[x][y] && gameState.board[x][y].player === player) {
                            line.push([x, y]);
                            x += dx;
                            y += dy;
                        }
                        
                        if (line.length >= 5) {
                            // åˆ›å»ºçº¿æ¡æ ‡è¯†ç¬¦
                            const lineId = `${line[0][0]},${line[0][1]}-${dx},${dy}-${line.length}`;
                            
                            if (!gameState.scoredLines.has(lineId)) {
                                const score = calculateLineScore(line);
                                if (player === 'black') {
                                    gameState.blackScore += score;
                                } else {
                                    gameState.whiteScore += score;
                                }
                                gameState.scoredLines.add(lineId);
                            }
                        }
                    }
                }
            }
        }

        // è®¡ç®—è¿çº¿åˆ†æ•°
        function calculateLineScore(line) {
            let scienceCount = 0;
            let gridCount = {};
            
            for (let [x, y] of line) {
                const piece = gameState.board[x][y];
                if (piece.isScience) {
                    scienceCount++;
                }
                
                const grid = gameState.scienceGrids.find(g => g.row === x && g.col === y);
                if (grid) {
                    gridCount[grid.subject] = (gridCount[grid.subject] || 0) + 1;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰2ä¸ªåŒç±»ç§‘å­¦å­æˆ–ç§‘å­¦æ ¼
            if (scienceCount >= 2) return 2;
            for (let subject in gridCount) {
                if (gridCount[subject] >= 2) return 2;
            }
            
            return 1;
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('currentPlayer').textContent = gameState.currentPlayer === 'black' ? 'é»‘æ–¹' : 'ç™½æ–¹';
            document.getElementById('blackScore').textContent = gameState.blackScore;
            document.getElementById('whiteScore').textContent = gameState.whiteScore;
            document.getElementById('blackScience').textContent = gameState.blackScience;
            document.getElementById('whiteScience').textContent = gameState.whiteScience;
            
            const blackAccuracy = gameState.blackTotal > 0 ? Math.round(gameState.blackCorrect / gameState.blackTotal * 100) : 0;
            const whiteAccuracy = gameState.whiteTotal > 0 ? Math.round(gameState.whiteCorrect / gameState.whiteTotal * 100) : 0;
            document.getElementById('blackAccuracy').textContent = blackAccuracy + '%';
            document.getElementById('whiteAccuracy').textContent = whiteAccuracy + '%';
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function isGameOver() {
            let emptyCount = 0;
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) emptyCount++;
                }
            }
            return emptyCount === 0 || Math.abs(gameState.blackScore - gameState.whiteScore) >= 10;
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸ
        function showGameOver() {
            let result;
            if (gameState.blackScore > gameState.whiteScore) {
                result = `ğŸ‰ é»‘æ–¹è·èƒœï¼<br>å¾—åˆ†ï¼š${gameState.blackScore} : ${gameState.whiteScore}`;
            } else if (gameState.whiteScore > gameState.blackScore) {
                result = `ğŸ‰ ç™½æ–¹è·èƒœï¼<br>å¾—åˆ†ï¼š${gameState.whiteScore} : ${gameState.blackScore}`;
            } else {
                result = `ğŸ¤ å¹³å±€ï¼<br>å¾—åˆ†ï¼š${gameState.blackScore} : ${gameState.whiteScore}`;
            }
            
            document.getElementById('gameResult').innerHTML = result;
            document.getElementById('gameOverModal').classList.remove('hidden');
            document.getElementById('gameOverModal').classList.add('flex');
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.selectedPieceType = 'normal';
            gameState.blackScore = 0;
            gameState.whiteScore = 0;
            gameState.blackScience = gameConfig.sciencePieceCount;
            gameState.whiteScience = gameConfig.sciencePieceCount;
            gameState.blackCorrect = 0;
            gameState.blackTotal = 0;
            gameState.whiteCorrect = 0;
            gameState.whiteTotal = 0;
            gameState.scoredLines = new Set();
            // é‡ç½®æ—¶æ¸…ç©ºç§‘å­¦æ ¼æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
            gameState.scienceGrids = [];
            
            // éšè—å¼¹çª—
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('gameOverModal').classList.remove('flex');
            
            // é‡æ–°åˆå§‹åŒ–
            initGame();
        }

        // æ£‹å­é€‰æ‹©å™¨äº‹ä»¶
        function setupPieceSelectors() {
            document.getElementById('normalPieceContainer').addEventListener('click', () => {
                gameState.selectedPieceType = 'normal';
                updatePieceSelectors();
            });

            document.getElementById('sciencePieceContainer').addEventListener('click', () => {
                const remaining = gameState.currentPlayer === 'black' ? gameState.blackScience : gameState.whiteScience;
                if (remaining > 0) {
                    gameState.selectedPieceType = 'science';
                    updatePieceSelectors();
                }
            });
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('newGameBtn').addEventListener('click', resetGame);
        document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
        document.getElementById('cancelAnswer').addEventListener('click', () => {
            document.getElementById('questionModal').classList.add('hidden');
            document.getElementById('questionModal').classList.remove('flex');
            gameState.selectedPieceType = 'normal';
            updatePieceSelectors();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
        setupPieceSelectors();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°ç»˜åˆ¶æ£‹ç›˜
        window.addEventListener('resize', () => {
            setTimeout(() => {
                createBoard();
                // åªé‡æ–°æ¸²æŸ“ç§‘å­¦æ ¼ä½ç½®ï¼Œä¸é‡æ–°ç”Ÿæˆæ•°æ®
                renderScienceGrids();
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ£‹å­
                for (let i = 0; i < 15; i++) {
                    for (let j = 0; j < 15; j++) {
                        if (gameState.board[i][j]) {
                            renderPiece(i, j);
                        }
                    }
                }
            }, 100);
        });
    </script>
</body>
</html>
