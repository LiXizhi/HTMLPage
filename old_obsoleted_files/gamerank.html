<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ’è¡Œæ¦œ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        html, body { 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        
        /* Ensure game list can scroll when content exceeds container */
        .game-list-scroll {
            min-height: 200px;
            overflow-y: scroll !important; /* Force scroll even without content overflow */
        }          
        /* Leaderboard scrollable area */
        .leaderboard-scroll {
            overflow-y: scroll !important;
            max-height: 77vh; /* Force maximum height to ensure scrolling */
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        .game-item:hover { background: rgba(102, 126, 234, 0.1); transform: translateX(4px); }
        .game-item.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .leaderboard-item:nth-child(1) { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .leaderboard-item:nth-child(2) { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); }
        .leaderboard-item:nth-child(3) { background: linear-gradient(135deg, #cd7f32, #daa520); }
        .tab-active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .age-button:hover { background: rgba(102, 126, 234, 0.1); }
        .age-button.active { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .user-highlight { border: 3px solid #10b981; background: rgba(16, 185, 129, 0.1); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }        
        .layout-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; flex-shrink: 0; }
        .main-content { flex: 1; min-width: 0; overflow: hidden; }        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu { display: none; }
        .dropdown-menu:hover { display: block; }
        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 8px;
            background: transparent;
        }
        @media (max-width: 768px) {
            .layout-container { flex-direction: column; }
            .sidebar { width: 100%; min-height: auto; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- æ•´ä½“å¸ƒå±€å®¹å™¨ -->
    <div class="layout-container">
        <!-- å·¦ä¾§æ¸¸æˆåˆ—è¡¨ -->
        <div class="sidebar bg-white shadow-lg flex flex-col">
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-4 pb-2">
                    <h2 class="text-lg font-bold mb-4 text-gray-800">å¾—åˆ†æ’è¡Œæ¦œ</h2>
                </div>                
                <div class="flex-1 overflow-y-auto px-4 pb-2 game-list-scroll">
                    <div id="gameList" class="space-y-2">
                        <!-- æ¸¸æˆé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>            <!-- åˆ†æ•°æäº¤åŒºåŸŸ -->
            <div class="p-4 bg-gray-50 border-t">
                <div class="space-y-3">
                    <button 
                        onclick="showScoreDialog()" 
                        class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition-all"
                        id="submitButton"
                    >
                        ğŸ† æäº¤æˆç»©
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">ä¸ºäº†ä¿æŠ¤éšç§ï¼Œéœ€è¦æ‰‹å·¥æäº¤åˆ†æ•°</p>
            </div>
        </div>
        <div class="main-content flex flex-col">
            <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
            <div class="bg-white shadow-sm p-4 border-b">
                <div class="flex items-center justify-between">
                    
                    <div class="flex items-center space-x-6">
                        <!-- å‘¨æ¦œ/æœˆæ¦œåˆ‡æ¢ -->
                        <div class="flex space-x-3">
                            <button id="weeklyTab" class="tab-active px-6 py-2 rounded-lg font-bold transition-all" onclick="switchTab('weekly')">
                                ğŸ“… å‘¨æ¦œ
                            </button>
                            <button id="monthlyTab" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-bold transition-all hover:bg-gray-300" onclick="switchTab('monthly')">
                                ğŸ“Š æœˆæ¦œ
                            </button>
                        </div>
                        <div class="text-sm text-gray-500">
                            åœ¨çº¿ç”¨æˆ·: <span class="font-bold text-green-600">1,234</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œå†…å®¹ -->
            <div class="flex-1 p-2">
                <div class="bg-white rounded-xl shadow-sm h-full flex flex-col">
                    <div class="p-6 border-b">
                        <div class="flex items-center justify-between">
                            <!-- åŠ¨æ€æ ‡é¢˜å’Œä¸‹æ‹‰èœå• -->
                            <div class="dropdown relative">
                                <button class="flex items-center text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors cursor-pointer">
                                    <span>ğŸ… </span>
                                    <span id="rankingTitle">æ··é¾„æ€»æ¦œå‘¨æ¦œ</span>
                                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>                                
                                <!-- ä¸‹æ‹‰èœå• -->
                                <div class="dropdown-menu absolute top-full left-0 mt-2 w-48 bg-white border rounded-lg shadow-lg z-10">
                                    <div class="py-2 text-lg">
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('all')">ğŸ† æ··é¾„æ€»æ¦œ</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('5-6')">ğŸ‘¶ 5-6å²</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('7-8')">ğŸ§’ 7-8å²</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('9-10')">ğŸ‘¦ 9-10å²</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('11-12')">ğŸ‘§ 11-12å²</a>
                                        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100" onclick="selectLeaderboard('13+')">ğŸ§‘ 13å²ä»¥ä¸Š</a>
                                    </div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600">
                                æ€»è®¡: <span id="totalPlayers" class="font-bold text-blue-600">100</span> äºº
                            </div>
                        </div>
                    </div>                      
                    <div class="flex-1 overflow-hidden">
                        <div id="leaderboardList" class="h-full min-h-[400px] overflow-y-auto leaderboard-scroll">
                            <!-- æ’è¡Œæ¦œé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <div id="scoreInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-4xl w-full max-h-[80vh] shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4">ğŸ†</div>
                <h3 class="text-3xl font-bold mb-6 text-gray-800" id="submitDialogTitle">æäº¤æˆç»©</h3>
                
                <!-- æ¸¸æˆä¿¡æ¯æ˜¾ç¤º - æ”¹ä¸ºç½‘æ ¼å¸ƒå±€ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">å½“å‰è®­ç»ƒ</div>
                        <div class="text-xl font-bold text-green-700" id="dialogCurrentGame">-</div>
                    </div>
                      <div class="bg-purple-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">å½“å‰åˆ†æ•°</div>
                        <div class="text-xl font-bold text-purple-700" id="dialogCurrentScore">æš‚æ— è®°å½•</div>
                        <div class="text-sm text-gray-500 mt-1" id="dialogUserAge">ï¼ˆå¹´é¾„æœªè®¾ç½®ï¼‰</div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-lg border">
                        <div class="text-base text-gray-600 mb-2">é¢„ä¼°æ’å</div>
                        <div class="text-xl font-bold text-yellow-700" id="dialogUserRank">æœªä¸Šæ¦œ</div>
                    </div>                </div>
                
                <!-- è¯´æ˜æ–‡å­— -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                    <p class="text-base text-gray-700 leading-relaxed">
                        <strong>ä¸ºäº†ä¿æŠ¤éšç§ï¼Œéœ€è¦æ‰‹å·¥æäº¤åˆ†æ•°ã€‚</strong>æ‚¨çš„åˆ†æ•°å°†æ˜¾ç¤ºåœ¨ç›¸åº”å¹´é¾„ç»„çš„æ’è¡Œæ¦œä¸­ï¼Œå¸®åŠ©æ‚¨äº†è§£è‡ªå·±çš„è®­ç»ƒæ°´å¹³ã€‚
                    </p>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="closeScoreDialog()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg text-lg font-bold hover:bg-gray-400 transition-all">
                        å–æ¶ˆ
                    </button>
                    <button onclick="submitScoreFromDialog()" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold hover:from-green-700 hover:to-blue-700 transition-all">
                        æäº¤åˆ†æ•°
                    </button>
                </div>
            </div>
        </div>
    </div>    <!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-md shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4 text-red-500">âš ï¸</div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">æäº¤å¤±è´¥</h3>
                <p id="errorModalText" class="text-gray-600 mb-6 text-lg leading-relaxed"></p>
                <button onclick="closeErrorModal()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-3 rounded-lg font-bold hover:from-red-600 hover:to-red-700 transition-all">
                    çŸ¥é“äº†
                </button>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤ºæ¨¡æ€æ¡† -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 m-4 max-w-md shadow-2xl">
            <div class="text-center">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">åˆ†æ•°æäº¤æˆåŠŸï¼</h3>
                <p class="text-gray-600 mb-2">ä½ çš„åˆ†æ•°å·²åŠ å…¥æ’è¡Œæ¦œ</p>
                <p id="rankInfo" class="text-lg font-bold text-blue-600 mb-6"></p>
                <button onclick="closeModal()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition-all">
                    å¤ªæ£’äº†ï¼
                </button>
            </div>
        </div>
    </div><script>
          // æ¸¸æˆé…ç½®å’Œç”¨æˆ·æ•°æ®
        let gameConfig = {
            games: {
                puzzle: { name: 'ç›Šæ™ºè§£è°œ', icon: 'ğŸ§©', desc: 'æŒ‘æˆ˜ä½ çš„æ™ºåŠ›' },
                racing: { name: 'æé€Ÿèµ›è½¦', icon: 'ğŸï¸', desc: 'é€Ÿåº¦ä¸æ¿€æƒ…' },
                shooting: { name: 'å°„å‡»å¤§å¸ˆ', icon: 'ğŸ¯', desc: 'è€ƒéªŒä½ çš„å‡†åº¦' },
                platform: { name: 'è·³è·ƒå†’é™©', icon: 'ğŸ¦˜', desc: 'å¹³å°è·³è·ƒæ¸¸æˆ' },
                music: { name: 'éŸ³ä¹èŠ‚æ‹', icon: 'ğŸµ', desc: 'èŠ‚å¥æ„ŸæŒ‘æˆ˜' },
                card: { name: 'è®°å¿†å¡ç‰Œ', icon: 'ğŸƒ', desc: 'è®°å¿†åŠ›è®­ç»ƒ' },
                sudoku: { name: 'æ•°ç‹¬æ¸¸æˆ', icon: 'ğŸ”¢', desc: 'é€»è¾‘æ¨ç†æ•°å­—æ¸¸æˆ' },
                memory: { name: 'è®°å¿†å¤§å¸ˆ', icon: 'ğŸ§ ', desc: 'è®­ç»ƒè®°å¿†åŠ›' },
                math: { name: 'æ•°å­¦æŒ‘æˆ˜', icon: 'â•', desc: 'æ•°å­¦è¿ç®—èƒ½åŠ›' },
                word: { name: 'å•è¯æ¸¸æˆ', icon: 'ğŸ“', desc: 'è‹±è¯­å•è¯æŒ‘æˆ˜' },
                color: { name: 'é¢œè‰²è®°å¿†', icon: 'ğŸ¨', desc: 'é¢œè‰²ä½ç½®è®°å¿†' },
                cube: { name: 'ç«‹æ–¹ä½“', icon: 'ğŸ“¦', desc: '3Dç©ºé—´æ€ç»´' },
                chess: { name: 'äº”å­æ£‹', icon: 'âš«', desc: 'ç­–ç•¥å¯¹æˆ˜æ¸¸æˆ' },
                water: { name: 'å€’æ°´æ¸¸æˆ', icon: 'ğŸ§ª', desc: 'é€»è¾‘æ¨ç†å€’æ°´' },
                shape: { name: 'å›¾å½¢è®¡æ•°', icon: 'ğŸ”º', desc: 'è§†è§‰è®¡æ•°è®­ç»ƒ' }
            },
            userAge: 9,
            userScores: {
                puzzle: 85,
                racing: 92,
                shooting: 78,
            }
        };        let games = gameConfig.games || {};
        let userAge = (gameConfig.userAge !== undefined && gameConfig.userAge !== null) ? gameConfig.userAge : null; // ç”¨æˆ·å¹´é¾„ï¼Œä»é…ç½®ä¸­è·å–
        let userGameScores = gameConfig.userScores || {}; // ç”¨æˆ·å„æ¸¸æˆçš„åˆ†æ•°ï¼Œä»é…ç½®ä¸­è·å–// é»˜è®¤æ¸¸æˆæ•°æ®ï¼ˆä½œä¸ºåå¤‡ï¼‰
        const defaultGames = gameConfig.games;
            
        function generateGameList() {
            const gameListContainer = document.getElementById('gameList');
            gameListContainer.innerHTML = '';
            
            const gameKeys = Object.keys(games);
            if (gameKeys.length === 0) {
                gameListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— æ¸¸æˆæ•°æ®</p>';
                return;
            }
              gameKeys.forEach((gameId, index) => {
                const game = games[gameId];
                const isActive = gameId === currentGame; // åŸºäºå½“å‰æ¸¸æˆIDåˆ¤æ–­æ˜¯å¦æ¿€æ´»
                
                const gameItem = document.createElement('div');
                gameItem.className = `game-item ${isActive ? 'active' : ''} cursor-pointer p-4 rounded-lg transition-all duration-200`;
                gameItem.setAttribute('data-game-id', gameId);
                gameItem.addEventListener('click', () => selectGame(gameId));
                
                // æ˜¾ç¤ºç”¨æˆ·åœ¨è¯¥æ¸¸æˆçš„åˆ†æ•°
                const userScore = userGameScores[gameId];
                const scoreDisplay = userScore ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full ml-2">${userScore}åˆ†</span>` : '';
                
                gameItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">${game.icon}</span>
                            <div>
                                <h3 class="font-bold">${game.name}</h3>
                                <p class="text-sm opacity-80">${game.desc || 'æš‚æ— æè¿°'}</p>
                            </div>
                        </div>
                        ${scoreDisplay}
                    </div>
                `;
                
                gameListContainer.appendChild(gameItem);
            });
              // è®¾ç½®ç¬¬ä¸€ä¸ªæ¸¸æˆä¸ºå½“å‰æ¸¸æˆå¹¶æ›´æ–°ç•Œé¢ï¼ˆä»…åœ¨æ²¡æœ‰å½“å‰æ¸¸æˆæ—¶ï¼‰
            if (gameKeys.length > 0) {
                // å¦‚æœæ²¡æœ‰å½“å‰æ¸¸æˆæˆ–å½“å‰æ¸¸æˆä¸å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œæ‰è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªæ¸¸æˆ
                if (!currentGame || !gameKeys.includes(currentGame)) {
                    currentGame = gameKeys[0];
                }
                updateUserInfo();
            }
        }          function updateUserInfo(){
            // Update any user info displays if needed
            // For now, this function can remain empty but available for future use
            console.log('User info updated - Age:', userAge, 'Scores:', userGameScores);
        }
        // æ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    gameConfig = e.data.data;
                    try {
                        // gameConfig is now a JSON object                        
                        if (gameConfig && typeof gameConfig === 'object') {
                            games = gameConfig.games || defaultGames;
                            userAge = (gameConfig.userAge !== undefined && gameConfig.userAge !== null) ? gameConfig.userAge : null;
                            userGameScores = gameConfig.userScores || {};
                        } else {
                            // Fallback to defaults
                            games = defaultGames;
                            userAge = null;
                            userGameScores = {};
                        }
                    } catch (error) {
                        console.error('Error processing game config:', error);
                        games = defaultGames;
                        userAge = null;
                        userGameScores = {};
                    }
                    
                    generateGameList();
                    initializeData();
                    updateUserInfo();
                    
                    // å¦‚æœæœ‰ç”¨æˆ·å¹´é¾„ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”å¹´é¾„ç»„
                    if (userAge) {
                        const targetAgeGroup = getAgeGroup(userAge);
                        currentAgeGroup = targetAgeGroup;
                        updateAgeButtons();
                    }
                    
                    updateTitle();
                    updateLeaderboard();
                    console.log('Game config updated:', { games, userAge, userGameScores });
                    break;
                case 'getGameStats':
                    // å‘é€æ¸¸æˆç»Ÿè®¡æ•°æ®
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            currentGame: currentGame,
                            games: Object.keys(games),
                            userAge: userAge,
                            userGameScores: userGameScores,
                            leaderboardData: leaderboardData
                        }
                    }, '*');
                    break;
            }
        });

        // å¹´é¾„ç»„é…ç½®
        const ageGroups = {
            'all': { name: 'æ··é¾„æ€»æ¦œ', emoji: 'ğŸ†', filter: () => true },
            '5-6': { name: '5-6å²', emoji: 'ğŸ‘¶', filter: (age) => age >= 5 && age <= 6 },
            '7-8': { name: '7-8å²', emoji: 'ğŸ§’', filter: (age) => age >= 7 && age <= 8 },
            '9-10': { name: '9-10å²', emoji: 'ğŸ‘¦', filter: (age) => age >= 9 && age <= 10 },
            '11-12': { name: '11-12å²', emoji: 'ğŸ‘§', filter: (age) => age >= 11 && age <= 12 },
            '13+': { name: '13å²ä»¥ä¸Š', emoji: 'ğŸ§‘', filter: (age) => age >= 13 }
        };

        let currentGame = 'puzzle';
        let currentTab = 'weekly';
        let currentAgeGroup = 'all';
        let leaderboardData = {};

        // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
        function initializeData() {
            Object.keys(games).forEach(gameId => {
                leaderboardData[gameId] = {
                    weekly: generateMockData(),
                    monthly: generateMockData()
                };
            });
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ’è¡Œæ¦œæ•°æ®
        function generateMockData() {
            const names = ['å°æ˜', 'å°çº¢', 'å°åˆš', 'å°ä¸½', 'å°å', 'å°ç‹', 'å°æ', 'å°å¼ ', 'å°é™ˆ', 'å°èµµ', 'å°å‘¨', 'å°å´', 'å°éƒ‘', 'å°å†¯', 'å°å­™'];
            const data = [];
            for (let i = 0; i < 120; i++) {
                data.push({
                    rank: i + 1,
                    name: names[Math.floor(Math.random() * names.length)] + (i + 1),
                    score: 100000 - i * 800 + Math.floor(Math.random() * 600),
                    age: Math.floor(Math.random() * 14) + 5 // 5-18å²
                });
            }
            return data.sort((a, b) => b.score - a.score);
        }

        // æ›´æ–°æ ‡é¢˜
        function updateTitle() {
            const tabName = currentTab === 'weekly' ? 'å‘¨æ¦œ' : 'æœˆæ¦œ';
            const ageName = ageGroups[currentAgeGroup].name;
            document.getElementById('rankingTitle').textContent = `${ageName}${tabName}`;
        }        // ä»ä¸‹æ‹‰èœå•é€‰æ‹©æ’è¡Œæ¦œ
        function selectLeaderboard(ageGroup) {
            event.preventDefault();
            currentAgeGroup = ageGroup;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateAgeButtons();
            updateTitle();
            updateLeaderboard();
        }

        // æ›´æ–°æ¦œå•ç±»å‹æŒ‰é’®çŠ¶æ€
        function updateTabButtons() {
            document.querySelectorAll('[id$="Tab"]').forEach(btn => {
                btn.className = 'bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-bold transition-all hover:bg-gray-300';
            });
            document.getElementById(currentTab + 'Tab').className = 'tab-active px-6 py-2 rounded-lg font-bold transition-all';
        }

        // æ›´æ–°å¹´é¾„ç»„æŒ‰é’®çŠ¶æ€
        function updateAgeButtons() {
            document.querySelectorAll('.age-button').forEach((btn, index) => {
                btn.classList.remove('active');
                const groups = ['all', '5-6', '7-8', '9-10', '11-12', '13+'];
                if (groups[index] === currentAgeGroup) {
                    btn.classList.add('active');
                }
            });
        }        // é€‰æ‹©æ¸¸æˆ
        function selectGame(gameId) {
            currentGame = gameId;
            
            // æ›´æ–°æ¸¸æˆé€‰æ‹©æ ·å¼
            document.querySelectorAll('.game-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-game-id') === gameId) {
                    item.classList.add('active');
                }
            });
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            updateUserInfo();
            
            // åˆ‡æ¢æ¸¸æˆåï¼Œè‡ªåŠ¨æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¹´é¾„çš„æ¦œ
            if (userAge) {
                const targetAgeGroup = getAgeGroup(userAge);
                currentAgeGroup = targetAgeGroup;
                updateAgeButtons();
                updateTitle();
            }
            
            updateLeaderboard();
        }

        // åˆ‡æ¢æ¦œå•ç±»å‹
        function switchTab(tab) {
            currentTab = tab;
            updateTabButtons();
            updateTitle();
            updateLeaderboard();
        }

        // é€‰æ‹©å¹´é¾„ç»„
        function selectAge(ageGroup) {
            currentAgeGroup = ageGroup;
            updateAgeButtons();
            updateTitle();
            updateLeaderboard();
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateLeaderboard() {
            if (!currentGame) return;

            let data = [...leaderboardData[currentGame][currentTab]];

            // åº”ç”¨å¹´é¾„ç»„ç­›é€‰
            if (currentAgeGroup !== 'all') {
                data = data.filter(item => ageGroups[currentAgeGroup].filter(item.age));
            }

            document.getElementById('totalPlayers').textContent = data.length;

            const listContainer = document.getElementById('leaderboardList');
            listContainer.innerHTML = '';

            if (data.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ¯</div>
                            <p class="text-xl">æš‚æ— ${ageGroups[currentAgeGroup].name}çš„ç©å®¶è®°å½•</p>
                            <p class="text-sm mt-2">å¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªä¸Šæ¦œçš„ç©å®¶å§ï¼</p>
                        </div>
                    </div>
                `;
                return;
            }

            data.slice(0, 100).forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `leaderboard-item flex items-center justify-between p-4 border-b hover:bg-gray-50 transition-all ${index < 3 ? 'text-white font-bold' : ''} ${item.name === 'æˆ‘' ? 'user-highlight' : ''}`;
                
                let rankDisplay = index + 1;
                let rankIcon = '';
                if (index === 0) rankIcon = 'ğŸ¥‡';
                else if (index === 1) rankIcon = 'ğŸ¥ˆ';
                else if (index === 2) rankIcon = 'ğŸ¥‰';                // æ ¹æ®æ’åè®¾ç½®ä¸åŒçš„æ–‡å­—é¢œè‰²
                let textColorClass = '';
                let subTextColorClass = '';
                if (index === 0) {
                    // ç¬¬ä¸€åï¼šæ·±é‡‘è‰²æ–‡å­—
                    textColorClass = 'text-yellow-900';
                    subTextColorClass = 'text-yellow-800 opacity-80';
                } else if (index === 1) {
                    // ç¬¬äºŒåï¼šæ·±ç°è‰²æ–‡å­—
                    textColorClass = 'text-gray-700';
                    subTextColorClass = 'text-gray-600 opacity-80';
                } else if (index === 2) {
                    // ç¬¬ä¸‰åï¼šæ·±æ£•è‰²æ–‡å­—
                    textColorClass = 'text-amber-900';
                    subTextColorClass = 'text-amber-800 opacity-80';
                } else {
                    // å…¶ä»–åæ¬¡ï¼šåŸæ¥çš„é¢œè‰²
                    textColorClass = 'text-gray-800';
                    subTextColorClass = 'text-gray-500';
                }

                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-3xl font-bold mr-4 min-w-[60px] text-center ${index < 3 ? textColorClass : 'text-gray-600'}">
                            ${rankIcon || rankDisplay}
                        </div>
                        <div class="flex items-center">
                            <div class="mr-4">
                                <div class="text-lg font-bold ${textColorClass}">${item.name}</div>
                                <div class="text-sm ${subTextColorClass}">${item.age}å² ${item.name === 'æˆ‘' ? '(ä½ )' : ''}</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${textColorClass}">${item.score.toLocaleString()}</div>
                        <div class="text-sm ${subTextColorClass}">åˆ†æ•°</div>
                    </div>
                `;
                
                listContainer.appendChild(div);
            });
        }

        // æ ¹æ®å¹´é¾„ç¡®å®šå¹´é¾„ç»„
        function getAgeGroup(age) {
            if (age >= 5 && age <= 6) return '5-6';
            if (age >= 7 && age <= 8) return '7-8';
            if (age >= 9 && age <= 10) return '9-10';
            if (age >= 11 && age <= 12) return '11-12';
            if (age >= 13) return '13+';
            return 'all';
        }        // æ˜¾ç¤ºæäº¤é”™è¯¯æ¶ˆæ¯ï¼ˆä½¿ç”¨å¼¹çª—æ¨¡æ€æ¡†ï¼‰
        function showSubmitError(message) {
            const errorModalText = document.getElementById('errorModalText');
            errorModalText.textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        // éšè—æäº¤é”™è¯¯æ¶ˆæ¯
        function hideSubmitError() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        // å…³é—­é”™è¯¯æ¨¡æ€æ¡†
        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }        function showScoreDialog() {
            // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜ï¼Œä¸æ˜¾ç¤ºç”¨æˆ·å¹´é¾„
            const tabName = currentTab === 'weekly' ? 'å‘¨æ¦œ' : 'æœˆæ¦œ';
            const ageName = ageGroups[currentAgeGroup].name;
            document.getElementById('submitDialogTitle').textContent = `æäº¤æˆç»© - ${ageName}${tabName}`;
            
            // æ›´æ–°å¯¹è¯æ¡†ä¸­çš„ä¿¡æ¯
            document.getElementById('dialogCurrentGame').textContent = games[currentGame] ? games[currentGame].name : '-';
            
            const currentScore = userGameScores[currentGame];
            document.getElementById('dialogCurrentScore').textContent = currentScore ? `${currentScore.toLocaleString()} åˆ†` : 'æš‚æ— è®°å½•';
            
            // æ˜¾ç¤ºç”¨æˆ·å¹´é¾„
            const ageText = userAge ? `ï¼ˆ${userAge}å²ï¼‰` : 'ï¼ˆå¹´é¾„æœªè®¾ç½®ï¼‰';
            document.getElementById('dialogUserAge').textContent = ageText;
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºé¢„ä¼°æ’å
            updateEstimatedRank();
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('scoreInfoModal').classList.remove('hidden');
        }
        function updateEstimatedRank() {
            if (!userAge || !leaderboardData[currentGame]) {
                document.getElementById('dialogUserRank').textContent = 'éœ€è¦è®¾ç½®å¹´é¾„';
                return;
            }
            
            const currentScore = userGameScores[currentGame];
            if (!currentScore) {
                document.getElementById('dialogUserRank').textContent = 'æš‚æ— åˆ†æ•°è®°å½•';
                return;
            }
            
            // æ··åˆæ¦œå¯ä»¥æ— è§†å¹´é¾„ï¼Œå…¶ä»–æ¦œå•éœ€è¦æ£€æŸ¥å¹´é¾„ç»„æ˜¯å¦åŒ¹é…
            if (currentAgeGroup !== 'all') {
                const targetAgeGroup = getAgeGroup(userAge);
                if (currentAgeGroup !== targetAgeGroup) {
                    document.getElementById('dialogUserRank').textContent = 'è¯¥æ¦œä¸ç”¨æˆ·å¹´é¾„ä¸ç¬¦';
                    return;
                }
            }
            
            // è®¡ç®—ç”¨æˆ·åœ¨å½“å‰å¹´é¾„ç»„çš„æ’å
            const data = leaderboardData[currentGame][currentTab];
            const filteredData = currentAgeGroup === 'all' ? data : data.filter(item => ageGroups[currentAgeGroup].filter(item.age));
            
            // æ·»åŠ ç”¨æˆ·åˆ†æ•°åˆ°æ’è¡Œæ¦œä¸­è¿›è¡Œæ’åºï¼ˆä¸´æ—¶è®¡ç®—ï¼‰
            const tempData = [...filteredData];
            // ç§»é™¤ä¹‹å‰çš„ç”¨æˆ·è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingUserIndex = tempData.findIndex(item => item.name === 'æˆ‘');
            if (existingUserIndex !== -1) {
                tempData.splice(existingUserIndex, 1);
            }
            
            // æ·»åŠ æ–°çš„ç”¨æˆ·åˆ†æ•°
            tempData.push({
                name: 'æˆ‘',
                score: currentScore,
                age: userAge
            });
            tempData.sort((a, b) => b.score - a.score);
              const userRank = tempData.findIndex(item => item.name === 'æˆ‘') + 1;
            const totalPlayers = tempData.length;            
            document.getElementById('dialogUserRank').textContent = `ç¬¬ ${userRank} ä½`;
        }
        function submitScoreFromDialog() {
            if (userAge === null || userAge === undefined) {
                showSubmitError('ç”¨æˆ·å¹´é¾„æœªè®¾ç½®ï¼Œè¯·è®¾ç½®å¹´é¾„åå†æäº¤åˆ†æ•°');
                return;
            }

            // æ··åˆæ¦œå¯ä»¥æ— è§†å¹´é¾„ï¼Œå…¶ä»–æ¦œå•éœ€è¦æ£€æŸ¥å¹´é¾„ç»„æ˜¯å¦åŒ¹é…
            if (currentAgeGroup !== 'all') {
                const targetAgeGroup = getAgeGroup(userAge);
                if (currentAgeGroup !== targetAgeGroup) {
                    // å¹´é¾„ä¸ç¬¦æ—¶ç›´æ¥å…³é—­å¯¹è¯æ¡†
                    closeScoreDialog();
                    return;
                }
            }

            const currentScore = userGameScores[currentGame];
            if (!currentScore || currentScore <= 0) {
                showSubmitError('å½“å‰è®­ç»ƒæš‚æ— æœ‰æ•ˆåˆ†æ•°è®°å½•');
                return;
            }

            // å…³é—­å¯¹è¯æ¡†
            closeScoreDialog();
            
            // è°ƒç”¨åŸæœ‰çš„æäº¤åˆ†æ•°é€»è¾‘
            submitScoreInternal(currentScore);
        }        // å…³é—­æäº¤æˆç»©å¯¹è¯æ¡†
        function closeScoreDialog() {
            document.getElementById('scoreInfoModal').classList.add('hidden');
        }

        // å†…éƒ¨æäº¤åˆ†æ•°å‡½æ•°ï¼ˆé‡å‘½ååŸsubmitScoreå‡½æ•°ï¼‰
        function submitScoreInternal(score) {
            // æ›´æ–°ç”¨æˆ·æ¸¸æˆåˆ†æ•°
            userGameScores[currentGame] = score;

            // ç§»é™¤ä¹‹å‰çš„ç”¨æˆ·è®°å½•
            ['weekly', 'monthly'].forEach(tab => {
                leaderboardData[currentGame][tab] = leaderboardData[currentGame][tab].filter(item => item.name !== 'æˆ‘');
            });

            // æ·»åŠ åˆ°æ’è¡Œæ¦œæ•°æ®
            const userEntry = {
                rank: 0,
                name: 'æˆ‘',
                score: score,
                age: userAge
            };

            // æ·»åŠ åˆ°æ‰€æœ‰ç›¸å…³æ¦œå•
            ['weekly', 'monthly'].forEach(tab => {
                leaderboardData[currentGame][tab].push(userEntry);
                leaderboardData[currentGame][tab].sort((a, b) => b.score - a.score);
                // é‡æ–°è®¡ç®—æ’å
                leaderboardData[currentGame][tab].forEach((item, index) => {
                    item.rank = index + 1;
                });
            });

            // è‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”å¹´é¾„ç»„
            const targetAgeGroup = getAgeGroup(userAge);
            currentAgeGroup = targetAgeGroup;
            updateAgeButtons();
            updateTitle();

            // è·å–ç”¨æˆ·æ’åä¿¡æ¯
            const userRank = leaderboardData[currentGame][currentTab].findIndex(item => item.name === 'æˆ‘') + 1;
            document.getElementById('rankInfo').textContent = `ä½ åœ¨${games[currentGame].name}ä¸­æ’åç¬¬ ${userRank} ä½ï¼`;

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            updateUserInfo();
            
            // é‡æ–°ç”Ÿæˆæ¸¸æˆåˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°çš„åˆ†æ•°
            generateGameList();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            document.getElementById('successModal').classList.remove('hidden');

            updateLeaderboard();

            setTimeout(() => {
                const userItem = document.querySelector('.user-highlight');
                if (userItem) {
                    userItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
            
            window.parent.postMessage({ 
                type: 'scoreUpdated', 
                data: {
                    game: currentGame,
                    score: score,
                    userGameScores: userGameScores
                }
            }, '*');
        }
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        
        function initializePage() {
            if (!games || Object.keys(games).length === 0) {
                games = defaultGames;
            }
            
            generateGameList();
            initializeData();
            updateUserInfo();
            updateTitle();
            updateLeaderboard();

            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                errorModal.addEventListener('click', function(e) {
                    if (e.target === errorModal) {
                        closeErrorModal();
                    }
                });
            }
            
            window.parent.postMessage({ type: 'gameLoaded' }, '*');
        }
        initializePage();
    </script>
</body>
</html>

