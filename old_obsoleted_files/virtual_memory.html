<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§†è§‰è®°å¿†æ—‹è½¬æ¸¸æˆ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        /* å…¨å±é€‚é… */
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .game-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        .game-info {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #374151;
            font-size: 1.4rem; /* ä» 1.2rem å¢å¤§åˆ° 1.4rem */
            min-height: 50px;
        }

        @media (max-width: 640px) {
            .game-info {
                padding: 0.25rem 0.5rem;
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
                min-height: 40px;
            }
        }

        /* æ¸¸æˆçŠ¶æ€æ  */
        .status-bar {
            text-align: center;
            padding: 0.5rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(31, 41, 55, 0.5);
            font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
        }

        @media (max-width: 640px) {
            .status-bar {
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            background: rgba(31, 41, 55, 0.9);
            border-top: 1px solid #374151;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
            min-height: 36px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
                min-height: 32px;
            }
        }

        /* å¢å¤§æ¸¸æˆç½‘æ ¼é€‚é… */
        .grid-cell {
            transition: all 0.3s ease;
            background-color: #4b5563 !important;
            cursor: pointer;
            border: 1px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        @media (hover: hover) {
            .grid-cell:hover {
                background-color: #6b7280 !important;
                transform: scale(1.05);
            }
        }

        .grid-cell:active {
            background-color: #6b7280 !important;
            transform: scale(1.05);
        }

        .grid-container {
            transition: transform 2s ease-in-out;
            display: grid;
            gap: 6px; /* ä» 4px å¢å¤§åˆ° 6px */
            padding: 12px; /* ä» 8px å¢å¤§åˆ° 12px */
            background-color: #374151;
            border-radius: 12px;
            max-width: 90vmin; /* ä» 95vmin å‡å°‘åˆ° 90vminï¼Œä½†ä¼šå› ä¸ºæ ¼å­å˜å¤§è€Œæ•´ä½“æ›´å¤§ */
            max-height: 75vh; /* ä» 70vh å¢å¤§åˆ° 75vh */
            margin: 0 auto;
            width: fit-content;
            height: fit-content;
        }

        .grid-container.no-transition {
            transition: none !important;
        }

        /* çŠ¶æ€æ ·å¼ */
        .highlighted {
            background-color: #10b981 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
        }
        .correct {
            background-color: #10b981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .incorrect {
            background-color: #ef4444 !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .pulse-green {
            animation: pulseGreen 0.5s ease-in-out;
        }
        .pulse-red {
            animation: pulseRed 0.5s ease-in-out;
        }

        @keyframes pulseGreen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }
        @keyframes pulseRed {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); }
        }

        /* å“åº”å¼ç½‘æ ¼å¤§å°ä¼˜åŒ– */
        @media (max-width: 640px) {
            .grid-cell {
                min-height: 40px; /* ä» 32px å¢å¤§åˆ° 40px */
                min-width: 40px; /* ä» 32px å¢å¤§åˆ° 40px */
                font-size: 1.3rem; /* ä» 1.1rem å¢å¤§åˆ° 1.3rem */
            }
            .grid-container {
                gap: 5px; /* ä» 3px å¢å¤§åˆ° 5px */
                padding: 10px; /* ä» 6px å¢å¤§åˆ° 10px */
                max-height: 70vh; /* ä» 65vh å¢å¤§åˆ° 70vh */
                max-width: 95vmin; /* ä» 98vmin å‡å°‘åˆ° 95vmin */
            }
        }

        @media (max-height: 600px) {
            .grid-cell {
                min-height: 36px; /* ä» 28px å¢å¤§åˆ° 36px */
                min-width: 36px; /* ä» 28px å¢å¤§åˆ° 36px */
                font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
            }
            .grid-container {
                gap: 4px; /* ä» 2px å¢å¤§åˆ° 4px */
                padding: 8px; /* ä» 4px å¢å¤§åˆ° 8px */
                max-height: 60vh; /* ä» 55vh å¢å¤§åˆ° 60vh */
                max-width: 95vmin; /* ä» 98vmin å‡å°‘åˆ° 95vmin */
            }
            .game-board-area {
                padding: 0.25rem;
            }
        }

        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) or (max-height: 500px) {
            .grid-cell {
                min-height: 32px; /* ä» 24px å¢å¤§åˆ° 32px */
                min-width: 32px; /* ä» 24px å¢å¤§åˆ° 32px */
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            }
            .grid-container {
                gap: 3px; /* ä» 2px å¢å¤§åˆ° 3px */
                padding: 6px; /* ä» 4px å¢å¤§åˆ° 6px */
                max-height: 55vh; /* ä» 50vh å¢å¤§åˆ° 55vh */
                max-width: 98vmin; /* ä» 100vmin å‡å°‘åˆ° 98vmin */
            }
        }

        /* è§„åˆ™å¼¹çª— */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            box-sizing: border-box;
        }

        .rules-content {
            background: #1f2937;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
        }

        .rules-content h2 {
            font-size: 1.8rem; /* ä» 1.5rem å¢å¤§åˆ° 1.8rem */
        }

        .rules-content h3 {
            font-size: 1.4rem; /* ä» 1.2rem å¢å¤§åˆ° 1.4rem */
        }

        @media (max-width: 640px) {
            .rules-content {
                padding: 1rem;
                max-width: 95vw;
                max-height: 85vh;
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            }
            
            .rules-content h2 {
                font-size: 1.6rem; /* ä» 1.3rem å¢å¤§åˆ° 1.6rem */
            }

            .rules-content h3 {
                font-size: 1.3rem; /* ä» 1.1rem å¢å¤§åˆ° 1.3rem */
            }
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            padding: 0.5rem;
            background: rgba(31, 41, 55, 0.9);
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            color: #d1d5db;
        }

        .setting-select {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
        }

        @media (max-width: 640px) {
            .settings-panel {
                padding: 0.25rem;
                gap: 0.5rem;
            }
            .setting-item {
                font-size: 1rem; /* ä» 0.8rem å¢å¤§åˆ° 1rem */
            }
            .setting-select {
                padding: 0.2rem 0.4rem;
                font-size: 1rem; /* ä» 0.8rem å¢å¤§åˆ° 1rem */
            }
        }

        /* å€’è®¡æ—¶æ˜¾ç¤º */
        .countdown-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem; /* ä» 5rem å¢å¤§åˆ° 6rem */
            font-weight: bold;
            color: #ef4444;
            z-index: 200;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            pointer-events: none;
        }

        @media (max-width: 640px) {
            .countdown-display {
                font-size: 5rem; /* ä» 4rem å¢å¤§åˆ° 5rem */
            }
        }

        /* æ¸¸æˆç»“æŸå¼¹çª— */
        .game-end-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            box-sizing: border-box;
        }

        .game-end-content {
            background: #1f2937;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            text-align: center;
            min-width: 300px;
            font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
        }

        .game-end-content h2 {
            font-size: 2.2rem; /* ä» 1.8rem å¢å¤§åˆ° 2.2rem */
        }

        .game-end-header {
            border-bottom: 1px solid #374151;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .game-end-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #374151;
            border-radius: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .stat-label {
            color: #d1d5db;
            font-size: 1.2rem; /* ä» 1rem å¢å¤§åˆ° 1.2rem */
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.6rem; /* ä» 1.3rem å¢å¤§åˆ° 1.6rem */
        }

        .game-end-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        @media (max-width: 640px) {
            .game-end-content {
                padding: 1.5rem;
                min-width: 280px;
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            }
            
            .game-end-content h2 {
                font-size: 1.8rem; /* ä» 1.5rem å¢å¤§åˆ° 1.8rem */
            }
            
            .game-end-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .stat-item {
                flex-direction: column;
                text-align: center;
                gap: 0.25rem;
            }
            
            .stat-label {
                font-size: 1.1rem; /* ä» 0.9rem å¢å¤§åˆ° 1.1rem */
            }
            
            .stat-value {
                font-size: 1.4rem; /* ä» 1.2rem å¢å¤§åˆ° 1.4rem */
            }
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
        * {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¸¸æˆä¸»ä½“åŒºåŸŸ */
        .game-board-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            min-height: 0;
            overflow: hidden;
        }

        /* ç¡®ä¿æ¸¸æˆç½‘æ ¼è‡ªé€‚åº” */
        .grid-3 { 
            grid-template-columns: repeat(3, 1fr);
        }
        .grid-3 .grid-cell {
            min-height: 70px !important; /* 3x3æ ¼å­æœ€å¤§ */
            min-width: 70px !important;
            font-size: 1.8rem !important;
        }

        .grid-4 { 
            grid-template-columns: repeat(4, 1fr);
        }
        .grid-4 .grid-cell {
            min-height: 60px !important; /* 4x4æ ¼å­ä¸­ç­‰ */
            min-width: 60px !important;
            font-size: 1.6rem !important;
        }

        .grid-5 { 
            grid-template-columns: repeat(5, 1fr);
        }
        .grid-5 .grid-cell {
            min-height: 50px !important; /* 5x5æ ¼å­è¾ƒå° */
            min-width: 50px !important;
            font-size: 1.4rem !important;
        }

        .grid-6 { 
            grid-template-columns: repeat(6, 1fr);
        }
        .grid-6 .grid-cell {
            min-height: 40px !important; /* 6x6æ ¼å­æœ€å° */
            min-width: 40px !important;
            font-size: 1.2rem !important;
        }

        /* å“åº”å¼è°ƒæ•´ - æ‰‹æœºç«¯ */
        @media (max-width: 640px) {
            .grid-3 .grid-cell {
                min-height: 55px !important;
                min-width: 55px !important;
                font-size: 1.6rem !important;
            }
            
            .grid-4 .grid-cell {
                min-height: 48px !important;
                min-width: 48px !important;
                font-size: 1.4rem !important;
            }
            
            .grid-5 .grid-cell {
                min-height: 42px !important;
                min-width: 42px !important;
                font-size: 1.3rem !important;
            }
            
            .grid-6 .grid-cell {
                min-height: 36px !important;
                min-width: 36px !important;
                font-size: 1.1rem !important;
            }
        }

        /* å“åº”å¼è°ƒæ•´ - ä½é«˜åº¦å±å¹• */
        @media (max-height: 600px) {
            .grid-3 .grid-cell {
                min-height: 48px !important;
                min-width: 48px !important;
                font-size: 1.5rem !important;
            }
            
            .grid-4 .grid-cell {
                min-height: 42px !important;
                min-width: 42px !important;
                font-size: 1.3rem !important;
            }
            
            .grid-5 .grid-cell {
                min-height: 38px !important;
                min-width: 38px !important;
                font-size: 1.2rem !important;
            }
            
            .grid-6 .grid-cell {
                min-height: 32px !important;
                min-width: 32px !important;
                font-size: 1.1rem !important;
            }
        }

        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) or (max-height: 500px) {
            .grid-3 .grid-cell {
                min-height: 42px !important;
                min-width: 42px !important;
                font-size: 1.4rem !important;
            }
            
            .grid-4 .grid-cell {
                min-height: 38px !important;
                min-width: 38px !important;
                font-size: 1.2rem !important;
            }
            
            .grid-5 .grid-cell {
                min-height: 34px !important;
                min-width: 34px !important;
                font-size: 1.1rem !important;
            }
            
            .grid-6 .grid-cell {
                min-height: 28px !important;
                min-width: 28px !important;
                font-size: 1rem !important;
            }
        }


        /* åŠ¨æ€æ›´æ–°æ ·å¼ */
        #dynamic-grid-style {
            display: none;
        }

        /* è§„åˆ™å›¾æ ‡ - å®šä½åˆ°å³ä¸‹è§’ */
        .rules-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; /* å¢å¤§å›¾æ ‡å­—ä½“ */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .rules-icon:hover {
            background: rgba(59, 130, 246, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 640px) {
            .rules-icon {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="game-container">
        <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
        <div class="game-info">
            <div class="flex items-center gap-2 text-yellow-400">
                <span class="text-base font-medium">å¾—åˆ†:</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
                <span id="score" class="font-bold text-xl">0</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
            </div>
            <div class="flex items-center gap-2 text-blue-400">
                <span class="text-base font-medium">å…³å¡:</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
                <span id="level" class="font-bold text-xl">1</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
                <span class="font-bold text-xl">/</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
                <span id="total-level" class="font-bold text-xl">1</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
            </div>
            <div class="flex items-center gap-2 text-green-400">
                <span class="text-base font-medium">ç›®æ ‡:</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
                <span id="targetCount" class="font-bold text-xl">2</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
            </div>
            <div class="flex items-center gap-2 text-red-400">
                <span class="text-base font-medium">é”™è¯¯:</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
                <span id="errorCount" class="font-bold text-xl">0</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
                <span class="font-bold text-xl">/</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
                <span class="font-bold text-xl">2</span> <!-- ä» text-lg å¢å¤§åˆ° text-xl -->
            </div>
            <div class="text-purple-400">
                <span id="gameMode" class="font-bold text-base">çº¯è‰²</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
            </div>
        </div>

        <!-- æ¸¸æˆçŠ¶æ€æ  -->
        <div id="status" class="status-bar">
            <span class="text-white text-base font-medium">ç‚¹å‡»å¼€å§‹è®­ç»ƒ</span> <!-- ä» text-sm æ”¹ä¸º text-base -->
        </div>

        <!-- æ¸¸æˆä¸»ä½“åŒºåŸŸ -->
        <div class="game-board-area">
            <div id="gameBoard" class="grid-container">
                <!-- åŠ¨æ€ç”Ÿæˆç½‘æ ¼ -->
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="control-buttons">
            <button id="startBtn" class="btn bg-green-600 hover:bg-green-700 text-white">
                å¼€å§‹è®­ç»ƒ
            </button>
        </div>

        <!--è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <div class="setting-item">
                <label>ç½‘æ ¼:</label>
                <select id="gridSize" class="setting-select">
                    <option value="3" selected>3x3</option>
                    <option value="4" selected>4x4</option>
                    <option value="5">5x5</option>
                    <option value="6">6x6</option>
                </select>
            </div>
            <div class="setting-item">
                <label>æ¨¡å¼:</label>
                <select id="gameModeSelect" class="setting-select">
                    <option value="color" selected>çº¯è‰²</option>
                    <option value="chinese">æˆè¯­</option>
                    <option value="english">å•è¯</option>
                </select>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™å¼¹çª— -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">è®­ç»ƒè§„åˆ™</h2>
                <button id="closeRules" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="text-gray-300 space-y-3 text-sm">
                <div>
                    <h3 class="font-semibold text-green-400 mb-2">ğŸ“‹ ç›®æ ‡</h3>
                    <p>è®°ä½ç»¿è‰²æ ¼å­çš„ä½ç½®ï¼Œåœ¨æ£‹ç›˜æ—‹è½¬åå‡†ç¡®ç‚¹å‡»å‡ºæ¥ï¼</p>
                </div>
                <div>
                    <h3 class="font-semibold text-blue-400 mb-2">ğŸ® æ“ä½œæ–¹æ³•</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>çº¯è‰²æ¨¡å¼</strong>ï¼šè®°ä½ç»¿è‰²æ ¼å­ä½ç½®ï¼Œæ—‹è½¬åç›´æ¥ç‚¹å‡»</li>
                        <li><strong>æˆè¯­æ¨¡å¼</strong>ï¼šè®°ä½æ±‰å­—é¡ºåºå’Œä½ç½®ï¼ŒæŒ‰é¡ºåºç‚¹å‡»æ‹¼æˆå®Œæ•´æˆè¯­</li>
                        <li><strong>å•è¯æ¨¡å¼</strong>ï¼šè®°ä½å­—æ¯é¡ºåºå’Œä½ç½®ï¼ŒæŒ‰é¡ºåºç‚¹å‡»æ‹¼æˆå®Œæ•´å•è¯</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="startGameFromRules" class="btn bg-green-600 hover:bg-green-700 text-white px-6 py-2">
                    å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div id="gameEndModal" class="game-end-modal hidden">
        <div class="game-end-content">
            <div class="game-end-header">
                <h2 class="text-2xl font-bold text-white mb-4">æ¸¸æˆç»“æŸ</h2>
            </div>
            <div class="game-end-body">
                <div id="gameEndReason" class="text-gray-300 text-center mb-4"></div>
                <div class="game-end-stats">
                    <div class="stat-item">
                        <span class="stat-label">æœ€ç»ˆåˆ†æ•°</span>
                        <span id="finalScore" class="stat-value text-yellow-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">è¾¾åˆ°å…³å¡</span>
                        <span id="finalLevel" class="stat-value text-blue-400">1</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¤±è´¥æ¬¡æ•°</span>
                        <span id="finalFailures" class="stat-value text-red-400">0</span>
                    </div>
                </div>
            </div>
            <div class="game-end-actions">
                <button id="playAgainBtn" class="btn bg-green-600 hover:bg-green-700 text-white">
                    å†æ¬¡æ¸¸æˆ
                </button>
                <button id="settleBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white">
                    ç»“ç®—
                </button>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™æŸ¥çœ‹å›¾æ ‡ -->
    <div id="rulesIcon" class="rules-icon hidden" title="æŸ¥çœ‹è§„åˆ™">
        ?
    </div>

    <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
    <div id="countdownDisplay" class="countdown-display hidden"></div>

    <script>
        // å…¨å±€å˜é‡å’Œé…ç½®
        let game_config = '';
        let globalHighestScore = 0;
        let gameStarted = false;

        // æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data;
                    updateGameConfig(game_config);
                    break;
                case 'getGameStats':
                    const difficulty = calculateDifficulty();
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: globalHighestScore,
                            difficulty: Math.min(difficulty, 3)
                        }
                    }, '*');
                    break;
            }
        });

        // æ›´æ–°æ¸¸æˆé…ç½®
        function updateGameConfig(config) {
            try {
                if (typeof config === 'string' && config.trim()) {
                    const newConfig = parseGameConfig(config);
                    if (newConfig && window.visualGame) {
                        if (newConfig.gridSize !== undefined) {
                            window.visualGame.gridSize = Math.max(3, Math.min(8, newConfig.gridSize));
                            if (window.visualGame.gridSizeSelect) {
                                window.visualGame.gridSizeSelect.value = window.visualGame.gridSize;
                            }
                            window.visualGame.createGrid();
                        }
                        if (newConfig.maxErrors !== undefined) {
                            window.visualGame.maxErrors = Math.max(1, Math.min(5, newConfig.maxErrors));
                        }
                        if (newConfig.gameMode !== undefined) {
                            window.visualGame.gameMode = newConfig.gameMode;
                            window.visualGame.gameModeSelect.value = newConfig.gameMode;
                            window.visualGame.updateGameModeUI();
                        }
                        if (newConfig.customWords !== undefined) {
                            window.visualGame.customWords = newConfig.customWords;
                        }
                        if (newConfig.customChinese !== undefined) {
                            window.visualGame.customChinese = newConfig.customChinese;
                        }
                        if (newConfig.difficulty !== undefined) {
                            window.visualGame.setDifficulty(newConfig.difficulty);
                        }
                        console.log('é…ç½®å·²æ›´æ–°');
                        window.visualGame.resetGame();
                    }
                }
            } catch (error) {
                console.warn('è§£ææ¸¸æˆé…ç½®å¤±è´¥ï¼Œä¿æŒåŸé…ç½®:', error);
            }
        }

        // è§£ææ¸¸æˆé…ç½®ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function parseGameConfig(config) {
            const result = {};
            
            try {
                const jsonData = JSON.parse(config);
                return jsonData;
            } catch (e) {
                const lines = config.trim().split('\n');
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line || line.startsWith('#')) continue;
                    
                    if (line.includes('=')) {
                        const [key, value] = line.split('=').map(s => s.trim());
                        if (key === 'gridSize') {
                            result.gridSize = parseInt(value);
                        } else if (key === 'maxErrors') {
                            result.maxErrors = parseInt(value);
                        } else if (key === 'gameMode') {
                            result.gameMode = value;
                        } else if (key === 'difficulty') {
                            result.difficulty = parseInt(value);
                        }
                    }
                }
            }
            
            return result;
        }

        /* 
         * æ¸¸æˆé…ç½®ç¤ºä¾‹:
         * 
         * é…ç½®é¡¹1 - çº¯è‰²æ¨¡å¼ (JSONæ ¼å¼):
         * {
         *   "gridSize": 4,
         *   "maxErrors": 2,
         *   "gameMode": "color"
         * }
         * 
         * é…ç½®é¡¹2 - ä¸­æ–‡æˆè¯­æ¨¡å¼ (JSONæ ¼å¼):
         * {
         *   "gridSize": 5,
         *   "maxErrors": 3,
         *   "gameMode": "chinese",
         *   "customChinese": ["ä¸‡äº‹å¦‚æ„", "å¿ƒæƒ³äº‹æˆ", "æ­¥æ­¥é«˜å‡", "è´¢æºå¹¿è¿›", "èº«ä½“å¥åº·"]
         * }
         * 
         * é…ç½®é¡¹3 - è‹±æ–‡å•è¯æ¨¡å¼ (JSONæ ¼å¼):
         * {
         *   "gridSize": 4,
         *   "maxErrors": 2,
         *   "gameMode": "english",
         *   "customWords": ["APPLE", "BANANA", "CHERRY", "DRAGON", "EAGLE"]
         * }
         */

        // è®¡ç®—å½“å‰éš¾åº¦
        function calculateDifficulty() {
            if (!window.visualGame) return 1;
            
            const game = window.visualGame;
            let difficultyScore = 0;
            
            // åŸºäºå…³å¡
            if (game.level >= 15) difficultyScore += 2;
            else if (game.level >= 8) difficultyScore += 1;
            
            // åŸºäºç½‘æ ¼å¤§å°
            if (game.gridSize >= 6) difficultyScore += 2;
            else if (game.gridSize >= 5) difficultyScore += 1;
            
            // åŸºäºé”™è¯¯å®¹å¿åº¦ï¼ˆé”™è¯¯æ¬¡æ•°è¶Šå°‘è¶Šéš¾ï¼‰
            if (game.maxErrors <= 1) difficultyScore += 1;
            
            // åŸºäºç´¯è®¡å¤±è´¥æ¬¡æ•°ï¼ˆå¤±è´¥æ¬¡æ•°è¶Šå¤šè¯´æ˜éš¾åº¦è¶Šé«˜ï¼‰
            if (game.totalFailures >= 3) difficultyScore += 1;
            
            return Math.min(Math.max(difficultyScore, 1), 3);
        }

        class VisualMemoryGame {
            constructor() {
                this.gridSize = 4; // é»˜è®¤4x4
                this.originalPattern = []; // åŸå§‹ä½ç½®çš„ç›®æ ‡æ ¼å­
                this.correctClicks = [];
                this.gameState = 'waiting'; // waiting, showing, rotating, rotated, finished
                this.score = 0;
                this.level = 1;
                this.errorCount = 0;
                this.maxErrors = 2;
                this.currentRotation = 0; // å½“å‰æ—‹è½¬è§’åº¦
                this.gameMode = 'color'; // æ¸¸æˆæ¨¡å¼ï¼šcolor, chinese, english
                this.sequenceChars = []; // å­˜å‚¨å½“å‰åºåˆ—çš„å­—ç¬¦å†…å®¹
                this.currentWord = ''; // å½“å‰å®Œæ•´çš„è¯æ±‡

                // æ·»åŠ æ¸¸æˆç»“æŸæ¡ä»¶ç›¸å…³å±æ€§
                this.maxLevels = 10; // æœ€å¤§å…³å¡æ•°
                this.totalFailures = 0; // ç´¯è®¡å¤±è´¥æ¬¡æ•°
                this.maxFailures = 3; // æœ€å¤§å¤±è´¥æ¬¡æ•°é™åˆ¶
                this.startTime = 0; // æ¸¸æˆå¼€å§‹æ—¶é—´
                this.maxPlayTime = 600000; // æœ€å¤§æ¸¸æˆæ—¶é•¿ï¼ˆ10åˆ†é’Ÿï¼‰
                this.difficulty = 2; // éš¾åº¦ç­‰çº§ï¼š1-ç®€å•ï¼Œ2-ä¸­ç­‰ï¼Œ3-å›°éš¾
                
                // é¢„å®šä¹‰è¯åº“
                this.chineseWords = [
                    'ä¸€å¿ƒä¸€æ„', 'äºŒé¾™æˆç ', 'ä¸‰å¿ƒäºŒæ„', 'å››é¢æ¥šæ­Œ', 'äº”æ¹–å››æµ·',
                    'å…­ç¥æ— ä¸»', 'ä¸ƒä¸Šå…«ä¸‹', 'å…«ä»™è¿‡æµ·', 'ä¹ç‰›ä¸€æ¯›', 'åå…¨åç¾',
                    'ç™¾å‘ç™¾ä¸­', 'åƒå†›ä¸‡é©¬', 'ä¸‡äº‹å¦‚æ„', 'ä¸œå±±å†èµ·', 'å—è¾•åŒ—è¾™',
                    'è¥¿é£æ®‹ç…§', 'åŒ—æ–—ä¸ƒæ˜Ÿ', 'æ˜¥æš–èŠ±å¼€', 'å¤æ—¥ç‚ç‚', 'ç§‹é«˜æ°”çˆ½'
                ];
                
                this.englishWords = [
                    'APPLE', 'BRAVE', 'CLOUD', 'DREAM', 'EAGLE', 'FLAME', 'GRACE',
                    'HEART', 'IVORY', 'JEWEL', 'KNIFE', 'LIGHT', 'MAGIC', 'NOBLE',
                    'OCEAN', 'PEACE', 'QUEEN', 'RIVER', 'STORM', 'TIGER'
                ];
                
                this.customWords = []; // è‡ªå®šä¹‰è‹±æ–‡è¯åº“
                this.customChinese = []; // è‡ªå®šä¹‰ä¸­æ–‡æˆè¯­è¯åº“
                
                this.initializeElements();
                this.initializeRulesModal();
                this.initializeGameEndModal();
                this.createGrid();
                this.bindEvents();
                this.updateGameModeUI();
                this.addTouchSupport();
                
                window.visualGame = this;
                
                // æ¸¸æˆå¼€å§‹æ—¶æ˜¾ç¤ºè§„åˆ™
                this.showRulesModal();
            }

            // æ·»åŠ è®¾ç½®éš¾åº¦çš„æ–¹æ³•
            setDifficulty(level) {
                level = Math.max(1, Math.min(3, level)); // é™åˆ¶åœ¨1-3ä¹‹é—´
                this.difficulty = level;
                
                // æ ¹æ®éš¾åº¦è°ƒæ•´æ¸¸æˆå‚æ•°
                switch(level) {
                    case 1: // ç®€å•
                        this.gridSize = 3;
                        this.maxErrors = 3;
                        this.maxFailures = 5;
                        this.maxLevels = 8;
                        break;
                    case 2: // ä¸­ç­‰
                        this.gridSize = 4;
                        this.maxErrors = 2;
                        this.maxFailures = 3;
                        this.maxLevels = 10;
                        break;
                    case 3: // å›°éš¾
                        this.gridSize = 5;
                        this.maxErrors = 1;
                        this.maxFailures = 2;
                        this.maxLevels = 12;
                        break;
                }
                
                // æ›´æ–°UIæ˜¾ç¤º
                if (this.gridSizeSelect) {
                    this.gridSizeSelect.value = this.gridSize;
                }
                
                // é‡æ–°åˆ›å»ºç½‘æ ¼å’Œæ›´æ–°æ˜¾ç¤º
                this.createGrid();
                this.updateGameModeUI();
                this.resetGame();
                
                console.log(`éš¾åº¦å·²è®¾ç½®ä¸º: ${level} (${level === 1 ? 'ç®€å•' : level === 2 ? 'ä¸­ç­‰' : 'å›°éš¾'})`);
            }

            // åˆå§‹åŒ–DOMå…ƒç´ 
            initializeElements() {
                this.gameBoard = document.getElementById('gameBoard');
                this.statusElement = document.getElementById('status');
                this.scoreElement = document.getElementById('score');
                this.levelElement = document.getElementById('level');
                this.totalLevelElement = document.getElementById('total-level');
                this.targetCountElement = document.getElementById('targetCount');
                this.errorCountElement = document.getElementById('errorCount');
                this.startBtn = document.getElementById('startBtn');
                this.gridSizeSelect = document.getElementById('gridSize');
                this.gameModeSelect = document.getElementById('gameModeSelect');
                this.gameModeElement = document.getElementById('gameMode');
                this.countdownDisplay = document.getElementById('countdownDisplay');
                this.rulesIcon = document.getElementById('rulesIcon');
                
                // æ›´æ–°æ€»å…³å¡æ•°æ˜¾ç¤º
                if (this.totalLevelElement) {
                    this.totalLevelElement.textContent = this.maxLevels;
                }
            }

            // åˆå§‹åŒ–è§„åˆ™å¼¹çª—
            initializeRulesModal() {
                this.rulesModal = document.getElementById('rulesModal');
                this.closeRulesBtn = document.getElementById('closeRules');
                this.startGameFromRulesBtn = document.getElementById('startGameFromRules');
                
                // æ˜¾ç¤ºè§„åˆ™å›¾æ ‡
                if (this.rulesIcon) {
                    this.rulesIcon.classList.remove('hidden');
                }
            }

            // åˆå§‹åŒ–æ¸¸æˆç»“æŸå¼¹çª—
            initializeGameEndModal() {
                this.gameEndModal = document.getElementById('gameEndModal');
                this.gameEndReasonElement = document.getElementById('gameEndReason');
                this.finalScoreElement = document.getElementById('finalScore');
                this.finalLevelElement = document.getElementById('finalLevel');
                this.finalFailuresElement = document.getElementById('finalFailures');
                this.playAgainBtn = document.getElementById('playAgainBtn');
                this.settleBtn = document.getElementById('settleBtn');
            }

            // åˆ›å»ºç½‘æ ¼
            createGrid() {
                this.gameBoard.innerHTML = '';
                this.gameBoard.className = `grid-container grid-${this.gridSize}`;
                
                const totalCells = this.gridSize * this.gridSize;
                for (let i = 0; i < totalCells; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.addEventListener('click', () => this.cellClicked(i));
                    this.gameBoard.appendChild(cell);
                }
                
                this.updateDisplay();
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startGame());
                
                this.gridSizeSelect.addEventListener('change', (e) => {
                    this.gridSize = parseInt(e.target.value);
                    this.createGrid();
                    this.resetGame();
                });
                
                this.gameModeSelect.addEventListener('change', (e) => {
                    this.gameMode = e.target.value;
                    this.updateGameModeUI();
                    this.resetGame();
                });
                
                // è§„åˆ™å¼¹çª—äº‹ä»¶
                this.closeRulesBtn.addEventListener('click', () => this.hideRulesModal());
                this.startGameFromRulesBtn.addEventListener('click', () => {
                    this.hideRulesModal();
                    this.startGame();
                });
                this.rulesIcon.addEventListener('click', () => this.showRulesModal());
                
                // æ¸¸æˆç»“æŸå¼¹çª—äº‹ä»¶
                this.playAgainBtn.addEventListener('click', () => {
                    this.hideGameEndModal();
                    this.resetGame();
                });
                this.settleBtn.addEventListener('click', () => {
                    this.hideGameEndModal();
                    this.sendGameFinishedMessage();
                });
                
                // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
                this.rulesModal.addEventListener('click', (e) => {
                    if (e.target === this.rulesModal) {
                        this.hideRulesModal();
                    }
                });
                
                this.gameEndModal.addEventListener('click', (e) => {
                    if (e.target === this.gameEndModal) {
                        this.hideGameEndModal();
                    }
                });
            }

            // æ˜¾ç¤ºè§„åˆ™å¼¹çª—
            showRulesModal() {
                this.rulesModal.classList.remove('hidden');
            }

            // éšè—è§„åˆ™å¼¹çª—
            hideRulesModal() {
                this.rulesModal.classList.add('hidden');
            }

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
            showGameEndModal(reason) {
                this.gameEndReasonElement.textContent = reason;
                this.finalScoreElement.textContent = this.calculatePercentageScore();
                this.finalLevelElement.textContent = this.level;
                this.finalFailuresElement.textContent = this.totalFailures;
                this.gameEndModal.classList.remove('hidden');
            }

            // éšè—æ¸¸æˆç»“æŸå¼¹çª—
            hideGameEndModal() {
                this.gameEndModal.classList.add('hidden');
            }

            // æ›´æ–°æ¸¸æˆæ¨¡å¼UI
            updateGameModeUI() {
                if (this.gameModeElement) {
                    switch(this.gameMode) {
                        case 'color':
                            this.gameModeElement.textContent = 'çº¯è‰²';
                            break;
                        case 'chinese':
                            this.gameModeElement.textContent = 'æˆè¯­';
                            break;
                        case 'english':
                            this.gameModeElement.textContent = 'å•è¯';
                            break;
                    }
                }
                
                // æ›´æ–°æ€»å…³å¡æ•°æ˜¾ç¤º
                if (this.totalLevelElement) {
                    this.totalLevelElement.textContent = this.maxLevels;
                }
                
                this.updateTargetCount();
            }

            // è·å–è¯åº“
            getWordBank() {
                if (this.gameMode === 'chinese') {
                    return this.customChinese.length > 0 ? this.customChinese : this.chineseWords;
                } else if (this.gameMode === 'english') {
                    return this.customWords.length > 0 ? this.customWords : this.englishWords;
                }
                return [];
            }

            // æ·»åŠ è§¦æ‘¸æ”¯æŒ
            addTouchSupport() {
                // é˜²æ­¢åŒå‡»ç¼©æ”¾
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            generatePattern() {
                if (this.gameMode === 'color') {
                    let numCells;
                    
                    // æ ¹æ®éš¾åº¦è°ƒæ•´ç›®æ ‡æ ¼å­æ•°é‡
                    const difficultyMultiplier = this.difficulty === 1 ? 0.8 : this.difficulty === 3 ? 1.2 : 1;
                    let extraCells = Math.max(0, this.gridSize - 4); // é¢å¤–æ ¼å­æ•°
                    
                    if (this.level <= 3) {
                        numCells = Math.ceil(2 * difficultyMultiplier);
                    } else if (this.level <= 6) {
                        numCells = Math.ceil(3 * difficultyMultiplier);
                    } else if (this.level <= 10) {
                        numCells = Math.ceil(4 * difficultyMultiplier);
                    } else if (this.level <= 15) {
                        numCells = Math.ceil(5 * difficultyMultiplier);
                    } else {
                        numCells = Math.min(Math.ceil(6 * difficultyMultiplier), Math.floor(this.gridSize * this.gridSize * 0.4));
                    }
                    numCells += extraCells; // æ·»åŠ é¢å¤–æ ¼å­æ•°
                    
                    // ç¡®ä¿è‡³å°‘æœ‰1ä¸ªæ ¼å­ï¼Œæœ€å¤šä¸è¶…è¿‡æ€»æ ¼å­æ•°çš„ä¸€åŠ
                    numCells = Math.max(1, Math.min(numCells, Math.floor(this.gridSize * this.gridSize / 2)));
                    
                    const totalCells = this.gridSize * this.gridSize;
                    this.originalPattern = [];
                    
                    while (this.originalPattern.length < numCells) {
                        const randomIndex = Math.floor(Math.random() * totalCells);
                        if (!this.originalPattern.includes(randomIndex)) {
                            this.originalPattern.push(randomIndex);
                        }
                    }
                } else {
                    const wordBank = this.getWordBank();
                    this.currentWord = wordBank[Math.floor(Math.random() * wordBank.length)];
                    this.sequenceChars = this.currentWord.split('');
                    
                    const totalCells = this.gridSize * this.gridSize;
                    this.originalPattern = [];
                    
                    while (this.originalPattern.length < this.sequenceChars.length) {
                        const randomIndex = Math.floor(Math.random() * totalCells);
                        if (!this.originalPattern.includes(randomIndex)) {
                            this.originalPattern.push(randomIndex);
                        }
                    }
                }
            }

            updateTargetCount() {
                if (!this.targetCountElement) return;
                
                if (this.gameMode === 'color') {
                    let numCells;
                    
                    // æ ¹æ®éš¾åº¦è°ƒæ•´ç›®æ ‡æ ¼å­æ•°é‡
                    const difficultyMultiplier = this.difficulty === 1 ? 0.8 : this.difficulty === 3 ? 1.2 : 1;
                    let extraCells = Math.max(0, this.gridSize - 4); // é¢å¤–æ ¼å­æ•°
                    
                    if (this.level <= 3) {
                        numCells = Math.ceil(2 * difficultyMultiplier);
                    } else if (this.level <= 6) {
                        numCells = Math.ceil(3 * difficultyMultiplier);
                    } else if (this.level <= 10) {
                        numCells = Math.ceil(4 * difficultyMultiplier);
                    } else if (this.level <= 15) {
                        numCells = Math.ceil(5 * difficultyMultiplier);
                    } else {
                        numCells = Math.min(Math.ceil(6 * difficultyMultiplier), Math.floor(this.gridSize * this.gridSize * 0.4));
                    }
                    numCells += extraCells; // æ·»åŠ é¢å¤–æ ¼å­æ•°
                    
                    // ç¡®ä¿è‡³å°‘æœ‰1ä¸ªæ ¼å­ï¼Œæœ€å¤šä¸è¶…è¿‡æ€»æ ¼å­æ•°çš„ä¸€åŠ
                    numCells = Math.max(1, Math.min(numCells, Math.floor(this.gridSize * this.gridSize / 2)));
                    
                    this.targetCountElement.textContent = numCells;
                } else {
                    const wordBank = this.getWordBank();
                    if (wordBank.length > 0) {
                        const avgLength = Math.round(wordBank.reduce((sum, word) => sum + word.length, 0) / wordBank.length);
                        this.targetCountElement.textContent = `${avgLength}å­—`;
                    } else {
                        this.targetCountElement.textContent = '4å­—';
                    }
                }
            }
            
            startGame() {
                if (!gameStarted) {
                    this.startTime = Date.now();
                    window.parent.postMessage({ type: 'gameStarted' }, '*');
                    gameStarted = true;
                }

                if (this.shouldEndGame()) {
                    this.endGame();
                    return;
                }

                this.gameState = 'showing';
                this.correctClicks = [];
                this.errorCount = 0;
                this.generatePattern();
                this.showPattern();
                
                this.startBtn.classList.add('hidden');
                this.updateTargetCount();
                this.updateErrorCount();
            }

            startCountdown(seconds, callback) {
                if (this.countdownDisplay) {
                    this.countdownDisplay.classList.remove('hidden');
                    
                    let remaining = seconds;
                    this.countdownDisplay.textContent = remaining;
                    
                    const timer = setInterval(() => {
                        remaining--;
                        if (remaining > 0) {
                            this.countdownDisplay.textContent = remaining;
                        } else {
                            clearInterval(timer);
                            this.countdownDisplay.classList.add('hidden');
                            callback();
                        }
                    }, 1000);
                } else {
                    // å¦‚æœå€’è®¡æ—¶å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ
                    setTimeout(callback, seconds * 1000);
                }
            }

            shouldEndGame() {
                // console.log(`æœ€å¤§å…³å¡æ•°: ${this.maxLevels}, æœ€å¤§å¤±è´¥æ¬¡æ•°: ${this.maxFailures}, æœ€å¤§æ¸¸æˆæ—¶é•¿: ${this.maxPlayTime}ms`);
                // console.log(`æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶: å…³å¡=${this.level}, å¤±è´¥æ¬¡æ•°=${this.totalFailures}, å½“å‰æ¸¸æˆæ—¶é•¿=${Date.now() - this.startTime}ms`);
                if (this.level > this.maxLevels) {
                    return true;
                }
                
                if (this.totalFailures >= this.maxFailures) {
                    return true;
                }
                
                if (this.startTime > 0 && (Date.now() - this.startTime) > this.maxPlayTime) {
                    return true;
                }
                
                return false;
            }

            endGame() {
                this.gameState = 'finished';
                
                // ç¡®å®šæ¸¸æˆç»“æŸåŸå› 
                let endReason = '';
                if (this.level > this.maxLevels) {
                    endReason = `æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰${this.maxLevels}ä¸ªå…³å¡ï¼`;
                } else if (this.totalFailures >= this.maxFailures) {
                    endReason = `å¤±è´¥æ¬¡æ•°å·²è¾¾åˆ°ä¸Šé™(${this.maxFailures}æ¬¡)ï¼Œæ¸¸æˆç»“æŸï¼`;
                } else if (this.startTime > 0 && (Date.now() - this.startTime) > this.maxPlayTime) {
                    endReason = 'æ¸¸æˆæ—¶é—´å·²åˆ°ï¼Œæ¸¸æˆç»“æŸï¼';
                } else {
                    endReason = 'æ¸¸æˆç»“æŸï¼';
                }
                
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
                this.showGameEndModal(endReason);
                
                // æ›´æ–°æœ€é«˜åˆ†
                const finalScore = this.calculatePercentageScore();
                if (finalScore > globalHighestScore) {
                    globalHighestScore = finalScore;
                }
            }

            sendGameFinishedMessage() {
                const finalScore = this.calculatePercentageScore();
                const difficulty = calculateDifficulty();
                
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: {
                        score: finalScore,
                        highestScore: Math.max(globalHighestScore, finalScore),
                        level: this.level,
                        gridSize: this.gridSize,
                        difficulty: Math.min(difficulty, 3),
                        totalFailures: this.totalFailures,
                        playTime: this.startTime > 0 ? Date.now() - this.startTime : 0
                    }
                }, '*');
            }

            calculatePercentageScore() {
                const levelScore = Math.min(40, (this.level - 1) / this.maxLevels * 40);
                const maxPossibleScore = 2000;
                const rawScore = Math.min(40, (this.score / maxPossibleScore) * 40);
                const accuracyScore = Math.max(0, 20 - (this.totalFailures / this.maxFailures * 20));
                
                const totalScore = Math.round(levelScore + rawScore + accuracyScore);
                
                return Math.max(0, Math.min(100, totalScore));
            }

            generatePattern() {
                if (this.gameMode === 'color') {
                    let numCells;
                    
                    // æ ¹æ®éš¾åº¦è°ƒæ•´ç›®æ ‡æ ¼å­æ•°é‡
                    const difficultyMultiplier = this.difficulty === 1 ? 0.8 : this.difficulty === 3 ? 1.2 : 1;
                    let extraCells = Math.max(0, this.gridSize - 4); // é¢å¤–æ ¼å­æ•°
                    
                    if (this.level <= 3) {
                        numCells = Math.ceil(2 * difficultyMultiplier);
                    } else if (this.level <= 6) {
                        numCells = Math.ceil(3 * difficultyMultiplier);
                    } else if (this.level <= 10) {
                        numCells = Math.ceil(4 * difficultyMultiplier);
                    } else if (this.level <= 15) {
                        numCells = Math.ceil(5 * difficultyMultiplier);
                    } else {
                        numCells = Math.min(Math.ceil(6 * difficultyMultiplier), Math.floor(this.gridSize * this.gridSize * 0.4));
                    }
                    numCells += extraCells; // æ·»åŠ é¢å¤–æ ¼å­æ•°
                    
                    // ç¡®ä¿è‡³å°‘æœ‰1ä¸ªæ ¼å­ï¼Œæœ€å¤šä¸è¶…è¿‡æ€»æ ¼å­æ•°çš„ä¸€åŠ
                    numCells = Math.max(1, Math.min(numCells, Math.floor(this.gridSize * this.gridSize / 2)));
                    
                    const totalCells = this.gridSize * this.gridSize;
                    this.originalPattern = [];
                    
                    while (this.originalPattern.length < numCells) {
                        const randomIndex = Math.floor(Math.random() * totalCells);
                        if (!this.originalPattern.includes(randomIndex)) {
                            this.originalPattern.push(randomIndex);
                        }
                    }
                } else {
                    const wordBank = this.getWordBank();
                    this.currentWord = wordBank[Math.floor(Math.random() * wordBank.length)];
                    this.sequenceChars = this.currentWord.split('');
                    
                    const totalCells = this.gridSize * this.gridSize;
                    this.originalPattern = [];
                    
                    while (this.originalPattern.length < this.sequenceChars.length) {
                        const randomIndex = Math.floor(Math.random() * totalCells);
                        if (!this.originalPattern.includes(randomIndex)) {
                            this.originalPattern.push(randomIndex);
                        }
                    }
                }
            }

            showPattern() {
                this.clearAllHighlights();
                
                if (this.gameMode === 'color') {
                    this.originalPattern.forEach(index => {
                        const cell = this.gameBoard.children[index];
                        cell.classList.add('highlighted');
                    });
                    
                    this.statusElement.innerHTML = '<span class="text-green-400">è®°ä½ç»¿è‰²æ ¼å­ä½ç½®...</span>';
                    
                    this.startCountdown(4, () => {
                        this.rotateBoard();
                    });
                } else {
                    this.showSequentialPattern();
                }
            }

            showSequentialPattern() {
                this.statusElement.innerHTML = `<span class="text-green-400">è®°ä½å­—ç¬¦é¡ºåº: ${this.currentWord}</span>`;
                
                let currentIndex = 0;
                const showNextChar = () => {
                    if (currentIndex < this.originalPattern.length) {
                        const cellIndex = this.originalPattern[currentIndex];
                        const char = this.sequenceChars[currentIndex];
                        const cell = this.gameBoard.children[cellIndex];
                        
                        this.clearAllHighlights();
                        
                        cell.classList.add('highlighted');
                        cell.textContent = char;
                        
                        currentIndex++;
                        
                        setTimeout(showNextChar, 1200);
                    } else {
                        this.statusElement.innerHTML = `<span class="text-yellow-400">å®Œæ•´${this.gameMode === 'chinese' ? 'æˆè¯­' : 'å•è¯'}: ${this.currentWord}</span>`;
                        setTimeout(() => {
                            this.clearAllHighlights();
                            this.clearAllText();
                            this.rotateBoard();
                        }, 1500);
                    }
                };
                
                showNextChar();
            }

            rotateBoard() {
                this.gameState = 'rotating';
                
                this.clearAllHighlights();
                
                this.statusElement.innerHTML = '<span class="text-orange-400">æ£‹ç›˜æ­£åœ¨æ—‹è½¬...</span>';
                
                const rotationOptions = [-90, 90, 180];
                const appliedRotation = rotationOptions[Math.floor(Math.random() * rotationOptions.length)];
                
                this.currentRotation += appliedRotation;
                
                this.gameBoard.style.transform = `rotate(${this.currentRotation}deg)`;
                
                setTimeout(() => {
                    this.gameState = 'rotated';
                    if (this.gameMode === 'color') {
                        this.statusElement.innerHTML = '<span class="text-blue-400">ç‚¹å‡»ç»¿è‰²æ ¼å­ä½ç½®ï¼</span>';
                    } else {
                        this.statusElement.innerHTML = `<span class="text-blue-400">æŒ‰é¡ºåºæ‹¼æˆ: ${this.currentWord}</span>`;
                    }
                }, 2000);
            }

            cellClicked(originalIndex) {
                if (this.gameState !== 'rotated') return;

                const cell = this.gameBoard.children[originalIndex];
                
                if (cell.classList.contains('correct') || cell.classList.contains('incorrect')) {
                    return;
                }
                
                let isCorrect = false;
                
                if (this.gameMode === 'color') {
                    isCorrect = this.originalPattern.includes(originalIndex);
                } else {
                    const expectedIndex = this.originalPattern[this.correctClicks.length];
                    isCorrect = (originalIndex === expectedIndex);
                }
                
                if (isCorrect) {
                    cell.classList.add('correct', 'pulse-green');
                    this.correctClicks.push(originalIndex);
                    
                    if (this.gameMode !== 'color') {
                        const charIndex = this.correctClicks.length - 1;
                        cell.textContent = this.sequenceChars[charIndex];
                        
                        const currentProgress = this.sequenceChars.slice(0, this.correctClicks.length).join('');
                        this.statusElement.innerHTML = `<span class="text-blue-400">è¿›åº¦: ${currentProgress} / ${this.currentWord}</span>`;
                    }
                    
                    if (this.correctClicks.length === this.originalPattern.length) {
                        this.gameCompleted(true);
                    }
                } else {
                    cell.classList.add('incorrect', 'pulse-red');
                    this.errorCount++;
                    this.updateErrorCount();
                    
                    if (this.errorCount >= this.maxErrors) {
                        this.gameCompleted(false);
                    }
                }
            }

            gameCompleted(success) {
                this.gameState = 'finished';
                
                this.originalPattern.forEach((originalIndex, i) => {
                    const cell = this.gameBoard.children[originalIndex];
                    if (!cell.classList.contains('correct')) {
                        cell.classList.add('correct');
                    }
                    
                    if (this.gameMode !== 'color' && this.sequenceChars[i]) {
                        cell.textContent = this.sequenceChars[i];
                    }
                });
                
                if (success) {
                    let basePoints;
                    if (this.gameMode === 'color') {
                        basePoints = this.originalPattern.length * 20;
                    } else {
                        basePoints = this.sequenceChars.length * 25;
                    }
                    const levelBonus = this.level * 10;
                    const points = basePoints + levelBonus;
                    
                    this.score += points;
                    this.level++;
            
                    if (this.gameMode !== 'color') {
                        this.statusElement.innerHTML = `<span class="text-green-400">å®Œç¾æ‹¼å‡º"${this.currentWord}"ï¼+${points}åˆ†</span>`;
                    } else {
                        this.statusElement.innerHTML = `<span class="text-green-400">å®Œç¾ï¼+${points}åˆ†</span>`;
                    }
                    
                    const currentPercentageScore = this.calculatePercentageScore();
                    if (currentPercentageScore > globalHighestScore) {
                        globalHighestScore = currentPercentageScore;
                    }
                } else {
                    this.totalFailures++;
                    
                    if (this.gameMode !== 'color') {
                        this.statusElement.innerHTML = `<span class="text-red-400">é”™è¯¯å¤ªå¤šï¼ç­”æ¡ˆ: "${this.currentWord}"</span>`;
                    } else {
                        this.statusElement.innerHTML = `<span class="text-red-400">é”™è¯¯å¤ªå¤šï¼æ­£ç¡®ç­”æ¡ˆå·²æ˜¾ç¤º</span>`;
                    }
                }

                this.updateDisplay();
        
                if (this.shouldEndGame()) {
                    setTimeout(() => {
                        this.endGame();
                    }, 2000);
                } else {
                    setTimeout(() => {
                        this.autoStartNextRound();
                    }, 2000);
                }
            }

            autoStartNextRound() {
                this.gameBoard.classList.add('no-transition');
                
                this.currentRotation = 0;
                this.gameBoard.style.transform = 'rotate(0deg)';
                
                this.clearAllHighlights();
                this.clearAllText();
                
                this.gameBoard.offsetHeight;
                
                setTimeout(() => {
                    this.gameBoard.classList.remove('no-transition');
                    this.startGame();
                }, 50);
            }

            clearAllHighlights() {
                const cells = this.gameBoard.children;
                for (let cell of cells) {
                    cell.classList.remove('highlighted', 'correct', 'incorrect', 'pulse-green', 'pulse-red');
                }
            }

            clearAllText() {
                const cells = this.gameBoard.children;
                for (let cell of cells) {
                    cell.textContent = '';
                }
            }

            resetGameState() {
                this.score = 0;
                this.level = 1;
                this.totalFailures = 0;
                this.startTime = 0;
                
                this.currentRotation = 0;
                this.gameBoard.classList.add('no-transition');
                this.gameBoard.style.transform = 'rotate(0deg)';
                this.gameBoard.offsetHeight;
                this.gameBoard.classList.remove('no-transition');
                
                this.clearAllHighlights();
                this.clearAllText();
                this.gameState = 'waiting';
                this.startBtn.classList.remove('hidden');
                this.statusElement.innerHTML = '<span class="text-white">ç‚¹å‡»å¼€å§‹æ¸¸æˆ</span>';
                this.updateDisplay();
                this.updateTargetCount();
                this.errorCount = 0;
                this.updateErrorCount();
                
                gameStarted = false;
            }

            resetGame() {
                // ç›´æ¥é‡ç½®æ¸¸æˆçŠ¶æ€ï¼Œä¸è°ƒç”¨endGame
                this.resetGameState();
            }

            updateDisplay() {
                if (this.scoreElement) {
                    this.scoreElement.textContent = this.score;
                }
                if (this.levelElement) {
                    this.levelElement.textContent = this.level;
                }
                this.updateTargetCount();
            }

            updateTargetCount() {
                if (!this.targetCountElement) return;
                
                if (this.gameMode === 'color') {
                    let numCells;
                    
                    // æ ¹æ®éš¾åº¦è°ƒæ•´ç›®æ ‡æ ¼å­æ•°é‡
                    const difficultyMultiplier = this.difficulty === 1 ? 0.8 : this.difficulty === 3 ? 1.2 : 1;
                    let extraCells = Math.max(0, this.gridSize - 4); // é¢å¤–æ ¼å­æ•°
                    
                    if (this.level <= 3) {
                        numCells = Math.ceil(2 * difficultyMultiplier);
                    } else if (this.level <= 6) {
                        numCells = Math.ceil(3 * difficultyMultiplier);
                    } else if (this.level <= 10) {
                        numCells = Math.ceil(4 * difficultyMultiplier);
                    } else if (this.level <= 15) {
                        numCells = Math.ceil(5 * difficultyMultiplier);
                    } else {
                        numCells = Math.min(Math.ceil(6 * difficultyMultiplier), Math.floor(this.gridSize * this.gridSize * 0.4));
                    }
                    numCells += extraCells; // æ·»åŠ é¢å¤–æ ¼å­æ•°
                    
                    // ç¡®ä¿è‡³å°‘æœ‰1ä¸ªæ ¼å­ï¼Œæœ€å¤šä¸è¶…è¿‡æ€»æ ¼å­æ•°çš„ä¸€åŠ
                    numCells = Math.max(1, Math.min(numCells, Math.floor(this.gridSize * this.gridSize / 2)));
                    
                    this.targetCountElement.textContent = numCells;
                } else {
                    const wordBank = this.getWordBank();
                    if (wordBank.length > 0) {
                        const avgLength = Math.round(wordBank.reduce((sum, word) => sum + word.length, 0) / wordBank.length);
                        this.targetCountElement.textContent = `${avgLength}å­—`;
                    } else {
                        this.targetCountElement.textContent = '4å­—';
                    }
                }
            }

            updateErrorCount() {
                if (this.errorCountElement) {
                    this.errorCountElement.textContent = this.errorCount;
                }
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        new VisualMemoryGame();
        
        // æ¸¸æˆåŠ è½½å®Œæˆæ—¶å‘é€æ¶ˆæ¯
        window.parent.postMessage({ type: 'gameLoaded' }, '*');
    </script>
</body>
</html>

