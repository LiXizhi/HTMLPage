<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¡ºåºè®°å¿†æ¸¸æˆ</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        /* å…¨å±åŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            touch-action: manipulation;
        }
        
        /* æ¸¸æˆä¸»å®¹å™¨ */
        .game-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        .game-info {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #374151;
            font-size: 1.4rem;
            min-height: 50px;
        }

        @media (max-width: 640px) {
            .game-info {
                padding: 0.25rem 0.5rem;
                font-size: 1.1rem;
                min-height: 40px;
            }
        }

        /* æ¸¸æˆçŠ¶æ€æ  */
        .status-bar {
            text-align: center;
            padding: 0.5rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(31, 41, 55, 0.5);
            font-size: 1.2rem;
        }

        @media (max-width: 640px) {
            .status-bar {
                font-size: 1.1rem;
            }
        }

        /* æ¸¸æˆä¸»ä½“åŒºåŸŸ */
        .game-board-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            min-height: 0;
            overflow: hidden;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            padding: 0.5rem;
            background: rgba(31, 41, 55, 0.9);
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: #85888b;
        }

        .setting-select {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 1.1rem;
        }

        @media (max-width: 640px) {
            .settings-panel {
                padding: 0.25rem;
                gap: 0.5rem;
            }
            .setting-item {
                font-size: 1rem;
            }
            .setting-select {
                padding: 0.2rem 0.4rem;
                font-size: 1rem;
            }
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            min-height: 36px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 1.1rem;
                min-height: 32px;
            }
        }

        /* æ¸¸æˆç½‘æ ¼å®¹å™¨ */
        .grid-container {
            display: grid;
            gap: 6px;
            padding: 12px;
            background-color: #374151;
            border-radius: 12px;
            max-width: 90vmin;
            max-height: 75vh;
            margin: 0 auto;
            width: fit-content;
            height: fit-content;
        }

        @media (max-width: 640px) {
            .grid-container {
                gap: 5px;
                padding: 10px;
                max-height: 70vh;
                max-width: 95vmin;
            }
        }

        @media (max-height: 600px) {
            .grid-container {
                gap: 4px;
                padding: 8px;
                max-height: 60vh;
                max-width: 95vmin;
            }
        }

        /* ç½‘æ ¼å•å…ƒæ ¼æ ·å¼ */
        .grid-cell {
            transition: all 0.3s ease;
            background-color: #4b5563 !important;
            cursor: pointer;
            border: 1px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            min-height: 60px;
            min-width: 60px;
            font-size: 1.6rem;
        }

        @media (hover: hover) {
            .grid-cell:hover {
                background-color: #6b7280 !important;
                transform: scale(1.05);
            }
        }

        .grid-cell:active {
            background-color: #6b7280 !important;
            transform: scale(1.05);
        }

        /* å“åº”å¼ç½‘æ ¼å¤§å° */
        .grid-3 { 
            grid-template-columns: repeat(3, 1fr);
        }
        .grid-3 .grid-cell {
            min-height: 80px !important;
            min-width: 80px !important;
            font-size: 1.8rem !important;
        }

        .grid-4 { 
            grid-template-columns: repeat(4, 1fr);
        }
        .grid-4 .grid-cell {
            min-height: 70px !important;
            min-width: 70px !important;
            font-size: 1.6rem !important;
        }

        .grid-5 { 
            grid-template-columns: repeat(5, 1fr);
        }
        .grid-5 .grid-cell {
            min-height: 60px !important;
            min-width: 60px !important;
            font-size: 1.4rem !important;
        }

        .grid-6 { 
            grid-template-columns: repeat(6, 1fr);
        }
        .grid-6 .grid-cell {
            min-height: 50px !important;
            min-width: 50px !important;
            font-size: 1.2rem !important;
        }
        
        /* çŠ¶æ€æ ·å¼ */
        .highlighted {
            background-color: #10b981 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
        }
        .correct {
            background-color: #10b981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .incorrect {
            background-color: #ef4444 !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .highlighting {
            background-color: #3b82f6 !important;
            box-shadow: 0 0 20px #3b82f6;
            animation: highlight 0.8s ease-in-out;
        }

        .sequence-word {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
            white-space: nowrap;
            pointer-events: none;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes highlight {
            0% { background-color: #3b82f6; transform: scale(1); }
            50% { background-color: #60a5fa; transform: scale(1.1); }
            100% { background-color: #3b82f6; transform: scale(1); }
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pulse {
            animation: correctPulse 0.6s ease-in-out;
        }

        .wrong {
            animation: wrongShake 0.6s ease-in-out;
        }

        /* è§„åˆ™å¼¹çª— */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .rules-content {
            background: #1f2937;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
        }

        .rules-content h2 {
            font-size: 1.8rem;
        }

        .rules-content h3 {
            font-size: 1.4rem;
        }

        @media (max-width: 640px) {
            .rules-content {
                padding: 1rem;
                max-width: 95vw;
                max-height: 85vh;
                font-size: 1.1rem;
            }
            
            .rules-content h2 {
                font-size: 1.6rem;
            }

            .rules-content h3 {
                font-size: 1.3rem;
            }
        }

        .modal.hidden {
            display: none;
        }
        
        /* è§„åˆ™å›¾æ ‡ */
        .rules-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .rules-icon:hover {
            background: rgba(59, 130, 246, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 640px) {
            .rules-icon {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 1.6rem;
            }
        }

        /* åºåˆ—æ˜¾ç¤º */
        .sequence-display {
            font-size: 0.9rem;
            color: #a78bfa;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem;
        }
        .setting-text {
            color: #676869;
            font-weight: 500;
            padding: 0.2rem 0.2rem;
            min-width: 60px;
            text-align: center;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
        * {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="game-container">
        <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
        <div class="game-info">
            <div class="flex items-center gap-2 text-yellow-400">
                <span class="text-base font-medium">å¾—åˆ†:</span>
                <span id="score" class="font-bold text-xl">0</span>
            </div>
            <div class="flex items-center gap-2 text-blue-400">
                <span class="text-base font-medium">å…³å¡:</span>
                <span id="currentLevel" class="font-bold text-xl">1</span>
            </div>
            <div class="flex items-center gap-2 text-green-400">
                <span class="text-base font-medium">åºåˆ—:</span>
                <span id="sequenceLength" class="font-bold text-xl">4</span>
            </div>
            <div class="flex items-center gap-2 text-red-400">
                <span class="text-base font-medium">é”™è¯¯:</span>
                <span id="mistakes" class="font-bold text-xl">0</span>
                <span class="font-bold text-xl">/</span>
                <span class="font-bold text-xl">5</span>
            </div>
            <div class="flex items-center gap-2 text-purple-400">
                <span class="text-base font-medium">æ­¥éª¤:</span>
                <span id="currentStep" class="font-bold text-xl">0</span>
            </div>
        </div>

        <!-- æ¸¸æˆçŠ¶æ€æ  -->
        <div id="gameStatus" class="status-bar">
            <span class="text-white text-base font-medium">ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜</span>
        </div>

        <!-- æ¸¸æˆä¸»ä½“åŒºåŸŸ -->
        <div class="game-board-area">
            <div id="gameGrid" class="grid-container grid-4">
                <!-- ç½‘æ ¼å•å…ƒæ ¼å°†ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <!-- åºåˆ—æ˜¾ç¤º -->
            <div id="sequenceDisplay" class="sequence-display"></div>

            <div class="control-buttons">
                <button id="startBtn" class="btn bg-green-600 hover:bg-green-700 text-white">
                    å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>

        
        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <div class="setting-item">
                <label>éš¾åº¦:</label>
                <select id="difficultySelect" class="setting-select">
                    <option value="1">1çº§ - å…¥é—¨</option>
                    <option value="2">2çº§ - åˆå­¦</option>
                    <option value="3">3çº§ - åŸºç¡€</option>
                    <option value="4">4çº§ - è¿›é˜¶</option>
                    <option value="5">5çº§ - ç†Ÿç»ƒ</option>
                    <option value="6">6çº§ - ä¸­çº§</option>
                    <option value="7">7çº§ - é«˜çº§</option>
                    <option value="8">8çº§ - ä¸“å®¶</option>
                    <option value="9">9çº§ - å¤§å¸ˆ</option>
                    <option value="10">10çº§ - ä¼ å¥‡</option>
                    <option value="11">11çº§ - è¶…å‡¡</option>
                    <option value="12">12çº§ - ç¥è¯</option>
                </select>
            </div>
            <div class="setting-item">
                <label>ç½‘æ ¼:</label>
                <span id="gridSizeDisplay" class="setting-text">4Ã—4</span>
            </div>
            <div class="setting-item">
                <label>åºåˆ—:</label>
                <span id="sequenceDisplay" class="setting-text">4æ­¥</span>
            </div>
            <div class="setting-item">
                <label>é€Ÿåº¦:</label>
                <span id="speedDisplay" class="setting-text">æ­£å¸¸</span>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆè§„åˆ™å¼¹çª— -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-blue-400">è¿‡ç›®ä¸å¿˜</h2>
                <button id="closeRulesBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-3 text-2xl text-white">
                <div class="bg-gray-600 p-3 rounded-lg">
                    <h3 class="font-medium mb-2 text-green-400">ğŸ¯ ç›®æ ‡</h3>
                    <p>è§‚å¯Ÿæ–¹å—äº®èµ·çš„é¡ºåºå’Œæ˜¾ç¤ºçš„è‹±æ–‡å•è¯ï¼Œç„¶åå‡­è®°å¿†æŒ‰ç›¸åŒé¡ºåºç‚¹å‡»æ–¹å—ã€‚</p>
                </div>
                <div class="bg-gray-600 p-3 rounded-lg">
                    <h3 class="font-medium mb-2 text-yellow-400">ğŸ“‹ æ¸¸æˆæµç¨‹</h3>
                    <ul class="space-y-1 text-xl">
                        <li>â€¢ è§‚å¯Ÿæ–¹å—æŒ‰é¡ºåºä¾æ¬¡äº®èµ·ï¼Œæ¯ä¸ªæ˜¾ç¤ºä¸€ä¸ªå•è¯</li>
                        <li>â€¢ è®°ä½æ¯ä¸ªæ–¹å—äº®èµ·çš„å…ˆåé¡ºåº</li>
                        <li>â€¢ å®Œå…¨æ¶ˆå¤±åï¼ŒæŒ‰ç…§ç›¸åŒçš„é¡ºåºç‚¹å‡»æ–¹å—</li>
                    </ul>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button id="startGameFromRules" class="btn text-2xl bg-green-600 hover:bg-green-700 text-white px-6 py-4">å¼€å§‹è®­ç»ƒ</button>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™æŸ¥çœ‹å›¾æ ‡ -->
    <div id="rulesIcon" class="rules-icon hidden" title="æŸ¥çœ‹è§„åˆ™">
        ?
    </div>

    <script>
        // å…¨å±€å˜é‡å’Œé…ç½®
        let game_config = '';
        let highestScore = 0;
        let gameStarted = false;

        // æ›´æ–°æ¸¸æˆé…ç½®
        function updateGameConfig(config) {
            try {
                if (typeof config === 'string' && config.trim()) {
                    const newWords = parseWordConfig(config);
                    if (newWords.length > 0) {
                        if (window.sequenceGame) {
                            window.sequenceGame.wordPool = newWords;
                            console.log(`é…ç½®å·²æ›´æ–°ï¼ŒåŠ è½½äº† ${newWords.length} ä¸ªå•è¯`);
                        }
                    } else {
                        console.warn('æ–°é…ç½®æ²¡æœ‰æœ‰æ•ˆå•è¯ï¼Œä¿æŒåŸé…ç½®');
                    }
                }
            } catch (error) {
                console.warn('è§£ææ¸¸æˆé…ç½®å¤±è´¥ï¼Œä¿æŒåŸé…ç½®:', error);
            }
        }

        // è§£æå•è¯é…ç½®ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function parseWordConfig(config) {
            const words = [];
            
            try {
                const jsonData = JSON.parse(config);
                if (Array.isArray(jsonData)) {
                    return jsonData.filter(item => 
                        typeof item === 'string' || (item.word && typeof item.word === 'string')
                    ).map(item => typeof item === 'string' ? item.toUpperCase() : item.word.toUpperCase());
                }
            } catch (e) {
                const lines = config.trim().split('\n');
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line || line.startsWith('#')) continue;
                    
                    if (line.includes(',')) {
                        const parts = line.split(',');
                        if (parts[0] && parts[0].trim()) {
                            words.push(parts[0].trim().toUpperCase());
                        }
                    } else {
                        words.push(line.toUpperCase());
                    }
                }
            }
            
            return words;
        }

        class SequenceMemoryGame {
            constructor() {
                this.gameGrid = document.getElementById('gameGrid');
                this.startBtn = document.getElementById('startBtn');
                this.gameStatus = document.getElementById('gameStatus');
                this.scoreElement = document.getElementById('score');
                this.mistakesElement = document.getElementById('mistakes');
                this.currentLevelElement = document.getElementById('currentLevel');
                this.currentStepElement = document.getElementById('currentStep');
                this.sequenceDisplay = document.getElementById('sequenceDisplay');
                this.sequenceLengthElement = document.getElementById('sequenceLength');
                
                this.gridSize = 4;
                this.sequenceLength = 4;
                this.playSpeed = 1000;
                this.currentLevel = 1;
                this.score = 0;
                this.mistakes = 0;
                
                this.gameState = 'idle';
                this.targetSequence = [];
                this.sequenceWords = [];
                this.playerSequence = [];
                this.currentStep = 0;
                this.cells = [];
                this.showingSequence = false;
                
                // åˆå§‹åŒ–å®šæ—¶å™¨ç®¡ç†ç›¸å…³å˜é‡
                this.sequenceTimers = [];
                this.isShowingSequence = false;
                
                // è‹±æ–‡å•è¯æ± 
                this.wordPool = [
                    'cat', 'dog', 'sun', 'moon', 'tree', 'book', 'cake', 'ball',
                    'car', 'bus', 'red', 'blue', 'big', 'small', 'hot', 'cold',
                    'yes', 'no', 'up', 'down', 'in', 'out', 'on', 'off',
                    'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight',
                    'nine', 'ten', 'boy', 'girl', 'mom', 'dad', 'happy', 'sad'
                ];

                // åˆå§‹åŒ–æ¸¸æˆ
                this.initializeElements();
                this.initializeRulesModal();
                this.initializeDifficulty();
                this.createGrid();
                this.bindEvents();
                this.addTouchSupport();
                this.updateDisplayText();

                window.sequenceGame = this;

                // æ¸¸æˆå¼€å§‹æ—¶æ˜¾ç¤ºè§„åˆ™
                this.showRulesModal();
            }

            // æ–°å¢ï¼šåˆå§‹åŒ–DOMå…ƒç´ 
            initializeElements() {
                // DOMå…ƒç´ å·²ç»åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†ï¼Œè¿™é‡Œå¯ä»¥åšä¸€äº›é¢å¤–çš„è®¾ç½®
                this.rulesModal = document.getElementById('rulesModal');
                this.rulesIcon = document.getElementById('rulesIcon');
                this.closeRulesBtn = document.getElementById('closeRulesBtn');
                this.startGameFromRules = document.getElementById('startGameFromRules');
                this.difficultySelect = document.getElementById('difficultySelect');
            }

            // æ–°å¢ï¼šåˆå§‹åŒ–è§„åˆ™å¼¹çª—
            initializeRulesModal() {
                // ç¡®ä¿è§„åˆ™å›¾æ ‡éšè—
                if (this.rulesIcon) {
                    this.rulesIcon.classList.add('hidden');
                }
            }

            // æ–°å¢ï¼šç»‘å®šäº‹ä»¶
            bindEvents() {
                // å¼€å§‹æ¸¸æˆæŒ‰é’®
                if (this.startBtn) {
                    this.startBtn.addEventListener('click', () => {
                        if (this.gameState === 'idle') {
                            this.startGame();
                        } else {
                            this.resetGame();
                        }
                    });
                }

                // å…³é—­è§„åˆ™å¼¹çª—
                if (this.closeRulesBtn) {
                    this.closeRulesBtn.addEventListener('click', () => {
                        this.hideRulesModal();
                        if (this.rulesIcon) {
                            this.rulesIcon.classList.remove('hidden');
                        }
                    });
                }

                // ä»è§„åˆ™å¼¹çª—å¼€å§‹æ¸¸æˆ
                if (this.startGameFromRules) {
                    this.startGameFromRules.addEventListener('click', () => {
                        this.hideRulesModal();
                        if (this.rulesIcon) {
                            this.rulesIcon.classList.remove('hidden');
                        }
                        this.startGame();
                    });
                }

                // è§„åˆ™å›¾æ ‡ç‚¹å‡»
                if (this.rulesIcon) {
                    this.rulesIcon.addEventListener('click', () => {
                        this.showRulesModal();
                    });
                }

                // éš¾åº¦é€‰æ‹©å™¨
                if (this.difficultySelect) {
                    this.difficultySelect.addEventListener('change', (e) => {
                        const selectedDifficulty = parseInt(e.target.value);
                        this.setDifficulty(selectedDifficulty);
                    });
                }

                // ç‚¹å‡»è§„åˆ™å¼¹çª—é®ç½©å…³é—­
                if (this.rulesModal) {
                    this.rulesModal.addEventListener('click', (e) => {
                        if (e.target === this.rulesModal) {
                            this.hideRulesModal();
                            if (this.rulesIcon) {
                                this.rulesIcon.classList.remove('hidden');
                            }
                        }
                    });
                }
            }

            // æ–°å¢ï¼šæ·»åŠ è§¦æ‘¸æ”¯æŒ
            addTouchSupport() {
                // åŸºæœ¬çš„è§¦æ‘¸æ”¯æŒå·²ç»åœ¨ createGrid æ–¹æ³•ä¸­å®ç°
                // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„è§¦æ‘¸ç›¸å…³è®¾ç½®
            }

            // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨çš„æ–¹æ³•
            clearAllTimers() {
                // ç¡®ä¿ sequenceTimers æ•°ç»„å­˜åœ¨
                if (this.sequenceTimers && Array.isArray(this.sequenceTimers)) {
                    this.sequenceTimers.forEach(timer => {
                        if (timer) {
                            clearTimeout(timer);
                        }
                    });
                }
                this.sequenceTimers = [];
                this.isShowingSequence = false;
            }

            // æ–°å¢ï¼šç”Ÿæˆåºåˆ—
            generateSequence() {
                this.targetSequence = [];
                this.sequenceWords = this.getRandomWords(this.sequenceLength);
                
                const totalCells = this.gridSize * this.gridSize;
                const usedIndices = new Set();
                
                for (let i = 0; i < this.sequenceLength; i++) {
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * totalCells);
                    } while (usedIndices.has(randomIndex));
                    
                    usedIndices.add(randomIndex);
                    this.targetSequence.push(randomIndex);
                }
            }

            // æ–°å¢ï¼šæ˜¾ç¤ºåºåˆ—
            async showSequence() {
                this.clearAllTimers();
                this.isShowingSequence = true;
                
                let displayedSequence = [];
                
                for (let i = 0; i < this.targetSequence.length; i++) {
                    if (!this.isShowingSequence) {
                        return;
                    }
                    
                    const cellIndex = this.targetSequence[i];
                    const word = this.sequenceWords[i];
                    const cell = this.cells[cellIndex];
                    
                    // æ˜¾ç¤ºè‹±æ–‡å•è¯
                    const wordElement = document.createElement('div');
                    wordElement.className = 'sequence-word';
                    wordElement.textContent = word;
                    cell.appendChild(wordElement);
                    
                    // é«˜äº®æ˜¾ç¤ºå½“å‰æ–¹å—
                    cell.classList.add('highlighting');
                    
                    // æ›´æ–°åºåˆ—æ˜¾ç¤º
                    displayedSequence.push(word);
                    this.sequenceDisplay.textContent = `åºåˆ—: ${displayedSequence.join(' â†’ ')}`;
                    
                    // ä½¿ç”¨å—æ§çš„å®šæ—¶å™¨ç­‰å¾…
                    await this.sleepWithTimer(this.playSpeed);
                    
                    if (!this.isShowingSequence) {
                        return;
                    }
                    
                    // ç§»é™¤é«˜äº®å’Œå•è¯
                    cell.classList.remove('highlighting');
                    wordElement.remove();
                    
                    // çŸ­æš‚åœé¡¿
                    await this.sleepWithTimer(300);
                }
                
                // åªæœ‰åœ¨æ²¡æœ‰è¢«ä¸­æ–­çš„æƒ…å†µä¸‹æ‰å¯åŠ¨ç©å®¶å›åˆ
                if (this.isShowingSequence) {
                    this.startPlayerTurn();
                }
            }

            // å—æ§çš„å»¶è¿Ÿå‡½æ•°ï¼Œå¯ä»¥è¢«ä¸­æ–­
            sleepWithTimer(ms) {
                return new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        // ä»å®šæ—¶å™¨æ•°ç»„ä¸­ç§»é™¤
                        const index = this.sequenceTimers.indexOf(timer);
                        if (index > -1) {
                            this.sequenceTimers.splice(index, 1);
                        }
                        resolve();
                    }, ms);
                    
                    // æ·»åŠ åˆ°å®šæ—¶å™¨æ•°ç»„ä¸­
                    this.sequenceTimers.push(timer);
                });
            }

            // æ–°å¢ï¼šå¼€å§‹ç©å®¶å›åˆ
            startPlayerTurn() {
                this.gameState = 'memorizing';
                this.showingSequence = false;
                this.isShowingSequence = false;
                this.playerSequence = [];
                this.currentStep = 0;
                this.currentStepElement.textContent = '0';
                this.gameStatus.innerHTML = '<span class="text-blue-400">ç°åœ¨æŒ‰ç…§åˆšæ‰çš„é¡ºåºç‚¹å‡»æ–¹å—ï¼</span>';
            }

            // ä¿®æ”¹ï¼šæ›´æ–°æ˜¾ç¤ºæ–‡æœ¬æ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰UIåŒæ­¥
            updateDisplayText() {
                const gridSizeDisplay = document.getElementById('gridSizeDisplay');
                const sequenceDisplayElement = document.getElementById('sequenceDisplay');
                const speedDisplay = document.getElementById('speedDisplay');
        
                if (gridSizeDisplay) {
                    gridSizeDisplay.textContent = `${this.gridSize}Ã—${this.gridSize}`;
                }
        
                if (sequenceDisplayElement) {
                    sequenceDisplayElement.textContent = `${this.sequenceLength}æ­¥`;
                }
        
                if (speedDisplay) {
                    let speedText = 'æ­£å¸¸';
                    if (this.playSpeed >= 1300) speedText = 'æ…¢é€Ÿ';
                    else if (this.playSpeed <= 700) speedText = 'å¿«é€Ÿ';
                    else if (this.playSpeed <= 500) speedText = 'æå¿«';
                    speedDisplay.textContent = speedText;
                }
        
                // æ›´æ–°åºåˆ—é•¿åº¦æ˜¾ç¤º
                this.updateSequenceLengthDisplay();
        
                // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤ºå½“å‰éš¾åº¦ä¿¡æ¯
                if (this.gameState === 'idle') {
                    const config = this.difficultyLevels[this.currentDifficulty - 1];
                    this.gameStatus.innerHTML = `<span class="text-blue-400">å½“å‰éš¾åº¦ï¼š${this.currentDifficulty} çº§ (${config.name}) - ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜</span>`;
                }
            }

            updateSequenceLengthDisplay() {
                if (this.sequenceLengthElement) {
                    this.sequenceLengthElement.textContent = this.sequenceLength;
                }
            }

            showRulesModal() {
                if (this.rulesModal) {
                    this.rulesModal.classList.remove('hidden');
                    this.rulesModal.style.display = 'flex';
                }
            }

            hideRulesModal() {
                if (this.rulesModal) {
                    this.rulesModal.classList.add('hidden');
                    this.rulesModal.style.display = 'none';
                }
            }
            createGrid() {
                this.gameGrid.innerHTML = '';
                this.gameGrid.className = `grid-container grid-${this.gridSize}`;
                this.cells = [];
                
                const totalCells = this.gridSize * this.gridSize;
                for (let i = 0; i < totalCells; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    
                    let touchHandled = false;
                    
                    cell.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        touchHandled = false;
                    });
                    
                    cell.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        if (!touchHandled) {
                            touchHandled = true;
                            this.onCellClick(i);
                        }
                    });
                    
                    cell.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (!touchHandled) {
                            this.onCellClick(i);
                        }
                        setTimeout(() => {
                            touchHandled = false;
                        }, 100);
                    });
                    
                    this.gameGrid.appendChild(cell);
                    this.cells.push(cell);
                }

                this.updateSequenceLengthDisplay();
            }
            
            getRandomWords(count) {
                const shuffled = [...this.wordPool].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }
            
            startGame() {
                this.hideRulesModal();
                
                // æ¸…ç†æ‰€æœ‰ç°æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                // ç¡®ä¿å½“å‰éš¾åº¦è®¾ç½®ç”Ÿæ•ˆ
                this.applyCurrentDifficulty();
                
                if (!gameStarted) {
                    window.parent.postMessage({ type: 'gameStarted' }, '*');
                    gameStarted = true;
                }

                this.gameState = 'showing';
                this.startBtn.disabled = true;
                this.startBtn.textContent = 'è¿›è¡Œä¸­...';
                this.gameStatus.innerHTML = '<span class="text-green-400">ä»”ç»†è§‚å¯Ÿæ–¹å—äº®èµ·çš„é¡ºåºå’Œå•è¯ï¼</span>';
                this.showingSequence = true;
                this.sequenceDisplay.textContent = '';
                
                this.resetCells();
                this.generateSequence();
                
                // ç¡®ä¿åœ¨æ¸…ç†åå†å¼€å§‹æ˜¾ç¤ºåºåˆ—
                setTimeout(() => {
                    this.showSequence();
                }, 100);
            }

            // æ–°å¢ï¼šåº”ç”¨å½“å‰éš¾åº¦è®¾ç½®
            applyCurrentDifficulty() {
                const config = this.difficultyLevels[this.currentDifficulty - 1];
                
                // æ›´æ–°æ¸¸æˆå‚æ•°
                this.gridSize = config.gridSize;
                this.sequenceLength = config.sequenceLength;
                this.playSpeed = config.playSpeed;
                
                // é‡æ–°åˆ›å»ºç½‘æ ¼ä»¥åº”ç”¨æ–°çš„ç½‘æ ¼å¤§å°
                this.createGrid();
                
                // åˆ·æ–°æ‰€æœ‰UIæ˜¾ç¤º
                this.updateDisplayText();
                
                console.log(`åº”ç”¨éš¾åº¦è®¾ç½®ï¼š${this.currentDifficulty} çº§ (${config.name}) - ç½‘æ ¼:${this.gridSize}Ã—${this.gridSize}, åºåˆ—:${this.sequenceLength}, é€Ÿåº¦:${this.playSpeed}ms`);
            }

            // ä¿®æ”¹ï¼šè®¾ç½®éš¾åº¦æ–¹æ³•ï¼Œå¢å¼ºUIåˆ·æ–°
            setDifficulty(difficultyLevel) {
                // éªŒè¯éš¾åº¦ç­‰çº§èŒƒå›´
                if (difficultyLevel < 1 || difficultyLevel > 12) {
                    console.warn('éš¾åº¦ç­‰çº§å¿…é¡»åœ¨1-12ä¹‹é—´');
                    return false;
                }
                
                const config = this.difficultyLevels[difficultyLevel - 1];
                
                // è®°å½•æ¸¸æˆæ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­
                const wasGameRunning = this.gameState !== 'idle';
                
                // å…ˆæ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                // æ›´æ–°å½“å‰éš¾åº¦
                this.currentDifficulty = difficultyLevel;
                
                // åº”ç”¨éš¾åº¦è®¾ç½®
                this.applyCurrentDifficulty();
                
                // æ›´æ–°éš¾åº¦é€‰æ‹©å™¨æ˜¾ç¤º
                this.updateDifficultySelector();

                // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè‡ªåŠ¨é‡æ–°å¼€å§‹å½“å‰å…³å¡
                if (wasGameRunning) {
                    // æ˜¾ç¤ºéš¾åº¦åˆ‡æ¢ä¿¡æ¯
                    this.gameStatus.innerHTML = `<span class="text-yellow-400">éš¾åº¦å·²åˆ‡æ¢ä¸º ${difficultyLevel} çº§ (${config.name})ï¼Œé‡æ–°å¼€å§‹å½“å‰å…³å¡ï¼</span>`;
                    
                    // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æç¤ºï¼Œç„¶åè‡ªåŠ¨å¼€å§‹æ¸¸æˆ
                    const restartTimer = setTimeout(() => {
                        this.startGame();
                    }, 1500);
                    
                    this.sequenceTimers.push(restartTimer);
                } else {
                    // æ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œæ˜¾ç¤ºéš¾åº¦ä¿¡æ¯
                    this.gameStatus.innerHTML = `<span class="text-blue-400">éš¾åº¦å·²è®¾ç½®ä¸º ${difficultyLevel} çº§ (${config.name}) - ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜</span>`;
                }
                
                console.log(`éš¾åº¦è®¾ç½®ä¸ºï¼š${difficultyLevel} çº§ (${config.name}) - ç½‘æ ¼:${config.gridSize}Ã—${config.gridSize}, åºåˆ—:${config.sequenceLength}, é€Ÿåº¦:${config.playSpeed}ms`);
                
                return true;
            }

            // ä¿®æ”¹ï¼šé‡ç½®æ¸¸æˆæ–¹æ³•ï¼Œç¡®ä¿éš¾åº¦é‡ç½®
            resetGame() {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                this.currentLevel = 1;
                this.score = 0;
                this.mistakes = 0;
                this.gameState = 'idle';
                
                // é‡ç½®ä¸ºé»˜è®¤éš¾åº¦
                this.currentDifficulty = 1;
                this.applyCurrentDifficulty();
                
                this.currentLevelElement.textContent = this.currentLevel;
                this.scoreElement.textContent = this.score;
                this.mistakesElement.textContent = this.mistakes;
                this.currentStepElement.textContent = '0';
                this.sequenceDisplay.textContent = '';
                this.startBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
                this.startBtn.disabled = false;
                
                // åˆ·æ–°UIæ˜¾ç¤º
                this.updateDisplayText();
                
                gameStarted = false;
            }

            onCellClick(index) {
                if (this.gameState !== 'memorizing' || this.showingSequence) return;
                
                const cell = this.cells[index];
                if (!cell) {
                    console.error(`Cell at index ${index} not found`);
                    return;
                }
                
                const expectedIndex = this.targetSequence[this.currentStep];
                
                if (index === expectedIndex) {
                    this.playerSequence.push(index);
                    this.currentStep++;
                    this.currentStepElement.textContent = this.currentStep;
                    
                    cell.classList.add('correct', 'pulse');
                    
                    // æ˜¾ç¤ºå¯¹åº”çš„è‹±æ–‡å•è¯
                    const wordElement = document.createElement('div');
                    wordElement.className = 'sequence-word';
                    wordElement.textContent = this.sequenceWords[this.currentStep - 1];
                    cell.appendChild(wordElement);
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ•´ä¸ªåºåˆ—
                    if (this.currentStep >= this.targetSequence.length) {
                        this.onLevelComplete();
                    }
                } else {
                    // é”™è¯¯ç‚¹å‡»
                    cell.classList.add('incorrect', 'wrong');
                    this.mistakes++;
                    this.mistakesElement.textContent = this.mistakes;
                    
                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¸¸æˆç»“æŸæ¡ä»¶
                    if (this.mistakes >= 5 || this.currentLevel >= 20) {
                        this.gameStatus.innerHTML = '<span class="text-red-400">æ¸¸æˆç»“æŸï¼</span>';
                        
                        setTimeout(() => {
                            this.endGame();
                        }, 1500);
                    } else {
                        this.gameStatus.innerHTML = '<span class="text-red-400">é¡ºåºé”™è¯¯ï¼é‡æ–°å¼€å§‹å½“å‰å…³å¡...</span>';
                        
                        setTimeout(() => {
                            this.restartCurrentLevel();
                        }, 1500);
                    }
                }
            }
            
            onLevelComplete() {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                this.gameState = 'finished';
                this.score += this.currentLevel * this.sequenceLength * 10;
                this.scoreElement.textContent = this.score;
                
                if (this.score > highestScore) {
                    highestScore = this.score;
                }
                
                this.currentLevel++;
                this.currentLevelElement.textContent = this.currentLevel;
                
                // ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„å¼€æ‹¬å·
                if (this.currentLevel > 20) {
                    this.gameStatus.innerHTML = '<span class="text-green-400">æ­å–œé€šå…³ï¼è¾¾åˆ°æœ€é«˜å…³å¡ï¼</span>';
                    this.sequenceDisplay.textContent = `å®Œæˆåºåˆ—: ${this.sequenceWords.join(' â†’ ')}`;
                    
                    setTimeout(() => {
                        this.endGame();
                    }, 3000);
                    return;
                }
                
                this.gameStatus.innerHTML = `<span class="text-green-400">ç¬¬ ${this.currentLevel - 1} å…³å®Œæˆï¼å‡†å¤‡ä¸‹ä¸€å…³...</span>`;
                this.sequenceDisplay.textContent = `å®Œæˆåºåˆ—: ${this.sequenceWords.join(' â†’ ')}`;
                
                // ä½¿ç”¨å—æ§çš„å®šæ—¶å™¨è¿›å…¥ä¸‹ä¸€å…³
                const nextLevelTimer = setTimeout(() => {
                    this.increaseDifficulty();
                    this.startNextLevel();
                }, 3000);
                
                this.sequenceTimers.push(nextLevelTimer);
            }

            // åŒæ—¶æ·»åŠ ç¼ºå¤±çš„æ–¹æ³•
            // æ–°å¢ï¼šåˆå§‹åŒ–éš¾åº¦è®¾ç½®æ–¹æ³•
            initializeDifficulty() {
                // è®¾ç½®é»˜è®¤éš¾åº¦ä¸º1çº§
                this.currentDifficulty = 1;
                
                // ä»éš¾åº¦é…ç½®ä¸­åŠ è½½åˆå§‹å‚æ•°
                const defaultConfig = this.difficultyLevels[0]; // ç¬¬1çº§é…ç½®
                this.gridSize = defaultConfig.gridSize;
                this.sequenceLength = defaultConfig.sequenceLength;
                this.playSpeed = defaultConfig.playSpeed;
                
                // æ›´æ–°éš¾åº¦é€‰æ‹©å™¨çš„æ˜¾ç¤º
                this.updateDifficultySelector();
                
                console.log(`æ¸¸æˆåˆå§‹åŒ–ï¼šéš¾åº¦ ${this.currentDifficulty} çº§ (${defaultConfig.name})`);
            }

            // æ–°å¢ï¼šæ›´æ–°éš¾åº¦é€‰æ‹©å™¨æ˜¾ç¤º
            updateDifficultySelector() {
                const difficultySelect = document.getElementById('difficultySelect');
                if (difficultySelect) {
                    difficultySelect.value = this.currentDifficulty;
                }
            }
            
            // éš¾åº¦é…ç½®ï¼š12ä¸ªç­‰çº§
            difficultyLevels = [
                // åˆçº§éš¾åº¦ (1-3çº§)
                { level: 1, gridSize: 3, sequenceLength: 3, playSpeed: 1500, name: 'å…¥é—¨' },
                { level: 2, gridSize: 3, sequenceLength: 4, playSpeed: 1300, name: 'åˆå­¦' },
                { level: 3, gridSize: 4, sequenceLength: 4, playSpeed: 1200, name: 'åŸºç¡€' },
                
                // ä¸­çº§éš¾åº¦ (4-6çº§)
                { level: 4, gridSize: 4, sequenceLength: 5, playSpeed: 1100, name: 'è¿›é˜¶' },
                { level: 5, gridSize: 4, sequenceLength: 6, playSpeed: 1000, name: 'ç†Ÿç»ƒ' },
                { level: 6, gridSize: 5, sequenceLength: 5, playSpeed: 950, name: 'ä¸­çº§' },
                
                // é«˜çº§éš¾åº¦ (7-9çº§)
                { level: 7, gridSize: 5, sequenceLength: 6, playSpeed: 900, name: 'é«˜çº§' },
                { level: 8, gridSize: 5, sequenceLength: 7, playSpeed: 850, name: 'ä¸“å®¶' },
                { level: 9, gridSize: 6, sequenceLength: 6, playSpeed: 800, name: 'å¤§å¸ˆ' },
                
                // ä¸“å®¶éš¾åº¦ (10-12çº§)
                { level: 10, gridSize: 6, sequenceLength: 7, playSpeed: 750, name: 'ä¼ å¥‡' },
                { level: 11, gridSize: 6, sequenceLength: 8, playSpeed: 700, name: 'è¶…å‡¡' },
                { level: 12, gridSize: 6, sequenceLength: 9, playSpeed: 650, name: 'ç¥è¯' }
            ];
            
            currentDifficulty = 1; // é»˜è®¤éš¾åº¦ç­‰çº§
            
            // è®¾ç½®éš¾åº¦ç­‰çº§
            setDifficulty(difficultyLevel) {
                // éªŒè¯éš¾åº¦ç­‰çº§èŒƒå›´
                if (difficultyLevel < 1 || difficultyLevel > 12) {
                    console.warn('éš¾åº¦ç­‰çº§å¿…é¡»åœ¨1-12ä¹‹é—´');
                    return false;
                }
                
                const config = this.difficultyLevels[difficultyLevel - 1];
                
                // è®°å½•æ¸¸æˆæ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­
                const wasGameRunning = this.gameState !== 'idle';
                
                // å…ˆæ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                // æ›´æ–°å½“å‰éš¾åº¦
                this.currentDifficulty = difficultyLevel;
                
                // åº”ç”¨éš¾åº¦è®¾ç½®
                this.applyCurrentDifficulty();
                
                // æ›´æ–°éš¾åº¦é€‰æ‹©å™¨æ˜¾ç¤º
                this.updateDifficultySelector();

                // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè‡ªåŠ¨é‡æ–°å¼€å§‹å½“å‰å…³å¡
                if (wasGameRunning) {
                    // æ˜¾ç¤ºéš¾åº¦åˆ‡æ¢ä¿¡æ¯
                    this.gameStatus.innerHTML = `<span class="text-yellow-400">éš¾åº¦å·²åˆ‡æ¢ä¸º ${difficultyLevel} çº§ (${config.name})ï¼Œé‡æ–°å¼€å§‹å½“å‰å…³å¡ï¼</span>`;
                    
                    // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æç¤ºï¼Œç„¶åè‡ªåŠ¨å¼€å§‹æ¸¸æˆ
                    const restartTimer = setTimeout(() => {
                        this.startGame();
                    }, 1500);
                    
                    this.sequenceTimers.push(restartTimer);
                } else {
                    // æ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œæ˜¾ç¤ºéš¾åº¦ä¿¡æ¯
                    this.gameStatus.innerHTML = `<span class="text-blue-400">éš¾åº¦å·²è®¾ç½®ä¸º ${difficultyLevel} çº§ (${config.name}) - ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜</span>`;
                }
                
                console.log(`éš¾åº¦è®¾ç½®ä¸ºï¼š${difficultyLevel} çº§ (${config.name}) - ç½‘æ ¼:${config.gridSize}Ã—${config.gridSize}, åºåˆ—:${config.sequenceLength}, é€Ÿåº¦:${config.playSpeed}ms`);
                
                return true;
            }
            
            // è·å–å½“å‰éš¾åº¦ä¿¡æ¯
            getDifficultyInfo() {
                const config = this.difficultyLevels[this.currentDifficulty - 1];
                return {
                    level: this.currentDifficulty,
                    name: config.name,
                    gridSize: config.gridSize,
                    sequenceLength: config.sequenceLength,
                    playSpeed: config.playSpeed
                };
            }
            
            // ä¿®æ”¹åŸæœ‰çš„increaseDifficultyæ–¹æ³•ï¼Œä½¿å…¶åŸºäºéš¾åº¦ç­‰çº§é€’å¢
            increaseDifficulty() {
                // æ¯3å…³å¢åŠ 1ä¸ªéš¾åº¦ç­‰çº§ï¼Œä½†ä¸è¶…è¿‡12çº§
                if (this.currentLevel % 3 === 1 && this.currentLevel > 1) {
                    const newDifficulty = Math.min(12, this.currentDifficulty + 1);
                    if (newDifficulty > this.currentDifficulty) {
                        this.setDifficulty(newDifficulty);
                        
                        // æ˜¾ç¤ºéš¾åº¦æå‡ä¿¡æ¯
                        const config = this.difficultyLevels[newDifficulty - 1];
                        this.gameStatus.innerHTML = `<span class="text-yellow-400">éš¾åº¦æå‡è‡³ ${newDifficulty} çº§ (${config.name})ï¼</span>`;
                        
                        setTimeout(() => {
                            this.gameStatus.innerHTML = '<span class="text-green-400">ä»”ç»†è§‚å¯Ÿæ–¹å—äº®èµ·çš„é¡ºåºå’Œå•è¯ï¼</span>';
                        }, 2000);
                    }
                }
            }
            
            resetCells() {
                this.cells.forEach(cell => {
                    cell.classList.remove('correct', 'incorrect', 'pulse', 'wrong', 'highlighting');
                    const wordElement = cell.querySelector('.sequence-word');
                    if (wordElement) {
                        wordElement.remove();
                    }
                });
                this.currentStep = 0;
                this.currentStepElement.textContent = '0';
            }
            
            resetGame() {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                this.currentLevel = 1;
                this.score = 0;
                this.mistakes = 0;
                this.gameState = 'idle';
                
                // é‡ç½®ä¸ºé»˜è®¤éš¾åº¦
                this.currentDifficulty = 1;
                this.applyCurrentDifficulty();
                
                this.currentLevelElement.textContent = this.currentLevel;
                this.scoreElement.textContent = this.score;
                this.mistakesElement.textContent = this.mistakes;
                this.currentStepElement.textContent = '0';
                this.sequenceDisplay.textContent = '';
                this.startBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
                this.startBtn.disabled = false;
                
                // åˆ·æ–°UIæ˜¾ç¤º
                this.updateDisplayText();
                
                gameStarted = false;
            }
            
            endGame() {
                const maxPossibleScore = this.calculateMaxScore();
                const percentageScore = Math.min(100, Math.round((this.score / maxPossibleScore) * 100));
                
                const difficulty = calculateDifficulty();
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: {
                        score: percentageScore,
                        highestScore: Math.min(100, Math.round((highestScore / maxPossibleScore) * 100)),
                        level: this.currentLevel,
                        difficulty: Math.min(difficulty, 3),
                        mistakes: this.mistakes
                    }
                }, '*');

                this.gameState = 'idle';
                this.startBtn.textContent = 'é‡æ–°å¼€å§‹';
                this.startBtn.disabled = false;
            }

            calculateMaxScore() {
                let maxScore = 0;
                for (let level = 1; level <= 20; level++) {
                    let sequenceLength = Math.min(4 + Math.floor((level - 1) / 3), 10);
                    maxScore += level * sequenceLength * 10;
                }
                return maxScore;
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            restartCurrentLevel() {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                this.gameState = 'showing';
                this.gameStatus.innerHTML = '<span class="text-green-400">é‡æ–°æŒ‘æˆ˜å½“å‰å…³å¡ï¼</span>';
                this.resetCells();
                this.generateSequence();
                
                // å»¶è¿Ÿå¯åŠ¨ç¡®ä¿æ¸…ç†å®Œæˆ
                setTimeout(() => {
                    this.showSequence();
                }, 100);
            }

            startNextLevel() {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.clearAllTimers();
                
                this.gameState = 'showing';
                this.gameStatus.innerHTML = '<span class="text-green-400">ä»”ç»†è§‚å¯Ÿæ–¹å—äº®èµ·çš„é¡ºåºå’Œå•è¯ï¼</span>';
                this.resetCells();
                this.generateSequence();
                
                // å»¶è¿Ÿå¯åŠ¨ç¡®ä¿æ¸…ç†å®Œæˆ
                setTimeout(() => {
                    this.showSequence();
                }, 100);
            }
        }
        
        // æ›´æ–°è®¡ç®—éš¾åº¦çš„å‡½æ•°
        function calculateDifficulty() {
            if (!window.sequenceGame) return 1;
            
            const game = window.sequenceGame;
            return game.currentDifficulty;
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new SequenceMemoryGame();
        
        // æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data;
                    updateGameConfig(game_config);
                    break;
                case 'getGameStats':
                    const difficulty = calculateDifficulty();
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: highestScore,
                            difficulty: Math.min(difficulty, 3)
                        }
                    }, '*');
                    break;
            }
        });
        
        // é˜»æ­¢ç§»åŠ¨ç«¯çš„é»˜è®¤è¡Œä¸º
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.grid-cell')) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.game-board-area')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // æ¸¸æˆåŠ è½½å®Œæˆæ—¶å‘é€æ¶ˆæ¯
        window.parent.postMessage({ type: 'gameLoaded' }, '*');
    </script>
</body>
</html>