<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>麦思星球主界面</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      font-size: 16px;
    }

    body {
      font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(45deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      -webkit-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }

    .app {
      width: 1280px;
      height: 720px;
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      overflow: hidden;
      transform-origin: center;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 120px;
      height: 720px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
      overflow-y: scroll;
      z-index: 100;
    }

    .sidebar::-webkit-scrollbar {
      display: none;
    }

    .menu-item {
      width: 88px;
      height: 88px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      border: 2px solid transparent;
      padding: 8px 4px;
    }

    .menu-item .icon {
      font-size: 32px;
      margin-bottom: 4px;
    }

    .menu-item .menu-text {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      text-align: center;
      line-height: 1;
    }

    .menu-item.active .menu-text {
      color: #bb7bf7;
    }

    .menu-item:hover .menu-text {
      color: #fff;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .menu-item.active {
      background: rgba(0, 200, 255, 0.3);
      border-color: #bb7bf7;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.3);
    }

    .menu-item.hidden {
      display: none !important;
    }

    /* 主内容区域 */
    .main-content {
      margin-left: 120px;
      width: calc(1280px - 120px);
      height: 720px;
      position: relative;
      overflow: hidden;
    }

    /* 顶部状态栏 */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 50;
    }

    .top-bar .logo {
      font-size: 20px;
      font-weight: bold;
      color: #bb7bf7;
    }

    .top-bar .status {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
    }

    .status .time {
      font-weight: bold;
    }

    .status .menu-dropdown {
      position: relative;
      display: flex;
      align-items: center;
    }

    .menu-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .menu-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .menu-icon {
      font-size: 20px;
      color: #fff;
      font-weight: bold;
      line-height: 1;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      min-width: 160px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-15px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      margin-top: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .dropdown-item {
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #fff;
      font-size: 15px;
      font-weight: 500;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
    }

    .dropdown-item:first-child {
      border-radius: 12px 12px 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 12px 12px;
      border-bottom: none;
    }

    .dropdown-item:only-child {
      border-radius: 12px;
      border-bottom: none;
    }

    /* devMode 相关样式 */
    /* 
       * 开发者模式UI控制系统
       * 使用方法：
       * 1. 在HTML元素上添加 'dev-only' 类，该元素将仅在开发模式下显示
       * 2. 通过URL参数 ?dev=true 启用开发模式
       * 3. 使用全局方法控制：
       *    - window.enableDevMode() 启用开发模式
       *    - window.disableDevMode() 禁用开发模式
       *    - window.toggleDevMode() 切换开发模式
       */
    .dev-only {
      display: none !important;
    }

    .dev-mode .dev-only {
      display: block !important;
    }

    .dev-mode .menu-dropdown .dev-only {
      display: flex !important;
    }

    /* 标签页内容 */
    .tab-content {
      display: none;
      width: 100%;
      height: 100%;
      padding: 80px 30px 0;
      overflow: hidden;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content.active#planet,
    .tab-content.active#test,
    .tab-content.active#member,
    .tab-content.active#profile,
    .tab-content.active#training-stats {
      padding: 60px 0 0;
    }

    #memberIframe,
    #profileIframe {
      width: 100%;
      height: 100%;
    }

    /* 首页 - 横向卡片布局 */
    .home-content {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .featured-section {
      height: 300px;
      margin-bottom: 16px;
      position: relative;
    }

    .featured-slider {
      width: 100%;
      height: calc(100% - 32px);
      position: relative;
      overflow: hidden;
      border-radius: 20px;
    }

    .featured-item {
      display: none;
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
    }

    .featured-item.active {
      display: block;
    }

    .featured-card {
      width: 100%;
      height: 100%;
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .featured-card>div {
      margin-top: -36px;
    }

    .featured-card:hover {
      transform: scale(1.02);
    }

    .featured-card .game-icon {
      font-size: 96px;
      margin-bottom: 16px;
    }

    .featured-card .game-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .featured-card .game-desc {
      font-size: 16px;
      opacity: 0.9;
    }

    /* 推荐游戏横向滚动 */
    .recommended-section {
      flex: 1;
      overflow: hidden;
    }

    .section-title {
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .game-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 10px 0;
      height: 280px;
      -webkit-overflow-scrolling: touch;
    }

    .game-row::-webkit-scrollbar {
      height: 6px;
      display: none;
    }

    .game-row::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .game-row::-webkit-scrollbar-thumb {
      background: rgba(0, 200, 255, 0.6);
      border-radius: 3px;
    }

    .dots-indicator {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .featured-start-btn {
      display: none;
      position: absolute;
      top: 50%;
      right: 20%;
      transform: translateY(calc(-50% + 16px));
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #fff;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 8px 16px rgba(251, 191, 36, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      margin: 0 8px;
    }

    .featured-start-btn:hover {
      transform: translateY(calc(-50% + 14px));
      box-shadow: 0 12px 24px rgba(251, 191, 36, 0.6);
    }

    .dot.active {
      background: #bb7bf7;
      transform: scale(1.2);
    }

    /* 推荐游戏横向滚动 */
    .recommended-section {
      flex: 1;
      overflow: hidden;
    }

    .section-title {
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .game-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 10px 0;
      height: 280px;
      -webkit-overflow-scrolling: touch;
    }

    .game-row::-webkit-scrollbar {
      height: 6px;
      display: none;
    }

    .game-row::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .game-row::-webkit-scrollbar-thumb {
      background: rgba(0, 200, 255, 0.6);
      border-radius: 3px;
    }

    .game-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 200px;
      height: 250px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 8px 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .game-card:hover {
      transform: translateY(-10px);
      background: rgba(255, 255, 255, 0.15);
      border-color: #bb7bf7;
      box-shadow: 0 10px 30px rgba(0, 200, 255, 0.3);
    }

    /* 通用游戏图标样式 */
    .game-card .game-icon,
    .featured-card-item .game-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    .game-card .game-icon {
      flex-shrink: 0;
      width: 108px;
      height: 108px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      font-size: 40px;
    }

    /* 通用游戏标题样式 */
    .game-card .game-title,
    .featured-card-item .game-title {
      font-weight: bold;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .game-card .game-title {
      font-size: 22px;
      margin-top: 8px;
    }

    /* 通用游戏描述样式 */
    .game-card .game-desc,
    .featured-card-item .game-desc {
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
      overflow: hidden;
    }

    .game-card .game-desc {
      font-size: 14px;
      margin-bottom: 10px;
      height: 40px;
    }

    /* 通用游戏标签样式 */
    .game-card .game-tags,
    .featured-card-item .game-tags {
      display: flex;
      gap: 8px;
    }

    .game-card .game-tags {
      flex: 1;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }

    .featured-card-item .game-tags {
      flex-wrap: wrap;
      justify-content: center;
    }

    .game-card .tag,
    .featured-card-item .game-tags .tag {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .game-card .tag {
      background: rgba(0, 200, 255, 0.3);
      color: #bb7bf7;
      padding: 4px 8px;
      font-size: 16px;
    }

    .featured-card-item .game-tags .tag {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      color: #fff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .featured-card-item .game-tags .tag:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .game-card.locked {
      opacity: 0.6;
    }

    .lock-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
    }

    .game-card .lock-icon {
      position: absolute;
      top: 84px;
      left: 36px;
      font-size: 32px;
    }

    /* 游戏分类页面 */
    .games-content {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .games-content::-webkit-scrollbar {
      display: none;
    }

    .category-section {
      margin-bottom: 40px;
    }

    .category-title {
      font-size: 22px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }

    .category-card {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
    }

    .category-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.15);
      border-color: #bb7bf7;
      box-shadow: 0 5px 20px rgba(0, 200, 255, 0.3);
    }

    .category-card .lock-overlay {
      background: rgba(0, 0, 0, 0.1);
    }

    .category-card .lock-icon {
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: 24px;
    }

    .category-card .game-icon {
      flex-shrink: 0;
      width: 112px;
      height: 112px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
    }

    .category-card .game-icon.prod {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .category-card .game-title {
      font-size: 22px;
      font-weight: bold;
    }

    .category-card .game-desc {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.3;
    }

    /* 统计和个人页面 */
    .stats-content,
    .profile-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      margin-top: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    .stat-card:hover {
      border-color: #bb7bf7;
      box-shadow: 0 5px 20px rgba(0, 200, 255, 0.3);
    }

    .stat-value {
      font-size: 48px;
      font-weight: bold;
      color: #bb7bf7;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 16px;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      margin-bottom: 20px;
    }

    .profile-name {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .profile-level {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 30px;
    }

    .profile-menu {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .profile-menu-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      min-width: 200px;
    }

    .profile-menu-item:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: #bb7bf7;
    }

    .profile-menu-item {
      font-size: 16px;
    }

    /* 设置页面样式 */
    .settings-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 60px 40px;
    }

    .settings-content .section-title {
      font-size: 48px;
      margin-bottom: 60px;
      font-weight: bold;
      color: #bb7bf7;
      text-shadow: 0 4px 8px rgba(187, 123, 247, 0.5);
    }

    .settings-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 32px;
      padding: 80px 60px;
      width: 90%;
      max-width: 1000px;
      backdrop-filter: blur(15px);
      border: 3px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .age-display-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 80px;
      font-size: 36px;
      font-weight: 600;
      justify-content: center;
      color: #fff;
    }

    .age-status {
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 24px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .age-status.applied {
      background: rgba(34, 197, 94, 0.3);
      color: #22c55e;
      border: 2px solid rgba(34, 197, 94, 0.5);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .age-status.unapplied {
      background: rgba(156, 163, 175, 0.3);
      color: #9ca3af;
      border: 2px solid rgba(156, 163, 175, 0.5);
      box-shadow: 0 4px 12px rgba(156, 163, 175, 0.2);
    }

    .age-control-row {
      display: flex;
      align-items: center;
      gap: 40px;
      justify-content: center;
    }

    .age-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid rgba(255, 255, 255, 0.4);
      color: white;
      font-size: 48px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .age-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .age-btn:active {
      transform: scale(0.95);
    }

    .age-value {
      font-size: 64px;
      font-weight: bold;
      color: #bb7bf7;
      min-width: 120px;
      text-align: center;
      text-shadow: 0 4px 8px rgba(187, 123, 247, 0.5);
    }

    .control-btn {
      padding: 20px 40px;
      border-radius: 16px;
      border: 3px solid transparent;
      cursor: pointer;
      font-size: 24px;
      font-weight: 700;
      transition: all 0.3s ease;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      min-width: 120px;
    }

    .apply-btn {
      background: rgba(34, 197, 94, 0.3);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.5);
    }

    .apply-btn:hover {
      background: rgba(34, 197, 94, 0.4);
      border-color: rgba(34, 197, 94, 0.7);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.4);
    }

    .clear-btn {
      background: rgba(239, 68, 68, 0.3);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.5);
    }

    .clear-btn:hover {
      background: rgba(239, 68, 68, 0.4);
      border-color: rgba(239, 68, 68, 0.7);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(239, 68, 68, 0.4);
    }

    .control-btn:active {
      transform: translateY(0);
    }

    /* Planet tab styles */
    .planet-content {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
      /* 简化的单层渐变效果 */
      background: radial-gradient(ellipse at center 15%,
          rgba(236, 72, 153, 0.3) 0%,
          /* 粉色中心 */
          rgba(147, 51, 234, 0.2) 40%,
          /* 紫色过渡 */
          rgba(0, 0, 0, 0.1) 80%,
          /* 暗色边缘 */
          rgba(0, 0, 0, 0.2) 100%
          /* 更暗的边缘 */
        );
    }

    /* 欢迎界面样式 */
    .planet-welcome-prompt {
      text-align: center;
      color: white;
      position: relative;
      z-index: 2;
      margin-top: 50px;
    }

    .planet-welcome-prompt h1 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 2rem;
      line-height: 1.4;
    }

    /* 彩色文字样式 */
    .planet-name {
      color: #40ce74;
      /* 绿色 */
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .shine-text {
      color: #fbbf24;
      /* 黄色 */
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* 黄色按钮 - 进入麦思星球 */
    .planet-enter-btn {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #fff;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 8px 16px rgba(251, 191, 36, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      margin: 0 8px;
    }

    .planet-enter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(251, 191, 36, 0.6);
    }

    /* 按钮容器 */
    .planet-button-container {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
      align-items: center;
    }

    /* 背景图片容器 */
    .planet-background-image-container {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      aspect-ratio: 16/10;
      width: auto;
      height: 60%;
      overflow: hidden;
    }

    .planet-background-image {
      width: 100%;
      height: 100%;
      object-fit: fill;
      /* 使用更平滑的mask渐变效果 */
      mask: linear-gradient(to bottom,
          transparent 0%,
          rgba(0, 0, 0, 0.3) 15%,
          rgba(0, 0, 0, 0.8) 25%,
          rgba(0, 0, 0, 1) 35%,
          rgba(0, 0, 0, 1) 100%),
        linear-gradient(to right,
          transparent 0%,
          rgba(0, 0, 0, 0.3) 10%,
          rgba(0, 0, 0, 0.7) 20%,
          rgba(0, 0, 0, 1) 30%,
          rgba(0, 0, 0, 1) 70%,
          rgba(0, 0, 0, 0.7) 80%,
          rgba(0, 0, 0, 0.3) 90%,
          transparent 100%);
      mask-composite: intersect;
      -webkit-mask: linear-gradient(to bottom,
          transparent 0%,
          rgba(0, 0, 0, 0.3) 15%,
          rgba(0, 0, 0, 0.8) 25%,
          rgba(0, 0, 0, 1) 35%,
          rgba(0, 0, 0, 1) 100%),
        linear-gradient(to right,
          transparent 0%,
          rgba(0, 0, 0, 0.3) 10%,
          rgba(0, 0, 0, 0.7) 20%,
          rgba(0, 0, 0, 1) 30%,
          rgba(0, 0, 0, 1) 70%,
          rgba(0, 0, 0, 0.7) 80%,
          rgba(0, 0, 0, 0.3) 90%,
          transparent 100%);
      -webkit-mask-composite: source-in;
    }

    /* 触摸反馈 */
    /* .touchable {
            position: relative;
            overflow: hidden;
        }

        .touchable::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .touchable:active::before {
            width: 100%;
            height: 100%;
        } */

    /* 消息提示 */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      font-size: 24px;
      /* border: 1px solid rgba(0, 200, 255, 0.5); */
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.6);
    }

    .empty-state .icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 16px;
    }

    /* 锁定游戏弹出UI */
    .lock-modal {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1e1e3f 0%, #2d2d5a 100%);
      color: white;
      padding: 50px 40px;
      border-radius: 30px 30px 0 0;
      box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      border-top: 3px solid rgba(187, 123, 247, 0.6);
      backdrop-filter: blur(10px);
      min-height: 60%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lock-modal.show {
      transform: translateY(0);
    }

    .lock-modal-content {
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 400px;
      height: 100%;
    }

    .lock-modal-title {
      font-size: 42px;
      font-weight: bold;
      margin-bottom: 40px;
      color: #ff8a95;
      line-height: 1.2;
      /* text-shadow: 0 2px 8px rgba(255, 138, 149, 0.4); */
    }

    .lock-modal-description {
      font-size: 28px;
      line-height: 1.6;
      margin-bottom: 50px;
      color: rgba(255, 255, 255, 0.95);
      padding: 0 20px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .lock-modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 25px;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .lock-modal-btn {
      padding: 25px 40px;
      border: none;
      border-radius: 20px;
      font-size: 22px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 400px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: none;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .lock-modal-btn.member {
      background: linear-gradient(135deg, #d946ef, #a855f7);
      color: white;
      box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);
    }

    .lock-modal-btn.member:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(168, 85, 247, 0.6);
      background: linear-gradient(135deg, #e879f9, #c084fc);
    }

    .lock-modal-btn.planet {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      box-shadow: 0 8px 20px rgba(251, 191, 36, 0.4);
    }

    .lock-modal-btn.planet:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(251, 191, 36, 0.6);
      background: linear-gradient(135deg, #fde047, #facc15);
    }

    .lock-modal-close {
      position: absolute;
      top: 25px;
      right: 30px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      font-size: 36px;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .lock-modal-close:hover {
      color: white;
    }

    /* 遮罩层 */
    .lock-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .lock-modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* 精选游戏横向滚动 */
    .recommended-section {
      flex: 1;
      overflow: hidden;
    }

    .section-title {
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    /* 新增：三卡牌布局样式 */
    .featured-three-cards {
      display: none;
      /* 默认隐藏，可通过JS控制显示 */
      width: 100%;
      height: calc(100% - 32px);
      gap: 20px;
      padding: 0 20px;
      margin-top: 16px;
      position: relative;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE and Edge */
    }

    .featured-three-cards::-webkit-scrollbar {
      display: none;
      /* Chrome, Safari */
    }

    .featured-three-cards.active {
      display: flex;
      justify-content: flex-start;
    }

    .featured-card-item,
    .daily-practice-card {
      flex-shrink: 0 0 calc(33.333% - 14px);
      min-width: calc(33.333% - 14px);
      max-width: calc(33.333% - 14px);
      height: 100%;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .featured-card-item:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .featured-card-item:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .featured-card-item:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    /* .featured-card-item:hover {
            transform: scale(1.05) translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            z-index: 10;
        } */

    .featured-card-item .card-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      position: relative;
    }

    .featured-card-item .game-icon {
      font-size: 64px;
      margin-bottom: 8px;
    }

    .featured-card-item .game-title {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .featured-card-item .game-desc {
      font-size: 16px;
      opacity: 0.9;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .featured-card-item .play-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateX(-50%) translateY(10px);
    }

    .featured-card-item:hover .play-button {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .featured-card-item .play-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateX(-50%) translateY(-2px);
    }

    /* 三卡牌模式下隐藏原有的点击按钮和指示器 */
    .featured-section.three-cards-mode .featured-start-btn,
    .featured-section.three-cards-mode .dots-indicator {
      display: none !important;
    }

    .game-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 10px 0;
      height: 280px;
      -webkit-overflow-scrolling: touch;
    }

    /* 完成标识样式 */
    .completion-badge {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.2);
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .completion-badge.show {
      opacity: 1;
      transform: scale(1);
    }

    .completion-badge:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.6);
    }

    /* 确保父元素有相对定位 */
    .game-card,
    .category-card,
    .featured-card-item {
      position: relative;
    }

    /* 精选卡片的完成标识调整 */
    .featured-card-item .completion-badge {
      bottom: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      font-size: 20px;
    }

    /* 日练习任务卡片样式 */
    .daily-practice-card {
      /* 尺寸由上面的通用规则控制 */
      padding: 15px;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    .daily-practice-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .daily-practice-title {
      font-size: 16px;
      font-weight: bold;
      color: #8b4513;
    }

    .daily-practice-detail {
      font-size: 14px;
      color: #d2691e;
      cursor: pointer;
      text-decoration: underline;
    }

    .daily-practice-tasks {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .daily-practice-main-task {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      align-items: center;
      flex: 1;
    }

    .practice-task-tag-large {
      padding: 6px 12px;
      background: rgba(139, 69, 19, 0.9);
      color: white;
      border-radius: 16px;
      font-size: 16px;
      font-weight: bold;
    }

    .practice-task-title-large {
      font-size: 22px;
      color: #8b4513;
      font-weight: bold;
      line-height: 1.2;
      margin-bottom: 2px;
    }

    .practice-task-quotas {
      font-size: 14px;
      color: #d2691e;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .practice-task-scene-container {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      padding: 10px 12px;
    }

    .practice-task-scene-label {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #8b4513;
      font-weight: bold;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .practice-task-scene-label::before {
      content: '';
      width: 3px;
      height: 12px;
      background: linear-gradient(135deg, #d2691e, #8b4513);
      margin-right: 5px;
      border-radius: 2px;
    }

    .practice-task-scene {
      font-size: 15px;
      color: #8b4513;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .practice-task-empty {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
    }

    /* 滚动指示器样式 */
    .scroll-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }

    .scroll-indicator.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .scroll-indicator:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-50%) scale(1.1);
    }

    .scroll-indicator.left {
      left: 10px;
    }

    .scroll-indicator.right {
      right: 10px;
    }

    .scroll-indicator svg {
      width: 20px;
      height: 20px;
      fill: #666;
    }

    .practice-task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .practice-task-tag {
      flex-shrink: 0;
      padding: 4px 8px;
      background: rgba(139, 69, 19, 0.8);
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .practice-task-title {
      font-size: 14px;
      color: #8b4513;
      font-weight: 500;
    }

    /* 日练习任务Modal样式 - 支持三页滑动 */
    .daily-practice-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      width: 95%;
      max-width: 650px;
      height: 90vh;
      max-height: 750px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .daily-practice-modal.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .daily-practice-modal-content {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .daily-practice-modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      font-size: 48px;
      color: white;
      cursor: pointer;
      transition: color 0.2s ease;
      z-index: 10;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .daily-practice-modal-close:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    /* 滑动容器 */
    .practice-pages-container {
      width: 300%;
      height: 100%;
      display: flex;
      transition: transform 0.3s ease;
    }

    /* 单页面样式 */
    .practice-single-page {
      width: 100%;
      height: 100%;
      padding: 55px 25px 30px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .practice-page {
      width: 33.333%;
      height: 100%;
      padding: 50px 25px 30px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    /* 每页不同的顶部色彩 */
    .practice-page:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f7f7f7 50%, #f7f7f7 100%);
    }

    .practice-page:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #f7f7f7 50%, #f7f7f7 100%);
    }

    .practice-page:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #f7f7f7 50%, #f7f7f7 100%);
    }

    .practice-page-title {
      font-size: 32px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .practice-page-divider {
      width: 100%;
      height: 1px;
      background: rgba(255, 255, 255, 0.3);
      margin-bottom: 20px;
    }

    .practice-page-content {
      flex: 1;
      overflow-y: auto;
    }

    .practice-page-content::-webkit-scrollbar {
      display: none;
    }

    .practice-content-section {
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .practice-content-section:last-child {
      margin-bottom: 0;
    }

    .practice-section-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .practice-section-title::before {
      content: '';
      width: 6px;
      height: 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin-right: 10px;
      border-radius: 3px;
    }

    .practice-section-content {
      font-size: 20px;
      line-height: 1.6;
      color: #555;
    }

    /* 页面指示器 */
    .practice-page-indicators {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .practice-page-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .practice-page-dot.active {
      background: white;
      transform: scale(1.3);
    }

    /* 滑动区域 */
    .practice-swipe-area {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5;
    }

    /* 账号管理页面样式 */
    .account-container {
      padding: 40px 30px;
      max-width: 600px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .account-header {
      display: flex;
      align-items: center;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      margin-bottom: 40px;
      color: white;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }

    .account-icon {
      width: 80px;
      height: 80px;
      margin-right: 20px;
      flex-shrink: 0;
    }

    .account-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
    }

    .account-info {
      flex: 1;
    }

    .account-phone {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .account-status {
      font-size: 16px;
      opacity: 0.9;
    }

    .account-actions {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .account-btn {
      display: flex;
      align-items: center;
      padding: 24px;
      background: white;
      border: 2px solid #e1e8ed;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .account-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .logout-btn {
      border-color: #667eea;
    }

    .logout-btn:hover {
      border-color: #5b6ee8;
      background: #f8f9ff;
    }

    .delete-btn {
      border-color: #ef4444;
    }

    .delete-btn:hover {
      border-color: #dc2626;
      background: #fef2f2;
    }

    .btn-icon {
      font-size: 28px;
      margin-right: 20px;
      flex-shrink: 0;
    }

    .btn-content {
      flex: 1;
    }

    .btn-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }

    .btn-desc {
      font-size: 14px;
      color: #64748b;
      line-height: 1.4;
    }

    .btn-arrow {
      font-size: 20px;
      color: #94a3b8;
      margin-left: 12px;
    }

    .account-tips {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .account-tips p {
      margin: 8px 0;
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }

    /* 确认对话框样式 */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .confirm-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .confirm-modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .confirm-modal.show .confirm-modal-content {
      transform: scale(1);
    }

    .confirm-modal-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .confirm-modal-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .confirm-modal-desc {
      font-size: 16px;
      color: #64748b;
      line-height: 1.5;
      margin-bottom: 30px;
    }

    .confirm-modal-buttons {
      display: flex;
      gap: 16px;
    }

    .confirm-modal-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .confirm-modal-btn.cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .confirm-modal-btn.cancel:hover {
      background: #e2e8f0;
    }

    .confirm-modal-btn.confirm {
      background: #ef4444;
      color: white;
    }

    .confirm-modal-btn.confirm:hover {
      background: #dc2626;
    }

    .confirm-modal-btn.logout {
      background: #667eea;
      color: white;
    }

    .confirm-modal-btn.logout:hover {
      background: #5b6ee8;
    }

    /* 游戏进度条样式 */
    .game-progress-container {
      width: 100%;
      bottom: -16px;
      left: 0;
      right: 0;
    }

    /* 推荐游戏卡片的进度条样式 */
    .game-card .game-progress-container {
      position: static;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }

    /* 分类游戏卡片的进度条样式 */
    .category-card .game-progress-container {
      bottom: -18px;
    }

    .game-progress-bar {
      width: 100%;
      height: 16px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .game-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
      width: 0%;
      transition: width 0.6s ease;
      border-radius: 8px;
    }

    /* 不同等级的进度条颜色 */
    .game-progress-fill.level-1 {
      background: linear-gradient(90deg, #94a3b8 0%, #64748b 100%);
      /* 启蒙级 - 灰色 */
    }

    .game-progress-fill.level-2 {
      background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
      /* 进阶级 - 蓝色 */
    }

    .game-progress-fill.level-3 {
      background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
      /* 精英级 - 紫色 */
    }

    .game-progress-fill.level-4 {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      /* 大师级 - 橙色 */
    }

    .game-progress-fill.level-5 {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
      /* 王者级 - 红色 */
    }

    /* 通用进度条文本样式 */
    .game-progress-text,
    .featured-card-item .game-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      white-space: nowrap;
      z-index: 2;
      line-height: 1;
    }

    .game-progress-text {
      font-size: 10px;
    }

    .featured-card-item .game-progress-text {
      font-size: 11px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* 轮播卡片容器样式调整 */
    .featured-card-item {
      display: flex;
      flex-direction: column;
      height: auto;
    }

    .featured-card-item .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: calc(100% - 30px);
      /* 为进度条和间距留出空间 */
    }

    /* 轮播卡片的进度条容器和样式（带文本） */
    .featured-card-item .game-progress-container {
      position: absolute;
      bottom: -15px;
      left: 0;
      right: 0;
      padding: 0 16px 16px 16px;
      margin-top: 0;
    }

    .featured-card-item .game-progress-bar {
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      position: relative;
    }

    .featured-card-item .game-progress-fill {
      border-radius: 10px;
    }

    /* 游戏卡片容器样式调整 */
    .game-card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      min-width: 200px;
      height: 250px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 8px 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: visible;
      /* 允许进度条显示在外部 */
    }

    .game-card .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: calc(100% - 14px);
      /* 为进度条留出空间 */
    }

    /* 分类卡片容器样式调整 */
    .category-card {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      height: 180px;
      padding: 8px 8px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
      overflow: visible;
      /* 允许进度条显示在外部 */
    }

    .category-card .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100% - 14px);
      /* 为进度条留出空间 */
    }

    /* 训练统计按钮样式 */
    .training-stats-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .training-stats-btn:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .training-stats-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    /* 训练统计iframe样式 */
    #trainingStatsIframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- 左侧菜单栏 -->
    <nav class="sidebar">
      <div class="menu-item touchable active" data-tab="home">
        <span class="icon">☀️</span>
        <span class="menu-text">今日</span>
      </div>
      <div class="menu-item touchable hidden" data-tab="games">
        <span class="icon">🎮</span>
        <span class="menu-text">游戏</span>
      </div>
      <div class="menu-item touchable hidden" data-tab="planet">
        <span class="icon">🗺️</span>
        <span class="menu-text">星球</span>
      </div>
      <div class="menu-item touchable hidden" data-tab="test">
        <span class="icon">📝</span>
        <span class="menu-text">测评</span>
      </div>
      <div class="menu-item touchable hidden" data-tab="member">
        <span class="icon">👑</span>
        <span class="menu-text">会员</span>
      </div>
      <!-- <div class="menu-item touchable" data-tab="stats">
                <span class="icon">📊</span>
                <span class="menu-text">统计</span>
            </div> -->
      <div class="menu-item touchable p-0" data-tab="profile">
        <span class="icon">👤</span>
        <span class="menu-text">我的</span>
      </div>
      <div class="menu-item touchable hidden" data-tab="account" id="accountMenuItem">
        <span class="icon">🔑</span>
        <span class="menu-text">账号</span>
      </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="main-content">
      <!-- 顶部状态栏 -->
      <div class="top-bar">
        <div class="logo"></div>        <div class="status">
          <!-- <div class="time" id="current-time">12:34</div> -->
          <button class="training-stats-btn" id="trainingStatsBtn">训练统计</button>
          <button class="portrait-mode-btn" id="portraitModeBtn" onclick="togglePortraitMode()">
            <span id="portraitModeBtnText">竖屏显示</span>
          </button>
          <div class="menu-dropdown dev-only">
            <button class="menu-button" id="menuButton">
              <span class="menu-icon">≡</span>
            </button>
            <div class="dropdown-menu" id="dropdownMenu">
              <div class="dropdown-item" data-action="profile">我的</div>
              <div class="dropdown-item" data-action="member">会员</div>
              <div class="dropdown-item" data-action="settings">设置</div>
              <div class="dropdown-item" data-action="account">账号</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 首页内容 -->
      <div class="tab-content active" id="home">
        <div class="home-content">
          <!-- 精选游戏轮播 -->
          <section class="featured-section">
            <h2 class="section-title">今日任务</h2>
            <div class="featured-slider">
              <!-- 动态加载的轮播内容 -->
            </div>
            <div class="dots-indicator">
              <!-- 动态加载的圆点指示器 -->
            </div>
            <button class="featured-start-btn">开始游戏</button>
          </section>

          <!-- 推荐游戏横向滚动 -->
          <section class="recommended-section">
            <h2 class="section-title">待训练任务</h2>
            <div class="game-row">
              <!-- 动态加载的推荐游戏 -->
            </div>
          </section>
        </div>
      </div>

      <!-- 游戏分类页面 -->
      <div class="tab-content" id="games">
        <div class="games-content">
          <!-- 动态加载的游戏分类内容 -->
        </div>
      </div>

      <!-- 会员页面 -->
      <div class="tab-content" id="member">
        <iframe id="memberIframe" frameborder="0"></iframe>
      </div> <!-- 星球介绍页面 -->
      <div class="tab-content" id="planet">
        <iframe id="planetIframe" frameborder="0" style="width: 100%; height: 100%;">
        </iframe>
      </div>

      <!-- 测评页面 -->
      <div class="tab-content" id="test">
        <iframe id="testIframe" frameborder="0" style="width: 100%; height: 100%;">
        </iframe>
      </div>

      <!-- 统计页面 -->
      <div class="tab-content" id="stats">
        <div class="stats-content">
          <h2 class="section-title">用户统计</h2>
          <div class="stats-grid">
            <div class="stat-card touchable">
              <div class="stat-value">85</div>
              <div class="stat-label">操作能力</div>
            </div>
            <div class="stat-card touchable">
              <div class="stat-value">92</div>
              <div class="stat-label">策略思维</div>
            </div>
            <div class="stat-card touchable">
              <div class="stat-value">78</div>
              <div class="stat-label">反应速度</div>
            </div>
            <div class="stat-card touchable">
              <div class="stat-value">88</div>
              <div class="stat-label">综合评分</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 设置页面 -->
      <div class="tab-content" id="settings">
        <div class="settings-content">
          <h2 class="section-title">设置</h2>
          <div class="settings-section">
            <div class="age-display-row">
              <span>当前用户年龄（测试值）：</span>
              <span id="currentAge">无</span>
              <span id="ageStatus" class="age-status">未应用</span>
            </div>
            <div class="age-control-row">
              <button class="age-btn age-decrease" id="decreaseBtn">-</button>
              <span id="ageValue" class="age-value">8</span>
              <button class="age-btn age-increase" id="increaseBtn">+</button>
              <button class="control-btn apply-btn" id="applyBtn">应用</button>
              <button class="control-btn clear-btn" id="clearBtn">清除</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 个人页面 -->
      <div class="tab-content" id="profile">
        <iframe id="profileIframe" frameborder="0"></iframe>
      </div>

      <!-- 账号管理页面 -->
      <div class="tab-content" id="account">
        <div class="account-container">
          <div class="account-header">
            <div class="account-icon">
              <img
                src="https://cdn.keepwork.com/update61/assetdownload/update/texture/aries/creator/keepwork/minigame/logo.png.p,ba44b8275f4bdb7e6dacebc939b2ac13,33659"
                alt="麦思星球" />
            </div>
            <div class="account-info">
              <div class="account-phone" id="accountPhone">未登录</div>
              <div class="account-status">麦思星球用户</div>
            </div>
          </div>

          <div class="account-actions">
            <button class="account-btn logout-btn" id="logoutBtn">
              <div class="btn-icon">🚪</div>
              <div class="btn-content">
                <div class="btn-title">退出登录</div>
                <div class="btn-desc">切换到其他账号</div>
              </div>
              <div class="btn-arrow">→</div>
            </button>

            <button class="account-btn delete-btn" id="deleteAccountBtn">
              <div class="btn-icon">⚠️</div>
              <div class="btn-content">
                <div class="btn-title">注销账号</div>
                <div class="btn-desc">永久删除账号和所有数据</div>
              </div>
              <div class="btn-arrow">→</div>
            </button>
          </div>

          <div class="account-tips">
            <p>• 退出登录后可以使用其他手机号重新登录</p>
            <p>• 注销账号后将无法恢复，请谨慎操作</p>
          </div>
        </div>
      </div>

      <!-- 训练统计页面 -->
      <div class="tab-content" id="training-stats">
        <iframe id="trainingStatsIframe" frameborder="0"></iframe>
      </div>
    </main>
  </div>

  <script>
    class LocalStorageProxy {
      constructor() {
        this.requestId = 0
        this.pendingRequests = new Map()

        // 监听父页面的响应
        window.addEventListener('message', (event) => {
          if (event.data.type === 'localStorageResponse') {
            const { requestId, success, data, error } = event.data
            const request = this.pendingRequests.get(requestId)

            if (request) {
              this.pendingRequests.delete(requestId)
              if (success) {
                request.resolve(data)
              } else {
                request.reject(new Error(error))
              }
            }
          }
        })
      }

      _sendRequest(action, key, value) {
        return new Promise((resolve, reject) => {
          const requestId = ++this.requestId

          this.pendingRequests.set(requestId, { resolve, reject })

          // 设置超时
          setTimeout(() => {
            if (this.pendingRequests.has(requestId)) {
              this.pendingRequests.delete(requestId)
              reject(new Error('LocalStorage operation timeout'))
            }
          }, 5000)

          // 发送请求到父页面
          window.parent.postMessage(
            {
              type: 'localStorage',
              action,
              key,
              value,
              requestId,
            },
            '*'
          )
        })
      }

      // 标准localStorage API
      async getItem(key) {
        return await this._sendRequest('getItem', key)
      }

      async setItem(key, value) {
        return await this._sendRequest('setItem', key, value)
      }

      async removeItem(key) {
        return await this._sendRequest('removeItem', key)
      }

      async clear() {
        return await this._sendRequest('clear')
      }

      async key(index) {
        return await this._sendRequest('key', null, index)
      }

      async length() {
        return await this._sendRequest('length')
      }

      async keys() {
        return await this._sendRequest('keys')
      }

      // 扩展API - 使用父页面的工具方法
      async getStorageData(key, defaultValue = {}) {
        return await this._sendRequest('getStorageData', key, defaultValue)
      }

      async setStorageData(key, data) {
        return await this._sendRequest('setStorageData', key, data)
      }
    }

    // 创建全局实例
    window.parentLocalStorage = new LocalStorageProxy()

    class GameApp {
      constructor() {
        this.gameTitles = ''
        this.currentTab = 'home'
        this.currentSlide = 0
        this.slideInterval = null
        this.parentLocationHref = null
        this.userIsVip = true
        this.isDevMode = false
        this.maisiToken = null
        this.userInfo = null
        this.menuVisibility = {
          games: false,
          planet: false,
          test: false,
          member: false,
          settings: false,
          account: false,
        }
        // 年龄设置相关属性
        this.currentAge = null
        this.tempAge = 8
        this.ageApplied = false
        // 日练习任务数据
        this.dailyPracticeTasks = []
        // 账号页面事件初始化标志
        this._accountEventsInitialized = false
        // 游戏积分数据
        this.trainingPointsData = {}
        // 积分数据监听器标志
        this.hasTrainingPointsListener = false
        // 存储所有游戏数据，用于在openGame中查找游戏信息
        this.allGamesData = []
        // 今日推荐游戏
        this.todayRecommendedGames = null
        // 监听窗口可见性变化，重新获取积分数据
        this.setupVisibilityListener()
        this.init()
      }

      /**
       * 切换菜单项的显示状态
       * @param {string} menuName - 菜单名称 ('games', 'planet', 'member', 'all')
       * @param {boolean} visible - 是否显示，可选参数，不传则切换当前状态
       */
      toggleMenuVisibility(menuName, visible = null) {
        const menuItems = {
          games: document.querySelector('.menu-item[data-tab="games"]'),
          planet: document.querySelector('.menu-item[data-tab="planet"]'),
          test: document.querySelector('.menu-item[data-tab="test"]'),
          // member: document.querySelector('.menu-item[data-tab="member"]'),
          settings: document.querySelector('.menu-item[data-tab="settings"]'),
          account: document.querySelector('.menu-item[data-tab="account"]'),
        }

        if (menuName === 'all') {
          // 切换所有菜单项
          const allVisible = visible !== null ? visible : Object.values(this.menuVisibility).some((v) => !v)

          Object.keys(menuItems).forEach((key) => {
            this.menuVisibility[key] = allVisible
            if (menuItems[key]) {
              if (allVisible) {
                menuItems[key].classList.remove('hidden')
              } else {
                menuItems[key].classList.add('hidden')
              }
            }
          })

          // this.showMessage(`${allVisible ? '显示' : '隐藏'}所有菜单项`)
        } else if (menuItems[menuName]) {
          // 切换单个菜单项
          const newVisibility = visible !== null ? visible : !this.menuVisibility[menuName]
          this.menuVisibility[menuName] = newVisibility

          if (newVisibility) {
            menuItems[menuName].classList.remove('hidden')
          } else {
            menuItems[menuName].classList.add('hidden')

            // 如果当前显示的就是被隐藏的页面，切换到首页
            if (this.currentTab === menuName) {
              this.switchToHome()
            }
          }

          // this.showMessage(`${newVisibility ? '显示' : '隐藏'}${this.getMenuDisplayName(menuName)}菜单`)
        }
      }

      /**
       * 管理devMode相关的UI显示
       * @param {boolean} enable - 是否启用devMode
       */
      toggleDevModeUI(enable = true) {
        const body = document.body

        if (enable) {
          body.classList.add('dev-mode')
          // console.log('🔧 Dev模式UI已启用')
        } else {
          body.classList.remove('dev-mode')
          // console.log('🔒 Dev模式UI已禁用')
        }
      }

      /**
       * 集中管理devMode下的所有特性
       * @param {boolean} enable - 是否启用devMode
       */
      enableDevMode(enable = true) {
        if (enable) {
          this.isDevMode = true

          // 启用devMode UI显示
          this.toggleDevModeUI(true)

          // 显示所有菜单和解锁内容
          this.toggleAppState({
            showAllMenus: true,
            unlockContent: true,
          })
        } else {
          this.isDevMode = false

          // 禁用devMode UI显示
          this.toggleDevModeUI(false)

          // 可以在这里添加生产环境的默认设置
        }
      }

      /**
       * 解锁所有游戏内容
       * @param {boolean} unlock - 是否解锁，默认为true
       */
      unlockAllContent(unlock = true) {
        // 更新用户VIP状态
        this.userIsVip = !unlock

        // 移除或添加所有游戏卡片的锁定状态
        const gameCards = document.querySelectorAll('.game-card, .category-card')
        gameCards.forEach((card) => {
          if (unlock) {
            card.classList.remove('locked')
            // 移除锁定覆盖层
            const lockOverlay = card.querySelector('.lock-overlay')
            if (lockOverlay) {
              lockOverlay.remove()
            }
          } else {
            card.classList.add('locked')
            // 添加锁定覆盖层（如果不存在）
            if (!card.querySelector('.lock-overlay')) {
              const lockOverlay = document.createElement('div')
              lockOverlay.className = 'lock-overlay'
              lockOverlay.innerHTML = '<div class="lock-icon">🔒</div>'
              card.appendChild(lockOverlay)
            }
          }
        })

        this.showMessage(unlock ? '🎉 已解锁所有游戏内容！' : '🔒 已锁定所有游戏内容')
      }

      /**
       * 组合方法：同时切换菜单显示和解锁内容
       * @param {object} options - 配置选项
       */
      toggleAppState(options = {}) {
        const {
          showAllMenus = true,
          unlockContent = true,
          specificMenus = null, // 例如: { games: true, planet: false, member: true }
        } = options

        // 处理菜单显示
        if (specificMenus) {
          Object.entries(specificMenus).forEach(([menuName, visible]) => {
            this.toggleMenuVisibility(menuName, visible)
          })
        } else {
          this.toggleMenuVisibility('all', showAllMenus)
        }

        // 处理内容解锁
        this.unlockAllContent(unlockContent)
      }

      /**
       * 更新特定游戏的完成标识
       * @param {string} gameName - 游戏名称
       * @param {boolean} isCompleted - 是否完成
       */
      updateCompletionBadges(gameName, isCompleted) {
        // 只选择精选游戏区域中的游戏元素
        const featuredSlider = document.querySelector('.featured-slider')
        if (!featuredSlider) return

        let featuredGameCards = Array.from(featuredSlider.querySelectorAll(`[data-game-name="${gameName}"]`))
        if (gameName === 'thinking_understanding') {
          featuredGameCards = featuredGameCards.concat(Array.from(featuredSlider.querySelectorAll(`[data-game-name="${gameName}2"]`)))
        }

        featuredGameCards.forEach((card) => {
          // 移除现有的完成标识
          const existingBadge = card.querySelector('.completion-badge')
          if (existingBadge) {
            existingBadge.remove()
          }

          // 如果游戏已完成，添加完成标识
          if (isCompleted) {
            const badge = document.createElement('div')
            badge.className = 'completion-badge'
            badge.innerHTML = '✓'
            badge.title = '已完成'

            card.appendChild(badge)

            // 添加显示动画
            setTimeout(() => {
              badge.classList.add('show')
            }, 100)
          }
        })
      }

      /**
       * 检查特定游戏是否在今天完成
       * @param {string} gameName - 游戏名称
       * @returns {boolean} 是否在今天完成
       */
      isGameCompletedToday(gameName, finishInfo) {
        try {
          if (!finishInfo || !finishInfo.timestamp) {
            return false
          }

          const today = new Date()
          const todayStr = today.toISOString().split('T')[0]

          const finishDate = new Date(finishInfo.timestamp)
          const finishDateStr = finishDate.toISOString().split('T')[0]

          return finishDateStr === todayStr
        } catch (error) {
          console.error('检查游戏完成状态失败:', error)
          return false
        }
      }

      getMiniGameFinishInfo() {
        if (!this.hasGameFinishListener) {
          this.hasGameFinishListener = true
          window.addEventListener('message', (e) => {
            if (e.data.type === 'miniGameFinishInfoResponse') {
              for (const [game, info] of Object.entries(e.data.data || {})) {
                this.updateCompletionBadges(game, this.isGameCompletedToday(game, info))
              }
            }
          })
        }
        window.parent.postMessage({ type: 'getMiniGameFinishInfo' }, '*')
      }

      async init() {
        // this.initTime();
        await this.getUserInfo()
        await this.getDailyPracticeTasks()
        await this.initGameData()
        await this.getTrainingPointsData()
        this.initTabNavigation()
        this.initSlider()
        this.initGameClickEvents()
        this.initTouchEvents()
        this.initSettings()
        this.initTopMenuDropdown()
        this.initTrainingStatsButton()
      }

      initTime() {
        const updateTime = () => {
          const now = new Date()
          const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
          })
          document.getElementById('current-time').textContent = timeString
        }

        updateTime()
        setInterval(updateTime, 1000)
      }

      async getUserInfo() {
        window.addEventListener('message', (e) => {
          switch (e.data.type) {
            case 'locationResponse':
              this.parentLocationHref = e.data.href
              break
            case 'testUserAgeResponse':
              if (e.data.age) {
                this.tempAge = e.data.age
                this.updateAgeDisplay()
                this.applyAge(false)
              }
              break
            case 'todayRecommendedGamesResponse':
              this.todayRecommendedGames = e.data.gameNames
              break
            case 'miniGameProxyDataResponse':
              this.keepworkUserInfo = e.data.keepworkUserInfo || {}
              this.updateWelcomeMessage(this.keepworkUserInfo.name || this.keepworkUserInfo.nickName || this.keepworkUserInfo.username)
              break
            case 'gameNameClicked':
              const gameName = e.data.gameInfo.name
              this.openGame(gameName)
              break
          }
        })
        window.parent.postMessage({ type: 'getLocation' }, '*')
        await new Promise((resolve) => setTimeout(resolve, 500))

        // 获取父页面的URL和参数
        const parentUrl = new URL(
          this.parentLocationHref ? decodeURIComponent(this.parentLocationHref) : window.location.href
        )
        const parentUrlParams = new URLSearchParams(parentUrl.search)

        // 检查是否在开发模式
        let devMode = parentUrlParams.get('dev')
        if (!devMode) {
          const currentUrl = new URL(window.location.href)
          const currentUrlParams = new URLSearchParams(currentUrl.search)
          devMode = currentUrlParams.get('dev')
        }

        // 检查是否显示账号菜单 - 非小程序环境或dev=true时显示
        const cmdline = parentUrlParams.get('cmdline')
        const shouldShowAccountMenu = (!this.isInWechatMiniProgram() && !cmdline) || devMode === 'true'

        if (shouldShowAccountMenu) {
          this.toggleMenuVisibility('account', true)
        }

        if (devMode === 'true') {
          window.parent.postMessage({ type: 'getTestUserAge' }, '*')
          this.enableDevMode(true)
        } else {
          // 清除测试用户年龄
          window.parent.postMessage(
            {
              type: 'setTestUserAge',
              age: null,
            },
            '*'
          )
        }

        // 获取第三方token
        let token = parentUrlParams.get('thirdpartytoken')
        const cmdlineParam = parentUrlParams.get('cmdline')
        if (cmdlineParam) {
          const cmdlineParams = new URLSearchParams(cmdlineParam.replace(/\s+/g, '&'))
          // for (const [key, value] of cmdlineParams) {
          //     console.log(`cmdline参数 - ${key}: ${value}`);
          // }
          const thirdpartytoken = cmdlineParams.get('thirdpartytoken')
          if (thirdpartytoken) {
            // 如果cmdline中有token，使用它覆盖URL参数中的token
            token = thirdpartytoken
          }
        }
        if (!token) {
          const username = parentUrlParams.get('username')
          token = parentUrlParams.get('maisiToken') || parentUrlParams.get('token')
          if (!token) {
            window.parent.postMessage({ type: 'getTodayRecommendedGames' }, '*')
            await new Promise((resolve) => setTimeout(resolve, 500))
            this.loadMemberIframe({ username })
            return
          }
        }
        this.maisiToken = token

        const from = parentUrlParams.get('from')
        const headers = {}
        headers['Authorization'] = `Bearer ${token}`
        try {
          const apiDev = 'https://maseai-be-qa1.langcong.com/api/v1/open/getUserInfo'
          const apiProd = 'https://be.maseai.com/api/v1/open/getUserInfo'
          const api = from === 'dev' ? apiDev : apiProd
          const response = await fetch(api, {
            headers: headers,
          })
          const data = await response.json()
          if (data.code === 200 && data.data) {
            // console.log('用户信息:', data.data)
            this.userInfo = data.data
            const unlockgames = parentUrlParams.get('unlockgames') || ''
            this.gameTitles = data.data.gameName + (unlockgames ? ',' + unlockgames : '')
            this.updateWelcomeMessage(data.data.name)
          } else {
            // 可能是从keepwork或者ms_games_login登录，无麦思测评用户数据，无接口推荐游戏，取本地逻辑计算出的推荐游戏
            window.parent.postMessage({ type: 'getTodayRecommendedGames' }, '*')
            await new Promise((resolve) => setTimeout(resolve, 500))
          }
        } catch (error) {
          console.error('获取用户信息失败:', error)
        }
        this.getParacraftUserInfo(token, from)
      } async loadMemberIframe({ userId, username }) {
        if (!userId && !username) return
        const encodedUserId = userId ? btoa(JSON.stringify({ userId: userId })) : btoa(JSON.stringify({ username }))
        const response = await fetch(`https://api.keepwork.com/core/v0/users/kp${encodedUserId}/detail`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })

        const data = await response.json()
        if (!data) return

        // console.log('ParaCraft用户信息:', data);
        this.userIsVip = data.commonVip || data.vip
        const memberIframe = document.getElementById('memberIframe')
        if (!memberIframe || memberIframe.src !== '') return
        memberIframe.src = `https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/vip?userId=${data.id}`
      }      /**
       * 加载星球iframe内容
       */
      loadPlanetIframe() {
        const planetIframe = document.getElementById('planetIframe')

        // 如果iframe已经加载过，直接返回
        if (!planetIframe || planetIframe.src !== '') return

        // 设置iframe的src
        planetIframe.src = 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/ms_games_planet'
      }

      /**
       * 加载测评iframe内容
       */
      loadTestIframe() {
        const testIframe = document.getElementById('testIframe')

        // 如果iframe已经加载过，直接返回
        if (!testIframe || testIframe.src !== '') return

        // 如果有maisiToken，添加到URL参数中
        const accessToken = this.maisiToken || ''
        testIframe.src = `https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/ms_games_test?accessToken=${accessToken}`
      }

      async getParacraftUserInfo(token, from) {
        try {
          let response = await fetch('https://api.keepwork.com/core/v0/oauth_users/maisi', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              maisiToken: token,
              from: from || 'prod', // 默认使用生产环境
            }),
          })

          const data = await response.json()
          if (!data) return

          this.loadMemberIframe({ userId: data.userId })
        } catch (error) {
          console.error('获取ParaCraft用户信息失败:', error)
        }
      }

      /**
       * 获取训练积分数据
       */
      async getTrainingPointsData() {
        try {
          // 避免重复添加事件监听器
          if (!this.hasTrainingPointsListener) {
            this.hasTrainingPointsListener = true
            // 监听来自父窗口的积分数据响应
            window.addEventListener('message', (e) => {
              if (e.data.type === 'allGamesTrainingPointsResponse') {
                this.trainingPointsData = e.data.allPointsData || {}
                // 更新当前活跃tab中的游戏卡片进度条
                this.updateAllGameProgressBars()
              }
            })
          }

          // 向父窗口请求积分数据
          window.parent.postMessage({ type: 'getAllGamesTrainingPoints' }, '*')

          // 设置超时，如果5秒内没有收到响应，则使用默认0分显示进度条
          setTimeout(() => {
            if (Object.keys(this.trainingPointsData).length === 0) {
              console.log('获取积分数据超时，使用默认0分显示进度条')
              // 保持trainingPointsData为空对象，进度条仍会显示，但默认为0分
              this.updateAllGameProgressBars()
            }
          }, 5000)
        } catch (error) {
          console.error('获取训练积分数据失败:', error)
        }
      }

      /**
       * 根据积分计算等级信息
       * @param {number} points - 积分数量
       * @returns {object} 等级信息
       */
      getGameLevel(points = 0) {
        const levels = [
          { level: 1, name: '启蒙级', min: 0, max: 300, color: 'level-1' },
          { level: 2, name: '进阶级', min: 301, max: 800, color: 'level-2' },
          { level: 3, name: '精英级', min: 801, max: 1500, color: 'level-3' },
          { level: 4, name: '大师级', min: 1501, max: 3000, color: 'level-4' },
          { level: 5, name: '王者级', min: 3001, max: Infinity, color: 'level-5' },
        ]

        for (const levelInfo of levels) {
          if (points >= levelInfo.min && points <= levelInfo.max) {
            const progress =
              levelInfo.max === Infinity
                ? 100
                : Math.min(100, ((points - levelInfo.min) / (levelInfo.max - levelInfo.min)) * 100)

            return {
              ...levelInfo,
              progress: Math.round(progress),
              currentPoints: points,
            }
          }
        }

        return levels[0] // 默认返回启蒙级
      }

      /**
       * 更新所有游戏卡片的进度条
       * 优化版本：只更新当前活跃tab中的卡片，提升性能
       */
      updateAllGameProgressBars() {
        // 测试方法：为所有游戏随机生成积分数据
        const generateTestData = () => {
          console.log('🧪 生成测试积分数据')
          const testData = {}

          // 获取当前页面所有游戏卡片的gameName
          const allGameCards = document.querySelectorAll('[data-game-name]')
          const gameNames = new Set()

          allGameCards.forEach((card) => {
            const gameName = card.dataset.gameName
            if (gameName) {
              gameNames.add(gameName)
            }
          })

          // 为每个游戏生成随机积分
          gameNames.forEach((gameName) => {
            // 随机生成0-4000分，确保覆盖所有等级
            const randomPoints = Math.floor(Math.random() * 4000)
            testData[gameName] = {
              total: randomPoints,
              dailyTotal: Math.floor(Math.random() * 100),
              lastUpdateDate: '2025-08-04',
            }
          })

          console.log('🎲 随机生成的测试数据:', testData)
          return testData
        }

        // 🧪 开发模式下生成测试数据
        // if (this.isDevMode) {
        //   this.trainingPointsData = generateTestData()
        //   console.log('🚀 开发模式：使用测试积分数据')
        // } else {
        //   return
        // }

        // console.log('开始更新当前活跃tab的游戏进度条, 积分数据:', this.trainingPointsData)

        // 获取当前活跃的tab内容
        const activeTabContent = document.querySelector('.tab-content.active')
        if (!activeTabContent) {
          console.log('没有找到活跃的tab内容')
          return
        }

        // 只在活跃tab中查找和更新卡片
        const gameCards = activeTabContent.querySelectorAll('.game-card[data-game-name]')
        // console.log(`在活跃tab中找到 ${gameCards.length} 个推荐游戏卡片`)
        gameCards.forEach((card) => {
          this.updateGameCardProgressBar(card, false)
        })

        const categoryCards = activeTabContent.querySelectorAll('.category-card[data-game-name]')
        // console.log(`在活跃tab中找到 ${categoryCards.length} 个分类游戏卡片`)
        categoryCards.forEach((card) => {
          this.updateGameCardProgressBar(card, false)
        })

        const featuredCards = activeTabContent.querySelectorAll('.featured-card-item[data-game-name]')
        // console.log(`在活跃tab中找到 ${featuredCards.length} 个轮播游戏卡片`)
        featuredCards.forEach((card) => {
          this.updateGameCardProgressBar(card, true)
        })
      }

      /**
       * 为单个游戏卡片更新进度条
       * @param {HTMLElement} card - 游戏卡片元素
       * @param {boolean} showText - 是否显示文本信息
       */
      updateGameCardProgressBar(card, showText = false) {
        const gameName = card.dataset.gameName
        if (!gameName) {
          console.log('卡片缺少gameName:', card)
          return
        }

        // 获取积分数据，如果没有数据则默认为0分
        const gameData =
          this.trainingPointsData && this.trainingPointsData[gameName]
            ? this.trainingPointsData[gameName]
            : { total: 0, dailyTotal: 0, lastUpdateDate: '' }
        const points = gameData.total || 0
        const levelInfo = this.getGameLevel(points)

        // console.log(`更新游戏 ${gameName} 进度条: ${points} 分, 等级: ${levelInfo.level} (${points === 0 ? '默认0分' : '真实积分'})`)

        // 查找或创建进度条容器，作为卡片的子元素
        let progressContainer = card.querySelector('.game-progress-container')
        if (!progressContainer) {
          progressContainer = document.createElement('div')
          progressContainer.className = 'game-progress-container'
          card.appendChild(progressContainer)
        }

        // 清空容器
        progressContainer.innerHTML = ''

        // 创建进度条
        const progressBar = document.createElement('div')
        progressBar.className = 'game-progress-bar'

        const progressFill = document.createElement('div')
        progressFill.className = `game-progress-fill ${levelInfo.color}`
        progressFill.style.width = `${levelInfo.progress}%`

        progressBar.appendChild(progressFill)

        // 添加进度文本
        const progressText = document.createElement('div')
        progressText.className = 'game-progress-text'

        if (showText) {
          // featured-card-item：显示完整文本信息
          if (levelInfo.level === 5) {
            progressText.textContent = `Lv${levelInfo.level} ${levelInfo.name} ${levelInfo.currentPoints} 分`
          } else {
            progressText.textContent = `Lv${levelInfo.level} ${levelInfo.name} ${levelInfo.currentPoints}/${levelInfo.max} 分`
          }
        } else {
          // 其他卡片：只显示数字格式
          if (levelInfo.level === 5) {
            progressText.textContent = `${levelInfo.currentPoints}`
          } else {
            progressText.textContent = `${levelInfo.currentPoints}/${levelInfo.max}`
          }
        }

        progressBar.appendChild(progressText)
        progressContainer.appendChild(progressBar)
      }

      /**
       * 🧪 生成测试积分数据并更新进度条
       * 开发测试用：为所有游戏随机生成积分，展示各种等级的进度条效果
       */
      generateTestProgressBars() {
        console.log('🧪 手动生成测试积分数据并更新进度条')

        // 获取当前页面所有游戏卡片的gameName
        const allGameCards = document.querySelectorAll('[data-game-name]')
        const gameNames = new Set()

        allGameCards.forEach((card) => {
          const gameName = card.dataset.gameName
          if (gameName) {
            gameNames.add(gameName)
          }
        })

        // 生成测试数据，确保覆盖所有等级
        const testData = {}
        const levelRanges = [
          { min: 0, max: 300 }, // 启蒙级
          { min: 301, max: 800 }, // 进阶级
          { min: 801, max: 1500 }, // 精英级
          { min: 1501, max: 3000 }, // 大师级
          { min: 3001, max: 4000 }, // 王者级
        ]

        const gameNamesArray = Array.from(gameNames)
        gameNamesArray.forEach((gameName, index) => {
          // 循环使用不同等级范围，确保能看到各种等级的进度条
          const levelIndex = index % levelRanges.length
          const range = levelRanges[levelIndex]
          const randomPoints = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min

          testData[gameName] = {
            total: randomPoints,
            dailyTotal: Math.floor(Math.random() * 100),
            lastUpdateDate: '2025-08-04',
          }
        })

        // 设置测试数据并更新进度条
        this.trainingPointsData = testData
        console.log('🎲 生成的测试数据:', testData)

        // 立即更新进度条
        this.updateAllGameProgressBars()

        // 提示信息
        console.log('✅ 测试进度条已生成！可以在控制台调用 gameApp.generateTestProgressBars() 重新生成')

        return testData
      }

      /**
       * 为日练习任务卡片更新进度条
       * @param {HTMLElement} card - 日练习任务卡片元素
       */
      updateDailyPracticeProgressBar(card) {
        // 计算所有游戏的总积分
        let totalPoints = 0
        if (this.trainingPointsData && Object.keys(this.trainingPointsData).length > 0) {
          Object.values(this.trainingPointsData).forEach((gameData) => {
            if (gameData && gameData.total) {
              totalPoints += gameData.total
            }
          })
        }
        // 如果没有积分数据，默认为0分

        const levelInfo = this.getGameLevel(totalPoints)

        // 移除已存在的进度条
        const existingProgressBar = card.querySelector('.game-progress-bar')
        if (existingProgressBar) {
          existingProgressBar.remove()
        }

        // 创建进度条
        const progressBar = document.createElement('div')
        progressBar.className = 'game-progress-bar'

        const progressFill = document.createElement('div')
        progressFill.className = `game-progress-fill ${levelInfo.color}`
        progressFill.style.width = `${levelInfo.progress}%`

        // 添加进度文本
        const progressText = document.createElement('div')
        progressText.className = 'game-progress-text'

        if (levelInfo.level === 5) {
          progressText.textContent = `Lv${levelInfo.level} ${levelInfo.name} ${levelInfo.currentPoints} 分`
        } else {
          progressText.textContent = `Lv${levelInfo.level} ${levelInfo.name} ${levelInfo.currentPoints}/${levelInfo.max} 分`
        }

        progressBar.appendChild(progressFill)
        progressBar.appendChild(progressText)
        card.appendChild(progressBar)
      }

      /**
       * 设置窗口可见性监听器
       */
      setupVisibilityListener() {
        // 监听窗口焦点事件
        window.addEventListener('focus', () => {
          this.getTrainingPointsData()
        })

        // 监听页面可见性变化
        if (typeof document.visibilityState !== 'undefined') {
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              this.getTrainingPointsData()
            }
          })
        }
      }

      async showAndLoadProfileIframe(token) {
        const profileIframe = document.getElementById('profileIframe')

        if (!profileIframe || profileIframe.src !== '') return
        profileIframe.src = `https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/user_profile?maisiToken=${token}`
        // profileIframe.src = `http://127.0.0.1:5500/maisi/maisi/webgames/data/user_profile.html?maisiToken=${token}`

        const containerWidth = 1160
        const containerHeight = 660

        let targetWidth = Math.max(containerWidth, 1280)
        let targetHeight = (targetWidth / containerWidth) * containerHeight
        if (targetHeight < 720) {
          targetWidth = targetWidth * (720 / targetHeight)
          targetHeight = 720
        }
        const scale = containerWidth / targetWidth

        profileIframe.style.transformOrigin = '0 0'
        profileIframe.style.transform = `scale(${scale})`
        profileIframe.style.width = `${targetWidth}px`
        profileIframe.style.height = `${targetHeight}px`
      }

      async initGameData() {
        try {
          const response = await fetch(
            `https://api.keepwork.com/core/v0/repos/${encodeURIComponent('maisi/maisi')}/files/${encodeURIComponent(
              'maisi/maisi/webgames/data/todayRecommended_config'
            )}.md`
          )
          const configText = await response.text()
          const categories = this.parseGameConfig(configText)

          // 收集所有游戏
          const allGames = []
          categories.forEach((category) => {
            allGames.push(...category.games)
          })

          // 存储所有游戏数据供openGame使用
          this.allGamesData = allGames

          // 更新轮播图（前三个游戏）
          // 更新轮播图 - 优先显示与gameTitles匹配的游戏
          const featuredGames = this.selectFeaturedGames(allGames)
          this.updateFeaturedSlider(featuredGames)
          this.getMiniGameFinishInfo()

          // 更新推荐游戏列表（随机选择5个）
          const shuffledGames = this.shuffleArray([...allGames])
          this.updateRecommendedGames(shuffledGames)

          // 更新游戏分类列表
          this.updateGameCategories(categories)

          // 延迟更新进度条，确保DOM已渲染完成
          setTimeout(() => {
            this.updateAllGameProgressBars()
          }, 100)
        } catch (error) {
          console.error('加载游戏配置失败:', error)
        }
      }

      async getDailyPracticeTasks() {
        try {
          // 模拟接口调用，实际需要根据具体接口地址和参数进行调整
          // const baseUrl = 'https://maseai-be-qa1.langcong.com/api/v1'
          const baseUrl = 'https://be.maseai.com/api/v1'
          const response = await fetch(`${baseUrl}/task/user/growthPlan/SpecifyDate?dateTime=${Date.now()}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${this.maisiToken}`,
            },
          })

          if (response.ok) {
            const data = await response.json()
            if (data.code === 200 && data.data) {
              this.dailyPracticeTasks = data.data
              console.log('获取日练习任务数据成功:', this.dailyPracticeTasks)
            } else {
              console.warn('获取日练习任务数据失败:', data.msg)
              // 使用模拟数据
              // this.setMockDailyPracticeTasks()
            }
          } else {
            console.warn('接口请求失败，使用模拟数据')
            // this.setMockDailyPracticeTasks()
          }
        } catch (error) {
          console.error('获取日练习任务数据异常:', error)
          // 使用模拟数据
          // this.setMockDailyPracticeTasks()
        }
      }

      setMockDailyPracticeTasks() {
        // 模拟数据，用于开发测试
        this.dailyPracticeTasks = [
          {
            taskMeta: {
              quotaName: '情绪能力',
              taskName: '绘本情绪小标注',
              quotas: ['情绪表达'],
            },
            taskScene: {
              title: '任务场景',
              content: '亲子阅读或孩子自主阅读时间',
            },
            operationSuggestion: {
              title: '操作建议',
              content:
                '孩子阅读绘本时，用便利贴标注出角色的情绪，在便利贴上画出表情或简单写下情绪词语，阅读后与家人交流，分析角色产生不同情绪的原因。',
            },
            toolSuggestion: {
              title: '工具建议',
              content: '绘本、便利贴、彩笔',
            },
            arrangement: {
              title: '时间安排',
              weekDays: ['周四'],
            },
          },
          {
            taskMeta: {
              quotaName: '认知能力',
              taskName: '寻宝大师',
              quotas: ['视分辨'],
            },
            taskScene: {
              title: '任务场景',
              content: '麦思星球',
            },
            operationSuggestion: {
              title: '操作建议',
              content: '考验你的视觉分辨与选择注意力。请克服干扰，识别并数出不同形状和不同颜色的几何图形。',
            },
            toolSuggestion: {
              title: '工具建议',
              content: '寻宝大师',
            },
            arrangement: {
              title: '时间安排',
              weekDays: ['周四'],
            },
          },
          {
            taskMeta: {
              quotaName: '认知能力',
              taskName: '旋转宫殿',
              quotas: ['空间思维'],
            },
            taskScene: {
              title: '任务场景',
              content: '麦思星球',
            },
            operationSuggestion: {
              title: '操作建议',
              content:
                '考验你的视觉记忆能力。认真观察并记忆格子矩阵中亮起的方块、成语、单词的位置，在矩阵旋转后，找到它们的对应位置。',
            },
            toolSuggestion: {
              title: '工具建议',
              content: '旋转宫殿',
            },
            arrangement: {
              title: '时间安排',
              weekDays: ['周四'],
            },
          },
        ]
      }

      selectFeaturedGames(allGames) {
        // 如果没有游戏数据，返回空数组
        if (!allGames || allGames.length === 0) {
          return []
        }

        // 如果有gameTitles配置，优先查找匹配的游戏
        if (this.gameTitles && this.gameTitles.trim() !== '') {
          console.log('使用gameTitles配置:', this.gameTitles)
          const gameTitlesList = this.gameTitles.split(',').map((title) => title.trim())
          const matchedGames = []

          // 查找匹配的游戏
          for (const title of gameTitlesList) {
            const matchedGame = allGames.find((game) => game.name === title)
            if (matchedGame && !matchedGames.includes(matchedGame)) {
              matchedGames.push(matchedGame)
            }
          }

          // 如果有匹配的游戏，返回匹配的游戏
          if (matchedGames.length > 0) {
            // 如果匹配的游戏不足3个，从剩余游戏中随机补充
            // if (matchedGames.length < 3) {
            //     const remainingGames = allGames.filter(game => !matchedGames.includes(game));
            //     const shuffledRemaining = this.shuffleArray(remainingGames);
            //     const neededCount = 3 - matchedGames.length;
            //     matchedGames.push(...shuffledRemaining.slice(0, neededCount));
            // }
            return matchedGames
          }
        }

        // 如果没有gameTitles配置但有todayRecommendedGames，使用今日推荐游戏
        if (this.todayRecommendedGames && Array.isArray(this.todayRecommendedGames) && this.todayRecommendedGames.length > 0) {
          console.log('使用todayRecommendedGames配置:', this.todayRecommendedGames)
          const matchedGames = []

          // 按照todayRecommendedGames的顺序查找匹配的游戏
          for (const gameName of this.todayRecommendedGames) {
            const matchedGame = allGames.find((game) => game.gameName === gameName)
            if (matchedGame && !matchedGames.includes(matchedGame)) {
              matchedGames.push(matchedGame)
            }
          }

          // 如果有匹配的游戏，直接返回（不随机）
          if (matchedGames.length > 0) {
            return matchedGames
          }
        }

        // 如果没有gameTitles配置和todayRecommendedGames配置，随机选择3个游戏
        const validGames = allGames.filter(game => game.tags && game.tags.length > 0 && game.tags[0] !== '');
        const shuffledGames = this.shuffleArray([...validGames])
        return shuffledGames.slice(0, 3)
      }

      shuffleArray(array) {
        const shuffled = [...array]
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1))
            ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
        }
        return shuffled
      }

      updateFeaturedSlider(games) {
        const slider = document.querySelector('.featured-slider')
        const dotsContainer = document.querySelector('.dots-indicator')
        const featuredSection = document.querySelector('.featured-section')

        // 清空现有内容
        slider.innerHTML = ''
        dotsContainer.innerHTML = ''

        // 判断是否使用三卡牌模式（可以根据游戏数量或其他条件来决定）
        const useThreeCardsMode = true // todo

        if (useThreeCardsMode) {
          // 三卡牌模式
          featuredSection.classList.add('three-cards-mode')

          const threeCardsContainer = document.createElement('div')
          threeCardsContainer.className = 'featured-three-cards active'

          // 创建日练习任务卡片
          if (this.dailyPracticeTasks.length > 0) {
            const dailyPracticeCard = document.createElement('div')
            dailyPracticeCard.className = 'daily-practice-card touchable'
            dailyPracticeCard.innerHTML = this.createDailyPracticeCardHTML()
            threeCardsContainer.appendChild(dailyPracticeCard)
          }

          // 取前三个游戏
          games.slice(0, 3).forEach((game, index) => {
            const showGameTags = game.tags && game.tags.length > 0 && game.tags[0] !== ''
            const cardItem = document.createElement('div')
            cardItem.className = 'featured-card-item touchable'
            cardItem.dataset.gameName = game.gameName
            cardItem.innerHTML = `
                <div class="card-content">
                    <div class="game-icon">${game.emoji}</div>
                    <div class="game-title">${game.name}</div>
                    <div class="game-tags">${showGameTags
                ? game.tags
                  .slice(0, 2)
                  .map((tag) => `<span class="tag">${tag}</span>`)
                  .join('')
                : `<div class="game-desc">${game.description}</div>`
              }
                    </div>
                </div>
              `
            threeCardsContainer.appendChild(cardItem)
          })

          slider.appendChild(threeCardsContainer)

          // 初始化滚动指示器
          this.initScrollIndicators(threeCardsContainer)
        } else {
          // 原有轮播模式
          featuredSection.classList.remove('three-cards-mode')

          games.forEach((game, index) => {
            const slideItem = document.createElement('div')
            slideItem.className = `featured-item ${index === 0 ? 'active' : ''}`
            slideItem.innerHTML = `
                <div class="featured-card touchable" data-game-name="${game.gameName}">
                    <div>
                        <div class="game-icon">${game.emoji}</div>
                        <div class="game-title">${game.name}</div>
                        <div class="game-desc">${game.description}</div>
                    </div>
                </div>
              `
            slider.appendChild(slideItem)

            const dot = document.createElement('span')
            dot.className = `dot ${index === 0 ? 'active' : ''}`
            dotsContainer.appendChild(dot)
          })

          document.querySelector('.featured-start-btn').style.display = games.length > 0 ? 'block' : 'none'
          this.initSlider()
        }
      }

      createDailyPracticeCardHTML() {
        // 获取当前日期
        const today = new Date()
        const month = today.getMonth() + 1
        const day = today.getDate()

        // 只显示第一条任务
        const firstTask = this.dailyPracticeTasks[0]
        return `
            <div class="daily-practice-header">
              <div class="daily-practice-title">${month}月${day}日 练习任务</div>
            </div>
            <div class="daily-practice-main-task">
              <div class="practice-task-tag-large">${firstTask.taskMeta.quotaName}</div>
              <div class="practice-task-title-large">${firstTask.taskMeta.taskName}</div>
              <div class="practice-task-quotas">${firstTask.taskMeta.quotas.join('、')}</div>
              <div class="practice-task-scene-container">
                <div class="practice-task-scene-label">任务场景</div>
                <div class="practice-task-scene">${firstTask.taskScene.content}</div>
              </div>
            </div>
          `
      }

      updateRecommendedGames(games) {
        const gameRow = document.querySelector('.game-row')
        gameRow.innerHTML = ''

        games.forEach((game, index) => {
          const showGameTags = game.tags && game.tags.length > 0 && game.tags[0] !== ''
          if (!showGameTags) return
          const gameCard = document.createElement('div')
          gameCard.className = `game-card touchable ${this.userIsVip ? 'locked' : ''}`
          gameCard.dataset.gameId = index + 1
          gameCard.dataset.gameName = game.gameName

          gameCard.innerHTML = `
                <div class="game-icon">${game.emoji}</div>
                <div class="game-title">${game.name}</div>
            `
          gameCard.innerHTML += showGameTags
            ? `
                    <div class="game-tags">
                        ${game.tags
              .slice(0, 2)
              .map((tag) => `<span class="tag">${tag}</span>`)
              .join('')}
                    </div>
                `
            : ''
          gameCard.innerHTML += this.userIsVip
            ? '<div class="lock-overlay"><div class="lock-icon">🔒</div></div>'
            : ''

          gameRow.appendChild(gameCard)
        })
      }

      updateGameCategories(categories) {
        const gamesContent = document.querySelector('.games-content')
        gamesContent.innerHTML = ''

        categories.forEach((category) => {
          if (category.games && category.games.length > 0) {
            const categorySection = document.createElement('div')
            categorySection.className = 'category-section'

            const categoryTitle = document.createElement('h2')
            categoryTitle.className = 'category-title'
            categoryTitle.textContent = category.name

            const categoryGrid = document.createElement('div')
            categoryGrid.className = 'category-grid'

            // 按照tags有无排序，有tags的排前面
            category.games.sort((a, b) => {
              const aHasTags = Array.isArray(a.tags) && a.tags.length > 0 && a.tags[0] !== ''
              const bHasTags = Array.isArray(b.tags) && b.tags.length > 0 && b.tags[0] !== ''
              return (bHasTags ? 1 : 0) - (aHasTags ? 1 : 0)
            })

            category.games.forEach((game, index) => {
              const showGameTags = game.tags && game.tags.length > 0 && game.tags[0] !== ''
              const gameCard = document.createElement('div')
              gameCard.className = `category-card touchable ${this.userIsVip ? 'locked' : ''}`
              gameCard.dataset.gameId = `${category.name}-${index}`
              gameCard.dataset.gameName = game.gameName

              gameCard.innerHTML = `
                    <div class="${showGameTags ? 'game-icon prod' : 'game-icon'}">${game.emoji}</div>
                    <div class="game-title">${game.name}</div>
                    ${this.userIsVip ? '<div class="lock-overlay"><div class="lock-icon">🔒</div></div>' : ''}
                `

              categoryGrid.appendChild(gameCard)
            })

            categorySection.appendChild(categoryTitle)
            categorySection.appendChild(categoryGrid)
            gamesContent.appendChild(categorySection)
          }
        })

        if (gamesContent.children.length === 0) {
          const emptyState = document.createElement('div')
          emptyState.className = 'empty-state'
          emptyState.innerHTML = `
                <div class="icon">🎮</div>
                <h3>暂无游戏</h3>
                <p>正在加载更多精彩游戏...</p>
            `
          gamesContent.appendChild(emptyState)
        }
      }

      parseGameConfig(configText) {
        const categories = []
        const lines = configText.trim().split('\n')
        let currentCategory = null
        let currentGame = null

        const directAccess = window.parent === window.top

        for (let line of lines) {
          line = line.trim()
          if (line.startsWith('## ')) {
            currentCategory = {
              name: line.substring(3),
              games: [],
            }
            categories.push(currentCategory)
          } else if (line.startsWith('### ')) {
            const gameTitle = line.substring(4)
            const emoji = gameTitle.split(' ')[0]
            const name = gameTitle.substring(emoji.length + 1)
            currentGame = {
              emoji: emoji,
              name: name,
              description: '',
              tags: [],
              url: '',
              isvip: false,
            }
            if (currentCategory) {
              currentCategory.games.push(currentGame)
            }
          } else if (line.startsWith('- desc:')) {
            if (currentGame) {
              currentGame.description = line.substring(7).trim()
            }
          } else if (line.startsWith('- tags:')) {
            if (currentGame) {
              const tagString = line.substring(7).trim()
              currentGame.tags = tagString.split(',').map((tag) => tag.trim())
            }
          } else if (line.startsWith('- url:')) {
            if (currentGame) {
              currentGame.url = line.substring(6).trim()
            }
          } else if (line.startsWith('- isvip:')) {
            if (currentGame) {
              currentGame.isvip = line.substring(8).trim() === 'true'
            }
          } else if (line.startsWith('- gameName:')) {
            if (currentGame) {
              const gameName = line.substring(11).trim()
              currentGame.gameName = gameName || ''
              currentGame.isUnavailable = !gameName
            }
          } else if (line.startsWith('- targetGameName:')) {
            if (currentGame) {
              const targetGameName = line.substring(17).trim()
              currentGame.targetGameName = targetGameName || ''
            }
          } else if (directAccess && line.startsWith('- gameConfigs:')) {
            if (currentGame) {
              const configString = line.substring(14).trim()
              currentGame.gameConfigs = configString.split(',').map((config) => ({
                label: config.trim(),
                value: config.trim(),
              }))
              currentGame.gameConfigs.unshift({ label: '默认', value: '' })
            }
          }
        }

        return categories
      }

      updateWelcomeMessage(username) {
        document.querySelector('.logo').textContent = username ? `欢迎回来，${username}` : ''
      }

      goToSlide(index) {
        const slides = document.querySelectorAll('.featured-item')
        const dots = document.querySelectorAll('.dot')

        slides.forEach((slide) => slide.classList.remove('active'))
        dots.forEach((dot) => dot.classList.remove('active'))

        if (slides[index]) {
          slides[index].classList.add('active')
          dots[index].classList.add('active')
          this.currentSlide = index
        }
      }

      nextSlide() {
        const slides = document.querySelectorAll('.featured-item')
        const nextIndex = (this.currentSlide + 1) % slides.length
        this.goToSlide(nextIndex)
      }

      prevSlide() {
        const slides = document.querySelectorAll('.featured-item')
        const prevIndex = (this.currentSlide - 1 + slides.length) % slides.length
        this.goToSlide(prevIndex)
      }

      startSlider() {
        this.stopSlider()
        this.slideInterval = setInterval(() => {
          this.nextSlide()
        }, 5000)
      }

      stopSlider() {
        if (this.slideInterval) {
          clearInterval(this.slideInterval)
          this.slideInterval = null
        }
      }

      initTabNavigation() {
        const menuItems = document.querySelectorAll('.menu-item')
        const tabContents = document.querySelectorAll('.tab-content')

        menuItems.forEach((item) => {
          item.addEventListener('click', (e) => {
            const targetTab = item.dataset.tab

            menuItems.forEach((menu) => menu.classList.remove('active'))
            tabContents.forEach((content) => content.classList.remove('active'))

            item.classList.add('active')
            document.getElementById(targetTab).classList.add('active')

            this.currentTab = targetTab

            if (targetTab === 'home') {
              this.startSlider()
            } else {
              this.stopSlider()
            }

            // 切换tab后更新当前tab的进度条
            this.updateAllGameProgressBars()

            if (targetTab === 'member') {
              const memberIframe = document.getElementById('memberIframe')
              if (memberIframe) {
                memberIframe.contentWindow.postMessage(
                  {
                    type: 'hideScrollbar',
                  },
                  '*'
                )
              }
            }            // 只在点击"我的"菜单时才加载profile iframe
            if (targetTab === 'profile' && this.maisiToken) {
              this.showAndLoadProfileIframe(this.maisiToken)
            }            // 只在点击"星球"菜单时才加载planet iframe
            if (targetTab === 'planet') {
              this.loadPlanetIframe()
            }

            // 只在点击"测评"菜单时才加载test iframe
            if (targetTab === 'test') {
              this.loadTestIframe()
            }

            // 只在点击"账号"菜单时才初始化账号页面
            if (targetTab === 'account') {
              this.initAccountPage()
            }
          })
        })
      }

      /**
       * 切换到首页
       */
      switchToHome() {
        const menuItems = document.querySelectorAll('.menu-item')
        const tabContents = document.querySelectorAll('.tab-content')
        const homeMenuItem = document.querySelector('.menu-item[data-tab="home"]')

        menuItems.forEach((menu) => menu.classList.remove('active'))
        tabContents.forEach((content) => content.classList.remove('active'))

        homeMenuItem.classList.add('active')
        document.getElementById('home').classList.add('active')

        this.currentTab = 'home'
        this.startSlider()

        // 切换到首页后更新进度条
        this.updateAllGameProgressBars()
      }

      /**
       * 获取菜单显示名称
       * @param {string} menuName - 菜单名称
       * @returns {string} 显示名称
       */      getMenuDisplayName(menuName) {
        const names = {
          games: '游戏',
          planet: '星球',
          test: '测评',
          member: '会员',
          settings: '设置',
          account: '账号',
        }
        return names[menuName] || menuName
      }

      initSlider() {
        const slides = document.querySelectorAll('.featured-item')
        const dots = document.querySelectorAll('.dot')

        if (slides.length === 0) return

        dots.forEach((dot, index) => {
          dot.addEventListener('click', () => {
            this.goToSlide(index)
          })
        })

        // 触摸滑动支持
        let startX = 0
        let startY = 0
        const slider = document.querySelector('.featured-slider')

        slider.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX
          startY = e.touches[0].clientY
        })

        slider.addEventListener('touchend', (e) => {
          const endX = e.changedTouches[0].clientX
          const endY = e.changedTouches[0].clientY
          const diffX = startX - endX
          const diffY = startY - endY

          if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
              this.nextSlide()
            } else {
              this.prevSlide()
            }
          }
        })

        this.startSlider()
      }

      initGameClickEvents() {
        document.addEventListener('click', (e) => {
          const gameCard = e.target.closest('[data-game-name]')

          if (e.target.classList.contains('featured-start-btn')) {
            const activeSlide = document.querySelector('.featured-item.active')
            if (activeSlide) {
              const featuredCard = activeSlide.querySelector('.featured-card')
              if (featuredCard) {
                const gameName = featuredCard.dataset.gameName
                this.openGame(gameName)
              }
            }
            return
          }

          // 处理三卡牌模式下的播放按钮点击
          if (e.target.classList.contains('play-button')) {
            e.stopPropagation()
            const cardItem = e.target.closest('.featured-card-item')
            if (cardItem) {
              const gameName = cardItem.dataset.gameName
              this.openGame(gameName)
            }
            return
          }

          // 处理三卡牌模式下的卡片点击
          if (e.target.closest('.featured-card-item')) {
            const cardItem = e.target.closest('.featured-card-item')
            const gameName = cardItem.dataset.gameName
            this.openGame(gameName)
            return
          }

          if (e.target.id === 'enterPlanetBtn') {
            this.enterMaisiPlanet()
            return
          }

          // 处理日练习任务卡片点击
          if (e.target.closest('.daily-practice-card')) {
            this.showDailyPracticeModal()
            return
          }

          if (!gameCard) return

          const isFeatureCard = gameCard.classList.contains('featured-card')
          if (isFeatureCard) return

          const isLocked = gameCard.classList.contains('locked')
          if (isLocked) {
            this.showMessage('任务未解锁。坚持每日任务打卡，解锁更多训练任务。')
            // this.showLockModal();
            return
          }

          const gameName = gameCard.dataset.gameName
          this.openGame(gameName)
        })
      }

      showLockModal() {
        // 创建遮罩层
        const overlay = document.createElement('div')
        overlay.className = 'lock-modal-overlay'

        // 创建锁定模态框
        const modal = document.createElement('div')
        modal.className = 'lock-modal'
        modal.innerHTML = `
            <div class="lock-modal-content">
                <button class="lock-modal-close">&times;</button>
                <div class="lock-modal-title">🔒 这个游戏被锁定了</div>
                <div class="lock-modal-description">
                    成为会员解锁全部思维训练游戏<br>
                    进入麦思星球3D世界免费体验更多互动游戏
                </div>
                <div class="lock-modal-buttons">
                    <button class="lock-modal-btn member">开通麦思星球会员</button>
                    <button class="lock-modal-btn planet">进入麦思星球</button>
                </div>
            </div>
          `

        // 添加到页面
        // const parentElement = document.querySelector('.app');
        // const parentElement = document.querySelector('.main-content');
        const parentElement = document.querySelector('.tab-content.active')
        parentElement.appendChild(overlay)
        parentElement.appendChild(modal)

        // 显示动画
        setTimeout(() => {
          overlay.classList.add('show')
          modal.classList.add('show')
        }, 10)

        // 绑定事件
        const closeModal = () => {
          overlay.classList.remove('show')
          modal.classList.remove('show')
          setTimeout(() => {
            parentElement.removeChild(overlay)
            parentElement.removeChild(modal)
          }, 300)
        }

        // 关闭按钮
        modal.querySelector('.lock-modal-close').addEventListener('click', closeModal)

        // 点击遮罩层关闭
        overlay.addEventListener('click', closeModal)

        // 开通会员按钮
        modal.querySelector('.lock-modal-btn.member').addEventListener('click', () => {
          this.openMembership()
          closeModal()
        })

        // 进入麦思星球按钮
        modal.querySelector('.lock-modal-btn.planet').addEventListener('click', () => {
          this.enterMaisiPlanet()
          closeModal()
        })
      }

      showDailyPracticeModal() {
        if (!this.dailyPracticeTasks || this.dailyPracticeTasks.length === 0) {
          this.showMessage('暂无练习任务数据')
          return
        }

        // 创建遮罩层
        const overlay = document.createElement('div')
        overlay.className = 'lock-modal-overlay'

        // 创建日练习任务模态框
        const modal = document.createElement('div')
        modal.className = 'daily-practice-modal'

        // 只显示第一条任务
        const firstTask = this.dailyPracticeTasks[0]
        const colors = ['#667eea', '#764ba2']

        modal.innerHTML = `
            <div class="daily-practice-modal-content">
              <button class="daily-practice-modal-close">&times;</button>
              <div class="practice-single-page" style="background: linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 50%, #f7f7f7 50%, #f7f7f7 100%);">
                <div class="practice-page-title">${firstTask.taskMeta.quotaName} - ${firstTask.taskMeta.taskName}</div>
                <div class="practice-page-divider"></div>
                <div class="practice-page-content">
                  <div class="practice-content-section">
                    <div class="practice-section-title">${firstTask.taskScene.title}</div>
                    <div class="practice-section-content">${firstTask.taskScene.content}</div>
                  </div>
                  <div class="practice-content-section">
                    <div class="practice-section-title">${firstTask.operationSuggestion.title}</div>
                    <div class="practice-section-content">${firstTask.operationSuggestion.content}</div>
                  </div>
                  <div class="practice-content-section">
                    <div class="practice-section-title">${firstTask.toolSuggestion.title}</div>
                    <div class="practice-section-content">${firstTask.toolSuggestion.content}</div>
                  </div>
                </div>
              </div>
            </div>
          `

        // 添加到页面
        const parentElement = document.querySelector('.tab-content.active')
        parentElement.appendChild(overlay)
        parentElement.appendChild(modal)

        // 显示动画
        setTimeout(() => {
          overlay.classList.add('show')
          modal.classList.add('show')
        }, 10)

        // 绑定事件
        const closeModal = () => {
          overlay.classList.remove('show')
          modal.classList.remove('show')
          setTimeout(() => {
            parentElement.removeChild(overlay)
            parentElement.removeChild(modal)
          }, 300)
        }

        // 关闭按钮
        modal.querySelector('.daily-practice-modal-close').addEventListener('click', closeModal)

        // 移除点击遮罩层关闭功能
        // overlay.addEventListener('click', closeModal)

        // 阻止模态框内容区域的点击事件冒泡
        modal.querySelector('.daily-practice-modal-content').addEventListener('click', (e) => {
          e.stopPropagation()
        })
      }

      /**
       * 初始化训练统计按钮
       */
      initTrainingStatsButton() {
        const trainingStatsBtn = document.getElementById('trainingStatsBtn')
        if (trainingStatsBtn) {
          trainingStatsBtn.addEventListener('click', () => {
            this.showTrainingStats()
          })
        }
      }

      /**
       * 显示训练统计页面
       */
      showTrainingStats() {
        // 隐藏所有tab内容
        const tabContents = document.querySelectorAll('.tab-content')
        tabContents.forEach(content => content.classList.remove('active'))

        // 移除所有菜单项的active状态
        const menuItems = document.querySelectorAll('.menu-item')
        menuItems.forEach(menu => menu.classList.remove('active'))

        // 显示训练统计tab
        const trainingStatsTab = document.getElementById('training-stats')
        trainingStatsTab.classList.add('active')

        // 加载iframe内容
        this.loadTrainingStatsIframe()

        this.currentTab = 'training-stats'
        this.stopSlider()
      }

      /**
       * 加载训练统计iframe
       */
      loadTrainingStatsIframe() {
        const trainingStatsIframe = document.getElementById('trainingStatsIframe')

        if (!trainingStatsIframe || trainingStatsIframe.src !== '') return

        // 构建iframe URL，可以根据需要传递必要的参数
        let iframeUrl = 'https://cross.keepwork.com/api/raw/maisi/maisi/webgames/data/ms_games_stats'
        // iframeUrl = 'http://127.0.0.1:5500/maisi/maisi/webgames/data/ms_games_stats.html'

        // 如果有token，添加到URL参数中
        if (this.maisiToken) {
          iframeUrl += `?maisiToken=${this.maisiToken}`
        }

        trainingStatsIframe.src = iframeUrl

        const containerWidth = 1160
        const containerHeight = 660

        let targetWidth = Math.max(containerWidth, 1280)
        let targetHeight = (targetWidth / containerWidth) * containerHeight
        if (targetHeight < 720) {
          targetWidth = targetWidth * (720 / targetHeight)
          targetHeight = 720
        }
        const scale = containerWidth / targetWidth

        trainingStatsIframe.style.transformOrigin = '0 0'
        trainingStatsIframe.style.transform = `scale(${scale})`
        trainingStatsIframe.style.width = `${targetWidth}px`
        trainingStatsIframe.style.height = `${targetHeight}px`
      }

      initScrollIndicators(container) {
        // 创建左右滚动指示器
        const leftIndicator = document.createElement('div')
        leftIndicator.className = 'scroll-indicator left'
        leftIndicator.innerHTML = `
            <svg viewBox="0 0 24 24">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
          `

        const rightIndicator = document.createElement('div')
        rightIndicator.className = 'scroll-indicator right'
        rightIndicator.innerHTML = `
            <svg viewBox="0 0 24 24">
              <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
          `

        // 添加到容器的父元素
        const parentElement = container.parentElement
        parentElement.style.position = 'relative'
        parentElement.appendChild(leftIndicator)
        parentElement.appendChild(rightIndicator)

        // 滚动事件处理
        const updateIndicators = () => {
          const { scrollLeft, scrollWidth, clientWidth } = container
          const maxScrollLeft = scrollWidth - clientWidth

          // 显示/隐藏左滚动指示器
          if (scrollLeft > 0) {
            leftIndicator.classList.add('visible')
          } else {
            leftIndicator.classList.remove('visible')
          }

          // 显示/隐藏右滚动指示器
          if (scrollLeft < maxScrollLeft - 1) {
            // -1 for rounding errors
            rightIndicator.classList.add('visible')
          } else {
            rightIndicator.classList.remove('visible')
          }
        }

        // 点击事件处理
        leftIndicator.addEventListener('click', () => {
          const cardWidth = container.children[0].offsetWidth + 20 // 卡片宽度 + gap
          container.scrollBy({
            left: -cardWidth,
            behavior: 'smooth',
          })
        })

        rightIndicator.addEventListener('click', () => {
          const cardWidth = container.children[0].offsetWidth + 20 // 卡片宽度 + gap
          container.scrollBy({
            left: cardWidth,
            behavior: 'smooth',
          })
        })

        // 监听滚动事件
        container.addEventListener('scroll', updateIndicators)

        // 初始检查
        setTimeout(updateIndicators, 100) // 延迟执行确保元素已渲染

        // 触摸滑动支持
        let startX = 0
        let isScrolling = false

        container.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX
          isScrolling = false
        })

        container.addEventListener('touchmove', (e) => {
          if (!isScrolling) {
            const diffX = startX - e.touches[0].clientX
            if (Math.abs(diffX) > 10) {
              isScrolling = true
            }
          }
        })

        container.addEventListener('touchend', (e) => {
          if (isScrolling) {
            const endX = e.changedTouches[0].clientX
            const diffX = startX - endX
            const cardWidth = container.children[0].offsetWidth + 20

            if (Math.abs(diffX) > 50) {
              if (diffX > 0) {
                // 向左滑动，显示右边内容
                container.scrollBy({
                  left: cardWidth,
                  behavior: 'smooth',
                })
              } else {
                // 向右滑动，显示左边内容
                container.scrollBy({
                  left: -cardWidth,
                  behavior: 'smooth',
                })
              }
            }
          }
          isScrolling = false
        })
      }

      initPracticeModalSwipe(modal) {
        const container = modal.querySelector('.practice-pages-container')
        const dots = modal.querySelectorAll('.practice-page-dot')
        const swipeArea = modal.querySelector('.practice-swipe-area')
        let currentPage = 0
        const totalPages = 3

        // 更新页面显示
        const updatePage = (pageIndex) => {
          const translateX = -pageIndex * 33.333
          container.style.transform = `translateX(${translateX}%)`

          // 更新指示器
          dots.forEach((dot, index) => {
            if (index === pageIndex) {
              dot.classList.add('active')
            } else {
              dot.classList.remove('active')
            }
          })

          currentPage = pageIndex
        }

        // 点击指示器切换页面
        dots.forEach((dot, index) => {
          dot.addEventListener('click', () => {
            updatePage(index)
          })
        })

        // 触摸滑动支持
        let startX = 0
        let startY = 0
        let isDragging = false

        swipeArea.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX
          startY = e.touches[0].clientY
          isDragging = true
        })

        swipeArea.addEventListener('touchmove', (e) => {
          if (!isDragging) return
          e.preventDefault()
        })

        swipeArea.addEventListener('touchend', (e) => {
          if (!isDragging) return
          isDragging = false

          const endX = e.changedTouches[0].clientX
          const endY = e.changedTouches[0].clientY
          const diffX = startX - endX
          const diffY = startY - endY

          // 只有水平滑动距离大于垂直滑动距离，且滑动距离超过50px时才切换页面
          if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0 && currentPage < totalPages - 1) {
              // 向左滑动，下一页
              updatePage(currentPage + 1)
            } else if (diffX < 0 && currentPage > 0) {
              // 向右滑动，上一页
              updatePage(currentPage - 1)
            }
          }
        })

        // 鼠标拖拽支持（桌面端）
        let isMouseDragging = false

        swipeArea.addEventListener('mousedown', (e) => {
          startX = e.clientX
          startY = e.clientY
          isMouseDragging = true
          e.preventDefault()
        })

        swipeArea.addEventListener('mousemove', (e) => {
          if (!isMouseDragging) return
          e.preventDefault()
        })

        swipeArea.addEventListener('mouseup', (e) => {
          if (!isMouseDragging) return
          isMouseDragging = false

          const endX = e.clientX
          const endY = e.clientY
          const diffX = startX - endX
          const diffY = startY - endY

          if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0 && currentPage < totalPages - 1) {
              updatePage(currentPage + 1)
            } else if (diffX < 0 && currentPage > 0) {
              updatePage(currentPage - 1)
            }
          }
        })

        // 鼠标离开区域时停止拖拽
        swipeArea.addEventListener('mouseleave', () => {
          isMouseDragging = false
        })
      }

      openMembership() {
        const memberMenuItem = document.querySelector('.menu-item[data-tab="member"]')
        const tabContents = document.querySelectorAll('.tab-content')
        const menuItems = document.querySelectorAll('.menu-item')

        menuItems.forEach((menu) => menu.classList.remove('active'))
        tabContents.forEach((content) => content.classList.remove('active'))

        memberMenuItem.classList.add('active')
        document.getElementById('member').classList.add('active')

        this.currentTab = 'member'
        this.stopSlider()

        const memberIframe = document.getElementById('memberIframe')
        if (memberIframe) {
          memberIframe.contentWindow.postMessage(
            {
              type: 'hideScrollbar',
            },
            '*'
          )
        }
      }

      enterMaisiPlanet() {
        window.parent.postMessage({
          type: 'launch3DEngine',
          target: 'external',
        }, '*')
        this.showMessage('跳转中...')
        let url = `https://api.keepwork.com/core/v0/repos/${encodeURIComponent(
          'maisi/maisi'
        )}/files/${encodeURIComponent('maisi/maisi/webgames/data/custom_loader1')}.md`
        const currentUrl = new URL(window.location.href)
        const currentUrlParams = new URLSearchParams(currentUrl.search)
        currentUrlParams.delete('gameName')
        for (const [key, value] of currentUrlParams) {
          url += (url.includes('?') ? '&' : '?') + `${key}=${encodeURIComponent(value)}`
        }
        url += (url.includes('?') ? '&' : '?') + 'autoStartParacraft=true'
        window.location.href = url
      }

      initTouchEvents() {
        // 增强触摸反馈
        document.addEventListener('touchstart', (e) => {
          const touchable = e.target.closest('.touchable')
          if (touchable) {
            touchable.style.transform = 'scale(0.95)'
            touchable.style.opacity = '0.8'
          }
        })

        document.addEventListener('touchend', (e) => {
          const touchable = e.target.closest('.touchable')
          if (touchable) {
            touchable.style.transform = ''
            touchable.style.opacity = ''
          }
        })

        document.addEventListener('touchcancel', (e) => {
          const touchable = e.target.closest('.touchable')
          if (touchable) {
            touchable.style.transform = ''
            touchable.style.opacity = ''
          }
        })
      }

      openGame(gameName) {
        if (!gameName || gameName.trim() === '') {
          this.showMessage('游戏内容解析失败，换个游戏试试吧！')
          return
        }
        this.showMessage('正在打开任务...')
        const parentUrl = new URL(this.parentLocationHref || window.parent.location.href)
        const urlParams = new URLSearchParams(parentUrl.search)

        // 查找游戏数据，如果存在originalGameName则添加到URL参数中
        const gameData = this.allGamesData.find(game => game.gameName === gameName)
        if (gameData && gameData.targetGameName) {
          urlParams.set('originalGameName', gameName)
          urlParams.set('gameName', gameData.targetGameName)
        } else {
          urlParams.set('gameName', gameName)
        }

        // 测试游戏内容
        // const testGames = [
        //   'visual_rotate_mem',
        //   'audio_mem',
        //   'guess_cubes',
        //   'sudoku',
        //   'count_shapes',
        //   'maze_words_visual',
        //   'snake_words',
        //   'stroop_color_word',
        //   'simon_says_compare',
        //   'spatial_words_memo',
        //   'dual_n_back',
        //   'find_numbers',
        //   'schulte_grid',
        //   'water_split',
        //   'attention_focus',
        //   'graph_analogy',
        //   'graphic_patterns',
        //   'graph_abstract_thinking',
        //   'thinking_understanding',
        // ]
        // if (testGames.includes(gameName)) {
        //   urlParams.set('projectPath', urlParams.get('projectPath') + '/dev')
        // }

        const targetUrl = `${parentUrl.origin}${parentUrl.pathname}?${urlParams.toString()}&startFrom=ms_games`
        setTimeout(() => {
          window.parent.postMessage(
            {
              type: 'navigate',
              navigateType: this.isDevMode ? undefined : 'openGame',
              url: targetUrl,
            },
            '*'
          )
        }, 500)
      }

      /**
       * 初始化设置页面
       */
      initSettings() {
        // 获取元素
        const decreaseBtn = document.getElementById('decreaseBtn')
        const increaseBtn = document.getElementById('increaseBtn')
        const ageValue = document.getElementById('ageValue')
        const applyBtn = document.getElementById('applyBtn')
        const clearBtn = document.getElementById('clearBtn')

        // 绑定事件
        decreaseBtn.addEventListener('click', () => {
          if (this.tempAge > 5) {
            this.tempAge--
            this.updateAgeDisplay()
          }
        })

        increaseBtn.addEventListener('click', () => {
          if (this.tempAge < 16) {
            this.tempAge++
            this.updateAgeDisplay()
          }
        })

        applyBtn.addEventListener('click', () => {
          this.applyAge(true)
        })

        clearBtn.addEventListener('click', () => {
          this.clearAge()
        })
      }

      /**
       * 更新年龄数值显示
       */
      updateAgeDisplay() {
        const ageValue = document.getElementById('ageValue')
        if (ageValue) {
          ageValue.textContent = this.tempAge
        }
      }

      /**
       * 更新年龄状态显示
       */
      updateAgeStatus() {
        const currentAge = document.getElementById('currentAge')
        const ageStatus = document.getElementById('ageStatus')

        if (currentAge && ageStatus) {
          if (this.ageApplied && this.currentAge !== null) {
            currentAge.textContent = this.currentAge
            ageStatus.textContent = '已应用'
            ageStatus.className = 'age-status applied'
          } else {
            currentAge.textContent = '无'
            ageStatus.textContent = '未应用'
            ageStatus.className = 'age-status unapplied'
          }
        }
      }

      /**
       * 应用年龄设置
       */
      applyAge(isActiveTrigger = true) {
        this.currentAge = this.tempAge
        this.ageApplied = true
        this.updateAgeStatus()
        if (isActiveTrigger) {
          this.showMessage(`已应用年龄设置：${this.currentAge}岁`)
          window.parent.postMessage(
            {
              type: 'setTestUserAge',
              age: this.currentAge,
            },
            '*'
          )
        }
      }

      /**
       * 清除年龄设置
       */
      clearAge() {
        this.currentAge = null
        this.ageApplied = false
        this.tempAge = 8
        this.updateAgeDisplay()
        this.updateAgeStatus()
        this.showMessage('已清除年龄设置')
        window.parent.postMessage(
          {
            type: 'setTestUserAge',
            age: null,
          },
          '*'
        )
      }

      /**
       * 初始化顶部菜单下拉功能
       */
      initTopMenuDropdown() {
        const menuButton = document.getElementById('menuButton')
        const dropdownMenu = document.getElementById('dropdownMenu')

        if (!menuButton || !dropdownMenu) return

        // 点击菜单按钮切换下拉菜单显示
        menuButton.addEventListener('click', (e) => {
          e.stopPropagation()
          dropdownMenu.classList.toggle('show')
        })

        // 点击下拉菜单项
        const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item')
        dropdownItems.forEach((item) => {
          item.addEventListener('click', (e) => {
            e.stopPropagation()
            const action = item.dataset.action
            this.handleTopMenuAction(action)
            dropdownMenu.classList.remove('show')
          })
        })

        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', () => {
          dropdownMenu.classList.remove('show')
        })

        // 阻止下拉菜单内部点击事件冒泡
        dropdownMenu.addEventListener('click', (e) => {
          e.stopPropagation()
        })
      }

        /**
         * 处理顶部菜单操作
         * @param {string} action - 操作类型
         */        handleTopMenuAction(action) {
        switch (action) {
          case 'profile':
            this.openProfile()
            break
          case 'member':
            this.openMembership()
            break
          case 'account':
            this.openAccount()
            break
          case 'settings':
            this.openSettings()
            break
          default:
            console.log('未知的菜单操作:', action)
        }
      }

      /**
       * 打开个人页面
       */
      openProfile() {
        const profileMenuItem = document.querySelector('.menu-item[data-tab="profile"]')
        const tabContents = document.querySelectorAll('.tab-content')
        const menuItems = document.querySelectorAll('.menu-item')

        menuItems.forEach((menu) => menu.classList.remove('active'))
        tabContents.forEach((content) => content.classList.remove('active'))

        profileMenuItem.classList.add('active')
        document.getElementById('profile').classList.add('active')

        this.currentTab = 'profile'
        this.stopSlider()

        // 加载profile iframe
        if (this.maisiToken) {
          this.showAndLoadProfileIframe(this.maisiToken)
        }
      }

      /**
       * 打开账号管理页面
       */
      openAccount() {
        const accountMenuItem = document.querySelector('.menu-item[data-tab="account"]')
        const tabContents = document.querySelectorAll('.tab-content')
        const menuItems = document.querySelectorAll('.menu-item')

        menuItems.forEach((menu) => menu.classList.remove('active'))
        tabContents.forEach((content) => content.classList.remove('active'))

        // 激活账号菜单项和对应的tab
        if (accountMenuItem) {
          accountMenuItem.classList.add('active')
        }
        document.getElementById('account').classList.add('active')

        this.currentTab = 'account'
        this.stopSlider()

        // 初始化账号页面
        this.initAccountPage()
      }

      /**
       * 初始化账号页面
       */
      async initAccountPage() {
        // 更新手机号显示
        const accountPhone = document.getElementById('accountPhone')
        try {
          // 直接使用类的userInfo属性
          if (this.userInfo && this.userInfo.phone) {
            // 脱敏显示手机号
            const phone = this.userInfo.phone
            const maskedPhone = phone.substring(0, 3) + '****' + phone.substring(7)
            accountPhone.textContent = maskedPhone
          } else {
            // 如果没有userInfo，尝试从localStorage获取
            let userInfo = null
            if (window.parentLocalStorage) {
              const userInfoStr = await window.parentLocalStorage.getItem('keepwork_user_info')
              if (userInfoStr) {
                userInfo = JSON.parse(userInfoStr)
              }
            }

            if (userInfo && userInfo.phone) {
              const phone = userInfo.phone
              const maskedPhone = phone.substring(0, 3) + '****' + phone.substring(7)
              accountPhone.textContent = maskedPhone
            } else {
              accountPhone.textContent = '未登录'
            }
          }
        } catch (error) {
          console.error('获取用户信息失败:', error)
          accountPhone.textContent = '获取失败'
        }

        // 只在第一次初始化时绑定事件
        this.initAccountEvents()
      }

      /**
       * 初始化账号页面事件（只执行一次）
       */
      initAccountEvents() {
        // 如果已经初始化过，直接返回
        if (this._accountEventsInitialized) {
          return
        }

        const logoutBtn = document.getElementById('logoutBtn')
        const deleteAccountBtn = document.getElementById('deleteAccountBtn')

        if (logoutBtn) {
          logoutBtn.addEventListener('click', this.handleLogout.bind(this))
        }

        if (deleteAccountBtn) {
          deleteAccountBtn.addEventListener('click', this.handleDeleteAccount.bind(this))
        }          // 标记已初始化
        this._accountEventsInitialized = true
      }

      /**
       * 打开设置页面
       */
      openSettings() {
        const settingsMenuItem = document.querySelector('.menu-item[data-tab="settings"]')
        const tabContents = document.querySelectorAll('.tab-content')
        const menuItems = document.querySelectorAll('.menu-item')

        menuItems.forEach((menu) => menu.classList.remove('active'))
        tabContents.forEach((content) => content.classList.remove('active'))

        // 激活设置菜单项和对应的tab
        if (settingsMenuItem) {
          settingsMenuItem.classList.add('active')
        }
        document.getElementById('settings').classList.add('active')

        this.currentTab = 'settings'
        this.stopSlider()
      }

      /**
       * 处理退出登录
       */
      handleLogout() {
        this.showConfirmModal({
          icon: '🚪',
          title: '确认退出登录？',
          desc: '退出后需要重新输入手机号和验证码登录',
          confirmText: '退出登录',
          confirmClass: 'logout',
          onConfirm: () => {
            this.performLogout()
          },
        })
      }

      /**
       * 处理注销账号
       */
      handleDeleteAccount() {
        this.showConfirmModal({
          icon: '⚠️',
          title: '确认注销账号？',
          desc: '注销后将永久删除您的账号及所有相关数据，此操作无法恢复！',
          confirmText: '确认注销',
          confirmClass: 'confirm',
          onConfirm: () => {
            this.performDeleteAccount()
          },
        })
      }

      /**
       * 执行退出登录
       */
      async performLogout() {
        try {
          this.showMessage('正在退出登录...')

          // 清除本地存储的token等信息
          if (window.parentLocalStorage) {
            await window.parentLocalStorage.removeItem('keepwork_access_token')
            await window.parentLocalStorage.removeItem('keepwork_token_expires')
            await window.parentLocalStorage.removeItem('mais_games_access_token')
            await window.parentLocalStorage.removeItem('mais_games_token_expires')
            await window.parentLocalStorage.removeItem('keepwork_user_info')
          }

          this.showMessage('已退出登录')

          // 延迟跳转到登录页面
          setTimeout(() => {
            const parentUrl = new URL(this.parentLocationHref || window.parent.location.href)
            const urlParams = new URLSearchParams()
            const originalParams = new URLSearchParams(parentUrl.search)
            urlParams.set('gameName', 'ms_games_login')
            const projectPath = originalParams.get('projectPath')
            if (projectPath) {
              urlParams.set('projectPath', projectPath)
            }
            const targetUrl = `${parentUrl.origin}${parentUrl.pathname}?${urlParams.toString()}`

            window.parent.postMessage(
              {
                type: 'navigate',
                url: targetUrl,
              },
              '*'
            )
          }, 1000)
        } catch (error) {
          console.error('退出登录失败:', error)
          this.showMessage('退出登录失败，请重试')
        }
      }

      /**
       * 执行注销账号
       */
      async performDeleteAccount() {
        try {
          this.showMessage('正在注销账号...')

          // await api.delete('/users/account')
          await new Promise((resolve) => setTimeout(resolve, 1000))

          // 清除本地存储的token等信息
          if (window.parentLocalStorage) {
            await window.parentLocalStorage.removeItem('keepwork_access_token')
            await window.parentLocalStorage.removeItem('keepwork_token_expires')
            await window.parentLocalStorage.removeItem('mais_games_access_token')
            await window.parentLocalStorage.removeItem('mais_games_token_expires')
            await window.parentLocalStorage.removeItem('keepwork_user_info')
          }

          this.showMessage('账号已注销')

          // 延迟跳转到登录页面
          setTimeout(() => {
            const parentUrl = new URL(this.parentLocationHref || window.parent.location.href)
            const urlParams = new URLSearchParams()
            const originalParams = new URLSearchParams(parentUrl.search)
            urlParams.set('gameName', 'ms_games_login')
            const projectPath = originalParams.get('projectPath')
            if (projectPath) {
              urlParams.set('projectPath', projectPath)
            }
            const targetUrl = `${parentUrl.origin}${parentUrl.pathname}?${urlParams.toString()}`

            window.parent.postMessage(
              {
                type: 'navigate',
                url: targetUrl,
              },
              '*'
            )
          }, 1000)
        } catch (error) {
          console.error('注销账号失败:', error)
          this.showMessage('注销账号失败，请重试')
        }
      }

      /**
       * 显示确认对话框
       */
      showConfirmModal({ icon, title, desc, confirmText, confirmClass, onConfirm }) {
        // 创建确认对话框
        const modal = document.createElement('div')
        modal.className = 'confirm-modal'
        modal.innerHTML = `
            <div class="confirm-modal-content">
              <div class="confirm-modal-icon">${icon}</div>
              <div class="confirm-modal-title">${title}</div>
              <div class="confirm-modal-desc">${desc}</div>
              <div class="confirm-modal-buttons">
                <button class="confirm-modal-btn cancel">取消</button>
                <button class="confirm-modal-btn ${confirmClass}">${confirmText}</button>
              </div>
            </div>
          `

        // 添加到页面
        document.body.appendChild(modal)

        // 显示动画
        setTimeout(() => {
          modal.classList.add('show')
        }, 10)

        // 绑定事件
        const closeModal = () => {
          modal.classList.remove('show')
          setTimeout(() => {
            if (modal.parentNode) {
              document.body.removeChild(modal)
            }
          }, 300)
        }

        // 取消按钮
        modal.querySelector('.cancel').addEventListener('click', closeModal)

        // 确认按钮
        modal.querySelector(`.${confirmClass}`).addEventListener('click', () => {
          closeModal()
          if (onConfirm) {
            onConfirm()
          }
        })

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal()
          }
        })
      }

      showMessage(message) {
        // 检查是否已有提示元素
        let existingToast = document.querySelector('.toast')

        if (existingToast) {
          // 更新现有元素的文本内容
          existingToast.textContent = message

          // 清除现有的定时器（如果有的话）
          if (existingToast.hideTimer) {
            clearTimeout(existingToast.hideTimer)
          }

          // 重新设置定时器
          existingToast.hideTimer = setTimeout(() => {
            if (existingToast && existingToast.parentNode) {
              document.body.removeChild(existingToast)
            }
          }, 2000)
        } else {
          // 创建新的提示元素
          const toast = document.createElement('div')
          toast.className = 'toast'
          toast.textContent = message

          document.body.appendChild(toast)

          // 设置定时器并保存引用
          toast.hideTimer = setTimeout(() => {
            if (toast && toast.parentNode) {
              document.body.removeChild(toast)
            }
          }, 2000)
        }
      }

      isInWechatMiniProgram() {
        const ua = navigator.userAgent.toLowerCase();
        return ua.includes('miniprogram') || ua.includes('micromessenger');
      }
    }

    // 初始化应用
    const gameApp = new GameApp()
    window.gameApp = gameApp

    // 开发模式下提供快捷测试方法
    if (gameApp.isDevMode) {
      console.log('🧪 开发模式已启用！')
      console.log('💡 可在控制台使用以下测试命令：')
      console.log('   gameApp.generateTestProgressBars() - 生成测试进度条数据')
      console.log('   gameApp.clearAllProgressBars() - 清除所有进度条')
      console.log('   toggleDevMode(false) - 关闭开发模式')
    }

    // 全局方法：方便外部控制devMode
    window.toggleDevMode = (enable) => {
      if (typeof enable !== 'boolean') {
        enable = !gameApp.isDevMode
      }
      gameApp.enableDevMode(enable)
      return gameApp.isDevMode
    }

    // 全局方法：快速开启devMode
    window.enableDevMode = () => window.toggleDevMode(true)

    // 全局方法：快速关闭devMode
    window.disableDevMode = () => window.toggleDevMode(false)

    document.addEventListener('WeixinJSBridgeReady', function () {
      WeixinJSBridge.invoke('setFontSizeCallback', { fontSize: 2 })
      WeixinJSBridge.on('menu:setfont', function () {
        WeixinJSBridge.invoke('setFontSizeCallback', { fontSize: 2 })
      })
    })

    // 页面可见性变化处理
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        gameApp.stopSlider()
      } else {
        if (gameApp.currentTab === 'home') {
          gameApp.startSlider()
        }
        // 页面重新变为可见时，刷新游戏完成信息
        setTimeout(() => {
          gameApp.getMiniGameFinishInfo()
        }, 500)
      }
    })

    window.parent.postMessage({ type: 'gameLoaded' }, '*')
    window.parent.postMessage({ type: 'getMiniGameProxyData' }, '*')
  </script>
</body>

</html>