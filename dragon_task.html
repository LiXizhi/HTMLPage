<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ±æŠ±é¾™æˆé•¿ä»»åŠ¡</title>
      <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            height: 100vh;
        }
        
        .dragon-container {
            width: 100%;
            max-width: 1280px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .task-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        }
        
        .dragon-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            animation: float 3s ease-in-out infinite; 
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* æŠ±æŠ±é¾™èº«ä½“ */
        .dragon-body {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }
        
        /* çœ¼ç› */
        .dragon-eye {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dragon-pupil {
            width: 40px;
            height: 40px;
            background: #1f2937;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dragon-highlight {
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            left: 8px;
        }
        
        /* çœ¨çœ¼åŠ¨ç”» */
        .dragon-eye.blink {
            animation: blink 0.15s ease-in-out;
        }
        
        @keyframes blink {
            0%, 100% { height: 60px; }
            50% { height: 6px; }
        }
        
        /* å˜´å·´ */
        .dragon-mouth {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 8px;
            border: 2px solid #6b7280;
            border-top: none;
            border-radius: 0 0 20px 20px;
            background: transparent;
        }
        
        /* è¯´è¯åŠ¨ç”» */
        .dragon-body.speaking {
            animation: speaking 0.6s ease-in-out infinite;
        }
        
        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* é¾™æµ®åŠ¨åŠ¨ç”» */
        .dragon-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .progress-ring {
            width: 80px;
            height: 80px;
            position: relative;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 6;
        }
        
        .progress-bg {
            stroke: #e5e7eb;
        }
        
        .progress-bar {
            stroke: #4ade80;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s ease;
        }
        
        .level-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #92400e;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        
        .task-button {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
        }
        
        .task-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
        }
        
        .task-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pending { background: #fbbf24; }
        .status-active { background: #10b981; animation: pulse 2s infinite; }
        .status-completed { background: #6366f1; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .main-task {
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        .reward-item {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .reward-item:hover {
            transform: scale(1.05);
        }
        
        /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
        .task-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .task-list-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .task-list-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .task-list-item.active {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            transform: translateX(8px);
        }
        
        .task-list-item.completed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .task-list-item.in-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffd700, #f59e0b);
        }
        
        .task-list-item.locked {
            cursor: pointer;
        }
        
        .task-list-item.locked:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .task-detail {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow-y: auto;
            height: 100%;
        }
        
        .task-detail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        }
        
        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 600px) {
            .dragon-container {
                padding: 20px;
            }
            
            .task-grid {
                gap: 20px;
            }
            
            .dragon-avatar {
                width: 100px;
                height: 100px;
                font-size: 50px;
            }
            
            header {
                padding: 16px 24px;
            }
            
            .task-card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="dragon-container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <header class="flex items-center justify-between p-4 text-white flex-shrink-0">
            <div class="flex items-center space-x-4">
                <div class="dragon-float">
                    <div class="dragon-body">
                        <div class="dragon-eye">
                            <div class="dragon-pupil">
                                <div class="dragon-highlight"></div>
                            </div>
                        </div>
                        <div class="dragon-mouth"></div>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl font-bold mb-2" id="playerName">æŠ±æŠ±é¾™çš„æˆé•¿ä¹‹æ—…</h1>
                    <div class="flex items-center space-x-4">
                        <div class="level-badge" id="levelBadge">Lv.3 æ™ºæ…§é¾™</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-300">ğŸ’</span>
                            <span class="font-semibold" id="experienceText">ç»éªŒå€¼: 1250/2000</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ€»è¿›åº¦ -->
            <div class="text-center">
                <div class="progress-ring mx-auto mb-2">
                    <svg width="80" height="80">
                        <circle class="progress-bg" cx="40" cy="40" r="36"></circle>
                        <circle class="progress-bar" cx="40" cy="40" r="36" 
                                stroke-dasharray="67.8 226.2" stroke-dashoffset="0" id="overallProgressBar"></circle>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-white" id="overallProgressText">30%</span>
                    </div>
                </div>
                <p class="text-sm opacity-90">æ€»ä½“è¿›åº¦</p>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="flex-1 px-4 pb-4 overflow-hidden min-h-0">
            <div class="grid grid-cols-4 gap-4 h-full max-h-full">
                
                <!-- å·¦ä¾§ä»»åŠ¡åˆ—è¡¨ -->
                <div class="task-list p-4">
                    <h2 class="text-lg font-bold text-white mb-4">ğŸ—‚ï¸ ä»»åŠ¡åˆ—è¡¨</h2>
                    <div id="taskListContainer">
                        <!-- ä»»åŠ¡é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å³ä¾§ä»»åŠ¡è¯¦æƒ… -->
                <div class="col-span-3 task-detail p-6" id="taskDetail">
                    <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // æ¸¸æˆé…ç½®å’Œç»Ÿè®¡
        let game_config = '';
        let gameStats = {
            score: 1250,
            difficulty: 2, // 1~3
            level: 3,
            tasksCompleted: 1,
            totalTasks: 3,
            cognitiveScore: 45,
            activeDays: 7
        };

        // å¯é…ç½®çš„æ¸¸æˆè®¾ç½® - æ‰€æœ‰ä»»åŠ¡ä¿¡æ¯éƒ½åœ¨è¿™é‡Œé…ç½®
        let gameConfig = {
            // ç©å®¶ä¿¡æ¯
            player: {
                name: "æŠ±æŠ±é¾™çš„æˆé•¿ä¹‹æ—…",
                level: 1,
                title: "é¾™è›‹",
                experience: 1250,
                maxExperience: 2000,
                overallProgress: 30 // æ€»ä½“è¿›åº¦ç™¾åˆ†æ¯”
            },
            
            // ä»»åŠ¡é…ç½®
            tasks: [
                {
                    id: 0,
                    title: 'ğŸ¥š å¤©èµ‹è§‰é†’',
                    subtitle: 'å­µåŒ–é¾™è›‹ï¼Œè§£é”æŠ±æŠ±é¾™',
                    status: 'in-progress', // completed, in-progress, locked, available
                    progress: 30, // è¿›åº¦ç™¾åˆ†æ¯”
                    progressText: 'è¿›åº¦: 2/7å¤©',
                    unlockConditions: [],
                    isUnlocked: true,
                    details: {
                        fullTitle: 'ğŸ¥š å¤©èµ‹è§‰é†’ï¼ˆå­µåŒ–é¾™è›‹ï¼‰',
                        description: 'ç¥ç§˜é¾™è›‹æ­£åœ¨ç­‰å¾…è§‰é†’',
                        steps: [
                            { name: 'ç¬¬1å¤©ï¼šæ³¨æ„åŠ›æµ‹è¯•', status: 'completed' },
                            { name: 'ç¬¬2å¤©ï¼šè®°å¿†åŠ›æµ‹è¯•', status: 'in-progress' },
                            { name: 'ç¬¬3-7å¤©ï¼šèƒ½åŠ›æµ‹è¯•', status: 'pending' }
                        ],
                        progressInfo: {
                            current: 2,
                            total: 7,
                            percentage: 30,
                            estimatedDays: 5
                        },
                        rewards: [
                            { icon: 'ğŸ‰', name: 'å¹¼å¹´æŠ±æŠ±é¾™' },
                            { icon: 'ğŸ®', name: 'äº’åŠ¨åŠŸèƒ½' },
                            { icon: 'â¤ï¸', name: 'é™ªä¼´æ¨¡å¼' }
                        ],
                        buttonText: 'ç»§ç»­æµ‹è¯•',
                        buttonEnabled: true
                    }
                },
                {
                    id: 1,
                    title: 'â¤ï¸ é£ç¿”çš„å¿ƒ',
                    subtitle: 'è§£é”é£è¡Œèƒ½åŠ›',
                    status: 'locked',
                    progress: 0,
                    progressText: 'ğŸ”’ éœ€è®¤çŸ¥èƒ½åŠ›60åˆ†',
                    unlockConditions: [
                        { type: 'cognitiveScore', value: 60, current: 45 },
                        { type: 'taskCompleted', taskId: 0 }
                    ],
                    isUnlocked: false,
                    details: {
                        fullTitle: 'ğŸš€ é£ç¿”çš„å¿ƒ',
                        description: 'æŠ±æŠ±é¾™æ¸´æœ›é£ç¿”ï¼å‰å¾€æ˜Ÿå…‰å¡”å¯»æ‰¾é£ç¿”çš„å¿ƒï¼',
                        unlockRequirements: {
                            cognitiveScore: { required: 60, current: 45 },
                            dragonEggHatching: { status: 'in-progress', progress: 30 }
                        },
                        preview: {
                            activities: [
                                { icon: 'ğŸƒ', name: 'è·‘é…·æŒ‘æˆ˜' },
                                { icon: 'ğŸ”§', name: 'æœºå…³è°œé¢˜' },
                                { icon: 'ğŸ’', name: 'æ”¶é›†å¿ƒä¹‹ç¢ç‰‡(7ä¸ª)' },
                                { icon: 'âœ¨', name: 'å¿ƒçµè¿æ¥ä»ªå¼' }
                            ]
                        },
                        rewards: [
                            { icon: 'ğŸš€', name: 'é£è¡Œèƒ½åŠ›' },
                            { icon: 'ğŸ²', name: 'æˆå¹´å½¢æ€' },
                            { icon: 'ğŸ†', name: 'å¾æœè€…ç§°å·' }
                        ],
                        buttonText: 'éœ€è¦è§£é”',
                        buttonEnabled: false
                    }
                },
                {
                    id: 2,
                    title: 'ğŸ”ï¸ é¾™ä¹‹è°·',
                    subtitle: 'è§£é”å®¶å›­ç³»ç»Ÿ',
                    status: 'locked',
                    progress: 0,
                    progressText: 'ğŸ”’ éœ€å®Œæˆé£ç¿”çš„å¿ƒ',
                    unlockConditions: [
                        { type: 'taskCompleted', taskId: 1 }
                    ],
                    isUnlocked: false,
                    details: {
                        fullTitle: 'ğŸ”ï¸ é¾™ä¹‹è°·',
                        description: 'å»ºé€ ä¸“å±å®¶å›­ï¼Œä½“éªŒç§èœå…»æˆç³»ç»Ÿ',
                        unlockRequirements: {
                            flyingHeartQuest: { status: 'not-completed' }
                        },
                        preview: {
                            homeTemplates: [
                                { icon: 'ğŸŒ…', name: 'æ™¨æ›¦èŠ±å›­' },
                                { icon: 'ğŸŒ™', name: 'æ˜Ÿå¤œæ£®æ—' },
                                { icon: 'â˜ï¸', name: 'äº‘æµ·å³¡è°·' },
                                { icon: 'ğŸŒ±', name: 'ç§èœå…»æˆç³»ç»Ÿ' }
                            ]
                        },
                        rewards: [
                            { icon: 'ğŸ ', name: 'ä¸“å±å®¶å›­' },
                            { icon: 'ğŸ¨', name: 'è£…é¥°åŠŸèƒ½' }
                        ],
                        buttonText: 'æš‚æœªè§£é”',
                        buttonEnabled: false
                    }
                }
            ]
        };

        // Host communication logic
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data; // this is markdown or text string
                    console.log('Game config updated:', game_config);
                    // Update config logic - could be used to modify game parameters
                    break;
                case 'getGameStats':
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: gameStats.score,
                            difficulty: gameStats.difficulty,
                            level: gameStats.level,
                            tasksCompleted: gameStats.tasksCompleted,
                            totalTasks: gameStats.totalTasks,
                            cognitiveScore: gameStats.cognitiveScore,
                            activeDays: gameStats.activeDays
                        }
                    }, '*');
                    break;
            }
        });

        // æ¸¸æˆé€»è¾‘
        class DragonTaskManager {
            constructor() {
                this.currentTask = 0;
                this.initializeUI();
                this.initializeEvents();
                this.updateProgress();
                this.startBlinking();
                this.loadTaskDetail(0); // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªä»»åŠ¡
                this.sendGameLoaded();
            }

            initializeUI() {
                // æ›´æ–°ç©å®¶ä¿¡æ¯
                this.updatePlayerInfo();
                
                // ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
                this.generateTaskList();
            }

            updatePlayerInfo() {
                const player = gameConfig.player;
                document.getElementById('playerName').textContent = player.name;
                document.getElementById('levelBadge').textContent = `Lv.${player.level} ${player.title}`;
                document.getElementById('experienceText').textContent = `ç»éªŒå€¼: ${player.experience}/${player.maxExperience}`;
                document.getElementById('overallProgressText').textContent = `${player.overallProgress}%`;
                
                // æ›´æ–°æ€»ä½“è¿›åº¦ç¯
                this.updateOverallProgress(player.overallProgress);
            }

            updateOverallProgress(progress) {
                const progressBar = document.getElementById('overallProgressBar');
                const circumference = 2 * Math.PI * 36;
                const offset = circumference * (1 - progress / 100);
                progressBar.style.strokeDasharray = `${circumference * progress / 100} ${circumference}`;
            }

            generateTaskList() {
                const container = document.getElementById('taskListContainer');
                container.innerHTML = '';

                gameConfig.tasks.forEach((task, index) => {
                    const taskElement = this.createTaskListItem(task, index);
                    container.appendChild(taskElement);
                });
            }

            createTaskListItem(task, index) {
                const div = document.createElement('div');
                div.className = `task-list-item ${this.getTaskStatusClass(task.status)}${index === 0 ? ' active' : ''}`;
                div.setAttribute('data-task', index);

                const statusIndicatorClass = this.getStatusIndicatorClass(task.status);
                const statusText = this.getStatusText(task.status);
                const progressBarClass = this.getProgressBarClass(task.status, index);
                const textClass = this.getTextClass(task.status);

                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold ${textClass}">${task.title}</h3>
                        <div class="flex items-center">
                            <div class="status-indicator ${statusIndicatorClass}"></div>
                            <span class="text-xs ${textClass.replace('text-gray-800', 'text-gray-600')}">${statusText}</span>
                        </div>
                    </div>
                    <p class="text-sm ${textClass.replace('text-gray-800', 'text-gray-600')} mb-2">${task.subtitle}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${progressBarClass} h-2 rounded-full" style="width: ${task.progress}%"></div>
                    </div>
                    <div class="text-xs ${textClass.replace('text-gray-800', 'text-gray-500')} mt-1">${task.progressText}</div>
                `;

                return div;
            }

            getTaskStatusClass(status) {
                switch(status) {
                    case 'completed': return 'completed';
                    case 'in-progress': return 'in-progress';
                    case 'locked': return 'locked';
                    default: return 'locked';
                }
            }

            getStatusIndicatorClass(status) {
                switch(status) {
                    case 'completed': return 'status-completed';
                    case 'in-progress': return 'status-active';
                    case 'locked': return 'status-pending';
                    default: return 'status-pending';
                }
            }

            getStatusText(status) {
                switch(status) {
                    case 'completed': return 'å·²å®Œæˆ';
                    case 'in-progress': return 'è¿›è¡Œä¸­';
                    case 'locked': return 'å¾…å¼€å¯';
                    default: return 'å¾…å¼€å¯';
                }
            }

            getProgressBarClass(status, index) {
                if (status === 'locked') return 'bg-gray-300';
                
                switch(index) {
                    case 0: return 'bg-gradient-to-r from-purple-500 to-pink-500';
                    case 1: return 'bg-gradient-to-r from-blue-500 to-purple-500';
                    case 2: return 'bg-yellow-400';
                    default: return 'bg-green-400';
                }
            }

            getTextClass(status) {
                return status === 'locked' ? 'text-gray-500' : 'text-gray-800';
            }

            generateTaskDetail(taskIndex) {
                const task = gameConfig.tasks[taskIndex];
                if (!task) return '';

                const details = task.details;
                const statusIndicator = this.getStatusIndicatorClass(task.status);
                const statusText = this.getStatusText(task.status);

                // æ ¹æ®ä»»åŠ¡ç±»å‹ç”Ÿæˆä¸åŒçš„è¯¦æƒ…å†…å®¹
                switch(taskIndex) {
                    case 0: return this.generateDragonEggDetail(task, details, statusIndicator, statusText);
                    case 1: return this.generateFlyingHeartDetail(task, details, statusIndicator, statusText);
                    case 2: return this.generateDragonValleyDetail(task, details, statusIndicator, statusText);
                    default: return this.generateGenericDetail(task, details, statusIndicator, statusText);
                }
            }

            generateDragonEggDetail(task, details, statusIndicator, statusText) {
                const stepsHtml = details.steps.map(step => {
                    const stepClass = step.status === 'completed' ? 'bg-white' : 
                                     step.status === 'in-progress' ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50';
                    const stepIcon = step.status === 'completed' ? 'âœ…' : 
                                    step.status === 'in-progress' ? 'ğŸ”„' : 'â³';
                    const stepStatusClass = step.status === 'completed' ? 'text-green-600' : 
                                           step.status === 'in-progress' ? 'text-blue-600' : 'text-gray-500';
                    const stepStatusText = step.status === 'completed' ? 'å·²å®Œæˆ' : 
                                          step.status === 'in-progress' ? 'è¿›è¡Œä¸­' : 'å¾…å¼€å¯';
                    
                    return `
                        <div class="flex items-center justify-between p-3 ${stepClass} rounded-lg">
                            <span class="font-medium">${stepIcon} ${step.name}</span>
                            <span class="text-sm ${stepStatusClass} font-semibold">${stepStatusText}</span>
                        </div>
                    `;
                }).join('');

                const rewardsHtml = details.rewards.map(reward => `
                    <div class="reward-item">
                        <div class="text-2xl mb-2">${reward.icon}</div>
                        <div class="text-sm font-medium">${reward.name}</div>
                    </div>
                `).join('');

                return `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${details.fullTitle}</h2>
                        <div class="flex items-center">
                            <div class="status-indicator ${statusIndicator}"></div>
                            <span class="text-sm text-gray-600">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-purple-50 rounded-lg p-6">
                            <h3 class="font-semibold text-purple-700 mb-4 text-lg">ğŸ”® è§‰é†’ç¥æ®¿</h3>
                            <div class="text-center mb-4">
                                <div class="text-8xl mb-3">ğŸ¥š</div>
                                <p class="text-purple-600">${details.description}</p>
                            </div>
                            <div class="space-y-3">
                                ${stepsHtml}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-semibold text-gray-700">å­µåŒ–è¿›åº¦</span>
                                <span class="text-sm text-gray-600">${details.progressInfo.percentage}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full" style="width: ${details.progressInfo.percentage}%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600 mt-2">
                                <span>è¿›åº¦: ${details.progressInfo.current}/${details.progressInfo.total}å¤©</span>
                                <span>é¢„è®¡${details.progressInfo.estimatedDays}å¤©å®Œæˆ</span>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-800 mb-3">ğŸ å­µåŒ–å¥–åŠ±</h4>
                            <div class="grid grid-cols-3 gap-3">
                                ${rewardsHtml}
                            </div>
                        </div>
                        
                        <button class="task-button w-full text-lg py-4" ${!details.buttonEnabled ? 'disabled' : ''}>${details.buttonText}</button>
                    </div>
                `;
            }

            generateFlyingHeartDetail(task, details, statusIndicator, statusText) {
                const unlockReqs = details.unlockRequirements;
                const cognitiveProgress = (unlockReqs.cognitiveScore.current / unlockReqs.cognitiveScore.required) * 100;
                
                const activitiesHtml = details.preview.activities.map(activity => `
                    <div class="flex items-center p-3 bg-white rounded-lg">
                        <span class="text-2xl mr-3">${activity.icon}</span>
                        <span class="font-medium text-gray-600">${activity.name}</span>
                    </div>
                `).join('');

                const rewardsHtml = details.rewards.map(reward => `
                    <div class="reward-item">
                        <div class="text-2xl mb-2">${reward.icon}</div>
                        <div class="text-sm font-medium">${reward.name}</div>
                    </div>
                `).join('');

                return `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${details.fullTitle}</h2>
                        <div class="flex items-center">
                            <div class="status-indicator ${statusIndicator}"></div>
                            <span class="text-sm text-gray-600">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="font-semibold text-blue-800 mb-3 text-lg">ğŸ”’ è§£é”æ¡ä»¶</h3>
                            <p class="text-blue-700 mb-4">è®¤çŸ¥èƒ½åŠ›è¾¾åˆ°${unlockReqs.cognitiveScore.required}åˆ†ä¸”å®Œæˆé¾™è›‹å­µåŒ–</p>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">è®¤çŸ¥èƒ½åŠ›:</span>
                                    <span class="text-sm font-semibold">${unlockReqs.cognitiveScore.current}/${unlockReqs.cognitiveScore.required}åˆ†</span>
                                </div>
                                <div class="w-full bg-blue-200 rounded-full h-3">
                                    <div class="bg-blue-500 h-3 rounded-full" style="width: ${cognitiveProgress}%"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">é¾™è›‹å­µåŒ–:</span>
                                    <span class="text-sm font-semibold text-orange-600">${unlockReqs.dragonEggHatching.progress}% ${unlockReqs.dragonEggHatching.status === 'in-progress' ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6 opacity-75">
                            <h3 class="font-semibold text-gray-700 mb-4 text-lg">ğŸ—¼ æ˜Ÿå…‰å¡”æ¢é™©</h3>
                            <div class="grid grid-cols-2 gap-4">
                                ${activitiesHtml}
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-3">ğŸ é£ç¿”å¥–åŠ±</h4>
                            <div class="grid grid-cols-3 gap-3">
                                ${rewardsHtml}
                            </div>
                        </div>
                        
                        <button class="task-button w-full text-lg py-4" ${!details.buttonEnabled ? 'disabled' : ''}>${details.buttonText}</button>
                    </div>
                `;
            }

            generateDragonValleyDetail(task, details, statusIndicator, statusText) {
                const templatesHtml = details.preview.homeTemplates.map(template => `
                    <div class="flex items-center p-3 bg-white rounded-lg">
                        <span class="text-2xl mr-3">${template.icon}</span>
                        <span class="font-medium text-gray-600">${template.name}</span>
                    </div>
                `).join('');

                const rewardsHtml = details.rewards.map(reward => `
                    <div class="reward-item bg-gradient-to-r from-green-100 to-emerald-100">
                        <div class="text-2xl mb-2">${reward.icon}</div>
                        <div class="text-sm font-medium">${reward.name}</div>
                    </div>
                `).join('');

                return `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${details.fullTitle}</h2>
                        <div class="flex items-center">
                            <div class="status-indicator ${statusIndicator}"></div>
                            <span class="text-sm text-gray-600">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h3 class="font-semibold text-green-800 mb-3 text-lg">ğŸ”’ è§£é”æ¡ä»¶</h3>
                            <p class="text-green-700 mb-4">å®Œæˆ"é£ç¿”çš„å¿ƒ"ä»»åŠ¡</p>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">å‰ç½®ä»»åŠ¡:</span>
                                    <span class="text-sm font-semibold text-red-600">${details.unlockRequirements.flyingHeartQuest.status === 'not-completed' ? 'æœªå®Œæˆ' : 'å·²å®Œæˆ'}</span>
                                </div>
                                <div class="w-full bg-green-200 rounded-full h-3">
                                    <div class="bg-green-500 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6 opacity-75">
                            <h3 class="font-semibold text-gray-700 mb-4 text-lg">ğŸï¸ å®¶å›­æ¨¡æ¿é€‰æ‹©</h3>
                            <div class="grid grid-cols-2 gap-4">
                                ${templatesHtml}
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
                            <h4 class="font-semibold text-green-800 mb-3">ğŸŒŸ å®¶å›­å¥–åŠ±</h4>
                            <div class="grid grid-cols-2 gap-3">
                                ${rewardsHtml}
                            </div>
                        </div>
                        
                        <button class="task-button w-full text-lg py-4" ${!details.buttonEnabled ? 'disabled' : ''}>${details.buttonText}</button>
                    </div>
                `;
            }

            generateGenericDetail(task, details, statusIndicator, statusText) {
                return `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${details.fullTitle}</h2>
                        <div class="flex items-center">
                            <div class="status-indicator ${statusIndicator}"></div>
                            <span class="text-sm text-gray-600">${statusText}</span>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <p class="text-gray-700">${details.description}</p>
                        <button class="task-button w-full text-lg py-4" ${!details.buttonEnabled ? 'disabled' : ''}>${details.buttonText}</button>
                    </div>
                `;
            }

            loadTaskDetail(taskIndex) {
                const taskDetail = document.getElementById('taskDetail');
                const content = this.generateTaskDetail(taskIndex);
                
                if (content) {
                    taskDetail.innerHTML = content;
                    
                    // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                    const button = taskDetail.querySelector('.task-button');
                    if (button && !button.disabled) {
                        button.addEventListener('click', () => this.handleTaskAction(taskIndex));
                    }
                }
            }

            updateGameConfig(newConfig) {
                // å…è®¸å¤–éƒ¨æ›´æ–°é…ç½®
                Object.assign(gameConfig, newConfig);
                this.initializeUI();
                this.loadTaskDetail(this.currentTask);
            }

            sendGameLoaded() {
                // Send game loaded event to host
                window.parent.postMessage({ type: 'gameLoaded' }, '*');
            }

            sendGameStarted() {
                // Send game started event to host
                window.parent.postMessage({ type: 'gameStarted' }, '*');
            }

            sendGameFinished(results = {}) {
                // Send game finished event to host with results
                const finishData = {
                    score: gameStats.score,
                    level: gameStats.level,
                    tasksCompleted: gameStats.tasksCompleted,
                    cognitiveScore: gameStats.cognitiveScore,
                    ...results
                };
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: finishData 
                }, '*');
            }

            updateGameStats(updates) {
                // Update game statistics
                Object.assign(gameStats, updates);
            }
            
            initializeEvents() {
                // ä»»åŠ¡åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.task-list-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        // Allow all tasks to be clicked and shown, even locked ones
                        this.selectTask(index);
                    });
                });
            }
            
            selectTask(taskIndex) {
                // æ›´æ–°ä»»åŠ¡åˆ—è¡¨é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.task-list-item').forEach((item, index) => {
                    if (index === taskIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // åŠ è½½ä»»åŠ¡è¯¦æƒ…
                this.currentTask = taskIndex;
                this.loadTaskDetail(taskIndex);
            }
            
            handleTaskAction(taskIndex) {
                const task = gameConfig.tasks[taskIndex];
                if (!task) return;

                switch(taskIndex) {
                    case 0: // å¤©èµ‹è§‰é†’ï¼ˆå­µåŒ–é¾™è›‹ï¼‰
                        this.startDragonEggHatching();
                        break;
                    case 1: // é£ç¿”çš„å¿ƒ
                        if (this.checkUnlockConditions(task.unlockConditions)) {
                            this.startFlyingHeartQuest();
                        } else {
                            this.showUnlockMessage('éœ€è¦è®¤çŸ¥èƒ½åŠ›è¾¾åˆ°60åˆ†æ‰èƒ½è§£é”æ­¤ä»»åŠ¡ï¼');
                        }
                        break;
                    case 2: // é¾™ä¹‹è°·
                        if (this.checkUnlockConditions(task.unlockConditions)) {
                            this.startDragonValleyQuest();
                        } else {
                            this.showDragonValleyLocked();
                        }
                        break;
                }
            }

            checkUnlockConditions(conditions) {
                return conditions.every(condition => {
                    switch(condition.type) {
                        case 'cognitiveScore':
                            return condition.current >= condition.value;
                        case 'taskCompleted':
                            const task = gameConfig.tasks[condition.taskId];
                            return task && task.status === 'completed';
                        default:
                            return false;
                    }
                });
            }
            
            startDragonEggHatching() {
                console.log('å¼€å§‹å¤©èµ‹è§‰é†’ä»»åŠ¡');
                this.sendGameStarted();
                this.startSpeaking();
                alert('ğŸ¥š è¿›å…¥è§‰é†’ç¥æ®¿ï¼Œå¼€å§‹ä»Šæ—¥çš„èƒ½åŠ›æµ‹è¯•ï¼');
                this.stopSpeaking();
                
                // Update stats when task is started
                this.updateGameStats({ 
                    score: gameStats.score + 50,
                    cognitiveScore: gameStats.cognitiveScore + 5 
                });
                
                // Simulate task completion after some time
                setTimeout(() => {
                    this.updateGameStats({ 
                        tasksCompleted: gameStats.tasksCompleted + 1 
                    });
                    this.sendGameFinished({ taskCompleted: 'dragonEggHatching' });
                }, 3000);
                
                // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°å…·ä½“çš„æµ‹è¯•é¡µé¢
            }
            
            startFlyingHeartQuest() {
                console.log('å¼€å§‹é£ç¿”çš„å¿ƒä»»åŠ¡');
                this.sendGameStarted();
                this.startSpeaking();
                alert('ğŸš€ æŠ±æŠ±é¾™æ¸´æœ›é£ç¿”ï¼å‰å¾€æ˜Ÿå…‰å¡”å¯»æ‰¾é£ç¿”çš„å¿ƒï¼');
                this.stopSpeaking();
                
                // Update stats when quest is started
                this.updateGameStats({ 
                    difficulty: 3, // Increase difficulty for this quest
                    score: gameStats.score + 100 
                });
                
                // Simulate quest completion
                setTimeout(() => {
                    this.updateGameStats({ 
                        level: gameStats.level + 1,
                        tasksCompleted: gameStats.tasksCompleted + 1 
                    });
                    this.sendGameFinished({ questCompleted: 'flyingHeart' });
                }, 5000);
            }

            startDragonValleyQuest() {
                console.log('å¼€å§‹é¾™ä¹‹è°·ä»»åŠ¡');
                this.sendGameStarted();
                this.startSpeaking();
                alert('ğŸ”ï¸ æ¬¢è¿æ¥åˆ°é¾™ä¹‹è°·ï¼å¼€å§‹å»ºé€ ä½ çš„ä¸“å±å®¶å›­ï¼');
                this.stopSpeaking();
                
                // Update stats when quest is started
                this.updateGameStats({ 
                    score: gameStats.score + 150 
                });
                
                // Simulate quest completion
                setTimeout(() => {
                    this.updateGameStats({ 
                        level: gameStats.level + 1,
                        tasksCompleted: gameStats.tasksCompleted + 1 
                    });
                    this.sendGameFinished({ questCompleted: 'dragonValley' });
                }, 4000);
            }
            
            checkCognitiveScore(requiredScore) {
                // æ¨¡æ‹Ÿæ£€æŸ¥è®¤çŸ¥èƒ½åŠ›åˆ†æ•°
                const currentScore = 45; // å½“å‰åˆ†æ•°
                return currentScore >= requiredScore;
            }
            
            showUnlockMessage(message) {
                alert(`ğŸ”’ ${message}`);
            }
            
            showDragonValleyLocked() {
                alert('ğŸ”ï¸ é¾™ä¹‹è°·éœ€è¦å®Œæˆé£ç¿”çš„å¿ƒä»»åŠ¡æ‰èƒ½è§£é”ï¼');
            }
            
            updateProgress() {
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                const progressRing = document.querySelector('.progress-bar');
                const totalProgress = gameConfig.player.overallProgress;
                const circumference = 2 * Math.PI * 36; // åœ†å‘¨é•¿
                const offset = circumference * (1 - totalProgress / 100);
                
                if (progressRing) {
                    progressRing.style.strokeDasharray = `${circumference * totalProgress / 100} ${circumference}`;
                }
            }
            
            // æŠ±æŠ±é¾™åŠ¨ç”»
            blinkEye() {
                const dragonEye = document.querySelector('.dragon-eye');
                if (dragonEye) {
                    dragonEye.classList.add('blink');
                    setTimeout(() => {
                        dragonEye.classList.remove('blink');
                    }, 150);
                }
            }

            startBlinking() {
                setInterval(() => {
                    if (Math.random() < 0.3) { // 30% chance to blink
                        this.blinkEye();
                    }
                }, 2000);
            }

            startSpeaking() {
                const dragonBody = document.querySelector('.dragon-body');
                if (dragonBody) {
                    dragonBody.classList.add('speaking');
                }
            }

            stopSpeaking() {
                const dragonBody = document.querySelector('.dragon-body');
                if (dragonBody) {
                    dragonBody.classList.remove('speaking');
                }
            }


            sendGameLoaded() {
                // Send game loaded event to host
                window.parent.postMessage({ type: 'gameLoaded' }, '*');
            }

            sendGameStarted() {
                // Send game started event to host
                window.parent.postMessage({ type: 'gameStarted' }, '*');
            }

            sendGameFinished(results = {}) {
                // Send game finished event to host with results
                const finishData = {
                    score: gameStats.score,
                    level: gameStats.level,
                    tasksCompleted: gameStats.tasksCompleted,
                    cognitiveScore: gameStats.cognitiveScore,
                    ...results
                };
                window.parent.postMessage({ 
                    type: 'gameFinished', 
                    data: finishData 
                }, '*');
            }

            updateGameStats(updates) {
                // Update game statistics
                Object.assign(gameStats, updates);
            }
            
            initializeEvents() {
                // ä»»åŠ¡åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.task-list-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        // Allow all tasks to be clicked and shown, even locked ones
                        this.selectTask(index);
                    });
                });
            }
            
            selectTask(taskIndex) {
                // æ›´æ–°ä»»åŠ¡åˆ—è¡¨é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.task-list-item').forEach((item, index) => {
                    if (index === taskIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // åŠ è½½ä»»åŠ¡è¯¦æƒ…
                this.currentTask = taskIndex;
                this.loadTaskDetail(taskIndex);
            }
            
            handleTaskAction(taskIndex) {
                switch(taskIndex) {
                    case 0: // å¤©èµ‹è§‰é†’ï¼ˆå­µåŒ–é¾™è›‹ï¼‰
                        this.startDragonEggHatching();
                        break;
                    case 1: // é£ç¿”çš„å¿ƒ
                        if (this.checkCognitiveScore(60)) {
                            this.startFlyingHeartQuest();
                        } else {
                            this.showUnlockMessage('éœ€è¦è®¤çŸ¥èƒ½åŠ›è¾¾åˆ°60åˆ†æ‰èƒ½è§£é”æ­¤ä»»åŠ¡ï¼');
                        }
                        break;
                    case 2: // é¾™ä¹‹è°·
                        this.showDragonValleyLocked();
                        break;
                }
            }
            
            startDragonEggHatching() {
                console.log('å¼€å§‹å¤©èµ‹è§‰é†’ä»»åŠ¡');
                this.sendGameStarted();
                this.startSpeaking();
                alert('ğŸ¥š è¿›å…¥è§‰é†’ç¥æ®¿ï¼Œå¼€å§‹ä»Šæ—¥çš„èƒ½åŠ›æµ‹è¯•ï¼');
                this.stopSpeaking();
                
                // Update stats when task is started
                this.updateGameStats({ 
                    score: gameStats.score + 50,
                    cognitiveScore: gameStats.cognitiveScore + 5 
                });
                
                // Simulate task completion after some time
                setTimeout(() => {
                    this.updateGameStats({ 
                        tasksCompleted: gameStats.tasksCompleted + 1 
                    });
                    this.sendGameFinished({ taskCompleted: 'dragonEggHatching' });
                }, 3000);
                
                // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°å…·ä½“çš„æµ‹è¯•é¡µé¢
            }
            
            startFlyingHeartQuest() {
                console.log('å¼€å§‹é£ç¿”çš„å¿ƒä»»åŠ¡');
                this.sendGameStarted();
                this.startSpeaking();
                alert('ğŸš€ æŠ±æŠ±é¾™æ¸´æœ›é£ç¿”ï¼å‰å¾€æ˜Ÿå…‰å¡”å¯»æ‰¾é£ç¿”çš„å¿ƒï¼');
                this.stopSpeaking();
                
                // Update stats when quest is started
                this.updateGameStats({ 
                    difficulty: 3, // Increase difficulty for this quest
                    score: gameStats.score + 100 
                });
                
                // Simulate quest completion
                setTimeout(() => {
                    this.updateGameStats({ 
                        level: gameStats.level + 1,
                        tasksCompleted: gameStats.tasksCompleted + 1 
                    });
                    this.sendGameFinished({ questCompleted: 'flyingHeart' });
                }, 5000);
            }
            
            checkCognitiveScore(requiredScore) {
                // æ¨¡æ‹Ÿæ£€æŸ¥è®¤çŸ¥èƒ½åŠ›åˆ†æ•°
                const currentScore = 45; // å½“å‰åˆ†æ•°
                return currentScore >= requiredScore;
            }
            
            showUnlockMessage(message) {
                alert(`ğŸ”’ ${message}`);
            }
            
            showDragonValleyLocked() {
                alert('ğŸ”ï¸ é¾™ä¹‹è°·éœ€è¦å®Œæˆé£ç¿”çš„å¿ƒä»»åŠ¡æ‰èƒ½è§£é”ï¼');
            }
            
            updateProgress() {
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                const progressRing = document.querySelector('.progress-bar');
                const totalProgress = 30; // æ€»è¿›åº¦30%
                const circumference = 2 * Math.PI * 36; // åœ†å‘¨é•¿
                const offset = circumference * (1 - totalProgress / 100);
                
                if (progressRing) {
                    progressRing.style.strokeDasharray = `${circumference * totalProgress / 100} ${circumference}`;
                }
            }
            
            // æŠ±æŠ±é¾™åŠ¨ç”»
            blinkEye() {
                const dragonEye = document.querySelector('.dragon-eye');
                if (dragonEye) {
                    dragonEye.classList.add('blink');
                    setTimeout(() => {
                        dragonEye.classList.remove('blink');
                    }, 150);
                }
            }

            startBlinking() {
                setInterval(() => {
                    if (Math.random() < 0.3) { // 30% chance to blink
                        this.blinkEye();
                    }
                }, 2000);
            }

            startSpeaking() {
                const dragonBody = document.querySelector('.dragon-body');
                if (dragonBody) {
                    dragonBody.classList.add('speaking');
                }
            }

            stopSpeaking() {
                const dragonBody = document.querySelector('.dragon-body');
                if (dragonBody) {
                    dragonBody.classList.remove('speaking');
                }
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆç®¡ç†å™¨
        new DragonTaskManager();
    </script>
</body>
</html>
