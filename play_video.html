
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§†é¢‘æ’­æ”¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1;
        }
        
        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        /* éšè—è§†é¢‘æ’­æ”¾å™¨çš„é»˜è®¤æ§åˆ¶æ¡ */
        .video-player::-webkit-media-controls {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-panel {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-play-button {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-start-playback-button {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-timeline {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-current-time-display {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-time-remaining-display {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-mute-button {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-volume-slider {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }
        
        .video-player::-webkit-media-controls-overlay-play-button {
            display: none !important;
        }
        
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 18px;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 20;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .control-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0.8;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .fullscreen-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
        
        /* è§¦æ§ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .control-btn:hover,
            .fullscreen-btn:hover {
                transform: none;
                background: rgba(0, 0, 0, 0.6);
            }
        }
    </style>
</head>
<body>
    <div class="video-container">
        <div id="loadingMessage" class="loading-message">
            è§†é¢‘åŠ è½½ä¸­...
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•
        </div>
        
        <video id="videoPlayer" class="video-player" style="display: none;" 
               preload="metadata" 
               playsinline 
               webkit-playsinline 
               controls="false" 
               disablePictureInPicture
               controlslist="nodownload nofullscreen noremoteplayback">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
        </video>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <!-- <div class="video-controls" id="videoControls" style="display: none;">
            <button class="control-btn" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">
                â–¶
            </button>
            <button class="control-btn" id="muteBtn" title="é™éŸ³/å–æ¶ˆé™éŸ³">
                ğŸ”Š
            </button>
        </div> -->
        
        <!-- å…¨å±æŒ‰é’® -->
        <!-- <button class="fullscreen-btn" id="fullscreenBtn" style="display: none;" title="å…¨å±">
            â›¶
        </button> -->
    </div>

    <script>
        let videoPlayer = null;
        let loadingMessage = null;
        let errorMessage = null;
        let videoControls = null;
        let playPauseBtn = null;
        let muteBtn = null;
        let fullscreenBtn = null;
        let controlsTimeout = null;
        let gameLoaded = false;
        
        // å›ºå®šè§†é¢‘URL
        const videoUrl = 'https://api.keepwork.com/ts-storage/siteFiles/46434/raw#dragon_change.mp4';
        
        // æ¸¸æˆé…ç½®
        let game_config = {
            id: 'video_player',
            videoUrl: videoUrl
        };
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // è·å–DOMå…ƒç´ 
            videoPlayer = document.getElementById('videoPlayer');
            loadingMessage = document.getElementById('loadingMessage');
            errorMessage = document.getElementById('errorMessage');
            videoControls = document.getElementById('videoControls');
            playPauseBtn = document.getElementById('playPauseBtn');
            muteBtn = document.getElementById('muteBtn');
            fullscreenBtn = document.getElementById('fullscreenBtn');
            
            // ç»‘å®šäº‹ä»¶
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', togglePlayPause);
                playPauseBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    togglePlayPause();
                });
            }
            
            if (muteBtn) {
                muteBtn.addEventListener('click', toggleMute);
                muteBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    toggleMute();
                });
            }
            
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                fullscreenBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    toggleFullscreen();
                });
            }
            
            // å…¨å±çŠ¶æ€å˜åŒ–ç›‘å¬
            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            
            // é˜²æ­¢é¡µé¢ç¼©æ”¾
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });
            
            // é˜²æ­¢ç§»åŠ¨ç«¯çš„é»˜è®¤æ‰‹åŠ¿
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            });
            
            // è‡ªåŠ¨åŠ è½½è§†é¢‘
            loadVideo(videoUrl);
        }
        
        // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®ï¼ˆä¸´æ—¶ï¼‰
        function showControlsTemporarily() {
            if (videoControls && fullscreenBtn) {
                videoControls.style.opacity = '0.8';
                fullscreenBtn.style.opacity = '0.8';
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (controlsTimeout) {
                    clearTimeout(controlsTimeout);
                }
                
                // 3ç§’åéšè—æ§åˆ¶æŒ‰é’®
                controlsTimeout = setTimeout(() => {
                    if (videoControls && fullscreenBtn) {
                        videoControls.style.opacity = '0.3';
                        fullscreenBtn.style.opacity = '0.3';
                    }
                }, 3000);
            }
        }
        
        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        function togglePlayPause() {
            if (videoPlayer) {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            }
        }
        
        // åˆ‡æ¢é™éŸ³
        function toggleMute() {
            if (videoPlayer) {
                videoPlayer.muted = !videoPlayer.muted;
            }
        }
        
        // åˆ‡æ¢å…¨å±
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // è¿›å…¥å…¨å±
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
            } else {
                // é€€å‡ºå…¨å±
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }
        
        // æ›´æ–°æ’­æ”¾/æš‚åœæŒ‰é’®
        function updatePlayPauseButton() {
            if (playPauseBtn && videoPlayer) {
                playPauseBtn.textContent = videoPlayer.paused ? 'â–¶' : 'â¸';
            }
        }
        
        // æ›´æ–°é™éŸ³æŒ‰é’®
        function updateMuteButton() {
            if (muteBtn && videoPlayer) {
                muteBtn.textContent = videoPlayer.muted ? 'ğŸ”‡' : 'ğŸ”Š';
            }
        }
        
        // æ›´æ–°å…¨å±æŒ‰é’®
        function updateFullscreenButton() {
            if (fullscreenBtn) {
                const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
                fullscreenBtn.textContent = isFullscreen ? 'â›¶' : 'â›¶';
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
        function showLoading() {
            if (loadingMessage) loadingMessage.style.display = 'block';
            if (errorMessage) errorMessage.style.display = 'none';
            if (videoPlayer) videoPlayer.style.display = 'none';
            if (videoControls) videoControls.style.display = 'none';
            if (fullscreenBtn) fullscreenBtn.style.display = 'none';
        }
        
        // æ˜¾ç¤ºè§†é¢‘
        function showVideo() {
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (errorMessage) errorMessage.style.display = 'none';
            if (videoPlayer) videoPlayer.style.display = 'block';
            if (videoControls) videoControls.style.display = 'flex';
            if (fullscreenBtn) fullscreenBtn.style.display = 'flex';
            
            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            updatePlayPauseButton();
            updateMuteButton();
            updateFullscreenButton();
            
            // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
            showControlsTemporarily();
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError() {
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (errorMessage) errorMessage.style.display = 'block';
            if (videoPlayer) videoPlayer.style.display = 'none';
            if (videoControls) videoControls.style.display = 'none';
            if (fullscreenBtn) fullscreenBtn.style.display = 'none';
        }
        
        // å°è¯•è‡ªåŠ¨æ’­æ”¾ - é’ˆå¯¹ç½‘é¡µç¯å¢ƒä¼˜åŒ–
        function tryAutoPlay() {
            if (videoPlayer) {
                // è®¾ç½®é™éŸ³ä»¥æé«˜è‡ªåŠ¨æ’­æ”¾æˆåŠŸç‡
                videoPlayer.muted = true;
                
                // å¤šæ¬¡å°è¯•æ’­æ”¾ï¼Œæé«˜æˆåŠŸç‡
                let playAttempts = 0;
                const maxAttempts = 5; // å¢åŠ å°è¯•æ¬¡æ•°
                
                function attemptPlay() {
                    playAttempts++;
                    console.log(`å°è¯•è‡ªåŠ¨æ’­æ”¾ (ç¬¬${playAttempts}æ¬¡)`);
                    
                    const playPromise = videoPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                            // è‡ªåŠ¨æ’­æ”¾æˆåŠŸåå¯ä»¥å°è¯•å–æ¶ˆé™éŸ³
                            setTimeout(() => {
                                if (videoPlayer && !videoPlayer.paused) {
                                    videoPlayer.muted = false;
                                }
                            }, 1000);
                        }).catch(error => {
                            console.log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥ (ç¬¬${playAttempts}æ¬¡):`, error);
                            
                            // å¦‚æœè¿˜æœ‰å°è¯•æ¬¡æ•°ï¼Œå»¶è¿Ÿåå†è¯•
                            if (playAttempts < maxAttempts) {
                                setTimeout(attemptPlay, 300 + playAttempts * 200); // é€’å¢å»¶è¿Ÿ
                            } else {
                                // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                                updatePlayPauseButton();
                                if (loadingMessage) {
                                    loadingMessage.innerHTML = 'ç‚¹å‡»ä»»æ„ä½ç½®å¼€å§‹æ’­æ”¾è§†é¢‘';
                                    loadingMessage.style.display = 'block';
                                }
                            }
                        });
                    }
                }
                
                // ç«‹å³å°è¯•ç¬¬ä¸€æ¬¡
                attemptPlay();
                
                // è®¾ç½®å¤šä¸ªå»¶è¿Ÿå°è¯•ï¼Œé’ˆå¯¹ç½‘é¡µç¯å¢ƒ
                const delays = [500, 1000, 2000, 3000];
                delays.forEach((delay, index) => {
                    setTimeout(() => {
                        if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                            console.log(`å»¶è¿Ÿå°è¯•è‡ªåŠ¨æ’­æ”¾ (${delay}ms)`);
                            videoPlayer.play().catch(error => {
                                console.log(`å»¶è¿Ÿè‡ªåŠ¨æ’­æ”¾å¤±è´¥ (${delay}ms):`, error);
                            });
                        }
                    }, delay);
                });
            }
        }
        
        // åŠ è½½å¹¶æ’­æ”¾è§†é¢‘
        function loadVideo(url) {
            if (!url) {
                showError();
                return;
            }
            
            if (!videoPlayer) {
                showError();
                return;
            }
            
            // è®¾ç½®è§†é¢‘æº
            videoPlayer.src = url;
            
            // ç›‘å¬è§†é¢‘åŠ è½½äº‹ä»¶
            videoPlayer.addEventListener('loadstart', function() {
                showLoading();
            });
            
            videoPlayer.addEventListener('canplay', function() {
                showVideo();
                // è‡ªåŠ¨æ’­æ”¾
                tryAutoPlay();
                
                // ç½‘é¡µç¯å¢ƒé¢å¤–å°è¯•
                setTimeout(() => {
                    if (videoPlayer && videoPlayer.paused) {
                        console.log('canplayäº‹ä»¶å»¶è¿Ÿå°è¯•æ’­æ”¾');
                        tryAutoPlay();
                    }
                }, 100);
            });
            
            // æ·»åŠ æ›´å¤šè§¦å‘è‡ªåŠ¨æ’­æ”¾çš„äº‹ä»¶
            videoPlayer.addEventListener('loadeddata', function() {
                console.log('è§†é¢‘æ•°æ®åŠ è½½å®Œæˆï¼Œå°è¯•æ’­æ”¾');
                if (videoPlayer.paused) {
                    tryAutoPlay();
                }
            });
            
            videoPlayer.addEventListener('canplaythrough', function() {
                console.log('è§†é¢‘å¯ä»¥æµç•…æ’­æ”¾ï¼Œå°è¯•æ’­æ”¾');
                if (videoPlayer.paused) {
                    tryAutoPlay();
                }
            });
            
            videoPlayer.addEventListener('error', function() {
                showError();
            });
            
            // ç›‘å¬è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
            videoPlayer.addEventListener('ended', function() {
                updatePlayPauseButton();
                // å‘é€è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶ç»™çˆ¶çª—å£
                window.parent.postMessage({
                    type: 'videoEnded',
                    data: {
                        closeWindow: true,
                        id: game_config.id
                    }
                }, '*');
            });
            
            videoPlayer.addEventListener('play', function() {
                updatePlayPauseButton();
            });
            
            videoPlayer.addEventListener('pause', function(e) {
                updatePlayPauseButton();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ„å¤–æš‚åœï¼ˆéç”¨æˆ·ä¸»åŠ¨æš‚åœï¼‰
                // å¦‚æœè§†é¢‘ä¸æ˜¯å› ä¸ºç»“æŸè€Œæš‚åœï¼Œä¸”ä¸æ˜¯ç”¨æˆ·ç‚¹å‡»æš‚åœï¼Œåˆ™å°è¯•æ¢å¤æ’­æ”¾
                setTimeout(() => {
                    if (videoPlayer && videoPlayer.paused && !videoPlayer.ended && videoPlayer.readyState >= 2) {
                        console.log('æ£€æµ‹åˆ°è§†é¢‘æ„å¤–æš‚åœï¼Œå°è¯•æ¢å¤æ’­æ”¾');
                        videoPlayer.play().catch(error => {
                            console.log('è‡ªåŠ¨æ¢å¤æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }, 500); // å»¶è¿Ÿ500msæ£€æŸ¥ï¼Œé¿å…ä¸æ­£å¸¸æš‚åœæ“ä½œå†²çª
            });
            
            videoPlayer.addEventListener('volumechange', function() {
                updateMuteButton();
            });
            
            // ç‚¹å‡»è§†é¢‘æ—¶åªåœ¨æš‚åœçŠ¶æ€ä¸‹æ’­æ”¾ï¼Œé¿å…æ„å¤–æš‚åœ
            videoPlayer.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                if (videoPlayer.paused) {
                    videoPlayer.play().then(() => {
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.log('æ’­æ”¾å¤±è´¥:', error);
                    });
                }
                showControlsTemporarily();
            });
            
            // è§¦æ‘¸äº‹ä»¶ - åªåœ¨æš‚åœçŠ¶æ€ä¸‹æ’­æ”¾
            videoPlayer.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                if (videoPlayer.paused) {
                    videoPlayer.play().then(() => {
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.log('æ’­æ”¾å¤±è´¥:', error);
                    });
                }
                showControlsTemporarily();
            });
            
            // ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®æ’­æ”¾è§†é¢‘ï¼ˆç”¨äºè§£å†³è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
            document.addEventListener('click', function(e) {
                if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                    videoPlayer.play().then(() => {
                        // æ’­æ”¾æˆåŠŸåéšè—åŠ è½½æç¤º
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.log('æ’­æ”¾å¤±è´¥:', error);
                    });
                }
            });
            
            // è§¦æ‘¸é¡µé¢ä»»æ„ä½ç½®æ’­æ”¾è§†é¢‘
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                    videoPlayer.play().then(() => {
                        // æ’­æ”¾æˆåŠŸåéšè—åŠ è½½æç¤º
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.log('æ’­æ”¾å¤±è´¥:', error);
                    });
                }
            });
            
            // é˜²æ­¢è§†é¢‘æ„å¤–æš‚åœçš„äº‹ä»¶ç›‘å¬
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œé˜²æ­¢åˆ‡æ¢æ ‡ç­¾é¡µæ—¶æš‚åœ
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå¦‚æœè§†é¢‘è¢«æš‚åœä¸”å·²åŠ è½½ï¼Œå°è¯•ç»§ç»­æ’­æ”¾
                    setTimeout(() => {
                        if (videoPlayer && videoPlayer.paused) {
                            videoPlayer.play().catch(error => {
                                console.log('æ¢å¤æ’­æ”¾å¤±è´¥:', error);
                            });
                        }
                    }, 100);
                }
            });
            
            // é˜²æ­¢ç©ºæ ¼é”®ç­‰é”®ç›˜äº‹ä»¶æš‚åœè§†é¢‘
            document.addEventListener('keydown', function(e) {
                // é˜»æ­¢ç©ºæ ¼é”®ã€å›è½¦é”®ç­‰å¯èƒ½æš‚åœè§†é¢‘çš„æŒ‰é”®
                if (e.code === 'Space' || e.code === 'Enter' || e.code === 'MediaPlayPause') {
                    e.preventDefault();
                    e.stopPropagation();
                    // å¦‚æœè§†é¢‘æš‚åœï¼Œåˆ™æ’­æ”¾
                    if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                        videoPlayer.play().catch(error => {
                            console.log('é”®ç›˜æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }
            });
            
            // å°è¯•åŠ è½½è§†é¢‘
            videoPlayer.load();
        }
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    try {
                        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå…ˆè§£æJSON
                        game_config = typeof e.data.data === 'string' ? JSON.parse(e.data.data) : e.data.data;
                        
                        // è·å–è§†é¢‘URLï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤URLï¼‰
                        const newVideoUrl = game_config.videoUrl || videoUrl;
                        if (newVideoUrl !== videoPlayer.src) {
                            loadVideo(newVideoUrl);
                        }
                    } catch (error) {
                        console.error('è§£ææ¸¸æˆé…ç½®å¤±è´¥:', error);
                        // ä½¿ç”¨é»˜è®¤è§†é¢‘URL
                        loadVideo(videoUrl);
                    }
                    break;
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            
            // ç½‘é¡µç¯å¢ƒç‰¹æ®Šå¤„ç†ï¼šå°è¯•åˆ›å»ºç”¨æˆ·äº¤äº’ä¸Šä¸‹æ–‡
            setTimeout(() => {
                // åˆ›å»ºä¸€ä¸ªä¸å¯è§çš„æŒ‰é’®æ¥æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’
                const hiddenButton = document.createElement('button');
                hiddenButton.style.position = 'absolute';
                hiddenButton.style.left = '-9999px';
                hiddenButton.style.opacity = '0';
                hiddenButton.style.pointerEvents = 'none';
                document.body.appendChild(hiddenButton);
                
                // å°è¯•è§¦å‘ä¸€ä¸ªåˆæˆçš„ç‚¹å‡»äº‹ä»¶
                try {
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    hiddenButton.dispatchEvent(clickEvent);
                    console.log('å°è¯•åˆ›å»ºç”¨æˆ·äº¤äº’ä¸Šä¸‹æ–‡');
                } catch (e) {
                    console.log('æ— æ³•åˆ›å»ºåˆæˆäº¤äº’äº‹ä»¶:', e);
                }
                
                // æ¸…ç†
                setTimeout(() => {
                    if (hiddenButton.parentNode) {
                        hiddenButton.parentNode.removeChild(hiddenButton);
                    }
                }, 1000);
            }, 200);
        });
        
        // æ£€æµ‹æ˜¯å¦åœ¨iframeä¸­
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }
        
        // ç”¨æˆ·äº¤äº’æ£€æµ‹ - å¢å¼ºç‰ˆ
        let userInteracted = false;
        const interactionEvents = ['click', 'touchstart', 'keydown', 'mousedown', 'pointerdown', 'touchmove'];
        
        // ç½‘é¡µç¯å¢ƒçš„ç§¯ææ’­æ”¾ç­–ç•¥
        function aggressivePlayAttempt() {
            if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                console.log('æ‰§è¡Œç§¯ææ’­æ”¾å°è¯•');
                
                // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§ä¸”æœ‰å°ºå¯¸
                if (videoPlayer.offsetWidth === 0 || videoPlayer.offsetHeight === 0) {
                    videoPlayer.style.width = '100%';
                    videoPlayer.style.height = '100%';
                }
                
                // è®¾ç½®å¤šä¸ªæ’­æ”¾å±æ€§
                videoPlayer.muted = true;
                videoPlayer.autoplay = true;
                videoPlayer.playsInline = true;
                
                // å°è¯•æ’­æ”¾
                const playPromise = videoPlayer.play();
                if (playPromise) {
                    playPromise.then(() => {
                        console.log('ç§¯ææ’­æ”¾æˆåŠŸ');
                        setTimeout(() => {
                            if (videoPlayer && !videoPlayer.paused) {
                                videoPlayer.muted = false;
                            }
                        }, 1000);
                    }).catch(error => {
                        console.log('ç§¯ææ’­æ”¾å¤±è´¥:', error);
                        
                        // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½è§†é¢‘
                        setTimeout(() => {
                            if (videoPlayer && videoPlayer.paused) {
                                console.log('å°è¯•é‡æ–°åŠ è½½è§†é¢‘');
                                const currentSrc = videoPlayer.src;
                                videoPlayer.load();
                                setTimeout(() => {
                                    videoPlayer.play().catch(e => {
                                        console.log('é‡æ–°åŠ è½½åæ’­æ”¾å¤±è´¥:', e);
                                    });
                                }, 500);
                            }
                        }, 1000);
                    });
                }
            }
        }
        
        function markUserInteraction() {
            if (!userInteracted) {
                userInteracted = true;
                console.log('æ£€æµ‹åˆ°ç”¨æˆ·äº¤äº’ï¼Œå°è¯•æ’­æ”¾è§†é¢‘');
                
                // ç”¨æˆ·äº¤äº’åç«‹å³å°è¯•æ’­æ”¾
                if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                    // å…ˆå°è¯•å¸¸è§„æ’­æ”¾
                    videoPlayer.play().then(() => {
                        console.log('ç”¨æˆ·äº¤äº’åæ’­æ”¾æˆåŠŸ');
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.log('ç”¨æˆ·äº¤äº’åæ’­æ”¾å¤±è´¥:', error);
                        // å¦‚æœå¸¸è§„æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨ç§¯ææ’­æ”¾ç­–ç•¥
                        aggressivePlayAttempt();
                    });
                } else {
                    // å¦‚æœè§†é¢‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œä¹Ÿå°è¯•ç§¯ææ’­æ”¾
                    aggressivePlayAttempt();
                }
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                interactionEvents.forEach(event => {
                    document.removeEventListener(event, markUserInteraction);
                });
            }
        }
        
        // æ·»åŠ ç”¨æˆ·äº¤äº’ç›‘å¬
        interactionEvents.forEach(event => {
            document.addEventListener(event, markUserInteraction, { once: true });
        });
        
        // ç½‘é¡µç¯å¢ƒé¢å¤–çš„æ’­æ”¾è§¦å‘æœºåˆ¶
        // ç›‘å¬é¼ æ ‡ç§»åŠ¨ï¼ˆè½»é‡çº§äº¤äº’æ£€æµ‹ï¼‰
         let mouseMoveCount = 0;
         document.addEventListener('mousemove', function() {
             mouseMoveCount++;
             if (mouseMoveCount === 3 && videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                 console.log('æ£€æµ‹åˆ°é¼ æ ‡æ´»åŠ¨ï¼Œå°è¯•æ’­æ”¾');
                 videoPlayer.play().catch(error => {
                     console.log('é¼ æ ‡æ´»åŠ¨æ’­æ”¾å¤±è´¥:', error);
                     // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨ç§¯ææ’­æ”¾ç­–ç•¥
                     aggressivePlayAttempt();
                 });
             }
         }, { once: true });
         
         // æ·»åŠ æ›´å¤šè½»é‡çº§äº¤äº’æ£€æµ‹
         document.addEventListener('mouseenter', function() {
             if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                 console.log('æ£€æµ‹åˆ°é¼ æ ‡è¿›å…¥ï¼Œå°è¯•æ’­æ”¾');
                 setTimeout(() => {
                     aggressivePlayAttempt();
                 }, 100);
             }
         }, { once: true });
        
        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
         document.addEventListener('scroll', function() {
             if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                 console.log('æ£€æµ‹åˆ°æ»šåŠ¨äº‹ä»¶ï¼Œå°è¯•æ’­æ”¾');
                 videoPlayer.play().catch(error => {
                     console.log('æ»šåŠ¨äº‹ä»¶æ’­æ”¾å¤±è´¥:', error);
                     // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨ç§¯ææ’­æ”¾ç­–ç•¥
                     aggressivePlayAttempt();
                 });
             }
         }, { once: true });
         
         // ç½‘é¡µç¯å¢ƒçš„å®šæ—¶ç§¯æå°è¯•
         let aggressiveAttempts = 0;
         const maxAggressiveAttempts = 5;
         const aggressiveInterval = setInterval(() => {
             aggressiveAttempts++;
             if (videoPlayer && videoPlayer.paused && aggressiveAttempts <= maxAggressiveAttempts) {
                 console.log(`å®šæ—¶ç§¯ææ’­æ”¾å°è¯• (ç¬¬${aggressiveAttempts}æ¬¡)`);
                 aggressivePlayAttempt();
             }
             
             if (aggressiveAttempts >= maxAggressiveAttempts || (videoPlayer && !videoPlayer.paused)) {
                 clearInterval(aggressiveInterval);
             }
         }, 3000); // æ¯3ç§’å°è¯•ä¸€æ¬¡
        
        // å¦‚æœåœ¨iframeä¸­ï¼Œæ·»åŠ é¢å¤–çš„æ’­æ”¾å°è¯•
        if (isInIframe()) {
            console.log('æ£€æµ‹åˆ°iframeç¯å¢ƒï¼Œå¯ç”¨å¢å¼ºæ’­æ”¾ç­–ç•¥');
            
            // ç›‘å¬çˆ¶çª—å£çš„æ¶ˆæ¯
            window.addEventListener('message', function(e) {
                if (e.data.type === 'tryPlay' || e.data.type === 'userInteraction') {
                    console.log('æ”¶åˆ°çˆ¶çª—å£æ’­æ”¾æŒ‡ä»¤');
                    if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                        videoPlayer.play().catch(error => {
                            console.log('çˆ¶çª—å£æŒ‡ä»¤æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }
            });
            
            // å®šæœŸæ£€æŸ¥å¹¶å°è¯•æ’­æ”¾ï¼ˆä»…åœ¨iframeä¸­ï¼‰- å¢åŠ é¢‘ç‡
            let checkCount = 0;
            const maxChecks = 15; // å¢åŠ æ£€æŸ¥æ¬¡æ•°
            const checkInterval = setInterval(() => {
                checkCount++;
                if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2 && checkCount <= maxChecks) {
                    console.log(`iframeç¯å¢ƒå®šæœŸæ£€æŸ¥æ’­æ”¾ (ç¬¬${checkCount}æ¬¡)`);
                    videoPlayer.play().catch(error => {
                        console.log('å®šæœŸæ£€æŸ¥æ’­æ”¾å¤±è´¥:', error);
                    });
                }
                
                if (checkCount >= maxChecks || (videoPlayer && !videoPlayer.paused)) {
                    clearInterval(checkInterval);
                }
            }, 1000); // å‡å°‘é—´éš”æ—¶é—´
            
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                    console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œå°è¯•æ’­æ”¾');
                    setTimeout(() => {
                        videoPlayer.play().catch(error => {
                            console.log('å¯è§æ€§å˜åŒ–æ’­æ”¾å¤±è´¥:', error);
                        });
                    }, 200);
                }
            });
        } else {
            console.log('éiframeç¯å¢ƒï¼Œä½¿ç”¨æ ‡å‡†æ’­æ”¾ç­–ç•¥');
        }
        
        // é€šçŸ¥çˆ¶çª—å£æ¸¸æˆå·²åŠ è½½
        setTimeout(() => {
            gameLoaded = true;
            window.parent.postMessage({
                type: 'gameLoaded',
            }, '*');
            
            // æ¸¸æˆåŠ è½½å®Œæˆåå†æ¬¡å°è¯•æ’­æ”¾ï¼ˆé’ˆå¯¹ç½‘é¡µç¯å¢ƒï¼‰
             if (videoPlayer && videoPlayer.paused && videoPlayer.readyState >= 2) {
                 console.log('æ¸¸æˆåŠ è½½å®Œæˆï¼Œæœ€åå°è¯•è‡ªåŠ¨æ’­æ”¾');
                 setTimeout(() => {
                     tryAutoPlay();
                 }, 500);
                 
                 // å¦‚æœå¸¸è§„å°è¯•å¤±è´¥ï¼Œä½¿ç”¨ç§¯ææ’­æ”¾ç­–ç•¥
                 setTimeout(() => {
                     if (videoPlayer && videoPlayer.paused) {
                         console.log('å¸¸è§„æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨ç§¯ææ’­æ”¾ç­–ç•¥');
                         aggressivePlayAttempt();
                     }
                 }, 2000);
             }
        }, 100);
    </script>
</body>
</html>
