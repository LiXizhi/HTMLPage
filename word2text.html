
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Document Converter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Mammoth (DOCX -> HTML) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- Turndown (HTML -> Markdown) -->
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    
    <!-- Marked (Markdown -> HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- html-docx-js (HTML -> DOCX Blob) -->
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
    
    <!-- FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-file-signature"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">DocuFlow <span class="text-slate-400 font-normal text-sm ml-2">PDF/DOCX â†” Markdown</span></h1>
        </div>
        <div class="text-sm text-slate-500">
            v1.2 Client-Side Only
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden p-6 gap-6">
        
        <!-- Left Side: Drop Zone -->
        <div class="w-1/3 flex flex-col gap-4">
            <div id="drop-zone" class="flex-1 border-2 border-dashed border-slate-300 rounded-xl bg-white flex flex-col items-center justify-center p-8 transition-all duration-200 relative group hover:border-blue-400">
                
                <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf,.docx">
                
                <div class="text-center pointer-events-none">
                    <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2 text-slate-700">Drag & Drop File</h3>
                    <p class="text-slate-500 text-sm mb-6">Supports .pdf or .docx</p>
                    <span class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-600 shadow-sm">Browse Files</span>
                </div>
            </div>

            <!-- Status / Info Card -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm h-48">
                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Processing Status</h4>
                <div id="status-container" class="flex flex-col items-center justify-center h-32 text-slate-400 text-sm text-center">
                    <p>Waiting for file...</p>
                </div>
            </div>
        </div>

        <!-- Right Side: Editor -->
        <div class="w-2/3 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-slate-50 border-b border-slate-200 px-4 py-3 flex justify-between items-center">
                <span class="text-sm font-semibold text-slate-600">Markdown Editor</span>
                <div class="flex gap-2">
                    <button onclick="copyText()" class="px-3 py-1.5 hover:bg-slate-200 rounded text-slate-600 text-sm transition-colors" title="Copy to Clipboard">
                        <i class="fa-regular fa-copy"></i> Copy
                    </button>
                    <button onclick="downloadDocx()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-file-word"></i> Export DOCX
                    </button>
                </div>
            </div>

            <!-- Text Area -->
            <div class="flex-1 relative">
                <textarea id="editor" class="w-full h-full p-6 resize-none focus:outline-none font-mono text-sm leading-relaxed text-slate-700" placeholder="# Your converted text will appear here...&#10;&#10;You can also type Markdown directly and export it to DOCX."></textarea>
            </div>
        </div>

    </main>

    <script>
        // --- DOM Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const editor = document.getElementById('editor');
        const statusContainer = document.getElementById('status-container');

        // --- Libraries Setup ---
        const turndownService = new TurndownService({ 
            headingStyle: 'atx',
            codeBlockStyle: 'fenced'
        });

        // --- Event Listeners ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        // --- Core Logic ---
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            showLoading(file.name);

            if (file.type === "application/pdf") {
                processPDF(file);
            } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || file.name.endsWith('.docx')) {
                processDOCX(file);
            } else {
                showError("Unsupported file type. Please upload PDF or DOCX.");
            }
        }

        // --- PDF Processing ---
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = `# ${file.name}\n\n`;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    showLoading(`Processing Page ${i} of ${pdf.numPages}...`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    let lastY, text = '';
                    for (let item of textContent.items) {
                        if (lastY == item.transform[5] || !lastY){
                            text += item.str;
                        }  
                        else{
                            text += '\n' + item.str;
                        }                                                    
                        lastY = item.transform[5];
                    }
                    fullText += text + "\n\n---\n\n";
                }

                editor.value = fullText;
                showSuccess("PDF converted successfully.");

            } catch (err) {
                console.error(err);
                showError("Error parsing PDF: " + err.message);
            }
        }

        // --- DOCX Processing ---
        function processDOCX(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                
                mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                    .then(function(result){
                        const html = result.value;
                        const markdown = turndownService.turndown(html);
                        editor.value = `# ${file.name}\n\n${markdown}`;
                        showSuccess("DOCX converted to Markdown.");
                    })
                    .catch(function(err){
                        console.error(err);
                        showError("Error parsing DOCX.");
                    });
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Export Logic (Fixed String Construction) ---
        function downloadDocx() {
            const markdownText = editor.value;
            if(!markdownText.trim()) {
                alert("Editor is empty!");
                return;
            }

            try {
                showLoading("Generating DOCX...");
                
                // 1. Convert Markdown to HTML
                const htmlContent = marked.parse(markdownText);

                // 2. Construct HTML for Word
                // We use string concatenation to break tags like </html> so the browser parser doesn't see them.
                const part1 = '<!DOCTYPE html><' + 'html><' + 'head><meta charset="utf-8">';
                const css = '<style>body { font-family: Calibri, sans-serif; font-size: 11pt; } h1 { font-size: 18pt; color: #2e74b5; } h2 { font-size: 14pt; color: #2e74b5; } code { background: #f0f0f0; font-family: Consolas; } pre { background: #f0f0f0; padding: 10px; } table { border-collapse: collapse; width: 100%; } td, th { border: 1px solid #ddd; padding: 8px; }</style>';
                const part2 = '<' + '/head><' + 'body>';
                const part3 = '<' + '/body><' + '/html>';

                const contentDocument = part1 + css + part2 + htmlContent + part3;

                // 3. Convert to Blob
                const converted = htmlDocx.asBlob(contentDocument);
                
                // 4. Save
                saveAs(converted, 'converted_document.docx');
                showSuccess("DOCX Downloaded!");

            } catch (e) {
                console.error(e);
                showError("Failed to generate DOCX.");
            }
        }

        function copyText() {
            editor.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            
            const btn = document.querySelector('button[title="Copy to Clipboard"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function showLoading(msg) {
            statusContainer.innerHTML = '<div class="loader mb-3"></div><span class="text-slate-600 font-medium animate-pulse">' + msg + '</span>';
        }

        function showSuccess(msg) {
            statusContainer.innerHTML = '<div class="w-8 h-8 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-check"></i></div><span class="text-green-600 font-medium">' + msg + '</span>';
        }

        function showError(msg) {
            statusContainer.innerHTML = '<div class="w-8 h-8 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-exclamation"></i></div><span class="text-red-600 font-medium">' + msg + '</span>';
        }
    </script>
</body>
</html>
