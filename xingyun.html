<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿäº‘ - æ•°å­—äººAIèŠå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
        }

        /* Digital Human Video Section */
        .human-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: transparent;
        }

        #digitalHuman {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: transparent;
            display: none; /* Hide original video, we'll use canvas */
        }

        #humanCanvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: transparent;
        }

        .video-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-indicator.listening {
            background: #ff4444;
        }

        .status-indicator.thinking {
            background: #ffaa00;
        }

        .status-indicator.speaking {
            background: #00aaff;
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .message-content {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-content {
            background: #e8f5e8;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
            text-align: center;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #e8f5e8;
            border-radius: 18px;
            max-width: 70%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Input Section */
        .chat-input {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 20px 0;
            border-top: 1px solid #eee;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .text-input-container {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            min-height: 40px;
            max-height: 120px;
            padding: 12px 50px 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            transition: border-color 0.3s ease;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .voice-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #ff4444 0%, #cc3333 100%);
            animation: pulse 1s infinite;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .control-btn.active {
            background: #667eea;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* æ»‘å—æ ·å¼ */
        .form-group input[type="range"] {
            width: 70%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            margin-right: 10px;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .form-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .form-group span {
            display: inline-block;
            min-width: 40px;
            font-weight: bold;
            color: #667eea;
        }

        .save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                margin: 0;
                border-radius: 0;
                height: 100vh;
            }

            .human-section {
                flex: 0 0 40%;
                border-radius: 0;
            }

            .chat-section {
                flex: 1;
                border-radius: 0;
            }

            .chat-header {
                border-radius: 0;
            }

            .chat-input {
                border-radius: 0;
            }

            .control-panel {
                bottom: 10px;
                right: 10px;
                padding: 10px;
            }

            .message-content {
                max-width: 85%;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        /* Streaming cursor animation */
        .streaming-cursor {
            animation: blink 1s infinite;
            color: #667eea;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .message.streaming .message-content {
            background: #e8f5e8;
            color: #333;
            border: 2px solid #667eea;
        }

        /* Welcome Popup for mobile devices */
        .welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .welcome-popup.hidden {
            display: none;
        }

        .welcome-content {
            max-width: 400px;
            width: 100%;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .welcome-subtitle {
            font-size: 16px;
            margin-bottom: 40px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .welcome-start-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.6);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 160px;
        }

        .welcome-start-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .welcome-start-btn:active {
            transform: scale(0.98);
        }

        /* Animation for welcome popup */
        .welcome-popup {
            animation: fadeInWelcome 0.8s ease-out;
        }

        @keyframes fadeInWelcome {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Video loading state */
        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 10;
        }

        .video-loading .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Popup for mobile devices -->
    <div class="welcome-popup" id="welcomePopup">
        <div class="welcome-content">
            <h1 class="welcome-title">æ¬¢è¿æ¥åˆ°æ˜Ÿäº‘AIåŠ©æ‰‹</h1>
            <p class="welcome-subtitle">æ‚¨çš„æ™ºèƒ½æ•°å­—äººå¯¹è¯ä¼™ä¼´ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„äº¤æµå§ï¼</p>
            <button class="welcome-start-btn" id="welcomeStartBtn">å¼€å§‹ä½“éªŒ</button>
        </div>
    </div>

    <div class="app-container">
        <!-- Digital Human Section -->
        <div class="human-section">
            <div class="video-container">
                <video id="digitalHuman" muted loop playsinline crossorigin="anonymous">
                    <source src="" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
                </video>
                <canvas id="humanCanvas"></canvas>
                <div class="video-loading" id="videoLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŠ è½½æ•°å­—äºº...</div>
                </div>
                <div class="video-overlay">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">å‡†å¤‡å¥½äº†</span>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="control-panel">
                <button class="control-btn" id="settingsBtn" title="è®¾ç½®">
                    âš™ï¸
                </button>
                <button class="control-btn" id="muteBtn" title="é™éŸ³/å–æ¶ˆé™éŸ³">
                    ğŸ”Š
                </button>
                <button class="control-btn" id="clearBtn" title="æ¸…ç©ºèŠå¤©">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <h1>æ˜Ÿäº‘ AI åŠ©æ‰‹</h1>
                <p>æ‚¨çš„æ™ºèƒ½æ•°å­—äººå¯¹è¯ä¼™ä¼´</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯æ˜Ÿäº‘ï¼Œä½ çš„AIæ•°å­—äººåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å’Œä½ è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                        <div class="message-time" id="welcomeTime"></div>
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <div class="input-container">
                    <div class="text-input-container">
                        <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ç‚¹å‡»éº¦å…‹é£è¯´è¯..." rows="1"></textarea>
                        <button class="voice-btn" id="voiceBtn" title="è¯­éŸ³è¾“å…¥">
                            ğŸ¤
                        </button>
                    </div>
                    <button class="send-btn" id="sendBtn" title="å‘é€æ¶ˆæ¯">
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è®¾ç½®</h2>
                <button class="close-btn" id="closeSettingsBtn">Ã—</button>
            </div>
            
            <form id="settingsForm">
                <div class="form-group">
                    <label for="llmApiKey">è±†åŒ… LLM API å¯†é’¥:</label>
                    <input type="password" id="llmApiKey" placeholder="è¾“å…¥æ‚¨çš„ API Key">
                </div>
                
                <div class="form-group">
                    <label for="modelName">æ¨¡å‹åç§°:</label>
                    <input type="text" id="modelName" placeholder="è¾“å…¥æ¨¡å‹åç§°">
                </div>
                
                <div class="form-group">
                    <label for="ttsApiKey">è±†åŒ… TTS API å¯†é’¥:</label>
                    <input type="password" id="ttsApiKey" placeholder="è¾“å…¥æ‚¨çš„ TTS API Key">
                </div>
                
                <div class="form-group">
                    <label for="ttsVoice">è¯­éŸ³æ¨¡å‹:</label>
                    <select id="ttsVoice">
                        <option value="zh_female_shuangkuaisisi">å¥³å£°-åŒå¿«æ€æ€</option>
                        <option value="zh_male_jingqiangkuaishou">ç”·å£°-äº¬è…”å¿«æ‰‹</option>
                        <option value="zh_female_wenxiaoyan">å¥³å£°-æ–‡å°é›</option>
                        <option value="zh_male_zhengxiaogang">ç”·å£°-æ­£å°åˆš</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="idleVideo">å¾…æœºè§†é¢‘ URL:</label>
                    <input type="url" id="idleVideo" placeholder="è¾“å…¥å¾…æœºåŠ¨ç”»è§†é¢‘URL">
                </div>
                
                <div class="form-group">
                    <label for="thinkingVideo">æ€è€ƒè§†é¢‘ URL:</label>
                    <input type="url" id="thinkingVideo" placeholder="è¾“å…¥æ€è€ƒåŠ¨ç”»è§†é¢‘URLï¼ˆå¯é€‰ï¼Œä¸ºç©ºåˆ™ä½¿ç”¨å¾…æœºè§†é¢‘ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="talkingVideo">è¯´è¯è§†é¢‘ URL:</label>
                    <input type="url" id="talkingVideo" placeholder="è¾“å…¥è¯´è¯åŠ¨ç”»è§†é¢‘URL">
                </div>
                
                <div class="form-group">
                    <label for="listeningVideo">å¬å–è§†é¢‘ URL:</label>
                    <input type="url" id="listeningVideo" placeholder="è¾“å…¥å¬å–åŠ¨ç”»è§†é¢‘URL">
                </div>
                
                <div class="form-group">
                    <label for="whiteThreshold">ç™½è‰²é€æ˜é˜ˆå€¼ (0.1-0.8):</label>
                    <input type="range" id="whiteThreshold" min="0.1" max="0.8" step="0.05" value="0.35">
                    <span id="whiteThresholdValue">0.35</span>
                </div>
                
                <div class="form-group">
                    <label for="fadeRange">è¾¹ç¼˜æ¸å˜èŒƒå›´ (0.05-0.3):</label>
                    <input type="range" id="fadeRange" min="0.05" max="0.3" step="0.01" value="0.15">
                    <span id="fadeRangeValue">0.15</span>
                </div>
                
                <div class="form-group">
                    <label for="saturationBoost">è‰²å½©é¥±å’Œåº¦å¢å¼º (1.0-2.0):</label>
                    <input type="range" id="saturationBoost" min="1.0" max="2.0" step="0.05" value="1.15">
                    <span id="saturationBoostValue">1.15</span>
                </div>
                
                <button type="submit" class="save-btn">ä¿å­˜è®¾ç½®</button>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        class DigitalHumanChat {
            constructor() {
                this.config = {
                    llmApiKey: 'ec978213-eff1-4a6f-9c15-7aeb71c082c7',
                    ttsApiKey: '',
                    llmUrl: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                    ttsUrl: 'https://ark.cn-beijing.volces.com/api/v3/audio/speech',
                    modelName: 'doubao-seed-1-6-flash-250615',
                    ttsVoice: 'zh_female_shuangkuaisisi',
                    maxTextureSize: 512,       // æœ€å¤§çº¹ç†å°ºå¯¸é™åˆ¶
                    // å…¨å±€é»˜è®¤WebGLè®¾ç½®
                    defaultWebglParams: {
                        whiteThreshold: 0.35,       // ç™½è‰²æ£€æµ‹é˜ˆå€¼ (0.1-0.8)
                        fadeRange: 0.15,            // æ¸å˜èŒƒå›´ (0.05-0.3)
                        saturationBoost: 1.15,      // é¥±å’Œåº¦å¢å¼º (1.0-2.0)
                        transparentColor: [1.0, 1.0, 1.0], // RGBé€æ˜è‰² (0.0-1.0)
                        colorThreshold: 0.1,        // é¢œè‰²åŒ¹é…é˜ˆå€¼
                        enableSmoothing: true,      // å¯ç”¨è¾¹ç¼˜å¹³æ»‘
                        compressionQuality: 0.85    // çº¹ç†å‹ç¼©è´¨é‡ (0.1-1.0)
                    },
                    
                    videos: {
                        idle: {
                            url: 'https://api.keepwork.com/ts-storage/siteFiles/46367/raw#dragon_eggy_idle.mp4',
                            webglParams: {
                                whiteThreshold: 0.35,    
                                fadeRange: 0.15,         
                                saturationBoost: 1.15,   
                                transparentColor: [1.0, 1.0, 1.0], 
                                colorThreshold: 0.1,     
                                enableSmoothing: true,   
                                compressionQuality: 0.9  
                            }
                        },
                        talking: {
                            url: 'https://api.keepwork.com/ts-storage/siteFiles/46368/raw#dragon_eggy_talk.mp4',
                            webglParams: {
                                whiteThreshold: 0.40,  
                                fadeRange: 0.12,
                                saturationBoost: 1.20,
                                transparentColor: [1.0, 1.0, 1.0],
                                colorThreshold: 0.08,  
                                enableSmoothing: true,
                                compressionQuality: 0.9
                            }
                        },
                        listening: {
                            url: 'https://cdn.keepwork.com/digitalhuman/v1/male/pikachu/idle.mp4',
                            webglParams: {
                                whiteThreshold: 0.30,  
                                fadeRange: 0.18,
                                saturationBoost: 1.10,
                                transparentColor: [0.95, 0.95, 0.95], 
                                colorThreshold: 0.12,
                                enableSmoothing: true,
                                compressionQuality: 0.85 
                            }
                        }
                    }
                };
                
                this.conversationHistory = [];
                this.isListening = false;
                this.isSpeaking = false;
                this.isMuted = false;
                this.currentAudio = null;
                this.recognition = null;
                this.videoLoaded = false;
                this.isMobile = this.detectMobile();
                this.currentVideoType = 'idle';
                this.thinkingStartTime = null;
                
                // å½“å‰è§†é¢‘çš„WebGLå‚æ•°ï¼ˆä»é…ç½®ä¸­åŠ¨æ€è·å–ï¼‰
                this.currentWebglParams = { ...this.config.videos[this.currentVideoType].webglParams };
                
                this.initElements();
                this.initWebGL();
                this.initEventListeners();
                this.initSpeechRecognition();
                this.loadSettings();
                this.setWelcomeTime();
                this.autoResizeTextarea();
                this.handleInitialLoad();
                
                // Initial resize adjustment
                setTimeout(() => this.adjustVideoSize(), 100);
            }

            initElements() {
                this.elements = {
                    digitalHuman: document.getElementById('digitalHuman'),
                    humanCanvas: document.getElementById('humanCanvas'),
                    statusIndicator: document.getElementById('statusIndicator'),
                    statusText: document.getElementById('statusText'),
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    muteBtn: document.getElementById('muteBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                    settingsForm: document.getElementById('settingsForm'),
                    welcomePopup: document.getElementById('welcomePopup'),
                    welcomeStartBtn: document.getElementById('welcomeStartBtn'),
                    videoLoading: document.getElementById('videoLoading'),
                    // WebGLé€æ˜åº¦æ§åˆ¶å…ƒç´ 
                    whiteThreshold: document.getElementById('whiteThreshold'),
                    whiteThresholdValue: document.getElementById('whiteThresholdValue'),
                    fadeRange: document.getElementById('fadeRange'),
                    fadeRangeValue: document.getElementById('fadeRangeValue'),
                    saturationBoost: document.getElementById('saturationBoost'),
                    saturationBoostValue: document.getElementById('saturationBoostValue')
                };
            }

            initWebGL() {
                const canvas = this.elements.humanCanvas;
                this.gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!this.gl) {
                    console.warn('WebGL not supported, falling back to regular video');
                    this.elements.digitalHuman.style.display = 'block';
                    canvas.style.display = 'none';
                    return;
                }

                // WebGLç€è‰²å™¨æºç  - é¡¶ç‚¹ç€è‰²å™¨
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec2 a_texCoord;
                    varying vec2 v_texCoord;
                    
                    void main() {
                        gl_Position = vec4(a_position, 0.0, 1.0);
                        v_texCoord = a_texCoord;
                    }
                `;

                // WebGLç€è‰²å™¨æºç  - ç‰‡æ®µç€è‰²å™¨
                const fragmentShaderSource = `
                    precision mediump float;
                    uniform sampler2D u_texture;
                    uniform float u_whiteThreshold;      // ç™½è‰²é˜ˆå€¼æ§åˆ¶
                    uniform float u_fadeRange;           // æ¸å˜èŒƒå›´æ§åˆ¶
                    uniform float u_saturationBoost;     // é¥±å’Œåº¦å¢å¼º
                    varying vec2 v_texCoord;
                    
                    void main() {
                        vec4 color = texture2D(u_texture, v_texCoord);
                        
                        // ä½¿ç”¨æ›´ç²¾ç¡®çš„ç™½è‰²æ£€æµ‹æ–¹æ³•
                        // è®¡ç®—RGBå„é€šé“ä¸ç™½è‰²çš„å·®å¼‚
                        vec3 whiteDiff = vec3(1.0) - color.rgb;
                        float whiteDistance = length(whiteDiff);
                        
                        // åŠ¨æ€é˜ˆå€¼è®¾ç½®
                        float pureWhiteThreshold = u_whiteThreshold * 0.4;         // çº¯ç™½è‰²é˜ˆå€¼
                        float fadeStartThreshold = u_whiteThreshold * 0.8;         // å¼€å§‹æ¸å˜çš„é˜ˆå€¼
                        float fadeEndThreshold = u_whiteThreshold * 1.2 + u_fadeRange; // ç»“æŸæ¸å˜çš„é˜ˆå€¼
                        
                        float alpha = 1.0;
                        
                        if (whiteDistance < pureWhiteThreshold) {
                            // çº¯ç™½è‰²åŒºåŸŸï¼Œå®Œå…¨é€æ˜
                            alpha = 0.0;
                        } else if (whiteDistance < fadeStartThreshold) {
                            // æ¥è¿‘ç™½è‰²åŒºåŸŸï¼Œå¿«é€Ÿè¡°å‡åˆ°é€æ˜
                            float fadeProgress = (whiteDistance - pureWhiteThreshold) / (fadeStartThreshold - pureWhiteThreshold);
                            alpha = fadeProgress * 0.3; // æœ€å¤§é€æ˜åº¦ä¸º0.3
                        } else if (whiteDistance < fadeEndThreshold) {
                            // è¿‡æ¸¡åŒºåŸŸï¼Œå¹³æ»‘æ¸å˜
                            float fadeProgress = (whiteDistance - fadeStartThreshold) / (fadeEndThreshold - fadeStartThreshold);
                            
                            // ä½¿ç”¨smoothstepè·å¾—æ›´è‡ªç„¶çš„æ¸å˜æ›²çº¿
                            fadeProgress = smoothstep(0.0, 1.0, fadeProgress);
                            alpha = 0.3 + fadeProgress * 0.7; // ä»0.3æ¸å˜åˆ°1.0
                        } else {
                            // éç™½è‰²åŒºåŸŸï¼Œå®Œå…¨ä¸é€æ˜
                            alpha = 1.0;
                        }
                        
                        // å¯¹äºéå¸¸æš—çš„åŒºåŸŸï¼ˆå¯èƒ½æ˜¯é˜´å½±ï¼‰ï¼Œç¨å¾®é™ä½é€æ˜åº¦ä»¥é¿å…è¾¹ç¼˜è¿‡ç¡¬
                        float brightness = (color.r + color.g + color.b) / 3.0;
                        if (brightness < 0.1) {
                            alpha *= 0.95;
                        }
                        
                        // åº”ç”¨è‰²å½©å¢å¼ºï¼Œè®©éç™½è‰²åŒºåŸŸæ›´åŠ é²œè‰³
                        vec3 enhancedColor = color.rgb;
                        if (whiteDistance > fadeStartThreshold) {
                            // å¯¹éç™½è‰²åŒºåŸŸè¿›è¡Œå¯è°ƒèŠ‚çš„é¥±å’Œåº¦å¢å¼º
                            vec3 gray = vec3((color.r + color.g + color.b) / 3.0);
                            enhancedColor = mix(gray, color.rgb, u_saturationBoost);
                        }
                        
                        // ç®€åŒ–çš„è¾¹ç¼˜è½¯åŒ–ï¼ˆç§»é™¤textureSizeä¾èµ–ï¼‰
                        // ä½¿ç”¨å›ºå®šçš„texelåç§»æ¥æ£€æµ‹è¾¹ç¼˜
                        float texelOffset = 0.001; // è¿‘ä¼¼texelå¤§å°
                        vec4 colorRight = texture2D(u_texture, v_texCoord + vec2(texelOffset, 0.0));
                        vec4 colorDown = texture2D(u_texture, v_texCoord + vec2(0.0, texelOffset));
                        
                        vec3 rightWhiteDiff = vec3(1.0) - colorRight.rgb;
                        vec3 downWhiteDiff = vec3(1.0) - colorDown.rgb;
                        float rightWhiteDistance = length(rightWhiteDiff);
                        float downWhiteDistance = length(downWhiteDiff);
                        
                        float edgeDetection = abs(whiteDistance - rightWhiteDistance) + abs(whiteDistance - downWhiteDistance);
                        
                        // å¦‚æœæ£€æµ‹åˆ°è¾¹ç¼˜ï¼Œç¨å¾®è°ƒæ•´alphaä»¥è·å¾—æ›´å¥½çš„æ··åˆæ•ˆæœ
                        if (edgeDetection > 0.1 && alpha > 0.3 && alpha < 1.0) {
                            alpha = mix(alpha, alpha * 0.9, min(edgeDetection * 2.0, 0.5));
                        }
                        
                        gl_FragColor = vec4(enhancedColor, alpha * color.a);
                    }
                `;

                // åˆ›å»ºç€è‰²å™¨
                this.shaderProgram = this.createShaderProgram(vertexShaderSource, fragmentShaderSource);
                
                if (!this.shaderProgram) {
                    console.warn('Failed to create shader program, falling back to regular video');
                    this.elements.digitalHuman.style.display = 'block';
                    canvas.style.display = 'none';
                    return;
                }

                // è·å–å±æ€§å’Œuniformä½ç½®
                this.programInfo = {
                    attribLocations: {
                        vertexPosition: this.gl.getAttribLocation(this.shaderProgram, 'a_position'),
                        textureCoord: this.gl.getAttribLocation(this.shaderProgram, 'a_texCoord'),
                    },
                    uniformLocations: {
                        uTexture: this.gl.getUniformLocation(this.shaderProgram, 'u_texture'),
                        uWhiteThreshold: this.gl.getUniformLocation(this.shaderProgram, 'u_whiteThreshold'),
                        uFadeRange: this.gl.getUniformLocation(this.shaderProgram, 'u_fadeRange'),
                        uSaturationBoost: this.gl.getUniformLocation(this.shaderProgram, 'u_saturationBoost'),
                    },
                };

                // åˆ›å»ºç¼“å†²åŒº
                this.initBuffers();
                
                // åˆ›å»ºçº¹ç†
                this.texture = this.gl.createTexture();
                
                // è®¾ç½®WebGLå¯ç”¨é€æ˜åº¦æ··åˆ
                this.gl.enable(this.gl.BLEND);
                this.gl.blendFunc(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA);
                
                // éšè—åŸè§†é¢‘ï¼Œæ˜¾ç¤ºcanvas
                this.elements.digitalHuman.style.display = 'none';
                canvas.style.display = 'block';
                
                console.log('WebGL initialized successfully');
            }

            createShaderProgram(vertexSource, fragmentSource) {
                const vertexShader = this.loadShader(this.gl.VERTEX_SHADER, vertexSource);
                const fragmentShader = this.loadShader(this.gl.FRAGMENT_SHADER, fragmentSource);

                if (!vertexShader || !fragmentShader) {
                    return null;
                }

                const shaderProgram = this.gl.createProgram();
                this.gl.attachShader(shaderProgram, vertexShader);
                this.gl.attachShader(shaderProgram, fragmentShader);
                this.gl.linkProgram(shaderProgram);

                if (!this.gl.getProgramParameter(shaderProgram, this.gl.LINK_STATUS)) {
                    console.error('Unable to initialize the shader program:', this.gl.getProgramInfoLog(shaderProgram));
                    return null;
                }

                return shaderProgram;
            }

            loadShader(type, source) {
                const shader = this.gl.createShader(type);
                this.gl.shaderSource(shader, source);
                this.gl.compileShader(shader);

                if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
                    console.error('An error occurred compiling the shaders:', this.gl.getShaderInfoLog(shader));
                    this.gl.deleteShader(shader);
                    return null;
                }

                return shader;
            }

            initBuffers() {
                // åˆ›å»ºçŸ©å½¢çš„é¡¶ç‚¹ä½ç½® (Triangle strip format)
                const positions = [
                    -1.0,  1.0,  // å·¦ä¸Š
                     1.0,  1.0,  // å³ä¸Š  
                    -1.0, -1.0,  // å·¦ä¸‹
                     1.0, -1.0,  // å³ä¸‹
                ];

                this.positionBuffer = this.gl.createBuffer();
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.positionBuffer);
                this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(positions), this.gl.STATIC_DRAW);

                // åˆ›å»ºçº¹ç†åæ ‡ (Triangle strip format)
                const textureCoordinates = [
                    0.0, 0.0,  // å·¦ä¸Š (å¯¹åº”çº¹ç†åæ ‡ç³»çš„å·¦ä¸Š)
                    1.0, 0.0,  // å³ä¸Š
                    0.0, 1.0,  // å·¦ä¸‹
                    1.0, 1.0,  // å³ä¸‹
                ];

                this.textureCoordBuffer = this.gl.createBuffer();
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.textureCoordBuffer);
                this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(textureCoordinates), this.gl.STATIC_DRAW);
            }

            updateVideoTexture() {
                if (!this.gl || !this.texture || !this.elements.digitalHuman.videoWidth) {
                    return;
                }

                const video = this.elements.digitalHuman;
                
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture);
                
                // Simply use the video as texture source - no repeated resizing logic
                this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, video);
                
                // è®¾ç½®çº¹ç†å‚æ•°ï¼Œè€ƒè™‘å¯ç”¨çš„å¹³æ»‘é€‰é¡¹
                this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
                this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
                
                if (this.currentWebglParams.enableSmoothing) {
                    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR);
                    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);
                } else {
                    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);
                    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
                }
            }

            renderFrame() {
                if (!this.gl || !this.shaderProgram) {
                    return;
                }

                // æ›´æ–°canvaså°ºå¯¸
                const canvas = this.elements.humanCanvas;
                const video = this.elements.digitalHuman;
                
                if (video.videoWidth && video.videoHeight) {
                    const aspectRatio = video.videoWidth / video.videoHeight;
                    const containerWidth = canvas.parentElement.clientWidth;
                    const containerHeight = canvas.parentElement.clientHeight;
                    const containerAspectRatio = containerWidth / containerHeight;

                    if (aspectRatio > containerAspectRatio) {
                        canvas.width = containerWidth;
                        canvas.height = containerWidth / aspectRatio;
                    } else {
                        canvas.width = containerHeight * aspectRatio;
                        canvas.height = containerHeight;
                    }

                    this.gl.viewport(0, 0, canvas.width, canvas.height);
                }

                // æ›´æ–°çº¹ç†
                this.updateVideoTexture();

                // æ¸…é™¤ç”»å¸ƒ
                this.gl.clearColor(0.0, 0.0, 0.0, 0.0);
                this.gl.clear(this.gl.COLOR_BUFFER_BIT);

                // ä½¿ç”¨ç€è‰²å™¨ç¨‹åº
                this.gl.useProgram(this.shaderProgram);

                // ç»‘å®šä½ç½®ç¼“å†²åŒº
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.positionBuffer);
                this.gl.vertexAttribPointer(this.programInfo.attribLocations.vertexPosition, 2, this.gl.FLOAT, false, 0, 0);
                this.gl.enableVertexAttribArray(this.programInfo.attribLocations.vertexPosition);

                // ç»‘å®šçº¹ç†åæ ‡ç¼“å†²åŒº
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.textureCoordBuffer);
                this.gl.vertexAttribPointer(this.programInfo.attribLocations.textureCoord, 2, this.gl.FLOAT, false, 0, 0);
                this.gl.enableVertexAttribArray(this.programInfo.attribLocations.textureCoord);

                // ç»‘å®šçº¹ç†
                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture);
                this.gl.uniform1i(this.programInfo.uniformLocations.uTexture, 0);
                
                // è®¾ç½®é€æ˜åº¦å¤„ç†å‚æ•°ï¼ˆä½¿ç”¨å½“å‰è§†é¢‘çš„å‚æ•°ï¼‰
                this.gl.uniform1f(this.programInfo.uniformLocations.uWhiteThreshold, this.currentWebglParams.whiteThreshold);
                this.gl.uniform1f(this.programInfo.uniformLocations.uFadeRange, this.currentWebglParams.fadeRange);
                this.gl.uniform1f(this.programInfo.uniformLocations.uSaturationBoost, this.currentWebglParams.saturationBoost);

                // ç»˜åˆ¶
                this.gl.drawArrays(this.gl.TRIANGLE_STRIP, 0, 4);

                // å¦‚æœè§†é¢‘æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ¸²æŸ“ä¸‹ä¸€å¸§
                if (!video.paused && !video.ended) {
                    requestAnimationFrame(() => this.renderFrame());
                }
            }

            startWebGLRendering() {
                if (this.gl && this.elements.digitalHuman.videoWidth) {
                    this.renderFrame();
                }
            }

            initEventListeners() {
                // Welcome popup
                this.elements.welcomeStartBtn.addEventListener('click', () => this.startExperience());

                // Send message
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Voice input
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());

                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettings());
                this.elements.closeSettingsBtn.addEventListener('click', () => this.hideSettings());
                this.elements.settingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings();
                });

                // WebGLå‚æ•°å®æ—¶è°ƒæ•´ï¼ˆæ›´æ–°å½“å‰è§†é¢‘çš„å‚æ•°ï¼‰
                this.elements.whiteThreshold.addEventListener('input', (e) => {
                    this.currentWebglParams.whiteThreshold = parseFloat(e.target.value);
                    this.elements.whiteThresholdValue.textContent = e.target.value;
                    // åŒæ­¥æ›´æ–°é…ç½®ä¸­çš„å‚æ•°
                    this.config.videos[this.currentVideoType].webglParams.whiteThreshold = this.currentWebglParams.whiteThreshold;
                });
                
                this.elements.fadeRange.addEventListener('input', (e) => {
                    this.currentWebglParams.fadeRange = parseFloat(e.target.value);
                    this.elements.fadeRangeValue.textContent = e.target.value;
                    // åŒæ­¥æ›´æ–°é…ç½®ä¸­çš„å‚æ•°
                    this.config.videos[this.currentVideoType].webglParams.fadeRange = this.currentWebglParams.fadeRange;
                });
                
                this.elements.saturationBoost.addEventListener('input', (e) => {
                    this.currentWebglParams.saturationBoost = parseFloat(e.target.value);
                    this.elements.saturationBoostValue.textContent = e.target.value;
                    // åŒæ­¥æ›´æ–°é…ç½®ä¸­çš„å‚æ•°
                    this.config.videos[this.currentVideoType].webglParams.saturationBoost = this.currentWebglParams.saturationBoost;
                });

                // Other controls
                this.elements.muteBtn.addEventListener('click', () => this.toggleMute());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());

                // Close modal on outside click
                this.elements.settingsModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.settingsModal) {
                        this.hideSettings();
                    }
                });

                // Handle window resize for video responsiveness
                window.addEventListener('resize', () => this.handleResize());
                
                // Handle orientation change for mobile devices
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.handleResize(), 100);
                });
            }

            detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
            }

            handleResize() {
                // Debounce resize events
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    this.adjustVideoSize();
                    // é‡æ–°å¯åŠ¨WebGLæ¸²æŸ“ä»¥é€‚åº”æ–°å°ºå¯¸
                    if (this.gl && this.elements.digitalHuman.videoWidth) {
                        this.startWebGLRendering();
                    }
                }, 100);
            }

            adjustVideoSize() {
                const video = this.elements.digitalHuman;
                const canvas = this.elements.humanCanvas;
                const container = video.parentElement;
                
                if (!video || !container) return;

                // Get container dimensions
                const containerRect = container.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const containerHeight = containerRect.height;

                // Get video dimensions (if loaded)
                let videoWidth = video.videoWidth || 16;
                let videoHeight = video.videoHeight || 9;

                // Calculate aspect ratios
                const containerAspect = containerWidth / containerHeight;
                const videoAspect = videoWidth / videoHeight;

                let displayWidth, displayHeight;

                // Apply object-fit: contain logic manually for better control
                if (containerAspect > videoAspect) {
                    // Container is wider, fit to height
                    displayWidth = containerHeight * videoAspect;
                    displayHeight = containerHeight;
                } else {
                    // Container is taller, fit to width
                    displayWidth = containerWidth;
                    displayHeight = containerWidth / videoAspect;
                }

                // Apply sizing to both video and canvas
                const elements = [video, canvas];
                elements.forEach(element => {
                    if (element) {
                        element.style.width = `${displayWidth}px`;
                        element.style.height = `${displayHeight}px`;
                        
                        // Center the element
                        element.style.position = 'absolute';
                        element.style.top = '50%';
                        element.style.left = '50%';
                        element.style.transform = 'translate(-50%, -50%)';
                    }
                });

                // Update canvas internal resolution if using WebGL
                if (this.gl && canvas) {
                    canvas.width = displayWidth * (window.devicePixelRatio || 1);
                    canvas.height = displayHeight * (window.devicePixelRatio || 1);
                    canvas.style.width = `${displayWidth}px`;
                    canvas.style.height = `${displayHeight}px`;
                    
                    // Update WebGL viewport
                    this.gl.viewport(0, 0, canvas.width, canvas.height);
                }
            }

            handleInitialLoad() {
                if (this.isMobile) {
                    // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ˜¾ç¤ºæ¬¢è¿å¼¹çª—
                    this.elements.welcomePopup.classList.remove('hidden');
                } else {
                    // åœ¨æ¡Œé¢è®¾å¤‡ä¸Šç›´æ¥åŠ è½½è§†é¢‘
                    this.elements.welcomePopup.classList.add('hidden');
                    this.loadIdleVideo();
                }
            }

            async startExperience() {
                // éšè—æ¬¢è¿å¼¹çª—
                this.elements.welcomePopup.classList.add('hidden');
                
                // åŠ è½½å¾…æœºè§†é¢‘
                await this.loadIdleVideo();
            }

            async loadIdleVideo() {
                if (this.videoLoaded) {
                    return;
                }

                this.elements.videoLoading.style.display = 'block';
                this.setStatus('ready', 'æ­£åœ¨åŠ è½½æ•°å­—äºº...');

                try {
                    const video = this.elements.digitalHuman;
                    const source = video.querySelector('source');
                    
                    // è®¾ç½®å¾…æœºè§†é¢‘æºå’ŒWebGLå‚æ•°
                    const idleConfig = this.config.videos.idle;
                    source.src = idleConfig.url;
                    this.currentVideoType = 'idle';
                    this.currentWebglParams = { ...idleConfig.webglParams }; // åˆ›å»ºå‰¯æœ¬
                    
                    console.log('Loading idle video with config:', idleConfig);
                    console.log('Current WebGL params:', this.currentWebglParams);
                    
                    video.load();

                    // ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ
                    await new Promise((resolve, reject) => {
                        video.onloadeddata = () => {
                            this.elements.videoLoading.style.display = 'none';
                            this.videoLoaded = true;
                            this.setStatus('ready', 'å‡†å¤‡å¥½äº†');
                            
                            // Small delay to ensure video dimensions are fully available
                            setTimeout(() => {
                                // Adjust video size after loading
                                this.adjustVideoSize();
                            }, 100);
                            
                            // è‡ªåŠ¨æ’­æ”¾å¾…æœºåŠ¨ç”»ï¼ˆé™éŸ³ï¼‰
                            video.muted = true;
                            video.play().then(() => {
                                console.log('Idle video started playing');
                                
                                // å¯åŠ¨WebGLæ¸²æŸ“
                                this.startWebGLRendering();
                                
                                resolve();
                            }).catch(error => {
                                console.error('Error playing idle video:', error);
                                reject(error);
                            });
                        };

                        video.onerror = () => {
                            this.elements.videoLoading.style.display = 'none';
                            this.showToast('è§†é¢‘åŠ è½½å¤±è´¥', 'error');
                            reject(new Error('Video load failed'));
                        };

                        // è®¾ç½®è¶…æ—¶
                        setTimeout(() => {
                            if (!this.videoLoaded) {
                                this.elements.videoLoading.style.display = 'none';
                                this.showToast('è§†é¢‘åŠ è½½è¶…æ—¶', 'warning');
                                reject(new Error('Video load timeout'));
                            }
                        }, 10000);
                    });

                } catch (error) {
                    console.error('Error loading idle video:', error);
                    this.elements.videoLoading.style.display = 'none';
                    this.setStatus('ready', 'å‡†å¤‡å¥½äº†');
                }
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'zh-CN';

                    this.recognition.onstart = () => {
                        this.setStatus('listening', 'æ­£åœ¨å¬å–...');
                        this.elements.voiceBtn.classList.add('listening');
                        this.switchVideo('listening');
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.elements.messageInput.value = transcript;
                        this.autoResizeTextarea();
                        this.sendMessage();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showToast('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error, 'error');
                        this.stopListening();
                    };

                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                } else {
                    console.warn('Speech recognition not supported');
                    this.elements.voiceBtn.style.display = 'none';
                }
            }

            setWelcomeTime() {
                const welcomeTimeElement = document.getElementById('welcomeTime');
                if (welcomeTimeElement) {
                    welcomeTimeElement.textContent = new Date().toLocaleTimeString();
                }
            }

            autoResizeTextarea() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            toggleVoiceInput() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                if (!this.recognition) {
                    this.showToast('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨', 'error');
                    return;
                }

                if (this.isSpeaking) {
                    this.stopSpeaking();
                }

                try {
                    this.isListening = true;
                    this.recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    this.showToast('æ— æ³•å¯åŠ¨è¯­éŸ³è¯†åˆ«', 'error');
                    this.isListening = false;
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
                this.isListening = false;
                this.elements.voiceBtn.classList.remove('listening');
                this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                this.switchVideo('idle');
            }

            async sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message) return;

                if (!this.config.llmApiKey) {
                    this.showToast('è¯·å…ˆé…ç½® LLM API Key', 'warning');
                    this.showSettings();
                    return;
                }

                // Add user message
                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.autoResizeTextarea();

                // Remove typing indicator and start streaming
                this.hideTypingIndicator();

                try {
                    // Add to conversation history
                    this.conversationHistory.push({ role: 'user', content: message });

                    // Keep conversation history manageable (last 10 exchanges)
                    if (this.conversationHistory.length > 20) {
                        this.conversationHistory = this.conversationHistory.slice(-20);
                    }

                    const response = await this.callLLM();
                    
                    if (response) {
                        this.conversationHistory.push({ role: 'assistant', content: response });
                        await this.speakText(response);
                    }
                } catch (error) {
                    this.hideTypingIndicator();
                    console.error('Error sending message:', error);
                    this.showToast('å‘é€æ¶ˆæ¯å¤±è´¥', 'error');
                    this.addMessage('ai', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚è¯·ç¨åå†è¯•ã€‚');
                }
            }

            async callLLM() {
                this.thinkingStartTime = Date.now();
                this.setStatus('thinking', 'æ€è€ƒä¸­...');
                
                // åˆ¤æ–­æ˜¯å¦éœ€è¦æ’­æ”¾thinkingåŠ¨ç”»
                const shouldShowThinking = true; // å…ˆè®¾ç½®ä¸ºtrueï¼Œç¨åæ ¹æ®å“åº”æ—¶é—´å†³å®š
                if (shouldShowThinking) {
                    // å¦‚æœé…ç½®äº†thinkingè§†é¢‘åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨idleè§†é¢‘
                    const thinkingVideo = this.config.videos.thinking || this.config.videos.idle;
                    this.switchVideo('thinking', thinkingVideo);
                }

                const payload = {
                    model: this.config.modelName,
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯æ˜Ÿäº‘ï¼Œä¸€ä¸ªå‹å–„ã€æ™ºèƒ½çš„AIæ•°å­—äººåŠ©æ‰‹ã€‚è¯·ç”¨ç®€æ´ã€è‡ªç„¶çš„ä¸­æ–‡å›å¤ç”¨æˆ·ï¼Œå›å¤é•¿åº¦æ§åˆ¶åœ¨100å­—ä»¥å†…ã€‚ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œä¸ªæ€§åŒ–ã€‚'
                        },
                        ...this.conversationHistory
                    ],
                    max_tokens: 512,
                    temperature: 0.7,
                    stream: true  // Enable streaming
                };

                const response = await fetch(this.config.llmUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.config.llmApiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`LLM API error: ${response.status}`);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let firstChunkReceived = false;
                
                // Create streaming message element
                const streamingMessageDiv = this.createStreamingMessage();
                const contentDiv = streamingMessageDiv.querySelector('.message-content');
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    break;
                                }
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    const delta = parsed.choices[0]?.delta?.content;
                                    if (delta) {
                                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå†…å®¹chunk
                                        if (!firstChunkReceived) {
                                            firstChunkReceived = true;
                                            const responseTime = Date.now() - this.thinkingStartTime;
                                            
                                            // å¦‚æœå“åº”æ—¶é—´å°äº2ç§’ï¼Œç›´æ¥åˆ‡æ¢åˆ°readyçŠ¶æ€ï¼Œä¸æ’­æ”¾thinkingåŠ¨ç”»
                                            // è¯´è¯åŠ¨ç”»å°†åœ¨speakTextä¸­å¤„ç†
                                            if (responseTime < 2000) {
                                                this.setStatus('ready', 'æ­£åœ¨å‡†å¤‡å›å¤...');
                                                this.switchVideo('idle');
                                            } else {
                                                // å“åº”æ—¶é—´è¶…è¿‡2ç§’ï¼Œä¿æŒthinkingçŠ¶æ€ä¸€ä¼šå„¿å†åˆ‡æ¢
                                                setTimeout(() => {
                                                    this.setStatus('ready', 'æ­£åœ¨å‡†å¤‡å›å¤...');
                                                    this.switchVideo('idle');
                                                }, 500);
                                            }
                                        }
                                        
                                        fullResponse += delta;
                                        // Update the streaming message with new content
                                        this.updateStreamingMessage(contentDiv, fullResponse);
                                    }
                                } catch (e) {
                                    // Skip invalid JSON
                                    continue;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Streaming error:', error);
                    throw error;
                }
                
                // Finalize the streaming message
                this.finalizeStreamingMessage(streamingMessageDiv, fullResponse);
                
                return fullResponse;
            }

            createStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai streaming';
                messageDiv.id = 'streamingMessage';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'ğŸ¤–';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.innerHTML = '<span class="streaming-cursor">|</span>';
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                return messageDiv;
            }

            updateStreamingMessage(contentDiv, text) {
                contentDiv.innerHTML = text + '<span class="streaming-cursor">|</span>';
                this.scrollToBottom();
            }

            finalizeStreamingMessage(messageDiv, finalText) {
                const contentDiv = messageDiv.querySelector('.message-content');
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                
                contentDiv.innerHTML = finalText;
                contentDiv.appendChild(timeDiv);
                
                messageDiv.classList.remove('streaming');
                messageDiv.removeAttribute('id');
            }

            async speakText(text) {
                if (this.isMuted || !this.config.ttsApiKey) {
                    this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                    this.switchVideo('idle');
                    return;
                }

                try {
                    this.setStatus('speaking', 'æ­£åœ¨è¯´è¯...');
                    this.isSpeaking = true;
                    
                    // è®°å½•å¼€å§‹è¯´è¯çš„æ—¶é—´ï¼Œç¡®ä¿è¯´è¯åŠ¨ç”»è‡³å°‘æ’­æ”¾3ç§’
                    const speakStartTime = Date.now();
                    this.switchVideo('talking');

                    const response = await fetch(this.config.ttsUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.config.ttsApiKey}`
                        },
                        body: JSON.stringify({
                            model: 'tts',
                            voice: this.config.ttsVoice,
                            input: text,
                            speed: 1.0
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`TTS API error: ${response.status}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    this.currentAudio = new Audio(audioUrl);
                    
                    const finishSpeaking = () => {
                        const speakDuration = Date.now() - speakStartTime;
                        const minSpeakTime = 3000; // 3ç§’æœ€å°è¯´è¯æ—¶é—´
                        
                        const finishAction = () => {
                            URL.revokeObjectURL(audioUrl);
                            this.isSpeaking = false;
                            this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                            this.switchVideo('idle');
                        };
                        
                        if (speakDuration < minSpeakTime) {
                            // å¦‚æœè¯´è¯æ—¶é—´ä¸è¶³3ç§’ï¼Œå»¶è¿Ÿåˆ‡æ¢å›idleçŠ¶æ€
                            setTimeout(finishAction, minSpeakTime - speakDuration);
                        } else {
                            finishAction();
                        }
                    };
                    
                    this.currentAudio.onended = finishSpeaking;
                    this.currentAudio.onerror = () => {
                        this.isSpeaking = false;
                        this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                        this.switchVideo('idle');
                    };

                    await this.currentAudio.play();
                } catch (error) {
                    console.error('TTS error:', error);
                    this.isSpeaking = false;
                    this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                    this.switchVideo('idle');
                    this.showToast('è¯­éŸ³åˆæˆå¤±è´¥', 'error');
                }
            }

            stopSpeaking() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.isSpeaking = false;
                    // ç«‹å³åˆ‡æ¢å›idleçŠ¶æ€
                    this.setStatus('ready', 'å‡†å¤‡å°±ç»ª');
                    this.switchVideo('idle');
                }
            }

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                messageContent.appendChild(timeDiv);
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai';
                typingDiv.id = 'typingIndicator';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'ğŸ¤–';
                
                const typingContent = document.createElement('div');
                typingContent.className = 'typing-indicator';
                typingContent.innerHTML = `
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>æ­£åœ¨æ€è€ƒ...</span>
                `;
                
                typingDiv.appendChild(avatar);
                typingDiv.appendChild(typingContent);
                
                this.elements.chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            scrollToBottom() {
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            setStatus(type, text) {
                this.elements.statusIndicator.className = `status-indicator ${type}`;
                this.elements.statusText.textContent = text;
            }

            switchVideo(type, customVideoUrl = null) {
                if (!this.videoLoaded) {
                    console.log('Video not loaded yet, skipping video switch');
                    return;
                }

                let videoUrl;
                let webglParams;
                
                if (customVideoUrl) {
                    videoUrl = customVideoUrl;
                    // å¯¹äºè‡ªå®šä¹‰è§†é¢‘URLï¼Œä½¿ç”¨é»˜è®¤WebGLå‚æ•°
                    webglParams = { ...this.config.defaultWebglParams };
                } else {
                    const videoConfig = this.config.videos[type];
                    // å¦‚æœæ²¡æœ‰é…ç½®thinkingè§†é¢‘ä¸”è¯·æ±‚thinkingç±»å‹ï¼Œåˆ™ä½¿ç”¨idleè§†é¢‘
                    if (type === 'thinking' && !this.config.videos.thinking) {
                        const idleConfig = this.config.videos.idle;
                        videoUrl = idleConfig.url;
                        webglParams = idleConfig.webglParams;
                        type = 'idle'; // ä¿®æ­£ç±»å‹ï¼Œé¿å…é‡å¤åˆ‡æ¢
                    } else if (videoConfig) {
                        videoUrl = videoConfig.url;
                        webglParams = videoConfig.webglParams;
                    }
                }

                // å¦‚æœè¦åˆ‡æ¢çš„åŠ¨ç”»ç±»å‹å’Œå½“å‰ä¸€æ ·ï¼Œä¸”è§†é¢‘URLä¹Ÿä¸€æ ·ï¼Œåˆ™è·³è¿‡
                if (this.currentVideoType === type && !customVideoUrl) {
                    console.log(`Already playing ${type} video, skipping switch`);
                    return;
                }
                
                if (videoUrl && webglParams) {
                    const video = this.elements.digitalHuman;
                    const source = video.querySelector('source');
                    
                    // æ›´æ–°å½“å‰WebGLå‚æ•° - åˆå¹¶é»˜è®¤å‚æ•°å’Œè§†é¢‘ç‰¹å®šå‚æ•°
                    this.currentVideoType = type;
                    this.currentWebglParams = { 
                        ...this.config.defaultWebglParams, 
                        ...webglParams 
                    };
                    
                    // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„æ»‘å—å€¼
                    if (this.elements.whiteThreshold) {
                        this.elements.whiteThreshold.value = this.currentWebglParams.whiteThreshold;
                        this.elements.whiteThresholdValue.textContent = this.currentWebglParams.whiteThreshold;
                    }
                    if (this.elements.fadeRange) {
                        this.elements.fadeRange.value = this.currentWebglParams.fadeRange;
                        this.elements.fadeRangeValue.textContent = this.currentWebglParams.fadeRange;
                    }
                    if (this.elements.saturationBoost) {
                        this.elements.saturationBoost.value = this.currentWebglParams.saturationBoost;
                        this.elements.saturationBoostValue.textContent = this.currentWebglParams.saturationBoost;
                    }
                    
                    console.log(`Switching to ${type} video with WebGL params:`, this.currentWebglParams);
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢è§†é¢‘æº
                    if (source.src !== videoUrl) {
                        source.src = videoUrl;
                        video.load();
                        
                        video.onloadeddata = () => {
                            // Small delay to ensure video dimensions are fully available
                            setTimeout(() => {
                                // Adjust video size when switching videos
                                this.adjustVideoSize();
                            }, 100);
                            
                            // å¯¹äºè¯´è¯åŠ¨ç”»ï¼Œä¸è¦é™éŸ³ï¼Œå…¶ä»–åŠ¨ç”»ä¿æŒé™éŸ³
                            if (type === 'talking') {
                                video.muted = false;
                            } else {
                                video.muted = true;
                            }
                            
                            video.play().then(() => {
                                // å¯åŠ¨WebGLæ¸²æŸ“
                                this.startWebGLRendering();
                            }).catch(error => {
                                console.error('Error playing video:', error);
                            });
                        };
                    } else {
                        // è§†é¢‘æºç›¸åŒï¼Œåªæ›´æ–°å½“å‰ç±»å‹å’Œé™éŸ³çŠ¶æ€
                        
                        // æ›´æ–°é™éŸ³çŠ¶æ€
                        if (type === 'talking') {
                            video.muted = false;
                        } else {
                            video.muted = true;
                        }
                        
                        console.log(`Same video URL for ${type}, not reloading`);
                    }
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                this.elements.muteBtn.textContent = this.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
                this.elements.muteBtn.classList.toggle('active', this.isMuted);
                
                if (this.isMuted && this.isSpeaking) {
                    this.stopSpeaking();
                }
            }

            clearChat() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯è®°å½•å—ï¼Ÿ')) {
                    this.elements.chatMessages.innerHTML = `
                        <div class="message ai">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message-content">
                                å¯¹è¯å·²æ¸…ç©ºã€‚æˆ‘æ˜¯æ˜Ÿäº‘ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                                <div class="message-time">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                    this.conversationHistory = [];
                }
            }

            showSettings() {
                // Load current settings
                document.getElementById('llmApiKey').value = this.config.llmApiKey;
                document.getElementById('modelName').value = this.config.modelName;
                document.getElementById('ttsApiKey').value = this.config.ttsApiKey;
                document.getElementById('ttsVoice').value = this.config.ttsVoice;
                document.getElementById('idleVideo').value = this.config.videos.idle;
                document.getElementById('thinkingVideo').value = this.config.videos.thinking || '';
                document.getElementById('talkingVideo').value = this.config.videos.talking;
                document.getElementById('listeningVideo').value = this.config.videos.listening;
                
                // Load WebGL settings
                this.elements.whiteThreshold.value = this.webglParams.whiteThreshold;
                this.elements.whiteThresholdValue.textContent = this.webglParams.whiteThreshold;
                this.elements.fadeRange.value = this.webglParams.fadeRange;
                this.elements.fadeRangeValue.textContent = this.webglParams.fadeRange;
                this.elements.saturationBoost.value = this.webglParams.saturationBoost;
                this.elements.saturationBoostValue.textContent = this.webglParams.saturationBoost;
                
                this.elements.settingsModal.classList.add('show');
            }

            hideSettings() {
                this.elements.settingsModal.classList.remove('show');
            }

            saveSettings() {
                this.config.llmApiKey = document.getElementById('llmApiKey').value;
                this.config.modelName = document.getElementById('modelName').value;
                this.config.ttsApiKey = document.getElementById('ttsApiKey').value;
                this.config.ttsVoice = document.getElementById('ttsVoice').value;
                
                // æ›´æ–°è§†é¢‘URLï¼ˆä¿æŒæ–°çš„é…ç½®ç»“æ„ï¼‰
                if (this.config.videos.idle) {
                    this.config.videos.idle.url = document.getElementById('idleVideo').value;
                }
                if (this.config.videos.talking) {
                    this.config.videos.talking.url = document.getElementById('talkingVideo').value;
                }
                if (this.config.videos.listening) {
                    this.config.videos.listening.url = document.getElementById('listeningVideo').value;
                }
                
                const thinkingVideo = document.getElementById('thinkingVideo').value;
                if (thinkingVideo) {
                    if (!this.config.videos.thinking) {
                        this.config.videos.thinking = {
                            url: thinkingVideo,
                            webglParams: { ...this.config.videos.idle.webglParams } // ä½¿ç”¨idleçš„å‚æ•°ä½œä¸ºé»˜è®¤
                        };
                    } else {
                        this.config.videos.thinking.url = thinkingVideo;
                    }
                }

                // ä¿å­˜å½“å‰è§†é¢‘çš„WebGLå‚æ•°åˆ°é…ç½®ä¸­
                if (this.config.videos[this.currentVideoType]) {
                    this.config.videos[this.currentVideoType].webglParams.whiteThreshold = parseFloat(this.elements.whiteThreshold.value);
                    this.config.videos[this.currentVideoType].webglParams.fadeRange = parseFloat(this.elements.fadeRange.value);
                    this.config.videos[this.currentVideoType].webglParams.saturationBoost = parseFloat(this.elements.saturationBoost.value);
                }

                // Save to localStorage
                localStorage.setItem('digitalHumanConfig', JSON.stringify(this.config));
                
                // Switch to idle video if available
                this.switchVideo('idle');
                
                this.hideSettings();
                this.showToast('è®¾ç½®å·²ä¿å­˜', 'success');
            }

            loadSettings() {
                const saved = localStorage.getItem('digitalHumanConfig');
                if (saved) {
                    try {
                        const savedConfig = JSON.parse(saved);
                        // æ·±åº¦åˆå¹¶é…ç½®ï¼Œä¿æŒè§†é¢‘é…ç½®ç»“æ„
                        if (savedConfig.videos) {
                            Object.keys(savedConfig.videos).forEach(videoType => {
                                if (this.config.videos[videoType]) {
                                    // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼
                                    if (typeof savedConfig.videos[videoType] === 'string') {
                                        this.config.videos[videoType].url = savedConfig.videos[videoType];
                                    } else {
                                        // æ–°æ ¼å¼ï¼Œæ·±åº¦åˆå¹¶
                                        this.config.videos[videoType] = {
                                            ...this.config.videos[videoType],
                                            ...savedConfig.videos[videoType]
                                        };
                                    }
                                }
                            });
                        }
                        
                        // åˆå¹¶å…¶ä»–é…ç½®
                        const { videos, ...otherConfig } = savedConfig;
                        this.config = { ...this.config, ...otherConfig };
                        
                        // æ›´æ–°å½“å‰WebGLå‚æ•°
                        if (this.config.videos[this.currentVideoType]) {
                            this.currentWebglParams = { ...this.config.videos[this.currentVideoType].webglParams };
                        }
                        
                    } catch (error) {
                        console.error('Error loading settings:', error);
                    }
                }
                
                // æ›´æ–°è®¾ç½®UIä¸­çš„å½“å‰WebGLå‚æ•°å€¼
                this.updateWebGLSettingsUI();
            }
            
            updateWebGLSettingsUI() {
                // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„æ»‘å—å€¼ä»¥åæ˜ å½“å‰è§†é¢‘çš„WebGLå‚æ•°
                if (this.elements.whiteThreshold && this.currentWebglParams) {
                    this.elements.whiteThreshold.value = this.currentWebglParams.whiteThreshold;
                    this.elements.whiteThresholdValue.textContent = this.currentWebglParams.whiteThreshold.toFixed(2);
                }
                if (this.elements.fadeRange && this.currentWebglParams) {
                    this.elements.fadeRange.value = this.currentWebglParams.fadeRange;
                    this.elements.fadeRangeValue.textContent = this.currentWebglParams.fadeRange.toFixed(2);
                }
                if (this.elements.saturationBoost && this.currentWebglParams) {
                    this.elements.saturationBoost.value = this.currentWebglParams.saturationBoost;
                    this.elements.saturationBoostValue.textContent = this.currentWebglParams.saturationBoost.toFixed(2);
                }
            }

            /**
             * æ·»åŠ æ–°çš„è§†é¢‘é…ç½®
             * @param {string} videoType - è§†é¢‘ç±»å‹åç§° (å¦‚: 'excited', 'sad', 'angry')
             * @param {string} videoUrl - è§†é¢‘URL
             * @param {Object} webglParams - WebGLå‚æ•°é…ç½®
             */
            addVideoConfig(videoType, videoUrl, webglParams = {}) {
                // åˆå¹¶é»˜è®¤å‚æ•°å’Œè‡ªå®šä¹‰å‚æ•°
                const finalParams = {
                    ...this.config.defaultWebglParams,
                    ...webglParams
                };

                this.config.videos[videoType] = {
                    url: videoUrl,
                    webglParams: finalParams
                };

                console.log(`Added new video config for ${videoType}:`, this.config.videos[videoType]);
                return this.config.videos[videoType];
            }

            /**
             * æ›´æ–°ç°æœ‰è§†é¢‘çš„WebGLå‚æ•°
             * @param {string} videoType - è§†é¢‘ç±»å‹
             * @param {Object} webglParams - æ–°çš„WebGLå‚æ•°
             */
            updateVideoWebGLParams(videoType, webglParams) {
                if (this.config.videos[videoType]) {
                    this.config.videos[videoType].webglParams = {
                        ...this.config.videos[videoType].webglParams,
                        ...webglParams
                    };
                    
                    // å¦‚æœæ˜¯å½“å‰æ’­æ”¾çš„è§†é¢‘ï¼Œç«‹å³æ›´æ–°å‚æ•°
                    if (this.currentVideoType === videoType) {
                        this.currentWebglParams = { ...this.config.videos[videoType].webglParams };
                        this.updateWebGLSettingsUI();
                    }
                    
                    console.log(`Updated WebGL params for ${videoType}:`, this.config.videos[videoType].webglParams);
                } else {
                    console.warn(`Video type ${videoType} not found in config`);
                }
            }

            /**
             * è·å–è§†é¢‘çš„WebGLå‚æ•°
             * @param {string} videoType - è§†é¢‘ç±»å‹
             * @returns {Object} WebGLå‚æ•°å¯¹è±¡
             */
            getVideoWebGLParams(videoType) {
                return this.config.videos[videoType]?.webglParams || null;
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                document.getElementById('toastContainer').appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.digitalHumanChat) {
                window.digitalHumanChat.stopListening();
                window.digitalHumanChat.stopSpeaking();
            }
        });

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        window.digitalHumanChat = new DigitalHumanChat();
    </script>
</body>
</html>