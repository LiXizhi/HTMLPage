<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è°æƒ³åƒä»€ä¹ˆ - è¨€è¯­ç†è§£æµ‹è¯•</title>
    <script src="https://cdn.keepwork.com/keepwork/cdn/tailwindcss@3.4.16.js"></script>
    <style>
        /* å…¨å±è®¾ç½® */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        body {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* æ¸¸æˆå®¹å™¨å…¨å± */
        .game-container {
            min-height: 100vh;
            min-height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .option {
            transition: all 0.3s ease;
            min-height: 48px; /* ç§»åŠ¨ç«¯å‹å¥½çš„æœ€å°è§¦æ§åŒºåŸŸ */
            touch-action: manipulation;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .progress {
            transition: width 0.3s ease;
        }
        
        /* é€‰é¡¹çŠ¶æ€æ ·å¼ */
        .option.selected {
            background-color: #2563eb;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
        }
        
        .option.correct {
            background-color: #16a34a;
            color: white;
            font-weight: bold;
        }
        
        .option.incorrect {
            background-color: #dc2626;
            color: white;
            font-weight: bold;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .game-container {
                padding: 0.5rem;
            }
            
            .game-content {
                padding: 1rem !important;
            }
            
            .option {
                min-height: 52px;
                font-size: 0.9rem;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
        }
        
        /* æ¨ªå±ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) and (orientation: landscape) {
            .game-container {
                padding: 0.25rem;
            }
            
            .game-content {
                padding: 0.75rem !important;
            }
            
            h1 {
                font-size: 1.25rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .stats-row {
                flex-direction: row !important;
                justify-content: space-between !important;
                margin-bottom: 0.5rem !important;
            }
            
            .question-area {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .options-grid {
                margin-bottom: 0.75rem !important;
            }
        }
        
        /* è§„åˆ™å¼¹çª—æ ·å¼ */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .rules-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* è§„åˆ™æŒ‰é’® */
        .rules-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #4f46e5;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .rules-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5);
        }
        
        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }
        
        /* è§¦æ§åé¦ˆ */
        .option:active {
            transform: scale(0.98);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-height: 600px) {
            .game-content {
                padding: 0.5rem !important;
            }
            
            .question-area {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .options-grid {
                gap: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .stats-row > div {
                font-size: 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-400">
    <!-- è§„åˆ™å¼¹çª— -->
    <div id="rules-modal" class="rules-modal">
        <div class="rules-content">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold text-purple-600 mb-2">è°æƒ³åƒä»€ä¹ˆï¼Ÿ</h2>
            </div>
            <div class="space-y-4 text-gray-700">
                <div>
                    <h3 class="font-bold text-lg mb-2">ğŸ¯ ç›®æ ‡</h3>
                    <p>æ ¹æ®é¢˜ç›®æè¿°ï¼Œé€‰æ‹©æœ€é€‚åˆçš„é€‰é¡¹ï¼Œæµ‹è¯•ä½ çš„è¨€è¯­ç†è§£èƒ½åŠ›ï¼</p>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="start-game-btn" class="bg-green-500 text-white px-8 py-3 rounded-lg text-2xl font-bold hover:bg-green-600 transition-colors">
                    å¼€å§‹è®­ç»ƒ
                </button>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™æŒ‰é’® -->
    <button id="rules-btn" class="rules-btn hidden" title="æŸ¥çœ‹æ¸¸æˆè§„åˆ™">
        â“
    </button>

    <div class="game-container">
        <div class="container mx-auto p-2 max-w-4xl flex-1 flex flex-col">
            <!-- æ¸¸æˆä¸»ç•Œé¢ -->
            <div class="game-content bg-white rounded-lg shadow-2xl p-4 md:p-6 mb-4 flex-1 flex flex-col">
                <!-- å¾—åˆ†å’Œè¿›åº¦æ˜¾ç¤º -->
                <div class="stats-row flex flex-col md:flex-row justify-evenly items-center mb-4">
                    <div class="text-lg md:text-2xl font-bold text-blue-600 mb-2 md:mb-0">
                        å¾—åˆ†: <span id="score">0</span>/<span id="total-questions">0</span>
                    </div>
                    <div class="text-lg md:text-2xl font-bold text-purple-600 mb-2 md:mb-0 hidden">
                        æœ€é«˜åˆ†: <span id="best-score">0</span>/<span id="best-total">0</span>
                    </div>
                    <div class="text-lg md:text-2xl font-bold text-green-600">
                        è¿›åº¦: <span id="progress-text">0</span>%
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="w-full bg-gray-200 rounded-full h-3 md:h-4 mb-4">
                    <div id="progress" class="progress h-3 md:h-4 rounded-full bg-blue-500" style="width: 0%"></div>
                </div>

                <!-- é—®é¢˜æ˜¾ç¤ºåŒº -->
                <div class="question-area bg-gray-50 rounded-lg p-3 md:p-6 mb-4 flex-1">
                    <div id="question" class="text-lg md:text-xl font-medium text-gray-800 fade-in"></div>
                </div>

                <!-- é€‰é¡¹åŒº -->
                <div class="options-grid grid grid-cols-1 gap-3 mb-4">
                    <div id="options" class="space-y-3"></div>
                </div>

                <!-- åé¦ˆä¿¡æ¯ -->
                <div id="feedback" class="feedback hidden p-3 md:p-4 rounded-lg mb-4"></div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="buttons-row flex justify-center gap-4 mt-auto">
                    <button id="next-btn" disabled class="bg-blue-500 text-white px-6 md:px-8 py-3 rounded-lg text-lg md:text-xl font-bold hover:bg-blue-600 transition-colors disabled:bg-blue-300 min-h-[48px]">
                        æäº¤
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div id="result-container" class="hidden container mx-auto p-2 max-w-4xl">
            <div class="bg-white rounded-lg shadow-2xl p-4 md:p-6 text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-purple-600 mb-4">æµ‹è¯•å®Œæˆ!</h2>
                <p class="text-lg md:text-xl mb-2">
                    ä½ çš„æœ€ç»ˆå¾—åˆ†æ˜¯: <span id="final-score" class="font-bold">0</span>/<span id="final-total" class="font-bold">0</span>
                </p>
                <p class="text-lg md:text-xl mb-4">
                    æœ€é«˜åˆ†: <span id="final-best-score" class="font-bold">0</span>/<span id="final-best-total" class="font-bold">0</span>
                </p>
                <p id="result-message" class="text-base md:text-lg mb-6"></p>
                <button id="restart-btn" class="bg-green-500 text-white px-6 md:px-8 py-3 rounded-lg text-lg md:text-xl font-bold hover:bg-green-600 transition-colors min-h-[48px]">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤æ¸¸æˆæ•°æ®
        let defaultQuestions = [
            {
                question: "å°æ˜ä¸å–œæ¬¢åƒç”œé£Ÿï¼Œä½†ä»Šå¤©ä»–æƒ³å°è¯•ä¸€ç§æ–°çš„æ—©é¤é€‰æ‹©ã€‚ä¸‹åˆ—å“ªç§é£Ÿç‰©æœ€é€‚åˆä»–ï¼Ÿ",
                options: ["èœ‚èœœè›‹ç³•", "å…¨éº¦é¢åŒ…é…ç‰›æ²¹æœ", "å·§å…‹åŠ›ç”œç”œåœˆ", "æ°´æœé…¸å¥¶"],
                answer: 1,
                explanation: "å…¨éº¦é¢åŒ…é…ç‰›æ²¹æœä¸å«å¤§é‡ç³–åˆ†ï¼Œæ˜¯ä¸ç”œçš„å¥åº·é€‰æ‹©ï¼Œé€‚åˆä¸å–œæ¬¢ç”œé£Ÿçš„äººã€‚"
            },
            {
                question: "å¼ é˜¿å§¨æ­£åœ¨æ§åˆ¶é’ çš„æ‘„å…¥é‡ï¼Œå¥¹æƒ³åšä¸€é“é€‚åˆè‡ªå·±åƒçš„èœã€‚ä¸‹åˆ—å“ªç§æœ€åˆé€‚ï¼Ÿ",
                options: ["è…Œåˆ¶çš„å’¸é±¼", "æ¸…è’¸æ–°é²œé²ˆé±¼", "é…±æ²¹ç‚’é¥­", "æ³¡èœæ±¤"],
                answer: 1,
                explanation: "æ¸…è’¸æ–°é²œé²ˆé±¼ä¸éœ€è¦é¢å¤–åŠ ç›ï¼Œä½¿ç”¨æ–°é²œé£Ÿææœ¬èº«çš„é²œå‘³ï¼Œæ˜¯æœ€ä½é’ çš„é€‰æ‹©ã€‚"
            },
            {
                question: "å°ææ˜¯ç´ é£Ÿä¸»ä¹‰è€…ï¼Œä»–æƒ³ç‚¹ä¸€ä»½å¤–å–ã€‚ä¸‹åˆ—å“ªç§é£Ÿç‰©ä»–å¯ä»¥åƒï¼Ÿ",
                options: ["ç‰›è‚‰æ±‰å ¡", "è”¬èœæ²™æ‹‰é…é¸¡è›‹", "çº¯ç´ è”¬èœå·", "èŠå£«æŠ«è¨"],
                answer: 2,
                explanation: "çº¯ç´ è”¬èœå·ä¸å«ä»»ä½•åŠ¨ç‰©åˆ¶å“ï¼Œæ˜¯ä¸¥æ ¼çš„ç´ é£Ÿé€‰æ‹©ã€‚"
            },
            {
                question: "ç‹å¥¶å¥¶ç‰™å£ä¸å¥½ï¼Œæƒ³åƒäº›è½¯çš„é£Ÿç‰©ã€‚ä¸‹åˆ—å“ªç§æœ€é€‚åˆå¥¹ï¼Ÿ",
                options: ["åšæœæ‚ç²®", "è’¸è›‹ç¾¹", "è„†çš®çƒ§è‚‰", "ç”Ÿèƒ¡èåœæ¡"],
                answer: 1,
                explanation: "è’¸è›‹ç¾¹è´¨åœ°æŸ”è½¯ï¼Œä¸éœ€è¦å’€åš¼ï¼Œéå¸¸é€‚åˆç‰™å£ä¸å¥½çš„è€å¹´äººã€‚"
            },
            {
                question: "å°ç¾æ­£åœ¨å‡è‚¥ï¼Œå¥¹æƒ³é€‰ä¸€ä»½ä½çƒ­é‡çš„åˆé¤ã€‚ä¸‹åˆ—å“ªç§æœ€åˆé€‚ï¼Ÿ",
                options: ["ç‚¸é¸¡å¥—é¤", "è”¬èœæ²™æ‹‰é…æ©„æ¦„æ²¹", "å¥¶æ²¹æ„é¢", "èŠå£«æ±‰å ¡é…è–¯æ¡"],
                answer: 1,
                explanation: "è”¬èœæ²™æ‹‰é…å°‘é‡æ©„æ¦„æ²¹æ˜¯ä½çƒ­é‡ä¸”è¥å…»å‡è¡¡çš„é€‰æ‹©ï¼Œé€‚åˆå‡è‚¥æœŸé—´é£Ÿç”¨ã€‚"
            },
            {
                question: "é™ˆå…ˆç”Ÿå¯¹æµ·é²œè¿‡æ•ï¼Œä»–æƒ³åƒä¸€é¡¿å®‰å…¨çš„æ™šé¤ã€‚ä¸‹åˆ—å“ªç§ä»–åº”è¯¥é¿å…ï¼Ÿ",
                options: ["çƒ¤ç‰›æ’", "æ¸…ç‚’æ—¶è”¬", "æ¸…è’¸å¤§é—¸èŸ¹", "ç•ªèŒ„é¸¡è›‹æ±¤"],
                answer: 2,
                explanation: "æ¸…è’¸å¤§é—¸èŸ¹æ˜¯æµ·é²œï¼Œæµ·é²œè¿‡æ•è€…åº”é¿å…é£Ÿç”¨ã€‚"
            },
            {
                question: "æ—å°å§æ˜¯ä¹³ç³–ä¸è€å—è€…ï¼Œå¥¹æƒ³å–ä¸€æ¯çƒ­é¥®ã€‚ä¸‹åˆ—å“ªç§æœ€é€‚åˆå¥¹ï¼Ÿ",
                options: ["å…¨è„‚ç‰›å¥¶", "è±†å¥¶", "å¥¶æ²¹å’–å•¡", "å¥¶é…ªå¥¶èŒ¶"],
                answer: 1,
                explanation: "è±†å¥¶ä¸å«ä¹³ç³–ï¼Œæ˜¯ä¹³ç³–ä¸è€å—è€…çš„è‰¯å¥½æ›¿ä»£å“ã€‚"
            },
            {
                question: "è€å¼ æœ‰ç³–å°¿ç—…ï¼Œéœ€è¦æ§åˆ¶è¡€ç³–ã€‚ä¸‹åˆ—å“ªç§é›¶é£Ÿä»–åº”è¯¥é¿å…ï¼Ÿ",
                options: ["æ— ç³–é…¸å¥¶", "ä¸€å°æŠŠåšæœ", "é«˜çº¤ç»´é¥¼å¹²", "èœ‚èœœè›‹ç³•"],
                answer: 3,
                explanation: "èœ‚èœœè›‹ç³•å«ç³–é‡é«˜ï¼Œä¼šè¿…é€Ÿå‡é«˜è¡€ç³–ï¼Œä¸é€‚åˆç³–å°¿ç—…æ‚£è€…ã€‚"
            }
        ];

        // æ¸¸æˆæ•°æ® - å¯ä»¥è¢«é…ç½®è¦†ç›–
        let questions = [...defaultQuestions];
        let selectedQuestions = []; // å­˜å‚¨éšæœºé€‰æ‹©çš„é¢˜ç›®

        // æ¸¸æˆçŠ¶æ€
        let currentQuestion = 0;
        let score = 0;
        let selectedOption = null;
        let answered = false;
        let bestScore = 0; // æœ€é«˜åˆ†
        let difficulty = 2; // éš¾åº¦ç­‰çº§ 1-3ï¼Œé»˜è®¤ä¸º2
        let game_config = null; // æ¸¸æˆé…ç½®
        let questionCount = 5; // é¢˜ç›®æ•°é‡

        // æ·»åŠ éšæœºæ•°ç»„æ‰“ä¹±å‡½æ•°
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // éšæœºé€‰æ‹©é¢˜ç›®
        function selectRandomQuestions(questionPool, minCount = 8) {
            const availableQuestions = [...questionPool];
            const targetCount = Math.max(minCount, Math.min(questionPool.length, minCount));
            
            // é¦–å…ˆæ‰“ä¹±æ‰€æœ‰é¢˜ç›®çš„é¡ºåº
            const shuffledQuestions = shuffleArray(availableQuestions);
            
            // å¦‚æœé¢˜ç›®æ•°é‡å°‘äºæˆ–ç­‰äºç›®æ ‡æ•°é‡ï¼Œè¿”å›æ‰€æœ‰é¢˜ç›®ï¼ˆå·²æ‰“ä¹±ï¼‰
            if (shuffledQuestions.length <= targetCount) {
                return shuffledQuestions;
            }
            
            // ä»æ‰“ä¹±åçš„é¢˜ç›®ä¸­é€‰æ‹©æŒ‡å®šæ•°é‡
            return shuffledQuestions.slice(0, targetCount);
        }

        // ä¸ºé¢˜ç›®é€‰é¡¹æ·»åŠ éšæœºæ‰“ä¹±åŠŸèƒ½
        function createShuffledQuestion(originalQuestion) {
            const shuffledQuestion = { ...originalQuestion };
            
            // åˆ›å»ºé€‰é¡¹ç´¢å¼•æ˜ å°„
            const originalOptions = [...originalQuestion.options];
            const indexMap = originalOptions.map((_, index) => index);
            const shuffledIndexMap = shuffleArray(indexMap);
            
            // æ ¹æ®æ‰“ä¹±çš„ç´¢å¼•é‡æ–°æ’åˆ—é€‰é¡¹
            shuffledQuestion.options = shuffledIndexMap.map(index => originalOptions[index]);
            
            // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆåœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®
            const originalCorrectIndex = originalQuestion.answer;
            shuffledQuestion.answer = shuffledIndexMap.indexOf(originalCorrectIndex);
            
            return shuffledQuestion;
        }

        // DOMå…ƒç´ 
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const feedbackEl = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');
        const scoreEl = document.getElementById('score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const progressEl = document.getElementById('progress');
        const progressTextEl = document.getElementById('progress-text');
        const gameContainer = document.querySelector('.game-content');
        const resultContainer = document.getElementById('result-container');
        const finalScoreEl = document.getElementById('final-score');
        const finalTotalEl = document.getElementById('final-total');
        const resultMessageEl = document.getElementById('result-message');
        const restartBtn = document.getElementById('restart-btn');
        const bestScoreEl = document.getElementById('best-score');
        const bestTotalEl = document.getElementById('best-total');
        const finalBestScoreEl = document.getElementById('final-best-score');
        const finalBestTotalEl = document.getElementById('final-best-total');
        const gameTitleEl = document.getElementById('game-title');
        const gameSubtitleEl = document.getElementById('game-subtitle');

        // åº”ç”¨æ¸¸æˆé…ç½®
        function applyGameConfig(config) {
            try {
                // è§£æé…ç½®ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼‰
                const parsedConfig = typeof config === 'string' ? JSON.parse(config) : config;
                
                // æ›´æ–°æ¸¸æˆæ ‡é¢˜å’Œå‰¯æ ‡é¢˜
                if (parsedConfig.title) {
                    gameTitleEl.textContent = parsedConfig.title;
                }
                if (parsedConfig.subtitle) {
                    gameSubtitleEl.textContent = parsedConfig.subtitle;
                }
                
                // æ›´æ–°éš¾åº¦
                if (parsedConfig.difficulty) {
                    difficulty = parsedConfig.difficulty;
                }
                
                // æ›´æ–°é—®é¢˜é›†
                if (parsedConfig.questions && Array.isArray(parsedConfig.questions)) {
                    questions = [...parsedConfig.questions];
                }
                
                // é‡æ–°é€‰æ‹©éšæœºé¢˜ç›®
                selectedQuestions = selectRandomQuestions(questions, questionCount).map(q => createShuffledQuestion(q));
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                currentQuestion = 0;
                score = 0;
                answered = false;
                selectedOption = null;
                
                // æ›´æ–°UI
                scoreEl.textContent = score;
                totalQuestionsEl.textContent = selectedQuestions.length;
                bestTotalEl.textContent = selectedQuestions.length;
                finalTotalEl.textContent = selectedQuestions.length;
                finalBestTotalEl.textContent = selectedQuestions.length;
                
                // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œï¼Œé‡æ–°åŠ è½½å½“å‰é—®é¢˜
                if (gameContainer.style.display !== 'none') {
                    loadQuestion();
                }
                
                console.log('Game config applied successfully:', parsedConfig);
                return true;
            } catch (error) {
                console.error('Error applying game config:', error);
                return false;
            }
        }

        // é‡ç½®åˆ°é»˜è®¤é…ç½®
        function resetToDefaultConfig() {
            questions = [...defaultQuestions];
            selectedQuestions = selectRandomQuestions(questions, questionCount).map(q => createShuffledQuestion(q));
            difficulty = 2;
            gameTitleEl.textContent = "ğŸ½ï¸ è°æƒ³åƒä»€ä¹ˆ ğŸ½ï¸";
            gameSubtitleEl.textContent = "è¨€è¯­ç†è§£æµ‹è¯•ï¼Œæå‡ä½ çš„æ€ç»´èƒ½åŠ›ï¼";
            
            currentQuestion = 0;
            score = 0;
            answered = false;
            selectedOption = null;
            
            scoreEl.textContent = score;
            totalQuestionsEl.textContent = selectedQuestions.length;
            bestTotalEl.textContent = selectedQuestions.length;
            finalTotalEl.textContent = selectedQuestions.length;
            finalBestTotalEl.textContent = selectedQuestions.length;
        }

        // æ¸¸æˆé…ç½®å’Œç»Ÿè®¡æ¶ˆæ¯ç›‘å¬
        window.addEventListener('message', function (e) {
            switch (e.data.type) {
                case 'setGameConfig':
                    game_config = e.data.data; // this is JSON object or string
                    const success = applyGameConfig(game_config);
                    
                    // å‘é€é…ç½®æ›´æ–°ç»“æœæ¶ˆæ¯
                    // window.parent.postMessage({ 
                    //     type: 'configUpdated', 
                    //     data: { 
                    //         success: success,
                    //         difficulty: difficulty,
                    //         questionCount: questions.length
                    //     }
                    // }, '*');
                    break;
                case 'getGameStats':
                    window.parent.postMessage({ 
                        type: 'gameStats', 
                        data: {
                            score: bestScore, // è¿”å›æœ€é«˜åˆ†
                            difficulty: difficulty,
                            totalQuestions: questions.length,
                            currentQuestion: currentQuestion,
                            gameTitle: gameTitleEl.textContent
                        }
                    }, '*');
                    break;
                // case 'resetConfig':
                //     resetToDefaultConfig();
                //     window.parent.postMessage({ 
                //         type: 'configReset', 
                //         data: { success: true }
                //     }, '*');
                //     break;
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©é¢˜ç›®ï¼Œå…ˆé€‰æ‹©éšæœºé¢˜ç›®
            if (selectedQuestions.length === 0) {
                selectedQuestions = selectRandomQuestions(questions, questionCount).map(q => createShuffledQuestion(q));
            }
            
            totalQuestionsEl.textContent = selectedQuestions.length;
            bestTotalEl.textContent = selectedQuestions.length;
            finalBestTotalEl.textContent = selectedQuestions.length;
            updateBestScoreDisplay();
            loadQuestion();
            
            // å‘é€æ¸¸æˆåŠ è½½å®Œæˆæ¶ˆæ¯
            window.parent.postMessage({ type: 'gameLoaded' }, '*');
        }

        // æ›´æ–°æœ€é«˜åˆ†æ˜¾ç¤º
        function updateBestScoreDisplay() {
            bestScoreEl.textContent = bestScore;
            finalBestScoreEl.textContent = bestScore;
        }

        // åŠ è½½é—®é¢˜
        function loadQuestion() {
            // å¦‚æœæ˜¯ç¬¬ä¸€é¢˜ï¼Œå‘é€æ¸¸æˆå¼€å§‹æ¶ˆæ¯
            if (currentQuestion === 0 && score === 0) {
                window.parent.postMessage({ type: 'gameStarted' }, '*');
            }
            
            answered = false;
            selectedOption = null;
            nextBtn.disabled = true;
            nextBtn.textContent = "æäº¤"; // é‡ç½®æŒ‰é’®æ–‡æœ¬ä¸º"æäº¤"
            feedbackEl.style.display = 'none';
            feedbackEl.className = 'feedback hidden p-4 rounded-lg mb-6';
            
            const q = selectedQuestions[currentQuestion]; // ä½¿ç”¨é€‰æ‹©çš„é¢˜ç›®
            questionEl.textContent = `${currentQuestion + 1}. ${q.question}`;
            questionEl.classList.remove('fade-in');
            void questionEl.offsetWidth;
            questionEl.classList.add('fade-in');
            
            optionsEl.innerHTML = '';
            q.options.forEach((option, index) => {
                const optionEl = document.createElement('button');
                optionEl.className = 'option w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg transition-colors';
                optionEl.textContent = option;
                optionEl.dataset.index = index;
                optionEl.addEventListener('click', selectOption);
                optionsEl.appendChild(optionEl);
            });
            
            updateProgress();
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(e) {
            if (answered) return;
            
            const selectedEl = e.target;
            const optionIndex = parseInt(selectedEl.dataset.index);
            
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            if (selectedOption !== null) {
                document.querySelectorAll('.option')[selectedOption].classList.remove('selected');
            }
            
            selectedOption = optionIndex;
            selectedEl.classList.add('selected');
            nextBtn.disabled = false;
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            if (selectedOption === null || answered) return;
            
            answered = true;
            const q = selectedQuestions[currentQuestion]; // ä½¿ç”¨é€‰æ‹©çš„é¢˜ç›®
            const options = document.querySelectorAll('.option');
            
            options.forEach((option, index) => {
                option.classList.remove('selected');
                if (index === q.answer) {
                    option.classList.add('correct');
                } else if (index === selectedOption && selectedOption !== q.answer) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selectedOption === q.answer) {
                score++;
                scoreEl.textContent = score;
                feedbackEl.textContent = "âœ“ æ­£ç¡®! " + q.explanation;
                feedbackEl.className = "feedback p-4 rounded-lg mb-6 bg-green-100 text-green-800 fade-in";
            } else {
                feedbackEl.textContent = "âœ— ä¸æ­£ç¡®ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯: " + q.options[q.answer] + ". " + q.explanation;
                feedbackEl.className = "feedback p-4 rounded-lg mb-6 bg-red-100 text-red-800 fade-in";
            }
            
            feedbackEl.style.display = 'block';
            nextBtn.disabled = false;
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (currentQuestion < selectedQuestions.length - 1) {
                nextBtn.textContent = "ä¸‹ä¸€é¢˜";
            } else {
                nextBtn.textContent = "æŸ¥çœ‹ç»“æœ";
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < selectedQuestions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const progress = ((currentQuestion) / selectedQuestions.length) * 100;
            progressEl.style.width = `${progress}%`;
            progressTextEl.textContent = Math.round(progress);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > bestScore) {
                bestScore = score;
                updateBestScoreDisplay();
            }
            
            gameContainer.style.display = 'none';
            resultContainer.classList.remove('hidden');
            finalScoreEl.textContent = score;
            finalTotalEl.textContent = selectedQuestions.length;
            
            const percentage = (score / selectedQuestions.length) * 100;
            // å°†åˆ†æ•°æ¢ç®—æˆç™¾åˆ†åˆ¶
            const normalizedScore = Math.round(percentage);
            const normalizedBestScore = Math.round((bestScore / selectedQuestions.length) * 100);
            
            let message = "";
            if (percentage >= 90) {
                message = "å¤ªæ£’äº†! ä½ çš„è¨€è¯­ç†è§£èƒ½åŠ›éå¸¸å‡ºè‰²!";
            } else if (percentage >= 70) {
                message = "åšå¾—ä¸é”™! ä½ çš„è¨€è¯­ç†è§£èƒ½åŠ›è‰¯å¥½ã€‚";
            } else if (percentage >= 50) {
                message = "è¿˜å¯ä»¥ã€‚ä½ çš„è¨€è¯­ç†è§£èƒ½åŠ›æœ‰æå‡ç©ºé—´ã€‚";
            } else {
                message = "éœ€è¦åŠ å¼ºç»ƒä¹ ã€‚å¤šæ³¨æ„ç†è§£é¢˜ç›®ä¸­çš„å…³é”®ä¿¡æ¯ã€‚";
            }
            
            // å¦‚æœè¾¾åˆ°æ–°çš„æœ€é«˜åˆ†ï¼Œæ·»åŠ ç¥è´ºä¿¡æ¯
            if (score === bestScore && score > 0) {
                message += " ğŸ‰ è¿™æ˜¯ä½ çš„æœ€é«˜åˆ†ï¼";
            }
            
            resultMessageEl.textContent = message;
            
            // å‘é€æ¸¸æˆå®Œæˆæ¶ˆæ¯ - åˆ†æ•°å·²æ¢ç®—ä¸ºç™¾åˆ†åˆ¶
            window.parent.postMessage({ 
                type: 'gameFinished', 
                data: {
                    score: normalizedScore,  // ç™¾åˆ†åˆ¶åˆ†æ•°
                    bestScore: normalizedBestScore,  // ç™¾åˆ†åˆ¶æœ€é«˜åˆ†
                    totalQuestions: selectedQuestions.length,
                    percentage: percentage,
                    difficulty: difficulty,
                    rawScore: score,  // ä¿ç•™åŸå§‹åˆ†æ•°ä¾›å‚è€ƒ
                    rawBestScore: bestScore  // ä¿ç•™åŸå§‹æœ€é«˜åˆ†ä¾›å‚è€ƒ
                }
            }, '*');
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            // é‡æ–°é€‰æ‹©éšæœºé¢˜ç›®å¹¶æ‰“ä¹±é€‰é¡¹
            selectedQuestions = selectRandomQuestions(questions, questionCount).map(q => createShuffledQuestion(q));
            
            currentQuestion = 0;
            score = 0;
            scoreEl.textContent = score;
            totalQuestionsEl.textContent = selectedQuestions.length;
            gameContainer.style.display = 'flex';
            resultContainer.classList.add('hidden');
            loadQuestion();
        }

        // æ–°å¢ï¼šè§„åˆ™å¼¹çª—æ§åˆ¶
        const rulesModal = document.getElementById('rules-modal');
        const startGameBtn = document.getElementById('start-game-btn');
        const rulesBtn = document.getElementById('rules-btn');
        
        // æ˜¾ç¤ºè§„åˆ™å¼¹çª—
        function showRules() {
            rulesModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // éšè—è§„åˆ™å¼¹çª—
        function hideRules() {
            rulesModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            rulesBtn.classList.remove('hidden');
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            hideRules();
            // å¦‚æœæ¸¸æˆå·²ç»å¼€å§‹ï¼Œä¸é‡æ–°åˆå§‹åŒ–
            if (currentQuestion === 0 && score === 0) {
                initGame();
            }
        }
        
        // ç§»åŠ¨ç«¯è§¦æ§ä¼˜åŒ–
        function addTouchSupport() {
            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ è§¦æ§åé¦ˆ
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.classList.contains('option')) {
                    e.target.style.transform = 'scale(0.98)';
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.classList.contains('option')) {
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 150);
                }
            });
        }
        
        // å±å¹•æ–¹å‘å˜åŒ–å¤„ç†
        function handleOrientationChange() {
            // å»¶è¿Ÿå¤„ç†ï¼Œç¡®ä¿æµè§ˆå™¨å®Œæˆæ–¹å‘åˆ‡æ¢
            setTimeout(() => {
                // é‡æ–°è®¡ç®—è§†å£é«˜åº¦
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                
                // è§¦å‘é‡æ’
                window.dispatchEvent(new Event('resize'));
            }, 100);
        }
        
        // åˆå§‹åŒ–ç§»åŠ¨ç«¯é€‚é…
        function initMobileAdaptation() {
            // è®¾ç½®è§†å£é«˜åº¦å˜é‡
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            
            // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            });
            
            // æ·»åŠ è§¦æ§æ”¯æŒ
            addTouchSupport();
            
            // é˜²æ­¢ç§»åŠ¨ç«¯ç¼©æ”¾
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function (e) {
                e.preventDefault();
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©é¢˜ç›®ï¼Œå…ˆé€‰æ‹©éšæœºé¢˜ç›®
            if (selectedQuestions.length === 0) {
                selectedQuestions = selectRandomQuestions(questions, questionCount).map(q => createShuffledQuestion(q));
            }
            
            totalQuestionsEl.textContent = selectedQuestions.length;
            bestTotalEl.textContent = selectedQuestions.length;
            finalBestTotalEl.textContent = selectedQuestions.length;
            updateBestScoreDisplay();
            loadQuestion();
            
            // å‘é€æ¸¸æˆåŠ è½½å®Œæˆæ¶ˆæ¯
            window.parent.postMessage({ type: 'gameLoaded' }, '*');
        }

        // äº‹ä»¶ç›‘å¬
        nextBtn.addEventListener('click', () => {
            if (!answered) {
                checkAnswer();
            } else {
                nextQuestion();
            }
        });

        restartBtn.addEventListener('click', restartGame);
        
        // æ–°å¢äº‹ä»¶ç›‘å¬
        startGameBtn.addEventListener('click', startGame);
        rulesBtn.addEventListener('click', showRules);
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        rulesModal.addEventListener('click', (e) => {
            if (e.target === rulesModal) {
                hideRules();
            }
        });

        initMobileAdaptation();
        showRules(); // æ˜¾ç¤ºè§„åˆ™å¼¹çª—
    </script>
</body>
</html>
